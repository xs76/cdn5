!function(t){class e{constructor(){this.googleLoginSupported=!0,this.googleAuth=null,this.googleLoginCertain=!1,this.GOOGLE_PROVIDER_URL="https://accounts.google.com",this.googleInit=!1,this.onGoogleInitCbs=[],this.fbLoginSupported=!0,this.fbInit=!1,this.fbLoginCertain=!1,this.onFbInitCbs=[],this.FB_SDK_VERSION="v3.3",this.FB_APP_ID="local"==n.ENVIRONMENT?"2386025974769573":"371757996756993",this.FB_PROVIDER_URL="https://www.facebook.com",this.loggedInIsCertain=!1,this.onLoggedInCertainCbs=[],this.onSignedInChangeCbs=[],this.isShowingLoggedInElsewhere=!1,this.lastSentAccountData=null,this.isInitingLibraries=!1,this.didInitLibraries=!1,this.onInitLibrariesCbs=[],this.lastUserId=""}init(){this.signInAny()}async showLoggedInElsewhere(){if(this.isShowingLoggedInElsewhere)return;this.isShowingLoggedInElsewhere=!0;let t=new $("You are logged in from another location.",["Stay signed in",{text:"Sign Out",color:"red",sideType:"invBanner",inline:!0}]);t.hideOnCloseRequest=!1;let e=await t.waitForButtonResponse();0==e?await this.sendCurrentAccountData(!0):1==e&&(await this.getIsSignedIn(!1)?await this.signOut():(await zt.set("lastServerAccountData",{}),await this.sendCurrentAccountData(!0))),this.isShowingLoggedInElsewhere=!1,await t.close()}async initLibraries(){if(!this.didInitLibraries){if(this.isInitingLibraries)return await new Promise(t=>this.onInitLibrariesCbs.push(t));this.isInitingLibraries=!0,await Promise.all([this.initGoogleLogin(),this.initFbLogin()]);for(const t of this.onInitLibrariesCbs)t();this.onInitLibrariesCbs=[],this.isInitingLibraries=!1,this.didInitLibraries=!0}}async initGoogleLogin(){try{await Zt.addScript("https://apis.google.com/js/api.js"),await this.loadGapi("auth2"),this.googleAuth=gapi.auth2.init({client_id:"9435755892-9o3jt03madd2pq529b2527thphp0nisd.apps.googleusercontent.com"}),this.googleAuth=await this.googleAuth,this.googleLoginCertain=!0}catch(t){console.warn("google login unsupported",t),this.googleLoginSupported=!1}this.testLoggedInIsCertain(),this.googleInit=!0;for(const t of this.onGoogleInitCbs)t();this.onGoogleInitCbs=[],this.fireOnSignedInChange(await this.getIsSignedIn()),await this.getIsSignedInGoogle()&&await this.doLibraryInitAutoLoginThings("google")}async waitForGoogleInit(){if(!this.googleInit)return await new Promise(t=>this.onGoogleInitCbs.push(t))}async initFbLogin(){try{let t=new Promise(t=>window.fbAsyncInit=t);await Zt.addScript("/patch/js/null.js?connect.facebook.net/en_US/sdk.js"),await t,FB.init({appId:this.FB_APP_ID,autoLogAppEvents:!0,version:this.FB_SDK_VERSION,status:!0,frictionlessRequests:!0}),this.fbLoginCertain=!0}catch(t){console.log("facebook login unsupported",t),this.fbLoginSupported=!1}this.testLoggedInIsCertain(),this.fbInit=!0;for(const t of this.onFbInitCbs)t();this.onFbInitCbs=[],this.fireOnSignedInChange(await this.getIsSignedIn()),await this.getFbIsLoggedIn()&&await this.doLibraryInitAutoLoginThings("facebook")}async waitForFbInit(){if(!this.fbInit)return await new Promise(t=>this.onFbInitCbs.push(t))}async doLibraryInitAutoLoginThings(t){this.lastSentAccountData&&this.lastSentAccountData.loginType==t||(await p.network.waitForConnectionOpen(),await this.sendCurrentAccountData())}async getFbLoginStatus(t=!0){return t&&await this.waitForFbInit(),this.fbLoginSupported?await new Promise(t=>FB.getLoginStatus(t)):null}async getFbIsLoggedIn(t){let e=await this.getFbLoginStatus(t);return!(!e||!e.status||"connected"!=e.status)}async fbApiCall(t,e){return this.fbLoginSupported?await new Promise(i=>FB.api(t,e,i)):null}async loadGapi(t){if(this.googleLoginSupported&&"gapi"in window)return await new Promise(e=>gapi.load(t,e))}async initAuth2(){return await new Promise(t=>{this.googleAuth=gapi.auth2.init({client_id:"9435755892-9o3jt03madd2pq529b2527thphp0nisd.apps.googleusercontent.com"}).then(t)})}async getIsSignedInGoogle(t){return t&&await this.waitForGoogleInit(),!!this.googleLoginSupported&&this.googleAuth.isSignedIn.get()}async signInAny(t=!0){let e=!1;if(window.FederatedCredential){let i=null;try{i=await navigator.credentials.get({federated:{providers:[this.GOOGLE_PROVIDER_URL,this.FB_PROVIDER_URL]},mediation:t?"silent":"required"})}catch(t){}i&&"federated"==i.type&&(i.provider==this.GOOGLE_PROVIDER_URL&&(await this.signInGoogle(i.id),e=!0),i.provider==this.FB_PROVIDER_URL&&(await this.signInFb(),e=!0))}e||(t&&!await zt.get("wasSignedInLastSession")||this.initLibraries(),t||new Mt)}async signInGoogle(t){if(await this.initLibraries(),await this.waitForGoogleInit(),!this.googleLoginSupported)return;if(this.googleAuth.isSignedIn.get()){if(this.googleAuth.currentUser.get().getBasicProfile().getEmail()==t)return}let e=await this.googleAuth.signIn({login_hint:t||""});if(window.FederatedCredential){let t=e.getBasicProfile();const i=new FederatedCredential({id:t.getEmail(),name:t.getName(),provider:this.GOOGLE_PROVIDER_URL,iconURL:t.getImageUrl()});navigator.credentials.store(i)}await this.sendCurrentAccountData()}async signInFb(){if(await this.initLibraries(),await this.waitForFbInit(),!this.fbLoginSupported)return;await new Promise(t=>FB.login(t,{scope:"email"}));if(window.FederatedCredential){let t=await this.fbApiCall("me",{fields:"name,email,picture.type(square).width(180).height(180)"});const e=new FederatedCredential({id:t.email||t.name||"Facebook",name:t.name||"Facebook",provider:this.FB_PROVIDER_URL,iconURL:t.picture.data.url});navigator.credentials.store(e)}await this.sendCurrentAccountData()}async signOutFb(){await this.waitForFbInit(),this.fbLoginSupported&&await this.getFbIsLoggedIn()&&await new Promise(t=>FB.logout(t))}async signOut(){await this.waitForLoggedInCertainty(),await this.waitForGoogleInit(),await this.waitForFbInit(),this.googleLoginSupported&&this.googleAuth.isSignedIn.get()&&await this.googleAuth.signOut(),this.fbLoginSupported&&await this.signOutFb(),navigator.credentials&&navigator.credentials.preventSilentAccess&&navigator.credentials.preventSilentAccess(),await this.sendCurrentAccountData(),this.fireOnSignedInChange(!1)}async waitForLoggedInCertainty(){if(!this.loggedInIsCertain)return await new Promise(t=>this.onLoggedInCertainCbs.push(t))}async testLoggedInIsCertain(){if(!this.loggedInIsCertain&&(!this.googleLoginSupported||this.googleLoginCertain)&&(!this.fbLoginSupported||this.fbLoginCertain)){this.loggedInIsCertain=!0;for(const t of this.onLoggedInCertainCbs)t();this.onLoggedInCertainCbs=[]}}async getIsSignedIn(t=!0){return t||this.didInitLibraries?await this.getIsSignedInGoogle(!0)||await this.getFbIsLoggedIn(!0):await zt.get("wasSignedInLastSession")}onSignedInChange(t){this.onSignedInChangeCbs.push(t)}removeOnSignedInChange(t){let e=this.onSignedInChangeCbs.indexOf(t);e>=0&&this.onSignedInChangeCbs.splice(e,1)}fireOnSignedInChange(t){for(let e=this.onSignedInChangeCbs.length-1;e>=0;e--)this.onSignedInChangeCbs[e](t);zt.set("wasSignedInLastSession",t)}async waitForSignedIn(){if(!await this.getIsSignedIn())return await new Promise(t=>{let e=i=>{i&&(this.removeOnSignedInChange(e),t())};this.onSignedInChange(e)})}async sendCurrentAccountData(t){let e=t&&!await zt.get("wasSignedInLastSession");e||await this.waitForLoggedInCertainty();let i={loginType:"guest"};if(!e)if(this.googleLoginSupported&&this.googleAuth.isSignedIn.get()){let t=this.googleAuth.currentUser.get().getAuthResponse();i.loginType="google",i.loginData={idToken:t.id_token}}else if(this.fbLoginSupported&&await this.getFbIsLoggedIn()){let t=await this.getFbLoginStatus();i.loginType="facebook",i.loginData={signedRequest:t.authResponse.signedRequest}}if("guest"==i.loginType){let t=await zt.get("lastServerAccountData");if(t)i.loginData=t;else{let t=await zt.get("lastServerNuggetCount");t&&(i.loginData={availableHatIds:t.availableHatIds,nuggetCount:t.count,guestLoginData:{encrypted:t.encrypted,now:t.now,salt:t.salt,version:1}})}}this.lastSentAccountData=i,p.network.sendMyAccountData(i)}async accountDataFromServer(t){if(!(t={...{nuggetCount:0,availableHatIds:[]},...t=t||{}}).guestLoginData&&t.nuggetCount<p.levelUI.currentNuggetCount){let t=new $("The account you are trying to log in to has less progress than your current guest account. If you log in you will lose your current progress. Are you sure?",["Yeah, log me in!","Nevermind"]);if(t.hideOnCloseRequest=!1,1==await t.waitForButtonResponse())return void this.signOut()}p.hats.makeAllHatsUnavailable(),p.levelUI.setNuggetCountFromServer(t.nuggetCount);let e=0;t.hatProgress&&t.hatProgress.totalWins&&(e=t.hatProgress.totalWins),p.cornerStats.setTotalWins(e);for(const i of t.availableHatIds)p.hats.makeHatIdAvailable(i);await p.hats.makeLocalHatsAvailable(),p.appearanceMenuManager.testCurrentHatsValid(),this.fireOnSignedInChange(!t.guestLoginData),zt.set("lastServerAccountData",t)}userIdChange(t){t!=this.lastUserId&&(this.lastUserId=t,p.cornerSettings.signOutButton.el.title="Your user id: "+t,t?console.log("signed in with User id:",t):console.log("signed out"))}}class i{constructor(){this.allowAds=!0;let t=Zt.parseSearch();("true"==Zt.lsGet("disable3rdParty")||t.kongregate&&"true"==t.kongregate.toLowerCase())&&(this.allowAds=!1,this.setBannerVisibilities(!1)),this.testing=!1,this.resetInterstitialValues(),this.onInterstitialLoadCbs=[],this.onInterstitialCloseCbs=[],this.onInterstitialDoneCbs=[];let e=window.aiptag;e||(e=window.aiptag={}),e.cmd=e.cmd||[],e.cmd.display=e.cmd.display||[],e.cmd.player=e.cmd.player||[],this.didConsent="true"==Zt.lsGet("playButtonConsent"),this.prerollElem=document.createElement("div"),this.prerollElem.classList.add("preroll"),document.body.appendChild(this.prerollElem),this.useAdinPlay=!0,this.usePokiBanners=!1,this.aipPlayer=null,this.onPrerollCompleteCbs=[],this.prerollCounter=0,this.prerollIsPlaying=!1,this.hasAdblock=!1,qt.addListener(t=>{this.updatePokiBannerVisibility()})}async init(){if(this.allowAds){try{await fetch("patch/js/null.js?pagead2.googlesyndication.com/pagead/js/adsbygoogle.js",{mode:"no-cors"})}catch(t){this.hasAdblock=!0}if(this.hasAdblock)for(const t of document.querySelectorAll(".itchBanner"))t.classList.add("itchBannerActive"),t.addEventListener("click",t=>{window.open("https://www.patreon.com/pelicanpartystudios")});if(CORDOVA){let t="ca-app-pub-3940256099942544/6300978111",e="ca-app-pub-3940256099942544/1033173712";this.testing||(IOS?(t="ca-app-pub-1491708476635888/1315711249",e="ca-app-pub-1491708476635888/6923261146"):ANDROID&&(t="ca-app-pub-1491708476635888/7997024883",e="ca-app-pub-1491708476635888/7472897815")),this.initMobileBanner(t);let i={isTesting:this.testing,autoShow:!1,id:e};this.didConsent||(i.adExtras={npa:1}),admob.interstitial.config(i),document.addEventListener("admob.interstitial.events.LOAD",t=>{this.onInterstitialLoadFinish(!0)}),document.addEventListener("admob.interstitial.events.LOAD_FAIL",t=>{this.onInterstitialLoadFinish(!1)}),document.addEventListener("admob.interstitial.events.OPEN",t=>{p.sfx.setMutedPreroll(!0)}),document.addEventListener("admob.interstitial.events.CLOSE",t=>{this.fireInterstitialCloseCbs(),p.sfx.setMutedPreroll(!1)})}if(this.useAdinPlay=!p.poki.usePokiSdk&&!CORDOVA,this.useAdinPlay&&!this.hasAdblock){let t=document.createElement("script");t.async=!1,t.src="//api.adinplay.com/libs/aiptag/pub/PPS/nuggetroyale.io/tag.min.js",document.head.appendChild(t),aiptag.cmp={show:!0,position:"centered",button:!1},p.cornerSettings.consentSettingsButton.setVisibility(!0),aiptag.cmd.player.push(t=>{this.aipPlayer=new aipPlayer({AD_WIDTH:960,AD_HEIGHT:540,AD_FULLSCREEN:!1,AD_CENTERPLAYER:!1,LOADING_TEXT:"loading advertisement",PREROLL_ELEM:t=>this.prerollElem,AIP_COMPLETE:t=>{for(const e of this.onPrerollCompleteCbs)e();this.onPrerollCompleteCbs=[]},AIP_REMOVE:function(){}})})}}}async doPreroll(){if(this.allowAds&&!this.hasAdblock)if(CORDOVA)await this.showInterstitial(),await this.waitForInterstitialDone();else if(p.poki.usePokiSdk)this.prerollIsPlaying=!0,p.music.stopCurrentBar(),p.sfx.setMutedPreroll(!0),await p.poki.commercialBreak(),Zt.gaEvent("gameLoop","preroll"),this.prerollIsPlaying=!1,p.sfx.setMutedPreroll(!1);else if(this.useAdinPlay&&this.aipPlayer){if(this.prerollCounter++,!(this.prerollCounter>7||window.forcePrerollInLobby))return;this.prerollCounter=0,p.curtain.addElemNeedsCurtain(this.prerollElem),this.prerollIsPlaying=!0,p.music.stopCurrentBar(),p.sfx.setMutedPreroll(!0),this.aipPlayer.startPreRoll(),Zt.gaEvent("gameLoop","preroll"),await this.waitForPrerollComplete(),this.prerollIsPlaying=!1,p.sfx.setMutedPreroll(!1),p.curtain.removeElemNeedsCurtain(this.prerollElem)}}async waitForPrerollComplete(){return await new Promise(t=>{this.onPrerollCompleteCbs.push(t)})}refreshAdinplayBannerAd(t,e=!1){if(!this.useAdinPlay||this.hasAdblock)return;let i=Date.now();if(e){let e=7e3-(i-parseInt(t.dataset.lastRefreshTime));if(e>0)return void("true"!=t.dataset.isWaitingForTimeout&&(t.dataset.isWaitingForTimeout=!0,window.setTimeout(e=>{this.refreshAdinplayBannerAd(t)},e)))}t.dataset.isWaitingForTimeout=!1,t.dataset.lastRefreshTime=i,aiptag.cmd.display.push(e=>aipDisplayTag.display(t.id))}refreshPokiBannerAd(t){this.usePokiBanners&&(PokiSDK.destroyAd(t),PokiSDK.displayAd(t,"300x250"))}setBannerVisibilities(t){for(const e of document.querySelectorAll(".thisDefinitelyWontGetBlockedByAdblockers"))e.style.display=t?null:"none"}setUsePokiBanners(){this.usePokiBanners=!0,this.updatePokiBannerVisibility()}updatePokiBannerVisibility(){if(CORDOVA)return;let t=p.mainMenu.visible&&"none"!=window.getComputedStyle(p.mainMenu.adContainer).display;this.setPokiBannerVisibility(p.mainMenu.ad,t),this.setPokiBannerVisibility(p.gameOverScreen.bannerAdContent,p.gameOverScreen.visible)}setPokiBannerVisibility(t,e){CORDOVA||t.dataset.visible!=e.toString()&&(t.dataset.visible=e,e?this.usePokiBanners?PokiSDK.displayAd(t,"300x250"):this.useAdinPlay&&this.refreshAdinplayBannerAd(t):this.usePokiBanners&&PokiSDK.destroyAd(t))}async initMobileBanner(t){if(!CORDOVA)return;let e={isTesting:this.testing,bannerAtTop:!0,autoShow:!1,id:t};this.didConsent||(e.adExtras={npa:1}),admob.interstitial.config(e),admob.banner.config(e),await admob.banner.prepare()}async setMobileBannerVisibility(t){CORDOVA&&(t?await admob.banner.show():await admob.banner.hide())}async preloadInterstitial(){if(!CORDOVA)return!1;if(this.isLoadingInterstitial)return await this.waitForInterstitialLoad();return this.isLoadingInterstitial=!0,await admob.interstitial.prepare(),!!await this.waitForInterstitialLoad()||(this.resetInterstitialValues(),!1)}async showInterstitial(){if(!CORDOVA)return!1;if(this.isShowingInterstitial)return await this.waitForInterstitialDone();this.isShowingInterstitial=!0;let t=await this.preloadInterstitial();return t&&(await admob.interstitial.show(),await this.waitForInterstitialClose()),this.resetInterstitialValues(),this.fireInterstitialDone(t),t}async waitForInterstitialLoad(){return!!CORDOVA&&(!!this.interstitialLoaded||await new Promise(t=>this.onInterstitialLoadCbs.push(t)))}onInterstitialLoadFinish(t){if(CORDOVA){t&&(this.interstitialLoaded=!0);for(const e of this.onInterstitialLoadCbs)e(t);this.onInterstitialLoadCbs=[]}}async waitForInterstitialClose(){if(CORDOVA)return await new Promise(t=>this.onInterstitialCloseCbs.push(t))}fireInterstitialCloseCbs(){for(const t of this.onInterstitialCloseCbs)t();this.onInterstitialCloseCbs=[]}async waitForInterstitialDone(){if(CORDOVA)return await new Promise(t=>this.onInterstitialDoneCbs.push(t))}fireInterstitialDone(t){for(const e of this.onInterstitialDoneCbs)e(t);this.onInterstitialDoneCbs=[]}resetInterstitialValues(){this.isShowingInterstitial=!1,this.isLoadingInterstitial=!1,this.interstitialLoaded=!1}}class n{constructor(){}static get ENVIRONMENT(){let t=location.hostname;return t.indexOf("localhost")>=0||/(\d+\.){3}\d+/g.exec(t)?"local":t.startsWith("dev.")?"dev":t.startsWith("staging.")?"staging":"live"}}class s{constructor(){this.lightsObject=new THREE.Object3D,this.lightsObject.name="lights",this.ambientMenuLQParent=null,this.menuLQVisible=!0,this.lights=[]}init(){let t=new THREE.AmbientLight(16777215,.3);t.name="ambient light",this.lightsObject.add(t),this.addLight(t,0);let e=new THREE.SpotLight(16777215,1,0,.3,1,1);e.name="bigLightWhite",e.position.set(200,200,200),p.renderer.supportsShadows&&(e.castShadow=!0),e.shadow.mapSize.width=e.shadow.mapSize.height=2048,e.shadow.bias=-16e-7,this.lightsObject.add(e),this.addLight(e,.31);let i=new THREE.SpotLight(16777215,1,0,.3,1,1);i.name="bigLightWhiteNoShadow",i.position.set(200,200,200),this.lightsObject.add(i),this.addLight(i,0,.3);let n=new THREE.SpotLight(16541184,2,140,1.26,.1,.01);n.name="grinderSpotlight",n.position.set(0,-70,0),this.lightsObject.add(n),this.addLight(n,.5);let s=new THREE.SpotLight(15776885,1,0,1,1,1);s.name="spotLightOrange",s.position.set(0,8,-30),this.lightsObject.add(s),this.addLight(s,.5);let r=new THREE.SpotLight(3050741,1,0,1,1,1);r.name="spotLightTeal",r.position.set(0,8,30),this.lightsObject.add(r),this.addLight(r,.5);let a=new THREE.SpotLight(12451583,1.5,0,.3,1,1);a.name="spotLightConveyorBelt",a.position.set(0,150,-30),a.target.position.set(0,50,100),a.target.updateMatrixWorld(),this.lightsObject.add(a),this.addLight(a,.7);let o=new THREE.SpotLight(15989759,1,0,1,1,1);o.name="spotLightLobby",o.position.set(-70,90,160),o.target.position.set(-60,60,160),o.target.updateMatrixWorld(),this.lightsObject.add(o),this.addLight(o,0);let l=new THREE.SpotLight(9097214,1,0,1,1,1);l.name="spotLightLobbyLow",l.position.set(-80,69,160),l.target.position.set(-60,60,160),l.target.updateMatrixWorld(),p.renderer.supportsShadows&&(l.castShadow=!0),l.shadow.mapSize.width=l.shadow.mapSize.height=2048,l.shadow.bias=-1e-6,this.lightsObject.add(l),this.addLight(l,.7),this.ambientLQParent=new THREE.Object3D,this.lightsObject.add(this.ambientLQParent);let h=new THREE.AmbientLight(16777215,.3);h.name="ambient light LQ",this.ambientLQParent.add(h),this.addLight(h,0,.3),this.ambientMenuLQParent=new THREE.Object3D,this.lightsObject.add(this.ambientMenuLQParent);let c=new THREE.AmbientLight(16777215,.6);c.name="ambient light menu LQ",this.ambientMenuLQParent.add(c),this.addLight(c,0,.5)}addLight(t,e=0,i=-1){this.lights.push({name:t.name,light:t,defaultIntensity:t.intensity,defaultColor:t.color.clone(),defaultCastShadow:t.castShadow,minQuality:e,maxQuality:i})}setQuality(t){for(const e of this.lights){let i=!0;e.minQuality>=0&&t<e.minQuality&&(i=!1),e.maxQuality>=0&&t>e.maxQuality&&(i=!1),e.light.visible=i}}setTheme(t){let e=t.lightsValues||[];for(const i of this.lights){let t=e.find(t=>t.name==i.name);i.light.intensity=i.defaultIntensity,i.light.color=i.defaultColor,i.light.castShadow=i.defaultCastShadow,t&&(t.color&&(i.light.color=t.color),(t.intensity||0===t.intensity)&&(i.light.intensity=t.intensity),void 0!==t.castShadow&&(i.light.castShadow=t.castShadow))}}setInMenu(t){this.ambientMenuLQParent.visible=t,this.ambientLQParent.visible=!t}}class r{constructor(){window.addEventListener("error",t=>{this.handleError("error",t)}),window.addEventListener("unhandledrejection",t=>{this.handleError("promise rejection",t)}),this.loggedItems=[]}handleError(t,e){let i="";e.reason&&e.reason.message?i=e.reason.message:e.reason?i=e.reason:e.error&&e.error.message?i=e.error.message:e.message&&(i=e.message);let n="";e.error&&e.error.stack?n=e.error.stack:e.reason instanceof Error&&e.reason.stack&&(n=e.reason.stack),this.loggedItems.push({type:t,message:i,stack:n})}}class a{constructor(){this.spawnedSystems=[]}loop(t,e){for(let i=this.spawnedSystems.length-1;i>=0;i--){let n=this.spawnedSystems[i];n.loop(t,e),null==n.obj&&this.spawnedSystems.splice(i,1)}}createSystem(t,e=.5){if(p.cornerSettings.quality<e)return null;let i=new o(t);return this.spawnedSystems.push(i),i}}class o{constructor(t){if(t={...{doInit:!0,startOnInit:!0,addToScene:!0,particleAssetPath:null,particleAssetPackage:"mainHQ",particleCount:10,gravity:-.01,startVelocity:0,angularVelocity:0,billboardParticles:!1,spawnerShape:{type:"box"},particleSize:1,particleOpacity:1,particleLifetime:0,loopAfterLifetime:!0,pickRandomChild:!1,duration:0,drag:0},...t},this.needsSeparateMaterials=!1,"number"==typeof t.startVelocity){let e=t.startVelocity;t.startVelocity={x:e,y:e,z:e}}if("number"==typeof t.particleSize){let e=t.particleSize;t.particleSize={min:e,max:e}}if("number"==typeof t.particleOpacity){let e=t.particleOpacity;t.particleOpacity={start:e,end:e}}if(this.animateOpacity=t.particleOpacity.start!=t.particleOpacity.end,this.animateOpacity&&(this.needsSeparateMaterials=!0),void 0===t.startVelocity.minX&&void 0!==t.startVelocity.x&&(t.startVelocity.minX=-t.startVelocity.x),void 0===t.startVelocity.maxX&&void 0!==t.startVelocity.x&&(t.startVelocity.maxX=t.startVelocity.x),void 0===t.startVelocity.minY&&void 0!==t.startVelocity.y&&(t.startVelocity.minY=-t.startVelocity.y),void 0===t.startVelocity.maxY&&void 0!==t.startVelocity.y&&(t.startVelocity.maxY=t.startVelocity.y),void 0===t.startVelocity.minZ&&void 0!==t.startVelocity.z&&(t.startVelocity.minZ=-t.startVelocity.z),void 0===t.startVelocity.maxZ&&void 0!==t.startVelocity.z&&(t.startVelocity.maxZ=t.startVelocity.z),this.opts=t,this.obj=new THREE.Object3D,t.addToScene&&p.game.scene.add(this.obj),this.particles=[],this.started=!1,this.startTime=0,this.active=!0,this.spawnerFunction=null,"box"==t.spawnerShape.type||"boxFaces"==t.spawnerShape.type){t.spawnerShape={...{size:1,sizeX:1,sizeY:1,sizeZ:1},...t.spawnerShape};let e=t.spawnerShape.size;this.spawnerFunction=(i=>{let n=new THREE.Vector3;if(n.x=Zt.randRange(-t.spawnerShape.sizeX*e,t.spawnerShape.sizeX*e),n.y=Zt.randRange(-t.spawnerShape.sizeY*e,t.spawnerShape.sizeY*e),n.z=Zt.randRange(-t.spawnerShape.sizeZ*e,t.spawnerShape.sizeZ*e),"boxFaces"==t.spawnerShape.type)switch(Zt.randInt(0,6)){case 0:n.x=-t.spawnerShape.sizeX;break;case 1:n.x=t.spawnerShape.sizeX;break;case 2:n.y=-t.spawnerShape.sizeY;break;case 3:n.y=t.spawnerShape.sizeY;break;case 4:n.z=-t.spawnerShape.sizeZ;break;case 5:n.z=t.spawnerShape.sizeZ}return n})}t.doInit&&this.init()}async init(){let t=await p.assetCache.getItem(this.opts.particleAssetPath,this.opts.particleAssetPackage);if(this.obj){t.scene&&(t=t.scene);for(let e=0;e<this.opts.particleCount;e++){let e=null;e=this.opts.pickRandomChild?Zt.randFromArray(t.children).clone():t.clone(),this.needsSeparateMaterials&&(e.material=e.material.clone()),e.material.opacity=this.opts.particleOpacity.start,this.particles.push(e),this.obj.add(e),this.resetParticle(e,!0)}this.opts.startOnInit&&this.start()}}destructor(){this.obj&&(this.obj.parent.remove(this.obj),this.obj=null,this.particles=[],this.spawnerFunction=null)}start(){this.started=!0,this.startTime=p.now}resetParticle(t,e=!1){t.position.copy(this.getNewSpawnPos());let i=new THREE.Vector3(Math.random(),Math.random(),Math.random());i.length()<=0&&i.set(1,0,0),t.quaternion.setFromAxisAngle(i,Math.random()*Math.PI*2),t.scale.setScalar(Zt.randRange(this.opts.particleSize.min,this.opts.particleSize.max)),t.userData.velocity=new THREE.Vector3;this.opts.startVelocityMultiplier;t.userData.velocity.x=Zt.randRange(this.opts.startVelocity.minX,this.opts.startVelocity.maxX),t.userData.velocity.y=Zt.randRange(this.opts.startVelocity.minY,this.opts.startVelocity.maxY),t.userData.velocity.z=Zt.randRange(this.opts.startVelocity.minZ,this.opts.startVelocity.maxZ),this.opts.particleLifetime>0&&(t.userData.lifeTime=e?Zt.randRange(0,this.opts.particleLifetime):0),this.opts.billboardParticles?(t.userData.angularVelocity=Zt.randRange(-this.opts.angularVelocity,this.opts.angularVelocity),t.userData.billboardRotation=Zt.randRange(0,2*Math.PI)):(t.userData.angularVelocity=new THREE.Vector3,t.userData.angularVelocity.x=Zt.randRange(-this.opts.angularVelocity,this.opts.angularVelocity),t.userData.angularVelocity.y=Zt.randRange(-this.opts.angularVelocity,this.opts.angularVelocity),t.userData.angularVelocity.z=Zt.randRange(-this.opts.angularVelocity,this.opts.angularVelocity))}loop(t,e){if(this.started&&this.obj&&this.obj.parent&&this.active){for(const t of this.particles){t.userData.velocity.y+=this.opts.gravity*(e/16.66);let i=1/(this.opts.drag+1);if(i=Zt.lerptt10(i,e/16.6666),t.userData.velocity.multiplyScalar(i),t.position.addScaledVector(t.userData.velocity,e/16.66),this.opts.billboardParticles){let i=p.cam.camera.position;t.lookAt(i),t.userData.billboardRotation+=t.userData.angularVelocity*e*.001;let n=t.getWorldPosition(new THREE.Vector3),s=i.clone().sub(n);s.normalize(),t.rotateOnWorldAxis(s,t.userData.billboardRotation)}else if(t.userData.angularVelocity.length()>0){let i=new THREE.Quaternion;i.setFromAxisAngle(t.userData.angularVelocity,t.userData.angularVelocity.length()*e*.001),i.normalize(),t.quaternion.multiply(i)}if(this.opts.particleLifetime>0){t.userData.lifeTime+=e;let i=t.userData.lifeTime/this.opts.particleLifetime;i>1&&this.opts.loopAfterLifetime&&this.resetParticle(t),this.animateOpacity&&(t.material.opacity=Zt.lerp(this.opts.particleOpacity.start,this.opts.particleOpacity.end,i))}}this.opts.duration>0&&t-this.startTime>1e3*this.opts.duration&&this.destructor()}}getNewSpawnPos(){return this.spawnerFunction?this.spawnerFunction():new THREE.Vector3}setActive(t){this.active=t}}class l{constructor(){this.pokiInit=!1,this.pokiErrored=!1,this.onPokiInitCbs=[],this.isPokiBuild=location.origin.includes("poki"),this._usePokiSdk=!1,this.gameplayStarted=!1;let t=Zt.parseSearch();(t.usePokiSDK&&"true"==t.usePokiSDK.toLowerCase()||this.isPokiBuild)&&(this._usePokiSdk=!0)}get usePokiSdk(){return this.pokiErrored,this._usePokiSdk}async init(){if(!this.usePokiSdk)return;let t=document.createElement("script");t.src="patch/poki-sdk.js",document.head.appendChild(t);try{await new Promise((e,i)=>{let n=i=>{e(),t.removeEventListener("load",n)};t.addEventListener("load",n);let s=e=>{i(new Error("unable to load PokiSDK")),t.removeEventListener("error",s)};t.addEventListener("error",s)}),await PokiSDK.init()}catch(t){this.pokiErrored=!0,console.warn("failed to load PokiSDK",t)}if(this.pokiInit=!0,this.usePokiSdk){p.ads.setUsePokiBanners();for(const t of document.querySelectorAll(".hideWithPokiSDK"))t.style.display="none"}for(const e of this.onPokiInitCbs)e();this.onPokiInitCbs=[]}async waitForInit(){if(!this.pokiInit)return await new Promise(t=>{this.onPokiInitCbs.push(t)})}async gameplayStart(){this.gameplayStarted||(this.gameplayStarted=!0,this.usePokiSdk&&(await this.waitForInit(),PokiSDK.gameplayStart()))}async gameplayStop(){this.gameplayStarted&&(this.gameplayStarted=!1,this.usePokiSdk&&(await this.waitForInit(),PokiSDK.gameplayStop()))}async gameLoadingStart(){this.usePokiSdk&&(await this.waitForInit(),PokiSDK.gameLoadingStart())}async gameLoadingFinished(){this.usePokiSdk&&(await this.waitForInit(),PokiSDK.gameLoadingFinished())}async gameLoadingProgress(t){this.usePokiSdk&&(await this.waitForInit(),PokiSDK.gameLoadingProgress({percentageDone:t}))}async commercialBreak(){this.usePokiSdk&&(await this.waitForInit(),await PokiSDK.commercialBreak())}async happyTime(t=.5){this.usePokiSdk&&(await this.waitForInit(),PokiSDK.happyTime(t))}}class h{constructor(){this.renderer=null,this.composer=null,this.usingVr=!1,this.uiRenderer=new kt,this.afterFrameRenderCbs=[],this._resolutionMultiplier=1,this._doPostProcessing=!0}get doPostProcessing(){return this._doPostProcessing}set doPostProcessing(t){this._doPostProcessing=t,this.renderer.renderToScreen=!t}set resolutionMultiplier(t){this._resolutionMultiplier=t,this.onResize()}init(){this.renderer=new THREE.WebGLRenderer,this.renderer.shadowMap.enabled=!0,this.renderer.gammaOutput=!0,this.renderer.toneMapping=THREE.Uncharted2ToneMapping,this.renderer.toneMappingExposure=.1,this.renderer.toneMappingWhitePoint=.1,this.renderer.renderToScreen=!1;let t=this.renderer.domElement;t.classList.add("fullScreen","mainCanvas"),document.body.appendChild(t);let e=new THREE.RenderPass(p.game.scene,p.cam.camera),i=new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),.12,1,.6);i.renderToScreen=!0,this.composer=new THREE.EffectComposer(this.renderer),this.composer.addPass(e),this.composer.addPass(i),this.uiRenderer.init(),qt.addListener((t,e)=>{this.onResize(t,e)}),this.onResize()}onResize(t=document.documentElement.clientWidth,e=document.documentElement.clientHeight){let i=this._resolutionMultiplier;this.w=t,this.h=e,this.setSize(t*i,e*i),this.uiRenderer.onResize()}setSize(t,e){this.renderer.setSize(t,e,!1),this.composer.setSize(t,e)}loop(){p.vr.session||(this.renderer.setViewport(0,0,this.w*this._resolutionMultiplier,this.h*this._resolutionMultiplier),this.renderCamera())}renderCamera(){this.renderer.gammaOutput=!1,this.doPostProcessing?this.composer.render():this.renderer.render(p.game.scene,p.cam.camera);for(let t=this.afterFrameRenderCbs.length-1;t>=0;t--){let e=this.afterFrameRenderCbs[t];e.waitCount--,e.waitCount<=0&&(e.cb(),this.afterFrameRenderCbs.splice(t,1))}}async waitForFrameRender(t=1){return await new Promise(e=>{this.afterFrameRenderCbs.push({cb:e,waitCount:t})})}get supportsShadows(){return this.renderer.capabilities.maxTextures>8}async makeXRCompatible(){await this.renderer.context.makeXRCompatible()}setUseVr(t,e,i){this.usingVr=!0,this.renderer.setFramebuffer(t),this.setSize(e,i),this.renderer.autoClear=!1}setViewport(t,e,i,n,s=!1){this.renderer.setViewport(t,e,i,n),this.renderer.setScissorTest(s),s&&this.renderer.setScissor(t,e,i,n)}clearDepth(){this.renderer.clearDepth()}}class c{constructor(){this.registration=null,this.lastMessageWithResponseId=0,this.installationFailed=!1,this.didCacheWarning=!1,this.installSw(),c.supported&&navigator.serviceWorker.addEventListener("message",this.onSwWorkerMessage.bind(this)),this.onSwMessageCbs=[]}static get supported(){return"serviceWorker"in window.navigator&&!this.installationFailed&&!CORDOVA}async installSw(){if(c.supported){try{this.registration=await navigator.serviceWorker.register("sw.js")}catch(t){this.installationFailed=!0}this.registration&&(this.registration.onupdatefound=(t=>{if(null!=this.registration.active){let t=this.registration.installing;t.onstatechange=(e=>{"installed"==t.state&&p.mainMenu.showUpdateAvailable()})}}),await this.forceSingleTab())}}async forceSingleTab(){return await this.messageWithResponse("newWindow")}async openCache(){if("undefined"==typeof caches)return null;if(CORDOVA)return null;try{return await caches.open("mainCacheV"+VERSION_TIMESTAMP)}catch(t){return this.didCacheWarning||(this.didCacheWarning=!0,console.warn("unable to open cache!",t)),null}}async storeCache(t,e){if(CORDOVA)return;"Request"!=t.constructor.name&&(t=new Request(t)),"Response"!=e.constructor.name&&(e=new Response(e));let i=await this.openCache();i&&i.put(t,e)}async hasCachedUrl(t){if(CORDOVA)return!1;let e=await this.openCache();if(!e)return!1;let i=new Request(t);return!!await e.match(i,{ignoreSearch:!0})}sendMessage(t){this.registration&&this.registration.active&&this.registration.active.postMessage(t)}async messageWithResponse(t,e=null){if(CORDOVA)return null;let i=++this.lastMessageWithResponseId;return this.sendMessage({opCode:"messageWithResponse",opCode2:t,id:i,data:e}),await this.waitForSwResponse(i)}async waitForSwResponse(t){if(!CORDOVA)return await new Promise(e=>{this.onSwMessageCbs.push(i=>{if("messageWithResponse"==i.opCode&&i.id==t)return e(i.result),!0})})}onSwWorkerMessage(t){if(!CORDOVA){for(let e=this.onSwMessageCbs.length-1;e>=0;e--){(0,this.onSwMessageCbs[e])(t.data)&&this.onSwMessageCbs.splice(e,1)}t.data&&t.data.opCode&&"otherWindowOpened"==t.data.opCode&&p.accounts.showLoggedInElsewhere()}}}class u{constructor(){this.isInit=!1,this.supported=!1,this.onSupportedCbs=[],this.desiredSessionMode="immersive-vr",this.sessionModeOptions={mode:this.desiredSessionMode},this.legacySessionOptions={immersive:!0,exclusive:!0},this.session=null,this.baseLayer=null,this.referenceSpace=null,this.boundFrameLoop=this.frameLoop.bind(this),this.lastFrameTime=0,this.cameraTransformMatrix=new THREE.Matrix4,this.cameraTransformMatrix.compose(new THREE.Vector3(0,10,0),new THREE.Quaternion,new THREE.Vector3(30,30,30))}async init(){let t=!0,e=!1;if(navigator.getVRDisplays){(await navigator.getVRDisplays()).length>0&&(e=!0)}if(e)try{await Zt.addScript("https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.js");new WebXRPolyfill}catch(e){t=!1}if(navigator.xr||(t=!1),t)if(navigator.xr.supportsSession)try{await navigator.xr.supportsSession(this.desiredSessionMode)}catch(e){t=!1}else if(navigator.xr.supportsSessionMode)try{await navigator.xr.supportsSessionMode(this.desiredSessionMode)}catch(e){t=!1}else if(navigator.xr.requestDevice){let e=await navigator.xr.requestDevice();if(e.supportsSession)try{await e.supportsSession(this.legacySessionOptions)}catch(e){t=!1}}else t=!1;this.supported=t,this.isInit=!0;for(const i of this.onSupportedCbs)i(t);this.onSupportedCbs=[]}async requestSession(){if(this.supported){if(navigator.xr.requestSession){const t=await navigator.xr.requestSession(this.sessionModeOptions);this.session=t,await p.renderer.makeXRCompatible(),this.baseLayer=new XRWebGLLayer(this.session,p.renderer.renderer.context),this.session.updateRenderState({baseLayer:this.baseLayer}),this.referenceSpace=await this.session.requestReferenceSpace({type:"stationary",subtype:"eye-level"})}else if(navigator.xr.requestDevice){const t=await navigator.xr.requestDevice();this.session=await t.requestSession(this.legacySessionOptions),await p.renderer.renderer.context.setCompatibleXRDevice(t),this.baseLayer=this.session.baseLayer=new XRWebGLLayer(this.session,p.renderer.renderer.context),this.referenceSpace=await this.session.requestFrameOfReference("eye-level")}this.session.requestAnimationFrame(this.boundFrameLoop),p.cam.makeVrCamera(),p.renderer.setUseVr(this.baseLayer.framebuffer,this.baseLayer.framebufferWidth,this.baseLayer.framebufferHeight)}}frameLoop(t,e){if(p.renderer.renderer.clear(),e.getViewerPose){const t=e.getViewerPose(this.referenceSpace);if(t){let e=this.session.renderState.baseLayer;for(const i of t.views){const t=e.getViewport(i);p.renderer.setViewport(t.x,t.y,t.width,t.height,!0);let n=new THREE.Matrix4;n.fromArray(i.projectionMatrix);let s=new THREE.Matrix4;s.fromArray(i.viewMatrix).getInverse(s),s.premultiply(this.cameraTransformMatrix),p.cam.setMatrices(n,s),p.renderer.renderCamera()}}}else if(e.getDevicePose){const t=e.getDevicePose(this.referenceSpace);if(t){let i=this.baseLayer;for(const n of e.views){const e=i.getViewport(n);p.renderer.setViewport(e.x,e.y,e.width,e.height,!0);let s=new THREE.Matrix4;s.fromArray(n.projectionMatrix);let r=new THREE.Matrix4;r.fromArray(t.getViewMatrix(n)).getInverse(r),r.premultiply(this.cameraTransformMatrix),p.cam.setMatrices(s,r),p.renderer.renderCamera()}}}this.session.requestAnimationFrame(this.boundFrameLoop)}async waitForSupport(){return this.isInit?this.supported:await new Promise(t=>{this.onSupportedCbs.push(t)})}}class d{constructor(){this.loggingManager=new r,this.network=new Y,this.offlineServer=new X,this.sfx=new Yt,this.particles=new a,this.cam=new w,this.renderer=new h,this.vr=new u,this.game=new P,this.input=new F,this.staticConfig=new Jt,this.assets=new Ft,this.assetCache=new Ht,this.playerAssetsCache=new k,this.localPlayerManager=new R,this.playerStats=new B,this.cornerStats=new ct,this.leaderboard=new wt,this.hats=new A,this.colors=new rt,this.mainMenu=new Tt,this.cornerSettings=new lt,this.appearanceMenuManager=new et,this.loadScreen=new St,this.levelUI=new xt,this.winnerScreen=new Bt,this.gameOverScreen=new mt,this.curtain=new Pt,this.music=new Ut(this.sfx.ctx),this.serviceWorker=new c,this.ads=new i,this.poki=new l,this.accounts=new e,this.boundLoop=this.loop.bind(this),this.prevNow=0,this.now=0,this.dt=0,this.smoothDt=0,this.frameCount=0}init(){if(zt.init(),qt.init(),this.offlineServer.init(),this.sfx.init(),this.cam.init(),this.renderer.init(),this.vr.init(),this.game.init(),this.input.init(),this.staticConfig.init(),this.assets.init(),this.localPlayerManager.init(),this.playerAssetsCache.init(),this.cornerStats.init(),this.network.init(),this.leaderboard.init(),this.hats.init(),this.mainMenu.init(),this.cornerSettings.init(),this.levelUI.init(),this.winnerScreen.init(),this.gameOverScreen.init(),this.music.init(),this.ads.init(),this.poki.init(),this.accounts.init(),this.loop(),"true"!=Zt.lsGet("disable3rdParty")&&!CORDOVA){function t(){dataLayer.push(arguments)}Zt.addScript("https://noga.poki.io/gtag/js?id=UA-36765112-12"),window.dataLayer=window.dataLayer||[],t("js",new Date),t("config","UA-36765112-12",{anonymize_ip:!0})}}loop(){this.frameCount++;{let t=performance.now();this.prevNow<=0&&(this.prevNow=t);let e=Math.min(t-this.prevNow,50);this.now=t,this.dt=e,this.smoothDt=Zt.lerp(this.smoothDt,this.dt,.01),this.prevNow=t,this.dt16=this.dt/16.6666;let i=10;for(let n=0;n<i;n++)this.game.loopPhysics(e/i);this.game.loop(t,e),this.particles.loop(t,e),this.cam.loop(t,e),jt.loop(),this.input.loop(t,e),this.network.loop(t,e),this.leaderboard.loop(t,e),this.offlineServer.loop(t,e),this.appearanceMenuManager.loop(t,e),this.levelUI.loop(t,e),this.renderer.loop(t,e)}window.requestAnimationFrame(this.boundLoop)}}Symbol.myDictIterator=Symbol(),Object.prototype[Symbol.myDictIterator]=function*(){for(let t of Object.getOwnPropertyNames(this))yield[t,this[t]]},Object.defineProperty(Object.prototype,"keyValues",{get:function(){return this[Symbol.myDictIterator]()}}),void 0===window.CORDOVA&&(window.CORDOVA=!1),void 0===window.ANDROID&&(window.ANDROID=!1),void 0===window.IOS&&(window.IOS=!1),void 0===window.DEBUG&&(window.DEBUG=!0);var p=null,m=!1,f=!1;let g=!1,y=!1;if(console.log("loading nugget royale v"+VERSION_TIMESTAMP),CORDOVA){if(ANDROID){let t=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),e=parseInt(t[2],10);!isNaN(e)&&e<70&&alert('You seem to be using an old browser. Please search for "Android System WebView" in the Play Store and update it.')}document.addEventListener("deviceready",()=>{m=!0,v()})}else m=!0,v();function v(){"complete"==document.readyState&&m&&f&&!g&&(g=!0,(p=new d).init()),CORDOVA&&g&&!y&&(y=!0,navigator.splashscreen.hide())}document.currentScript.onload=function(){f=!0,v()},window.addEventListener("load",t=>{v()});class b{constructor(t){if(t=t||{},t={...{pos:new THREE.Vector3,allowHole:!0,allowRotation:!0,renderGeometry:!0,isSquareShape:!1,hasBorders:!1,scaleX:5,scaleZ:5,id:-1,name:"balancingObject",hasCollisions:!0,createHoleWarning:!0,meshType:"default",customGeoAsset:null,customGeoAssetPackage:null,customGeoAssetSize:1},...t},this.id=t.id,this.obj=new THREE.Object3D,this.obj.name=t.name,this.obj.position.copy(t.pos),this.hasCollisions=t.hasCollisions,this.renderGeometry=t.renderGeometry,this.isSquareShape=t.isSquareShape,this.hasBorders=t.hasBorders,this.geometry=[],this.diskMeshAdditions=[],this.donutMesh=null,this.customGeoAsset=t.customGeoAsset,this.customGeoAssetPackage=t.customGeoAssetPackage,this.customGeoAssetSize=t.customGeoAssetSize,this.renderGeometry)if(null!=this.customGeoAsset)this.assetObj=new THREE.Object3D,this.obj.add(this.assetObj);else if(this.isSquareShape){var e=new THREE.BoxGeometry(1,1,1),i=new THREE.MeshStandardMaterial({color:16777215});let t=new THREE.Mesh(e,i);t.scale.set(1,.1,1),this.obj.add(t),this.geometry.push(t)}else switch(this.donutMesh=new x(t.meshType),this.obj.add(this.donutMesh.mesh),t.meshType){case"ice":this.diskMeshAdditions.push(new pe);break;case"sumo":this.diskMeshAdditions.push(new me)}this.meshType=t.meshType,this.pos=t.pos,this.prevPos=new THREE.Vector3,this.posVelocity=new THREE.Vector3,this.allowHole=t.allowHole,this.allowRotation=t.allowRotation,this.lastAvgPlayerPos=new THREE.Vector2,this.avgPlayerPos=new THREE.Vector2,this.avgPlayerPosVelocity=new THREE.Vector2,this.customWeights=[],this.radius=5,this.holeRadius=0,this.didSetStartSlope=!1,this.maxSlope=5,this.playerWeightMultiplier=1,this.customWeightImpactMultiplier=1,this.playerPhysicsSettings=null,this.scaleX=t.scaleX,this.scaleZ=t.scaleZ,this.setPlatformScale(),this.prevShouldDoHoleWarning=!1,this.holeWarning=null,t.createHoleWarning&&(this.holeWarning=new L,this.holeWarning.obj.position.y=1,this.obj.add(this.holeWarning.obj)),this.rot=new THREE.Quaternion,this.prevRot=new THREE.Quaternion,this._upVector=new THREE.Vector3(0,1,0),this.destructed=!1}init(){this.customGeoAsset&&this.loadAsset(),this.holeWarning&&this.holeWarning.loadAsset();for(const t of this.diskMeshAdditions)t.init(this)}async loadAsset(){let t=await p.assetCache.getItem(this.customGeoAsset,this.customGeoAssetPackage);if(!this.obj)return;t.receiveShadow=!0,t.castShadow=!0;let e=t.clone();this.assetObj.add(e)}destructor(){this.obj.parent.remove(this.obj),this.obj=null,this.assetObj=null,this.donutMesh&&(this.donutMesh.destructor(),this.donutMesh=null);for(const t of this.diskMeshAdditions)t.destructor();this.diskMeshAdditions=[],this.pos=null,this.prevPos=null,this.posVelocity=null,this.lastAvgPlayerPos=null,this.avgPlayerPos=null,this.avgPlayerPosVelocity=null,this.holeWarning.destructor(),this.holeWarning=null,this.rot=null,this.prevRot=null,this._upVector=null,this.destructed=!0}get pos2d(){return new THREE.Vector2(this.pos.x,this.pos.z)}setPos(t){this.pos=t,this.obj.position.copy(this.pos)}loop(t,e){const i=p.game;this.posVelocity=this.pos.clone(),this.posVelocity.sub(this.prevPos),this.prevPos.copy(this.pos);let n=[];for(let r of i.players){if(r.lastTouchedDisk==this){let e=t-r.lastTouchedDiskLandTime,i=Zt.clamp01(1-.001*e),s=Zt.lerp(1,1+r.lastTouchedDiskFallSpeed*p.game.players.length,i);r.hasHeavyPotion&&(s+=1.5*(p.game.players.length-1)),n.push({pos:r.pos2d,weight:s,isPlayer:!0})}else if(r.lastTouchedDiskBeforeJump==this){let e=t-r.jumpReleaseTime,i=Math.max(0,(1-.003*e)*(1+.3*r.lastJumpAmount));n.push({pos:r.pos2d,weight:i,isPlayer:!0})}}for(const r of this.customWeights){let t=r.pos.clone();if(r.relativeToDiskSize&&(this.isSquareShape?(t.x*=this.scaleX*this.customGeoAssetSize,t.y*=this.scaleZ*this.customGeoAssetSize):t.multiplyScalar(this.radius)),!r.didVelocityImpact&&(r.didVelocityImpact=!0,r.velocityImpact>0)){let e=t.clone();e.sub(this.avgPlayerPos),this.avgPlayerPosVelocity.addScaledVector(e,r.velocityImpact*this.customWeightImpactMultiplier)}n.push({pos:t,weight:r.weight})}let s=new THREE.Vector2;if(n.length<=1&&s.copy(this.pos2d),n.length>1){let t=0;for(const e of n)t+=e.weight;for(const e of n){let i=e.weight;e.isPlayer&&(i*=this.playerWeightMultiplier);let n=i/t,r=e.pos.multiplyScalar(n);s.add(r)}}else if(1==n.length){let t=n[0];s.lerp(t.pos,t.weight)}if(this.lastAvgPlayerPos.copy(s),this.lastAvgPlayerPos.sub(this.pos2d),this.lastAvgPlayerPos.multiplyScalar(Zt.mapValue(20,5,1,2,this.radius,!0)),this.lastAvgPlayerPos.clampLength(0,this.maxSlope),!p.game.debugMainGame){let t=Zt.mapValue(3e3,8e3,0,1,p.game.serverTime,!0);this.lastAvgPlayerPos.multiplyScalar(t)}this.holeWarning&&this.holeWarning.loop(t,e)}setDiskSettings({radius:t=0,holeRadius:e=0,maxSlope:i=Zt.mapValue(-1,1,5,10,Math.cos(.001*p.game.serverTime)),maxSlopeMultiplier:n=1,playerWeightMultiplier:s=1,customWeightImpactMultiplier:r=1,shouldDoHoleWarning:a=!1,pos:o=null,startSlopeDiskId:l=-1,playerPhysicsSettings:h=null,isSquareShape:c=!1,meshType:u=null,customGeoAsset:d=null,customGeoAssetPackage:m=null,customGeoAssetSize:f=1}={}){if(c!=this.isSquareShape||u!=this.meshType&&null!=u||d!=this.customGeoAsset||m!=this.customGeoAssetPackage)return!0;if(this.radius=t,this.holeRadius=e,this.radius=Math.max(0,this.radius),this.holeRadius=Zt.clamp(this.holeRadius,0,this.radius),this.playerPhysicsSettings=h,this.customGeoAssetSize=f,this.allowHole||(this.holeRadius=0),l>=0&&!this.didSetStartSlope){this.didSetStartSlope=!0;let t=p.game.getBalancingObjectById(l);this.lastAvgPlayerPos.copy(t.lastAvgPlayerPos),this.avgPlayerPos.copy(t.avgPlayerPos),this.avgPlayerPosVelocity.copy(t.avgPlayerPosVelocity),this.rot.copy(t.rot),this.prevRot.copy(t.prevRot),this.obj.setRotationFromQuaternion(this.rot)}return this.maxSlope=Math.max(0,i*n),this.playerWeightMultiplier=s,this.customWeightImpactMultiplier=r,this.setPlatformScale(),o&&this.setPos(o),a!=this.prevShouldDoHoleWarning&&(this.prevShouldDoHoleWarning=a,a&&this.holeWarning&&p.game.gameStateManager.currentState==ft.GameState.STARTED&&this.holeWarning.startAnimation()),!1}loopPhysics(t){if(this.allowRotation){let e=this.lastAvgPlayerPos.clone();e.sub(this.avgPlayerPos);let i=Zt.mapValue(20,5,2e-5,5e-5,this.radius,!0);this.avgPlayerPosVelocity.addScaledVector(e,i*t);let n=.97,s=Zt.lerptt10(n,t/16.6666);this.avgPlayerPosVelocity.multiplyScalar(s),this.avgPlayerPos.addScaledVector(this.avgPlayerPosVelocity,t);let r=new THREE.Vector3(this.avgPlayerPos.x,0,this.avgPlayerPos.y).clone();r.cross(new THREE.Vector3(0,-1,0));let a=new THREE.Quaternion;a.setFromAxisAngle(r,.04),a.normalize(),this.prevRot=this.rot,this.rot=a,this.obj.setRotationFromQuaternion(a),this.calculateUpVector()}}calculateUpVector(){this._upVector.copy(this.obj.up).applyQuaternion(this.obj.quaternion)}get upVector(){return this._upVector.clone()}get slope(){let t=this.upVector;return new THREE.Vector2(t.x,t.z)}hasRadius(t,e=0){return t+e>this.holeRadius&&t-e<this.radius}hasPos(t,e,i){let n=this.scaleX*this.customGeoAssetSize,s=this.scaleZ*this.customGeoAssetSize;return!(t<this.pos2d.x-n-i)&&(!(t>this.pos2d.x+n+i)&&(!(e<this.pos2d.y-s-i)&&!(e>this.pos2d.y+s+i)))}getVelocityAtPosition(t){let e=t.clone();e.applyQuaternion(this.rot);let i=t.clone();return i.applyQuaternion(this.prevRot),e.sub(i),e.add(this.posVelocity),e}getRelativePos(t){return t.clone().sub(this.pos)}getAbsolutePos(t){return t.clone().add(this.pos)}getClosestRelativePosOnDisk(t,e=!0){let i=t.clone().projectOnPlane(this.upVector);return e&&(this.isSquareShape?(i.x=Zt.clamp(i.x,-this.scaleX*this.customGeoAssetSize,this.scaleX*this.customGeoAssetSize),i.z=Zt.clamp(i.z,-this.scaleZ*this.customGeoAssetSize,this.scaleZ*this.customGeoAssetSize),this.debug&&jt.drawRay(i,new THREE.Vector3(0,10,0))):i.clampLength(this.holeRadius,this.radius)),i}getClosestPosOnDisk(t,e=!0){let i=this.getRelativePos(t),n=this.getClosestRelativePosOnDisk(i,e);return this.getAbsolutePos(n)}testPlayerCollision(t){if(this.destructed)return null;if(!this.hasCollisions)return null;let e=this.upVector,i=this.getRelativePos(t.pos),n=this.getClosestRelativePosOnDisk(i),s=t.radius,r=i.distanceTo(n),a=!1;if(!this.isSquareShape&&this.radius-this.holeRadius<=0)return null;if(this.hasBorders&&this.isSquareShape){let t=this.scaleX*this.customGeoAssetSize,n=this.scaleZ*this.customGeoAssetSize,s=t-i.x;(s=Math.abs(s+2)-2)<r&&(r=s,a=!0,e=new THREE.Vector3(-1,0,0));let o=i.x+t;(o=Math.abs(o+2)-2)<r&&(r=o,a=!0,e=new THREE.Vector3(1,0,0));let l=n-i.z;(l=Math.abs(l+2)-2)<r&&(r=l,a=!0,e=new THREE.Vector3(0,0,-1));let h=i.z+n;(h=Math.abs(h+2)-2)<r&&(r=h,a=!0,e=new THREE.Vector3(0,0,1))}return r>s?null:{type:"disk",player:t,disk:this,penetration:s-r,normal:e,diskVelocity:this.getVelocityAtPosition(n),touchedBorder:a}}setPlatformScale(){if(this.renderGeometry){if(this.customGeoAsset)this.assetObj.scale.setScalar(this.customGeoAssetSize);else if(this.isSquareShape){let t=this.geometry[0];t.scale.setX(2*this.scaleX*this.customGeoAssetSize),t.scale.setZ(2*this.scaleZ*this.customGeoAssetSize)}else this.donutMesh.updateVertices(this.radius,this.holeRadius);for(const t of this.diskMeshAdditions)t.update()}}getSafestPos(t){if(t||(t=new THREE.Vector3),this.isSquareShape)return new THREE.Vector3(this.pos.x,this.pos.y,this.pos.z);let e=t.clone(),i=0;if(this.holeRadius>1&&(i=(this.radius+this.holeRadius)/2,e.length()>i)){let t=this.slope;t.setLength(this.radius/2),e.x-=t.x,e.z-=t.y}let n=new THREE.Vector3(e.x,0,e.z);if(n.length()<=0&&(n.x=Zt.randRange(-1,1),n.z=Zt.randRange(-1,1)),n.clampLength(i,i),n.add(this.pos),this.holeRadius<1){let t=this.slope;t.setLength(this.radius/2),n.x-=t.x,n.z-=t.y}return n}getRandomPosOnSquare(){return new THREE.Vector3(this.pos.x+Zt.randRange(-this.scaleX,this.scaleX)*this.customGeoAssetSize,this.pos.y,this.pos.z+Zt.randRange(-this.scaleZ,this.scaleZ)*this.customGeoAssetSize)}getFrictionAmountForPos(t){let e=this.upVector;if(e.y>.997)return 0;let i=e.projectOnPlane(new THREE.Vector3(0,1,0));i.normalize();let n=.05;return n-=t.clone().projectOnVector(i).dot(i),this.playerPhysicsSettings&&(this.playerPhysicsSettings.frictionMultiplier||0==this.playerPhysicsSettings.frictionMultiplier)&&(n*=this.playerPhysicsSettings.frictionMultiplier),Zt.clamp01(n)}addCustomWeight(t){let e=new T(t);return this.customWeights.push(e),e}removeCustomWeight(t){let e=this.customWeights.indexOf(t);e>=0&&this.customWeights.splice(e,1)}}class w{constructor(){this.camera=new THREE.PerspectiveCamera(75,1,.1,1e3),this.isVrCamera=!1,this.deathShakeStartTime=0,this.chickenBoxCamBasePosition=new THREE.Vector3(-60,60,160),this.camSmoothing=!0,this.setCamSmoothingNextFrame=!1,this.allowControlling=!1,this.mainMenuBecameVisible=!1,this.temporaryDeathPlayerPositions=[],this.smoothTarget=new THREE.Vector3,this.smoothCamPos=new THREE.Vector3,this.smoothCamDist=15,this.smoothFov=70,this.controller=new E,qt.addListener(t=>{this.onResize()}),this.onResize(),this.uwMultiplier=1,this.uhMultiplier=1,this.mainMenuMousePos=new THREE.Vector2,this.smoothMainMenuMousePos=new THREE.Vector2,window.addEventListener("mousemove",t=>{this.mainMenuMousePos.set(t.pageX,t.pageY),this.mainMenuMousePos.x/=window.innerWidth,this.mainMenuMousePos.y/=window.innerHeight,this.mainMenuMousePos.x-=.5,this.mainMenuMousePos.y-=.5})}init(){this.doFastCut(),this.controller.init()}onResize(t=document.documentElement.clientWidth,e=document.documentElement.clientHeight){this.isVrCamera||(this.aspect=t/e,this.updateProjectionMatrix())}loop(t,e){if(this.isVrCamera)return;let i=p.game.gameStateManager.currentState,n=new THREE.Vector3,s=new THREE.Vector3,r=15,a=75,o=.1,l=.1,h=!0,c=.03,u=0;if(p.game.debugMainGame)n.set(0,0,0),r=20,s.set(-1,.5,0);else if(p.mainMenu.visible)n.set(-90,128,160),s.set(-1,0,0),r=30,a=70,this.mainMenuBecameVisible&&(this.mainMenuBecameVisible=!1,r+=3,a-=2),h=!1,l=.999,n.z-=2*this.mainMenuMousePos.x,n.y+=2*this.mainMenuMousePos.y,this.smoothMainMenuMousePos.lerp(this.mainMenuMousePos,Zt.lerpt01(c)),o=Zt.clamp01(this.smoothTarget.distanceTo(n)-3),p.mainMenu.offsetUI(30*this.smoothMainMenuMousePos.x,30*this.smoothMainMenuMousePos.y);else if(i==ft.GameState.INVALID||i==ft.GameState.WAITING_FOR_PLAYERS){let t=0,e=0;for(const i of p.game.getMyControllablePlayers()){n.add(i.pos),t++;for(const t of p.game.getMyControllablePlayers()){let n=i.pos.distanceTo(t.pos);e=Math.max(e,n)}}t>0?(n.divideScalar(t),r=Zt.mapValue(-64,-67,7,13,n.x,!0),r=Math.max(r,.5*e)):(n.copy(this.chickenBoxCamBasePosition),r=15),n.x=Math.max(n.x,-66),s.set(-1,1,0)}else if(i==ft.GameState.STARTING)n.set(-60,60,160),s.set(-1,1,0),r=15;else if(i==ft.GameState.STARTED||i==ft.GameState.SHOW_WINNER){let t=Date.now()-p.game.gameStateManager.gameStartTime,e=t<2100,a=0,o=p.game.hasControllablePlayer(),l=0;for(let i=this.temporaryDeathPlayerPositions.length-1;i>=0;i--){let t=this.temporaryDeathPlayerPositions[i],e=p.now-t.time,s=Math.min(1,2-.001*e);l=Math.max(l,s),s<0&&this.temporaryDeathPlayerPositions.splice(i,1);let r=t.pos.clone();r.multiplyScalar(s),n.add(r),a+=s}for(const i of p.game.players){if(i.died)continue;if(o&&!i.controllableByMe)continue;if(!i.controllableByMe&&!i.isSpawnStartAnimatingBelt){let t=i.pos;if(t.y=0,t.length()>50)continue}let t=1;i.controllableByMe||(t=1-l),n.add(i.playerObj.position.clone().multiplyScalar(t)),a+=t}if(a>0&&n.divideScalar(a),e)n.x=0,n.add(new THREE.Vector3(0,0,-18)),s.set(-1,.7,.5),r=20,c=.1,u=1;else{let e=10+.1*p.game.players.length,n=0,a=[];for(const t of p.game.getMyControllablePlayers())a.push(t.pos);for(const t of this.temporaryDeathPlayerPositions)a.push(t.pos);for(const t of a)for(const e of a){let i=t.distanceTo(e);n=Math.max(n,i)}let o=4*Math.sqrt(n);r=Math.max(e,o);let l=Math.PI,h=p.game.stageManager.currentStageSettings.rotateCam;(h||void 0===h)&&(l=5e-5*t,l+=3),s.x+=Math.cos(l),s.z+=Math.sin(l),s.y+=1,i==ft.GameState.SHOW_WINNER&&(r=5)}}if(this.camSmoothing){this.smoothTarget.lerp(n,Zt.lerpt01(o));let t=h?o:l;this.smoothCamDist=Zt.lerpt(this.smoothCamDist,r,t),this.smoothFov=Zt.lerpt(this.smoothFov,a,.025)}else this.smoothTarget.copy(n),this.smoothCamDist=r,this.smoothFov=a;let d=n.clone();if(d.addScaledVector(s,this.smoothCamDist),i!=ft.GameState.WAITING_FOR_PLAYERS||p.mainMenu.visible||(d.x=Math.max(d.x,-74)),this.camSmoothing?this.smoothCamPos.lerp(d,Zt.lerpt01(c)):this.smoothCamPos.copy(d),this.controller.loop(t,e),this.controller.isControlling)this.camera.position.copy(this.controller.pos),this.camera.rotation.copy(this.controller.rot);else{this.camera.position.copy(this.smoothCamPos),this.updateProjectionMatrix();let e=50,i=Zt.mod(t,e)/e,n=Math.floor(t/e),s=new THREE.Vector3(Zt.randSeed(n),Zt.randSeed(n+3e3),Zt.randSeed(n+8e3)),r=new THREE.Vector3(Zt.randSeed(n+1),Zt.randSeed(n+3001),Zt.randSeed(n+8001)),a=s.clone().lerp(r,i),o=this.smoothTarget.clone();o.addScaledVector(a,u),this.camera.lookAt(o)}if(!p.mainMenu.visible){let e=t-this.deathShakeStartTime,i=1-.002*e,n=.001*Math.sin(.03*e)*Zt.clamp01(i),s=this.camera.position.clone().sub(this.smoothTarget);this.camera.rotateOnWorldAxis(s,n)}this.setCamSmoothingNextFrame&&(this.setCamSmoothingNextFrame=!1,this.camSmoothing=!0)}updateProjectionMatrix(){this.camera.projectionMatrix=w.createDynamicAspectProjection(this.smoothFov,this.aspect,.55)}static createDynamicAspectProjection(t=90,e=1,i=1,n=.05,s=1e3){let r=Math.max(i,1/e),a=r*e;return this.createProjection(t,n,s,r,a)}static createProjection(t=90,e=.05,i=1e3,n=1,s=1){const r=new THREE.Matrix4;let a=1/Math.tan(t/2*(Math.PI/180)),o=a;a*=n,o*=s;const l=1/(i-e);return r.elements[0]=a,r.elements[5]=o,r.elements[10]=-i*l,r.elements[14]=-i*e*l,r.elements[11]=-1,r.elements[15]=0,r}doFastCut(){this.camSmoothing=!1,this.setCamSmoothingNextFrame=!0}getInputDirection(t,e=!1){let i=new THREE.Quaternion;this.camera.getWorldQuaternion(i);let n=new THREE.Vector3;n.copy(this.camera.up),n.applyQuaternion(i);let s=new THREE.Vector3(0,0,1),r=new THREE.Matrix4;r.extractRotation(this.camera.matrix),s.applyMatrix4(r);let a=s.clone();a.cross(new THREE.Vector3(0,1,0)),a.normalize();let o=s.clone();return e||(o.y=0),o.normalize(),a.multiplyScalar(-t.x),o.multiplyScalar(-t.y),a.add(o)}doDeathCamShake(){this.deathShakeStartTime=p.now}makeVrCamera(){this.isVrCamera=!0,this.camera.matrixAutoUpdate=!1}setMatrices(t,e){this.camera.matrix.copy(e),this.camera.projectionMatrix.copy(t),this.camera.matrixWorldNeedsUpdate=!0}onMainMenuVisible(){this.doFastCut(),this.mainMenuBecameVisible=!0}addTemporaryDeathPlayerPos(t){this.temporaryDeathPlayerPositions.push({time:p.now,pos:t})}}class x{constructor(t="default"){this.circleVertexCount=50,this.meshSettings=x.getMeshSettings(t),this.geometry=new THREE.BufferGeometry;let e=this.calculateVertices();this.posAttribute=new THREE.BufferAttribute(new Float32Array(e.vertices),3),this.indexAttribute=new THREE.BufferAttribute(new Uint16Array(this.calculateIndices()),1),this.normalAttribute=new THREE.BufferAttribute(new Float32Array(this.calculateNormals()),3),this.uvsAttribute=new THREE.BufferAttribute(new Float32Array(e.uvs),2),this.posAttribute.dynamic=!0,this.geometry.addAttribute("position",this.posAttribute),this.geometry.addAttribute("normal",this.normalAttribute),this.geometry.addAttribute("uv",this.uvsAttribute),this.geometry.setIndex(this.indexAttribute),this.mesh=new THREE.Mesh(this.geometry,this.meshSettings.material),this.mesh.receiveShadow=!0,this.mesh.castShadow=!0,this.setMeshGroups()}destructor(){this.geometry.dispose(),this.geometry=null,this.meshSettings=null,this.posAttribute=null,this.indexAttribute=null,this.normalAttribute=null,this.uvsAttribute=null,this.mesh.parent.remove(this.mesh),this.mesh=null}setMeshGroups(){this.geometry.addGroup(0,12*this.circleVertexCount,0),this.geometry.addGroup(12*this.circleVertexCount,4*this.circleVertexCount*3,1)}static getMeshSettings(t="default"){return this.cachedMaterials||(this.cachedMaterials=[{name:"default",material:new THREE.MeshStandardMaterial,roughness:1,metalness:.34,textureEncoding:THREE.LinearEncoding},{name:"ice",material:new THREE.MeshStandardMaterial,texturesAssetPackageName:"themeIceDisk",roughness:0,metalness:1,textureEncoding:THREE.sRGBEncoding,forceTopScale:!0,topScale:.48},{name:"sumo",material:new THREE.MeshStandardMaterial,texturesAssetPackageName:"themeSumoDisk",roughness:.86,metalness:0,textureEncoding:THREE.sRGBEncoding,forceTopScale:!0,topScale:.48},{name:"saws",material:new THREE.MeshStandardMaterial,texturesAssetPackageName:"themeSawsDisk",roughness:.9,metalness:.15,textureEncoding:THREE.sRGBEncoding,forceTopScale:!0,topScale:.48},{name:"knives",material:new THREE.MeshStandardMaterial,texturesAssetPackageName:"themeSawsDisk",roughness:.9,metalness:.15,textureEncoding:THREE.sRGBEncoding,forceTopScale:!0,topScale:.48}],this.loadMaterials()),this.cachedMaterials.find(e=>e.name==t)}static async loadMaterials(){this.loadEnvMap(),await p.assets.waitForAccurateQuality();let t=p.assets.bestMainIsHQ;await this.setDefaultMaterialTextures(),t||(await p.assets.waitForHQLoad(),await this.setDefaultMaterialTextures()),await this.setMaterialTextures()}static async setDefaultMaterialTextures(){let t=await p.assets.bestMain.getTexture("disk/disk_top_albedo.png",{encoding:this.cachedMaterials[0].textureEncoding}),e=await p.assets.bestMain.getTexture("disk/disk_top_metallic.png",{encoding:this.cachedMaterials[0].textureEncoding}),i=await p.assets.bestMain.getTexture("disk/disk_top_normal.png",{encoding:this.cachedMaterials[0].textureEncoding});for(const n of this.cachedMaterials){let s=n.material;s.map=t,s.normalMap=i,s.roughness=this.cachedMaterials[0].roughness,s.metalness=this.cachedMaterials[0].metalness,s.roughnessMap=e,s.metalnessMap=e,s.shadowSide=THREE.DoubleSide,s.side=THREE.DoubleSide,s.needsUpdate=!0}}static async setMaterialTextures(){for(const t of this.cachedMaterials){let e=t.texturesAssetPackageName;if(!e)continue;let i=p.assets.getPackage(e),n=await i.getTexture("disk_top_albedo.png",{encoding:t.textureEncoding}),s=await i.getTexture("disk_top_metallic.png",{encoding:t.textureEncoding}),r=await i.getTexture("disk_top_normal.png",{encoding:t.textureEncoding}),a=t.material;a.name=t.name,a.map=n,a.normalMap=r,a.roughness=t.roughness,a.metalness=t.metalness,a.roughnessMap=s,a.metalnessMap=s,a.needsUpdate=!0}}static async loadEnvMap(){let t=await p.game.getEnvMap();for(const e of this.cachedMaterials)e.material.envMap=t,e.material.needsUpdate=!0}calculateVertices(t=10,e=0){let i=new Array(3*this.circleVertexCount*8),n=new Array(2*this.circleVertexCount*6),s=Zt.mapValue(5,20,-.3,-3,t,!0);this.circleVertexCount,this.circleVertexCount;for(let r=0;r<this.circleVertexCount;r++){let a=r/this.circleVertexCount*Math.PI*2,o=Math.cos(a),l=Math.sin(a);i[24*r+0]=o*e,i[24*r+1]=s,i[24*r+2]=l*e,i[24*r+3]=o*e,i[24*r+4]=0,i[24*r+5]=l*e,i[24*r+6]=o*e,i[24*r+7]=0,i[24*r+8]=l*e,i[24*r+9]=o*t,i[24*r+10]=0,i[24*r+11]=l*t,i[24*r+12]=o*t,i[24*r+13]=0,i[24*r+14]=l*t,i[24*r+15]=o*t,i[24*r+16]=s,i[24*r+17]=l*t,i[24*r+18]=o*t,i[24*r+19]=s,i[24*r+20]=l*t,i[24*r+21]=o*e,i[24*r+22]=s,i[24*r+23]=l*e;let h=this.circleVertexCount/2,c=(Math.abs(r-h),Math.min(.02,.4/t));this.meshSettings.forceTopScale&&(c=this.meshSettings.topScale/t),n[16*r+4]=o*c*e+.5,n[16*r+5]=l*c*e+.5,n[16*r+6]=o*c*t+.5,n[16*r+7]=l*c*t+.5,n[16*r+12]=o*c*t+.5,n[16*r+13]=l*c*t+.5,n[16*r+14]=o*c*e+.5,n[16*r+15]=l*c*e+.5,n[16*r+0]=.25*o+.5,n[16*r+1]=.25*l+.5,n[16*r+2]=.3*o+.5,n[16*r+3]=.3*l+.5,n[16*r+8]=.25*o+.5,n[16*r+9]=.25*l+.5,n[16*r+10]=.3*o+.5,n[16*r+11]=.3*l+.5}return{vertices:i,uvs:n}}calculateNormals(){let t=new Array(3*this.circleVertexCount*6);this.circleVertexCount;for(let e=0;e<this.circleVertexCount;e++){let i=e/t.length*Math.PI*2,n=Math.cos(i),s=Math.sin(i);t[24*e+0]=n,t[24*e+1]=0,t[24*e+2]=s,t[24*e+3]=n,t[24*e+4]=0,t[24*e+5]=s,t[24*e+6]=0,t[24*e+7]=1,t[24*e+8]=0,t[24*e+9]=0,t[24*e+10]=1,t[24*e+11]=0,t[24*e+12]=-n,t[24*e+13]=0,t[24*e+14]=-s,t[24*e+15]=-n,t[24*e+16]=0,t[24*e+17]=-s,t[24*e+18]=0,t[24*e+19]=-1,t[24*e+20]=0,t[24*e+21]=0,t[24*e+22]=-1,t[24*e+23]=0}return t}calculateIndices(){let t=new Array(3*this.circleVertexCount*8),e=8*this.circleVertexCount,i=8*this.circleVertexCount,n=12*this.circleVertexCount;for(let s=0;s<t.length;s++)t[s]=0;for(let s=0;s<this.circleVertexCount;s++)t[12*s+0]=(8*s+2)%e,t[12*s+1]=(8*s+11)%e,t[12*s+2]=(8*s+3)%e,t[12*s+3]=(8*s+2)%e,t[12*s+4]=(8*s+10)%e,t[12*s+5]=(8*s+11)%e,t[12*s+6]=(8*s+7)%e,t[12*s+7]=(8*s+14)%e,t[12*s+8]=(8*s+6)%e,t[12*s+9]=(8*s+7)%e,t[12*s+10]=(8*s+15)%e,t[12*s+11]=(8*s+14)%e,t[12*s+n+0]=(8*s+0)%i,t[12*s+n+1]=(8*s+9)%i,t[12*s+n+2]=(8*s+1)%i,t[12*s+n+3]=(8*s+0)%i,t[12*s+n+4]=(8*s+8)%i,t[12*s+n+5]=(8*s+9)%i,t[12*s+n+6]=(8*s+4)%i,t[12*s+n+7]=(8*s+12)%i,t[12*s+n+8]=(8*s+13)%i,t[12*s+n+9]=(8*s+4)%i,t[12*s+n+10]=(8*s+13)%i,t[12*s+n+11]=(8*s+5)%i;return t}updateVertices(t,e){let i=this.calculateVertices(t,e);this.posAttribute.set(i.vertices),this.posAttribute.needsUpdate=!0,this.uvsAttribute.set(i.uvs),this.uvsAttribute.needsUpdate=!0,this.geometry.boundingSphere&&(this.geometry.boundingSphere.radius=t)}}class S{constructor(){this.obj=new THREE.Object3D,this.linkedDisk=null,this.scalePosWithDisk=!0,this.pos2d=new THREE.Vector2,p.game.scene.add(this.obj),this.loadAsset(),this.rotOffset=new THREE.Quaternion,this.setRot()}destructor(){this.linkedDisk=null,this.obj.parent&&this.obj.parent.remove(this.obj),this.obj=null,this.material&&this.material.dispose(),this.material=null}static async getTexture(){return this.cachedTexture||(this.cachedTexture=await p.assets.mainHQ.getTexture("circleShadow.png")),this.cachedTexture}async loadAsset(){let t=await S.getTexture(),e=new THREE.MeshBasicMaterial;if(e.map=t,e.transparent=!0,e.depthWrite=!1,this.material=e,!this.obj)return;let i=new THREE.PlaneBufferGeometry,n=new THREE.Mesh(i,e);this.obj.add(n)}setLinkedDisk(t){this.linkedDisk=t}updatePos(t=null){if(t&&this.pos2d.copy(t),this.linkedDisk&&this.linkedDisk.pos){let t=new THREE.Vector3(this.pos2d.x,0,this.pos2d.y);this.scalePosWithDisk&&(this.linkedDisk.isSquareShape?(t.x*=this.linkedDisk.scaleX*this.linkedDisk.customGeoAssetSize,t.z*=this.linkedDisk.scaleZ*this.linkedDisk.customGeoAssetSize):(t.x*=this.linkedDisk.radius,t.z*=this.linkedDisk.radius)),this.linkedDisk.obj.localToWorld(t),this.obj.position.copy(t),this.obj.quaternion.copy(this.rotOffset),this.obj.quaternion.premultiply(this.linkedDisk.obj.quaternion)}}setScale(t,e){this.obj.scale.set(e,t,1)}setOpacity(t){this.material&&(this.material.opacity=t)}setRot(t=0){this.rotOffset.setFromAxisAngle(new THREE.Vector3(1,0,0),.5*-Math.PI),this.rotOffset.premultiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),t))}}class E{constructor(){this.pos=new THREE.Vector3,this.rot=new THREE.Euler,this.velocity=new THREE.Vector3,this.allowControlling=!1,this.isControlling=!1,this.spectateIcon=document.createElement("div"),this.spectateIcon.classList.add("spectateIcon","hidden"),document.body.appendChild(this.spectateIcon)}init(){let t=p.input.touch.touchListener;t.addEventListener("click",e=>{this.allowControlling&&(this.pointerIsLocked?this.setIsControlling(!1):t.requestPointerLock())}),t.addEventListener("mousemove",t=>{this.isControlling&&this.pointerIsLocked&&this.addCamRot(t.movementX,t.movementY,.004)}),document.addEventListener("pointerlockchange",t=>{this.setIsControlling(this.pointerIsLocked)})}get pointerIsLocked(){return document.pointerLockElement==p.input.touch.touchListener}setIsControlling(t){this.isControlling!=t&&(this.isControlling=t,t?(this.pos=p.cam.camera.position,this.rot.copy(p.cam.camera.rotation),this.rot.reorder("YXZ"),this.rot.z=0):this.exitPointerLock(),p.game.updateSpectateTextVisibility(),p.mainMenu.updateUIVisibilities(),this.spectateIcon.classList.toggle("hidden",!t))}addCamRot(t,e,i){this.rot.x-=e*i,this.rot.y-=t*i,this.rot.x=Zt.clamp(this.rot.x,-Math.PI/2,Math.PI/2)}loop(t,e){let i=new THREE.Vector2,n=new THREE.Vector2,s=!1,r=!1;for(const a of p.localPlayerManager.localPlayers)for(const t of a.inputs)i.add(t.currentInputDirection2D),n.add(t.lookInputDirection),t.jumpPressed&&(s=!0),t.flyDownPressed&&(r=!0);if(this.isControlling){let t=p.cam.getInputDirection(i,!0);this.velocity.add(t),this.addCamRot(n.x,n.y,.1),s&&(this.velocity.y+=1),r&&(this.velocity.y-=1);let a=Zt.lerptt10(.8,e/16.6666);this.velocity.multiplyScalar(a),this.pos.addScaledVector(this.velocity,.01*e),this.posHor=new THREE.Vector2(this.pos.x,this.pos.z),p.game.debugMainGame||(this.posHor.clampLength(0,90),this.pos.x=this.posHor.x,this.pos.z=this.posHor.y,this.pos.y=Zt.clamp(this.pos.y,-50,90))}else this.allowControlling&&n.length()>0&&this.setIsControlling(!0)}setAllowControlling(t){this.allowControlling=t,t||this.setIsControlling(!1)}exitPointerLock(){document.exitPointerLock&&document.exitPointerLock()}}class M{constructor(t,e){this.obj=new THREE.Object3D,this.linkedDisk=t,this.loadAsset();let i=Zt.randRange(0,2*Math.PI);this.linkedDisk.isSquareShape?(this.localPosition=new THREE.Vector3(0,0,0),Math.random()<.5?(this.localPosition.x=Math.random()>.5?-1:1,this.localPosition.z=Zt.randRange(-1,1)):(this.localPosition.x=Zt.randRange(-1,1),this.localPosition.z=Math.random()>.5?-1:1)):this.localPosition=new THREE.Vector3(Math.cos(i),0,Math.sin(i)),this.diskSizePosOffset=Zt.randRange(.8,2.5),this.radius=2,this.animationSpeed=Zt.randRange(.9,1.1),this.flyingToPlayer=null,this.playerPickupStartTime=0,this.playerPickupStartPos=new THREE.Vector3,this.spawnTime=p.now,this.despawnTime=-1,this.isDespawningWithDelay=!1,e&&p.sfx.playSound("chicken/spawn"),this.loop(0,16),this.destroyNextFrame=!1}destructor(){this.obj.parent.remove(this.obj),this.obj=null,this.linkedDisk=null}get pos(){return this.obj.position.clone()}static async getSeedAsset(){if(!this.cachedObject){let t=await p.assets.main.getGltfObject("corn.glb");this.cachedObject=t.scene.children[0],this.cachedObject.scale.setScalar(.36),this.cachedObject.castShadow=!0}return this.cachedObject}async loadAsset(){let t=(await M.getSeedAsset()).clone();this.obj&&this.obj.add(t)}loop(t,e){if(this.obj.rotation.y=.003*p.game.serverTime*this.animationSpeed,this.flyingToPlayer){let t=.004*(p.game.serverTime-this.playerPickupStartTime);t>1&&(this.destroyNextFrame=!0),t=Gt.in(Zt.clamp01(t)),this.obj.position.lerpVectors(this.playerPickupStartPos,this.flyingToPlayer.pos,t),this.obj.scale.setScalar(Math.max(.001,1-t))}else if(this.linkedDisk&&this.linkedDisk.obj){{let e=.004*(t-this.spawnTime);e=Gt.out(Zt.clamp01(e)),e=Math.max(.001,e),this.obj.scale.setScalar(e)}let e=this.localPosition.clone();if(this.linkedDisk.isSquareShape)e.x*=this.linkedDisk.scaleX*this.linkedDisk.customGeoAssetSize,e.x>0?e.x=Math.max(.1,e.x-this.diskSizePosOffset):e.x=Math.min(-.1,e.x+this.diskSizePosOffset),e.z*=this.linkedDisk.scaleZ*this.linkedDisk.customGeoAssetSize,e.z>0?e.z=Math.max(.1,e.z-this.diskSizePosOffset):e.z=Math.min(-.1,e.z+this.diskSizePosOffset);else{let t=this.linkedDisk.radius-this.diskSizePosOffset;t=Math.max(.1,t),e.setLength(t)}this.linkedDisk.obj.localToWorld(e),e.y+=.4*Math.cos(.007*p.game.serverTime*this.animationSpeed)+.3,this.obj.position.copy(e)}else this.destroyNextFrame=!0;if(this.despawnTime>=0&&p.game.serverTime>this.despawnTime){let t=.004*(p.game.serverTime-this.despawnTime);t=1-t,(t=Gt.out(Zt.clamp01(t)))<0?this.destroyNextFrame=!0:(t=Math.max(.001,t),this.obj.scale.setScalar(t))}}playerTouched(t){this.destroyNextFrame||this.flyingToPlayer||this.isDespawningWithDelay||(p.network.sendAteCorn(t.playerId),this.flyingToPlayer=t,this.playerPickupStartTime=p.game.serverTime,this.playerPickupStartPos.copy(this.pos),p.sfx.playSound("cornEat"))}despawnWithDelay(){this.isDespawningWithDelay||(this.isDespawningWithDelay=!0,this.despawnTime=p.game.serverTime+Zt.randRange(0,2e3))}}class T{constructor({pos:t=new THREE.Vector2,weight:e=1,relativeToDiskSize:i=!0,velocityImpact:n=0}){this.pos=t,this.weight=e,this.relativeToDiskSize=i,this.didVelocityImpact=!1,this.velocityImpact=n}setPos(t){this.pos.copy(t)}setPos3d(t){this.pos.x=t.x,this.pos.y=t.z}}class C{constructor(t){this.obj=new THREE.Object3D,this.obj.name="dashLine",this.obj.position.y=-.878,this.offsetObj=new THREE.Object3D,this.offsetObj.name="dashLine offset",this.obj.add(this.offsetObj),this.material=new THREE.MeshBasicMaterial({color:65280}),this.spheres=[],this.bigSphere=C.createSphere(this.material),this.bigSphere.name="bigSphere",this.bigSphere.scale.setScalar(.3);let e=C.createSphere(C.getWhiteMaterial());e.name="bigWhiteSphere",e.scale.setScalar(1.2),this.bigSphere.add(e),this.offsetObj.add(this.bigSphere),this.visible=!0,this.renderObject=!1,this.playerObject=t,this.length=0,this.angle=0,this.isBlinking=!1,this.isShaking=!0,this.update()}destructor(){this.obj=null,this.offsetObj=null,this.material.dispose(),this.material=null,this.spheres=[],this.bigSphere=null,this.playerObject=null}static getGeo(){return null==this.sphereGeo&&(this.sphereGeo=new THREE.SphereBufferGeometry(1,7,4)),this.sphereGeo}static getWhiteMaterial(){return null==this.whiteMaterial&&(this.whiteMaterial=new THREE.MeshBasicMaterial({color:16777215,side:THREE.BackSide})),this.whiteMaterial}static createSphere(t){let e=this.getGeo(),i=new THREE.Mesh(e,t);return i.name="sphere",i}update(t){let e=this.length>0&&this.visible;if(this.renderObject!=e&&(this.renderObject=e,e?this.playerObject.add(this.obj):this.playerObject.remove(this.obj)),!e)return;this.offsetObj.position.x=this.length;let i=Math.round(this.length);for(;this.spheres.length!=i;)if(this.spheres.length<i){let t=C.createSphere(this.material);t.scale.setScalar(.1);let e=C.createSphere(C.getWhiteMaterial());e.scale.setScalar(1.5),t.add(e),this.offsetObj.add(t),this.spheres.push(t),t.position.x=-this.spheres.length}else{let t=this.spheres[this.spheres.length-1];this.offsetObj.remove(t),this.spheres.splice(-1,1)}this.isBlinking&&Math.cos(.03*t)>0?this.material.color.setRGB(.5,.5,.5):(this.material.color.setRGB(1,1,0),this.material.color.lerpHSL(new THREE.Color(1,0,0),this.length/10)),this.obj.rotation.z=this.angle;let n=.02*Zt.clamp01(this.length-5);this.isShaking||(n=0),this.obj.rotation.y=Math.cos(.07*t)*n}}class P{constructor(){this.debugMainGame=!1,this.players=[],this.slicedPlayerTopHalfs=[],this.potions=[],this.balancingObjects=[],this.stageObjects=[],this.stageObjectTypes={saw:de,knife:ue},this.cornSeeds=[],this.timeScale=1,this.timeScaleChanges=[],this.debugMainGame||(this.lobbyBalancingObject=new b({id:0,pos:new THREE.Vector3(-60,60,160),allowHole:!1,allowRotation:!1,isSquareShape:!0,hasBorders:!0,scaleX:12.5,scaleZ:18,renderGeometry:!1,createHoleWarning:!1,name:"lobbyBalancingObject"}),this.balancingObjects.push(this.lobbyBalancingObject)),this.mainBalancingObjects=[],this.gameStateManager=new ft,this.scene=new THREE.Scene,jt.setCurrentScene(this.scene);for(const t of this.balancingObjects)t&&this.scene.add(t.obj);this.grinderRollerRotation=0,this.grinderRollers=[],this.currentGrinderAssetPath=null,this.configValuesLoaded=!1,this.midJoinMinPlayers=0,this.midJoinMinScore=0,this.midJoinMinPlayersForScore=0,this.bgColor=0,this.envMap=null,this.onEnvMapLoadCbs=[],this.scene.fog=new THREE.FogExp2(this.bgColor,.01),this.scene.background=new THREE.Color(this.bgColor),this.menuObject=null,this.menuParticlesObj=null,this.createdMenuParticles=[],this.arenaObject=null,this.arenaMaterialSwitcher=null,this.beltObject=null,this.conveyorBeltSwitcher=null,this.chickenboxObj=null,this.chickenboxSwitcher=null,this.lights=new s,this.stageManager=new _,this.didLoadEnvironment=!1,this.environmentLoadProgressCbs=[],this.onEnvironmentLoadCbs=[],this.doorsAnimating=!0,this.doorsOpen=!1,this.doorsOpenAmount=0,this.grinderSound=null,this.didHaveControllablePlayerThisGame=!1,this.spectatingMessage=new pt("",{color:0,multiLine:!1,maxWidthPercent:.7,maxFitScale:.4,top:"80%",animationType:"hideBottom",startHidden:!0}),this.updateSpectateText(),this.lobbyPlayerCountMessage=new pt("",{color:0,multiLine:!1,maxWidthPercent:.7,maxFitScale:.4,top:"80%",animationType:"hideBottom",startHidden:!0}),document.addEventListener("visibilitychange",t=>{for(const e of this.getMyPlayers())e.forceNextPositionFromServer()})}init(){for(const e of this.balancingObjects)e&&e.init();this.lights.init(),this.stageManager.init(),this.scene.add(this.lights.lightsObject),this.loadEnvMap(),this.setupEnvironment(),p.assets.onBeforePlayProgress(t=>{for(const e of this.environmentLoadProgressCbs)e(t)}),this.loadSounds(),this.gameStateManager.onStateChange(t=>{this.onGameStateChange(t)});let t=new THREE.Object3D;t.name="grinder rollers",this.scene.add(t);for(let e=0;e<5;e++){let i=new THREE.Object3D;i.position.x=57.319-27.389*e,i.position.y=-26.754,i.position.z=-3.644,e%2==1&&(i.rotation.y=Math.PI),t.add(i),this.grinderRollers.push(i)}this.loadConfigValues()}async loadConfigValues(){this.midJoinMinPlayers=await p.staticConfig.getKey("midJoinMinPlayers"),this.midJoinMinScore=await p.staticConfig.getKey("midJoinMinScore"),this.midJoinMinPlayersForScore=await p.staticConfig.getKey("midJoinMinPlayersForScore"),this.configValuesLoaded=!0}async loadSounds(){this.grinderSound=await p.sfx.getSound("grinderAmbient")}async setupEnvironment(){this.menuObject=new THREE.Object3D,this.menuObject.name="menu wall",this.menuObject.position.set(-110,130,160),this.menuObject.rotation.y=Math.PI,this.scene.add(this.menuObject),this.menuParticlesObj=new THREE.Object3D,this.menuParticlesObj.name="menu particles",this.scene.add(this.menuParticlesObj);let t=p.particles.createSystem({particleAssetPath:"particles/dust.json",particleCount:100,gravity:0,spawnerShape:{type:"box",sizeX:9,sizeY:5,sizeZ:3},particleSize:{min:.1,max:.3},particleOpacity:.6,pickRandomChild:!0,startVelocity:.002,angularVelocity:1,billboardParticles:!0,loop:!0,particleLifetime:3e4},0);t.obj.position.set(-107,132,165),t.obj.name="menuParticles",this.menuParticlesObj.add(t.obj),this.createdMenuParticles.push(t);let e={particleAssetPath:"particles/smoke.json",particleCount:10,gravity:0,particleSize:{min:3,max:7},particleOpacity:{start:.1,end:0},startVelocity:{minX:0,maxX:0,minY:.02,maxY:.05,minZ:0,maxZ:0},angularVelocity:1,billboardParticles:!0,loop:!0,particleLifetime:5e3},i=p.particles.createSystem(e,0);i.obj.position.set(-107,115,145),i.obj.name="menuSmokeParticles1",this.menuParticlesObj.add(i.obj),this.createdMenuParticles.push(i);let n=p.particles.createSystem(e,0);n.obj.position.set(-115,121,165),n.obj.name="menuSmokeParticles1",this.menuParticlesObj.add(n.obj),this.createdMenuParticles.push(n),this.arenaObject=new THREE.Object3D,this.arenaObject.name="arena",this.arenaObject.position.y=-30,this.scene.add(this.arenaObject),this.beltObject=new THREE.Object3D,this.beltObject.name="belt",this.beltObject.position.y=70,this.beltObject.position.z=40,this.beltObject.rotation.x=.2,this.scene.add(this.beltObject),this.lobbyBalancingObject&&(this.chickenboxObj=new THREE.Object3D,this.chickenboxObj.position.y=-.3,this.lobbyBalancingObject.obj.add(this.chickenboxObj)),await p.assets.waitForAccurateQuality();let s=p.assets.bestMainIsHQ;await this.loadEnvironmentAssets(),this.didLoadEnvironment=!0,this.environmentLoadProgressCbs=[];for(const r of this.onEnvironmentLoadCbs)r();this.onEnvironmentLoadCbs=[],s||(await p.assets.waitForHQLoad(),this.loadEnvironmentAssets())}async loadEnvironmentAssets(){let t=await p.assets.bestMain.getGltfObject("arena.glb");this.addArenaAssets(t);let e=await p.assets.bestMain.getGltfObject("conveyorBelt.glb");this.addConveyorbeltAssets(e);let i=await p.assets.bestMain.getGltfObject("chickenbox/chickenboxCardBoard.glb"),n=await p.assets.bestMain.getGltfObject("chickenbox/chickenbox.glb");this.addChickenBoxAssets(i,n)}setQuality(t){this.lights.setQuality(t),this.setEnvironmentQuality();for(const e of p.game.players)e.loadPlayerModel(!0)}setEnvironmentQuality(){let t=p.cornerSettings.quality;this.arenaMaterialSwitcher&&this.arenaMaterialSwitcher.setMaterials(t>.5),this.conveyorBeltSwitcher&&this.conveyorBeltSwitcher.setMaterials(t>.3),this.chickenboxSwitcher&&this.chickenboxSwitcher.setMaterials(t>.3)}addArenaAssets(t){Zt.removeAndDisposeChildren(this.arenaObject),this.arenaMaterialSwitcher&&this.arenaMaterialSwitcher.destructor();let e=t.scene;e.traverse(t=>{t instanceof THREE.Mesh&&(t.castShadow=!0,t.receiveShadow=!0,t.material.envMap=this.envMap,t.material.needsUpdate=!0)}),e.scale.x=e.scale.y=e.scale.z=8;let i=e.getObjectByName("GrinderBox");i.position.x=-.335,i.position.z=.071;let n=e.getObjectByName("Canvas"),s=n.material;n.material=new THREE.MeshBasicMaterial({color:this.bgColor}),Zt.disposeMaterialWithTextures(s),this.arenaMaterialSwitcher=new Wt(e),this.arenaObject.add(e),this.grinderDoorL=e.getObjectByName("GrinderDoor1"),this.grinderDoorR=e.getObjectByName("GrinderDoor2"),this.setEnvironmentQuality(),this.arenaObject.traverse(t=>{t.matrixAutoUpdate=!1,t.updateMatrix()})}addConveyorbeltAssets(t){Zt.removeAndDisposeChildren(this.beltObject),this.conveyorBeltSwitcher&&this.conveyorBeltSwitcher.destructor();let e=t.scene;e.traverse(t=>{t instanceof THREE.Mesh&&(t.castShadow=!0,t.receiveShadow=!0)});let i=e.children[0].material;i.envMap=this.envMap,i.needsUpdate=!0;for(let n=0;n<5;n++){let t=e.clone();this.beltObject.add(t),t.position.z=231*(n+.5)}this.conveyorBeltSwitcher=new Wt(this.beltObject),this.setEnvironmentQuality(),this.beltObject.traverse(t=>{t.matrixAutoUpdate=!1,t.updateMatrix()})}addChickenBoxAssets(t,e){if(!this.chickenboxObj)return;Zt.removeAndDisposeChildren(this.chickenboxObj),this.chickenboxSwitcher&&this.chickenboxSwitcher.destructor(),this.chickenboxObj.add(t.scene);let i=e.scene;for(const n of[[1,1,0],[-1,1,.05],[-1,-1,.05],[1,-1,0]]){let t=i.clone();t.scale.set(n[0],1,n[1]),t.position.x=n[2],this.chickenboxObj.add(t)}this.chickenboxObj.traverse(t=>{t instanceof THREE.Mesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0,t.castShadow=!0,t.receiveShadow=!0)}),this.chickenboxSwitcher=new Wt(this.chickenboxObj),this.setEnvironmentQuality(),this.chickenboxObj.traverse(t=>{t.matrixAutoUpdate=!1,t.updateMatrix()})}async setGrinderAsset(t,e){if(t!=this.currentGrinderAssetPath){this.currentGrinderAssetPath=t;let i=await p.assetCache.getItem(t,e);if(t!=this.currentGrinderAssetPath)return;let n=t.endsWith(".json")?i:i.scene;for(const t of this.grinderRollers){let e=n.clone();for(let i=t.children.length-1;i>=0;i--)t.remove(t.children[i]);t.add(e)}}}getEnvironmentLoadProgress(){return p.assets.lastBeforePlayProgress}onEnvironmentLoadProgress(t){this.didLoadEnvironment?t(1):this.environmentLoadProgressCbs.push(t)}async waitForEnvironmentLoad(){return await new Promise(t=>{this.onEnvironmentLoadCbs.push(t)})}async loadMaterialsAndTextures(t){await p.playerAssetsCache.waitForCacheLoad(),t&&t(.2);for(const e of p.playerAssetsCache.playerAssets)this.scene.add(e.obj);this.scene.traverse(t=>t.frustumCulled=!1),await p.renderer.waitForFrameRender(),t&&t(1),this.scene.traverse(t=>t.frustumCulled=!0);for(const e of p.playerAssetsCache.playerAssets)this.scene.remove(e.obj);await p.renderer.waitForFrameRender(2)}async addMainMenuBackground(t){let e;e=t.text?await t.text():await new Promise(e=>{let i=new FileReader;i.addEventListener("loadend",t=>{e(i.result)}),i.readAsText(t)});let i=Nt.getJsonObject(JSON.parse(e));Zt.removeAndDisposeChildren(this.menuObject),this.menuObject.add(i),this.menuOrangeFlickerMaterial=i.getObjectByName("orange light").material,this.menuObject.traverse(t=>{t.matrixAutoUpdate=!1,t.updateMatrix()})}async loadEnvMap(){this.envMap=await p.assets.mainHQ.getCubeTexture(["env/px.png","env/nx.png","env/py.png","env/ny.png","env/pz.png","env/nz.png"]);for(const t of this.onEnvMapLoadCbs)t(this.envMap);this.onEnvMapLoadCbs=[]}async getEnvMap(){return this.envMap?this.envMap:await new Promise((t,e)=>{this.onEnvMapLoadCbs.push(t)})}updateStageSettings(t){t={...{disks:[],stageObjects:[]},...t};for(let e=0;e<t.disks.length;e++){let i=t.disks[e],n=i.diskId=i.diskId||e+1,s=this.balancingObjects[n],r=!0;s&&(r=s.setDiskSettings(i)),r&&(s&&s.destructor(),s=new b({...i,...{id:n}}),this.balancingObjects[n]=s,this.gameStateManager.isWatchingGame&&p.sfx.playSound("diskSplit",Zt.randRange(.7,1.1)),this.balancingObjects[n]=s,this.mainBalancingObjects.push(s),this.scene.add(s.obj),s.init(),s.setDiskSettings(i))}for(let e=1;e<this.balancingObjects.length;e++){let i=this.balancingObjects[e];if(i&&!t.disks.find(t=>t.diskId==e)){let t=this.mainBalancingObjects.indexOf(i);t>=0&&this.mainBalancingObjects.splice(t,1),i.destructor(),delete this.balancingObjects[e]}}for(let e=0;e<t.stageObjects.length;e++){let i=t.stageObjects[e],n=i.id=i.id||e,s=this.stageObjects[n],r=!0;if(s&&(r=s.setSettingsStageObject(i)),r){s&&s.destructor(),s=new(0,this.stageObjectTypes[i.type])({id:n,type:i.type}),this.stageObjects[n]=s,this.scene.add(s.obj),s.setSettingsStageObject(i)&&console.warn("A stageobject just got constructed and its settings were incorrect from the beginning."),s.init()}}for(let e=0;e<this.stageObjects.length;e++){let i=this.stageObjects[e];i&&(t.stageObjects.find(t=>t.id==e)||(i.destructor(),delete this.stageObjects[e]))}}setTimeScale(t){this.timeScale=t,this.timeScaleChanges.push({serverTime:this.realServerTime,scale:t})}resetTimeScaleChanges(){this.timeScaleChanges=[]}getPlayerById(t,e=!1){let i=this.players.find(e=>e.playerId==t);return!i&&e&&(i=this.newPlayer(!1,t)),i}*getMyPlayers(){for(const t of this.players)t.isMyPlayer&&(yield t)}*getMyControllablePlayers(){for(const t of this.players)t.controllableByMe&&!t.died&&(yield t)}hasControllablePlayer(){for(const t of this.getMyControllablePlayers())return!0;return!1}onGameStateChange(t){t==ft.GameState.STARTED&&(this.didHaveControllablePlayerThisGame=this.hasControllablePlayer()),this.doGameStartThings(),t==ft.GameState.WAITING_FOR_PLAYERS&&p.poki.gameplayStop()}doGameStartThings(){this.gameStateManager.currentState==ft.GameState.STARTED&&(this.didHaveControllablePlayerThisGame||(this.didHaveControllablePlayerThisGame=this.hasControllablePlayer()),this.didHaveControllablePlayerThisGame&&p.poki.gameplayStart(),p.mainMenu.updateUIVisibilities())}getBalancingObjectById(t){return this.balancingObjects[t]}loop(t,e){e*=this.timeScale;for(let s of this.players)s.loop(t,e);let i=this.players.length;if(!p.mainMenu.visible&&p.network.documentVisible){let e=i*.05,n=Math.floor(e),s=e-n,r=n+(Math.random()<s?1:0),a=Zt.randInt(0,i);for(let i=0;i<r;i++){let e=a+i;e=Zt.mod(e,this.players.length),this.players[e].verifyCheater(t)}}this.stageManager.loop(t,e);for(const s of this.balancingObjects)s&&s.loop(t,e);for(let s=this.potions.length-1;s>=0;s--){let i=this.potions[s];i.loop(t,e),i.testBalancingObjectsCollision(this.balancingObjects),i.destroyNextFrame&&(i.destructor(),this.potions.splice(s,1))}for(let s=this.cornSeeds.length-1;s>=0;s--){let i=this.cornSeeds[s];i.loop(t,e),i.destroyNextFrame&&(i.destructor(),this.cornSeeds.splice(s,1))}for(const s of this.stageObjects)s&&s.loop(t,e);for(let s=this.slicedPlayerTopHalfs.length-1;s>=0;s--){let i=this.slicedPlayerTopHalfs[s];i.loop(t,e),i.destroyNextFrame&&(i.destructor(),this.slicedPlayerTopHalfs.splice(s,1))}let n=Zt.mapValue(80,1,.001,.0035,this.players.length,!0);this.grinderRollerRotation+=e*n;for(const s of this.grinderRollers)s.rotation.z=this.grinderRollerRotation;if(!this.doorsOpen&&this.serverTime>2e3&&this.gameStateManager.currentState==ft.GameState.STARTED&&this.setDoorsOpen(!0),this.doorsAnimating){let t=4e-4*e;this.doorsOpen||(t*=-1),this.doorsOpenAmount+=t,this.doorsOpenAmount=Zt.clamp01(this.doorsOpenAmount);let i=9.443*Gt.in(this.doorsOpenAmount);this.grinderDoorL&&(this.grinderDoorL.position.x=-i),this.grinderDoorR&&(this.grinderDoorR.position.x=i)}if(p.game.menuOrangeFlickerMaterial){let e=Math.cos(.04*t)+Math.cos(.03*t)+Math.cos(.007*t);p.game.menuOrangeFlickerMaterial.opacity=Zt.clamp01(.06*e+.3)}}loopPhysics(t){t*=this.timeScale;for(const n of this.balancingObjects)n&&n.loopPhysics(t);let e=1/0,i=!1;for(const n of this.players){n.testCollisions(this.players),n.loopPhysics(t),n.testTouchPotion(this.potions),n.testTouchCornSeed(this.cornSeeds);let s=n.testHitStageObject(this.stageObjects);if(s){let{closestSawDist:t,didFindSawDist:r}=s;r&&n.controllableByMe&&(i=!0,e=Math.min(t,e))}}if(i){let t=.4*Zt.clamp01(1/Math.pow(.4*e,2));this.stageManager.themeManager.getThemeByName("saws").setSawsVolume(t)}}get realServerTime(){let t=Date.now()-this.gameStateManager.gameStartTime;return p.network.isOfflineGame||(t+=p.network.pingManager.smoothAvgPing/2),t}get serverTime(){let t=this.realServerTime,e=this.timeScaleChanges;e.length<=0&&(e=[{serverTime:0,scale:1}]);let i=1,n=0,s=0,r=t=>(t-n)*i+s;for(const a of e){let t=a.scale,e=a.serverTime,o=r(a.serverTime);i=t,n=e,s=o}return r(t)}setPlayerPosition(t,e,i,n,s,r,a,o,l,h,c,u){this.getPlayerById(t,!0).setNetworkPosition(e,i,n,s,r,a,o,l,h,c,u)}handlePlayerControlsData(t,e,i){let n=this.getPlayerById(t);n&&n.handleControlsData(e,i)}playerHitOtherPlayerFromServer(t,e,i,n){this.getPlayerById(t).setNetworkPositionFromPlayerHit(i);let s=this.getPlayerById(e);s&&s.doHitByPlayerImpulse(e,n,!0)}setPlayerHatFromServer(t,e){this.getPlayerById(t,!0).setHatFromServer(e)}setPlayerHasCrownFromServer(t,e){this.getPlayerById(t,!0).setHasCrownFromServer(e)}setPlayerServerMass(t,e){this.getPlayerById(t,!0).setServerMass(e)}setIsMyPlayer(t){let e=null;for(const i of this.players)if(i.playerId==t){i.isMyPlayer=!0,e=i;break}return e||(e=this.newPlayer(!0,t)),e}allowTemporaryPlayerInput(t,e){let i=this.getPlayerById(t);i&&i.allowTemporaryPlayerInput(e)}playerLeft(t,e=!1){let i=this.players.find(e=>e.playerId==t);if(i){i.onDisconnect(e);let t=this.players.indexOf(i);this.players.splice(t,1),this.updateUIVisibilities(),Array.from(this.getMyControllablePlayers()).length<=0&&this.despawnAllCornSeeds()}}newPlayer(t,e){let i=new O(t,e);return this.players.push(i),this.updateLobbyPlayerCountMessage(),this.scene.add(i.playerObj),this.gameStateManager.currentState==ft.GameState.STARTED&&i.spawnStartGame(),i}onBecomesOfflineGame(){for(let t=this.players.length-1;t>=0;t--){let e=this.players[t];e.died&&e.sendPlayerDied()}p.leaderboard.updateOfflineLeaderboardAfterBotsLoad()}setPlayerLaunchStartPos(t,e,i){let n=this.getPlayerById(t);n&&!n.isMyPlayer&&n.setLauchStartPos(e,i)}setDoorsOpen(t){t&&p.sfx.playSound("doorOpenGrinder"),this.doorsAnimating=!0,this.doorsOpen=t,this.grinderSound&&(t?this.grinderSound.play():this.grinderSound.stop())}setLobbyCollisions(t){this.lobbyBalancingObject&&(this.lobbyBalancingObject.hasCollisions=t)}spawnPotion(t,e,i,n,s,r,a=this.serverTime){let o=new $t(t,e,i,n,s,r,a);this.potions.push(o),this.scene.add(o.obj)}removePotion(t,e){let i=this.potions.find(e=>e.id==t);if(i){let t=this.getPlayerById(e);i.removeAnimated(t)}}removeAllPotions(){for(const t of this.potions)t.destructor();this.potions=[]}playerApplyPotion(t,e,i){let n=this.getPlayerById(t);n&&n.applyPotion(e,i)}spawnCornSeed(t){if(Array.from(this.getMyControllablePlayers()).length<=0)return;let e=Zt.randFromArray(this.mainBalancingObjects.filter(t=>!!t)),i=new M(e,t);this.cornSeeds.push(i),this.scene.add(i.obj)}despawnAllCornSeeds(){for(const t of this.cornSeeds)t.despawnWithDelay()}removeAllCornSeeds(){for(const t of this.cornSeeds)t.destructor();this.cornSeeds=[]}updateUIVisibilities(){this.updateAllowControllingCamera(),this.updateLobbyPlayerCountMessage()}getCanControlCamera(){if(this.debugMainGame)return!0;if(this.hasControllablePlayer())return!1;if(this.gameStateManager.currentState!=ft.GameState.STARTED)return!1;if(p.mainMenu.visible)return!1;if(!this.configValuesLoaded)return!1;let t=!1,e=this.players.length;for(const i of p.localPlayerManager.localPlayers)if(!i.playerDiedThisRound&&!(e<this.midJoinMinPlayers||i.stats.score>this.midJoinMinScore&&e<this.midJoinMinPlayersForScore)){t=!0;break}return!t}updateAllowControllingCamera(){let t=this.getCanControlCamera();p.cam.controller.setAllowControlling(t),this.updateSpectateTextVisibility(t)}updateSpectateTextVisibility(t){void 0===t&&(t=this.getCanControlCamera()),t&&!p.cam.controller.isControlling?(this.updateSpectateText(),this.spectatingMessage.show()):this.spectatingMessage.hide(!1)}updateSpectateText(){let t="You are spectating, the next game begins soon...";this.didHaveControllablePlayerThisGame&&(t=p.input.touch.touchSupported||p.input.hasGamepad?"Look around to enter spectate mode":"Click to enter spectate mode"),this.spectatingMessage.setText(t)}updateLobbyPlayerCountMessage(){if([ft.GameState.INVALID,ft.GameState.WAITING_FOR_PLAYERS].includes(this.gameStateManager.currentState)&&!p.mainMenu.visible&&!p.levelUI.isShowingNewHatUI){this.lobbyPlayerCountMessage.show();let t=`Waiting for players (${p.game.players.length}/80)`;this.lobbyPlayerCountMessage.setText(t)}else this.lobbyPlayerCountMessage.hide(!1)}setMenuVisibility(t){t==!this.menuObject.parent&&(t?this.scene.add(this.menuObject):this.scene.remove(this.menuObject)),t==!this.menuParticlesObj.parent&&(t?this.scene.add(this.menuParticlesObj):this.scene.remove(this.menuParticlesObj));for(const e of this.createdMenuParticles)e.setActive(t)}}class _{constructor(){this.currentStage=0,this.themeManager=new re;let t={playerWeightMultiplier:.1,isSquareShape:!0,customGeoAsset:"cuttingBoard.json",customGeoAssetPackage:"themeKnives",customGeoAssetSize:3,scaleX:2.9,scaleZ:5.1},e={positionsSeed:0,getDiskSettings:e=>[t],getStageObjectSettings:t=>(t=>{let e={type:"knife",linkedDiskId:1,knifeType:"knife",animationType:"falling"},i=t,n=[];for(let s=0;s<50;s++){let t=Zt.randRange(-.9,.9,i++),r=Zt.randRange(-.9,.9,i++);n.push({...e,...{pos:new THREE.Vector3(t,0,r),rotation:Zt.randRange(-Math.PI,Math.PI,i++),animationTimeOffset:s+10}})}return n})(this.currentStageSettings.positionsSeed),theme:"knives"},i={type:"knife",linkedDiskId:1,knifeType:"cleaver",animationType:"chopping",size:2,posPath:t=>{let e=.9*Math.cos(t);return new THREE.Vector3(0,0,e)}},n=[{stageId:0,getDiskSettings:t=>{let e=1e3/(t+20)-13,i=.1*t+2,n=e*(.2*Zt.longCos(i,3)+.2);return[{radius:e,holeRadius:n=Zt.clamp(n,0,e-6),shouldDoHoleWarning:i>3.2}]}},{stageId:1,getDiskSettings:t=>{let e=1e3/(t+20)-9,i=e-4,n=e=>.5-.5*Math.cos((t-20)*e*Math.PI);if(t<20)return[{radius:e,maxSlopeMultiplier:t<15?1:n(.2)}];{let s=t>22?1:n(.5);return[{radius:e,holeRadius:i,maxSlopeMultiplier:s},{radius:i,maxSlopeMultiplier:s}]}}},{stageId:2,getDiskSettings:t=>{let e=30-.5*t,i=.5*(t-7);return[{radius:e,holeRadius:i=Math.min(i,e-6),shouldDoHoleWarning:t>6}]}},{stageId:3,getDiskSettings:t=>{let e,i;if(t<20)e=30-.7*t,i=0;else{let n=t-20;e=16-.4*n,i=.5*n,i=Math.min(i,e-2)}return[{radius:e,holeRadius:i,shouldDoHoleWarning:t>19}]}},{stageId:4,getDiskSettings:t=>{let e=30-.5*t,i=Math.cos(.3*t);t<10&&(i=-1);let n=i*e*.75;return[{radius:e,holeRadius:n=Math.min(n,e-2),shouldDoHoleWarning:i>-.5&&e>5}]}},{stageId:5,getDiskSettings:t=>{let e=1e3/(t+20)-9;return[{radius:e+=e*Math.cos(.3*t)*.2,maxSlope:5*Math.cos(.3*t+1)+5}]}},{stageId:6,getDiskSettings:t=>{let e=t=>35/Math.pow(1.03,7*Math.floor(t/7))-.8,i=e(t),n=e(t-7),s=0;s=Math.floor(t/7),s=Math.max(0,s);let r=3*-Zt.mod(t,7);return[{radius:i,diskId:1},{holeRadius:i,radius:n,pos:new THREE.Vector3(0,r,0),diskId:s+2,startSlopeDiskId:1,maxSlopeMultiplier:.4}]}},{stageId:7,getDiskSettings:t=>{let e=35/Math.pow(1.03,t)-.8,i=.002*Math.pow(t,2),n=.1*t+2,s=.5*Math.cos(.005*Math.pow(t,2))+.5,r=e*s,a=e*(1-s),o=a+i/2,l=r+i/2;return[{pos:new THREE.Vector3(Math.cos(n)*o,0,Math.sin(n)*o),radius:r,shouldDoHoleWarning:r>.1&&t<30},{pos:new THREE.Vector3(-Math.cos(n)*l,0,-Math.sin(n)*l),radius:a,shouldDoHoleWarning:a>.1&&t<30}]}},{stageId:8,getDiskSettings:t=>{let e=t=>25-.5*t,i=t=>t<5?0:.7*e(t)-10*Math.pow(Zt.mod(t,5)/5,5),n=(e(t),[{radius:e(t),holeRadius:i(t),diskId:1}]);for(let s=0;s<10;s++){let r=5*s+5;if(r>t)break;let a=t-r,o=3*a,l=.7*e(r)-a,h=i(r-.01)-a;n.push({radius:l,holeRadius:h,diskId:s+2,startSlopeDiskId:1,pos:new THREE.Vector3(0,o,0)})}return n}},{stageId:9,getDiskSettings:t=>{return[{radius:35*(1-1/(1+Math.pow(Math.E,6-.1*t)))-1,playerPhysicsSettings:{frictionMultiplier:0,dragTargetHorizontal:.99,dragTargetHorizontalWhenFalling:.99,dragTargetHorizontalWhenFlying:.99,movementSpeedMultiplier:.2,sprintSpeedMultiplier:1,dashMultiplier:.5},maxSlopeMultiplier:0,meshType:"ice"}]},theme:"ice"},{stageId:10,getDiskSettings:t=>{let e=[];for(let i=0;i<3;i++){let n=2*Math.PI/3*i+.1*t,s=20,r=5*i;e.push({radius:this.simpleDiskSize(t,18+r,.07,r+1),pos:new THREE.Vector3(Math.cos(n)*s,0,Math.sin(n)*s),playerPhysicsSettings:{frictionMultiplier:0,dragTargetHorizontal:.99,dragTargetHorizontalWhenFalling:.99,dragTargetHorizontalWhenFlying:.99,movementSpeedMultiplier:.2,sprintSpeedMultiplier:1,dashMultiplier:.5},maxSlopeMultiplier:0,meshType:"ice"})}return e},theme:"ice"},{stageId:11,getDiskSettings:t=>{let e=[],i=this.simpleDiskSize(t,20);for(let n=0;n<3;n++){let s=2*Math.PI/3*n+.1*t,r=16;e.push({radius:i*(.5*Math.cos(.3*t+2*n/3*Math.PI)+.5),pos:new THREE.Vector3(Math.cos(s)*r,0,Math.sin(s)*r),playerPhysicsSettings:{frictionMultiplier:0,dragTargetHorizontal:.99,dragTargetHorizontalWhenFalling:.99,dragTargetHorizontalWhenFlying:.99,movementSpeedMultiplier:.2,sprintSpeedMultiplier:1,dashMultiplier:.5},maxSlopeMultiplier:0,meshType:"ice"})}return e},theme:"ice"},{stageId:12,getDiskSettings:t=>[{radius:20*(1-1/(1+Math.pow(Math.E,3-.1*t)))-1,maxSlopeMultiplier:.2,meshType:"sumo"}],theme:"sumo"},{stageId:13,getDiskSettings:t=>[{radius:30*(1-1/(1+Math.pow(Math.E,4-.05*t))),maxSlopeMultiplier:.3,meshType:"saws"}],getStageObjectSettings:t=>[{type:"saw",linkedDiskId:1,rotation:Zt.mod(.04*Math.pow(t,2),2*Math.PI)}],theme:"saws"},{stageId:14,getDiskSettings:t=>[{radius:25*(1-1/(1+Math.pow(Math.E,4-.05*t))),maxSlopeMultiplier:.3,meshType:"saws"}],getStageObjectSettings:t=>[{type:"saw",linkedDiskId:1,pos:new THREE.Vector3(0,4,1),rotation:Math.cos(.02*Math.pow(t,2))},{type:"saw",linkedDiskId:1,pos:new THREE.Vector3(0,4,-1),rotation:Math.cos(.02*Math.pow(t,2))+Math.PI},{type:"saw",linkedDiskId:1,rotation:Zt.mod(.04*Math.pow(t,2),2*Math.PI)},{type:"saw",linkedDiskId:1,rotation:Zt.mod(.04*Math.pow(t,2),2*Math.PI)+Math.PI,middlePieceVisible:!1}],theme:"saws"},{stageId:15,getDiskSettings:t=>[{radius:25*(1-1/(1+Math.pow(Math.E,4-.05*t))),maxSlopeMultiplier:.3,meshType:"saws"}],getStageObjectSettings:t=>{let e=0;return t>20?e=10*(t-20)+50:t>10&&(e=.5*Math.pow(t-10,2)),e=Zt.mod(e,2*Math.PI),[{type:"saw",linkedDiskId:1,pos:new THREE.Vector3(0,8,0),rotation:e,height:1.55},{type:"saw",linkedDiskId:1,pos:new THREE.Vector3(0,8,0),rotation:e+Math.PI,middlePieceVisible:!1,height:1.55}]},theme:"saws"},{stageId:16,getDiskSettings:t=>[{radius:25-.2*t+2*Math.cos(.1*t-1),maxSlopeMultiplier:.3,meshType:"saws"}],getStageObjectSettings:t=>{let e=[],i=Zt.mod(.02*Math.pow(t,2),2*Math.PI);for(let n=0;n<3;n++){let t=n/3*Math.PI*2;e.push({type:"saw",linkedDiskId:1,pos:new THREE.Vector3(Math.cos(t),0,Math.sin(t)),rotation:i})}return e},theme:"saws"},{stageId:17,getDiskSettings:t=>{let e=.002*Math.pow(t,2),i=.1*t+2,n=.5*Math.cos(.005*Math.pow(t,2))+.5,s=23*n,r=23*(1-n),a=r+e/2,o=s+e/2;return[{pos:new THREE.Vector3(Math.cos(i)*a,0,Math.sin(i)*a),radius:s,shouldDoHoleWarning:s>.1&&t<30,maxSlopeMultiplier:0,meshType:"saws"},{pos:new THREE.Vector3(-Math.cos(i)*o,0,-Math.sin(i)*o),radius:r,shouldDoHoleWarning:r>.1&&t<30,maxSlopeMultiplier:0,meshType:"saws"}]},getStageObjectSettings:t=>{let e=Zt.mod(.04*Math.pow(t,2),2*Math.PI);return[{type:"saw",linkedDiskId:1,rotation:e},{type:"saw",linkedDiskId:2,rotation:e}]},theme:"saws"},{stageId:18,getDiskSettings:t=>[{radius:25-.2*t+2*Math.cos(.1*t-1),maxSlopeMultiplier:.3,meshType:"saws"}],getStageObjectSettings:t=>{let e=[],i=Zt.mod(.02*Math.pow(t,2),2*Math.PI);for(let n=0;n<2;n++){let t=n/2*Math.PI*2,s=i;n%2==0&&(s*=-1,s+=Math.PI),e.push({type:"saw",linkedDiskId:1,pos:new THREE.Vector3(Math.cos(t),0,Math.sin(t)),rotation:s})}return e},theme:"saws"},{stageId:19,rotateCam:!1,getDiskSettings:e=>[t],getStageObjectSettings:t=>{let e={type:"knife",linkedDiskId:1,knifeType:"knife",animationType:"falling"},i=0,n=t=>Zt.randRange(-.35,.35,i++),s=[];for(let r=0;r<4;r++){let t=r%2==0,i=t?9:5;for(let a=0;a<2;a++){let o=.9-r/4,l=0;a&&(o*=-1,l=Math.PI);for(let h=0;h<i;h++){if(t&&h%2==0)continue;let c=Zt.lerp(-.9,.9,h/(i-1));s.push({...e,...{pos:new THREE.Vector3(c,0,o),rotation:n()+l,animationTimeOffset:10*r+5*a-.1*h+15}})}}}return s},theme:"knives"},{...{positionsSeed:1,stageId:20},...e},{...{positionsSeed:2,stageId:21},...e},{...{positionsSeed:3,stageId:22},...e},{...{positionsSeed:4,stageId:23},...e},{...{positionsSeed:5,stageId:24},...e},{...{positionsSeed:6,stageId:25},...e},{...{positionsSeed:7,stageId:26},...e},{stageId:27,rotateCam:!1,getDiskSettings:e=>[t],getStageObjectSettings:t=>[{...i,...{posPath:t=>{let e=.9*Math.cos(t);return new THREE.Vector3(0,0,e)},forcedAnimationTimeCurve:t=>.01*Math.pow(t,2)}}],theme:"knives"},{stageId:28,rotateCam:!1,getDiskSettings:e=>[t],getStageObjectSettings:t=>[{...i,...{posPath:t=>{let e=Zt.mapValue(-1,1,0,.9,Math.cos(.7*t));return new THREE.Vector3(0,0,e)},forcedAnimationTimeCurve:t=>.01*Math.pow(t,2)}},{...i,...{posPath:t=>{let e=Zt.mapValue(-1,1,-.9,0,Math.cos(.6*t));return new THREE.Vector3(0,0,e)},forcedAnimationTimeCurve:t=>.01*Math.pow(t,2)+1}}],theme:"knives"},{stageId:29,rotateCam:!1,getDiskSettings:e=>[t],getStageObjectSettings:t=>{let e=t=>(t=.01*Math.pow(t,2),t=Zt.mod(t,10));const n=(t=e(t))<6;let s=t>.5?.001:0;return[{...i,...{posPath:t=>{let e=Zt.lerp(-.9,.9,Zt.mod(.2*t-s,1));return new THREE.Vector3(0,0,e)},forcedAnimationTimeCurve:t=>{return(t=e(t))<6?t:t-6},animationType:n?"chopping":"horizontalSlice",dieTypeIsVertical:n,overrideIntervalClosestDist:!0}}]},theme:"knives"}];this.stageSettings=[];for(const s of n)this.stageSettings[s.stageId]=s;this.debugStage={rotateCam:!1,getDiskSettings:t=>[{playerWeightMultiplier:0,maxSlopeMultiplier:0,isSquareShape:!0,customGeoAsset:"cuttingBoard.json",customGeoAssetPackage:"themeKnives",customGeoAssetSize:3,scaleX:2.9,scaleZ:5.1}],getStageObjectSettings:t=>[{type:"knife",knifeType:"knife",animationType:"falling",linkedDiskId:1,pos:new THREE.Vector3(0,0,0),animationTimeOffset:3*Math.floor(t/3)+1}],theme:"knives"},this.debugStage=this.stageSettings[this.stageSettings.length-1]}init(){this.themeManager.init()}simpleDiskSize(t,e=25,i=.07,n=1){return(1-1/(1+Math.pow(Math.E,4-t*i)))*e-n}setCurrentStage(t){this.currentStage=t,p.game.updateStageSettings(),this.setDiskSizes();let e=this.currentStageSettings.theme||"default";this.themeManager.setTheme(e)}get currentStageSettings(){return p.game.debugMainGame?this.debugStage:this.stageSettings[this.currentStage]}loop(t,e){this.setDiskSizes(),this.themeManager.loop(t,e)}setDiskSizes(){let t=p.game.serverTime/1e3,e=[],i=[];e=this.currentStageSettings.getDiskSettings(t),this.currentStageSettings.getStageObjectSettings&&(i=this.currentStageSettings.getStageObjectSettings(t)),p.game.updateStageSettings({disks:e,stageObjects:i})}}class A{constructor(){this.hats=null,this.availableBotHatIds=[0],this.availableHatsAfterClear=[],this.availableHats=[0],this.crown=null,this.crownIsLoading=!1,this.onCrownLoadCbs=[],this.onHatsLoadCbs=[]}async init(){this.hats=await p.staticConfig.getDataSet("hats");for(const t of this.onHatsLoadCbs)t();this.onHatsLoadCbs=[];for(const t of this.hats)t.availableWithCode||this.availableBotHatIds.push(t.hatId);await this.makeLocalHatsAvailable()}async waitForHatsLoad(){this.hats||await new Promise(t=>{this.onHatsLoadCbs.push(t)})}async makeLocalHatsAvailable(){await this.makeNuggetHatsAvailable(),await this.makeLocalUnlockedHatsAvailable()}async makeNuggetHatsAvailable(){let t=await p.levelUI.getValidNuggetCount(),e=await this.getHatCountForNuggetCount(t);await this.waitForHatsLoad();let i=0;for(const n of this.hats)if(!n.availableWithCode){if(++i>e)break;await this.makeHatIdAvailable(n.hatId,!1)}}async makeLocalUnlockedHatsAvailable(){let t=await zt.get("localUnlockedHats");t=t||[];for(const e of t)await this.makeHatIdAvailable(e,!1)}async getHatCountForNuggetCount(t,e=!0,i=!0){await this.waitForHatsLoad();let n=.2*Math.sqrt(t);if(e&&(n=Math.floor(n)),i){let t=this.hats.length;n=Math.min(t,n)}return n}async getHatPercentageForNuggetCount(t){return Zt.mod(await this.getHatCountForNuggetCount(t,!1,!1),1)}async getHatIdForNuggetHatCount(t){await this.waitForHatsLoad();let e=0;for(const i of this.hats)if(!i.availableWithCode&&++e>=t)return i.hatId;return-1}getRandomBotHatId(){if(Math.random()>.4||!this.availableBotHatIds)return 0;let t=Math.floor(Math.pow(Math.random(),2)*this.availableBotHatIds.length);return t>=this.availableBotHatIds.length?0:this.availableBotHatIds[t]}async makeHatIdAvailable(t,e=!0,i=!1){if(i&&this.availableHatsAfterClear.push(t),!this.availableHats.includes(t)&&(this.availableHats.push(t),await this.waitForHatsLoad(),this.availableHats.sort((t,e)=>this.hats.findIndex(e=>e.hatId==t)-this.hats.findIndex(t=>t.hatId==e)),e)){let e=!1;await zt.getSet("autoEquippedHats",i=>(i||(i=[]),i.includes(t)?e=!0:i.push(t),i)),e||p.appearanceMenuManager.equipHatAllPlayers(t)}}makeAllHatsUnavailable(){this.availableHats=[0];for(const t of this.availableHatsAfterClear)this.availableHats.push(t)}async localUnlockHat(t,e=!0){await this.makeHatIdAvailable(t,e),await zt.getSet("localUnlockedHats",e=>(e||(e=[]),e.includes(t)||e.push(t),e))}async testHatUnlockName(t,e=-1){if(this.hats)for(const i of this.hats)i.unlockName&&t.toLowerCase()==i.unlockName.toLowerCase()&&(await this.localUnlockHat(i.hatId,!1),p.appearanceMenuManager.equipHatSpecificPlayer(i.hatId,e))}async getHatObject(t){await this.waitForHatsLoad();let e=this.hats.find(e=>e.hatId==t)||{},i="";(e={...{hideComb:!0,uiRenderHeightOffset:0,scaleWithPlayer:!1,customTexture:"",ignoreCrownYOffset:!1},...e}).fileName&&(i="lazyAssets/hats/"+e.fileName);let n=null;if(i)if(i.endsWith(".json")){let t=await p.assetCache.getItem(i,null);t&&(n=t.clone())}else{let t=await p.assetCache.getItem(i,null);t&&(n=t.scene.clone())}if(e.customTexture&&n){let t=await p.assetCache.getItem("lazyAssets/hatTextures/"+e.customTexture,null);n.traverse(e=>{e instanceof THREE.Mesh&&e.name.toLowerCase().endsWith("replacetexture")&&(e.material=e.material.clone(),e.material.map=t)})}return n||(e.hideComb=!1),e.main=n,e}async getCrown(){if(this.crown)return this.crown;if(this.crownIsLoading)return await new Promise((t,e)=>{this.onCrownLoadCbs.push(t)});this.crownIsLoading=!0;let t=await p.assets.mainHQ.getGltfObject("chicken/crown.glb");this.crown=t.scene;for(const e of this.onCrownLoadCbs)e(this.crown);return this.crownIsLoading=!1,this.onCrownLoadCbs=[],this.crown}}class L{constructor(){this.obj=new THREE.Object3D,this.obj.visible=!1,this.assetObject=null,this.bottomObj=null,this.topObj=null,this.smoothLookTarget=new THREE.Vector3,this.destructed=!1,this.animationStartTime=0}destructor(){this.obj.parent&&this.obj.parent.remove(this.obj),this.destructAsset(),this.obj=null,this.bottomObj=null,this.topObj=null,this.smoothLookTarget=null,this.destructed=!0}async loadAsset(){let t=await p.assets.main.getJsonObject("holeWarning.json");this.destructed?this.destructAsset():(this.obj.add(t),this.bottomObj=t.getObjectByName("arrow"),this.topObj=t.getObjectByName("exclamation mark"))}destructAsset(){this.assetObj&&(this.assetObj.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.assetObj=null)}loop(t,e){let i=p.cam.camera.position.clone();if(this.smoothLookTarget.lerp(i,Zt.lerpt01(.025)),this.obj.lookAt(this.smoothLookTarget),this.topObj&&this.bottomObj&&this.isAnimating){this.topObj.position.y=Zt.mapValue(-1,1,.07,.08,Math.cos(.01*t)),this.topObj.rotation.x=.1*Math.cos(.011*t),this.topObj.rotation.z=.1*Math.cos(.012*t);let e=t-this.animationStartTime,i=Gt.out(Zt.clamp(.001*e,1e-4,1)),n=Gt.out(Zt.clamp01(5e-4*e));if(this.topObj.scale.setScalar(i),this.topObj.position.y-=.07*(1-i),this.topObj.rotation.y=Math.cos(.025*t)*(1-n),this.topObj.rotation.z+=Math.cos(.025*t)*(1-n),this.bottomObj.scale.setScalar(i),e>5e3){let t=e-5e3,i=Gt.out(1-Zt.clamp(.002*t,1e-5,1));this.topObj.scale.setScalar(i),this.topObj.position.y-=.07*(1-i),this.bottomObj.scale.setScalar(i),i<=0&&(this.obj.visible=!1,this.isAnimating=!1)}}}startAnimation(){this.animationStartTime=p.now,this.obj.visible=!0,this.isAnimating=!0,p.sfx.playSound("warningHole")}}class R{constructor(){this.localPlayers=[],this.localBotPlayers=[],this.maxPlayerCount=4}init(){this.addLocalPlayer(),p.game.debugMainGame&&this.addLocalPlayer()}addLocalPlayer(){if(this.localPlayers.length>=this.maxPlayerCount)return;let t=new I({index:this.localPlayers.length});this.localPlayers.push(t),this.updateLocalPlayerCount()}removeLocalPlayer(){let t=this.localPlayers.length-1;t<0||(this.localPlayers[t].destructor(),this.localPlayers.splice(t,1),this.updateLocalPlayerCount())}updateLocalPlayerCount(){let t=this.localPlayers.length;p.mainMenu.updateLocalPlayerCount(t),p.appearanceMenuManager.updateLocalPlayerCount(t)}*getAllPlayers(){for(const t of this.localPlayers)yield t;for(const t of this.localBotPlayers)yield t}newUnassignedPlayer(t,e){let i=Array.from(this.getAllPlayers()).find(t=>t.isActivating&&t.statsId==e);if(i)return i.assignNetworkPlayer(t.playerId),void t.setLocalPlayer(i)}onPlayerCreationFailed(){for(const t of this.localPlayers)if(t.isActivating)return void t.onActivationFailed()}hasNonAfkPlayer(){if(!p.mainMenu.visible){for(const t of this.localPlayers)if(t.inputs.find(t=>!t.isAfk))return!0;return!1}}activateControllable(){if(!p.mainMenu.visible)for(const t of this.localPlayers)t.inputs.find(t=>!t.isAfk)&&t.activate()}createBot(t){let e=new I({isBot:!0,botDifficulty:t});this.localBotPlayers.push(e),e.activate()}removeBot(t){t.destructor();let e=this.localBotPlayers.indexOf(t);e>=0&&this.localBotPlayers.splice(e,1)}gamepadConnected(t){for(const e of this.localPlayers)if(!e.gamepadInput){e.setGamepadInput(t);break}}gamepadDisconnected(t){for(const e of this.localPlayers)e.gamepadInput==t&&e.setGamepadInput(null)}roundStarts(){for(const t of this.localPlayers)t.roundStarts()}}class I{constructor({isBot:t=!1,botDifficulty:e=.5,index:i=0}={}){if(this.inputs=[],this.isBot=t,this.gamepadInput=null,this.playerDiedThisRound=!1,t){let t=p.input.createBot(e);this.addInputPlayer(t),this.statsId=-1,this.stats=null}else{0!=i&&p.input.clearSideInputs();let t=p.input.requestInputPlayer();this.addInputPlayer(t);let e=p.input.requestAvailableGamepadInput();if(this.setGamepadInput(e),0==i){this.addInputPlayer(p.input.touch.inputPlayer);for(let t=0;t<3;t++){let t=p.input.requestSideInputPlayer();this.addInputPlayer(t)}}this.statsId=p.playerStats.getNewStatId(),this.stats=p.playerStats.getStatFromId(this.statsId)}this.linkedPlayerId=-1,this.isActivating=!1}addInputPlayer(t){t.linkedLocalPlayer=this,this.inputs.push(t)}removeInputPlayer(t){if(!t)return;t.linkedLocalPlayer=null;let e=this.inputs.indexOf(t);e>=0&&this.inputs.splice(e,1)}setGamepadInput(t){t?this.addInputPlayer(t):this.gamepadInput&&this.removeInputPlayer(this.gamepadInput),this.gamepadInput=t}destructor(){this.setGamepadInput(null);for(const t of this.inputs)p.input.removeInputPlayer(t);this.inputs=[],this.statsId>=0&&p.playerStats.removeStat(this.statsId),this.stats=null}get linkedPlayer(){return p.game.getPlayerById(this.linkedPlayerId)}activate(){if(this.isActivating||this.linkedPlayerId>-1)return;let t=!0;(p.game.gameStateManager.currentState==ft.GameState.STARTED&&this.playerDiedThisRound||p.gameOverScreen.visible||p.ads.prerollIsPlaying)&&(t=!1),t?(this.isActivating=!0,p.network.requestPlayerSpawn(this.statsId)):this.onActivationFailed()}onActivationFailed(){this.isActivating=!1;for(const t of this.inputs)t.onActivationFailed()}assignNetworkPlayer(t){this.isActivating&&(this.isActivating=!1,this.linkedPlayerId=t)}deactivate(){this.linkedPlayerId=-1;for(const t of this.inputs)t.deactivate()}playerDied(){this.playerDiedThisRound=!0}roundStarts(){this.playerDiedThisRound=!1}}class O{constructor(t,e){this._isMyPlayer=t,this.isTemporaryMyPlayer=!1,this.playerId=e||0,this.serverMass=1,this._jumpPressed=!1,this.prevJumpPressed=!1,this.allowInput=!0,this.jumpPressedAfterSpawn=!1,this.jumpReleaseTime=0,this.dashChargeAmount=0,this.lastDashTime=0,this.lastJumpAmount=0,this.jumpStamina=1,this.isSprinting=!1,this.sprintingSfx=null,this.sprintingStamina=1,this.isPlayingDashChargeSfx=!1,this.didPlayDashChargeDoneSfx=!1,this.dashChargeSfx=!1,this.cancelNextDashCharge=!1,this.isFlying=!1,this.flyingStamina=1,this.didAirJumpOnce=!1,this.prevTouchedDisk=null,this.lastTouchedDisk=null,this.lastTouchedDiskLandTime=0,this.lastTouchedDiskBeforeJump=null,this.lastTouchedDiskFallSpeed=0,this.lastSetNotOnDiskTime=0,this.isSliced=!1,this.didGetVerticalSliced=!1,this.slicedWalkDirection=new THREE.Vector3,this.died=!1,this.deathTime=0,this.lastPlayerDataSendTime=0,this.currentNetworkPosVersion=0,this.lastNetworkUpdateTime=0,this.lastNetworkPosWasCheatTeleport=!1,this.lastCheatTeleportTime=0,this.forceSetPosFromServer=!1,this.destructed=!1,this.playerAsset=null,this.chickenObj=null,this.chickenBody=null,this.chickenWingL=null,this.chickenWingR=null,this.chickenObjSliced=null,this.playerObj=new THREE.Object3D,this.playerObj.name="player",this.hatsContainerObj=null,this.hatObj=null,this.selectedHatObj=null,this.serverHatId=-1,this.serverHasCrown=!1,this.crownObj=null,this.didSelectBotHat=!1,this.selectedBotHatId=0,this.isLoadingPlayerModel=!1,this.onPlayerModelLoadCbs=[],this.hasReceivedFirstPosition=!1,t?(this.hasReceivedFirstPosition=!0,this.respawnToLobby()):this._pos=new THREE.Vector3,this.radius=1,this.velocity=new THREE.Vector3,this.currentInputDirection=new THREE.Vector3,this.networkPosTarget=new THREE.Vector3,this.networkVelocity=new THREE.Vector3,this.lastHitPlayerId=null,this.lastHitPlayerTime=0,this.smoothDragVertical=1,this.smoothDragHorizontal=1,this.targetRotationAngle=0,this.smoothRotationAngle=0,this.networkRotationAngle=0,this.forward=new THREE.Vector3,this.distanceWalked=0,this.lastChickenSfxDistanceWalked=0,this.isSpawnStartAnimating=!1,this.isSpawnStartAnimatingBelt=!1,this.spawnStartTime=0,this.spawnStartXOffset=0,this.spawnStartDragYPos=60,this.spawnStartTimeOffset=0,this.lastVerifyCheaterCheck=0,this.lastHitStageObjectClosestDist=0,this.lastHitStageObjectClosestIntervalDist=0,this.lastHitStageObjectTime=0,this.activePotion=null,this.canWalk=!0,this.canDashCharge=!0,this.canAirJump=!0,this.canFly=!0,this.canSprint=!0,this.applyDiskSlopeForce=!0,this.hasPlayerCollisions=!0,this.hasHeavyPotion=!1,this.heavyPotionAnimating=!1,this.heavyPotionAnimationStartTime=0,this.lastHeavyPotionHapticPulseTime=0,this.hasTornadoPotion=!1,this.tornadoFx=null,this.hasFeatherPotion=!1,this.gravityAmount=.04,this.hasSnowflakePotion=!1,this.iceCubeFx=null,this.snowFlakeGrabFx=null,this.boundOnStatsHatChange=(t=>{this.onStatsHatChange(t)}),this.localPlayer=null,this.animator=new D(this),this.loadPlayerModel(),this.dashLine=new C(this.playerObj),this.myPlayerIndicator=null,this.updateHat(),this.updateHatTimeout=new Kt(t=>{this.updateHat()},1e3)}static get lastChickenSfxWalkTime(){return this._lastChickenSfxWalkTime}static set lastChickenSfxWalkTime(t){this._lastChickenSfxWalkTime=t}destructor(){this.clearLocalPlayer(),this.playerObj.parent.remove(this.playerObj),this.destructed=!0,this.updateMyPlayerIndicator(),this.dashLine.destructor(),this.dashLine=null,this.tornadoFx&&(this.tornadoFx.destructor(),this.tornadoFx=null),this.iceCubeFx&&(this.iceCubeFx.destructor(),this.iceCubeFx=null),this.snowFlakeGrabFx&&(this.snowFlakeGrabFx.destructor(),this.snowFlakeGrabFx=null),this.sprintingSfx&&this.sprintingSfx.stop(),this.updateHatTimeout.destructor(),this.updateHatTimeout=null}get pos2d(){return new THREE.Vector2(this._pos.x,this._pos.z)}get pos(){return this._pos.clone()}get jumpPressed(){if(this.isMyPlayer){if(!this.allowInput||!this.localPlayer)return!1;for(const t of this.localPlayer.inputs)if(t.jumpPressed)return!0;return!1}return this._jumpPressed}set jumpPressed(t){this._jumpPressed=t}get sprintPressed(){if(this.isMyPlayer){if(!this.allowInput||!this.localPlayer)return!1;for(const t of this.localPlayer.inputs)if(t.sprintPressed)return!0;return!1}return!1}set isMyPlayer(t){this._isMyPlayer=t}get isMyPlayer(){return this._isMyPlayer}hapticPulse(t,e,i){if(this.controllableByMe)for(const n of this.localPlayer.inputs)n.hapticPulse(t,e,i)}getLocalInputDirection(){let t=this.localPlayer;if(t){let e=new THREE.Vector3;for(const i of t.inputs)e.add(i.currentInputDirection);return e.clampLength(0,1),e}return null}allowTemporaryPlayerInput(t){this.isTemporaryMyPlayer=t,t&&!this.hasReceivedFirstPosition&&this.respawnToLobby()}get invMass(){if(this.hasHeavyPotion)return.01;let t=this.serverMass;return this.jumpPressed&&(t/=5),1/t}getServerMassJumpMultiplier(){return Zt.mapValue(.7,1.5,.6,.5,this.serverMass,!0)}get controllableByMe(){return this.isMyPlayer&&this.localPlayer&&!this.localPlayer.isBot}get isOnDisk(){return null!=this.lastTouchedDisk&&!this.lastTouchedDisk.destructed}get accurateNetworkData(){return this.lastNetworkUpdateTime+200>p.now}get didDashRecently(){return p.now-this.lastDashTime<200}get stats(){let t=this.localPlayer;if(t){let e=t.stats;if(e)return e}return null}get hasCrown(){if(this.serverHasCrown)return!0;let t=this.stats;return!!t&&t.numberOne}async loadPlayerModel(t=!1){if(this.isLoadingPlayerModel&&(await new Promise((t,e)=>{this.onPlayerModelLoadCbs.push(t)}),!t))return;if(this.playerAsset){if(!t)return;this.chickenObj&&this.playerObj.remove(this.chickenObj)}this.isLoadingPlayerModel=!0,this.playerAsset=await p.playerAssetsCache.getRandomChicken();let e=p.cornerSettings.quality<=.3?this.playerAsset.objUnlit:this.playerAsset.obj;this.chickenObj=e.clone(),this.playerObj.add(this.chickenObj),this.chickenObj.position.y=.05-this.radius,this.chickenBody=this.chickenObj.getObjectByName("Chicken"),this.chickenWingL=this.chickenObj.getObjectByName("ChickenWings_L"),this.chickenWingR=this.chickenObj.getObjectByName("ChickenWings_R"),this.chickenComb=this.chickenObj.getObjectByName("ChickenComb"),this.animator.setObjects([this.chickenBody,this.chickenComb],this.chickenObj,this.chickenWingL,this.chickenWingR);for(const i of this.onPlayerModelLoadCbs)i();this.onPlayerModelLoadCbs=[],this.isLoadingPlayerModel=!1,p.sfx.playSound("chicken/spawn",Zt.randRange(.9,1.2)),this.updateHat()}setHatFromServer(t){this.serverHatId=t,this.updateHatTimeout.start()}setHasCrownFromServer(t){this.serverHasCrown=t,this.updateHat()}setServerMass(t){this.serverMass=t,this.controllableByMe&&p.cornerStats.setPlayerScale(t),this.updatePlayerSize()}updatePlayerSize(){if(this.heavyPotionAnimating){let t=p.now-this.heavyPotionAnimationStartTime,e=this.serverMass,i=2.5;if(this.hasHeavyPotion){let n=Zt.mapValue(0,1e3,e,i,t,!0);this.setPlayerSize(n)}else{let n=Zt.mapValue(0,1e3,i,e,t,!0);this.setPlayerSize(n)}let n=Zt.mapValue(0,1e3,1,0,t,!0);this.animator.setGrowingAnimation(n),t>1e3&&(this.heavyPotionAnimating=!1)}else this.hasHeavyPotion?this.setPlayerSize(2.5):this.setPlayerSize(this.serverMass)}setPlayerSize(t){this.playerObj.scale.setScalar(t),this.radius=t,this.animator.updateObjectSizes()}async createHatObject(){this.hatObj||(this.hatsContainerObj=new THREE.Object3D,this.hatsContainerObj.name="hats container",this.hatObj=new THREE.Object3D,this.hatObj.name="hat",this.hatsContainerObj.add(this.hatObj),this.animator.setHatObject(this.hatsContainerObj)),await this.loadPlayerModel(),this.chickenObj.add(this.hatsContainerObj)}getMyHatId(){let t=this.localPlayer;if(t){let e=t.stats;return e?e.selectedHatId:(this.didSelectBotHat||(this.didSelectBotHat=!0,this.selectedBotHatId=p.hats.getRandomBotHatId()),this.selectedBotHatId)}return this.serverHatId}async updateHat(){await this.createHatObject(),this.hasCrown?(this.crownObj=await p.hats.getCrown(),this.hatsContainerObj.add(this.crownObj)):this.crownObj=null;let t=!1,e=this.getMyHatId(),i=await p.hats.getHatObject(e);if(e!=this.getMyHatId())return;for(;this.hatObj.children.length;){let t=this.hatObj.children[0];this.hatObj.remove(t),t.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}i?(i.main&&this.hatObj.add(i.main),this.chickenComb.visible=!i.hideComb&&!this.hasCrown,this.animator.setScaleHatWithPlayer(i.scaleWithPlayer),this.selectedHatObj=i.main,t=i.ignoreCrownYOffset):this.selectedHatObj=null;let n=this.hasCrown&&!t;this.hatObj.position.y=n?.8:0,this.animator.updateHatMorphDictionary()}loop(t,e){this._pos.clampScalar(-200,200);{let t=new THREE.Vector3(1,0,0),i=0;this.currentInputDirection.length()<.05?i=NaN:(i=this.currentInputDirection.angleTo(t),this.currentInputDirection.clone().cross(t).y>0&&(i*=-1));let n=Math.PI,s=i-Zt.modMinMax(this.targetRotationAngle,-n,n);if(s=Zt.modMinMax(s,-n,n),isNaN(s)||(this.targetRotationAngle+=s),!this.isMyPlayer){let t=Zt.modMinMax(this.targetRotationAngle,-n,n),e=this.networkRotationAngle-t;e=Zt.modMinMax(e,-n,n),isNaN(e)||(this.targetRotationAngle+=e)}this.currentInputDirection.length()>.1||Math.abs(this.targetRotationAngle-this.smoothRotationAngle)>n||!this.isMyPlayer?(this.smoothRotationAngle=Zt.lerp(this.smoothRotationAngle,this.targetRotationAngle,Zt.lerptt01(.1,e/16.6666)),this.playerObj.rotation.y=this.smoothRotationAngle,this.forward.set(1,0,0),this.forward.applyAxisAngle(new THREE.Vector3(0,1,0),this.smoothRotationAngle)):this.targetRotationAngle=this.smoothRotationAngle}if((this.isMyPlayer||this.isTemporaryMyPlayer)&&t-this.lastPlayerDataSendTime>50&&!this.forceSetPosFromServer){this.lastPlayerDataSendTime=t;let e=-1;this.lastTouchedDisk&&!this.lastTouchedDisk.destructed&&(e=this.lastTouchedDisk.id),p.network.sendPlayerData({id:this.playerId,pos:this.pos,velocity:this.velocity,input:this.currentInputDirection,onDiskId:e,rotationAngle:Zt.modMinMax(this.targetRotationAngle,-Math.PI,Math.PI)})}let i=this.jumpPressed&&!this.cancelNextDashCharge;if(this.isOnDisk){if(i&&this.canDashCharge&&(this.setDashChargeAmount(this.dashChargeAmount+.001*e),this.controllableByMe)){this.setDashChargeSfx(!0);let t=this.getModifiedDashChargeAmount()>.5;t>.5&&!this.didPlayDashChargeDoneSfx&&(this.didPlayDashChargeDoneSfx=!0,this.hapticPulse(50,1,1),p.sfx.playSound("chicken/dashChargeDone")),t<.5?this.hapticPulse(20,.7*this.dashChargeAmount,.2*this.dashChargeAmount):this.hapticPulse(20,.15,0)}let n=this.getLocalInputDirection();if(n||(n=this.currentInputDirection),this.sprintPressed&&this.canSprint?(this.setIsSprinting(!0),this.isMyPlayer&&this.doCancelNextDashCharge()):n.length()<.05&&this.setIsSprinting(!1),i!=this.prevJumpPressed&&(this.isMyPlayer&&p.network.sendPlayerIsJumpingChange(this.playerId,i),!i&&(this.setDashChargeSfx(!1),!this.cancelNextDashCharge&&this.canDashCharge))){if(this.dashChargeAmount>.25){let e=1.1*this.getModifiedDashChargeAmount();if(this.prevTouchedDisk&&!this.prevTouchedDisk.destructed&&this.prevTouchedDisk.playerPhysicsSettings){let t=this.prevTouchedDisk.playerPhysicsSettings.dashMultiplier;(t||0===t)&&(e*=t)}let i=new THREE.Vector3(1,0,0);i.applyAxisAngle(new THREE.Vector3(0,1,0),this.smoothRotationAngle),i.setLength(e),this.velocity.add(i),this.lastDashTime=t,this.controllableByMe&&e>.1&&(p.sfx.playSound("chicken/dash",Zt.mapValue(0,3,1.3,.8,e,!0)),this.hapticPulse(250,1,1))}else if(this.jumpStamina>.1){let t=Zt.lerp(.4,1.3,this.jumpStamina),e=new THREE.Vector3(0,1,0);this.lastSetNotOnDiskTime=p.now,this.lastTouchedDiskBeforeJump=this.lastTouchedDisk,this.lastTouchedDisk=null,this.jumpReleaseTime=p.now,this.lastJumpAmount=t,e.setLength(t*this.getServerMassJumpMultiplier()),this.velocity.add(e),this.jumpStamina-=.4,this.playJumpSound(!1)}this.setDashChargeAmount(0)}if(this.lastTouchedDisk&&!this.lastTouchedDisk.destructed){let t=this.lastTouchedDisk;if(t.isSquareShape){let e=t.upVector,i=this.pos.sub(t.pos).projectOnPlane(e),n=t.customGeoAssetSize;(i.x+this.radius<-t.scaleX*n||i.x-this.radius>t.scaleX*n||i.z+this.radius<-t.scaleZ*n||i.z-this.radius>t.scaleZ*n)&&this.stopTouchingDisk()}else{this.pos.sub(t.pos).length()>t.radius+this.radius&&this.stopTouchingDisk()}}this.isSprinting&&(this.sprintingStamina-=.002*e*n.length(),this.sprintingStamina<=0&&this.setIsSprinting(!1))}else i!=this.prevJumpPressed&&!i&&this.canAirJump&&!this.didAirJumpOnce&&this.jumpStamina>.1&&!this.jumpPressedAfterSpawn&&(this.velocity.y+=1.5*this.getServerMassJumpMultiplier(),this.didAirJumpOnce=!0,this.jumpStamina-=.3,this.playJumpSound(!0)),i&&!this.hasFeatherPotion&&(this.flyingStamina-=.0017*e),this.setIsSprinting(!1);if(this.flyingStamina+=8e-4*e,this.flyingStamina=Zt.clamp01(this.flyingStamina),this.isFlying=i&&!this.isOnDisk&&this.canFly,(this.isFlying&&this.flyingStamina>.1||this.jumpPressedAfterSpawn)&&this.hapticPulse(100,.05,0),i!=this.prevJumpPressed&&(i||(this.jumpPressedAfterSpawn=!1)),this.prevJumpPressed=i,this.jumpPressed||(this.cancelNextDashCharge=!1),this.sprintingStamina+=5e-4*e,this.sprintingStamina=Zt.clamp01(this.sprintingStamina),this.jumpStamina+=4e-4*e,this.jumpStamina=Zt.clamp01(this.jumpStamina),!this.died&&this.pos.y<-20)this.doDeathThings();else{this.died&&this.pos.y>-10&&this.undoDeath();{let e=t-this.spawnStartTime;if(e*=7e-4,e+=this.spawnStartTimeOffset,this.isSpawnStartAnimating)if(e<1){let t=new THREE.Vector3(0,52,150),i=new THREE.Vector3(0,72,40);this._pos.lerpVectors(t,i,e),this._pos.x+=this.spawnStartXOffset}else this.isSpawnStartAnimatingBelt?(this.velocity.set(0,1,Zt.randRange(-6,-2)),this.spawnStartDragYPos=Zt.randRange(20,30),this.isSpawnStartAnimatingBelt=!1):(this.pos.y<this.spawnStartDragYPos||e>2)&&(this.isSpawnStartAnimating=!1,this.jumpPressedAfterSpawn=!0,this.allowInput=!0);this.jumpPressedAfterSpawn&&e>5&&(this.jumpPressedAfterSpawn=!1)}if(this.myPlayerIndicator){this.myPlayerIndicator.position.y=.1*Math.cos(.003*t*p.game.timeScale+this.myPlayerIndicatorTimeOffset)+2.5;let e=new THREE.Vector3;this.myPlayerIndicator.getWorldPosition(e);let i=.035*e.distanceTo(p.cam.camera.position);this.myPlayerIndicator.scale.setScalar(i)}if(this.activePotion&&t>this.activePotion.stopTime&&(this.onHasPotionChange(this.activePotion.type,!1),this.activePotion=null),this.heavyPotionAnimating&&this.updatePlayerSize(),this.hasTornadoPotion&&(this.playerObj.rotation.y=.04*t,this.tornadoFx&&(this.tornadoFx.obj.position.copy(this.pos),this.tornadoFx.loop(t,e))),this.hasSnowflakePotion&&this.iceCubeFx){let i=this.pos;i.y-=this.radius,this.iceCubeFx.obj.position.copy(i),this.iceCubeFx.obj.scale.setScalar(this.serverMass),this.iceCubeFx.loop(t,e)}if(this.snowFlakeGrabFx&&(this.snowFlakeGrabFx.obj.position.copy(this.pos),this.snowFlakeGrabFx.loop(t,e),this.snowFlakeGrabFx.done&&(this.snowFlakeGrabFx.destructor(),this.snowFlakeGrabFx=null)),this.hasHeavyPotion&&t-this.lastHeavyPotionHapticPulseTime>120&&this.currentInputDirection.length()>.2&&(this.lastHeavyPotionHapticPulseTime=t,this.hapticPulse(50,1,0)),this.hasTornadoPotion&&this.hapticPulse(100,.5,1),this.animator.loop(t,e),this.distanceWalked+=this.animator.smoothWalkSpeed*e,this.distanceWalked>this.lastChickenSfxDistanceWalked+1e3&&(O.lastChickenSfxWalkTime+100<t||void 0===O.lastChickenSfxWalkTime)){let e=Zt.randInt(0,2);O.lastChickenSfxWalkTime=t,p.sfx.playSound("chicken/walk"+e,Zt.randRange(.9,1.3)),this.lastChickenSfxDistanceWalked=this.distanceWalked}if(this.dashLine.visible=this.dashChargeAmount>0,this.dashLine.visible&&!this.controllableByMe){let t=!1;for(const e of p.game.getMyControllablePlayers()){if(e.pos.distanceTo(this.pos)<8){t=!0;break}}t||(this.dashLine.visible=!1)}if(this.dashLine.visible){let t=0;if(this.lastTouchedDisk&&!this.lastTouchedDisk.destructed){let e=this.lastTouchedDisk.upVector,i=this.forward.clone();i.applyAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2),e.projectOnPlane(i);let n=e.angleTo(new THREE.Vector3(0,1,0));isNaN(n)||(t=n)}this.dashLine.angle=t,this.dashLine.isBlinking=!this.controllableByMe,this.dashLine.isShaking=this.canDashCharge}this.dashLine.update(t)}}loopPhysics(t){if(this.isSpawnStartAnimatingBelt)return void this.updatePos();if(this._pos.addScaledVector(this.velocity,t/16.66),this.updatePos(),!this.isMyPlayer&&!this.isTemporaryMyPlayer&&this.accurateNetworkData){this.networkPosTarget.addScaledVector(this.networkVelocity,t/16.66);let e=this.pos.sub(this.networkPosTarget);e.multiplyScalar(-.001*t),e.clampLength(0,.5),this.velocity.add(e)}let e=0,i=0,n=!1,s={dragTargetVertical:.8,dragTargetVerticalWhenFalling:.98,dragTargetVerticalWhenFlying:.5,dragTargetHorizontal:.9,dragTargetHorizontalWhenFalling:.9,dragTargetHorizontalWhenFlying:.2,movementSpeedMultiplier:1,sprintSpeedMultiplier:2.5};this.prevTouchedDisk&&!this.prevTouchedDisk.destructed&&this.prevTouchedDisk.playerPhysicsSettings&&(s={...s,...this.prevTouchedDisk.playerPhysicsSettings}),this.isOnDisk?(e=s.dragTargetVertical,i=s.dragTargetHorizontal):this.jumpPressedAfterSpawn?(n=!0,i=.8,e=s.dragTargetVerticalWhenFlying):this.isFlying?(n=!0,i=s.dragTargetHorizontalWhenFlying,this.hasFeatherPotion?(e=.3,i=s.dragTargetHorizontalWhenFalling):e=Zt.lerp(s.dragTargetVerticalWhenFalling,s.dragTargetVerticalWhenFlying,Gt.out(this.flyingStamina))):(e=s.dragTargetVerticalWhenFalling,i=s.dragTargetHorizontalWhenFalling),e=Zt.clamp01(e),i=Zt.clamp01(i),n?(this.smoothDragVertical=Zt.lerptt(this.smoothDragVertical,e,.01,t/1.66666),this.smoothDragHorizontal=Zt.lerptt(this.smoothDragHorizontal,i,.01,t/1.66666)):(this.smoothDragVertical=e,this.smoothDragHorizontal=i);let r=Zt.lerptt10(this.smoothDragVertical,t/16.6666),a=Zt.lerptt10(this.smoothDragHorizontal,t/16.6666);if(this.velocity.x*=a,this.velocity.y*=r,this.velocity.z*=a,this.allowInput&&this.canWalk||this.isSliced){if(this.isSliced)this.currentInputDirection.copy(this.slicedWalkDirection);else{let t=this.getLocalInputDirection();t?this.currentInputDirection.set(t.x,0,t.z):this.accurateNetworkData||this.currentInputDirection.set(0,0,0)}let e=this.currentInputDirection.clone(),i=.6;i*=s.movementSpeedMultiplier,this.isOnDisk&&(this.jumpPressed&&!this.cancelNextDashCharge&&this.canDashCharge?i*=.3:this.isSprinting&&(i*=s.sprintSpeedMultiplier)),e.multiplyScalar(i),this.velocity.addScaledVector(e,.003*t)}if(this.heavyPotionAnimating&&!this.hasHeavyPotion&&(this.velocity.y+=.005*t),(this.isMyPlayer||this.isTemporaryMyPlayer||!this.accurateNetworkData)&&this.velocity.add(new THREE.Vector3(0,-this.gravityAmount*t/16.66,0)),this.lastTouchedDisk&&!this.lastTouchedDisk.destructed&&this.applyDiskSlopeForce){let e=this.lastTouchedDisk.slope;e.multiplyScalar(.002*t),this.velocity.x+=e.x,this.velocity.z+=e.y}}forceNextPositionFromServer(){this.forceSetPosFromServer=!0}setNetworkPosition(t,e,i,n,s,r,a,o,l,h,c){(!this.isMyPlayer&&!this.isTemporaryMyPlayer||this.forceSetPosFromServer)&&(this.isSpawnStartAnimatingBelt||(t!=this.currentNetworkPosVersion||this.forceSetPosFromServer)&&(this.currentNetworkPosVersion=t,this.lastNetworkUpdateTime=p.now,this.setNetworkPosTarget(e,i,n),this.velocity.set(s,r,a),this.networkVelocity.copy(this.velocity),this.currentInputDirection.set(o,0,l),this.lastTouchedDisk=p.game.getBalancingObjectById(c),this.lastTouchedDisk&&(this.prevTouchedDisk=this.lastTouchedDisk),this.networkRotationAngle=h,this.forceSetPosFromServer=!1))}setNetworkPositionFromPlayerHit(t){this.isMyPlayer||this.setNetworkPosTarget(t.x,t.y,t.z,3)}setNetworkPosTarget(t,e,i,n=8){this.networkPosTarget.set(t,e,i);let s=this.pos.distanceTo(this.networkPosTarget),r=this.lastNetworkPosWasCheatTeleport;this.lastNetworkPosWasCheatTeleport=!1,(this.forceSetPosFromServer||s>n||!this.hasReceivedFirstPosition)&&(!this.forceSetPosFromServer&&this.hasReceivedFirstPosition&&s>n&&(this.lastNetworkPosWasCheatTeleport=!0),this._pos.set(t,e,i),this.hasReceivedFirstPosition=!0),r!=this.lastNetworkPosWasCheatTeleport&&this.lastNetworkPosWasCheatTeleport&&(this.lastCheatTeleportTime=p.now)}spawnStartGame(){this.isSpawnStartAnimating=!0,this.isSpawnStartAnimatingBelt=!0,this.allowInput=!1,this.spawnStartTime=p.now,this.isMyPlayer&&(this.spawnStartXOffset=Zt.randRange(-12,12),this.spawnStartTimeOffset=Zt.randRange(-.3,0),p.network.sendPlayerLaunchPos(this.playerId,this.spawnStartXOffset,this.spawnStartTimeOffset))}setLauchStartPos(t,e){this.spawnStartXOffset=t,this.spawnStartTimeOffset=e}respawnToLobby(){p.game.lobbyBalancingObject?this._pos=p.game.lobbyBalancingObject.getRandomPosOnSquare():this._pos=new THREE.Vector3,this._pos.y+=2,this.clearAllPotions(),this.unSlicePlayer()}setDashChargeAmount(t){this.dashChargeAmount=t,this.dashLine.length=7*this.getModifiedDashChargeAmount(!0)}stopTouchingDisk(){this.lastSetNotOnDiskTime=p.now,this.lastTouchedDisk=null,this.setDashChargeAmount(0)}getModifiedDashChargeAmount(t=!1){const e=this.isMyPlayer||!t?1:0;if(this.dashChargeAmount<=e)return 0;let i=-.03/(this.dashChargeAmount-e),n=Math.cos(20*(this.dashChargeAmount-e))*i+1;return Math.max(0,n)}getDashChargeShakeAmount(){let t=this.dashChargeAmount<1?0:1-1/(60*(this.dashChargeAmount-1)),e=1-1/(10*(this.dashChargeAmount+.1)),i=this.dashChargeAmount<1?e:.15;return this.canDashCharge||(i=0),{dashChargeAmountMorph:Math.max(t,.3*e),dashChargeAmountShake:i}}doCancelNextDashCharge(){this.cancelNextDashCharge=!0,this.setDashChargeAmount(0),this.isMyPlayer&&this.sendPlayerControlsData(Y.PlayerControlsType.CANCEL_DASH_CHARGE)}sendPlayerControlsData(t,e=[]){p.network.sendPlayerControlsData(this.playerId,t,e)}handleControlsData(t,e){let i=new Uint32Array(e);if(t==Y.PlayerControlsType.JUMP){if(this.isMyPlayer)return;this.jumpPressed=!!i[3]}else if(t==Y.PlayerControlsType.CANCEL_DASH_CHARGE){if(this.isMyPlayer)return;this.doCancelNextDashCharge()}else if(t==Y.PlayerControlsType.SLICED){!!i[3]?this.makeSliced(!0):this.unSlicePlayer(!0)}else t==Y.PlayerControlsType.SLICED_VERTICAL&&this.makeSlicedVertical(!0)}onDisconnect(t=!1){t&&this.doDeathThings(!0),this.destructor()}doDeathThings(t=!1){if(!this.died){if(this.died=!0,this.deathTime=p.game.serverTime,p.cam.doDeathCamShake(),this.startDeathFX(),this.localPlayer&&this.localPlayer.playerDied(),this.isMyPlayer||this.isTemporaryMyPlayer||p.network.isOfflineGame){if(!this.didGetVerticalSliced){let t=this.controllableByMe?"death":"otherDeath";p.sfx.playSound("chicken/"+t,Zt.randRange(1,1.8))}this.hapticPulse(180,1,1),t||this.sendPlayerDied(),p.mainMenu.updateUIVisibilities(),p.game.gameStateManager.onPlayerDied()}this.controllableByMe&&p.cam.addTemporaryDeathPlayerPos(this.pos)}}sendPlayerDied(){p.network.sendPlayerDied(this.playerId)}undoDeath(){this.isMyPlayer||p.network.isOfflineGame||(this.died=!1)}updatePos(){this.playerObj.position.x=this._pos.x,this.playerObj.position.y=this._pos.y,this.playerObj.position.z=this._pos.z}setIsSprinting(t){this.isSprinting!=t&&(this.isSprinting=t,this.controllableByMe&&this.setSprintingSound(t))}async setSprintingSound(t){this.sprintingSfx||(this.sprintingSfx=await p.sfx.getSound("chicken/sprint")),this.sprintingSfx&&(t?this.sprintingSfx.play():this.sprintingSfx.stop())}async setDashChargeSfx(t){t!=this.isPlayingDashChargeSfx&&(this.isPlayingDashChargeSfx=t,this.dashChargeSfx||(this.dashChargeSfx=await p.sfx.getSound("chicken/dashCharge")),this.dashChargeSfx&&(t?this.dashChargeSfx.play():(this.dashChargeSfx.stop(),this.didPlayDashChargeDoneSfx=!1)))}playJumpSound(t){if(this.controllableByMe){let e=t?1.1:1;this.hasFeatherPotion?p.sfx.playSound("items/featherJump",e):p.sfx.playSound("chicken/jump",e)}}explodeNearbyPlayers(t){for(const e of p.game.players){let i=e.pos.sub(this.pos),n=i.length();i.setLength(Zt.clamp01(2-.4*n)*t),e.addImpulse(i)}}testCollisions(t){if(!this.isSpawnStartAnimating){if(this.isMyPlayer||this.isTemporaryMyPlayer||this.hasTornadoPotion){if(this.hasPlayerCollisions)for(const e of t){if(this==e)continue;let t=this.testColliding(e);t&&O.resolvePlayerCollision(t)}if(this.hasTornadoPotion)for(const e of t){if(this==e)continue;let t=this.pos,i=e.pos,n=Math.abs(t.y-i.y);t.y=i.y=0;let s=t.distanceTo(i);if(s<3){let t=Zt.mapValue(-1,1,.2,1,Math.cos(.01*p.now))/(n*n);t=Math.min(.3,t),t*=Zt.mapValue(2.5,3,1,0,s,!0),e.addImpulse(new THREE.Vector3(0,t,0))}}}for(const t of p.game.balancingObjects){if(!t)continue;let e=t.testPlayerCollision(this);if(e){let i=O.resolveDiskCollision(e);p.now-this.lastSetNotOnDiskTime>200*this.lastJumpAmount&&!e.touchedBorder&&(this.lastTouchedDisk&&!this.lastTouchedDisk.destructed||(this.lastTouchedDiskLandTime=p.now,this.lastTouchedDiskFallSpeed=Math.abs(i.velocityAlongNormal)),this.lastTouchedDisk=t,this.lastTouchedDisk&&(this.prevTouchedDisk=this.lastTouchedDisk),this.jumpPressedAfterSpawn=!1,this.didAirJumpOnce=!1)}}}}testColliding(t){if(!t.hasPlayerCollisions)return null;let e=this.radius+t.radius,i=this.playerObj.position.distanceTo(t.playerObj.position);if(i>e)return null;let n=this.pos;return n.sub(t.pos),{type:"player",a:this,b:t,penetration:e-i,normal:n.normalize()}}addImpulse(t){this.velocity.add(t.clone().multiplyScalar(this.invMass))}addCorrection(t){this._pos.add(t)}static resolvePlayerCollision(t){let e=t.a,i=t.b,n=e.velocity.clone().sub(i.velocity).dot(t.normal);if(n>0)return;let s=-1*n;s/=e.invMass+i.invMass,s*=2;let r=t.normal.clone().multiplyScalar(s),a=null,o=null;e.isMyPlayer?(a=e,o=i):i.isMyPlayer&&(a=i,o=e),a&&s>.5&&a.didDashRecently&&a.velocity.length()>o.velocity.length()&&p.network.sendHitOtherPlayer(a.playerId,o.playerId,a.pos,r),s>.5&&(e.controllableByMe&&e.didDashRecently||i.controllableByMe&&i.didDashRecently)&&p.sfx.playSound("chicken/dashHit"),e.doHitByPlayerImpulse(i.playerId,r),i.doHitByPlayerImpulse(e.playerId,r.multiplyScalar(-1))}doHitByPlayerImpulse(t,e,i=!1){i&&this.lastHitPlayerId==t&&p.now-this.lastHitPlayerTime<300||(this.lastHitPlayerId=t,this.lastHitPlayerTime=p.now,this.addImpulse(e))}static resolveDiskCollision(t){let e=t.player.velocity.clone().sub(t.diskVelocity).dot(t.normal);if(e>0)return{velocityAlongNormal:0};let i=-1*e;i/=t.player.invMass;let n=t.normal.clone().multiplyScalar(i);t.player.addImpulse(n);let s=0;t.player.lastTouchedDisk&&!t.player.lastTouchedDisk.destructed&&(s=.2*t.player.lastTouchedDisk.getFrictionAmountForPos(t.player.pos));let r=t.player.velocity.clone().sub(t.diskVelocity),a=r.clone().projectOnPlane(t.normal);a.normalize();let o=r.clone().multiplyScalar(-1).dot(a);o/=t.player.invMass;let l=a.clone(),h=s;Math.abs(o)<i*h?l.multiplyScalar(o):l.multiplyScalar(-i*s),t.player.addImpulse(l);let c=.8*Math.max(t.penetration-.001,0),u=t.normal.clone().multiplyScalar(c);return t.player.addCorrection(u),{velocityAlongNormal:e}}setLocalPlayer(t){this.clearLocalPlayer(),this.localPlayer=t,this.updateMyPlayerIndicator(),this.updateHat(),this.stats&&this.stats.onHatChange(this.boundOnStatsHatChange)}clearLocalPlayer(){this.localPlayer&&(this.localPlayer.deactivate(),this.localPlayer.stats&&this.localPlayer.stats.removeOnHatChange(this.boundOnStatsHatChange))}onStatsHatChange(){this.updateHat()}async updateMyPlayerIndicator(){let t=-1;if(this.stats&&(t=this.stats.id),(t<0||this.destructed)&&this.myPlayerIndicator)Zt.removeAndDisposeChildren(this.myPlayerIndicator),this.myPlayerIndicator=null;else if(t>=0){if(!this.myPlayerIndicator){let t=await p.assets.main.getJsonObject("playerIndicator.json");this.myPlayerIndicator=t,this.playerObj.add(this.myPlayerIndicator),this.myPlayerIndicatorTimeOffset=100*Math.random()}let e=p.colors.getPlayerColorFromId(t);this.myPlayerIndicator.children[1].material.color.setHex(e.main)}}startSnowFlakeGrabFx(){this.snowFlakeGrabFx||(this.snowFlakeGrabFx=new te)}startDeathFX(){let t=p.particles.createSystem({particleAssetPath:"particles/feather.json",particleCount:10,duration:2,spawnerShape:{type:"boxFaces"},startVelocity:{x:.3,minY:.2,maxY:.6,z:.3},billboardParticles:!0,angularVelocity:8,drag:.05});t&&t.obj.position.copy(this.pos);let e=p.particles.createSystem({particleAssetPath:"particles/tinyFeather.json",particleCount:15,duration:5,particleLifetime:5e3,loopAfterLifetime:!1,spawnerShape:{type:"boxFaces",size:0},particleSize:.4,startVelocity:{x:1.5,minY:0,maxY:1.5,z:1.5},particleOpacity:{start:1,end:0},billboardParticles:!0,angularVelocity:3,drag:.6});e&&e.obj.position.copy(this.pos)}makeSliced(t=!1){if(this.isSliced)return;if(!t){if(!this.isMyPlayer&&!this.isTemporaryMyPlayer)return;this.sendPlayerControlsData(Y.PlayerControlsType.SLICED,[!0])}let e="chickenSawSlice";if(this.controllableByMe||(e+="Other"),p.sfx.playSound(e,Zt.randRange(.9,1.1)),this.isSliced=!0,this.clearAllPotions(),this.updatePotionProperties(),this.startDeathFX(),this.slicedWalkDirection=this.forward.clone(),this.slicedWalkDirection.length()<=0){let t=Math.random()*Math.PI*2;this.slicedWalkDirection.set(Math.cos(t),0,Math.sin(t))}if(this.slicedWalkDirection.setLength(.65),!this.playerAsset||!this.playerAsset.slicedObj)return;this.chickenObjSliced=this.playerAsset.slicedObj.clone(),this.chickenObjSliced.position.y=-.947,this.playerObj.add(this.chickenObjSliced),this.chickenObj.visible=!1,this.animator.setObjects([this.chickenObjSliced.getObjectByName("SliceSkinBottom.001_0")],this.chickenObjSliced),this.animator.setWalkSpeedMultiplier(1.7);let i=[];i.push({obj:this.chickenObjSliced.getObjectByName("ChickenTop"),clone:!1}),this.doSlicedFx([],i)}unSlicePlayer(t=!1){if(this.isSliced){if(!t){if(!this.isMyPlayer)return;this.sendPlayerControlsData(Y.PlayerControlsType.SLICED,[!1])}this.isSliced=!1,this.updatePotionProperties(),this.chickenObj&&(this.chickenObj.visible=!0),this.playerObj.remove(this.chickenObjSliced),this.animator.setObjects([this.chickenBody,this.chickenComb],this.chickenObj,this.chickenWingL,this.chickenWingR),this.animator.setWalkSpeedMultiplier(1)}}makeSlicedVertical(t=!1){if(this.died)return;if(!t){if(!this.isMyPlayer&&!this.isTemporaryMyPlayer)return;this.sendPlayerControlsData(Y.PlayerControlsType.SLICED_VERTICAL)}this.didGetVerticalSliced=!0;let e="chickenKnifeSlice";if(this.controllableByMe||(e+="Other"),p.sfx.playSound(e,Zt.randRange(.9,1.1)),!this.playerAsset||!this.playerAsset.slicedObjVertical)return;let i=this.playerAsset.slicedObjVertical.clone();i.position.y=-.947,this.playerObj.add(i);let n=[];if(i.children.length>0)for(const[s,r]of i.children[0].children.slice().entries()){let t=void 0,e=new THREE.Vector3(Zt.randRange(-.005,.005),Zt.randRange(.005,.015),Zt.randRange(-.005,.005));if("ChickenHalfBack"==r.name){t=new THREE.Vector3(0,0,Zt.randRange(.02,.04));let i=this.smoothRotationAngle-.5*Math.PI;e.x=.003*Math.sin(i),e.z=.003*Math.cos(i)}else if("ChickenHalfFront"==r.name){t=new THREE.Vector3(0,0,-Zt.randRange(.02,.04));let i=this.smoothRotationAngle+.5*Math.PI;e.x=.003*Math.sin(i),e.z=.003*Math.cos(i)}n.push({obj:r,clone:!1,angularVelocity:t,yVelocity:Zt.randRange(.005,.015),velocity:e})}this.doSlicedFx(n),t||this.doDeathThings(!1)}doSlicedFx(t=[],e=[]){let i=Zt.randRange(.005,.015),n=Zt.randRange(-.05,.05);this.hasCrown&&this.crownObj&&e.push({obj:this.crownObj}),this.selectedHatObj&&e.push({obj:this.selectedHatObj});for(const s of t)this.addSlicedObject(s,i,n);for(const[s,r]of e.entries())this.addSlicedObject(r,i*(.3*s+1),n*(1+.5*s))}addSlicedObject(t,e,i){let n,s=t.obj;if(t.clone||void 0===t.clone){let t=s.clone();s.parent.add(t),s=t}if(t.yVelocity&&(e=t.yVelocity),t.angularVelocity&&(i=t.angularVelocity),n=t.velocity?t.velocity:new THREE.Vector3(0,e,0),s){let t=new N(s,n,i);p.game.slicedPlayerTopHalfs.push(t)}}testTouchPotion(t){if((this.isMyPlayer||this.isTemporaryMyPlayer)&&!this.activePotion)for(const e of t){this.pos.distanceTo(e.pos)<this.radius+e.radius&&e.playerTouched(this)}}applyPotion(t,e=5e3){let i=p.now+e;if(this.activePotion){if(this.activePotion.type==t)return void(this.activePotion.stopTime=i);this.onHasPotionChange(this.activePotion.type,!1),this.activePotion=null}this.activePotion={type:t,stopTime:i},this.onHasPotionChange(t,!0)}clearAllPotions(){this.activePotion&&(this.onHasPotionChange(this.activePotion.type,!1),this.activePotion=null)}onHasPotionChange(t,e){let i=e;t==$t.Types.HEAVY&&(this.hasHeavyPotion=e,this.heavyPotionAnimating=!0,this.heavyPotionAnimationStartTime=p.now,p.sfx.playSound("items/grow"+(e?"Start":"End"),Zt.randRange(.8,1.2),this.controllableByMe?1:.3)),t==$t.Types.TORNADO&&(this.hasTornadoPotion=e,e?(this.tornadoFx||(this.tornadoFx=new ee),p.sfx.playSound("items/tornado")):this.tornadoFx&&(this.tornadoFx.destructor(),this.tornadoFx=null)),t==$t.Types.FEATHER&&(this.hasFeatherPotion=e,e?(p.sfx.playSound("items/featherStart"),this.animator.setBigWingsAnimation(!0)):this.animator.setBigWingsAnimation(!1)),t==$t.Types.SNOWFLAKE&&(i=!1,this.hasSnowflakePotion=e,e?(this.iceCubeFx||(this.iceCubeFx=new Qt),p.sfx.playSound("items/iceFreeze",Zt.randRange(.7,1.2)),this.velocity.set(0,0,0),this.animator.setFrozen(!0)):this.iceCubeFx&&(this.iceCubeFx.playBreakFx(),this.iceCubeFx.destructor(),this.iceCubeFx=null,p.sfx.playSound("items/iceBreak",Zt.randRange(.8,1.1)),this.animator.setFrozen(!1))),i&&p.sfx.playSound("nuggetBite1"),this.updatePotionProperties()}updatePotionProperties(){let t=!0,e=!0,i=!0,n=!0,s=!0,r=!0,a=!0,o=.04;this.isSliced?(e=!1,i=!1,n=!1,s=!1):this.hasHeavyPotion?(e=!1,i=!1,s=!1,a=!1):this.hasTornadoPotion?(e=!1,i=!1,s=!1,r=!1,a=!1):this.hasFeatherPotion?o=.02:this.hasSnowflakePotion&&(e=!1,i=!1,n=!1,s=!1,t=!1),this.canWalk=t,this.canDashCharge=e,this.canAirJump=i,this.canFly=n,this.canSprint=s,this.hasPlayerCollisions=r,this.applyDiskSlopeForce=a,this.gravityAmount=o}testTouchCornSeed(t){if(this.controllableByMe)for(const e of t){this.pos.distanceTo(e.pos)<this.radius+e.radius&&e.playerTouched(this)}}testHitStageObject(t){let e=p.now-this.lastHitStageObjectTime,i=Math.pow(this.lastHitStageObjectClosestIntervalDist,2);if(this.isMyPlayer||this.isTemporaryMyPlayer?(i*=.002,i=Math.min(1,i)):(i*=.05,i+=1,i=Math.min(5,i)),e/1e3<i)return null;let n=1/0,s=!1,r=1/0,a=1/0;for(const o of t)if(o)if("saw"==o.type){let t=o.getDistanceFromSaw(this.pos);if(n=Math.min(t,n),s=!0,r=Math.min(t,r),t<1.5){this.makeSliced();break}}else if("knife"==o.type){let{closestDist:t,intervalDist:e}=o.getDistanceFromSharpEdge(this.pos);if(r=Math.min(t,r),a=Math.min(e,a),o.overrideIntervalClosestDist&&(a=0),t<this.radius){if(o.dieTypeIsVertical){this.makeSlicedVertical();break}this.makeSliced();break}}return this.lastHitStageObjectClosestIntervalDist=Math.min(r,a),this.lastHitStageObjectClosestDist=r,this.lastHitStageObjectTime=p.now,{closestSawDist:n,didFindSawDist:s}}reportThisPlayer(t){p.network.sendReportCheatingPlayer(this.playerId,t)}verifyCheater(t){if(this.isMyPlayer)return;if(t-this.lastVerifyCheaterCheck<1e3)return;this.lastVerifyCheaterCheck=t;let e=0;if(this.died){e+=Zt.clamp(.1*(p.game.serverTime-this.deathTime-1e3),0,1e3)}if(this.lastNetworkPosWasCheatTeleport){e+=Zt.clamp(.1*(p.now-this.lastCheatTeleportTime-1e3),0,1e3)}return e>0&&this.reportThisPlayer(e),!0}}class D{constructor(t){this.player=t,this.morphObjects=null,this.hat=null,this.scaleHatWithPlayer=!0,this.currentWalkTime=0,this.screamSmoothAmount=0,this.dashMorphSmoothAmount=0,this.wingFlappingOffset=100*Math.random(),this.walkSpeedMultiplier=1,this.smoothWalkSpeed=0,this.smoothJumpAddAmount=0;let e=Math.PI/180;this.hatPositions={default:{pos:[.038,2.352,-.016],influence:1},dashIn:{pos:[.193,-.6,.019],rot:[.74*e,-3.7*e,15*e]},dashOut:{pos:[-.551,-.039,.015],rot:[.47*e,-.3*e,3.67*e]},jump:{pos:[-.291,-.05,-.007],rot:[-.44*e,1.44*e,17.8*e]},fall:{pos:[.03,.463,.027]},flat:{pos:[.031,-1.379,-.019]}},this.hatMorphObjects=[],this.growingAnimationAmount=0,this.hasBigWings=!1,this.frozenAnimations=!1}setObjects(t,e,i,n){this.morphObjects=t,this.scene=e,this.leftWing=i,this.rightWing=n}setWalkSpeedMultiplier(t){this.walkSpeedMultiplier=t}setHatObject(t){this.hat=t}setScaleHatWithPlayer(t){this.scaleHatWithPlayer=t,this.updateObjectSizes()}setGrowingAnimation(t){this.growingAnimationAmount=t}setBigWingsAnimation(t){this.hasBigWings=t,this.updateObjectSizes()}loop(t,e){if(!this.morphObjects)return;if(this.frozenAnimations)return;let i=0;this.player.isOnDisk&&this.player.allowInput&&this.player.canWalk&&(i=this.player.currentInputDirection.length()),i*=this.walkSpeedMultiplier,this.smoothWalkSpeed=Zt.lerptt(this.smoothWalkSpeed,i,.3,e/16.6666);let n=this.player.velocity.length(),s=this.player.velocity.clone();s.y=0;let r=s.length(),a=this.player.velocity.y,o=p.game.timeScale;this.currentWalkTime+=e*this.smoothWalkSpeed*o;let{dashChargeAmountMorph:l,dashChargeAmountShake:h}=this.player.getDashChargeShakeAmount();this.setInfluence("walk1",Math.sin(.03*this.currentWalkTime)*this.smoothWalkSpeed),this.setInfluence("walk2",Math.cos(.03*this.currentWalkTime)*this.smoothWalkSpeed);let c=Math.cos(.03*this.currentWalkTime)*this.smoothWalkSpeed,u=Math.cos(.07*t*o)*h;this.scene.rotation.y=.03*c,this.scene.rotation.x=.1*c+.1*u,this.setHatMorphValue(Math.sin(.03*this.currentWalkTime)+1);let d=0;n>.2&&(d=1),this.screamSmoothAmount=Zt.lerptt(this.screamSmoothAmount,d,.3,e/16.6666),this.setInfluence("scream",Zt.lerp(.5,1,.5*Math.cos(.05*t*o)+.5)*this.screamSmoothAmount);let m=Zt.mapValue(.3,1,0,3,r,!0),f=new THREE.Vector3(1,0,0);f.applyAxisAngle(new THREE.Vector3(0,1,0),this.player.smoothRotationAngle);let g=f.angleTo(s);isNaN(g)&&(g=0),m*=Zt.mapValue(.8,1.5,1,0,g,!0);let y=this.dashMorphSmoothAmount>m?.4:.15;this.dashMorphSmoothAmount=Zt.lerptt(this.dashMorphSmoothAmount,m,y,e/16.6666),this.setInfluence("dashOut",this.dashMorphSmoothAmount),this.setInfluence("dashIn",l);let v=Zt.clamp01(-a);this.player.hasTornadoPotion&&(v=1),this.setInfluence("fall",v);let b=a;this.smoothJumpAddAmount=Zt.lerptt(this.smoothJumpAddAmount,this.player.isFlying?.7:0,.1,e/16.666),b+=this.smoothJumpAddAmount,b=Zt.clamp01(b),this.setInfluence("jump",b);let w=1-.01*(t-this.player.lastTouchedDiskLandTime)*o;w*=this.player.lastTouchedDiskFallSpeed,w=Zt.clamp01(w),w+=.2*Math.cos(.03*t)*this.growingAnimationAmount,this.setInfluence("flat",w);let x=Zt.clamp01(3*this.dashMorphSmoothAmount);x=-l;let S=Zt.lerp(1.5148578882217407,.9,l);S=Zt.lerp(S,.5,w);let E=Zt.lerp(1,0,w),M=Zt.lerp(.85,1.3,w);M*=1-.08*v-.4*b;let T=0,C=0;if(this.player.isOnDisk?C=Zt.clamp01(4*r):T=1,this.leftWing&&this.rightWing){this.leftWing.rotation.y=x,this.rightWing.rotation.y=-x,this.leftWing.position.y=this.rightWing.position.y=S,this.leftWing.position.z=-M,this.rightWing.position.z=M;let e=Math.cos(.03*t*o+this.wingFlappingOffset);this.leftWing.rotation.x=Zt.lerp(-E,e,C),this.rightWing.rotation.x=Zt.lerp(E,e,C),this.leftWing.rotation.x=Zt.lerp(this.leftWing.rotation.x,e,T),this.rightWing.rotation.x=Zt.lerp(this.rightWing.rotation.x,-e,T)}this.setHatPos()}setInfluence(t,e){if(this.morphObjects){for(const i of this.morphObjects){if(!i)continue;let n=i.morphTargetDictionary[t];i.morphTargetInfluences[n]=e}if(this.hat){let i=this.hatPositions[t];i&&(i.influence=e)}}}setHatPos(){if(!this.hat)return;let t=[0,0,0],e=[0,0,0];for(let[i,n]of this.hatPositions.keyValues){let i=n.influence;n.pos&&(t[0]+=n.pos[0]*i,t[1]+=n.pos[1]*i,t[2]+=n.pos[2]*i),n.rot&&(e[0]+=n.rot[0]*i,e[1]+=n.rot[1]*i,e[2]+=n.rot[2]*i)}this.hat.position.fromArray(t),this.hat.rotation.fromArray(e)}updateObjectSizes(){let t=this.player.radius;if(this.hat){let e=1;if(!this.scaleHatWithPlayer){const i=1.3333;e=Math.max(1,(1.5-t)*i+1)}this.hat.scale.setScalar(e)}if(this.leftWing&&this.rightWing){let e=Zt.mapValue(.7,1.5,.4,.25,t,!0);this.hasBigWings&&(e*=2),this.leftWing.scale.setScalar(e),this.rightWing.scale.setScalar(e)}}setFrozen(t){this.frozenAnimations=t}updateHatMorphDictionary(){this.hatMorphObjects=[],this.hat&&this.hat.traverse(t=>{if(t.morphTargetDictionary){let e,i=t.morphTargetDictionary;void 0!==i.move&&(e=i.move),void 0!==i.Move&&(e=i.Move),void 0!==i.morphTarget0&&(e=i.morphTarget0),void 0!==e&&this.hatMorphObjects.push({index:e,obj:t})}})}setHatMorphValue(t){for(const e of this.hatMorphObjects)e.obj.morphTargetInfluences[e.index]=t}}class k{constructor(){this.textureNames=["ChickenBrownTailBlack","ChickenNakedTailBlack","ChickenNakedTailGrey","ChickenWhiteTailBlack","ChickenWhiteTailWhite","ChickenBlackTailBlack"],this.playerAssets=[],this.chickensLoaded=!1,this.onChickensLoadCbs=[]}async init(){let t=await p.assets.main.getGltfObject("chicken.glb");t.scene.traverse(t=>{t instanceof THREE.Mesh&&(t.castShadow=!0)});for(const i of this.textureNames){let e=new THREE.MeshStandardMaterial({name:i,roughness:1,metalness:0}),n=e.clone();n.name=i+"_morphEnabled",n.morphTargets=n.morphNormals=!0;let s=new THREE.MeshBasicMaterial({name:i+"Unlit"}),r=s.clone();r.name=i+"Unlit_morphEnabled",r.morphTargets=n.morphNormals=!0;let a=t.scene.clone(),o=a.getObjectByName("Chicken"),l=a.getObjectByName("ChickenWings_L"),h=a.getObjectByName("ChickenWings_R"),c=a.getObjectByName("ChickenComb");o.material=c.material=n,l.material=h.material=e,a.name=i;let u=t.scene.clone(),d=u.getObjectByName("Chicken"),p=u.getObjectByName("ChickenWings_L"),m=u.getObjectByName("ChickenWings_R"),f=u.getObjectByName("ChickenComb");d.material=f.material=r,p.material=m.material=s,u.name=i+"Unlit";let g=new THREE.Object3D;g.name="slicedChicken";let y=new THREE.Object3D;y.name="slicedChickenUnlit";let v=new THREE.Object3D;v.name="slicedChickenVertical";let b=new THREE.Object3D;b.name="slicedChickenVerticalUnlit",this.playerAssets.push({material:e,morphMaterial:n,materialUnlit:s,morphMaterialUnlit:r,obj:a,objUnlit:u,slicedObj:g,slicedObjUnlit:y,slicedObjVertical:v,slicedObjVerticalUnlit:b})}await p.assets.waitForAccurateQuality();let e=p.assets.bestMainIsHQ;await this.loadTextures(),this.chickensLoaded=!0;for(const i of this.onChickensLoadCbs)i();this.onChickensLoadCbs=[],e||(await p.assets.waitForHQLoad(),this.loadTextures()),this.loadSliced(),this.loadSlicedVertical()}async loadTextures(){for(let t=0;t<this.textureNames.length;t++){let e=this.textureNames[t],i=this.playerAssets[t],n=await p.assets.bestMain.getTexture(`chicken/textures/${e}.png`);n.flipY=!1,n.needsUpdate=!0;let s=i.material.map,r=i.morphMaterial.map;i.material.map=null,i.morphMaterial.map=null,s&&s.dispose(),r&&r.dispose(),i.material.map=i.morphMaterial.map=i.materialUnlit.map=i.morphMaterialUnlit.map=n,i.material.needsUpdate=i.morphMaterial.needsUpdate=i.materialUnlit.needsUpdate=i.morphMaterialUnlit.needsUpdate=!0}}async loadSliced(){let t=await p.assets.getPackage("themeSaws").getGltfObject("slicedChicken.glb");t.scene.name="slicedChicken",t.scene.traverse(t=>{t instanceof THREE.Mesh&&(t.castShadow=!0)});for(const e of this.playerAssets){let i=t.scene.clone();for(const t of["SliceSkinBottom.001_0","SliceSkinTop.001_0"]){i.getObjectByName(t).material=e.morphMaterial}i.getObjectByName("ChickenComb").material=e.material,e.slicedObj.add(i)}}async loadSlicedVertical(){let t=await p.assets.getPackage("themeKnives").getGltfObject("slicedChickenVertical.glb");t.scene.name="slicedChickenVertical",t.scene.traverse(t=>{t instanceof THREE.Mesh&&(t.castShadow=!0)});for(const e of this.playerAssets){let i=t.scene.clone();for(const t of["Plane.004_0","Plane.001_0","ChickenComb"]){i.getObjectByName(t).material=e.morphMaterial}for(const t of["ChickenWings_L","ChickenWings_R"]){i.getObjectByName(t).material=e.morphMaterial}e.slicedObjVertical.add(i)}}async waitForCacheLoad(){if(!this.chickensLoaded)return await new Promise(t=>{this.onChickensLoadCbs.push(t)})}async getRandomChicken(){return await this.waitForCacheLoad(),Zt.randFromArray(this.playerAssets)}}class B{constructor(){this.myPlayerStats=[]}getNewStatId(){let t=0;for(;;){if(!this.myPlayerStats[t])return this.myPlayerStats[t]=new H(t),t;t++}}getStatFromId(t){return this.myPlayerStats[t]||null}sendAllStats(){for(const t of this.myPlayerStats)t.sendPlayerName(),t.sendPlayerHat()}removeStat(t){this.myPlayerStats[t].destructor(),this.myPlayerStats.splice(t,1)}scoreFromServer(t,e,i){let n=this.getStatFromId(t);n&&n.scoreFromServer(e,i)}}class H{constructor(t){this.id=t,this.name=null,this.score=0,this.rank=-1,this.didOffsetScoreThisRound=!1,this.numberOne=!1,this.rank01Offline=0,this.numberOneOffline=!1,this.selectedHatId=-1,this.onHatChangeCbs=[]}destructor(){this.onHatChangeCbs=[]}setName(t){this.name=t,this.sendPlayerName()}sendPlayerName(){p.network.sendPlayerName(this.id,this.name)}addScore(t){this.didOffsetScoreThisRound||(this.didOffsetScoreThisRound=!0,this.score+=t)}scoreFromServer(t,e){this.rank=t,this.score=e}getColor(){return p.colors.bgColors[this.id]}setHat(t){this.selectedHatId=t;for(const e of this.onHatChangeCbs)e(t);this.sendPlayerHat()}sendPlayerHat(){p.network.sendPlayerHat(this.id,this.selectedHatId)}onHatChange(t){this.onHatChangeCbs.push(t)}removeOnHatChange(t){let e=this.onHatChangeCbs.indexOf(t);e>=0&&this.onHatChangeCbs.splice(e,1)}roundStarts(){this.didOffsetScoreThisRound=!1}}class N{constructor(t,e=new THREE.Vector3,i=1){p.game.scene.attach(t),this.obj=t,this.destroyNextFrame=!1,this.startTime=p.now,this.velocity=e,"number"==typeof i?(this.angularVelocity=new THREE.Vector3(Math.random(),Math.random(),Math.random()),this.angularVelocity.setLength(i)):this.angularVelocity=i}destructor(){this.obj.parent.remove(this.obj),this.velocity=null,this.angularVelocity=null}loop(t,e){if(this.velocity.y-=3e-5*e,this.obj.position.addScaledVector(this.velocity,e),this.angularVelocity.length()>0){let t=new THREE.Quaternion;t.setFromAxisAngle(this.angularVelocity,this.angularVelocity.length()*e),t.normalize(),this.obj.quaternion.multiply(t)}t-this.startTime>5e3&&(this.destroyNextFrame=!0)}}class F{constructor(){this.inputPlayers=[],this.botInputPlayers=[],this.gamepadInputPlayers=[],this.currentSideInputs=[],this.defaultMovementKeys=[["KeyA","KeyD","KeyW","KeyS",65,68,87,83],["ArrowLeft","ArrowRight","ArrowUp","ArrowDown",37,39,38,40],["KeyJ","KeyL","KeyI","KeyK",74,76,73,75],["Numpad4","Numpad6","Numpad8","Numpad5",100,102,104,101]],this.defaultJumpKeys=[["Space",32],["KeyM",77],["BracketLeft",219],["Numpad0",96]],this.onDownAnyCbs=[],this.onJumpAnyControllableCbs=[],this.keyboardLayouts=new U,this.touch=new W,window.addEventListener("gamepadconnected",t=>{let e=t.gamepad.index,i=new V({gamepadIndex:e});this.gamepadInputPlayers.push(i),p.localPlayerManager.gamepadConnected(i)}),window.addEventListener("gamepaddisconnected",t=>{let e=t.gamepad.index,i=this.gamepadInputPlayers.find(t=>t.gamepadIndex==e);this.removeInputPlayer(i),p.localPlayerManager.gamepadDisconnected(i)}),window.addEventListener("blur",t=>{for(const e of this.getAllInputPlayers())e.resetInputs()})}init(){window.addEventListener("keydown",t=>{this.setKeyPressed(t,!0)}),window.addEventListener("keyup",t=>{this.setKeyPressed(t,!1)}),this.keyboardLayouts.init(),this.touch.init()}get hasGamepad(){return this.gamepadInputPlayers.length>0}requestInputPlayer(){let t=null;for(const n of this.defaultMovementKeys){if(!this.keySetContainsExistingKey(n)){t=n;break}}t||(t=["","","","",0,0,0,0]);let e=["",0];for(const n of this.defaultJumpKeys){if(!this.keySetContainsExistingKey(n)){e=n;break}}let i=new V({keys:{left:t[0],right:t[1],up:t[2],down:t[3],leftKeyCode:t[4],rightKeyCode:t[5],upKeyCode:t[6],downKeyCode:t[7],jump:e[0],jumpKeyCode:e[1]}});return this.inputPlayers.push(i),i}keySetContainsExistingKey(t){for(const e of this.inputPlayers)if(t.indexOf(e.keys.left)>=0||t.indexOf(e.keys.right)>=0||t.indexOf(e.keys.up)>=0||t.indexOf(e.keys.down)>=0||t.indexOf(e.keys.jump)>=0||t.indexOf(e.keys.leftKeyCode)>=0||t.indexOf(e.keys.rightKeyCode)>=0||t.indexOf(e.keys.upKeyCode)>=0||t.indexOf(e.keys.downKeyCode)>=0||t.indexOf(e.keys.jumpkeyCode)>=0)return!0;return!1}removeInputPlayer(t){t.destructor();let e=this.inputPlayers.indexOf(t);e>=0&&this.inputPlayers.splice(e,1);let i=this.botInputPlayers.indexOf(t);i>=0&&this.botInputPlayers.splice(i,1);let n=this.currentSideInputs.indexOf(t);n>=0&&this.currentSideInputs.splice(n,1);let s=this.gamepadInputPlayers.indexOf(t);s>=0&&this.gamepadInputPlayers.splice(s,1)}requestSideInputPlayer(){let t=this.requestInputPlayer();return this.currentSideInputs.push(t),t}clearSideInputs(){for(const t of this.currentSideInputs)this.removeInputPlayer(t)}clearSideInputWithKey(t){for(const e of this.currentSideInputs)e.containsKey(t)&&this.removeInputPlayer(e)}requestAvailableGamepadInput(){for(const t of this.gamepadInputPlayers)if(!t.linkedLocalPlayer)return t;return null}*getAllInputPlayers(){for(const t of this.inputPlayers)yield t;for(const t of this.botInputPlayers)yield t;for(const t of this.gamepadInputPlayers)yield t;yield this.touch.inputPlayer}loop(){for(const t of this.getAllInputPlayers())t.loop();this.touch.loop()}setKeyPressed(t,e){if("INPUT"!=document.activeElement.tagName&&!p.mainMenu.visible)for(const i of this.inputPlayers)i.keyboardEvent(t,e)}createBot(t){let e=new j({botDifficulty:t});return this.botInputPlayers.push(e),e}onJumpAnyControllable(t){this.onJumpAnyControllableCbs.push(t)}onDownAny(t){this.onDownAnyCbs.push(t)}fireDownAny(){for(const e of this.onDownAnyCbs)e();let t=!1;for(const e of this.getAllInputPlayers())if(!(e instanceof j)&&e.jumpPressed){t=!0;break}if(t)for(const e of this.onJumpAnyControllableCbs)e()}}class V{constructor(t){t=t||{},this.keys=t.keys||{},this.gamepadIndex=void 0===t.gamepadIndex?-1:t.gamepadIndex,this.prevGamepadJoystickActive=!1,this._controlsDisabled=!1,this.resetInputs(),this.lastInputTime=0,this.linkedLocalPlayer=null,this.lastPressedKey=null,this.lastPressedKeyWasDown=!1,this.lastDoublePressToggleTime=0,this.sprintPressedTimeout=new Kt(t=>{this.sprintPressed=!0},100)}get isAfk(){return this.lastInputTime+18e4<p.now}resetInputs(){this.leftPressed=!1,this.rightPressed=!1,this.upPressed=!1,this.downPressed=!1,this.jumpPressed=!1,this.flyDownPressed=!1,this.sprintPressed=!1,this.currentInputDirection2D=new THREE.Vector2,this.currentInputDirection=new THREE.Vector3,this.customInputDirection2D=new THREE.Vector2,this.customInputDirection3D=new THREE.Vector3,this.lookInputDirection=new THREE.Vector2}get controlsDisabled(){return this._controlsDisabled}set controlsDisabled(t){this._controlsDisabled=t,t&&this.resetInputs()}destructor(){this.linkedLocalPlayer&&(this.linkedLocalPlayer.removeInputPlayer(this),this.linkedLocalPlayer=null),this.resetInputs(),this.keys=null,this.sprintPressedTimeout.destructor(),this.sprintPressedTimeout=null}loop(){if(this.gamepadIndex>-1){let t=navigator.getGamepads()[this.gamepadIndex];if(t){let e=!1;e=this.setGamepadAxis(t,this.customInputDirection2D,0,1)||e,e=this.setGamepadAxis(t,this.lookInputDirection,2,3)||e,this.lookInputDirection.y*=-1,this.prevGamepadJoystickActive!=e&&(this.prevGamepadJoystickActive=e,this.onDownAny());let i=t.buttons.length>0&&t.buttons[0].pressed;this.jumpPressed!=i&&this.setJumpPressed(i);let n=t.buttons.length>10&&t.buttons[10].pressed;this.sprintPressed!=n&&this.setSprintPressed(n);let s=t.buttons.length>1&&t.buttons[1].pressed;this.flyDownPressed!=s&&this.setFlyDownPressed(s)}else this.customInputDirection2D=new THREE.Vector2;this.updateInputDirection()}}setGamepadAxis(t,e,i,n,s=.05){return e.set(t.axes[i],-t.axes[n]),e.length()<s&&e.set(0,0),e.length()>.5}keyboardEvent(t,e){t.code,t.code||t.keyCode;if(!this.keys||this.controlsDisabled)return;let i=null;this.testKeyPressed(t,this.keys.left,this.keys.leftKeyCode)&&this.leftPressed!=e&&(this.leftPressed=e,i="left"),this.testKeyPressed(t,this.keys.right,this.keys.rightKeyCode)&&this.rightPressed!=e&&(this.rightPressed=e,i="right"),this.testKeyPressed(t,this.keys.up,this.keys.upKeyCode)&&this.upPressed!=e&&(this.upPressed=e,i="up"),this.testKeyPressed(t,this.keys.down,this.keys.downKeyCode)&&this.downPressed!=e&&(this.downPressed=e,i="down"),this.testKeyPressed(t,this.keys.jump,this.keys.jumpKeyCode)&&this.jumpPressed!=e&&(this.jumpPressed=e,i="jump"),e&&i&&this.onDownAny(),i&&"jump"!=i&&i==this.lastPressedKey&&e!=this.lastPressedKeyWasDown?(!(p.now-this.lastDoublePressToggleTime<100&&e)||("left"!=i||this.rightPressed||this.upPressed||this.downPressed)&&("right"!=i||this.leftPressed||this.upPressed||this.downPressed)&&("up"!=i||this.leftPressed||this.rightPressed||this.downPressed)&&("down"!=i||this.leftPressed||this.rightPressed||this.upPressed)?(this.sprintPressedTimeout.stop(),this.sprintPressed=!1):this.sprintPressedTimeout.start(),this.lastDoublePressToggleTime=p.now):this.sprintPressed=!1,i&&(this.lastPressedKey=i),this.lastPressedKeyWasDown=e,this.updateInputDirection()}testKeyPressed(t,e,i){let n=t.code,s=n?null:t.keyCode;return n&&n==e||s&&s==i}updateInputDirection(){let t=new THREE.Vector2;this.rightPressed&&(t.x+=1),this.leftPressed&&(t.x-=1),this.upPressed&&(t.y+=1),this.downPressed&&(t.y-=1),t.add(this.customInputDirection2D),this.currentInputDirection2D=t,this.currentInputDirection=p.cam.getInputDirection(t),this.currentInputDirection.add(this.customInputDirection3D),this.currentInputDirection.clampLength(0,1)}onDownAny(){document.hasFocus()&&this.linkedLocalPlayer&&this.linkedLocalPlayer.activate(),this.lastInputTime=p.now,p.input.fireDownAny()}setJumpPressed(t){this.jumpPressed=t,t&&this.onDownAny()}setFlyDownPressed(t){this.flyDownPressed=t,t&&this.onDownAny()}setSprintPressed(t){this.sprintPressed=t,t&&this.onDownAny()}hapticPulse(t,e,i){if(this.gamepadIndex>-1){let n=navigator.getGamepads()[this.gamepadIndex];n&&(n.vibrationActuator?n.vibrationActuator.playEffect(n.vibrationActuator.type,{duration:t,strongMagnitude:e,weakMagnitude:i}):n.hapticActuators)}}remapKey(t,e){this.keys[t]=e}containsKey(t){return[this.keys.left,this.keys.right,this.keys.up,this.keys.down].includes(t)}onActivationFailed(){}deactivate(){}}class j extends V{constructor(t){super(t=t||{}),this.botDifficulty=void 0===t.botDifficulty?.4:t.botDifficulty,this.set3dDirections=[],this.isBeingDumb=!1,this.currentBotState=j.BotState.NORMAL,this.nextDirectionChangeTime=0,this.nextJumpTime=0,this.nextBotStateChangeTime=0,this.followingPlayer=null,this.maxFollowStateDistance=10,this.setNextJumpTime()}get linkedPlayer(){return this.linkedLocalPlayer?this.linkedLocalPlayer.linkedPlayer:null}static get BotState(){return{NORMAL:0,FOLLOWING_PLAYER:1,IDLE:2,STATE_MAX:3}}loop(){if(super.loop(),!this.linkedPlayer)return;let t=this.linkedPlayer;for(let e=this.set3dDirections.length-1;e>=0;e--){let t=this.set3dDirections[e];p.now>t.setIn&&(this.customInputDirection3D=t.dir,this.set3dDirections.splice(e,1))}if(p.now-this.nextBotStateChangeTime>0&&(this.pickNewState(),this.setNextStateChangeTime(),this.currentBotState==j.BotState.FOLLOWING_PLAYER&&this.findFollowingPlayer(t)),this.isBeingDumb){if(t&&t.lastTouchedDisk&&!t.lastTouchedDisk.destructed){let e=t.lastTouchedDisk.getSafestPos(t.pos),i=t.pos.sub(e);this.customInputDirection3D=i}}else if(this.currentBotState==j.BotState.NORMAL){if(this.jumpPressed)this.setJumpPressed(!1);else if(p.now-this.nextDirectionChangeTime>0){if(t&&Math.random()>1-this.botDifficulty)if(t.lastTouchedDisk&&!t.lastTouchedDisk.destructed){let e,i=(e=t.lastTouchedDisk==p.game.lobbyBalancingObject?t.lastTouchedDisk.getRandomPosOnSquare():t.lastTouchedDisk.getSafestPos(t.pos)).sub(t.pos);Math.random()>5-this.botDifficulty-i.length()?this.set3dDirectionAfterMs(i.x,0,i.z):this.set3dDirectionAfterMs()}else this.set3dDirectionAfterMs();else Math.random()>.6?this.set3dDirectionAfterMs(5*(Math.random()-.5),0,5*(Math.random()-.5)):this.set3dDirectionAfterMs();this.setNextDirChangeTime()}p.now-this.nextJumpTime>0&&(this.setJumpPressed(!0),this.setNextDirChangeTime(),this.setNextJumpTime())}else if(this.currentBotState==j.BotState.FOLLOWING_PLAYER){let e=this.followingPlayer.pos.sub(t.pos);e.length()<this.maxFollowStateDistance?this.set3dDirectionAfterMs(e.x,0,e.z):this.findFollowingPlayer(t)}this.updateInputDirection()}findFollowingPlayer(t){if(this.followingPlayer=this.getClosestPlayer(t),this.followingPlayer){this.followingPlayer.pos.distanceTo(t.pos)>=this.maxFollowStateDistance&&(this.followingPlayer=null)}this.followingPlayer||(this.currentBotState=j.BotState.NORMAL)}getClosestPlayer(t=null){t||(t=this.linkedPlayer);let e=null,i=1/0;for(const n of p.game.players){if(n==this.linkedPlayer)continue;let t=n.pos.distanceTo(this.linkedPlayer.pos);t<i&&(i=t,e=n)}return e}set3dDirectionAfterMs(t,e,i){let n=400*(1-this.botDifficulty);n<1?this.customInputDirection3D=new THREE.Vector3(t,e,i):this.set3dDirections.push({dir:new THREE.Vector3(t,e,i),setIn:p.now+n})}setNextDirChangeTime(){let t=Zt.randRange(100,500)*(1-this.botDifficulty);this.nextDirectionChangeTime=p.now+t}pickNewState(){let t=1,e=1,i=1;p.game.gameStateManager.currentState==ft.GameState.STARTED?(t=this.botDifficulty,e=.6*this.botDifficulty,i=Math.pow(1-this.botDifficulty,4)):(t=.7,e=.05,i=1);let n=t+e+i,s=Math.random()*n;this.currentBotState=s<t?j.BotState.NORMAL:s<t+e?j.BotState.FOLLOWING_PLAYER:j.BotState.IDLE}setNextStateChangeTime(){let t=Zt.randRange(5e3,1e4);this.nextBotStateChangeTime=p.now+t}setNextJumpTime(){let t=Zt.randRange(4e3,15e3);t*=this.botDifficulty+1,this.nextJumpTime=p.now+t}onActivationFailed(){super.onActivationFailed(),this.deactivate()}deactivate(){super.deactivate(),p.localPlayerManager.removeBot(this.linkedLocalPlayer)}}class G extends V{constructor(){super()}updateJoyStick(t){t.length()>0&&this.onDownAny(),this.customInputDirection2D=t.clone(),this.customInputDirection2D.y*=-1,this.updateInputDirection()}}class U{constructor(){window.addEventListener("keydown",t=>{this.keyEvent(t)}),this.onLoadFirstRegisteredKeysCbs=[],this.registeredKeysLoaded=!1,this.registeredKeys={},this.onLayoutInfoChangeCbs=[]}init(){this.loadRegisteredKeys()}async loadRegisteredKeys(){let t=await zt.get("registeredKeys");this.registeredKeys=t||{};for(const e of this.onLoadFirstRegisteredKeysCbs)e();this.registeredKeysLoaded=!0,this.onLoadFirstRegisteredKeysCbs=[]}async waitForFirstRegisteredKeysLoad(){if(!this.registeredKeysLoaded)return await new Promise(t=>{this.onLoadFirstRegisteredKeysCbs.push(t)})}async saveRegisteredKeys(){await this.waitForFirstRegisteredKeysLoad(),zt.set("registeredKeys",this.registeredKeys)}keyEvent(t){if("Dead"==t.key)return;let e=this.registeredKeys[t.code],i=null;e&&(i=e.key);let n=t.key;if(i==n)return;let s=t.shiftKey||t.ctrlKey||t.altKey||t.metaKey;if(e&&!e.hasModifierKey&&s)return;let r=!0;e?i&&i.toUpperCase()==n.toUpperCase()?r=!1:e.hasModifierKey&&!s&&(r=!1):r=!1,r&&(this.registeredKeys=[]),this.registeredKeys[t.code]={key:n,hasModifierKey:s};for(const a of this.onLayoutInfoChangeCbs)a();this.saveRegisteredKeys()}getKey(t){return this.registeredKeys[t]?this.registeredKeys[t].key:null}getVisualKeyForCode(t){let e=this.getKey(t);return e||(e=t),"number"==typeof e&&(e=e.toString()),e.startsWith("Key")&&(e=e.slice(3)),e.startsWith("Digit")&&(e=e.slice(5)),e.startsWith("Numpad")&&(e=e.slice(6)),"ArrowLeft"==e&&(e=""),"ArrowRight"==e&&(e=""),"ArrowDown"==e&&(e=""),"ArrowUp"==e&&(e="")," "==e&&(e="Space"),1==e.length&&(e=e.toUpperCase()),e}onLayoutInfoChange(t){this.onLayoutInfoChangeCbs.push(t)}removeOnLayoutInfoChange(t){let e=this.onLayoutInfoChangeCbs.indexOf(t);e>=0&&this.onLayoutInfoChangeCbs.splice(e,1)}}class z{constructor(t=null){this.el=document.createElement("div"),document.body.appendChild(this.el),this.visible=!0,this.currentUsingTouchId=null,this.didUpdateTouchLastLoop=!1,this.responsiveArea=t}updateTouch(t){if(this.responsiveArea&&(null==this.currentUsingTouchId||this.responsiveArea.cancelWhenLeaving)&&!this.responsiveArea.testTouchInResponsiveArea(t))return!1;let e=this.onUpdateTouch(t);return e&&(this.currentUsingTouchId=t.identifier,this.didUpdateTouchLastLoop=!0),e}onUpdateTouch(t){return!1}endTouchLoop(){this.didUpdateTouchLastLoop||(this.currentUsingTouchId=null,this.onEndTouch()),this.didUpdateTouchLastLoop=!1}onEndTouch(){}setVisibility(t){this.visible=t,this.el.style.display=t?null:"none"}}class W{constructor(){this.joyStick=new oe({responsiveArea:new ce(0,.65,0,1)}),this.jumpButton=new ae({right:80,bottom:20}),this.joyStickSpectate=new oe({responsiveArea:new he(null,170)}),this.lastDeltaLook=new THREE.Vector2,this.spectateLook=new le,this.upButton=new ae({right:80,bottom:100,responsiveArea:new he(null,50,!0)}),this.downButton=new ae({right:80,bottom:20,responsiveArea:new he(null,50,!0)}),this.touchElements=[this.joyStick,this.jumpButton,this.upButton,this.downButton,this.joyStickSpectate,this.spectateLook],this.normalElements=[this.joyStick,this.jumpButton],this.spectateElements=[this.joyStickSpectate,this.spectateLook,this.upButton,this.downButton],this.touchListener=document.createElement("div"),this.touchListener.classList.add("touchListener","fullScreen"),document.body.appendChild(this.touchListener),this.touchListener.addEventListener("touchstart",t=>{this.updateTouches(t)},{passive:!1}),this.touchListener.addEventListener("touchmove",t=>{this.updateTouches(t)},{passive:!1}),this.touchListener.addEventListener("touchend",t=>{this.updateTouches(t)},{passive:!1}),this.inputPlayer=new G,qt.addListener(t=>{this.onResize()}),this.onResize()}init(){this.setVisibility()}onResize(){let t=new THREE.Vector2(100,window.innerHeight-70);this.joyStick.setDefaultPos(t),this.joyStickSpectate.setDefaultPos(t)}*visibileTouchElements(){for(const t of this.touchElements)t.visible&&(yield t)}updateTouches(t){t.cancelable&&t.preventDefault();for(const i of t.touches){let t=!1;for(const e of this.visibileTouchElements())if(e.currentUsingTouchId==i.identifier&&e.updateTouch(i)){t=!0;break}if(!t)for(const e of this.visibileTouchElements())if(e.updateTouch(i))break}for(const i of this.touchElements)i.endTouchLoop();let e=this.joyStick.currentValue.clone();e.add(this.joyStickSpectate.currentValue),this.inputPlayer.updateJoyStick(e),this.inputPlayer.setJumpPressed(this.jumpButton.pressed||this.upButton.pressed),this.inputPlayer.setFlyDownPressed(this.downButton.pressed),this.inputPlayer.setSprintPressed(this.joyStick.doubleTapped),this.lastDeltaLook.add(this.spectateLook.lastDeltaPos)}loop(){this.lastDeltaLook.multiplyScalar(.1),this.inputPlayer.lookInputDirection.copy(this.lastDeltaLook),this.lastDeltaLook.set(0,0)}get touchSupported(){return"ontouchstart"in window}setVisibility(){let t=!1,e=!1;this.touchSupported&&!p.mainMenu.visible&&(p.game.getCanControlCamera()?e=!0:t=!0);for(const i of this.normalElements)i.setVisibility(t);for(const i of this.spectateElements)i.setVisibility(e)}}class q{constructor(t=!1){this.cancelWhenLeaving=t}testTouchInResponsiveArea(t){return!1}}class Y{constructor(){this.serverManager=new K,this.pingManager=new J,this.connectedServer=null,this.ws=null,this.isOfflineGame=!1,this.connectionOpenedAndDataSent=!1,this.onConnectionOpenCbs=[],window.sendCommand=(t=>{this.sendCommand(t)}),this.documentVisible=!0,document.addEventListener("visibilitychange",t=>{this.visibilityChange(!document.hidden)}),this.badConnectionIcon=new at("badConnection.svg"),this.noConnectionIcon=new at("noConnection.svg"),this.lastServerMessageTime=0,this.hasBadConnection=!1,this.lastGameOverStatsPlace=-1}static get ReceiveAction(){return{UPDATE_PLAYER_POSITIONS:0,MY_PLAYER_ID:1,PLAYERS_DISCONNECT:2,PLAYER_CONTROLS_DATA:3,DISALLOW_PLAYER_SPAWN:4,GAME_STATE_CHANGE:5,GAME_START_TIME_DELTA:6,PLAYER_LAUNCH_START_POS:7,HIT_OTHER_PLAYER:8,PLAYER_WON_TITLE:9,SCOREBOARD:10,SET_PLAYER_HAT:11,SET_PLAYER_HAS_CROWN:12,LOG_MESSAGE:14,SPAWN_POTION:15,PLAYER_TOUCH_POTION:16,PLAYER_APPLY_POTION:17,CURRENT_GAME_STAGE:18,MY_PLAYER_SCORES:19,VERSION_OUT_OF_DATE:20,ALLOW_TEMPORARY_PLAYER_INPUT:21,REQUEST_BOT_SPAWN:22,SET_PLAYER_SERVER_MASS:23,GAME_OVER_SCORE_STATS:24,CORN_SEED_SPAWN_TYPE:25,SPAWN_CORN_SEED:26,PONG:27,JOINED_GAME_ID:28,MY_ACCOUNT_DATA:29,SIGNED_IN_SOMEWHERE_ELSE:30,MY_USER_ID:31,REQUEST_DEBUG_STATS:32}}static get SendAction(){return{CONNECT_NEW_PLAYER:0,PLAYER_DATA:1,PLAYER_DIED:2,PLAYER_CONTROLS_DATA:3,PLAYER_LAUNCH_START_POS:4,HIT_OTHER_PLAYER:5,PLAYER_NAME:6,PLAYER_HAT:7,COMMAND:9,PLAYER_TOUCH_POTION:10,REPORT_CHEATING_PLAYER:11,VISIBILITY_CHANGE:12,MY_CLIENT_VERSION:13,PLAYER_ATE_CORN_SEED:14,MAIN_MENU_VISIBLE_CHANGE:15,PING:16,REQUEST_JOIN_GAME_ID:17,MY_ACCOUNT_DATA:18,DEBUG_STATS:19}}static get PlayerControlsType(){return{JUMP:0,CANCEL_DASH_CHARGE:1,SLICED:2,SLICED_VERTICAL:3}}static ceilBytesLength(t){return 4*Math.ceil(t/4)}static get MinusOne(){return new Uint32Array([-1])[0]}init(){this.serverManager.init(),this.badConnectionIcon.init(),this.noConnectionIcon.init(),this.connect()}async connect(){let t="",e=Zt.parseHash();if(e.ip)t=e.ip;else if("live"==n.ENVIRONMENT){let e=await this.serverManager.getBestServer();this.connectedServer=e,t=e.ip4}else t="local"==n.ENVIRONMENT?"ws://"+window.location.hostname+":8000":"wss://ws."+window.location.hostname;try{this.ws=new WebSocket(t)}catch(t){console.error("failed to connect to websocket",t),this.onClose()}if(this.ws){this.ws.binaryType="arraybuffer";let t=this;this.ws.onmessage=function(e){t.onMessage(new Uint8Array(e.data),this)},this.ws.onclose=function(e){t.onClose(e,this)},this.ws.onopen=function(e){t.onOpen(e,this)},this.ws.onerror=function(e){t.onError(e,this)}}}onMessage(t,e){if(e!=this.ws)return;this.lastServerMessageTime=p.now;let i=t.buffer,n=new Float32Array(i),s=new Uint32Array(i),r=new Int32Array(i);if(s[0]==Y.ReceiveAction.MY_PLAYER_ID){let t=s[1],e=s[2];e==Y.MinusOne&&(e=-1),this.onRecvMyPlayerId(t,e)}else if(s[0]==Y.ReceiveAction.UPDATE_PLAYER_POSITIONS){let t=4;for(;t<=i.byteLength-16;){let e=new Uint8Array(i,t,16),n=new Uint8Array(16);n.set(e);let s=new Uint16Array(n.buffer);t+=16;let r=s[0],a=n[2],o=n[3],l=Zt.mapValue(0,65535,-200,200,s[2],!0),h=Zt.mapValue(0,65535,-200,200,s[3],!0),c=Zt.mapValue(0,65535,-200,200,s[4],!0),u=Zt.mapValue(0,255,-1,1,n[10],!0),d=Zt.mapValue(0,255,-1,1,n[11],!0),m=Zt.mapValue(0,255,-1,1,n[12],!0),f=Zt.mapValue(0,255,-1,1,n[13],!0),g=Zt.mapValue(0,255,-1,1,n[14],!0),y=Zt.mapValue(0,255,-Math.PI,Math.PI,n[15],!0);p.game.setPlayerPosition(r,a,l,h,c,u,d,m,f,g,y,o)}}else if(s[0]==Y.ReceiveAction.PLAYERS_DISCONNECT){let t=1,e=s[t++];for(;t<s.length;)p.game.playerLeft(s[t++],e)}else if(s[0]==Y.ReceiveAction.PLAYER_CONTROLS_DATA){let t=s[1],e=s[2];p.game.handlePlayerControlsData(t,e,i)}else if(s[0]==Y.ReceiveAction.DISALLOW_PLAYER_SPAWN)p.localPlayerManager.onPlayerCreationFailed();else if(s[0]==Y.ReceiveAction.GAME_STATE_CHANGE)this.onRecvGameState(s[1]);else if(s[0]==Y.ReceiveAction.GAME_START_TIME_DELTA)this.onRecvDeltaStartTime(r[1]);else if(s[0]==Y.ReceiveAction.PLAYER_LAUNCH_START_POS)p.game.setPlayerLaunchStartPos(s[1],n[2],n[3]);else if(s[0]==Y.ReceiveAction.HIT_OTHER_PLAYER){let t=s[1],e=s[2],i=new THREE.Vector3;i.fromArray(n,3);let r=new THREE.Vector3;r.fromArray(n,6),p.game.playerHitOtherPlayerFromServer(t,e,i,r)}else if(s[0]==Y.ReceiveAction.PLAYER_WON_TITLE){let t=s[1],e=s[2],n=new Uint8Array(i,12,e),r=(new TextDecoder).decode(n);p.winnerScreen.startWinAnimation(t,r),p.mainMenu.visible||(1==this.lastGameOverStatsPlace&&p.game.didHaveControllablePlayerThisGame?p.poki.happyTime(1):p.poki.happyTime(.25))}else if(s[0]==Y.ReceiveAction.SCOREBOARD){let t=[],e=new TextDecoder,n=1;for(;n<s.length;){let r=s[n++],a=s[n++],o=new Uint8Array(i,4*n,a);n+=Math.ceil(a/4);let l=e.decode(o);t.push({name:l,score:r})}p.leaderboard.leaderboardDataFromServer(t)}else if(s[0]==Y.ReceiveAction.SET_PLAYER_HAT)p.game.setPlayerHatFromServer(s[1],s[2]);else if(s[0]==Y.ReceiveAction.SET_PLAYER_HAS_CROWN){let t=s[1],e=!!s[2];p.game.setPlayerHasCrownFromServer(t,e)}else if(s[0]==Y.ReceiveAction.LOG_MESSAGE){let t=this.parseStringMessage(s,i),e=null;try{e=JSON.parse(t)}catch(t){}e?console.log(e):console.log(t)}else if(s[0]==Y.ReceiveAction.SPAWN_POTION){let t=s[1],e=s[2],i=n[3],r=n[4],a=n[5],o=n[6],l=n[7];p.game.spawnPotion(t,e,i,r,a,o,l)}else if(s[0]==Y.ReceiveAction.PLAYER_TOUCH_POTION){let t=s[1],e=s[2];p.game.removePotion(t,e)}else if(s[0]==Y.ReceiveAction.PLAYER_APPLY_POTION){let t=s[1],e=s[2],i=s[3];p.game.playerApplyPotion(t,e,i)}else if(s[0]==Y.ReceiveAction.CURRENT_GAME_STAGE){let t=s[1];this.onRecvGameStage(t)}else if(s[0]==Y.ReceiveAction.MY_PLAYER_SCORES){let t=1,e=0;for(;t<s.length;){let i=s[t++],n=s[t++];p.playerStats.scoreFromServer(e,i,n),e++}p.leaderboard.updateLeaderboard()}else if(s[0]==Y.ReceiveAction.VERSION_OUT_OF_DATE)p.mainMenu.showServerVersionMismatch();else if(s[0]==Y.ReceiveAction.ALLOW_TEMPORARY_PLAYER_INPUT){let t=s[1],e=!!s[2];p.game.allowTemporaryPlayerInput(t,e)}else if(s[0]==Y.ReceiveAction.REQUEST_BOT_SPAWN)this.onRecvRequestBotSpawn();else if(s[0]==Y.ReceiveAction.SET_PLAYER_SERVER_MASS){let t=s[1],e=n[2];p.game.setPlayerServerMass(t,e)}else if(s[0]==Y.ReceiveAction.GAME_OVER_SCORE_STATS){let t=s[1],e=s[2];this.lastGameOverStatsPlace=e;let i=r[3],n=s[4],a=s[5];p.cornerStats.setPlayerPlace(t,e,i),p.gameOverScreen.setData({wonThisRound:1==e,rankThisRound:e,scoreThisRound:i,timeAliveSeconds:p.game.serverTime/1e3,winCount:n,winStreak:a})}else if(s[0]==Y.ReceiveAction.SPAWN_CORN_SEED)this.onRecvSpawnCornSeed(!!s[1]);else if(s[0]==Y.ReceiveAction.PONG){let t=s[1];this.pingManager.onGetPong(t)}else if(s[0]==Y.ReceiveAction.JOINED_GAME_ID){let t=s[1];this.serverManager.joinedGameId(t,this.connectedServer)}else if(s[0]==Y.ReceiveAction.MY_ACCOUNT_DATA){let t=this.parseJsonMessage(s,i);p.accounts.accountDataFromServer(t)}else if(s[0]==Y.ReceiveAction.SIGNED_IN_SOMEWHERE_ELSE)p.accounts.showLoggedInElsewhere();else if(s[0]==Y.ReceiveAction.MY_USER_ID){let t=this.parseStringMessage(s,i);p.accounts.userIdChange(t)}else if(s[0]==Y.ReceiveAction.REQUEST_DEBUG_STATS){let t={};t.avgPing=this.pingManager.avgPing,t.versionTimestamp=VERSION_TIMESTAMP,t.smoothDt=p.smoothDt,t.playerStats=[];for(const e of p.game.getMyPlayers()){let i=p.now-e.lastHitStageObjectTime,n=e.lastHitStageObjectClosestDist,s=e.lastHitStageObjectClosestIntervalDist;t.playerStats.push({lastTestHitStageObjectAgo:i,lastHitStageObjectClosestDist:n,lastHitStageObjectClosestIntervalDist:s,radius:e.radius,pos:e.pos})}t.knifeObjects=[];for(const e of p.game.stageObjects)if(e instanceof ue){let i=e.getDistanceFromSharpEdge(new THREE.Vector3);t.knifeObjects.push({distFromZero:i,hasKnife:!!e.knife,hasMainKnife:!!e.mainKnife,loadAssetCalled:e.loadAssetCalled,hasObj:!!e.obj})}t.loggedItems=p.loggingManager.loggedItems.slice(-10),this.sendJsonMessage(Y.SendAction.DEBUG_STATS,t)}}parseStringMessage(t,e){let i=t[1],n=new Uint8Array(e,8,i),s=null;try{s=(new TextDecoder).decode(n)}catch(t){}return s}parseJsonMessage(t,e){let i=this.parseStringMessage(t,e);try{return JSON.parse(i)}catch(t){return null}}onClose(t){console.log("connection lost"),this.isOfflineGame=!0,p.game.onBecomesOfflineGame(),this.setBadConnectionIcon()}async waitForConnectionOpen(){if(!this.connectionOpenedAndDataSent)return await new Promise(t=>this.onConnectionOpenCbs.push(t))}async onOpen(t){let e=Zt.parseHash();e.gameId&&this.sendJoinGameId(+e.gameId),this.serverManager.bestGameId>=0&&this.sendJoinGameId(this.serverManager.bestGameId),this.sendCurrentVersion(),p.playerStats.sendAllStats(),await p.accounts.sendCurrentAccountData(!0),this.connectionOpenedAndDataSent=!0;for(const i of this.onConnectionOpenCbs)i()}onError(t){console.error("websocket error: ",t),this.onClose()}loop(t,e){let i=t-this.lastServerMessageTime>500;this.hasBadConnection!=i&&(this.hasBadConnection=i,this.setBadConnectionIcon()),this.pingManager.loop(t,e)}sendPing(t){return this.send([Y.SendAction.PING,t])}setBadConnectionIcon(){this.isOfflineGame&&!p.mainMenu.visible?(this.badConnectionIcon.setVisibility(!1),this.noConnectionIcon.setVisibility(!0)):this.hasBadConnection&&!p.mainMenu.visible?(this.badConnectionIcon.setVisibility(!0),this.noConnectionIcon.setVisibility(!1)):(this.badConnectionIcon.setVisibility(!1),this.noConnectionIcon.setVisibility(!1))}send(t){if(this.ws&&this.ws.readyState==WebSocket.OPEN){t instanceof Array&&(t=new Uint32Array(t));try{return this.ws.send(t),!0}catch(e){throw console.log("error sending message",t),e}}}sendJoinGameId(t){this.send([Y.SendAction.REQUEST_JOIN_GAME_ID,t])}sendCurrentVersion(){"local"!=n.ENVIRONMENT&&"dev"!=n.ENVIRONMENT&&this.sendStringMessage(Y.SendAction.MY_CLIENT_VERSION,VERSION_TIMESTAMP)}sendPlayerData(t){let e=new ArrayBuffer(48),i=new Uint32Array(e,0),n=new Float32Array(e,0);i[0]=Y.SendAction.PLAYER_DATA,i[1]=t.id,n[2]=t.pos.x,n[3]=t.pos.y,n[4]=t.pos.z,n[5]=t.velocity.x,n[6]=t.velocity.y,n[7]=t.velocity.z,n[8]=t.input.x,n[9]=t.input.z,i[10]=t.onDiskId,n[11]=t.rotationAngle,this.send(e)}requestPlayerSpawn(t=-1){this.isOfflineGame?p.offlineServer.requestPlayerSpawn(t):this.send([Y.SendAction.CONNECT_NEW_PLAYER,t])}onRecvMyPlayerId(t,e){let i=p.game.setIsMyPlayer(t);p.localPlayerManager.newUnassignedPlayer(i,e),p.game.doGameStartThings()}onRecvGameState(t){p.game.gameStateManager.setCurrentState(t)}onRecvDeltaStartTime(t){p.game.gameStateManager.setDeltaStartTime(t)}onRecvRequestBotSpawn(){p.game.debugMainGame||p.localPlayerManager.createBot(Zt.randRange(.6,.8))}onRecvSpawnCornSeed(t){p.game.spawnCornSeed(t)}onRecvGameStage(t){p.game.stageManager.setCurrentStage(t)}sendPlayerDied(t){this.isOfflineGame?(p.offlineServer.onPlayerDied(t),p.game.playerLeft(t),p.offlineServer.testCurrentGameState()):this.send([Y.SendAction.PLAYER_DIED,t])}sendPlayerControlsData(t,e,i=[]){let n=(i=i instanceof Array||i instanceof ArrayBuffer?new Uint32Array(i):new Uint32Array([i])).length+3,s=new ArrayBuffer(4*n),r=new Uint32Array(s,0);r[0]=Y.SendAction.PLAYER_CONTROLS_DATA,r[1]=t,r[2]=e,r.set(i,3),this.send(s)}sendPlayerIsJumpingChange(t,e){this.sendPlayerControlsData(t,Y.PlayerControlsType.JUMP,e)}sendHitOtherPlayer(t,e,i,n){let s=new ArrayBuffer(36),r=new Uint32Array(s,0),a=new Float32Array(s,0);r[0]=Y.SendAction.HIT_OTHER_PLAYER,r[1]=t,r[2]=e,a[3]=i.x,a[4]=i.y,a[5]=i.z,a[6]=n.x,a[7]=n.y,a[8]=n.z,this.send(s)}sendPlayerLaunchPos(t,e,i){let n=new ArrayBuffer(16),s=new Uint32Array(n,0),r=new Float32Array(n,0);s[0]=Y.SendAction.PLAYER_LAUNCH_START_POS,s[1]=t,r[2]=e,r[3]=i,this.send(n)}sendPlayerName(t,e){let i=(new TextEncoder).encode(e),n=Y.ceilBytesLength(i.length),s=new ArrayBuffer(12+n),r=new Uint32Array(s);r[0]=Y.SendAction.PLAYER_NAME,r[1]=t,r[2]=i.length,new Uint8Array(s,12).set(i),this.send(s)}sendPlayerHat(t,e){this.send([Y.SendAction.PLAYER_HAT,t,e])}sendStringMessage(t,e){let i=(new TextEncoder).encode(e),n=Y.ceilBytesLength(i.length),s=new ArrayBuffer(8+n),r=new Uint32Array(s);r[0]=t,r[1]=i.length,new Uint8Array(s,8).set(i),this.send(s)}sendJsonMessage(t,e){let i=JSON.stringify(e);this.sendStringMessage(t,i)}sendCommand(t){this.isOfflineGame?p.offlineServer.sendCommand(t):this.sendStringMessage(Y.SendAction.COMMAND,t)}sendTouchPotion(t,e){this.isOfflineGame?p.offlineServer.playerTouchPotion(t,e):this.send([Y.SendAction.PLAYER_TOUCH_POTION,t.playerId,e.id])}sendAteCorn(t){this.send([Y.SendAction.PLAYER_ATE_CORN_SEED,t])}sendMenuVisible(){this.send([Y.SendAction.MAIN_MENU_VISIBLE_CHANGE,p.mainMenu.visible])}sendReportCheatingPlayer(t,e){e=Math.round(e),this.send([Y.SendAction.REPORT_CHEATING_PLAYER,t,e])}sendMyAccountData(t){this.sendJsonMessage(Y.SendAction.MY_ACCOUNT_DATA,t)}visibilityChange(t){this.documentVisible=t,this.send([Y.SendAction.VISIBILITY_CHANGE,t])}}class X{constructor(){this.lastGeneratedPlayerId=0,this.minPlayersRequired=80,this.gameStartTimeoutDurationSeconds=5,this.gameStartTime=0,this.showWinnerStartTime=0,this.didTestWinner=!1,this.playerDeathCountThisRound=0,this.nextBotSpawnTime=0,this.nextCornSpawnTime=0,this.nextPotionSpawnTime=0,this.currentGameStage=0,this.defaultPotionFallSpeed=0,this.stageSettings=[]}init(){this.loadConfigValues(),this.loadStageSettings()}async loadConfigValues(){this.defaultPotionFallSpeed=await p.staticConfig.getKey("defaultPotionFallSpeed")}async loadStageSettings(){let t=[{name:"potionBuildup",modifier:{getPotionSpawnRate:t=>Math.max(5,15-.4*t)}},{name:"knifeHeavyEnding",modifier:{getPotionSpawnRate:t=>{if(t>55)return 1},getPotionsWhitelist:t=>{if(t>55)return[$t.Types.HEAVY]}}}];for(const e of await p.staticConfig.getDataSet("stage_settings")){let i=this.stageSettings[e.stageId];if(i||(i={},this.stageSettings[e.stageId]=i),i.probability=1,void 0!==e.probability&&(i.probability=e.probability),e.fixedPotionSpawnRate&&(i.fixedPotionSpawnRate=e.fixedPotionSpawnRate),e.potionWhiteList&&(i.potionsWhitelistConfig=e.potionWhiteList.split(",").map(t=>$t.Types[t])),e.modifiers)for(const n of e.modifiers.split(",")){let e=t.find(t=>t.name==n);Object.assign(i,e.modifier)}}}get currentStageSettings(){return this.stageSettings[this.currentGameStage]}get serverTime(){return Date.now()-this.gameStartTime}requestPlayerSpawn(t){if(p.game.gameStateManager.currentState==ft.GameState.SHOW_WINNER)return null;this.lastGeneratedPlayerId++,p.network.onRecvMyPlayerId(this.lastGeneratedPlayerId,t),this.testCurrentGameState()}testCurrentGameState(){let t=p.game.players.length;p.game.gameStateManager.currentState==ft.GameState.INVALID?p.network.onRecvGameState(ft.GameState.WAITING_FOR_PLAYERS):p.game.gameStateManager.currentState==ft.GameState.WAITING_FOR_PLAYERS?t>=this.minPlayersRequired&&this.startGame():p.game.gameStateManager.currentState==ft.GameState.STARTING&&t<=1?p.network.onRecvGameState(ft.GameState.WAITING_FOR_PLAYERS):p.game.gameStateManager.currentState==ft.GameState.STARTED&&t<=1&&(p.network.onRecvGameState(ft.GameState.SHOW_WINNER),this.showWinnerStartTime=Date.now())}loop(t,e){if(p.network.isOfflineGame){if(p.game.gameStateManager.currentState==ft.GameState.STARTING)Date.now()>this.gameStartTime&&(p.network.onRecvGameState(ft.GameState.STARTED),this.playerDeathCountThisRound=0,this.currentGameStage=this.pickNewGameStage(),this.roundStarts());else if(p.game.gameStateManager.currentState==ft.GameState.SHOW_WINNER){let t=Date.now()-this.showWinnerStartTime;t>1e3&&!this.didTestWinner&&(this.didTestWinner=!0,this.testWinner()),t>7e3&&(p.network.onRecvGameState(ft.GameState.WAITING_FOR_PLAYERS),this.testCurrentGameState(),this.didTestWinner=!1)}else p.game.gameStateManager.currentState==ft.GameState.WAITING_FOR_PLAYERS&&t>this.nextBotSpawnTime&&this.requestBotSpawn();p.game.gameStateManager.isStarted&&(t>this.nextCornSpawnTime&&this.spawnCornSeed(),t>this.nextPotionSpawnTime&&(this.setNextPotionSpawnTime(),this.spawnPotion()))}}testWinner(){let t=p.game.players,e=ft.WinnerNameType.DRAW,i="";if(t.length>0){e=ft.WinnerNameType.NAMELESS;let n=t[0].stats;if(n){this.offsetStatsScore(n);let t=n.name;t&&(e=ft.WinnerNameType.PLAYER_NAME,i=t)}}p.winnerScreen.startWinAnimation(e,i);let n=this.getCurrentCrownPlayer();p.leaderboard.setLeaderboardDataFromOfflineServer();let s=this.getCurrentCrownPlayer();n!=s&&(n&&n.updateHat(),s&&s.updateHat())}offsetStatsScore(t){let e=p.game.players.length,i=this.playerDeathCountThisRound+e,n=i-e;if((n-=Zt.lerp(0,i/2,t.rank01Offline))>0){if(n*=2*(1-t.rank01Offline)+1,!t.numberOneOffline){let e=i-1-i/2,s=p.leaderboard.currentHighestScore+e-t.score-1;n=Math.min(n,s)}}else n*=2*t.rank01Offline+1;n=Math.round(n),t.addScore(n)}getCurrentCrownPlayer(){for(const t of p.game.players)if(t.hasCrown)return t;return null}onPlayerDied(t){let e=p.game.getPlayerById(t);e&&e.stats&&this.offsetStatsScore(e.stats),this.playerDeathCountThisRound++,this.testCurrentGameState()}requestBotSpawn(){this.setNextBotSpawnTime(),p.network.onRecvRequestBotSpawn()}setNextBotSpawnTime(){let t=p.game.players.length,e=.05*Math.pow(t,2),i=.1*Math.pow(t,2);t>this.minPlayersRequired&&(e=100*(t-70),i=300*(t-70));let n=Zt.lerp(e,i,Math.random());this.nextBotSpawnTime=p.now+n}startGame(t=!0){p.network.onRecvGameState(ft.GameState.STARTING),this.gameStartTime=Date.now(),t&&(this.gameStartTime+=1e3*this.gameStartTimeoutDurationSeconds),p.network.onRecvDeltaStartTime(this.gameStartTime-Date.now())}roundStarts(){p.network.onRecvGameStage(this.currentGameStage);for(let t=0;t<20;t++)this.spawnCornSeed(!1);for(const t of p.playerStats.myPlayerStats)t.roundStarts()}pickNewGameStage(){let t=0;for(const n of this.stageSettings)t+=n.probability;let e=Zt.randRange(0,t),i=0;for(let n=0;n<this.stageSettings.length;n++)if((i+=this.stageSettings[n].probability)>e)return n;return 0}sendCommand(t){"startGame"==t&&this.startGame(!1)}spawnCornSeed(t=!0){this.setNextCornSpawnTime(),p.network.onRecvSpawnCornSeed(t)}setNextCornSpawnTime(){this.nextCornSpawnTime=p.now+Zt.randRange(2e3,6e3)}setNextPotionSpawnTime(){let t;this.currentStageSettings&&(this.currentStageSettings.getPotionSpawnRate?t=this.currentStageSettings.getPotionSpawnRate(this.serverTime/1e3):this.currentStageSettings.fixedPotionSpawnRate&&(t=this.currentStageSettings.fixedPotionSpawnRate)),void 0!==t&&null!=t||(t=30*Math.pow(Math.random(),2)),this.nextPotionSpawnTime=p.now+1e3*t}spawnPotion(){let t=null,e=this.serverTime/1e3;if(this.currentStageSettings&&(this.currentStageSettings.getPotionsWhitelist&&(t=this.currentStageSettings.getPotionsWhitelist(e)),void 0!==t&&null!=t||!this.currentStageSettings.potionsWhitelistConfig||(t=this.currentStageSettings.potionsWhitelistConfig.slice())),void 0===t||null==t){t=[];for(let e=0;e<$t.Types.MAX_VALUE;e++)t.push(e);if(this.currentStageSettings&&this.currentStageSettings.getPotionsBlacklist){let i=this.currentStageSettings.getPotionsBlacklist(e);for(const e of i){let i=t.indexOf(e);i>=0&&t.splice(i,1)}}}let i=Zt.randFromArray(t),n=Zt.randRange(0,15),s=Zt.randRange(0,2*Math.PI),[r,a,o]=[Math.cos(s)*n,30,Math.sin(s)*n];p.game.spawnPotion(0,i,r,a,o,this.defaultPotionFallSpeed,this.serverTime)}playerTouchPotion(t,e){let i=e.getDuration();e.removeAnimated(t);let n=e.applyToOthersRadius;if(n>0)for(const s of p.game.players){let r=t.pos.distanceTo(s.pos);t!=s&&r<n&&p.game.playerApplyPotion(s.playerId,e.type,i)}else p.game.playerApplyPotion(t.playerId,e.type,i)}}class J{constructor(){this.lastPingId=0,this.waitingPingIds=[],this.lastPingTimes=[],this.avgPing=0,this.smoothAvgPing=0,this.nextPingTime=0}loop(t,e){t>this.nextPingTime&&(this.nextPingTime=t+5e3,this.doPing()),this.smoothAvgPing=Zt.lerpt(this.smoothAvgPing,this.avgPing,.025)}doPing(){this.lastPingId++,p.network.sendPing(this.lastPingId)&&this.waitingPingIds.push({id:this.lastPingId,time:Date.now()})}onGetPong(t){for(let e=this.waitingPingIds.length-1;e>=0;e--){let i=this.waitingPingIds[e];if(i.id==t){this.waitingPingIds.splice(e,1),this.addPingTime(Date.now()-i.time);break}}}addPingTime(t){this.lastPingTimes.push(t),this.lastPingTimes.length>4&&this.lastPingTimes.splice(0,this.lastPingTimes.length-4),this.avgPing=0;for(const e of this.lastPingTimes)this.avgPing+=e;this.avgPing/=this.lastPingTimes.length}}class K{constructor(){this.configUrl="https://nuggetroyale.io/config.json",this.configData=null,this.maxCompatibleVersion=1,this.bestServer=null,this.bestGameId=-1,this.didSearchBestServer=!1,this.onFindBestServerCbs=[]}init(){this.getConfig()}async getConfig(){let t=await Zt.cordovaFetch(this.configUrl),e=await t.json();if(this.configData=e,!e.version||e.version>this.maxCompatibleVersion)return;let i=location.hash;if(i){let t=this.findServerForGameName(i.substr(1));t&&(this.bestServer=t.server,this.bestGameId=t.gameId)}if(!this.bestServer){let t=[...e.servers];for(const e of t)e.minRequiredClientVersion||(e.minRequiredClientVersion=0);if((t=(t=t.sort((t,e)=>e.minRequiredClientVersion-t.minRequiredClientVersion)).filter(t=>t.minRequiredClientVersion<=VERSION_TIMESTAMP)).length>0){let e=t[0].minRequiredClientVersion,i=t.filter(t=>t.minRequiredClientVersion==e);this.bestServer=Zt.randFromArray(i)}}this.bestServer||(this.bestServer=Zt.randFromArray(e.servers)),this.didSearchBestServer=!0;for(const n of this.onFindBestServerCbs)n(this.bestServer);this.onFindBestServerCbs=[]}findServerForGameName(t){t=t.toLowerCase();for(const e of this.configData.servers)for(const i of e.games)if(i.name.toLowerCase()==t)return{server:e,gameId:i.id}}async getBestServer(){return this.didSearchBestServer?this.bestServer:await new Promise(t=>{this.onFindBestServerCbs.push(t)})}joinedGameId(t,e){if(location.hash.includes("=")||location.hash.includes("&"))return;if(!e)return;let i=e.games.find(e=>e.id==t);i&&(location.hash=i.name)}}class Z{constructor({onClick:t=null,text:e="",text2:i="",sideType:n="banner",color:s="blue3",addClasses:r=[],icon:a=null,iconSize:o=1,alignIconRight:l=!1,inline:h=!1,width:c=null,margin:u=null,disabled:d=!1}={}){this.el=document.createElement("div"),this.el.classList.add("genericButtonWrapper"),this.el.setAttribute("role","button"),this.inline=h,h&&(this.el.style.display="inline-block"),u&&(this.el.style.margin=u+"px"),this.contentEl=document.createElement("div"),this.contentEl.classList.add("genericButton",s,...r),"square"==n&&this.contentEl.classList.add("square"),c&&(this.contentEl.style.width=c+"px"),this.contentEl.addEventListener("click",t=>{this.click()}),this.contentEl.addEventListener("mouseenter",t=>{this.hoverChange(!0)}),this.contentEl.addEventListener("mouseleave",t=>{this.hoverChange(!1)}),this.boundMouseUp=this.onMouseUp.bind(this),this.contentEl.addEventListener("mousedown",t=>{this.activeChange(!0),window.addEventListener("mouseup",this.boundMouseUp)}),this.el.appendChild(this.contentEl),this.textEl=document.createElement("div"),this.textEl.classList.add("genericButtonText"),this.contentEl.appendChild(this.textEl),this.iconEl=document.createElement("div"),this.iconEl.classList.add("genericButtonIcon"),1!=o&&(this.iconEl.style.transform=`scale(${o})`),this.contentEl.appendChild(this.iconEl),this.afterIconTextEl=document.createElement("div"),this.afterIconTextEl.classList.add("genericButtonText"),this.contentEl.appendChild(this.afterIconTextEl),this.alignIconRight=l,this.setText(e,i),this.setIcon(a),this.disabled=!1,this.setDisabled(d);for(const p of["left","right"])for(const t of["top","bottom"]){let e=document.createElement("div");e.classList.add("genericButton","corner",p,t,n,s),this.contentEl.appendChild(e)}this.onClickCbs=[],t&&this.onClick(t)}destructor(){this.onClickCbs=[],this.el=null,this.contentEl=null,this.textEl=null,this.iconEl=null,this.afterIconTextEl=null,window.removeEventListener("mouseup",this.boundMouseUp),this.boundMouseUp=null}onMouseUp(){window.removeEventListener("mouseup",this.boundMouseUp),this.activeChange(!1)}hoverChange(t){this.el.classList.toggle("hovering",t)}activeChange(t){this.el.classList.toggle("active",t)}onClick(t){this.onClickCbs.push(t)}click(){if(!this.disabled){for(const t of this.onClickCbs)t();p.sfx.playSound("menu/click")}}setText(t,e){e?(this.textEl.textContent=t,this.afterIconTextEl.textContent=e):(this.textEl.textContent=this.alignIconRight?t:"",this.afterIconTextEl.textContent=this.alignIconRight?"":t)}setDisabled(t){this.disabled=t,this.el.classList.toggle("disabled",t),this.contentEl.classList.toggle("disabled",t)}setIcon(t){let e=null;t&&(e=`url(${t})`),this.iconEl.style.backgroundImage=e,this.iconEl.style.display=t?null:"none"}setVisibility(t){let e=this.inline?"inline-block":null;this.el.style.display=t?e:"none"}}class Q{constructor({zIndex:t=100}={}){this.el=document.createElement("div"),this.el.classList.add("genericUIBox","centerDialog"),document.body.appendChild(this.el),this.el.style.zIndex=t,this.requiresCurtain=!0,this.hideOnCloseRequest=!0,this.destroyOnCloseRequest=!0,this.setVisibility(!1,!0),this.setVisibility(!0)}destructor(){this.el.parentElement.removeChild(this.el),this.el=null}setVisibility(t,e=!1){this.visible=t,this.el.style.opacity=t?null:0;let i=t?0:-30;this.el.style.transform=`translate(-50%, -50%) translateY(${i}px)`,e&&(this.el.style.transition="none",Zt.recalculateStyle(this.el),this.el.style.transition=null),this.requiresCurtain&&(t?p.curtain.addElemNeedsCurtain(this):p.curtain.removeElemNeedsCurtain(this))}async close(){this.visible&&(this.setVisibility(!1),await Kt.promise(400),this.destructor())}onCloseRequest(){this.hideOnCloseRequest&&(this.destroyOnCloseRequest?this.close():this.setVisibility(!1))}}class $ extends Q{constructor(t,e=["Ok"],{closeOnButtonClick:i=!0}={}){super(),this.textEl=document.createElement("div"),this.textEl.classList.add("genericMenuText"),this.textEl.textContent=t,this.el.appendChild(this.textEl),this.buttonsContainer=document.createElement("div"),this.buttonsContainer.classList.add("genericAlertButtons"),this.el.appendChild(this.buttonsContainer),this.buttons=[],this.setButtons(e),this.onButtonClickCbs=[],this.closeOnButtonClick=i}destructor(){for(const t of this.buttons)t.destructor();this.buttons=[],this.onButtonClickCbs=[],this.buttonsContainer=null,super.destructor()}setButtons(t=[]){this.buttons=[];for(let e=0;e<t.length;e++){let i=t[e],n=null,s=new Z(n="string"==typeof i?{text:i,sideType:"invBanner",inline:!0}:i),r=e;s.onClick(t=>{this.fireButtonCallback(r)}),this.buttonsContainer.appendChild(s.el),this.buttons.push(s)}}fireButtonCallback(t){for(const e of this.onButtonClickCbs)e(t);this.closeOnButtonClick&&t>=0&&this.close()}async close(){this.fireButtonCallback(-1),await super.close()}async waitForButtonResponse(){return await new Promise(t=>{this.onButtonClickCbs.push(t)})}}class tt{constructor(t){this.index=t,this.el=document.createElement("div"),this.el.classList.add("appearanceMenu","yellowUIBoxContainer"),this.collapsed=!0,this.hidden=!0,this.selectedHatId=0,this.collapsedHatRenderTime=2200,this.el.addEventListener("click",t=>{this.onClick()});let e=p.mainMenu.playerNameUIs[t];this.hat=new yt({canvasSize:100,addClasses:["appearanceMenuHatView"]}),this.leftButton=new It("left",{allowRemapping:!1,allowKeyClick:!0,onClick:t=>{this.offsetHat(-1)},masterRemapButton:e.remapButtonLeft}),this.rightButton=new It("right",{allowRemapping:!1,allowKeyClick:!0,onClick:t=>{this.offsetHat(1)},masterRemapButton:e.remapButtonRight}),this.el.appendChild(this.leftButton.containerEl),this.el.appendChild(this.hat.canvasContainer),this.el.appendChild(this.rightButton.containerEl),this.closeMenuButton=new It("jump",{allowRemapping:!1,allowKeyClick:!0,onClick:t=>{this.setCollapsed(!0)},masterRemapButton:e.remapButtonJump}),this.leftPressed=!1,this.rightPressed=!1,this.leftRightHoldingStartTime=0,window.addEventListener("keydown",t=>{this.onKey(t,!0)}),window.addEventListener("keyup",t=>{this.onKey(t,!1)}),this.setState(),this.loadStoredHat()}get linkedPlayer(){return p.localPlayerManager.localPlayers[this.index].linkedPlayer}get inputPlayers(){return p.localPlayerManager.localPlayers[this.index].inputs}get stats(){return p.localPlayerManager.localPlayers[this.index].stats}setPlayerColors(t){let e=rt.intToHex(t.main),i=rt.intToHex(t.alt);this.el.style.background=`linear-gradient(to right top, ${e}, ${i})`}onClick(){this.setCollapsed(!this.collapsed)}setCollapsed(t){this.collapsed!=t&&(this.collapsed=t,this.setState(),t&&this.hat.render(this.collapsedHatRenderTime),p.sfx.playSound("menu/swoosh",t?.9:1.1))}setState(){let t=!this.collapsed&&!this.hidden;this.leftButton.setVisibility(t),this.rightButton.setVisibility(t),this.el.classList.toggle("collapsed",this.collapsed),this.el.classList.toggle("hidden",this.hidden);for(const e of this.inputPlayers)e.controlsDisabled=!this.collapsed&&!this.hidden;this.closeMenuButton.allowKeyClick=!this.collapsed}loop(t,e){this.collapsed||this.hidden||this.hat.render(t),this.collapsed&&!this.hidden&&this.leftPressed&&this.rightPressed&&t>this.leftRightHoldingStartTime+500&&this.setCollapsed(!1)}onKey(t,e){let i=t.code,n=!1;i==this.leftButton.currentValue&&this.leftPressed!=e&&(this.leftPressed=e,n=!0),i==this.rightButton.currentValue&&this.rightPressed!=e&&(this.rightPressed=e,n=!0),n&&this.leftPressed&&this.rightPressed&&(this.leftRightHoldingStartTime=p.now)}async loadStoredHat(){let t=await zt.get("selectedHatId"+this.index);void 0==t&&(t=-1),await this.setHat(t)}async offsetHat(t){let e=p.hats.availableHats,i=e.indexOf(this.selectedHatId);i+=t,i=Zt.mod(i,e.length),this.selectedHatId=e[i],void 0==this.selectedHatId&&(this.selectedHatId=0),await this.updateHat()}async setHat(t){this.selectedHatId=t,await this.updateHat()}async updateHat(t=0){this.stats.setHat(this.selectedHatId),zt.set("selectedHatId"+this.index,this.selectedHatId),await this.hat.loadHatId(this.selectedHatId),(this.collapsed||this.hidden)&&this.hat.render(this.collapsedHatRenderTime)}testCurrentHatValid(){this.offsetHat(0)}setVisibility(){let t=[ft.GameState.WAITING_FOR_PLAYERS,ft.GameState.STARTING].indexOf(p.game.gameStateManager.currentState)>-1;this.linkedPlayer&&!this.linkedPlayer.died||(t=!0),p.mainMenu.visible&&(t=!1),p.cam.controller.isControlling&&(t=!1),this.hidden=!t,this.setState()}}class et{constructor(){this.el=document.createElement("div"),this.el.classList.add("appearanceMenusContainer"),document.body.appendChild(this.el),this.menus=[]}updateLocalPlayerCount(t){for(;this.menus.length!=t;)if(this.menus.length<t){let t=new tt(this.menus.length);this.el.appendChild(t.el),this.menus.push(t)}else if(this.menus.length>t){let t=this.menus[this.menus.length-1];this.el.removeChild(t.el),this.menus.pop()}for(let e=0;e<this.menus.length;e++){this.menus[e].setPlayerColors(p.mainMenu.playerNameUIs[e].playerColors)}}loop(t,e){for(const i of this.menus)i.loop(t,e)}setVisibility(){for(const t of this.menus)t.setVisibility()}equipHatAllPlayers(t){for(const e of this.menus)e.setHat(t)}testCurrentHatsValid(){for(const t of this.menus)t.testCurrentHatValid()}equipHatSpecificPlayer(t,e){this.menus[e]&&this.menus[e].setHat(t)}}class it{constructor(t,{top:e="70%"}={}){this.visible=!1,this.textElWrapper=document.createElement("div"),this.textElWrapper.classList.add("bannerTextWrapper"),this.textElWrapper.style.top=e,document.body.appendChild(this.textElWrapper),this.textEl=document.createElement("div"),this.textEl.classList.add("bannerText"),this.textElWrapper.appendChild(this.textEl),this.textElContent=document.createElement("span"),this.textElContent.classList.add("bannerTextContent"),this.textEl.appendChild(this.textElContent),this.bannerCornerLeft=document.createElement("div"),this.bannerCornerLeft.classList.add("left"),this.bannerCornerRight=document.createElement("div"),this.bannerCornerRight.classList.add("right"),this.bannerCorners=[this.bannerCornerLeft,this.bannerCornerRight];for(const i of this.bannerCorners)i.classList.add("bannerTextCorner"),this.textElWrapper.appendChild(i);t&&this.setText(t),this.setVisibleWidth(!1),this.setVisibleCorners(!1)}destructor(){this.textElWrapper.parentElement.removeChild(this.textElWrapper),this.textElWrapper=null,this.textEl=null,this.textElContent=null,this.bannerCornerLeft=null,this.bannerCornerRight=null,this.bannerCorners=[],this.visible=!1}async init(){let t=await p.assets.main.getAsSvg("svg/winnerBanner.svg");for(const e of this.bannerCorners)e.style.backgroundImage=`url(${t})`}setText(t){this.textElContent.textContent=t}async setVisible(t){this.visible=t,t?(this.setVisibleWidth(t),await Kt.promise(400),this.setVisibleCorners(t)):(this.setVisibleCorners(t),await Kt.promise(100),this.setVisibleWidth(t))}setVisibleWidth(t){this.textEl.style.width=(t?this.textElContent.offsetWidth:0)+"px",this.textEl.style.padding=t?"10px 40px":"10px 0px"}setVisibleCorners(t){for(const e of this.bannerCorners)e.classList.toggle("hidden",!t)}}class nt{constructor(){this.el=document.createElement("div"),this.el.classList.add("genericUIBox","genericUIBoxMinor","mainMenuLeftSideContainer","changelogContainer"),document.body.appendChild(this.el),this.contentEl=document.createElement("div"),this.contentEl.classList.add("changelog"),this.el.appendChild(this.contentEl)}async init(){if(CORDOVA)return;let t=await fetch("/changelog"),e=await t.text();this.contentEl.innerHTML=e}setVisibility(){let t=p.mainMenu.visible&&p.localPlayerManager.localPlayers.length<=1;CORDOVA&&(t=!1),this.el.classList.toggle("hidden",!t)}}class st{constructor(t=2,e=18,i=13,n="transparent",s="white",{inline:r=!1}={}){this.el=document.createElement("div"),this.el.classList.add("checkerboard"),this.el.style.gridTemplate=`repeat(${t}, ${i}px) / repeat(${e}, ${i}px)`,this.el.style.width=e*i+"px",r&&(this.el.style.display="inline-grid"),n.startsWith("--")&&(n=`var(${n})`),s.startsWith("--")&&(s=`var(${s})`);for(let a=0;a<t;a++)for(let t=0;t<e;t++){let e=document.createElement("div");e.classList.add("checkerboardBlock"),e.style.width=e.style.height=i+"px",e.style.background=(a+t)%2?n:s,this.el.appendChild(e)}}}class rt{constructor(){this.playerColors=[{main:23802,alt:3716863},{main:14811155,alt:16736055},{main:1352192,alt:8048169},{main:16764989,alt:16766623},{main:6488253,alt:8200925},{main:16754735,alt:16763519},{main:14043536,alt:15491206}]}getPlayerColorFromId(t){return t=Zt.mod(t,this.playerColors.length),this.playerColors[t]}static intToHex(t){return"#"+t.toString(16).padStart(6,"0")}styleBillboardEl(t,e){let i=this.getPlayerColorFromId(e),n=rt.intToHex(i.main),s=rt.intToHex(i.alt);t.style.background=`linear-gradient(to top, ${n}, ${s})`,t.style.boxShadow=`inset 0px 0px 50px ${n}, 0px 0px 50px -8px ${s}, inset rgb(0, 0, 0) 0px 0px 13px 0px`}stylePlayerColorGradient(t,e){let i=this.getPlayerColorFromId(e),n=rt.intToHex(i.main),s=rt.intToHex(i.alt);t.style.background=`linear-gradient(to top, ${n}, ${s})`}}class at{constructor(t){this.el=document.createElement("div"),this.el.classList.add("connectionIcon","hidden"),document.body.appendChild(this.el),this.iconSvgName=t}init(){this.loadSvg()}async loadSvg(){let t=await p.assets.main.getAsSvg("svg/"+this.iconSvgName);this.el.style.backgroundImage=`url(${t})`}setVisibility(t){this.el.classList.toggle("hidden",!t)}}class ot{constructor(){this.el=document.createElement("div"),this.el.classList.add("cornSeedScale")}async init(){this.bgEl=document.createElement("div"),this.bgEl.classList.add("cornSeedScaleIcon");let t=await p.assets.main.getAsSvg("svg/scaleBack.svg");this.bgEl.style.backgroundImage=`url(${t})`,this.el.appendChild(this.bgEl),this.fgEl=document.createElement("div"),this.fgEl.classList.add("cornSeedScaleIcon");let e=await p.assets.main.getAsSvg("svg/scaleFront.svg");this.fgEl.style.backgroundImage=`url(${e})`,this.el.appendChild(this.fgEl)}setScale(t){let e=Zt.mapValue(.7,1.5,-50,50,t,!0);this.bgEl.style.transform=`rotate(${e}deg)`}}class lt{constructor(){if(this.visible=!1,this.collapsed=!0,this.el=document.createElement("div"),this.el.classList.add("cornerSettingsContainer","genericUIBox","purpleLines"),document.body.appendChild(this.el),!CORDOVA){let t=document.createElement("a");t.classList.add("hideWithPokiSDK"),t.textContent="privacy",t.href="/privacy",t.target="_blank",this.el.appendChild(t),this.el.appendChild(document.createTextNode(" "));let e=document.createElement("a");e.textContent="presskit",e.href="/presskit",e.target="_blank",this.el.appendChild(e)}this.muteSfxButton=new ht({iconPrefix:"sfx",storageName:"settingSfxMuted",color:"blue3",text:"sfx",width:200,onValueChange:t=>{p.sfx.setMutedSettings(t)}}),this.el.appendChild(this.muteSfxButton.el),this.muteMusicButton=new ht({iconPrefix:"music",storageName:"settingMusicMuted",text:"music",color:"blue3",sideType:"topHeavy",width:200,onValueChange:t=>{t&&p.music.stopCurrentBar()}}),this.el.appendChild(this.muteMusicButton.el),this.defaultQualitySetting=.3,this._currentQuality=this.defaultQualitySetting,this.qualityBeforeCooldown=this.defaultQualitySetting,this.updateQualityTimeout=new Kt(t=>{this.quality=this.qualityBeforeCooldown},700),this.qualityButton=new Z({sideType:"invBanner",color:"blue3",width:200,onClick:t=>{this.nextQuality()}}),this.el.appendChild(this.qualityButton.el),this.mainMenuButton=new Z({text:"Main menu",color:"blue3",icon:"img/cornerSettings/menu.svg",width:200,onClick:t=>{p.mainMenu.setVisibility(!0)}}),this.el.appendChild(this.mainMenuButton.el),this.fullScreenButton=new Z({text:"Fullscreen",color:"blue3",icon:"img/cornerSettings/fullscreen.svg",sideType:"invBanner",width:200,onClick:t=>{this.toggleFullscreen()}}),this.el.appendChild(this.fullScreenButton.el),window.addEventListener("dblclick",t=>{if(p.poki.usePokiSdk)return;let e=t.target;for(;e;){if(e.classList.contains("genericUIBox"))return;if(e.classList.contains("appearanceMenu"))return;e=e.parentElement}this.toggleFullscreen()}),this.partnersButton=new Z({text:"Partners",color:"purple",width:200,onClick:t=>{new At},addClasses:["hideWithPokiSDK"]}),this.el.appendChild(this.partnersButton.el),this.consentSettingsButton=new Z({text:"Consent Settings",width:200,onClick:t=>{aipAPItag.showCMPScreen()}}),this.el.appendChild(this.consentSettingsButton.el),this.consentSettingsButton.setVisibility(!1),this.vrButton=new Z({text:"Enter VR",color:"blue3",icon:"img/cornerSettings/VrIcon.svg",width:200,onClick:t=>{p.vr.requestSession()}}),this.el.appendChild(this.vrButton.el),this.vrButton.setVisibility(!1),this.signOutButton=new Z({text:"Sign out",sideType:"topHeavy",color:"red",width:200,onClick:t=>{p.accounts.signOut()}}),this.el.appendChild(this.signOutButton.el);let t=document.createElement("div");t.classList.add("cornerSettingsBottomIconContainer"),this.el.appendChild(t);let e=document.createElement("div");e.classList.add("cornerSettingsBottomIconLine"),t.appendChild(e);let i=document.createElement("div");i.classList.add("cornerSettingsBottomIcon"),t.appendChild(i);let n=document.createElement("div");n.classList.add("cornerSettingsBottomIconLine"),t.appendChild(n);let s=document.createElement("div");s.style.marginTop="7px",this.el.appendChild(s),this.signInButton=new Z({text:"Sign in",sideType:"square",color:"green2",inline:!0,onClick:t=>{p.poki.isPokiBuild?new $("Sign in is not supported on embedded pages."):p.accounts.signInAny(!1)}}),this.signInButton.contentEl.style.padding="0px 10px",s.appendChild(this.signInButton.el),this.instructionsButton=new Z({icon:"img/cornerSettings/instructions.svg",sideType:"square",inline:!0,onClick:t=>{new vt}}),s.appendChild(this.instructionsButton.el),CORDOVA&&this.instructionsButton.setVisibility(!1),this.globalLeaderboardButton=new Z({icon:"img/cornerSettings/globalLeaderboard.svg",iconSize:1.2,sideType:"square",inline:!0,onClick:t=>{new gt}}),s.appendChild(this.globalLeaderboardButton.el),this.settingsButton=new Z({icon:"img/cornerSettings/settingsSingle.svg",sideType:"square",inline:!0,onClick:t=>{this.setCollapsed(!this.collapsed)}}),s.appendChild(this.settingsButton.el),window.addEventListener("click",t=>{if(!this.collapsed){let e=!1,i=t.target;for(;i;){if(i==this.el){e=!0;break}i=i.parentElement}e||this.setCollapsed(!0)}})}init(){this.setVisibility(),this.setButtonsVisibility(),this.setVrButtonVisibility(),this.muteSfxButton.init(),this.muteMusicButton.init(),this.setQualityText(),this.loadQuality(),(!document.fullscreenEnabled||p.poki.usePokiSdk||CORDOVA)&&this.fullScreenButton.setVisibility(!1),(p.poki.usePokiSdk||CORDOVA)&&this.partnersButton.setVisibility(!1),p.accounts.onSignedInChange(t=>{this.setSignInVisibility(t)}),this.setSignInVisibility(!1)}setSignInVisibility(t){CORDOVA?(this.signInButton.setVisibility(!1),this.signOutButton.setVisibility(!1)):(this.signInButton.setVisibility(!t),this.signOutButton.setVisibility(t))}get quality(){return this._currentQuality||this.defaultQualitySetting}set quality(t){this._currentQuality=t||this.defaultQualitySetting,p.renderer.resolutionMultiplier=2*this._currentQuality,p.renderer.doPostProcessing=this._currentQuality>.5,p.game.setQuality(this._currentQuality)}setQualityText(){let t="";switch(this.qualityBeforeCooldown){case.3:t="low";break;case.5:t="medium";break;case.7:t="high";break;case 1:t="ultra"}this.qualityButton.setText("quality: "+t)}nextQuality(){switch(this.qualityBeforeCooldown){case.3:this.qualityBeforeCooldown=.5;break;case.5:this.qualityBeforeCooldown=.7;break;case.7:this.qualityBeforeCooldown=1;break;case 1:this.qualityBeforeCooldown=.3;break;default:this.qualityBeforeCooldown=.7}zt.set("settingQuality",this.qualityBeforeCooldown),this.setQualityText(),this.updateQualityTimeout.start()}async loadQuality(){this.quality=await zt.get("settingQuality"),this.qualityBeforeCooldown=this.quality,this.setQualityText()}async toggleFullscreen(){if(document.fullscreenElement)document.exitFullscreen();else try{await document.body.requestFullscreen()}catch(t){console.log("requestFullscreen failed",t)}}setCollapsed(t){this.collapsed=t,this.setVisibility()}setVisibility(){this.visible=p.mainMenu.visible||p.game.gameStateManager.isInLobby||!p.game.hasControllablePlayer(),p.cam.controller.isControlling&&(this.visible=!1),this.el.classList.toggle("hidden",!this.visible),this.el.classList.toggle("collapsed",this.collapsed)}setButtonsVisibility(){this.mainMenuButton.setVisibility(!p.mainMenu.visible)}async setVrButtonVisibility(){await p.vr.waitForSupport()&&this.vrButton.setVisibility(!0)}}class ht extends Z{constructor({iconPrefix:t=null,onValueChange:e=null,defaultValue:i=!1,storageName:n=null,text:s="",sideType:r,color:a,width:o}={}){super({onClick:async t=>{this.value=!this.value,zt.set(this.storageName,this.value),this.valueUpdated()},sideType:r,color:a,width:o}),this.text=s,this.value=i,this.storageName=n,this.iconPrefix=t,this.onValueChange=e,this.updateEls()}init(){this.loadSettingValue()}async loadSettingValue(){let t=await zt.get(this.storageName);null!=t&&(this.value=t),this.valueUpdated()}valueUpdated(){this.onValueChange&&this.onValueChange(this.value),this.updateEls()}updateEls(){let t=this.value?"Off":"On";this.setText(this.text+": "+t),this.setIcon(`img/cornerSettings/${this.iconPrefix}${t}.svg`)}}class ct{constructor(){this.didSetYourPlace=!1,this.didSetTotalPlayers=!1,this.didSetNuggets=!1,this.didSetTotalWins=!1,this.visible=!1,this.el=document.createElement("div"),this.el.classList.add("genericUIBox","cornerStatsContainer"),document.body.appendChild(this.el),this.scale=new ot,this.el.appendChild(this.scale.el),this.statsEl=document.createElement("div"),this.statsEl.classList.add("cornerStatsTexts"),this.el.appendChild(this.statsEl),this.statsEl.appendChild(document.createTextNode("You placed: ")),this.yourPlaceValue=document.createElement("span"),this.statsEl.appendChild(this.yourPlaceValue),this.statsEl.appendChild(document.createTextNode(" out of ")),this.totalPlayersValue=document.createElement("span"),this.statsEl.appendChild(this.totalPlayersValue),this.statsEl.appendChild(document.createElement("br")),this.statsEl.appendChild(document.createTextNode("Score this round: ")),this.lastGameScoreValue=document.createElement("span"),this.statsEl.appendChild(this.lastGameScoreValue),this.statsEl.appendChild(document.createElement("br")),this.statsEl.appendChild(document.createTextNode("Nuggets won: ")),this.nuggetsWonValue=document.createElement("span"),this.statsEl.appendChild(this.nuggetsWonValue),this.statsEl.appendChild(document.createElement("br")),this.statsEl.appendChild(document.createTextNode("Total wins: ")),this.totalWinsValue=document.createElement("span"),this.statsEl.appendChild(this.totalWinsValue)}init(){this.setVisibility(),this.scale.init()}setPlayerPlace(t,e,i){this.yourPlaceValue.textContent=e,this.lastGameScoreValue.textContent=i,this.didSetYourPlace=!0,this.setVisibility()}setTotalPlayers(){this.totalPlayersValue.textContent=p.game.players.length,this.didSetTotalPlayers=!0,this.setVisibility()}setNuggets(t){this.nuggetsWonValue.textContent=t,this.didSetNuggets=!0,this.setVisibility()}setPlayerScale(t){this.scale.setScale(t)}setTotalWins(t){this.totalWinsValue.textContent=t,this.didSetTotalWins=!0,this.setVisibility()}setVisibility(){let t=p.game.gameStateManager.isInLobby||!p.game.hasControllablePlayer();p.mainMenu.visible&&(t=!1),p.cam.controller.isControlling&&(t=!1),this.didSetYourPlace&&this.didSetTotalPlayers&&this.didSetNuggets&&this.didSetTotalWins||(t=!1),this.visible=t,this.el.classList.toggle("hidden",!t),p.mainMenu.socialMenu.setVisibility()}}class ut{constructor(){this.el=document.createElement("div"),this.el.classList.add("genericUIBox","genericUIBoxMinor","mainMenuLeftSideContainer","featuredInfluencerContainer"),document.body.appendChild(this.el),this.el.classList.add("featuredInfluencerYT"),this.contentEl=document.createElement("div"),this.contentEl.classList.add("featuredInfluencerContent"),this.el.appendChild(this.contentEl),this.iconEl=document.createElement("div"),this.iconEl.classList.add("featuredInfluencerIcon"),this.iconEl.style.backgroundImage='url("img/socialIcons/youtube.svg")',this.contentEl.appendChild(this.iconEl),this.textEl=document.createElement("div"),this.textEl.classList.add("featuredInfluencerText"),this.contentEl.appendChild(this.textEl),this.titleEl=document.createElement("div"),this.titleEl.textContent="FEATURED YOUTUBER:",this.textEl.appendChild(this.titleEl),this.influencerEl=document.createElement("div"),this.influencerEl.textContent="Loading...",this.textEl.appendChild(this.influencerEl),this.currentInfluencer=null,this.contentEl.addEventListener("click",t=>{this.currentInfluencer&&window.open(this.currentInfluencer.url)})}init(){this.loadInfluencer()}async loadInfluencer(){let t=await p.staticConfig.getDataSet("featured_influencers"),e=0;for(const r of t)e+=r.probability;let i=Zt.randRange(0,e),n=0,s=null;for(const r of t)if((n+=r.probability)>i){s=r;break}this.setInfluencer(s)}setInfluencer(t){t&&(this.currentInfluencer=t,this.influencerEl.textContent=t.name)}setVisibility(){let t=p.mainMenu.visible&&p.localPlayerManager.localPlayers.length<=1;p.poki.usePokiSdk&&(t=!1),CORDOVA&&(t=!1),this.el.classList.toggle("hidden",!t)}}class dt{constructor({invertCircleMask:t=!0}={}){this.el=document.createElement("div"),this.el.classList.add("fullScreenCircleUI","fullScreen"),document.body.appendChild(this.el),this.circleRadius=0,this.svgNs="http://www.w3.org/2000/svg",this.defaultCircleTransition="transform 0.5s";let e=document.createElementNS(this.svgNs,"svg");e.setAttributeNS(null,"width","100%"),e.setAttributeNS(null,"height","100%"),e.setAttributeNS(null,"class","turnBorderSvg"),this.el.appendChild(e);let i=document.createElementNS(this.svgNs,"defs");e.appendChild(i);let n=document.createElementNS(this.svgNs,"mask");n.id="winnerScreenMask_"+Zt.uuid,i.appendChild(n),this.svgMaskRect=this.createSvgRect(0,0,100,100),this.svgMaskRect.style.fill=t?"white":"black",n.appendChild(this.svgMaskRect),this.svgMaskCircle=document.createElementNS(this.svgNs,"circle"),this.svgMaskCircle.style.fill=t?"black":"white",this.svgMaskCircle.style.transformOrigin="center",this.svgMaskCircle.style.transition=this.defaultCircleTransition,n.appendChild(this.svgMaskCircle),this.svgLinesGroup=document.createElementNS(this.svgNs,"g"),this.svgLinesGroup.setAttributeNS(null,"mask","url(#"+n.id+")"),this.svgLinesGroup.style.transition="opacity 0.5s",e.appendChild(this.svgLinesGroup),this.svgCircleOutline=document.createElementNS(this.svgNs,"circle"),this.svgCircleOutline.style.fill="none",this.svgCircleOutline.style.stroke="var(--color-white)",this.svgCircleOutline.style.strokeWidth="20px",this.svgCircleOutline.style.transformOrigin="center",this.svgCircleOutline.style.transition=this.defaultCircleTransition,e.appendChild(this.svgCircleOutline),this.boundResize=(t=>{this.onResize()}),qt.addListener(this.boundResize),this.onResize(),this.setVisible(!1)}destructor(){this.el.parentElement&&this.el.parentElement.removeChild(this.el),this.el=null,this.svgMaskRect=null,this.svgMaskCircle=null,this.svgLinesGroup=null,this.svgCircleOutline=null,qt.removeListener(this.boundResize)}onResize(){let t=window.innerWidth,e=window.innerHeight;this.svgMaskRect.setAttributeNS(null,"width",t),this.svgMaskRect.setAttributeNS(null,"height",e);let i=t/2,n=e/2;for(this.circleRadius=Math.min(.4*t,.4*e),this.svgMaskCircle.setAttributeNS(null,"cx",i),this.svgMaskCircle.setAttributeNS(null,"cy",n),this.svgMaskCircle.setAttributeNS(null,"r",this.circleRadius),this.svgCircleOutline.setAttributeNS(null,"cx",i),this.svgCircleOutline.setAttributeNS(null,"cy",n),this.svgCircleOutline.setAttributeNS(null,"r",this.circleRadius);this.svgLinesGroup.firstChild;)this.svgLinesGroup.removeChild(this.svgLinesGroup.firstChild);for(let s=0;s<t/50;s++){let t=this.createSvgRect(50*s,0,50,e);t.style.fill=s%2==0?"var(--color-orange-main)":"var(--color-orange-alt)",this.svgLinesGroup.appendChild(t)}}createSvgRect(t,e,i,n){let s=document.createElementNS(this.svgNs,"rect");return s.setAttributeNS(null,"x",t),s.setAttributeNS(null,"y",e),s.setAttributeNS(null,"width",i),s.setAttributeNS(null,"height",n),s}setCircleScale(t,e){this.svgMaskCircle.style.transform=this.svgCircleOutline.style.transform=`scale(${t})`,e&&(this.svgMaskCircle.style.transition=this.svgCircleOutline.style.transition="none",Zt.recalculateStyle(this.svgMaskCircle),Zt.recalculateStyle(this.svgCircleOutline),this.svgMaskCircle.style.transition=this.svgCircleOutline.style.transition=this.defaultCircleTransition)}setLinesOpacity(t){this.svgLinesGroup.style.opacity=t}setVisible(t){this.el.style.display=t?null:"none"}}class pt{constructor(t,e){e=e||{},e={...{showDuration:0,color:Zt.randInt(1,6),multiLine:!0,maxWidth:0,maxWidthPercent:0,maxFitScale:0,top:null,animationType:"rotate",startHidden:!1},...e},this.animationType=e.animationType,this.el=document.createElement("div"),this.el.classList.add("fullScreenTitle"),"rotate"==this.animationType&&this.el.classList.add("animated"),e.multiLine||(this.el.style.whiteSpace="nowrap"),null!=e.top&&(this.el.style.top=e.top),this.textWrapper=document.createElement("div"),this.textWrapper.classList.add("fullScreenTitleTextWrapper"),this.el.appendChild(this.textWrapper),this.contentEl=document.createElement("span"),this.contentEl.classList.add("color"+e.color),this.contentEl.classList.add("fullScreenTitleContent"),this.textWrapper.appendChild(this.contentEl),document.body.appendChild(this.el),this.visible=!0,this.setText(t),this.maxWidth=e.maxWidth,this.maxWidthPercent=e.maxWidthPercent,this.multiLine=e.multiLine,this.maxFitScale=e.maxFitScale,"hideBottom"==this.animationType&&(this.setVisibleBottom(!1),this.contentEl.style.transition="none",Zt.recalculateStyle(this.contentEl),this.contentEl.style.transition=null,this.setVisibleBottom(!0)),e.showDuration>0&&this.hideAfterMs(e.showDuration),this.boundResize=(t=>{this.onResize()}),qt.addListener(this.boundResize),this.onResize(),e.startHidden&&this.hide(!1)}destructor(){this.el.parentElement.removeChild(this.el),this.el=null,qt.removeListener(this.boundResize)}onResize(){this.setMaxWidth()}setMaxWidth(){let t=this.maxWidth;if(this.maxWidthPercent>0&&(t=window.innerWidth*this.maxWidthPercent),t>0)if(this.multiLine)this.el.style.maxWidth=t+"px";else{Zt.recalculateStyle(this.el);let e=t/this.el.clientWidth;this.maxFitScale>0&&(e=Math.min(this.maxFitScale,e)),this.textWrapper.style.transform=`translateX(-50%) scale(${e})`}}async hide(t=!0){this.visible&&(this.visible=!1,"rotate"==this.animationType?(this.el.classList.remove("animated"),this.el.classList.add("hideAnimated")):"hideBottom"==this.animationType&&this.setVisibleBottom(!1),await Kt.promise(300),t&&this.destructor())}async show(){this.visible||(this.visible=!0,"rotate"==this.animationType?(this.el.classList.add("animated"),this.el.classList.remove("hideAnimated")):"hideBottom"==this.animationType&&this.setVisibleBottom(!0),await Kt.promise(300))}setText(t){this.contentEl.textContent!=t&&(this.contentEl.textContent=t,this.setMaxWidth())}setVisibleBottom(t){let e=t?0:100;this.contentEl.style.transform=`translateY(${e}%)`}async hideAfterMs(t){await Kt.promise(t),this.hide()}}class mt{constructor(){this.el=document.createElement("div"),this.el.classList.add("gameOverScreen","genericUIBox"),document.body.appendChild(this.el),this.titleContainer=document.createElement("div"),this.titleContainer.classList.add("gameOverTitleContainer"),this.el.appendChild(this.titleContainer),this.titleContainer.appendChild(new st(2,18,17,"--color-green2-main","white",{inline:!0}).el),this.titleEl=document.createElement("h2"),this.titleContainer.appendChild(this.titleEl),this.titleContainer.appendChild(new st(2,18,17,"--color-green2-main","white",{inline:!0}).el),this.gameOverScreenContent=document.createElement("div"),this.gameOverScreenContent.classList.add("gameOverScreenContent"),this.el.appendChild(this.gameOverScreenContent),CORDOVA||(this.bannerAdEl=document.createElement("div"),this.bannerAdEl.classList.add("gameOverBannerAd","thisDefinitelyWontGetBlockedByAdblockers","itchBanner"),this.bannerAdContent=document.createElement("div"),this.bannerAdContent.id="nuggetroyale-io_300x250",this.bannerAdContent.classList.add("pokiBanner"),this.bannerAdEl.appendChild(this.bannerAdContent),this.gameOverScreenContent.appendChild(this.bannerAdEl)),this.textEl=document.createElement("div"),this.textEl.classList.add("gameOverTextContent"),this.gameOverScreenContent.appendChild(this.textEl),this.table=document.createElement("table"),this.textEl.appendChild(this.table),this.tbody=document.createElement("tbody"),this.table.appendChild(this.tbody),this.onContinueButtonClickCbs=[],this.continueButton=new Z({text:"Continue",color:"blue3",width:200,onClick:t=>{this.close()}}),this.textEl.appendChild(this.continueButton.el),window.addEventListener("keypress",t=>{"Enter"!=t.code&&"Enter"!=t.key&&"Space"!=t.code&&"Space"!=t.key||this.close()}),this.currentScoreData={wonThisRound:!1,rankThisRound:1,scoreThisRound:0,nuggetsWon:0,timeAliveSeconds:0,winCount:0,winStreak:0},this.didAutoClose=!1,this.visible=!0,this.el.style.display="none",this.setVisiblility(!1,!0),this.el.style.display=null}init(){this.setData(),p.input.onJumpAnyControllable(t=>{this.close()})}setData(t){for(this.currentScoreData={...this.currentScoreData,...t},this.currentScoreData.wonThisRound?this.titleEl.textContent="YOU WON!":this.titleEl.textContent=`YOU PLACED #${this.currentScoreData.rankThisRound}`;this.tbody.firstChild;)this.tbody.removeChild(this.tbody.firstChild);this.addTableEl("Score this round",this.currentScoreData.scoreThisRound),this.addTableEl("Nuggets won",this.currentScoreData.nuggetsWon),this.addTableEl("Time alive",Zt.formatSeconds(this.currentScoreData.timeAliveSeconds)),this.addTableEl("Rounds won",this.currentScoreData.winCount),this.addTableEl("Win streak",this.currentScoreData.winStreak)}addTableEl(t,e){let i=document.createElement("tr"),n=document.createElement("td");n.textContent=t,i.appendChild(n);let s=document.createElement("td");s.textContent=e,i.appendChild(s),this.tbody.appendChild(i)}setVisiblility(t,e){this.visible!=t&&(this.visible=t,this.el.classList.toggle("hidden",!t),e&&Zt.skipCssTransition(this.el),p&&(t?p.curtain.addElemNeedsCurtain(this.el):p.curtain.removeElemNeedsCurtain(this.el),p.ads.updatePokiBannerVisibility()))}async showLastGameStats(){if(!p.mainMenu.visible){if(this.setVisiblility(!0),!CORDOVA){this.continueButton.setDisabled(!0);for(let t=4;t>0;t--){if(!this.visible)return;this.continueButton.setText("Continue ("+t+")"),await Kt.promise(1e3)}}this.continueButton.setText("Continue"),this.continueButton.setDisabled(!1)}}async waitForButtonClick(t=!0){if(this.visible||!t)return await new Promise(t=>{this.onContinueButtonClickCbs.push(t)})}autoClose(){this.close(!0)}close(t=!1){if(this.visible&&(t||!this.continueButton.disabled)){this.didAutoClose=t;for(const t of this.onContinueButtonClickCbs)t();this.onContinueButtonClickCbs=[],this.setVisiblility(!1)}}}class ft{constructor(){this.currentState=ft.GameState.INVALID,this.gameStartTime=0,this.onStateChangeCbs=[]}static get GameState(){return{INVALID:-1,WAITING_FOR_PLAYERS:0,STARTING:1,STARTED:2,SHOW_WINNER:3}}static get WinnerNameType(){return{PLAYER_NAME:0,NAMELESS:1,DRAW:2}}setCurrentState(t){if(this.currentState!=t){if(this.currentState==ft.GameState.SHOW_WINNER){p.winnerScreen.hideWinnerTitle();for(const t of p.game.getMyPlayers())t.respawnToLobby();p.cam.doFastCut(),this.doAfterGameLoop()}if(this.currentState=t,this.currentState==ft.GameState.WAITING_FOR_PLAYERS&&p.game.removeAllCornSeeds(),this.currentState==ft.GameState.STARTED){p.gameOverScreen.visible&&p.localPlayerManager.hasNonAfkPlayer()&&p.gameOverScreen.autoClose(),p.sfx.playSound("conveyorBeltLaunch"),p.game.stageManager.themeManager.setPlayingAmbientLoops(!0),p.music.startPlaying(),p.game.removeAllPotions(),p.game.setLobbyCollisions(!1),p.cornerStats.setTotalPlayers(),p.localPlayerManager.roundStarts(),p.mainMenu.didJoinGameOnce&&Zt.gaEvent("gameLoop","gameStart");for(const t of p.game.players)t.spawnStartGame()}this.currentState==ft.GameState.SHOW_WINNER?(p.game.stageManager.themeManager.setPlayingAmbientLoops(!1),p.game.setDoorsOpen(!1),p.music.playLastAndStop(),p.game.setLobbyCollisions(!0),p.game.setTimeScale(.2)):p.game.setTimeScale(1);for(let e=this.onStateChangeCbs.length-1;e>=0;e--){(0,this.onStateChangeCbs[e])(t)}p.mainMenu.updateUIVisibilities()}}async doAfterGameLoop(){p.game.didHaveControllablePlayerThisGame&&(p.mainMenu.didJoinGameOnce&&Zt.gaEvent("gameLoop","showGameoverScreen"),p.gameOverScreen.showLastGameStats(),await p.gameOverScreen.waitForButtonClick(),p.gameOverScreen.didAutoClose||await p.ads.doPreroll()),p.mainMenu.didJoinGameOnce&&Zt.gaEvent("gameLoop","backInLobby"),p.localPlayerManager.activateControllable(),await p.levelUI.doLastGameAddNuggetsAnimation()}get isInLobby(){let t=[ft.GameState.INVALID,ft.GameState.WAITING_FOR_PLAYERS,ft.GameState.STARTING].includes(this.currentState);return p.mainMenu.visible&&(t=!1),t}get isWatchingGame(){return this.isStarted&&!p.mainMenu.visible}get isStarted(){return this.currentState==ft.GameState.STARTED}setDeltaStartTime(t){this.gameStartTime=Date.now()+t,p.game.resetTimeScaleChanges(),this.currentState==ft.GameState.STARTING&&this.doCountDown()}async doCountDown(){for(;;){if(p.mainMenu.didJoinGameOnce){let t,e=Math.round((this.gameStartTime-Date.now())/1e3);if(e<0)break;0==e?(t="GO!",p.sfx.playSound("countDownLast")):(t=""+e,p.sfx.playSound("countDownFirst")),p.mainMenu.visible||new pt(t,{showDuration:1e3})}await Kt.promise(1e3)}await Kt.promise(1100)}async waitForGamestate(t){if(this.currentState!=t)return await new Promise(e=>{let i=n=>{n==t&&(this.removeOnStateChange(i),e())};this.onStateChange(i)})}onStateChange(t){this.onStateChangeCbs.push(t)}removeOnStateChange(t){let e=this.onStateChangeCbs.indexOf(t);e>=0&&this.onStateChangeCbs.splice(e,1)}onPlayerDied(){let t=p.game.hasControllablePlayer();t!=this.prevHasControllablePlayer&&(this.prevHasControllablePlayer=t,t||(p.mainMenu.didJoinGameOnce&&Zt.gaEvent("gameLoop","myPlayersDead"),p.poki.gameplayStop()))}}class gt extends Q{constructor(){super(),this.el.style.background="var(--color-blue3-main)",this.currentPage="score",this.buttonTexts={score:"score",winStreak:"win streak",roundsWon:"rounds won"},this.buttonsContainer=document.createElement("div"),this.buttonsContainer.classList.add("globalLeaderboardButtons"),this.el.appendChild(this.buttonsContainer),this.tablesContainer=document.createElement("div"),this.tablesContainer.classList.add("globalLeaderboardsContainer"),this.el.appendChild(this.tablesContainer),this.leaderboardData=null,this.getLeaderboardData()}async getLeaderboardData(){let t=await Zt.cordovaFetch("https://nuggetroyale.io/leaderboard.json");this.leaderboardData=await t.json(),this.updateCurrentTables(),this.updateButtons()}updateButtons(){for(const t of this.leaderboardData.leaderboards){let e=this.buttonTexts[t.name],i=new Z({text:e,onClick:e=>{this.currentPage=t.name,this.updateCurrentTables()},inline:!0,margin:10});this.buttonsContainer.appendChild(i.el)}}updateCurrentTables(){if(!this.leaderboardData)return;let t=this.leaderboardData.leaderboards.find(t=>t.name==this.currentPage),e=this.createLeaderboardTable(t.dailyScores,"Today"),i=this.createLeaderboardTable(t.weeklyScores,"This week");this.tablesContainer.textContent="",this.tablesContainer.appendChild(e),this.tablesContainer.appendChild(i)}createLeaderboardTable(t,e){let i=document.createElement("div");i.classList.add("globalLeaderboardContainer");let n=document.createElement("h2");n.textContent=e,i.appendChild(n);let s=new st(2,20,13,"--color-blue3-alt");i.appendChild(s.el);let r=document.createElement("table");i.appendChild(r);let a=document.createElement("tbody");r.appendChild(a);let o=1;for(const l of t){let t=document.createElement("tr");a.appendChild(t);let e=document.createElement("td");e.textContent="#"+o,o++,t.appendChild(e);let i=document.createElement("td");i.textContent=l.name,t.appendChild(i);let n=document.createElement("td");n.textContent=l.scoreValue,t.appendChild(n)}return i}}class yt{constructor({canvasSize:t=100,addClasses:e=null}={}){this.canvasContainer=document.createElement("div"),this.canvasContainer.classList.add("hatUICanvasContainer"),e&&this.canvasContainer.classList.add(...e),this.canvasContainer.style.width=this.canvasContainer.style.height=t+"px",this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=Math.max(260,t),this.size=t,this.ctx=this.canvas.getContext("2d"),this.canvasContainer.appendChild(this.canvas);this.camera=new THREE.OrthographicCamera(-1,1,1,-1,.01,10),this.camera.position.set(0,.3,1.1),this.camera.lookAt(0,0,0),this.scene=new THREE.Scene;let i=new THREE.DirectionalLight(16777215,1.5);i.position.set(1,1,1),this.scene.add(i);let n=new THREE.AmbientLight(16777215,.6);n.position.set(1,1,1),this.scene.add(n),this.hatContainer=new THREE.Object3D,this.scene.add(this.hatContainer),this.currentHatId=-1}destructor(){this.disposeCurrentHat(),this.scene.dispose(),this.scene=null,this.camera=null,this.canvas.width=this.canvas.height=0,this.canvas=null,this.ctx=null,this.canvasContainer=null}disposeCurrentHat(){for(;this.hatContainer.children.length;){let t=this.hatContainer.children[0];this.hatContainer.remove(t),t.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}}async loadHatId(t){this.currentHatId=t;let e=await p.hats.getHatObject(t);t==this.currentHatId&&await this.loadHat(e)}loadHat(t){this.disposeCurrentHat(),t&&t.main&&(t.main.position.y=t.uiRenderHeightOffset,this.hatContainer.add(t.main))}render(t=p.now){this.hatContainer.quaternion.setFromAxisAngle(new THREE.Vector3(0,1,0),.001*-t);let e=p.renderer.uiRenderer.render(this.size,this.size,this.scene,this.camera);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e.el,0,0,e.w,e.h,0,0,this.size,this.size)}}class vt extends Q{constructor(){super(),this.instructionsTitle=document.createElement("div"),this.instructionsTitle=document.createElement("h2"),this.instructionsTitle.classList.add("instructionsTextContent"),this.instructionsTitle.textContent="How to play:",this.el.appendChild(this.instructionsTitle),this.instructionsList=document.createElement("div"),this.instructionsList.classList.add("instructionsList"),this.el.appendChild(this.instructionsList),this.items=[new bt({title:"WALK",video:"walk",buttons:[{name:"up",times:[[.3,.3]]},{name:"left",times:[[.4,1]]},{name:"down",times:[[1.3,1]]},{name:"right",times:[[0,.2],[1.5,2]]}],buttonsType:"wasd"}),new bt({title:"JUMP",video:"jump",buttons:[{name:"jump",times:[[.15,.05]]}]}),new bt({title:"DOUBLE JUMP",video:"doubleJump",buttons:[{name:"jump",times:[[0,.1],[.3,.1]]}]}),new bt({title:"DASH",video:"dash",buttons:[{name:"jump",times:[[0,2.7]]}]}),new bt({title:"FLY",video:"fly",buttons:[{name:"jump",times:[[.1,5]]}]}),new bt({title:"SPRINT",video:"sprint",buttons:[{name:"up",times:[[.15,0]]},{name:"left",times:[[.15,0]]},{name:"down",times:[[.15,0]]},{name:"right",times:[[.15,.08],[.3,3]]}],buttonsType:"wasd"})];for(const t of this.items)this.instructionsList.appendChild(t.el)}destructor(){super.destructor(),this.instructionsList=null;for(const t of this.items)t.destructor();this.items=[]}}class bt{constructor({title:t=null,video:e=null,buttons:i=[],buttonsType:n="jump"}={}){this.el=document.createElement("div"),this.el.classList.add("instructionsItem"),this.smoothVideoTime=0,t&&(this.titleEL=document.createElement("h2"),this.titleEL.textContent=t,this.el.appendChild(this.titleEL)),e&&(this.videoEl=document.createElement("video"),this.videoEl.src="instructions/"+e+".webm",this.videoEl.autoplay=!0,this.videoEl.loop=!0,this.videoEl.muted=!0,this.videoEl.controls=!1,this.el.appendChild(this.videoEl)),this.keysEl=document.createElement("div"),this.keysEl.classList.add("instructionsItemKeys",n),this.el.appendChild(this.keysEl),this.buttons=i;for(const s of this.buttons){let t=p.mainMenu.getRemapButton(s.name),e=new It(t.keyType,{allowRemapping:!1,allowKeyClick:!1,masterRemapButton:t});s.button=e,this.keysEl.appendChild(e.containerEl)}this.loop()}destructor(){this.el=null,this.videoEl=null,this.keysEl=null;for(const t of this.buttons)t.button.destructor();this.buttons=[]}loop(){if(this.el){if(this.videoEl){let t=this.videoEl.currentTime;t>this.smoothVideoTime?this.smoothVideoTime=Zt.lerpt(this.smoothVideoTime,t,.5):this.smoothVideoTime=t;for(const e of this.buttons){let t=!1;for(const i of e.times)if(i[0]<=this.smoothVideoTime&&i[0]+i[1]>=this.smoothVideoTime){t=!0;break}e.button.forceDown(t)}}window.requestAnimationFrame(this.loop.bind(this))}}}class wt{constructor(){this.el=document.createElement("div"),this.el.classList.add("genericUIBox","leaderboard"),document.body.appendChild(this.el);let t=document.createElement("h2");t.textContent="Leaderboard",this.el.appendChild(t);let e=new st(2,18,13,"--color-red-main");this.el.appendChild(e.el),this.table=document.createElement("table"),this.el.appendChild(this.table),this.tbody=document.createElement("tbody"),this.table.appendChild(this.tbody),this.lastServerLeaderboardData=[],this.smoothScores=[],this.botNames=[],this.botNamesLoaded=!1,this.onBotNamesLoadCbs=[],this.fakeEntries=[],this.currentHighestScore=0}async init(){this.setVisibility(),this.botNames=await p.staticConfig.getDataSet("default_names"),this.botNamesLoaded=!0;for(const t of this.onBotNamesLoadCbs)t();this.onBotNamesLoadCbs=[]}async waitForBotNamesLoad(){if(!this.botNamesLoaded)return await new Promise(t=>this.onBotNamesLoadCbs.push(t))}async updateOfflineLeaderboardAfterBotsLoad(){await this.waitForBotNamesLoad(),this.setLeaderboardDataFromOfflineServer()}loop(t,e){for(const i of this.smoothScores)i.score=Zt.lerp(i.score,i.targetScore,.1),i.scoreEl.textContent=Math.round(i.score)}createCrownEl(){this.crownEl||(this.crownEl=document.createElement("img"),this.crownEl.classList.add("leaderboardCrown"),this.loadCrownEl())}async loadCrownEl(){this.crownEl.src=await p.assets.main.getAsSvg("svg/crownLeaderboard.svg")}async updateLeaderboard(){p.game.didHaveControllablePlayerThisGame&&await p.gameOverScreen.waitForButtonClick(!1);let t=[];for(const e of this.lastServerLeaderboardData)t.push(e);for(const e of p.playerStats.myPlayerStats)e.rank<0||(t[e.rank]={name:e.name,score:e.score,isMyPlayer:!0,myStat:e});for(const e of this.fakeEntries){let i=t.length;for(const[n,s]of t.entries())if(s&&e.score>s.score){i=n;break}t.splice(i,0,e)}this.currentHighestScore=0;for(const[e,i]of t.entries()){if(!i)continue;let n=i.myStat;n&&(n.rank01Offline=1-e/(t.length-1),n.numberOneOffline=0==e),this.currentHighestScore=Math.max(this.currentHighestScore,i.score)}for(let e=t.length-1;e>=5;e--){let i=t[e];i&&(i.isMyPlayer||delete t[e])}this.generateElements(t)}generateElements(t){let e=this.smoothScores;for(this.smoothScores=[],this.createCrownEl();this.tbody.firstChild;)this.tbody.removeChild(this.tbody.firstChild);let i=0;for(const n of t){if(i++,void 0===n)continue;0;let t=document.createElement("tr");this.tbody.appendChild(t);let s=document.createElement("td");1==i?s.appendChild(this.crownEl):s.textContent="#"+i,s.classList.toggle("myPlayerRank",!!n.isMyPlayer),t.appendChild(s);let r=document.createElement("td");r.textContent=n.name,t.appendChild(r);let a=document.createElement("td");t.appendChild(a),t.title=n.name;let o={name:n.name,score:0,targetScore:n.score,scoreEl:a},l=e.find(t=>t.name==n.name);l&&(o.score=l.score),this.smoothScores.push(o)}}leaderboardDataFromServer(t){this.lastServerLeaderboardData=t,this.setUseFakeEntries(!1),this.updateLeaderboard()}setLeaderboardDataFromOfflineServer(){let t=[...p.playerStats.myPlayerStats].sort((t,e)=>e.score-t.score),e=[];for(let i=0;i<t.length&&i<5;i++){let n=t[i];n.numberOne=0==i,e.push({name:n.name,score:n.score,isMyPlayer:!0,myStat:n})}this.lastServerLeaderboardData=e,this.setUseFakeEntries(!0),this.updateFakeEntries(),this.updateLeaderboard()}setUseFakeEntries(t){if(t!=this.fakeEntries.length>0)if(t){for(let t=0;t<8;t++)this.fakeEntries.push({});this.updateFakeEntries(!0)}else this.fakeEntries=[]}updateFakeEntries(t=!1){for(const e of this.fakeEntries)(t||Math.random()>.9)&&(e.name=Zt.randFromArray(this.botNames),e.unmappedScore=0),t&&(e.score=Zt.randInt(0,600)),e.unmappedScore+=Zt.randInt(-20,100),e.unmappedScore=Math.max(0,e.unmappedScore),e.score=15*Math.sqrt(e.unmappedScore)}setVisibility(){let t=p.game.gameStateManager.isInLobby||!p.game.hasControllablePlayer();p.mainMenu.visible&&(t=!1),p.cam.controller.isControlling&&(t=!1),this.visible=t,this.el.classList.toggle("hidden",!this.visible)}}class xt{constructor(){this.el=document.createElement("div"),this.el.classList.add("levelUIContainer","levelUIContainer","genericUIBox"),document.body.appendChild(this.el),this.canvas=document.createElement("canvas"),this.canvas.classList.add("levelUICanvas"),this.width=this.canvas.width=560,this.height=this.canvas.height=150,this.ctx=this.canvas.getContext("2d"),this.el.appendChild(this.canvas),this.progressBarContainer=document.createElement("div"),this.progressBarContainer.classList.add("levelUIProgressContainer"),this.el.appendChild(this.progressBarContainer),this.progressBar=document.createElement("div"),this.progressBar.classList.add("levelUIProgress"),this.progressBarContainer.appendChild(this.progressBar),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(16,this.width/this.height,.1,1e3),this.camera.position.set(-30,7,18);let t=Math.PI/180;this.camera.rotation.set(-90*t,-74*t,-90*t);let e=new THREE.AmbientLight(16777215,.4);this.scene.add(e);let i=new THREE.DirectionalLight(16777215,.7);i.castShadow=!0,i.shadow.mapSize.width=i.shadow.mapSize.height=512;let n=i.shadow.camera;n.zoom=.1,n.updateProjectionMatrix(),i.shadow.bias=-5e-4,i.position.set(-30,30,-10),this.scene.add(i),this.nugget=null,this.nuggetAnimations=[],this.crusher=null,this.newHatUIs=[],this.prevNuggetCount=0,this.currentNuggetCount=0,this.currentNuggetCountIsValid=!1,this.onCurrentNuggetCountValidCbs=[],this.currentProgressBarValue=0,this.progressBarShakingCount=0}init(){this.setVisibility(!1),this.loadScene()}get isShowingNewHatUI(){return this.newHatUIs.length>0}async loadScene(){let t=await p.assets.main.getGltfObject("levelUI/static.glb");t.scene.name="static",this.scene.add(t.scene);let e=await p.assets.main.getGltfObject("levelUI/nuggetBox.glb");e.scene.name="box",this.scene.add(e.scene);let i=await p.assets.main.getGltfObject("levelUI/crusher.glb");i.scene.name="crusher",this.scene.add(i.scene),this.crusher=i.scene,this.nugget=await p.assets.main.getGltfObject("levelUI/nugget.glb"),this.nugget.scene.name="nugget",this.scene.add(this.nugget.scene);let n=await p.game.getEnvMap();this.scene.traverse(t=>{t instanceof THREE.Mesh&&(t.material.envMap=n,t.material.shadowSide=THREE.DoubleSide,t.castShadow=!0,t.receiveShadow=!0,t.material.needsUpdate=!0)}),this.scene.remove(this.nugget.scene)}spawnNugget(){p.sfx.playSound("nuggetScoreCounter");let t=this.nugget.scene.clone();this.scene.add(t);let e=t.getObjectByName("Nugget"),i=new THREE.AnimationMixer(t);for(const n of this.nugget.animations){let t=i.clipAction(n);t.setLoop(THREE.LoopOnce),t.play()}this.nuggetAnimations.push({mixer:i,finalNugget:e,finalNuggetRotation:Math.random()*Math.PI*2})}getCrusherPosForMixerTime(t){if(t<.45)return 0;if(t<.5)return Zt.mapValue(.45,.5,0,1,t);if(t<.7)return 1;if(t<.75)return Zt.mapValue(.7,.75,1,-4,t);if(t<1){let e=Zt.mapValue(.75,1,0,1,t);return e=Gt.in(e),Zt.lerp(-4,0,e)}return 0}loop(t,e){if(this.visible){let t=this.nuggetAnimations.length>0?1/0:0;for(let n=this.nuggetAnimations.length-1;n>=0;n--){let i=this.nuggetAnimations[n],s=i.mixer;s.update(e/1e3),i.finalNugget.rotation.y=i.finalNuggetRotation;let r=this.getCrusherPosForMixerTime(s.time);if(r<t&&(0!=r||t==1/0)&&(t=r),s.time>2.666){let t=s.getRoot();t.parent.remove(t),s.stopAllAction(),s.uncacheRoot(t);for(const e of this.nugget.animations)s.uncacheClip(e);this.nuggetAnimations.splice(n,1)}}this.crusher&&(this.crusher.position.y=t+4);let i=p.renderer.uiRenderer.render(this.width,this.height,this.scene,this.camera);this.ctx.clearRect(0,0,this.width,this.height),this.ctx.drawImage(i.el,0,0,i.w,i.h,0,0,this.width,this.height)}for(let i=this.newHatUIs.length-1;i>=0;i--){let n=this.newHatUIs[i];n.loop(t,e),n.done&&(n.destructor(),this.newHatUIs.splice(i,1),p.game.updateLobbyPlayerCountMessage())}}async setNuggetCountFromServer(t){this.prevNuggetCount=this.currentNuggetCount,this.currentNuggetCount=t,this.setValidCurrentNuggetCount();let e=Math.min(this.prevNuggetCount,this.currentNuggetCount),i=await p.hats.getHatPercentageForNuggetCount(e);this.setProgressBar(i,!0);let n=this.currentNuggetCount-e;p.cornerStats.setNuggets(n),p.gameOverScreen.setData({nuggetsWon:n})}async getValidNuggetCount(){return this.currentNuggetCountIsValid?this.currentNuggetCount:await new Promise(t=>{this.onCurrentNuggetCountValidCbs.push(t)})}setValidCurrentNuggetCount(){if(!this.currentNuggetCountIsValid){this.currentNuggetCountIsValid=!0,this.prevNuggetCount=this.currentNuggetCount;for(const t of this.onCurrentNuggetCountValidCbs)t(this.currentNuggetCount);this.onCurrentNuggetCountValidCbs=[]}}async doLastGameAddNuggetsAnimation(){p.network.isOfflineGame||await this.doAddNuggetsAnimation(this.prevNuggetCount,this.currentNuggetCount)}async doAddNuggetsAnimation(t,e){let i=(e-t)/10;if((i=Math.ceil(i))<=0)return;this.setVisibility(!0),await Kt.promise(500);let n=await p.sfx.playSound("nuggetScoreCounterConveyorbelt"),s=[];for(let r=0;r<i;r++){this.spawnNugget();let n=Zt.mapValue(0,i,t,e,r,!0),a=Zt.mapValue(0,i,t,e,r+1,!0),o=await p.hats.getHatPercentageForNuggetCount(a),l=await p.hats.getHatCountForNuggetCount(n),h=await p.hats.getHatCountForNuggetCount(a),c=-1;h>l&&(c=await p.hats.getHatIdForNuggetHatCount(h));let u=this.setProgressBarAfterMs(2500,o,c,!1);s.push(u),await Kt.promise(400)}await Kt.promise(2500),n&&n.stop(),this.setVisibility(!1),await Kt.promise(400),await Promise.all(s)}async setProgressBarAfterMs(t,e,i=-1,n=!1){if(await Kt.promise(t),this.setProgressBar(e,n),i>=0){await this.showNewHatUI(i);let t=!1;await zt.get("didAutoEquipHatOnce")||(t=!0,zt.set("didAutoEquipHatOnce",!0)),await p.hats.makeHatIdAvailable(i,t)}}async setProgressBar(t,e=!1){let i=t<this.currentProgressBarValue;return this.currentProgressBarValue=t,t=Zt.clamp01(t),t=Zt.lerp(5,100,t),this.progressBar.style.width=t+"%",e?(this.progressBar.style.transition="none",Zt.recalculateStyle(this.progressBar),this.progressBar.style.transition=null):(this.offsetProgressBarShakingCount(1),await Kt.promise(500),this.offsetProgressBarShakingCount(-1)),i}offsetProgressBarShakingCount(t){this.progressBarShakingCount+=t,this.progressBarShakingCount=Math.max(0,this.progressBarShakingCount),this.progressBarContainer.classList.toggle("shaking",this.progressBarShakingCount>0)}async showNewHatUI(t){let e=new _t(t);this.newHatUIs.push(e),p.game.updateLobbyPlayerCountMessage(),await e.waitForDisappear()}setVisibility(t){void 0!==t&&(this.visible=t),this.el.classList.toggle("barOnly",!this.visible),this.el.classList.toggle("hidden",!p.game.gameStateManager.isInLobby&&!this.visible)}}class St{constructor(){this.loadScreen=document.getElementById("loadScreen"),this.loadingParts=[],this.progressBar=document.getElementById("progressBar")}async setVisibility(t){t?p.poki.gameLoadingStart():p.poki.gameLoadingFinished(),loadScreen.classList.toggle("hidden",!t),await Kt.promise(500)}updatePercentage(){let t=0,e=0;for(const i of this.loadingParts)t+=i.percentage*i.importance,e+=i.importance;e>0&&(t/=e),setProgressBar(t),p.poki.gameLoadingProgress(t)}requestLoadingPart(t){let e=new Et(this,t);return this.loadingParts.push(e),this.updatePercentage(),e}resetLoadingParts(){this.loadingParts=[],this.updatePercentage(),this.resetProgressBarAnimation()}resetProgressBarAnimation(){this.progressBar.style.transition="none",Zt.recalculateStyle(this.progressBar),this.progressBar.style.transition=null}setOrangeColor(){if(this.loadScreen.classList.remove("img1"),this.loadScreen.classList.add("img2"),testWebpSupported()){document.getElementById("loadScreenLogo").classList.add("left")}}}class Et{constructor(t,e){this.percentage=0,this.manager=t,this.importance=e}setPercentage(t){this.percentage=t,this.manager.updatePercentage()}setImportance(t){this.importance=t,this.manager.updatePercentage()}}class Mt extends Q{constructor(){super();let t=new Z({text:"Google",icon:"img/socialIcons/google.svg",width:170,onClick:t=>{p.accounts.signInGoogle()}});this.el.appendChild(t.el);let e=new Z({text:"Facebook",icon:"img/socialIcons/facebook.svg",width:170,onClick:t=>{p.accounts.signInFb()}});this.el.appendChild(e.el),this.destructed=!1,this.waitForSignedInClose()}destructor(){super.destructor(),this.destructed=!0}async waitForSignedInClose(){await p.accounts.waitForSignedIn(),this.destructed||await this.close()}}class Tt{constructor(){this.el=document.createElement("div"),this.el.classList.add("mainMenu","fullScreen"),document.body.appendChild(this.el),this.topSpacer=document.createElement("div"),this.topSpacer.classList.add("mainMenuTopSpacer"),this.el.appendChild(this.topSpacer),this.nameElsContainer=document.createElement("div"),this.nameElsContainer.classList.add("mainMenuPlayerList"),this.el.appendChild(this.nameElsContainer),this.newPlayerButtonContainer=document.createElement("div"),this.newPlayerButtonContainer.classList.add("newPlayerButtonContainer"),this.nameElsContainer.appendChild(this.newPlayerButtonContainer),this.newPlayerButton=document.createElement("div"),this.newPlayerButton.classList.add("genericUIBox","mainMenuPlayerItem","newPlayerButton"),this.newPlayerButtonContainer.appendChild(this.newPlayerButton),this.newPlayerButtonIcon=document.createElement("div"),this.newPlayerButtonIcon.classList.add("newPlayerButtonIcon"),this.newPlayerButton.appendChild(this.newPlayerButtonIcon),this.newPlayerButton.addEventListener("click",t=>{this.addNewPlayerAnimate()}),CORDOVA||(this.adContainer=document.createElement("div"),this.adContainer.classList.add("mainMenuAdBox","genericUIBox","thisDefinitelyWontGetBlockedByAdblockers"),this.el.appendChild(this.adContainer),this.adContent=document.createElement("div"),this.adContent.classList.add("mainMenuAdContent","itchBanner"),this.adContainer.appendChild(this.adContent),this.ad=document.createElement("div"),this.ad.id="nuggetroyale-io_300x250_2",this.ad.classList.add("pokiBanner"),this.adContent.appendChild(this.ad)),this.storeButtons=document.createElement("div"),this.storeButtons.classList.add("storeButtons","hideWithPokiSDK"),document.body.appendChild(this.storeButtons),this.storeButtons.appendChild(this.createStoreButton("img/stores/appleAppStore.svg","https://apps.apple.com/app/id1453974558")),this.storeButtons.appendChild(this.createStoreButton("img/stores/googlePlayStore.svg","https://play.google.com/store/apps/details?id=co.pelicanparty.nuggetroyale")),this.playerNameUIs=[],this.didJoinGameOnce=!1,this.waitForJoinGameCbs=[],this.visible=!0,this.bgAudio=null,this.didShowUpdateAvailable=!1,this.updateAvailableAlert=null,this.isNewPlayerAnimating=!1,this.lastRefreshAdTime=0,this.socialMenu=new Ot,this.changeLog=new nt,this.featuredInfluencer=new ut,window.addEventListener("keypress",t=>{"Enter"!=t.code&&"Enter"!=t.key||!this.visible||this.joinGame()}),window.addEventListener("keydown",t=>{"Escape"!=t.code&&"Escape"!=t.key||!this.didJoinGameOnce||this.setVisibility(!this.visible)}),qt.addListener(t=>{this.onResize()}),this.onResize()}async init(){this.loadBackground(),this.bgAudio=await p.sfx.getSound("menu/ambient"),this.bgAudio&&this.bgAudio.play(),this.socialMenu.init(),this.changeLog.init(),this.featuredInfluencer.init(),this.setVisibility(!0),p.input.onJumpAnyControllable(t=>{this.joinGame()}),p.game.debugMainGame&&(this.didJoinGameOnce=!0,this.setVisibility(!1)),this.refreshAd()}async loadBackground(){p.poki.gameLoadingStart(),p.loadScreen.requestLoadingPart(.15).setPercentage(1);let t=p.loadScreen.requestLoadingPart(.85),e=await p.assets.getMainMenuWall(e=>{t.setPercentage(e)});await p.game.addMainMenuBackground(e),p.loadScreen.setVisibility(!1),Zt.gaEvent("pageLoad","menuVisible"),Zt.gaTiming("pageLoad","menuVisible")}async addNewPlayerAnimate(){this.isNewPlayerAnimating=!0,p.localPlayerManager.addLocalPlayer();let t=this.playerNameUIs[this.playerNameUIs.length-1],e=window.getComputedStyle(t.el);this.newPlayerButton.style.height=e.height;let i=parseFloat(e.marginLeft)+parseFloat(e.marginRight),n=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),s=parseFloat(e.borderLeftWidth)+parseFloat(e.borderRightWidth);this.newPlayerButtonContainer.style.width=parseFloat(e.width)+i+n+s+"px",this.newPlayerButton.classList.add("opening"),t.el.style.display="none",t.setContentVisibility(!1,!0),p.sfx.playSound("menu/swoosh"),await Kt.promise(300),this.newPlayerButtonContainer.style.width=null,Zt.skipCssTransition(this.newPlayerButtonContainer),this.setAddPlayerButtonColor(),this.newPlayerButton.style.height=null,this.newPlayerButton.classList.remove("opening"),Zt.skipCssTransition(this.newPlayerButton),this.updateNewPlayerButtonVisibility(),t.el.style.display=null,Zt.skipCssTransition(t.el),t.setContentVisibility(!0),this.isNewPlayerAnimating=!1}updateLocalPlayerCount(t){for(;this.playerNameUIs.length!=t;)this.playerNameUIs.length<t?this.addNewPlayerEl():this.playerNameUIs.length>t&&this.removePlayerEl(this.playerNameUIs[this.playerNameUIs.length-1]);for(let e=0;e<this.playerNameUIs.length;e++){let t=this.playerNameUIs[e];t.setCloseButtonVisibility(0!=e&&e==this.playerNameUIs.length-1),t.updatePlaceholder()}this.isNewPlayerAnimating||(this.setAddPlayerButtonColor(),this.updateNewPlayerButtonVisibility()),this.changeLog.setVisibility(),this.featuredInfluencer.setVisibility()}addNewPlayerEl(){let t=new Ct(this.playerNameUIs.length);this.playerNameUIs.push(t),this.nameElsContainer.insertBefore(t.el,this.newPlayerButtonContainer),t.focusTextField()}removePlayerEl(t){let e=this.playerNameUIs.indexOf(t);e>=0&&this.playerNameUIs.splice(e,1),this.nameElsContainer.removeChild(t.el),t.destructor()}setAddPlayerButtonColor(){p.colors.stylePlayerColorGradient(this.newPlayerButton,this.playerNameUIs.length)}updateNewPlayerButtonVisibility(){let t=this.playerNameUIs.length<p.localPlayerManager.maxPlayerCount;CORDOVA&&(t=!1),this.newPlayerButton.style.display=t?null:"none"}testRemapKeyExists(t,e){for(const i of this.playerNameUIs){let n=i.testRemapKeyExists(t,e);if(n)return n}}getRemapButton(t){return this.playerNameUIs[0].getRemapButton(t)}async joinGame(){if(this.visible){if(this.defocusNameFields(),!this.didJoinGameOnce){p.poki.usePokiSdk&&await p.ads.doPreroll(),p.loadScreen.resetLoadingParts();let t=p.loadScreen.requestLoadingPart(.25),e=p.loadScreen.requestLoadingPart(.5),i=p.loadScreen.requestLoadingPart(.25);if(p.game.didLoadEnvironment&&t.setPercentage(1),p.loadScreen.setOrangeColor(),await p.loadScreen.setVisibility(!0),p.assets.main.loaded?e.setPercentage(1):p.assets.main.onProgress(t=>{e.setPercentage(t)}),!p.game.didLoadEnvironment){let e=p.game.getEnvironmentLoadProgress();p.game.onEnvironmentLoadProgress(i=>{let n=Zt.mapValue(e,1,0,1,i);t.setPercentage(n)}),await p.game.waitForEnvironmentLoad()}await p.game.loadMaterialsAndTextures(t=>{i.setPercentage(t)}),await p.loadScreen.setVisibility(!1),Zt.gaEvent("pageLoad","lobbyVisible"),Zt.gaTiming("pageLoad","lobbyVisible"),this.didJoinGameOnce=!0;for(const n of this.waitForJoinGameCbs)n();this.waitForJoinGameCbs=[]}this.setVisibility(!1),p.localPlayerManager.activateControllable()}}async waitForJoinGame(){if(!this.didJoinGameOnce)return await new Promise(t=>{this.waitForJoinGameCbs.push(t)})}async showUpdateAvailable(){if(this.didShowUpdateAvailable)return;this.didShowUpdateAvailable=!0,this.updateAvailableAlert=new $("There's an update available for the game.",["reload"]),0==await this.updateAvailableAlert.waitForButtonResponse()&&window.location.reload(),this.updateAvailableAlert=null}async showServerVersionMismatch(){this.updateAvailableAlert&&await this.updateAvailableAlert.waitForButtonResponse(),new $("Your version of Nugget Royale is too old. You won't be able to play online.")}defocusNameFields(){p.mainMenu.playerNameUIs.map(t=>t.nameBox).includes(document.activeElement)&&document.activeElement.blur()}createStoreButton(t,e){let i=document.createElement("a");i.classList.add("storeButton"),i.href=e,i.target="_blank";let n=document.createElement("img");return n.src=t,n.width=200,i.appendChild(n),i}refreshAd(){let t=Date.now();t-this.lastRefreshAdTime>3e4&&(this.lastRefreshAdTime=t,p.ads.refreshAdinplayBannerAd(this.ad))}offsetUI(t,e){this.el.style.transform=`translate(${t}px, ${e}px) scale(1.05)`}onResize(){this.setAdContainerPosition()}setAdContainerPosition(){if(!this.adContainer)return;let t=window.innerHeight>740;this.adContainer.classList.toggle("bottom",t),this.adContainer.classList.toggle("left",!t);let e=!1;t?this.adContainer.parentElement!=this.el&&(this.el.appendChild(this.adContainer),e=!0):this.adContainer.parentElement!=this.nameElsContainer&&(this.nameElsContainer.insertBefore(this.adContainer,this.nameElsContainer.firstChild),e=!0),e&&p&&(p.ads.refreshAdinplayBannerAd(this.ad,!0),p.ads.refreshPokiBannerAd(this.ad))}setVisibility(t){this.el.style.display=t?null:"none",p.ads.setMobileBannerVisibility(t),t!=this.visible&&(this.visible=t,t&&this.refreshAd(),p.network.sendMenuVisible()),this.updateUIVisibilities(),p.game.lights.setInMenu(t),t?this.bgAudio&&this.bgAudio.play():this.bgAudio&&this.bgAudio.stop(),t&&p.cam.onMainMenuVisible(),t?p.game.setMenuVisibility(!0):window.setTimeout(t=>{this.visible||p.game.setMenuVisibility(!1)},1e3)}updateUIVisibilities(){p.appearanceMenuManager.setVisibility(),p.leaderboard.setVisibility(),p.cornerSettings.setVisibility(),p.levelUI.setVisibility(),p.input.touch.setVisibility(),p.game.updateUIVisibilities(),p.cornerSettings.setButtonsVisibility(),p.cornerStats.setVisibility(),this.socialMenu.setVisibility(),this.changeLog.setVisibility(),this.featuredInfluencer.setVisibility(),p.network.setBadConnectionIcon(),p.ads.updatePokiBannerVisibility(),this.storeButtons.classList.toggle("hidden",!p.mainMenu.visible)}}class Ct{constructor(t){if(this.index=t,this.el=document.createElement("div"),this.el.classList.add("genericUIBox","mainMenuPlayerItem"),this.playerColors=p.colors.getPlayerColorFromId(t),p.colors.stylePlayerColorGradient(this.el,t),this.contentEl=document.createElement("div"),this.contentEl.classList.add("mainMenuPlayerItemContainer"),this.el.appendChild(this.contentEl),!CORDOVA){this.remapButtonsContainer=document.createElement("div"),this.remapButtonsContainer.classList.add("remapButtonsContainer"),this.contentEl.appendChild(this.remapButtonsContainer),this.inputPlayer=p.localPlayerManager.localPlayers[t].inputs[0],this.remapButtons=[this.remapButtonUp=new It("up",{value:this.inputPlayer.keys.up}),this.remapButtonLeft=new It("left",{value:this.inputPlayer.keys.left}),this.remapButtonDown=new It("down",{value:this.inputPlayer.keys.down}),this.remapButtonRight=new It("right",{value:this.inputPlayer.keys.right}),this.remapButtonJump=new It("jump",{value:this.inputPlayer.keys.jump})];for(const t of this.remapButtons)this.remapButtonsContainer.appendChild(t.containerEl),t.onValueChange(e=>{if(this.inputPlayer.remapKey(t.keyType,e),e&&p.mainMenu.testRemapKeyExists(e,[t]))return!0;p.input.clearSideInputWithKey(e),this.saveRemapButtons()});this.loadRemapButtons(),this.horizontalLine=document.createElement("div"),this.horizontalLine.classList.add("mainMenuHorizontalLine"),this.contentEl.appendChild(this.horizontalLine)}this.nameBox=document.createElement("input"),this.updatePlaceholder(),this.nameBox.classList.add("playerNameBox","inputNoMarkup"),this.nameBox.maxLength=30,this.nameBox.autocomplete="off",this.nameBox.autocorrect="off",this.nameBox.autocapitalize="off",this.nameBox.spellcheck=!1,this.nameBox.addEventListener("input",t=>{this.onNameChange()}),this.contentEl.appendChild(this.nameBox),this.loadName(),0==t&&(this.playButton=new Lt,this.contentEl.appendChild(this.playButton.el)),this.closeButton=document.createElement("div"),this.closeButton.classList.add("circleButton","closeButton"),this.closeButton.addEventListener("click",t=>{p.sfx.playSound("paperbag"),p.localPlayerManager.removeLocalPlayer()}),this.contentEl.appendChild(this.closeButton)}destructor(){for(const t of this.remapButtons)t.destructor();this.remapButtons=[],this.remapButtonUp=null,this.remapButtonLeft=null,this.remapButtonDown=null,this.remapButtonRight=null,this.remapButtonJump=null,this.el=null,this.contentEl=null,this.nameBox=null,this.remapButtonsContainer=null,this.inputPlayer=null,this.closeButton=null}updatePlaceholder(){let t=p.mainMenu.playerNameUIs.length>1;this.nameBox.placeholder=t?"Player "+(this.index+1):"Enter your name"}async loadName(){let t=await zt.get("playerName"+this.index);t&&(this.nameBox.value=t),this.setStatsName()}async saveRemapButtons(){zt.set("keyboardMappings"+this.index,{left:this.remapButtonLeft.currentValue,right:this.remapButtonRight.currentValue,up:this.remapButtonUp.currentValue,down:this.remapButtonDown.currentValue,jump:this.remapButtonJump.currentValue})}async loadRemapButtons(){let t=await zt.get("keyboardMappings"+this.index);t&&(this.remapButtonLeft.setNewValue(t.left),this.remapButtonRight.setNewValue(t.right),this.remapButtonUp.setNewValue(t.up),this.remapButtonDown.setNewValue(t.down),this.remapButtonJump.setNewValue(t.jump))}testRemapKeyExists(t,e=[]){for(const i of this.remapButtons)if(!(e.indexOf(i)>=0)&&i.currentValue==t)return i}getRemapButton(t){switch(t){case"left":return this.remapButtonLeft;case"right":return this.remapButtonRight;case"up":return this.remapButtonUp;case"down":return this.remapButtonDown;case"jump":return this.remapButtonJump}}clearWrongNameChars(){this.nameBox.value=this.nameBox.value.replace(/[\r\n\v\t]+/g,"")}onNameChange(){this.clearWrongNameChars(),zt.set("playerName"+this.index,this.nameBox.value),this.setStatsName(),p.hats.testHatUnlockName(this.nameBox.value,this.index)}setStatsName(){p.localPlayerManager.localPlayers[this.index].stats.setName(this.nameBox.value)}focusTextField(){this.nameBox.focus()}setCloseButtonVisibility(t){this.closeButton.style.display=t?null:"none"}setContentVisibility(t,e=!1){this.contentEl.style.opacity=t?1:0,e&&Zt.skipCssTransition(this.contentEl)}}class Pt{constructor(){this.curtainEl=document.createElement("div"),this.curtainEl.classList.add("menuCurtain","fullScreen"),document.body.appendChild(this.curtainEl),this.elemsNeedingCurtain=[],this.forcingZIndex=null,this.currentZIndex=0,this.setZTimeout=new Kt(()=>{this.setZIndex()},500),this._isVisible=!1,this.curtainEl.addEventListener("click",this.onCurtainClick.bind(this)),this.updateStyle()}get isVisible(){return this._isVisible}addElemNeedsCurtain(t){this.elemsNeedingCurtain.indexOf(t)<0&&(this.elemsNeedingCurtain.push(t),this.updateStyle())}removeElemNeedsCurtain(t){let e=this.elemsNeedingCurtain.indexOf(t);e>=0&&this.elemsNeedingCurtain.splice(e,1),this.updateStyle()}forceZIndex(t){this.forcingZIndex=t,this.updateStyle()}updateStyle(){let t=this.elemsNeedingCurtain.length>0||this.forcingZIndex;if(this.curtainEl.style.visibility=t?"visible":"hidden",this.curtainEl.style.opacity=t?1:0,this.forcingZIndex)this.animateZIndex(this.forcingZIndex);else if(t){let t=0;for(let e of this.elemsNeedingCurtain){e instanceof Q&&(e=e.el);let i=window.getComputedStyle(e).zIndex;i&&(t=Math.max(i,t))}this.animateZIndex(t-1)}this._isVisible=!!t}setZIndex(t=!0){this.curtainEl.style.zIndex=this.currentZIndex}animateZIndex(t){if(t==this.currentZIndex)return;let e=this.currentZIndex;this.currentZIndex=t,e>t?(this.setZIndex(!0),this.setZTimeout.stop()):this.setZTimeout.start()}testIsAboveEl(t){return this.isVisible&&this.currentZIndex>window.getComputedStyle(t).zIndex}onCurtainClick(){this.doTopMenuCloseRequest("curtainClick")}doTopMenuCloseRequest(t){let e=0,i=null;for(let n of this.elemsNeedingCurtain){let t=n instanceof Q?n.el:n,s=window.getComputedStyle(t).zIndex;s&&(e=Math.max(s,e),i=n)}null!=i&&i instanceof Q&&i.onCloseRequest(t)}}class _t extends dt{constructor(t){super({invertCircleMask:!1}),this.el.classList.add("newHatUIContainer"),this.hatContainer=document.createElement("div"),this.hatContainer.classList.add("newHatUICanvasContainer"),this.hatContainer.classList.add("hidden"),this.el.appendChild(this.hatContainer),this.hat=new yt({canvasSize:500}),this.hatContainer.appendChild(this.hat.canvasContainer),this.hatId=t,this.done=!1,this.waitForDisappearCbs=[],this.nameBanner=new it("",{top:"30%"}),this.nameBanner.init(),this.textsShouldBeVisible=!1,this.hatName=null,this.desc=null,this.descTitle=null,this.loadHat()}destructor(){super.destructor(),this.hatContainer=null,this.hat.destructor(),this.hat=null,this.nameBanner.destructor(),this.nameBanner=null}async loadHat(){let t=await p.hats.getHatObject(this.hatId);this.hat.loadHat(t),this.desc=t.hatDescription,this.hatName=t.hatName,this.setTextsVisibility(),await this.animate()}async animate(){p.sfx.playSound("hatUnlock"),await Kt.promise(1800),this.setTextsVisible(!0),this.setVisible(!0),this.setCircleScale(0,!0),this.hatContainer.classList.remove("hidden"),await Kt.promise(150),this.setCircleScale(.6),await Kt.promise(4e3),p.sfx.playSound("hatUnlockExit"),this.hatContainer.classList.add("hidden"),this.setTextsVisible(!1),await Kt.promise(70),this.setCircleScale(0),await Kt.promise(500),this.setVisible(!1),this.done=!0;for(const t of this.waitForDisappearCbs)t();this.waitForDisappearCbs=[]}setTextsVisibility(){this.textsShouldBeVisible?(this.hatName&&!this.nameBanner.visible&&(this.nameBanner.setText(this.hatName),this.nameBanner.setVisible(!0)),this.desc&&!this.descTitle&&(this.descTitle=new pt(this.desc,{color:0,multiLine:!1,maxWidth:1.5*this.circleRadius,maxFitScale:.4,top:"80%",animationType:"hideBottom"}))):(this.descTitle&&(this.descTitle.hide(),this.descTitle=null),this.nameBanner.visible&&this.nameBanner.setVisible(!1))}setTextsVisible(t){this.textsShouldBeVisible=t,this.setTextsVisibility()}loop(t,e){this.hat.render(t)}async waitForDisappear(){if(!this.done)return await new Promise(t=>{this.waitForDisappearCbs.push(t)})}}class At extends Q{constructor(){super();let t=document.createElement("h2");t.textContent="Partners",this.el.appendChild(t);let e=document.createElement("ul");e.classList.add("partnersList"),this.el.appendChild(e);let i=[{text:"Conmeego",url:"https://www.conmeego.io/"},{text:"Game Keys",url:"https://gameskeys.net/product/nugget-royale/"},{text:"GamingGuides",url:"https://gaminguides.com/ducklings-io/"},{text:"igroutka",url:"https://igroutka.ru/igry-io/28766-nuggetroyaleio.html"},{text:"Crazy Games",url:"https://www.crazygames.com/c/io"},{text:"Insane Games",url:"https://insanegames.io/"},{text:"More IO Games",url:"http://iogames.space"},{text:"GamesDonkey",url:"https://www.gamesdonkey.com/"},{text:"Addicting Games",url:"https://www.addictinggames.com/"},{text:"SilverGames",url:"https://www.silvergames.com/en/iogames"},{text:"Gamez.io",url:"https://www.Gamez.io"},{text:"Supegames.com",url:"http://supegames.com/3d-games/ducklings-io/"},{text:"Yaks Games",url:"https://yaksgames.com/category/.io-games"},{text:"Iogames.live",url:"https://iogames.live/best-io-games/"},{text:"vitalitygames.com",url:"https://www.vitalitygames.com"},{text:"Zuzu.games",url:"https://www.zuzu.games/"},{text:"Brightygames.com",url:"https://www.brightestgames.com/game/double-dodgers"},{text:"Play IO Games",url:"http://iogames.fun"}];for(const n of i){let t=document.createElement("li");e.appendChild(t);let i=document.createElement("a");i.textContent=n.text,i.href=n.url,i.target="_blank",t.appendChild(i)}}}class Lt{constructor(){this.el=document.createElement("div"),this.el.classList.add("joinGameButtonContainer"),this.joinGameButton=new Z({text:"Play",sideType:"invBanner",color:"blue3",addClasses:["playButton"],onClick:t=>{"false"!=Zt.lsGet("playButtonConsent")&&Zt.lsSet("playButtonConsent",!0),p.sfx.playSound("nuggetBite1"),p.mainMenu.joinGame()}}),this.el.appendChild(this.joinGameButton.el);let t=document.createElement("a");t.textContent="privacy policy",t.href="/privacy",t.target="_blank",CORDOVA&&t.addEventListener("click",t=>{t.preventDefault(),new Rt}),p.poki.usePokiSdk||(this.consentText=document.createElement("div"),this.consentText.classList.add("joinGameConsentText"),this.el.appendChild(this.consentText),"false"==Zt.lsGet("playButtonConsent")?(this.consentText.appendChild(document.createTextNode("You have opted out of cookies, visit our ")),this.consentText.appendChild(t),this.consentText.appendChild(document.createTextNode(" for more info on cookies or to opt back in."))):(this.consentText.appendChild(document.createTextNode("We use cookies. By clicking Play you agree to allow cookies to be placed. You can view our ")),this.consentText.appendChild(t),this.consentText.appendChild(document.createTextNode(" for more info on cookies or to opt out."))))}}class Rt{constructor(){this.container=document.createElement("div"),this.container.classList.add("privacyPopupContainer"),document.body.appendChild(this.container),this.iframe=document.createElement("iframe"),this.iframe.src="https://nuggetroyale.io/privacy?t="+VERSION_TIMESTAMP,this.iframe.classList.add("privacyIframe"),this.iframe.addEventListener("load",t=>{this.iframe.contentWindow.postMessage("startListenConsentChanges","*")}),this.container.appendChild(this.iframe),this.closeButton=document.createElement("div"),this.closeButton.classList.add("circleButton","closeButton","privacyCloseButton"),this.closeButton.addEventListener("click",t=>{this.destructor()}),this.container.appendChild(this.closeButton),this.boundOnMessage=this.onMessage.bind(this),window.addEventListener("message",this.boundOnMessage)}destructor(){this.container.parentElement.removeChild(this.container),this.container=null,this.iframe=null,this.closeButton=null,window.removeEventListener("message",this.boundOnMessage)}onMessage(t){if(!t.data)return;let e;try{e=JSON.parse(t.data)}catch(t){}if(!e)return;if(!("currentConsentState"in e))return;let i=!!e.currentConsentState;Zt.lsSet("playButtonConsent",i)}}class It{constructor(t,e){e={...{value:"",allowRemapping:!0,onValueChange:null,onClick:null,allowKeyClick:!1,masterRemapButton:null},...e},this.visible=!0,this.keyType=t,this.isRemapping=!1,this.onValueChangeCbs=[],this.onClickCbs=[],this.allowRemapping=e.allowRemapping,this.allowKeyClick=e.allowKeyClick,e.onValueChange&&this.onValueChange(e.onValueChange),e.onClick&&this.onClick(e.onClick),this.containerEl=document.createElement("div"),this.containerEl.style.gridArea=t,this.el=document.createElement("button"),this.currentValue=e.value,this.el.classList.add("remapButton","inputNoMarkup"),this.el.classList.toggle("allowHover",this.allowKeyClick||e.allowRemapping),this.containerEl.appendChild(this.el),this.masterRemapButton=e.masterRemapButton,this.masterRemapButton&&(this.currentValue=this.masterRemapButton.currentValue,this.boundMasterOnValueChange=(t=>{this.currentValue=t,this.setButtonText()}),this.masterRemapButton.onValueChange(this.boundMasterOnValueChange)),this.el.addEventListener("click",t=>{t.stopPropagation(),this.click()}),this.boundOnKeyDown=(t=>{this.onKey(t,"down")}),window.addEventListener("keydown",this.boundOnKeyDown),this.boundOnKeyUp=(t=>{this.onKey(t,"up")}),window.addEventListener("keyup",this.boundOnKeyUp),this.el.addEventListener("blur",t=>{this.cancelRemapping()}),this.setButtonText(),this.boundLayoutChange=(t=>{this.setButtonText()}),p.input.keyboardLayouts.onLayoutInfoChange(this.boundLayoutChange)}destructor(){this.el=null,this.masterRemapButton&&(this.masterRemapButton.removeOnValueChange(this.boundMasterOnValueChange),this.masterRemapButton=null),window.removeEventListener("keydown",this.boundOnKeyDown),window.removeEventListener("keyup",this.boundOnKeyUp),p.input.keyboardLayouts.removeOnLayoutInfoChange(this.boundLayoutChange)}click(){this.allowRemapping&&(this.isRemapping=!0,this.setButtonText());for(const t of this.onClickCbs)t();p.sfx.playSound("menu/click")}onKey(t,e){if("INPUT"==document.activeElement.tagName)return;if(!this.visible)return;let i=t.code;if(i||(i=t.keyCode),this.isRemapping){if("Escape"==i)return void this.cancelRemapping();t.preventDefault(),this.isRemapping=!1,this.setNewValue(i)}else this.allowKeyClick&&i==this.currentValue&&("down"==e?this.forceDown(!0):"up"==e&&(this.forceDown(!1),this.click()))}setNewValue(t){if(t!=this.currentValue){let e=this.currentValue;this.currentValue=t;for(const t of this.onValueChangeCbs){if(t(this.currentValue)){this.setNewValue(e);break}}}this.setButtonText()}cancelRemapping(){this.isRemapping=!1,this.setButtonText()}setButtonText(){if(this.isRemapping)this.el.textContent="[?]";else{let t=this.currentValue;this.el.textContent=p.input.keyboardLayouts.getVisualKeyForCode(t)}}onValueChange(t){this.onValueChangeCbs.push(t)}removeOnValueChange(t){let e=this.onValueChangeCbs.indexOf(t);e>=0&&this.onValueChangeCbs.splice(e,1)}onClick(t){this.onClickCbs.push(t)}forceDown(t){this.el.classList.toggle("forceDown",t)}setVisibility(t){this.visible=t,this.el.style.display=t?null:"none"}}class Ot{constructor(){this.visible=!1;this.el=document.createElement("div"),this.el.classList.add("socialContainer"),document.body.appendChild(this.el),this.createButton({icon:"img/socialIcons/twitter.svg",iconSize:.8,color:"#1b95e0",url:"https://twitter.com/NuggetRoyale"}),this.createButton({icon:"img/socialIcons/instagram.svg",iconSize:.8,color:"#f10176",url:"https://www.instagram.com/nuggetroyale/"}),this.createButton({icon:"img/socialIcons/youtube.svg",iconSize:.8,color:"#b31217",url:"https://www.youtube.com/channel/UCS7yitQSV06QZdSHtpoinxA"}),this.createButton({icon:"img/socialIcons/discord.svg",iconSize:.8,color:"#7289da",url:"https://discord.gg/7UaZT92"}),this.createButton({icon:"img/socialIcons/twitch.svg",iconSize:.8,color:"#6441A4",url:"https://www.twitch.tv/directory/game/Nugget%20Royale"}),this.shareHatContainer=document.createElement("div"),this.shareHatContainer.classList.add("shareHatContainer"),document.body.appendChild(this.shareHatContainer),this.facebookShareHat=new Dt({icon:"img/socialIcons/hatShare/facebookShare.svg",url:"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fnuggetroyale.io%2F&display=popup&ref=plugin&src=like&kid_directed_site=0&app_id=371757996756993",storageName:"didShareFacebook",hatId:1}),this.twitterShareHat=new Dt({icon:"img/socialIcons/hatShare/twitterShare.svg",url:"https://twitter.com/intent/tweet?hashtags=nuggetroyale&related=nuggetroyale%3AOfficial%20Twitter%20account%2Cpelican_party%3ADeveloper%2C&text=Chicken%20nuggets%20are%20the%20new%20currency&tw_p=tweetbutton&url=http%3A%2F%2Fnuggetroyale.io",storageName:"didShareTwitter",hatId:2}),this.shareHats=[this.facebookShareHat,this.twitterShareHat];for(const n of this.shareHats)this.shareHatContainer.appendChild(n.el);let t=document.createElement("div");t.classList.add("shareHatArrowText"),this.shareHatContainer.appendChild(t);let e=document.createElement("div");e.classList.add("shareHatArrow"),t.appendChild(e);let i=document.createElement("span");i.classList.add("shareHatText"),i.textContent="Share to unlock party hats",t.appendChild(i)}init(){for(const t of this.shareHats)t.init()}createButton({icon:t=null,iconSize:e=1,color:i=null,url:n="",openAsWindow:s=!1}={}){let r=document.createElement("div");if(r.classList.add("socialButton"),r.style.background=i,t){let i=document.createElement("div");i.classList.add("socialIcon"),i.style.backgroundImage=`url(${t})`,i.style.transform=`scale(${e})`,r.appendChild(i)}r.addEventListener("click",t=>{s?Ot.openWindow(n):window.open(n)}),this.el.appendChild(r)}setVisibility(){let t=p.mainMenu.visible||!p.game.gameStateManager.isInLobby&&!p.game.hasControllablePlayer();CORDOVA&&(t=!1),p.cam.controller.isControlling&&(t=!1),this.el.classList.toggle("hidden",!t);let e=!0;for(const n of this.shareHats)if(!n.didShare){e=!1;break}let i=(p.mainMenu.visible||!p.game.hasControllablePlayer()||p.game.gameStateManager.isInLobby)&&!e;CORDOVA&&(i=!1),p.cam.controller.isControlling&&(i=!1),this.shareHatContainer.classList.toggle("hidden",!i),this.shareHatContainer.classList.toggle("small",p.cornerStats.visible)}static openWindow(t,e){let i=(screen.width-500)/2,n=(screen.height-700)/2;window.open(t,e,`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=500, height=700, left=${i}, top=${n}`)}}class Dt{constructor({icon:t=null,url:e="null",storageName:i=null,hatId:n=-1}={}){this.el=document.createElement("div"),this.el.classList.add("shareHat"),this.el.style.backgroundImage=`url(${t})`,this.hatId=n,this.boundMakeAvailableThings=this.makeAvailableThings.bind(this),this.el.addEventListener("click",t=>{Ot.openWindow(e,"Share to unlock a party hat"),window.addEventListener("focus",this.boundMakeAvailableThings)}),this.storageName=i,this.didShare=!0}init(){this.loadStorageValue()}makeAvailableThings(){this.makeHatAvailable(),this.didShare=!0,zt.set(this.storageName,!0),this.setVisibility(),window.removeEventListener("focus",this.boundMakeAvailableThings)}async loadStorageValue(){this.didShare=await zt.get(this.storageName),this.didShare=!!this.didShare,this.didShare&&this.makeHatAvailable(!1),this.setVisibility()}makeHatAvailable(t=!0){p.hats.makeHatIdAvailable(this.hatId,t,!0)}setVisibility(){this.el.style.display=this.didShare?"none":null,p.mainMenu.socialMenu.setVisibility()}}class kt{constructor(){this.renderer=null,this.width=0,this.height=0}init(){this.renderer=new THREE.WebGLRenderer({alpha:!0}),this.renderer.shadowMap.enabled=!0,this.renderer.gammaOutput=!0,this.renderer.toneMapping=THREE.Uncharted2ToneMapping,this.renderer.toneMappingExposure=.1,this.renderer.toneMappingWhitePoint=.1}onResize(t,e){let i=p.renderer._resolutionMultiplier;this.width=window.innerWidth*i,this.height=window.innerHeight*i,this.renderer.setSize(this.width,this.height,!1)}render(t,e,i,n){let s=p.renderer._resolutionMultiplier;return s=1,t*=1,e*=1,this.renderer.setViewport(0,this.height-e,t,e),this.renderer.render(i,n),{el:this.renderer.domElement,w:t,h:e}}}class Bt extends dt{constructor(){super(),this.el.classList.add("winnerScreenContainer"),this.winnerTitle=null,this.nameBanner=new it,this.winTexts=[],this.drawTexts=[],this.defaultNames=[]}async init(){this.nameBanner.setVisible(!1),this.nameBanner.init(),this.winTexts=await p.staticConfig.getDataSet("win_texts"),this.drawTexts=await p.staticConfig.getDataSet("draw_texts"),this.defaultNames=await p.staticConfig.getDataSet("default_names")}async startWinAnimation(t,e){if(await p.music.waitForMusicStopPlaying(),await Kt.promise(200),!p.mainMenu.didJoinGameOnce)return;if(p.sfx.playSound("winnerJingle"),p.mainMenu.visible)return;this.hideWinnerTitle(),this.setLinesOpacity(.8),this.setVisible(!0),this.setCircleScale(4.5,!0),this.setCircleScale(1);let i="";t==ft.WinnerNameType.DRAW?(i=Zt.randFromArray(this.drawTexts),this.winnerTitle=new pt(i,{color:4,maxWidth:1.5*this.circleRadius})):(t==ft.WinnerNameType.NAMELESS&&(e=Zt.randFromArray(this.defaultNames)),this.nameBanner.setText(e),this.nameBanner.setVisible(!0),i=Zt.randFromArray(this.winTexts),this.winnerTitle=new pt(i,{color:0,multiLine:!1,maxWidth:1.5*this.circleRadius,maxFitScale:.4,top:"60%"})),await Kt.promise(5e3),this.hideWinnerTitle(),this.nameBanner.setVisible(!1),this.setCircleScale(0),this.setLinesOpacity(1),await p.game.gameStateManager.waitForGamestate(ft.GameState.WAITING_FOR_PLAYERS),this.setCircleScale(4.5),await Kt.promise(500),this.setVisible(!1)}hideWinnerTitle(){this.winnerTitle&&(this.winnerTitle.hide(),this.winnerTitle=null)}}class Ht{constructor(){this.cachedItems={}}async getItem(t,e="main"){let i=this.cachedItems[t];if(i){if("loading"==i.state)return await new Promise(t=>i.onLoadCbs.push(t));if("loaded"==i.state)return i.obj}i={state:"loading",obj:null,onLoadCbs:[]},this.cachedItems[t]=i;let n=null;if(e){let i=p.assets[e];i||(i=p.assets.getPackage(e)),t.endsWith(".json")?n=await i.getJsonObject(t):t.endsWith(".glb")&&(n=await i.getGltfObject(t))}else if(t.endsWith(".png"))(n=(new THREE.TextureLoader).load(t)).flipY=!1;else{let e=await Zt.cordovaFetch(t);if(!e.ok)return null;if(t.endsWith(".json")){let t=await e.json();n=Nt.getJsonObject(t)}else if(t.endsWith(".glb")){let t=await e.arrayBuffer();n=await Nt.getGltfObjectFromArrayBuffer(t)}}i.state="loaded",i.obj=n;for(const s of i.onLoadCbs)s(n);return n}}class Nt{constructor(t){this.isDownloading=!1,this.loaded=!1,this.url=t,this.arrayBuffer=null,this.fileLocations=[],this.onLoadCbs=[],this.onProgressCbs=[],this.lastProgressValue=0,this.textureCache={}}async startDownloading(){if(this.loaded)return;if(this.isDownloading)return await this.waitForLoad();this.isDownloading=!0;let t=await Zt.requestWithProgress(this.url,t=>{for(const e of this.onProgressCbs)e(t);this.lastProgressValue=t});p.serviceWorker.storeCache(this.url,t),this.arrayBuffer=await new Response(t).arrayBuffer(),this.parseFilePositions(),this.loaded=!0;for(const e of this.onLoadCbs)e();this.onLoadCbs=[],this.onProgressCbs=[],this.isDownloading=!1}parseFilePositions(){let t=0;for(;t<this.arrayBuffer.byteLength;){let e=new Uint32Array(this.arrayBuffer,t,1)[0],i=new Uint8Array(this.arrayBuffer,t+4,e),n=new TextDecoder("utf-8").decode(i);e%4!=0&&(e=4*Math.ceil(e/4));let s=new Uint32Array(this.arrayBuffer,t+4+e,1)[0];this.fileLocations.push({path:n,start:t+4+e+4,length:s}),s%4!=0&&(s=4*Math.ceil(s/4)),t+=4+e+4+s}}onLoad(t){this.loaded?t():this.onLoadCbs.push(t)}onProgress(t){this.loaded?t(1):this.onProgressCbs.push(t)}async waitForLoad(){if(!this.loaded)return await new Promise((t,e)=>{this.onLoad(e=>{t()})})}async getFileAsBuffer(t){this.loaded||await this.waitForLoad();for(const e of this.fileLocations)if(e.path==t)return this.arrayBuffer.slice(e.start,e.start+e.length);return console.warn("trying to load asset "+t+" but it does not exist!"),null}async getAsObjectUrl(t,e){let i=await this.getFileAsBuffer(t),n=new Blob([new Uint8Array(i)],{type:e});return URL.createObjectURL(n)}async getAsSvg(t){return await this.getAsObjectUrl(t,"image/svg+xml")}async getAsText(t){let e=await this.getFileAsBuffer(t);return Nt.bufferToText(e)}static bufferToText(t){let e=new Uint8Array(t);return new TextDecoder("utf-8").decode(e)}async getAsJSON(t){let e=await this.getAsText(t);return JSON.parse(e)}async getJsonObject(t){let e=await this.getAsJSON(t);return Nt.getJsonObject(e)}static getJsonObject(t){return(new THREE.ObjectLoader).parse(t)}static initGltfLoader(){this.gltfLoader||(this.gltfLoader=new THREE.GLTFLoader)}async getGltfObject(t){let e=await this.getFileAsBuffer(t);return await Nt.getGltfObjectFromArrayBuffer(e)}async blobToArrayBuffer(t){return await new Response(t).arrayBuffer()}async getGltfObjectFromBlob(t){let e=await this.blobToArrayBuffer(t);return await Nt.getGltfObjectFromArrayBuffer(e)}static async getGltfObjectFromArrayBuffer(t){return await new Promise((e,i)=>{this.initGltfLoader(),this.gltfLoader.parse(t,"",t=>{e(t)})})}async getTexture(t,{imageType:e="png",mapping:i=THREE.UVMapping,wrapS:n=THREE.ClampToEdgeWrapping,wrapT:s=THREE.ClampToEdgeWrapping,magFilter:r=THREE.LinearFilter,minFilter:a=THREE.LinearMipMapLinearFilter,format:o=THREE.RGBAFormat,type:l=THREE.UnsignedByteType,anisotropy:h=1,encoding:c=THREE.LinearEncoding}={}){let u=this.textureCache[t];if(u){if(u.texture)return u.texture;if(u.loading)return await new Promise((e,i)=>{this.textureCache[t].onLoadCbs.push(e)})}this.textureCache[t]=u={loading:!0,texture:null,onLoadCbs:[]};let d=await this.getAsImageObject(t),p=new THREE.Texture(d,i,n,s,r,a,o,l,h,c);p.needsUpdate=!0,u.texture=p;for(const m of u.onLoadCbs)m(u.texture);return u.onLoadCbs=[],u.loading=!1,p}async getAsImageObject(t){let e=await this.getAsObjectUrl(t);return await new Promise((i,n)=>{let s=new Image;s.onload=(t=>{i(s)}),s.onerror=(e=>{n(new Error("unable to get image object for "+t))}),s.src=e})}async getCubeTexture(t,{imageType:e="png",mapping:i=THREE.CubeReflectionMapping,wrapS:n=THREE.ClampToEdgeWrapping,wrapT:s=THREE.ClampToEdgeWrapping,magFilter:r=THREE.LinearFilter,minFilter:a=THREE.LinearMipMapLinearFilter,format:o=THREE.RGBAFormat,type:l=THREE.UnsignedByteType,anisotropy:h=1,encoding:c=THREE.LinearEncoding}={}){let u=new Array(t.length);for(let m=0;m<t.length;m++){let e=t[m];u[m]=this.getAsImageObject(e)}let d=await Promise.all(u),p=new THREE.CubeTexture(d,i,n,s,r,a,o,l,h,c);return p.needsUpdate=!0,p}}class Ft{constructor(){this.main=new Nt("packages/main.bin?v="+VERSION_TIMESTAMP),this.mainHQ=new Nt("packages/mainHQ.bin?v="+VERSION_TIMESTAMP),this.mainLQ=new Nt("packages/mainLQ.bin?v="+VERSION_TIMESTAMP),"webm"==Yt.audioFormat?this.sfx=new Nt("packages/sfxWebm.bin?v="+VERSION_TIMESTAMP):"mp3"==Yt.audioFormat?this.sfx=new Nt("packages/sfxMp3.bin?v="+VERSION_TIMESTAMP):this.sfx=null;let t=["themeIce","themeIceDisk","themeSumo","themeSumoDisk","themeSaws","themeSawsDisk","themeKnives"],e=["themeDefaultMusic","themeIceSfx","themeIceMusic","themeSumoMusic","themeSawsSfx","themeSawsMusic","themeKnivesSfx","themeKnivesMusic"];for(const i of e)t.push(i+Yt.audioFormatCamelCase);this.additionalPackages={};for(const i of t)this.additionalPackages[i]=new Nt("packages/"+i+".bin?v="+VERSION_TIMESTAMP);CORDOVA?(this.requiresMainLQ=!1,this.qualityIsAccurate=!0):(this.requiresMainLQ=!0,this.qualityIsAccurate=!1,navigator.connection&&navigator.connection.downlink&&(this.requiresMainLQ=navigator.connection.downlink<3)),this.menuWallUrl="lazyAssets/menuWall.json",this.lastLoadedWall=null,this.onAccurateQualityCbs=[],this.onMainMenuWallProgressCbs=[],this.onMainMenuWallLoadCbs=[],this.onHQLoadAfterLQCbs=[]}async init(){await p.serviceWorker.hasCachedUrl(this.mainHQ.url)&&(this.requiresMainLQ=!1);for(const t of this.onAccurateQualityCbs)t();if(this.onAccurateQualityCbs=[],this.qualityIsAccurate=!0,await this.loadWall(),await this.preloadOrangeLoadScreenBg(),this.main.startDownloading(),this.requiresMainLQ){await this.mainLQ.startDownloading(),this.sfx&&this.sfx.startDownloading(),await this.main.waitForLoad(),await this.mainHQ.startDownloading();for(const t of this.onHQLoadAfterLQCbs)t()}else this.mainHQ.startDownloading(),this.sfx&&this.sfx.startDownloading();for(let[t,e]of this.additionalPackages.keyValues)e.startDownloading()}async waitForAccurateQuality(){if(!this.qualityIsAccurate)return await new Promise(t=>{this.onAccurateQualityCbs.push(t)})}onBeforePlayProgress(t){this.bestMain.onProgress(t)}get bestMainIsHQ(){return this.mainHQ.loaded||!this.requiresMainLQ}get bestMain(){return this.bestMainIsHQ?this.mainHQ:this.mainLQ}get lastBeforePlayProgress(){return this.bestMain.lastProgressValue}getPackage(t){return this.additionalPackages[t]}async loadWall(){let t=await Zt.requestWithProgress(this.menuWallUrl,t=>{for(const e of this.onMainMenuWallProgressCbs)e(t)});p.serviceWorker.storeCache(this.menuWallUrl,t),this.lastLoadedWall=t,this.onMainMenuWallProgressCbs=[];for(const e of this.onMainMenuWallLoadCbs)e(this.lastLoadedWall);this.onMainMenuWallLoadCbs=[]}async getMainMenuWall(t){return this.lastLoadedWall?this.lastLoadedWall:(this.onMainMenuWallProgressCbs.push(t),await new Promise(t=>{this.onMainMenuWallLoadCbs.push(t)}))}async waitForHQLoad(){return await new Promise(t=>{this.onHQLoadAfterLQCbs.push(t)})}async preloadOrangeLoadScreenBg(){let t=new Image;return t.src="img/loadingScreen/orange.webp",await new Promise(e=>{t.onload=e,t.onerror=e})}}class Vt{constructor(){this.loadedData=null,this.onLoadCbs=[]}loadJson(t){this.loadedData=t;for(const e of this.onLoadCbs)e()}async waitForConfigLoad(){if(!this.loadedData)return await new Promise(t=>{this.onLoadCbs.push(t)})}async getDataSet(t){return await this.waitForConfigLoad(),this.loadedData[t]}async getKey(t){let e=await this.getDataSet("config_values");for(const{key:i,value:n}of e)if(i==t)return n}}class jt{constructor(){}static setCurrentScene(t){this.scene=t,this.drawLinesNextFrame=[],this.removeLinesNextFrame=[],this.material||(this.material=new THREE.LineBasicMaterial({color:16777215,vertexColors:!0}))}static loop(){if(this.drawLinesNextFrame&&this.removeLinesNextFrame){for(let t of this.removeLinesNextFrame){let e=t.line;e.parent.remove(e),e.geometry.dispose()}this.removeLinesNextFrame=[];for(let t of this.drawLinesNextFrame){let e=new THREE.Geometry;e.vertices.push(t.from),e.vertices.push(t.to),e.colors=[new THREE.Color(t.color),new THREE.Color(t.color)];let i=this.material;t.color&&(i=new THREE.LineBasicMaterial({color:t.color}));let n=new THREE.Line(e,i);t.line=n,this.scene.add(n),this.removeLinesNextFrame.push(t)}this.drawLinesNextFrame=[]}}static drawLine(t,e,i){this.drawLinesNextFrame&&this.drawLinesNextFrame.push({from:t.clone(),to:e.clone(),color:i})}static drawRay(t,e,i){let n=(t=t.clone()).clone();n.add(e),this.drawLine(t,n,i)}}class Gt{static inOut(t){return t<.5?8*t*t*t*t:1-Math.pow(-2*t+2,4)/2}static in(t){return Math.pow(t,4)}static out(t){return 1-Math.pow(1-t,4)}static bounceOut(t,e,i){return Math.pow(1-t,i)*Math.cos(t*e+Math.PI)+1}}class Ut{constructor(t){if(this.ctx=t,this.isLoopingNodes=!1,this.doPlayLastAndStopNext=!1,this.currentTrackIndex=0,this.nextCreateNodeTime=0,this.musicStopPlayingTime=-1,this.onMusicStopPlayingCbs=[],this.themes=[{name:"default",packageName:"themeDefaultMusic",trackCount:11},{name:"ice",packageName:"themeIceMusic",trackCount:6},{name:"sumo",packageName:"themeSumoMusic",trackCount:8},{name:"saws",packageName:"themeSawsMusic",trackCount:11},{name:"knives",packageName:"themeKnivesMusic",trackCount:11,gain:.8}],Yt.audioFormat)for(const e of this.themes)e.packageName+=Yt.audioFormatCamelCase;this.currentTheme=this.themes[0],this.gainNode=this.ctx.createGain(),this.gainNode.connect(this.ctx.destination),this.lastCreatedNode=null,window.setInterval(t=>this.loop(),100)}setTheme(t){let e=this.themes.find(e=>e.name==t);e&&(this.currentTheme=e)}async init(){for(const t of this.themes)this.loadTheme(t)}async loadTheme(t){t.loaded=!1,t.buffers=[];for(let e=0;e<=t.trackCount;e++)t.buffers[e]=await this.getAudioBuffer(e+"."+Yt.audioFormat,t.packageName);t.loaded=!0}async getAudioBuffer(t,e="sfx"){if(!this.ctx)return null;let i=null;if(!(i="sfx"==e?p.assets.sfx:p.assets.getPackage(e)))return null;let n=await i.getFileAsBuffer(t);return await new Promise(t=>{this.ctx.decodeAudioData(n,t)})}get isPlaying(){return!!this.ctx&&(!p.cornerSettings.muteMusicButton.value&&!p.ads.prerollIsPlaying&&(this.ctx.currentTime<this.musicStopPlayingTime||0==this.musicStopPlayingTime))}loop(){if(this.currentTheme.loaded){if(!this.isPlaying){for(const t of this.onMusicStopPlayingCbs)t();this.onMusicStopPlayingCbs=[]}if(this.isPlaying&&this.nextCreateNodeTime-.3<this.ctx.currentTime){let t=!1,e=null;if(this.doPlayLastAndStopNext)this.doPlayLastAndStopNext=!1,e=this.currentTheme.buffers[this.currentTheme.trackCount],this.isLoopingNodes=!1,t=!0;else{let t=p.game.players.length,i=this.currentTheme.trackCount-1;this.currentTrackIndex=Zt.mapValue(80,2,0,i,t,!0),this.currentTrackIndex=Math.round(this.currentTrackIndex),e=this.currentTheme.buffers[this.currentTrackIndex]}let i=this.ctx.createBufferSource();i.buffer=e,i.connect(this.gainNode),this.gainNode.gain.value=this.currentTheme.gain||1,this.nextCreateNodeTime=Math.max(this.nextCreateNodeTime,this.ctx.currentTime),t&&(this.nextCreateNodeTime-=.314,this.musicStopPlayingTime=this.nextCreateNodeTime+.4),i.start(Math.max(0,this.nextCreateNodeTime)),this.nextCreateNodeTime=this.nextCreateNodeTime+e.duration,this.lastCreatedNode=i}}}startPlaying(){this.musicStopPlayingTime=0,this.doPlayLastAndStopNext=!1,this.isLoopingNodes=!0}playLastAndStop(){this.doPlayLastAndStopNext=!0}stopCurrentBar(){this.lastCreatedNode&&this.lastCreatedNode.stop()}async waitForMusicStopPlaying(){if(this.isPlaying)return await new Promise(t=>{this.onMusicStopPlayingCbs.push(t)})}}class zt{static get dbName(){return"keyValuesDb"}static get objectStoreName(){return"keyValues"}static init(){this.supported=!1;try{let t=indexedDB.open(this.dbName);t.onupgradeneeded=(e=>{t.result.createObjectStore(this.objectStoreName)}),this.supported=!0}catch(t){console.log("error while opening indexedDB: ",t)}}static get(t){if(!this.supported){let e=Zt.lsGet("indexedDBFallback"+t);try{e=JSON.parse(e)}catch(t){e=null}return Promise.resolve(e)}return new Promise((e,i)=>{let n=indexedDB.open(this.dbName);n.onsuccess=(s=>{let r=n.result.transaction(this.objectStoreName,"readonly").objectStore(this.objectStoreName).get(t);r.onsuccess=(()=>{e(r.result)}),r.onerror=(()=>{i(new Error("Unable to get IndexedDB value for "+t))})}),n.onerror=(()=>{i(new Error("Unable to open IndexedDB for "+t))})})}static set(t,e){return this.getSet(t,()=>e)}static getSet(t,e){if(!this.supported){let i=Zt.lsGet(t),n=e(i);return Zt.lsSet("indexedDBFallback"+t,JSON.stringify(n)),Promise.resolve()}return new Promise((i,n)=>{let s=indexedDB.open(this.dbName);s.onsuccess=(r=>{let a=s.result.transaction(this.objectStoreName,"readwrite").objectStore(this.objectStoreName),o=a.openCursor(t);o.onsuccess=(()=>{let s=o.result;if(s){let r=e(s.value),a=s.update(r);a.onsuccess=(()=>{i()}),a.onerror=(()=>{n(new Error("Unable to update IndexedDB value for "+t))})}else{let s=a.put(e(null),t);s.onsuccess=(()=>{i()}),s.onerror=(()=>{n(new Error("Unable to put IndexedDB value for "+t))})}}),o.onerror=(()=>{n(new Error("Unable to open IndexedDB cursor for "+t))})}),s.onerror=(e=>{n(new Error("Unable to open IndexedDB for "+t))})})}}class Wt{constructor(t){this.materialCombinations=[],t&&this.storeObject(t)}destructor(t=!0,e=!0){if(t)if(e)for(const i of this.materialCombinations)Zt.disposeMaterialWithTextures(i.original),Zt.disposeMaterialWithTextures(i.basic);else for(const i of this.materialCombinations)i.original.dispose(),i.basic.dispose();this.materialCombinations=null}storeObject(t){let e=new Map;t.traverse(t=>{if(t instanceof THREE.Mesh&&!t.material.isMeshBasicMaterial){let i=t.material;if(e.has(i)){e.get(i).push(t)}else e.set(i,[t])}});for(const i of e.entries()){let t=i[0],e=i[1],n=new THREE.MeshBasicMaterial({map:t.map});this.materialCombinations.push({original:t,basic:n,meshes:e})}}setMaterials(t=!0){for(const e of this.materialCombinations)for(const i of e.meshes)i.material=t?e.original:e.basic}}class qt{constructor(){}static init(){window.addEventListener("resize",t=>{this.testResized(),window.setTimeout(t=>this.testResized(),100),window.setTimeout(t=>this.testResized(),500),window.setTimeout(t=>this.testResized(),1e3),window.setTimeout(t=>this.testResized(),2e3)})}static testResized(){let t=document.documentElement.clientWidth,e=document.documentElement.clientHeight;if(t!=this.prevW||e!=this.prevH){this.prevW=t,this.prevH=e;for(const i of this.listeners)i(t,e)}}static addListener(t){this.listeners||(this.listeners=[]),this.listeners.push(t)}static removeListener(t){this.listeners||(this.listeners=[]);let e=this.listeners.indexOf(t);e>=0&&this.listeners.splice(e,1)}}class Yt{constructor(){this.sounds=null,this.onSoundsLoadCbs=[],this.settingsMuted=!0,this.prerollMuted=!1,this.muted=!0,window.AudioContext=window.AudioContext||window.webkitAudioContext,this.supported=!!AudioContext,this.supported&&(null==Yt.audioFormat&&(this.supported=!1),this.supported&&(this.ctx=new AudioContext,this.ctx.onstatechange=(()=>{this.onCtxStatechange()}),this.boundUserEvent=this.userEvent.bind(this),this.addedUserEventListeners=!1,this.onCtxStatechange(),CORDOVA&&document.addEventListener("visibilitychange",t=>{document.hidden?this.ctx.suspend():window.setTimeout(t=>this.ctx.resume(),300)},!1)))}static get audioFormat(){if(!this._audioFormatSet){let t=document.createElement("audio");t.canPlayType("audio/webm")?this._audioFormat="webm":t.canPlayType("audio/mp3")?this._audioFormat="mp3":(this._audioFormat=null,this.supported=!1),this._audioFormatSet=!0}return this._audioFormat}static get audioFormatCamelCase(){let t=this.audioFormat;return t.charAt(0).toUpperCase()+t.substring(1)}async init(){if(!this.supported)return;let t=await p.staticConfig.getDataSet("sfx");this.sounds={};for(let e of t){let t=e.name,i=new Xt(e,this.ctx);this.sounds[t]=i,i.setMuted(this.muted)}for(const e of this.onSoundsLoadCbs)e();this.onSoundsLoadCbs=[]}async waitForSoundsLoad(){if(!this.sounds)return await new Promise(t=>{this.onSoundsLoadCbs.push(t)})}onCtxStatechange(){this.supported&&("suspended"==this.ctx.state?this.addUserEventListeners():"running"==this.ctx.state&&this.removeUserEventListeners())}addUserEventListeners(){this.supported&&(this.addedUserEventListeners||(window.addEventListener("touchstart",this.boundUserEvent),window.addEventListener("touchend",this.boundUserEvent),window.addEventListener("click",this.boundUserEvent),window.addEventListener("keydown",this.boundUserEvent),this.addedUserEventListeners=!0))}removeUserEventListeners(){this.supported&&this.addedUserEventListeners&&(window.removeEventListener("touchstart",this.boundUserEvent),window.removeEventListener("touchend",this.boundUserEvent),window.removeEventListener("click",this.boundUserEvent),window.removeEventListener("keydown",this.boundUserEvent),this.addedUserEventListeners=!1)}userEvent(){this.supported&&this.ctx.resume()}async playSound(t,e,i=1){if(!this.supported)return;await this.waitForSoundsLoad();let n=this.sounds[t];return n&&n.play(e,i),n}async getSound(t){return this.supported?(await this.waitForSoundsLoad(),this.sounds[t]):null}setMutedSettings(t){this.settingsMuted=t,this.updateMuted()}setMutedPreroll(t){this.prerollMuted=t,this.updateMuted()}updateMuted(){if(this.muted=this.settingsMuted||this.prerollMuted,this.sounds)for(const[t,e]of this.sounds.keyValues)e.setMuted(this.muted)}}class Xt{constructor(t,e){t={...{assetPackageName:"sfx",volume:1,forceAddGainNode:!1,defaultPitch:1,loop:!1,disallowMultiple:!1,allowWithoutUserEvent:!1},...t},this.name=t.name,this.ctx=e,this.loaded=!1,this.loading=!1,this.onLoadCbs=[],this.buffer=null,this.loop=t.loop,this.assetPackageName=t.assetPackageName,this.volume=t.volume,this.forceAddGainNode=t.forceAddGainNode,this.defaultPitch=t.defaultPitch,this.disallowMultiple=t.disallowMultiple,this.allowWithoutUserEvent=t.allowWithoutUserEvent,this.muted=!1,this.isLoopPlaying=!1,this.load(),this.createdNodes=[]}async load(){if(this.loaded)return;if(this.loading)return await new Promise(t=>{this.onLoadCbs.push(t)});let t;if(this.loading=!0,"sfx"==this.assetPackageName)t=await p.assets.sfx.getFileAsBuffer(this.name+"."+Yt.audioFormat);else{let e=this.assetPackageName+Yt.audioFormatCamelCase,i=p.assets.getPackage(e);if(!i)return void console.warn("failed to load sfx "+this.name+"."+Yt.audioFormat+" in package "+e);t=await i.getFileAsBuffer(this.name+"."+Yt.audioFormat)}this.buffer=await new Promise(e=>{this.ctx.decodeAudioData(t,e)}),this.loaded=!0;for(const e of this.onLoadCbs)e();this.onLoadCbs=[]}createSource(t=1){if(this.disallowMultiple&&this.createdNodes.length>0)return;let e=this.ctx.createBufferSource(),i=null;e.buffer=this.buffer,e.loop=this.loop;let n=this.volume*t;1!=n||this.forceAddGainNode?((i=this.ctx.createGain()).gain.value=n,e.connect(i),i.connect(this.ctx.destination)):e.connect(this.ctx.destination);let s={sourceNode:e,gainNode:i,started:!1},r=t=>{e.removeEventListener("ended",r),this.createdNodes.includes(s)&&this.clearNodeGroup(s);let i=this.createdNodes.indexOf(s);i>=0&&this.createdNodes.splice(i,1)};e.addEventListener("ended",r),this.createdNodes.push(s)}async play(t=this.defaultPitch,e=1){if(this.loop&&(this.isLoopPlaying=!0),this.muted)return;if(!this.loaded){if(!this.allowWithoutUserEvent)return;await this.load()}this.createSource(e);let i=this.createdNodes[this.createdNodes.length-1];if(!i.started){i.started=!0;let e=i.sourceNode;t&&t>0&&(e.playbackRate.value=t),e.start()}}stop(){this.loop&&(this.isLoopPlaying=!1);for(const t of this.createdNodes)this.clearNodeGroup(t);this.createdNodes=[]}clearNodeGroup(t){t.sourceNode.stop(),t.gainNode?(t.gainNode.disconnect(this.ctx.destination),t.sourceNode.disconnect(t.gainNode)):t.sourceNode.disconnect(this.ctx.destination)}setMuted(t){this.muted=t,t?this.loop?this.isLoopPlaying&&(this.stop(),this.isLoopPlaying=!0):this.stop():this.isLoopPlaying&&this.play()}setVolume(t){for(const e of this.createdNodes)e.gainNode&&e.gainNode.gain.linearRampToValueAtTime(t,e.gainNode.context.currentTime+.1)}}!function(){if("undefined"!=typeof WebSocket&&e()>0){var t=WebSocket;window.WebSocket=function(i){var n=new t(i);n.binaryType="arraybuffer",this.readyState=WebSocket.CONNECTING,this.onclose=function(){},this.onopen=function(){},this.onmessage=function(){};var s=this;n.onclose=function(){window.setTimeout(function(){s.readyState=WebSocket.CLOSED,s.onclose()},e())},n.onopen=function(){window.setTimeout(function(){s.readyState=WebSocket.OPEN,s.onopen()},e())},n.onmessage=function(t){window.setTimeout(function(){s.onmessage(t)},e())},this.send=function(t){window.setTimeout(function(){n.send(t)},e())},this.close=function(){window.setTimeout(function(){n.close(),s.readyState=WebSocket.CLOSING},e())}}.bind(),WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3}function e(){let t=0;try{t=parseInt(localStorage.simulatedLatency)/2}catch(t){}return isNaN(t)&&(t=0),t}}();class Jt extends Vt{constructor(){super()}async init(){let t=await p.assets.main.getAsJSON("config.json");this.loadJson(t)}}class Kt{constructor(t,e,i){this.cb=t,this.id=-1,this.ms=e,this.isDestructed=!1,i&&this.start()}destructor(){this.stop(),this.isDestructed=!0,this.cb=null}get isRunning(){return-1!=this.id}stop(){if(!this.isDestructed)return this.id>=0&&(window.clearTimeout(this.id),this.id=-1,!0)}start(){this.isDestructed||(this.stop(),this.id=window.setTimeout(this.execute.bind(this),this.ms))}execute(){this.id=-1,this.cb&&this.cb()}static promise(t){return new Promise((e,i)=>{window.setTimeout(()=>{e()},t)})}}class Zt{constructor(){}static mod(t,e){return(t%e+e)%e}static modMinMax(t,e,i){return this.mod(t-e,i-e)+e}static lerp(t,e,i){return t+i*(e-t)}static iLerp(t,e,i){return(i-t)/(e-t)}static lerptt01(t,e){return 1-Math.pow(1-t,e)}static lerptt10(t,e){return 1-this.lerptt01(1-t,e)}static lerptt(t,e,i,n){return Zt.lerp(t,e,this.lerptt01(i,n))}static lerpt(t,e,i){return this.lerptt(t,e,i,p.dt16)}static lerpt01(t){return this.lerptt01(t,p.dt16)}static lerpt10(t){return this.lerptt10(t,p.dt16)}static mapValue(t,e,i,n,s,r){let a=this.iLerp(t,e,s);return r&&(a=this.clamp01(a)),this.lerp(i,n,a)}static clamp(t,e,i){return Math.max(e,Math.min(i,t))}static clamp01(t){return Zt.clamp(t,0,1)}static randInt(t,e,i){return Math.floor(this.randRange(t,e,i))}static randRange(t,e,i){return this.randSeed(i)*(e-t)+t}static randSeed(t){if(void 0===t)return Math.random();let e=1e4*Math.sin(t++);return e-Math.floor(e)}static randFromArray(t){return this.randFromArrayHelper(t,Math.random())}static randFromArraySeed(t,e){return this.randFromArrayHelper(t,this.randSeed(e))}static randFromArrayHelper(t,e){return t[Math.floor(e*t.length)]}static longCos(t,e,i){void 0===i&&(i=0);let n=t*(e/Math.PI+1),s=Math.min(this.mod(n,2*Math.PI+2*e),Math.PI),r=Math.min(Math.max(this.mod(n,2*Math.PI+2*e)-Math.PI-e-i*e,0),Math.PI);return Math.cos(s+r)}static printStack(){console.log(...arguments),console.group("stack"),console.log((new Error).stack),console.groupEnd()}static recalculateStyle(t){window.getComputedStyle(t).getPropertyValue("top")}static skipCssTransition(t){let e=t.style.transition;t.style.transition="none",this.recalculateStyle(t),t.style.transition=e}static requestWithProgress(t,e){return new Promise((i,n)=>{let s=new XMLHttpRequest;s.responseType="blob",s.addEventListener("progress",t=>{if(e){let i=0;t.lengthComputable&&(i=t.loaded/t.total),e(i)}}),s.onload=(e=>{200==s.status||0==s.status&&CORDOVA?i(s.response):n(new Error("wrong status code: "+s.status+" for "+t))}),s.onerror=(e=>{console.log("xhrerror:",e),n(new Error(`xhr error for ${t} readyState=${s.readyState} status=${s.status}`))}),s.open("GET",t,!0),s.send()})}static get uuid(){return Date.now()+"_"+Math.random().toString(36).substr(2,9)}static removeAndDisposeChildren(t){for(let e=t.children.length-1;e>=0;e--){let i=t.children[e];this.removeAndDisposeObject(i)}}static removeAndDisposeObject(t){t.parent&&t.parent.remove(t),t.traverse(t=>{t instanceof THREE.Mesh&&(t.geometry&&t.geometry.dispose(),t.material&&this.disposeMaterialWithTextures(t.material))})}static disposeMaterialWithTextures(t){t.dispose();for(const e of Object.keys(t)){const i=t[e];i&&i.isTexture&&i.dispose()}}static lsSet(t,e){try{return localStorage.setItem(t),!0}catch(i){return this.localStorageMemory||(this.localStorageMemory={}),this.localStorageMemory[t]=e.toString(),!1}}static lsGet(t){try{return localStorage.getItem(t)}catch(e){return this.localStorageMemory?this.localStorageMemory[t]:void 0}}static formatSeconds(t){let e=Math.floor(t/60);return t=Math.floor(t-60*e),e<10&&(e="0"+e),t<10&&(t="0"+t),e+":"+t}static searchToDict(t){let e=new URLSearchParams(t),i={};for(const n of e.entries())i[n[0]]=n[1];return i}static parseHash(){let t=location.hash;return t.startsWith("#")&&(t=t.substr(1)),this.searchToDict(t)}static parseSearch(){return this.searchToDict(location.search)}static gaEvent(t,e){if("ga"in window&&ga.getAll){let i=ga.getAll()[0];if(!i)return;i.send("event",t,e)}}static gaTiming(t,e,i=Math.round(performance.now())){if("ga"in window&&ga.getAll){let n=ga.getAll()[0];if(!n)return;n.send("timing",t,e,i)}}static async addScript(t){let e=document.createElement("script");e.src=t,document.head.appendChild(e),await new Promise((i,n)=>{let s=t=>{i(),e.removeEventListener("load",s)};e.addEventListener("load",s);let r=i=>{n(new Error("unable to load script "+t)),e.removeEventListener("error",r)};e.addEventListener("error",r)})}static async cordovaFetch(t){if(CORDOVA)return await new Promise((e,i)=>{let n=new XMLHttpRequest;n.responseType="blob",n.onload=function(){let t=n.status;0==t&&(t=200),e(new Response(n.response,{status:t}))},n.onerror=function(){i(new TypeError("Local request failed",t))},n.open("GET",t),n.send(null)});try{return await fetch(...arguments)}catch(e){throw new Error("error while fetching "+t)}}}class Qt{constructor(){this.obj=new THREE.Object3D,this.obj.name="iceCube",p.game.scene.add(this.obj),this.material=null,this.createTime=0,this.loadAsset()}async loadAsset(){let t=await p.assetCache.getItem("potions/iceCube.json");if(!this.obj)return;let e=t.clone();e.material=this.material=e.material.clone(),e.rotation.y=Zt.randRange(0,2*Math.PI),this.createTime=p.now,this.obj.add(e)}playBreakFx(){var t=p.particles.createSystem({particleAssetPath:"particles/iceShards.json",pickRandomChild:!0,particleCount:30,duration:2,spawnerShape:{type:"boxFaces"},startVelocity:{x:.1,minY:0,maxY:.2,z:.1}});t&&(t.obj.position.copy(this.obj.position),t.obj.position.y+=1)}loop(t,e){let i=t-this.createTime;this.material&&(this.material.opacity=Zt.mapValue(0,1e3,.5,.8,i,!0))}destructor(){this.obj.parent.remove(this.obj),this.obj=null,this.material&&this.material.dispose(),this.material=null}}class $t{constructor(t,e,i,n,s,r,a){this.id=t,this.type=e,this.spawnPos=new THREE.Vector3(i,n,s),this.spawnTime=a,this.fallSpeed=r,this.radius=1.3,this.hasLanded=!1,this.hasReachedBelowAllDisks=!1,this.landedObject=null,this.landedRadiusDistance=0,this.landedLocalPosition=null,this.hasFallenOffDisk=!1,this.fallStartTime=0,this.touchedPlayerIds=[],this.destroyNextFrame=!1,this.isRemoveAnimating=!1,this.isRemoveAnimatingToPlayer=null,this.removeAnimatingStartTime=0,this.isRemoveAnimatingStartPos=null,this.obj=new THREE.Object3D,this.obj.name="potionItem",this.obj.position.copy(this.spawnPos),this.assetObj=null,this.shineMat=new THREE.MeshBasicMaterial({blending:THREE.AdditiveBlending,depthFunc:THREE.NeverDepth,depthWrite:!1,color:1447446}),this.shineMesh=new THREE.Mesh($t.shineGeo,this.shineMat),this.shineMesh.renderOrder=1,this.obj.add(this.shineMesh),this.shineAmount=0,this.loadAsset(),$t.loadSettings()}destructor(){this.obj.parent&&this.obj.parent.remove(this.obj),this.destructAsset(),this.obj=null,this.spawnPos=null,this.touchedPlayerIds=null,this.shineMat.dispose(),this.shineMat=null,this.shineMesh=null}destructAsset(){this.assetObj&&(this.assetObj.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.assetObj=null)}static get Types(){return{HEAVY:0,TORNADO:1,FEATHER:2,SNOWFLAKE:3,MAX_VALUE:4}}static async loadSettings(){if(!this.loadingPotionSettings){if(this.loadingPotionSettings=!0,this.potionSettings=await p.staticConfig.getDataSet("potion_settings"),this.potionSettingsLoaded=!0,this.onSettingsLoadCbs)for(const t of this.onSettingsLoadCbs)t();this.onSettingsLoadCbs=null}}static async waitForSettingsLoad(){if(!this.potionSettingsLoaded)return this.onSettingsLoadCbs||(this.onSettingsLoadCbs=[]),await new Promise(t=>this.onSettingsLoadCbs.push(t))}static getSettingsByType(t,e=!1){if(this.potionSettings)return this.potionSettings.find(e=>e.potionId==t)}get settings(){return $t.getSettingsByType(this.type)}getDuration(){let t=this.settings;return t?1e3*Zt.randRange(t.minDuration,t.maxDuration):5e3}get applyToOthersRadius(){let t=this.settings;return t&&t.applyToOthersRadius}static get shineGeo(){return this._shineGeo||(this._shineGeo=new THREE.CylinderBufferGeometry(1,1,100,8)),this._shineGeo}static get shineColor(){return new THREE.Color(16764989)}async loadAsset(){await $t.waitForSettingsLoad();let t=this.settings.assetName,e="potions/items/"+t;if(t.endsWith(".glb")){let t=await p.assets.main.getGltfObject(e);this.assetObj=t.scene}else t.endsWith(".json")&&(this.assetObj=await p.assets.main.getJsonObject(e));this.obj?this.obj.add(this.assetObj):this.destructAsset()}get pos(){return this.obj.position.clone()}playerTouched(t){if(this.isRemoveAnimating||this.destroyNextFrame)return;let e=t.playerId;this.touchedPlayerIds.includes(e)||(this.touchedPlayerIds.push(e),p.network.sendTouchPotion(t,this))}playerTouchedServer(t){this.type==$t.Types.SNOWFLAKE&&(p.sfx.playSound("items/iceGrab"),t.startSnowFlakeGrabFx())}loop(t,e){if(this.obj.rotation.y=.001*p.game.serverTime,this.isRemoveAnimating){let t=p.game.serverTime-this.removeAnimatingStartTime;t/=1e3;let e=1-Gt.in(4*t);e=Math.max(.001,e),this.obj.scale.setScalar(e),this.isRemoveAnimatingToPlayer&&!this.isRemoveAnimatingToPlayer.destructed&&this.obj.position.lerpVectors(this.isRemoveAnimatingStartPos,this.isRemoveAnimatingToPlayer.pos,Gt.in(Zt.clamp01(4*t))),t>1&&(this.destroyNextFrame=!0)}else if(this.hasLanded)if(this.hasFallenOffDisk){let t=p.game.serverTime-this.fallStartTime;this.obj.position.y=this.fallStartHeight-Math.pow(t*this.fallSpeed,2)}else{if(this.landedObject&&!this.landedObject.destructed){let t=this.landedLocalPosition.clone();this.landedObject.obj.localToWorld(t),this.obj.position.copy(t)}let t=!1;if(this.landedObject.destructed)t=!1;else{let e=.5*this.radius;t=this.landedObject.isSquareShape?this.landedObject.hasPos(this.spawnPos.x,this.spawnPos.z,e):this.landedObject.hasRadius(this.landedRadiusDistance,e)}t||(this.hasFallenOffDisk=!0,this.landedObject=null,this.fallStartTime=p.game.serverTime,this.fallStartHeight=this.obj.position.y)}else{let t=p.game.serverTime-this.spawnTime;this.obj.position.y=this.spawnPos.y-t*this.fallSpeed}this.hasReachedBelowAllDisks||this.hasLanded||this.isRemoveAnimating?this.shineAmount-=.001*e:this.shineAmount+=.001*e,this.shineAmount=Zt.clamp(this.shineAmount,5e-4,1);let i=Gt.inOut(this.shineAmount);this.shineMat.color.copy($t.shineColor),this.shineMat.color.multiplyScalar(.1*i),this.shineMesh.scale.set(i,1,i)}testBalancingObjectsCollision(t){if(this.hasLanded)return;let e=!0;for(const i of t){if(!i)continue;let t=i.getClosestPosOnDisk(this.pos),n=this.pos.distanceTo(t),s=i.getClosestPosOnDisk(this.pos,!1);this.pos.y>s.y&&(e=!1),n<this.radius&&(this.hasLanded=!0,this.landedObject=i,this.landedLocalPosition=this.pos,i.obj.worldToLocal(this.landedLocalPosition),this.landedLocalPosition.y=0,this.landedRadiusDistance=this.landedLocalPosition.length(),this.landedLocalPosition.y=this.radius)}e&&(this.hasReachedBelowAllDisks=!0)}removeAnimated(t){this.isRemoveAnimating=!0,t&&(this.isRemoveAnimatingToPlayer=t,this.playerTouchedServer(t)),this.removeAnimatingStartTime=p.game.serverTime,this.isRemoveAnimatingStartPos=this.pos}}class te{constructor(){this.obj=new THREE.Object3D,this.obj.name="snowflake grab fx",p.game.scene.add(this.obj),this.startTime=0,this.assetObjs=[],this.done=!1,this.loadAsset(),this.assetLoaded=!1}async loadAsset(){let t=await p.assetCache.getItem("potions/snowFlakeGrab.json");if(this.obj){for(let e=0;e<2;e++){let e=t.clone();e.material=e.material.clone(),this.assetObjs.push(e),this.obj.add(e)}this.assetLoaded=!0,this.startTime=p.now}}loop(t,e){if(!this.assetLoaded||!this.obj)return;let i=t-this.startTime;for(let n=0;n<this.assetObjs.length;n++){let t=this.assetObjs[n],e=i-150*n,s=Math.max(.001,.03*e);t.scale.setScalar(s);let r=n%2==0?1:-1;t.rotation.y=.003*i*r-.5,t.material.opacity=1-.003*e}i>1e3&&(this.done=!0)}destructor(){this.obj.parent.remove(this.obj),this.obj=null;for(const t of this.assetObjs)t.material.dispose();this.assetObjs=[]}}class ee{constructor(){this.obj=new THREE.Object3D,this.obj.name="tornado",p.game.scene.add(this.obj),this.tornadoAssets=[],this.loadAssets()}async loadAssets(){let t=await p.assetCache.getItem("potions/tornado.json");for(let e=0;e<5;e++){let e=t.clone(),i=Zt.randRange(.9,1.1),n=Zt.randRange(.7,1);e.scale.set(i,n,i),this.tornadoAssets.push({tornado:e,speed:Zt.randRange(.01,.02)}),this.obj.add(e)}}loop(t,e){for(const i of this.tornadoAssets)i.tornado.rotation.z=t*i.speed}destructor(){this.obj.parent.remove(this.obj)}}class ie{constructor(t){this.type=t.type,this.obj=new THREE.Object3D,this.linkedDisk=null,this.rotOffset=new THREE.Quaternion,this.posOffset=new THREE.Vector3,this.scalePosWithDisk=!0,this.loadAssetName=null,this.loadAssetPackageName=null,this.loadAssetCalled=!1}destructor(){this.obj&&this.obj.parent&&this.obj.parent.remove(this.obj),this.obj=null}init(){this.loadAssetName&&this.loadAsset()}async loadAsset(){this.loadAssetCalled=!0;let t,e=await p.assetCache.getItem(this.loadAssetName,this.loadAssetPackageName);if(!this.obj)return;t=e.scene?e.scene.clone():e.clone(),this.obj.add(t),this.onAssetLoaded(t);let i=await p.game.getEnvMap();t.traverse(t=>{t instanceof THREE.Mesh&&(t.material.envMap=i,t.material.needsUpdate=!0,t.castShadow=!0)})}onAssetLoaded(t){}setSettingsStageObject(t){return t.type!=this.type||(!t.linkedDiskId||this.linkedDisk&&this.linkedDisk.id==t.linkedDiskId||(this.linkedDisk=p.game.getBalancingObjectById(t.linkedDiskId)),t.posOffset?this.posOffset.copy(t.posOffset):this.posOffset.set(0,0,0),this.scalePosWithDisk=t.scalePosWithDisk||void 0===t.scalePosWithDisk,!!this.setSettings(t))}setSettings(t){return!1}loop(t,e){if(this.linkedDisk&&this.linkedDisk.destructed&&(this.linkedDisk=null),this.linkedDisk&&this.linkedDisk.pos){let t=this.posOffset.clone();this.scalePosWithDisk&&(this.linkedDisk.isSquareShape?(t.x*=this.linkedDisk.scaleX*this.linkedDisk.customGeoAssetSize,t.z*=this.linkedDisk.scaleZ*this.linkedDisk.customGeoAssetSize):(t.x*=this.linkedDisk.radius,t.z*=this.linkedDisk.radius)),this.linkedDisk.obj.localToWorld(t),this.obj.position.copy(t),this.obj.quaternion.copy(this.rotOffset),this.obj.quaternion.premultiply(this.linkedDisk.obj.quaternion)}}}class ne{constructor(){this.balancingObject=null,this.obj=new THREE.Object3D,this.parentObjWithDisk=!0,this.scaleObjWithDisk=!0}init(t){this.balancingObject=t,this.parentObjWithDisk?this.balancingObject.obj.add(this.obj):p.game.scene.add(this.obj),this.loadAssets(),this.update()}async loadAssets(){}destructor(){this.obj&&(this.balancingObject=null,this.obj.parent.remove(this.obj),this.obj=null)}update(){this.balancingObject&&(this.scaleObjWithDisk&&this.obj.scale.setScalar(Math.max(.001,this.balancingObject.radius)),this.scaleChanged(this.balancingObject.radius))}scaleChanged(){}}class se{constructor(t){this.name=t,this.activated=!1,this.lightSettings={},this.ambientLoops=[],this.loadedAmbientLoops=null,this.onAmbientLoopsLoadCbs=[],this.isLoadingAmbientLoops=!1,this.grinderAsset="grinderBar.glb",this.grinderAssetPackage="mainHQ"}doActivate(){this.activated=!0,p.game.lights.setTheme(this.lightSettings),p.game.setGrinderAsset(this.grinderAsset,this.grinderAssetPackage),this.activate()}doDeactivate(){this.activated=!1,p.game.lights.setTheme({}),this.setPlayingAmbientLoops(!1),this.deactivate()}async activate(){}async deactivate(){}async loadAmbientLoops(){if(this.loadedAmbientLoops)return this.loadedAmbientLoops;if(this.isLoadingAmbientLoops)return await new Promise(t=>{this.onAmbientLoopsLoadCbs.push(t)});this.isLoadingAmbientLoops=!0;let t=[];for(const e of this.ambientLoops){let i=await p.sfx.getSound(e);i&&t.push(i)}this.loadedAmbientLoops=t,this.isLoadingAmbientLoops=!1;for(const e of this.onAmbientLoopsLoadCbs)e()}async setPlayingAmbientLoops(t){await this.loadAmbientLoops();for(const e of this.loadedAmbientLoops)t?e.play():e.stop()}loop(t,e){}}class re{constructor(){this.themes=[new fe,new ge,new be,new ve,new ye],this.selectedTheme=null}init(){this.setTheme("default")}getThemeByName(t){return this.themes.find(e=>e.name==t)}setTheme(t){"string"==typeof t&&(t=this.getThemeByName(t)),p&&p.music.setTheme(t.name),this.selectedTheme&&this.selectedTheme.doDeactivate(),this.selectedTheme=t,this.selectedTheme.doActivate()}setPlayingAmbientLoops(t){this.selectedTheme&&this.selectedTheme.setPlayingAmbientLoops(t)}loop(t,e){this.selectedTheme&&this.selectedTheme.loop(t,e)}}class ae extends z{constructor({left:t=null,right:e=null,top:i=null,bottom:n=null,responsiveArea:s=null}={}){super(s),this.el.classList.add("touchInputButton","touchInputWhiteBorder"),this.left=t,this.right=e,this.top=i,this.bottom=n,t&&(this.el.style.left=t+"px"),e&&(this.el.style.right=e+"px"),i&&(this.el.style.top=i+"px"),n&&(this.el.style.bottom=n+"px"),this.updateResponsiveAreaPos(),qt.addListener(t=>{this.updateResponsiveAreaPos()}),this.pressed=!1}updateResponsiveAreaPos(){if(this.responsiveArea instanceof he){const t=35;let e=0,i=0;this.left&&(e=this.left+t),this.top&&(i=this.top+t),this.right&&(e=window.innerWidth-this.right-t),this.bottom&&(i=window.innerHeight-this.bottom-t),this.responsiveArea.pos.set(e,i)}}onUpdateTouch(t){return this.pressed=!0,this.setPressedClass(),!0}onEndTouch(){this.pressed=!1,this.setPressedClass()}setPressedClass(){this.el.classList.toggle("touching",this.pressed)}}class oe extends z{constructor({defaultPos:t=new THREE.Vector2(0,0),hideWhenUsed:e=!0,responsiveArea:i=null}={}){super(i),this.currentValue=new THREE.Vector2,this.hideWhenUsed=e,this.el.classList.add("touchInputJoyStickContainer","touchInputWhiteBorder"),this.stickEl=document.createElement("div"),this.stickEl.classList.add("touchInputJoyStick"),this.el.appendChild(this.stickEl),this.lastIsTouchingValue=!1,this.lastIsTouchingToggleTime=0,this.doubleTapped=!1,this.setDefaultPos(t)}onUpdateTouch(t){let e=new THREE.Vector2(t.pageX,t.pageY);return null==this.currentUsingTouchId?(this.onIsTouchingChange(!0),this.setPos(e),!0):this.currentUsingTouchId==t.identifier?(this.setStickPos(e),this.setOpacity(.1),!0):void 0}onEndTouch(){this.onIsTouchingChange(!1),this.resetPos(),this.setOpacity(1)}onIsTouchingChange(t){this.doubleTapped=!1,t!=this.lastIsTouchingValue&&(this.lastIsTouchingValue=t,p.now-this.lastIsTouchingToggleTime<200&&t&&(this.doubleTapped=!0),this.lastIsTouchingToggleTime=p.now)}setOpacity(t){this.el.style.opacity=t}setDefaultPos(t){this.defaultPos=t.clone(),this.responsiveArea instanceof he&&this.responsiveArea.pos.copy(this.defaultPos),this.resetPos()}resetPos(){this.setPos(this.defaultPos),this.setStickPos(this.defaultPos)}setPos(t){t=t.clone(),this.containerPos=t,this.el.style.transform=`translate(${t.x}px, ${t.y}px) translate(-50%, -50%)`}setStickPos(t){let e=t.clone();e.sub(this.containerPos);let i=e.clone();e.clampLength(0,40),this.currentValue=e.clone(),this.currentValue.divideScalar(40);let n=i.sub(e),s=this.containerPos.clone().add(n);s.x=Zt.clamp(s.x,75,window.innerWidth-75),s.y=Zt.clamp(s.y,75,window.innerHeight-75),this.setPos(s),this.stickEl.style.transform=`translate(${e.x}px, ${e.y}px) translate(-50%, -50%)`}}class le extends z{constructor(){super(),this.prevTouchPos=new THREE.Vector2,this.lastDeltaPos=new THREE.Vector2}onUpdateTouch(t){let e=new THREE.Vector2(t.pageX,t.pageY);return null==this.currentUsingTouchId&&this.prevTouchPos.copy(e),this.lastDeltaPos=e.clone().sub(this.prevTouchPos),this.prevTouchPos.copy(e),!0}onEndTouch(){this.lastDeltaPos=new THREE.Vector2}}class he extends q{constructor(t,e,i){super(i),this.pos=t||new THREE.Vector2,this.radius=e}testTouchInResponsiveArea(t){return new THREE.Vector2(t.pageX,t.pageY).distanceTo(this.pos)<this.radius}}class ce extends q{constructor(t,e,i,n,s){super(s),this.left=t,this.right=e,this.top=i,this.bottom=n}testTouchInResponsiveArea(t){let e=t.pageX/window.innerWidth,i=t.pageY/window.innerHeight;return e>this.left&&e<this.right&&i>this.top&&i<this.bottom}}class ue extends ie{constructor(t){super(t),this.loadAssetName="knives.json",this.loadAssetPackageName="themeKnives",this.knifeType=null,this.mainKnife=null,this.animationType=null,this.animationTimeOffset=0,this.pos=new THREE.Vector3,this.rotation=0,this.scaleMultiplier=1,this.morphObjects=[],this.addedDiskWeight=null,this.didPlayDropSound=!1,this.didPlayWobbleSound=!1,this.didPlayChopSound=!1,this.didPlaySlideSound=!1,this.shadow=null,this.dieTypeIsVertical=!0,this.knife=null,this.posPath=null,this.overrideIntervalClosestDist=!1,this.woodChipParticleOpts={particleAssetPath:"woodChip.json",particleAssetPackage:"themeKnives",particleCount:5,duration:2,particleSize:{min:.1,max:.2},spawnerShape:{type:"boxFaces"},startVelocity:{x:.2,minY:.7,maxY:1.5,z:.2},angularVelocity:3,drag:.01,gravity:-.02},this.woodChipParticleOpts2={...this.woodChipParticleOpts,...{particleSize:{min:.4,max:.7},startVelocity:{x:.5,minY:1,maxY:2,z:.5}}}}destructor(){super.destructor(),this.morphObjects=[],this.shadow&&(this.shadow.destructor(),this.shadow=null)}onAssetLoaded(t){this.knife=t,t.scale.setScalar(this.scaleMultiplier);for(const e of t.children){let t=e.name==this.knifeType;e.visible=t,t&&(this.mainKnife=e),"knife"==e.name&&e.position.set(0,0,0)}t.traverse(t=>{t.morphTargetInfluences&&this.morphObjects.push(t)})}setSettings(t){if(super.setSettings(t),null!=this.knifeType&&this.knifeType!=t.knifeType)return!0;this.knifeType=t.knifeType,"knife"==this.knifeType?this.scaleMultiplier=2:"cleaver"==this.knifeType&&(this.scaleMultiplier=3),this.knife&&this.knife.scale.setScalar(this.scaleMultiplier),this.animationType=t.animationType;let e="falling"==this.animationType;!!this.shadow!=e&&(e?this.shadow=new S:(this.shadow.destructor(),this.shadow=null)),this.animationTimeOffset=t.animationTimeOffset||0,this.forcedAnimationTime=t.forcedAnimationTime,this.forcedAnimationTimeCurve=t.forcedAnimationTimeCurve,void 0!==t.dieTypeIsVertical&&(this.dieTypeIsVertical=t.dieTypeIsVertical),t.pos&&(this.pos.copy(t.pos),this.addedDiskWeight&&this.addedDiskWeight.setPos3d(t.pos)),void 0!==t.rotation&&(this.rotation=t.rotation,this.shadow&&this.shadow.setRot(this.rotation)),this.posPath=t.posPath,this.overrideIntervalClosestDist=!!t.overrideIntervalClosestDist,this.shadow&&this.shadow.setLinkedDisk(this.linkedDisk)}mapT(t){return void 0!==this.forcedAnimationTimeCurve?this.forcedAnimationTimeCurve(t):t}loop(t,e){let i=p.game.serverTime/1e3,n=i-this.animationTimeOffset;void 0!==this.forcedAnimationTime&&(n=this.forcedAnimationTime);let s=n;n=this.mapT(s);let r=!1,a=!1,o=!1,l=!1,h=1,c=!0;if(this.posOffset.copy(this.pos),"falling"==this.animationType){this.posOffset.y-=.5,this.posOffset.y+=100*Math.max(-n,0),this.rotOffset.setFromAxisAngle(new THREE.Vector3(1,0,0),.5*Math.PI);let t=new THREE.Quaternion;t.setFromAxisAngle(new THREE.Vector3(0,1,0),this.rotation),this.rotOffset.premultiply(t);let e=i>this.animationTimeOffset;r=this.mapT(s+.29)>0,a=n>0;const o=45,l=8;let h=0;if(e&&(h=Math.sin(n*o)*Math.pow(l,-n)),this.setMorphTarget(0,h),this.linkedDisk&&e==!this.addedDiskWeight)if(e){this.addedDiskWeight=this.linkedDisk.addCustomWeight({pos:new THREE.Vector2(this.pos.x,this.pos.z),weight:3,velocityImpact:.003});let t=this.createWoodChips();for(const e of t)e.obj.position.copy(this.obj.position)}else this.linkedDisk.removeCustomWeight(this.addedDiskWeight),this.addedDiskWeight=null;if(this.shadow){this.shadow.updatePos(new THREE.Vector2(this.posOffset.x,this.posOffset.z));let t=Math.max(0,-n);this.shadow.setScale(2+t,.7+t),this.shadow.setOpacity(Math.min(.6,.1*n+1))}}else if("chopping"==this.animationType){this.rotOffset.setFromAxisAngle(new THREE.Vector3(0,1,0),.5*-Math.PI);const t=.5,e=.7;let i=e+t,a=t=>Zt.mod(t,i)/e,o=a(n),l=a(this.mapT(s+.29)),h=0,c=.8;o<c?h=.8*-Gt.inOut(o/c)*Math.PI*.5:o<1&&(h=.8*-Gt.out(1-(o-c)/(1-c))*Math.PI*.5),h+=.1;let u=new THREE.Quaternion;if(u.setFromAxisAngle(new THREE.Vector3(0,0,1),h),this.rotOffset.premultiply(u),this.posOffset.x+=.35*this.scaleMultiplier,this.posOffset.y+=1.5*this.scaleMultiplier,this.posPath){let i=e,s=i+t,r=t=>Gt.inOut(Zt.clamp01(Zt.mod(t,s)/i))*i,a=t=>Math.min(r(t),i),o=t=>Math.floor(t/s)*i,l=(t=>a(t)+o(t))(n)/i;this.posOffset.add(this.posPath(l))}let d=o>1;if(r=l>1,this.linkedDisk&&d==!this.addedDiskWeight)if(d){this.addedDiskWeight=this.linkedDisk.addCustomWeight({pos:new THREE.Vector2(this.posOffset.x,this.posOffset.z),weight:0,velocityImpact:.003});let t=this.createWoodChips({spawnerShape:{type:"boxFaces",sizeX:2*this.scaleMultiplier,sizeY:.5,sizeZ:.5}});for(const e of t)e.obj.position.copy(this.obj.position),e.obj.position.x-=3*this.scaleMultiplier,e.obj.position.y-=1.5*this.scaleMultiplier}else this.linkedDisk.removeCustomWeight(this.addedDiskWeight),this.addedDiskWeight=null}else if("horizontalSlice"==this.animationType){this.posOffset.x+=.35*this.scaleMultiplier,this.posOffset.y+=1.5*this.scaleMultiplier;const t=1,e=.2,i=1,r=-.4,a=15,u=2;let d=Gt.inOut(Zt.clamp01(n/t)),p=n-t-e;if(l=p>0){let t=n-this.mapT(s-.1),e=Zt.iLerp(.05,.2,t);h=(c=e<.5)?Zt.lerp(.5,2,e):Zt.lerp(.4,1,e)}let m=Gt.inOut(Zt.clamp01(p/i));this.posOffset.z+=.9-1.8*m;let f=p-i-r;d-=Gt.inOut(Zt.clamp01(f/t));let g=0,y=(f-t)*a;y>0&&y<Math.PI*u&&(g=.2*Math.abs(Math.sin(y))),(y-=Math.PI)>0&&y<Math.PI*u&&(o=Zt.mod(y/Math.PI,1)<.5);let v=d*Math.PI*.47;this.posOffset.y-=this.scaleMultiplier*(1-Math.cos(v))*1.5,this.posOffset.z+=this.scaleMultiplier*Math.sin(v)*.1,this.rotOffset.setFromAxisAngle(new THREE.Vector3(0,1,0),.5*-Math.PI);let b=new THREE.Quaternion;b.setFromAxisAngle(new THREE.Vector3(0,0,1),.1-g),this.rotOffset.premultiply(b);let w=new THREE.Quaternion;w.setFromAxisAngle(new THREE.Vector3(1,0,0),v),this.rotOffset.premultiply(w)}let u=p.game.gameStateManager.currentState==ft.GameState.STARTED;r!=this.didPlayDropSound&&(r&&u&&p.sfx.playSound("knifeDrop",Zt.randRange(.9,1.2)),this.didPlayDropSound=r),a!=this.didPlayWobbleSound&&(a&&u&&p.sfx.playSound("knifeWobble",Zt.randRange(.8,1.3)),this.didPlayWobbleSound=a),o!=this.didPlayChopSound&&(o&&u&&p.sfx.playSound("knifeChop",Zt.randRange(.9,1.1)),this.didPlayChopSound=o),l!=this.didPlaySlideSound&&(l&&u&&p.sfx.playSound("knifeSlide"+(c?"Long":"Short"),h),this.didPlaySlideSound=l),super.loop(t,e)}setMorphTarget(t,e){for(const i of this.morphObjects)i.morphTargetInfluences[t]=e}getDistanceFromSharpEdge(t){let e=1/0,i=1/0;if(this.mainKnife){let n=this.mainKnife.getObjectByName("collider"),s=[];for(const t of n.children)s.push(t.getWorldPosition(new THREE.Vector3));let r=[];s.length>=3&&r.push(new THREE.Triangle(s[0],s[1],s[2])),s.length>=4&&r.push(new THREE.Triangle(s[0],s[2],s[3]));for(const a of r){let n=a.closestPointToPoint(t,new THREE.Vector3),s=new THREE.Vector2(n.x,n.z);e=Math.min(t.distanceTo(n),e);let r=new THREE.Vector2(t.x,t.z);i=Math.min(r.distanceTo(s),i)}}else e=Math.abs(t.z-this.obj.getWorldPosition(new THREE.Vector3).z),i=0;return{closestDist:e,intervalDist:i}}createWoodChips(t={}){let e=p.particles.createSystem({...this.woodChipParticleOpts,...t}),i=p.particles.createSystem({...this.woodChipParticleOpts2,...t}),n=[];return e&&n.push(e),i&&n.push(i),n}}class de extends ie{constructor(t){super(t),this.pos=new THREE.Vector3,this.rotation=0,this.saws=[],this.middlePiece=null,this.pillar=null,this.sawsRotateSpeed=.1,this.loadAssetName="saw.glb",this.loadAssetPackageName="themeSaws"}destructor(){super.destructor(),this.saws=[],this.middlePiece=null}init(){super.init()}onAssetLoaded(t){for(const e of t.getObjectByName("Saw_Arm002").children)this.saws.push(e),e.rotateY(Math.random()*Math.PI*2);this.middlePiece=t.getObjectByName("sawMiddlePiece002"),this.pillar=t.getObjectByName("sawPillar")}setSettings(t){super.setSettings(t),t.pos&&this.pos.copy(t.pos),void 0!==t.rotation&&(this.rotation=t.rotation);let e=t.middlePieceVisible||void 0===t.middlePieceVisible;if(this.middlePiece&&(this.middlePiece.visible=e),this.pillar){let i=1;void 0!==t.height&&(i=t.height);let n=void 0===t.height||i>0;this.pillar.visible=e&&n,i=Math.max(.001,i),this.pillar.scale.y=-i}}loop(t,e){this.posOffset.copy(this.pos),this.posOffset.y+=1.5,this.rotOffset.setFromAxisAngle(new THREE.Vector3(0,1,0),this.rotation),super.loop(t,e);for(const i of this.saws)i.rotateY(-e*this.sawsRotateSpeed*p.game.timeScale)}getDistanceFromSaw(t){let e=new THREE.Vector3(0,0,-20);e.applyQuaternion(this.obj.quaternion),e.add(this.obj.position);let i=new THREE.Line3(this.obj.position,e),n=new THREE.Vector3;return i.closestPointToPoint(t,!0,n),n.distanceTo(t)}}class pe extends ne{constructor(){super(),this.scaleObjWithDisk=!1,this.createdIcicles=[]}async loadAssets(){let t=await p.assetCache.getItem("icicle.json","themeIce");if(this.obj)for(let e=0;e<20;e++){let e=Zt.randRange(0,2*Math.PI),i=Zt.randInt(2,3);for(let n=0;n<i;n++){let i=e+Zt.randRange(0,.1),n=t.clone();n.rotation.y=Zt.randRange(0,2*Math.PI),n.rotation.z=Math.PI;let s=Zt.randInt(0,n.children.length);for(let t=0;t<n.children.length;t++){n.children[t].visible=t==s}this.createdIcicles.push({icicle:n,phi:i,scale:Zt.randRange(.5,3)}),this.obj.add(n)}}}destructor(){super.destructor(),this.createdIcicles=[]}scaleChanged(t){for(const e of this.createdIcicles){let i=t-.5*e.scale;e.icicle.position.x=Math.cos(e.phi)*i,e.icicle.position.y=-.1*t-.1,e.icicle.position.z=Math.sin(e.phi)*i;let n=e.scale*((t-1)/10);n=Math.max(.001,n),e.icicle.scale.setScalar(n)}}}class me extends ne{constructor(){super()}async loadAssets(){let t=await p.assetCache.getItem("bundle.glb","themeSumo");if(!this.obj)return;for(let e=0;e<26;e++){let i=e/26*Math.PI*2,n=t.scene.clone();n.scale.setScalar(.025);let s=.95;n.position.x=Math.sin(i)*s,n.position.z=Math.cos(i)*s,n.rotation.y=i+.5*Math.PI;let r=Zt.randInt(0,n.children.length);for(let t=0;t<n.children.length;t++){n.children[t].visible=t==r}this.obj.add(n)}}}class fe extends se{constructor(){super("default")}}class ge extends se{constructor(){super("ice"),this.lightSettings={lightsValues:[{name:"grinderSpotlight",color:new THREE.Color(36607),intensity:5}]},this.ambientLoops=["freezerAmbient"],this.createdIcicles=null,this.environmentParticles=null}async activate(){let t=new THREE.Object3D;p.game.scene.add(t);let e=await p.assetCache.getItem("icicle.json","themeIce");if(this.activated){for(let i=0;i<10;i++){let i=Zt.randRange(0,2*Math.PI),n=Zt.randInt(2,3);for(let s=0;s<n;s++){let n=i+Zt.randRange(0,.1),s=e.clone();s.position.x=70*Math.cos(n),s.position.y=-3.6,s.position.z=70*Math.sin(n),s.rotation.y=Zt.randRange(0,2*Math.PI),s.rotation.z=Math.PI,s.scale.setScalar(Zt.randRange(2,4));let r=Zt.randInt(0,s.children.length);for(let t=0;t<s.children.length;t++){s.children[t].visible=t==r}t.add(s)}}this.createdIcicles=t,this.environmentParticles=p.particles.createSystem({particleAssetPath:"particles/iceTinyShards.json",pickRandomChild:!0,particleCount:80,spawnerShape:{type:"box",size:20,sizeY:.3},particleSize:{min:.2,max:.4},gravity:0,duration:0})}}async deactivate(){this.createdIcicles&&(this.createdIcicles.parent.remove(this.createdIcicles),this.createdIcicles=null),this.environmentParticles&&this.environmentParticles.destructor()}}class ye extends se{constructor(){super("knives"),this.ambientLoops=["kitchenAmbient"]}}class ve extends se{constructor(){super("saws"),this.ambientLoops=["sawAmbient"],this.sawsVolumeTarget=0,this.smoothSawsVolume=0}setSawsVolume(t){this.sawsVolumeTarget=t}loop(t,e){if(this.smoothSawsVolume=Zt.lerpt(this.smoothSawsVolume,this.sawsVolumeTarget,.1),this.smoothSawsVolume=Math.max(this.smoothSawsVolume,this.sawsVolumeTarget),this.loadedAmbientLoops)for(const i of this.loadedAmbientLoops)i.setVolume(this.smoothSawsVolume)}}class be extends se{constructor(){super("sumo"),this.grinderAsset="bambooGrinder.glb",this.grinderAssetPackage="themeSumo"}}var we,xe,Se,Ee,Me;we=this,xe=function(t){function e(){}function i(t,e){this.x=t||0,this.y=e||0}function n(t,e,i,n){this._x=t||0,this._y=e||0,this._z=i||0,this._w=void 0!==n?n:1}function s(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0}function r(){this.elements=[1,0,0,0,1,0,0,0,1],0<arguments.length&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}function a(t,e,n,s,o,l,h,c,u,d){Object.defineProperty(this,"id",{value:Qs++}),this.uuid=Js.generateUUID(),this.name="",this.image=void 0!==t?t:a.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==e?e:a.DEFAULT_MAPPING,this.wrapS=void 0!==n?n:1001,this.wrapT=void 0!==s?s:1001,this.magFilter=void 0!==o?o:1006,this.minFilter=void 0!==l?l:1008,this.anisotropy=void 0!==u?u:1,this.format=void 0!==h?h:1023,this.type=void 0!==c?c:1009,this.offset=new i(0,0),this.repeat=new i(1,1),this.center=new i(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new r,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==d?d:3e3,this.version=0,this.onUpdate=null}function o(t,e,i,n){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==n?n:1}function l(t,e,i){this.width=t,this.height=e,this.scissor=new o(0,0,t,e),this.scissorTest=!1,this.viewport=new o(0,0,t,e),i=i||{},this.texture=new a(void 0,void 0,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:1006,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0===i.stencilBuffer||i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}function h(t,e,i){l.call(this,t,e,i),this.samples=4}function c(t,e,i){l.call(this,t,e,i)}function u(t,e,i,n,s,r,o,l,h,c,u,d){a.call(this,null,r,o,l,h,c,n,s,u,d),this.image={data:t,width:e,height:i},this.magFilter=void 0!==h?h:1003,this.minFilter=void 0!==c?c:1003,this.flipY=this.generateMipmaps=!1,this.unpackAlignment=1}function d(t,e){this.min=void 0!==t?t:new s(1/0,1/0,1/0),this.max=void 0!==e?e:new s(-1/0,-1/0,-1/0)}function p(t,e){this.center=void 0!==t?t:new s,this.radius=void 0!==e?e:0}function m(t,e){this.normal=void 0!==t?t:new s(1,0,0),this.constant=void 0!==e?e:0}function f(t,e,i,n,s,r){this.planes=[void 0!==t?t:new m,void 0!==e?e:new m,void 0!==i?i:new m,void 0!==n?n:new m,void 0!==s?s:new m,void 0!==r?r:new m]}function g(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],0<arguments.length&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function y(t){var e,i={};for(e in t)for(var n in i[e]={},t[e]){var s=t[e][n];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture)?i[e][n]=s.clone():Array.isArray(s)?i[e][n]=s.slice():i[e][n]=s}return i}function v(t){for(var e={},i=0;i<t.length;i++){var n,s=y(t[i]);for(n in s)e[n]=s[n]}return e}function b(t,e,i){return void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}function w(){function t(s,r){!1!==i&&(n(s,r),e.requestAnimationFrame(t))}var e=null,i=!1,n=null;return{start:function(){!0!==i&&null!==n&&(e.requestAnimationFrame(t),i=!0)},stop:function(){i=!1},setAnimationLoop:function(t){n=t},setContext:function(t){e=t}}}function x(t){var e=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),e.get(t)},remove:function(i){i.isInterleavedBufferAttribute&&(i=i.data);var n=e.get(i);n&&(t.deleteBuffer(n.buffer),e.delete(i))},update:function(i,n){i.isInterleavedBufferAttribute&&(i=i.data);var s=e.get(i);if(void 0===s)e.set(i,function(e,i){var n=e.array,s=e.dynamic?35048:35044,r=t.createBuffer();return t.bindBuffer(i,r),t.bufferData(i,n,s),e.onUploadCallback(),i=5126,n instanceof Float32Array?i=5126:n instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):n instanceof Uint16Array?i=5123:n instanceof Int16Array?i=5122:n instanceof Uint32Array?i=5125:n instanceof Int32Array?i=5124:n instanceof Int8Array?i=5120:n instanceof Uint8Array&&(i=5121),{buffer:r,type:i,bytesPerElement:n.BYTES_PER_ELEMENT,version:e.version}}(i,n));else if(s.version<i.version){var r=i,a=r.array,o=r.updateRange;t.bindBuffer(n,s.buffer),!1===r.dynamic?t.bufferData(n,a,35044):-1===o.count?t.bufferSubData(n,0,a):0===o.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(t.bufferSubData(n,o.offset*a.BYTES_PER_ELEMENT,a.subarray(o.offset,o.offset+o.count)),o.count=-1),s.version=i.version}}}}function S(t,e,i,n,r,a){this.a=t,this.b=e,this.c=i,this.normal=n&&n.isVector3?n:new s,this.vertexNormals=Array.isArray(n)?n:[],this.color=r&&r.isColor?r:new b,this.vertexColors=Array.isArray(r)?r:[],this.materialIndex=void 0!==a?a:0}function E(t,e,i,n){this._x=t||0,this._y=e||0,this._z=i||0,this._order=n||E.DefaultOrder}function M(){this.mask=1}function T(){Object.defineProperty(this,"id",{value:sr++}),this.uuid=Js.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=T.DefaultUp.clone();var t=new s,e=new E,i=new n,a=new s(1,1,1);e.onChange(function(){i.setFromEuler(e,!1)}),i.onChange(function(){e.setFromQuaternion(i,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:a},modelViewMatrix:{value:new g},normalMatrix:{value:new r}}),this.matrix=new g,this.matrixWorld=new g,this.matrixAutoUpdate=T.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new M,this.visible=!0,this.receiveShadow=this.castShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}function C(){Object.defineProperty(this,"id",{value:rr+=2}),this.uuid=Js.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingSphere=this.boundingBox=null,this.groupsNeedUpdate=this.lineDistancesNeedUpdate=this.colorsNeedUpdate=this.normalsNeedUpdate=this.uvsNeedUpdate=this.verticesNeedUpdate=this.elementsNeedUpdate=!1}function P(t,e,i){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===i,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function _(t,e,i){P.call(this,new Int8Array(t),e,i)}function A(t,e,i){P.call(this,new Uint8Array(t),e,i)}function L(t,e,i){P.call(this,new Uint8ClampedArray(t),e,i)}function R(t,e,i){P.call(this,new Int16Array(t),e,i)}function I(t,e,i){P.call(this,new Uint16Array(t),e,i)}function O(t,e,i){P.call(this,new Int32Array(t),e,i)}function D(t,e,i){P.call(this,new Uint32Array(t),e,i)}function k(t,e,i){P.call(this,new Float32Array(t),e,i)}function B(t,e,i){P.call(this,new Float64Array(t),e,i)}function H(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingSphere=this.boundingBox=null,this.groupsNeedUpdate=this.uvsNeedUpdate=this.colorsNeedUpdate=this.normalsNeedUpdate=this.verticesNeedUpdate=!1}function N(t){if(0===t.length)return-1/0;for(var e=t[0],i=1,n=t.length;i<n;++i)t[i]>e&&(e=t[i]);return e}function F(){Object.defineProperty(this,"id",{value:ar+=2}),this.uuid=Js.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingSphere=this.boundingBox=null,this.drawRange={start:0,count:1/0},this.userData={}}function V(t,e,i,n,s,r){C.call(this),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:s,depthSegments:r},this.fromBufferGeometry(new j(t,e,i,n,s,r)),this.mergeVertices()}function j(t,e,i,n,r,a){function o(t,e,i,n,r,a,o,f,g,y,v){var b=a/g,w=o/y,x=a/2,S=o/2,E=f/2;o=g+1;var M,T,C=y+1,P=a=0,_=new s;for(T=0;T<C;T++){var A=T*w-S;for(M=0;M<o;M++)_[t]=(M*b-x)*n,_[e]=A*r,_[i]=E,c.push(_.x,_.y,_.z),_[t]=0,_[e]=0,_[i]=0<f?1:-1,u.push(_.x,_.y,_.z),d.push(M/g),d.push(1-T/y),a+=1}for(T=0;T<y;T++)for(M=0;M<g;M++)t=p+M+o*(T+1),e=p+(M+1)+o*(T+1),i=p+(M+1)+o*T,h.push(p+M+o*T,t,i),h.push(t,e,i),P+=6;l.addGroup(m,P,v),m+=P,p+=a}F.call(this),this.type="BoxBufferGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:r,depthSegments:a};var l=this;t=t||1,e=e||1,i=i||1,n=Math.floor(n)||1,r=Math.floor(r)||1;var h=[],c=[],u=[],d=[],p=0,m=0;o("z","y","x",-1,-1,i,e,t,a=Math.floor(a)||1,r,0),o("z","y","x",1,-1,i,e,-t,a,r,1),o("x","z","y",1,1,t,i,e,n,a,2),o("x","z","y",1,-1,t,i,-e,n,a,3),o("x","y","z",1,-1,t,e,i,n,r,4),o("x","y","z",-1,-1,t,e,-i,n,r,5),this.setIndex(h),this.addAttribute("position",new k(c,3)),this.addAttribute("normal",new k(u,3)),this.addAttribute("uv",new k(d,2))}function G(t,e,i,n){C.call(this),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n},this.fromBufferGeometry(new U(t,e,i,n)),this.mergeVertices()}function U(t,e,i,n){F.call(this),this.type="PlaneBufferGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n};var s=(t=t||1)/2,r=(e=e||1)/2,a=(i=Math.floor(i)||1)+1,o=(n=Math.floor(n)||1)+1,l=t/i,h=e/n,c=[],u=[],d=[],p=[];for(t=0;t<o;t++){var m=t*h-r;for(e=0;e<a;e++)u.push(e*l-s,-m,0),d.push(0,0,1),p.push(e/i),p.push(1-t/n)}for(t=0;t<n;t++)for(e=0;e<i;e++)s=e+a*(t+1),r=e+1+a*(t+1),o=e+1+a*t,c.push(e+a*t,s,o),c.push(s,r,o);this.setIndex(c),this.addAttribute("position",new k(u,3)),this.addAttribute("normal",new k(d,3)),this.addAttribute("uv",new k(p,2))}function z(){Object.defineProperty(this,"id",{value:or++}),this.uuid=Js.generateUUID(),this.name="",this.type="Material",this.lights=this.fog=!0,this.blending=1,this.side=0,this.vertexTangents=this.flatShading=!1,this.vertexColors=0,this.opacity=1,this.transparent=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=100,this.blendEquationAlpha=this.blendDstAlpha=this.blendSrcAlpha=null,this.depthFunc=3,this.depthWrite=this.depthTest=!0,this.clippingPlanes=null,this.clipShadows=this.clipIntersection=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetUnits=this.polygonOffsetFactor=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.userData={},this.needsUpdate=!0}function W(t){z.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.morphNormals=this.morphTargets=this.skinning=this.clipping=this.lights=this.fog=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,void 0!==t&&(void 0!==t.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(t))}function q(t,e){this.origin=void 0!==t?t:new s,this.direction=void 0!==e?e:new s}function Y(t,e,i){this.a=void 0!==t?t:new s,this.b=void 0!==e?e:new s,this.c=void 0!==i?i:new s}function X(t){z.call(this),this.type="MeshBasicMaterial",this.color=new b(16777215),this.lightMap=this.map=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.envMap=this.alphaMap=this.specularMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.lights=this.morphTargets=this.skinning=!1,this.setValues(t)}function J(t,e){T.call(this),this.type="Mesh",this.geometry=void 0!==t?t:new F,this.material=void 0!==e?e:new X({color:16777215*Math.random()}),this.drawMode=0,this.updateMorphTargets()}function K(t,e,i,n){function s(t,i){e.buffers.color.setClear(t.r,t.g,t.b,i,n)}var r,a,o=new b(0),l=0,h=null,c=0;return{getClearColor:function(){return o},setClearColor:function(t,e){o.set(t),s(o,l=void 0!==e?e:1)},getClearAlpha:function(){return l},setClearAlpha:function(t){s(o,l=t)},render:function(e,n,u,d){n=n.background,(u=(u=t.vr).getSession&&u.getSession())&&"additive"===u.environmentBlendMode&&(n=null),null===n?(s(o,l),h=null,c=0):n&&n.isColor&&(s(n,1),d=!0,h=null,c=0),(t.autoClear||d)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),n&&(n.isCubeTexture||n.isWebGLRenderTargetCube)?(void 0===a&&((a=new J(new j(1,1,1),new W({type:"BackgroundCubeMaterial",uniforms:y(nr.cube.uniforms),vertexShader:nr.cube.vertexShader,fragmentShader:nr.cube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1}))).geometry.removeAttribute("normal"),a.geometry.removeAttribute("uv"),a.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(a.material,"map",{get:function(){return this.uniforms.tCube.value}}),i.update(a)),d=n.isWebGLRenderTargetCube?n.texture:n,a.material.uniforms.tCube.value=d,a.material.uniforms.tFlip.value=n.isWebGLRenderTargetCube?1:-1,h===n&&c===d.version||(a.material.needsUpdate=!0,h=n,c=d.version),e.unshift(a,a.geometry,a.material,0,0,null)):n&&n.isTexture&&(void 0===r&&((r=new J(new U(2,2),new W({type:"BackgroundMaterial",uniforms:y(nr.background.uniforms),vertexShader:nr.background.vertexShader,fragmentShader:nr.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1}))).geometry.removeAttribute("normal"),Object.defineProperty(r.material,"map",{get:function(){return this.uniforms.t2D.value}}),i.update(r)),r.material.uniforms.t2D.value=n,!0===n.matrixAutoUpdate&&n.updateMatrix(),r.material.uniforms.uvTransform.value.copy(n.matrix),h===n&&c===n.version||(r.material.needsUpdate=!0,h=n,c=n.version),e.unshift(r,r.geometry,r.material,0,0,null))}}}function Z(){function t(){c.value!==n&&(c.value=n,c.needsUpdate=0<s),i.numPlanes=s,i.numIntersection=0}function e(t,e,n,s){var r=null!==t?t.length:0,a=null;if(0!==r){if(a=c.value,!0!==s||null===a)for(s=n+4*r,e=e.matrixWorldInverse,h.getNormalMatrix(e),(null===a||a.length<s)&&(a=new Float32Array(s)),s=0;s!==r;++s,n+=4)l.copy(t[s]).applyMatrix4(e,h),l.normal.toArray(a,n),a[n+3]=l.constant;c.value=a,c.needsUpdate=!0}return i.numPlanes=r,a}var i=this,n=null,s=0,a=!1,o=!1,l=new m,h=new r,c={value:null,needsUpdate:!1};this.uniform=c,this.numIntersection=this.numPlanes=0,this.init=function(t,i,r){var o=0!==t.length||i||0!==s||a;return a=i,n=e(t,r,0),s=t.length,o},this.beginShadows=function(){o=!0,e(null)},this.endShadows=function(){o=!1,t()},this.setState=function(i,r,l,h,u,d){if(!a||null===i||0===i.length||o&&!l)o?e(null):t();else{var p=4*(l=o?0:s),m=u.clippingState||null;for(c.value=m,m=e(i,h,p,d),i=0;i!==p;++i)m[i]=n[i];u.clippingState=m,this.numIntersection=r?this.numPlanes:0,this.numPlanes+=l}}}function Q(t,e,i){function n(t){var a=t.target;for(var o in null!==(t=s[a.id]).index&&e.remove(t.index),t.attributes)e.remove(t.attributes[o]);a.removeEventListener("dispose",n),delete s[a.id],(o=r[t.id])&&(e.remove(o),delete r[t.id]),i.memory.geometries--}var s={},r={};return{get:function(t,e){var r=s[e.id];return r||(e.addEventListener("dispose",n),e.isBufferGeometry?r=e:e.isGeometry&&(void 0===e._bufferGeometry&&(e._bufferGeometry=(new F).setFromObject(t)),r=e._bufferGeometry),s[e.id]=r,i.memory.geometries++,r)},update:function(t){var i=t.index,n=t.attributes;for(var s in null!==i&&e.update(i,34963),n)e.update(n[s],34962);for(s in t=t.morphAttributes){n=0;for(var r=(i=t[s]).length;n<r;n++)e.update(i[n],34962)}},getWireframeAttribute:function(t){var i=r[t.id];if(i)return i;i=[];var n=t.index,s=t.attributes;if(null!==n){s=0;for(var a=(n=n.array).length;s<a;s+=3){var o=n[s+0],l=n[s+1],h=n[s+2];i.push(o,l,l,h,h,o)}}else for(n=s.position.array,s=0,a=n.length/3-1;s<a;s+=3)o=s+0,l=s+1,h=s+2,i.push(o,l,l,h,h,o);return i=new(65535<N(i)?D:I)(i,1),e.update(i,34963),r[t.id]=i}}}function $(t,e){return Math.abs(e[1])-Math.abs(t[1])}function tt(t,e,i,n,s,r,o,l,h,c){t=void 0!==t?t:[],a.call(this,t,void 0!==e?e:301,i,n,s,r,void 0!==o?o:1022,l,h,c),this.flipY=!1}function et(t,e,i,n){a.call(this,null),this.image={data:t,width:e,height:i,depth:n},this.minFilter=this.magFilter=1003,this.wrapR=1001,this.flipY=this.generateMipmaps=!1}function it(t,e,i,n){a.call(this,null),this.image={data:t,width:e,height:i,depth:n},this.minFilter=this.magFilter=1003,this.wrapR=1001,this.flipY=this.generateMipmaps=!1}function nt(t,e,i){var n=t[0];if(0>=n||0<n)return t;var s=e*i,r=dr[s];if(void 0===r&&(r=new Float32Array(s),dr[s]=r),0!==e)for(n.toArray(r,0),n=1,s=0;n!==e;++n)s+=i,t[n].toArray(r,s);return r}function st(t,e){if(t.length!==e.length)return!1;for(var i=0,n=t.length;i<n;i++)if(t[i]!==e[i])return!1;return!0}function rt(t,e){for(var i=0,n=e.length;i<n;i++)t[i]=e[i]}function at(t,e){var i=pr[e];void 0===i&&(i=new Int32Array(e),pr[e]=i);for(var n=0;n!==e;++n)i[n]=t.allocateTextureUnit();return i}function ot(t,e){var i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function lt(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y):st(i,e)||(t.uniform2fv(this.addr,e),rt(i,e))}function ht(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z):void 0!==e.r?i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b):st(i,e)||(t.uniform3fv(this.addr,e),rt(i,e))}function ct(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w):st(i,e)||(t.uniform4fv(this.addr,e),rt(i,e))}function ut(t,e){var i=this.cache,n=e.elements;void 0===n?st(i,e)||(t.uniformMatrix2fv(this.addr,!1,e),rt(i,e)):st(i,n)||(gr.set(n),t.uniformMatrix2fv(this.addr,!1,gr),rt(i,n))}function dt(t,e){var i=this.cache,n=e.elements;void 0===n?st(i,e)||(t.uniformMatrix3fv(this.addr,!1,e),rt(i,e)):st(i,n)||(fr.set(n),t.uniformMatrix3fv(this.addr,!1,fr),rt(i,n))}function pt(t,e){var i=this.cache,n=e.elements;void 0===n?st(i,e)||(t.uniformMatrix4fv(this.addr,!1,e),rt(i,e)):st(i,n)||(mr.set(n),t.uniformMatrix4fv(this.addr,!1,mr),rt(i,n))}function mt(t,e,i){var n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(t.uniform1i(this.addr,s),n[0]=s),i.safeSetTexture2D(e||lr,s)}function ft(t,e,i){var n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(t.uniform1i(this.addr,s),n[0]=s),i.setTexture2DArray(e||hr,s)}function gt(t,e,i){var n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(t.uniform1i(this.addr,s),n[0]=s),i.setTexture3D(e||cr,s)}function yt(t,e,i){var n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(t.uniform1i(this.addr,s),n[0]=s),i.safeSetTextureCube(e||ur,s)}function vt(t,e){var i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function bt(t,e){var i=this.cache;st(i,e)||(t.uniform2iv(this.addr,e),rt(i,e))}function wt(t,e){var i=this.cache;st(i,e)||(t.uniform3iv(this.addr,e),rt(i,e))}function xt(t,e){var i=this.cache;st(i,e)||(t.uniform4iv(this.addr,e),rt(i,e))}function St(t,e){t.uniform1fv(this.addr,e)}function Et(t,e){t.uniform1iv(this.addr,e)}function Mt(t,e){t.uniform2iv(this.addr,e)}function Tt(t,e){t.uniform3iv(this.addr,e)}function Ct(t,e){t.uniform4iv(this.addr,e)}function Pt(t,e){e=nt(e,this.size,2),t.uniform2fv(this.addr,e)}function _t(t,e){e=nt(e,this.size,3),t.uniform3fv(this.addr,e)}function At(t,e){e=nt(e,this.size,4),t.uniform4fv(this.addr,e)}function Lt(t,e){e=nt(e,this.size,4),t.uniformMatrix2fv(this.addr,!1,e)}function Rt(t,e){e=nt(e,this.size,9),t.uniformMatrix3fv(this.addr,!1,e)}function It(t,e){e=nt(e,this.size,16),t.uniformMatrix4fv(this.addr,!1,e)}function Ot(t,e,i){var n=e.length,s=at(i,n);for(t.uniform1iv(this.addr,s),t=0;t!==n;++t)i.safeSetTexture2D(e[t]||lr,s[t])}function Dt(t,e,i){var n=e.length,s=at(i,n);for(t.uniform1iv(this.addr,s),t=0;t!==n;++t)i.safeSetTextureCube(e[t]||ur,s[t])}function kt(t,e,i){this.id=t,this.addr=i,this.cache=[],this.setValue=function(t){switch(t){case 5126:return ot;case 35664:return lt;case 35665:return ht;case 35666:return ct;case 35674:return ut;case 35675:return dt;case 35676:return pt;case 35678:case 36198:return mt;case 35679:return gt;case 35680:return yt;case 36289:return ft;case 5124:case 35670:return vt;case 35667:case 35671:return bt;case 35668:case 35672:return wt;case 35669:case 35673:return xt}}(e.type)}function Bt(t,e,i){this.id=t,this.addr=i,this.cache=[],this.size=e.size,this.setValue=function(t){switch(t){case 5126:return St;case 35664:return Pt;case 35665:return _t;case 35666:return At;case 35674:return Lt;case 35675:return Rt;case 35676:return It;case 35678:return Ot;case 35680:return Dt;case 5124:case 35670:return Et;case 35667:case 35671:return Mt;case 35668:case 35672:return Tt;case 35669:case 35673:return Ct}}(e.type)}function Ht(t){this.id=t,this.seq=[],this.map={}}function Nt(t,e){this.seq=[],this.map={};for(var i=t.getProgramParameter(e,35718),n=0;n<i;++n){var s=t.getActiveUniform(e,n),r=t.getUniformLocation(e,s.name),a=this,o=s.name,l=o.length;for(yr.lastIndex=0;;){var h=yr.exec(o),c=yr.lastIndex,u=h[1],d=h[3];if("]"===h[2]&&(u|=0),void 0===d||"["===d&&c+2===l){o=a,s=void 0===d?new kt(u,s,r):new Bt(u,s,r),o.seq.push(s),o.map[s.id]=s;break}void 0===(d=a.map[u])&&(d=new Ht(u),u=a,a=d,u.seq.push(a),u.map[a.id]=a),a=d}}}function Ft(t,e,i,n){var s=t.createShader(e);return t.shaderSource(s,i),t.compileShader(s),!0===n&&(!1===t.getShaderParameter(s,35713)&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==t.getShaderInfoLog(s)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",35633===e?"vertex":"fragment",t.getShaderInfoLog(s),function(t){t=t.split("\n");for(var e=0;e<t.length;e++)t[e]=e+1+": "+t[e];return t.join("\n")}(i))),s}function Vt(t){switch(t){case 3e3:return["Linear","( value )"];case 3001:return["sRGB","( value )"];case 3002:return["RGBE","( value )"];case 3004:return["RGBM","( value, 7.0 )"];case 3005:return["RGBM","( value, 16.0 )"];case 3006:return["RGBD","( value, 256.0 )"];case 3007:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw Error("unsupported encoding: "+t)}}function jt(t,e){return"vec4 "+t+"( vec4 value ) { return "+(e=Vt(e))[0]+"ToLinear"+e[1]+"; }"}function Gt(t){return""!==t}function Ut(t,e){return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights)}function zt(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}function Wt(t){return t.replace(/^[ \t]*#include +<([\w\d./]+)>/gm,function(t,e){if(void 0===(t=$s[e]))throw Error("Can not resolve #include <"+e+">");return Wt(t)})}function qt(t){return t.replace(/#pragma unroll_loop[\s]+?for \( int i = (\d+); i < (\d+); i \+\+ \) \{([\s\S]+?)(?=\})\}/g,function(t,e,i,n){for(t="",e=parseInt(e);e<parseInt(i);e++)t+=n.replace(/\[ i \]/g,"[ "+e+" ]");return t})}function Yt(t,e,i,n,s,r,a,o){var l=t.context,h=n.defines,c=s.vertexShader,u=s.fragmentShader,d="SHADOWMAP_TYPE_BASIC";1===r.shadowMapType?d="SHADOWMAP_TYPE_PCF":2===r.shadowMapType&&(d="SHADOWMAP_TYPE_PCF_SOFT");var p="ENVMAP_TYPE_CUBE",m="ENVMAP_MODE_REFLECTION",f="ENVMAP_BLENDING_MULTIPLY";if(r.envMap){switch(n.envMap.mapping){case 301:case 302:p="ENVMAP_TYPE_CUBE";break;case 306:case 307:p="ENVMAP_TYPE_CUBE_UV";break;case 303:case 304:p="ENVMAP_TYPE_EQUIREC";break;case 305:p="ENVMAP_TYPE_SPHERE"}switch(n.envMap.mapping){case 302:case 304:m="ENVMAP_MODE_REFRACTION"}switch(n.combine){case 0:f="ENVMAP_BLENDING_MULTIPLY";break;case 1:f="ENVMAP_BLENDING_MIX";break;case 2:f="ENVMAP_BLENDING_ADD"}}var g,y,v=0<t.gammaFactor?t.gammaFactor:1,b=a.isWebGL2?"":function(t,e,i){return[(t=t||{}).derivatives||e.envMapCubeUV||e.bumpMap||e.normalMap&&!e.objectSpaceNormalMap||e.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(t.fragDepth||e.logarithmicDepthBuffer)&&i.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",t.drawBuffers&&i.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(t.shaderTextureLOD||e.envMap)&&i.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Gt).join("\n")}(n.extensions,r,e),w=function(t){var e,i=[];for(e in t){var n=t[e];!1!==n&&i.push("#define "+e+" "+n)}return i.join("\n")}(h),x=l.createProgram();return n.isRawShaderMaterial?(0<(h=[w].filter(Gt).join("\n")).length&&(h+="\n"),0<(e=[b,w].filter(Gt).join("\n")).length&&(e+="\n")):(h=["precision "+r.precision+" float;","precision "+r.precision+" int;","#define SHADER_NAME "+s.name,w,r.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+v,"#define MAX_BONES "+r.maxBones,r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp?"#define FOG_EXP2":"",r.map?"#define USE_MAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+m:"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.normalMap&&r.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",r.displacementMap&&r.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.vertexTangents?"#define USE_TANGENT":"",r.vertexColors?"#define USE_COLOR":"",r.flatShading?"#define FLAT_SHADED":"",r.skinning?"#define USE_SKINNING":"",r.useVertexTexture?"#define BONE_TEXTURE":"",r.morphTargets?"#define USE_MORPHTARGETS":"",r.morphNormals&&!1===r.flatShading?"#define USE_MORPHNORMALS":"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"",r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+d:"",r.sizeAttenuation?"#define USE_SIZEATTENUATION":"",r.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",r.logarithmicDepthBuffer&&(a.isWebGL2||e.get("EXT_frag_depth"))?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Gt).join("\n"),e=[b,"precision "+r.precision+" float;","precision "+r.precision+" int;","#define SHADER_NAME "+s.name,w,r.alphaTest?"#define ALPHATEST "+r.alphaTest+(r.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+v,r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp?"#define FOG_EXP2":"",r.map?"#define USE_MAP":"",r.matcap?"#define USE_MATCAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+p:"",r.envMap?"#define "+m:"",r.envMap?"#define "+f:"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.normalMap&&r.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.vertexTangents?"#define USE_TANGENT":"",r.vertexColors?"#define USE_COLOR":"",r.gradientMap?"#define USE_GRADIENTMAP":"",r.flatShading?"#define FLAT_SHADED":"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"",r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+d:"",r.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",r.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",r.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",r.logarithmicDepthBuffer&&(a.isWebGL2||e.get("EXT_frag_depth"))?"#define USE_LOGDEPTHBUF_EXT":"",r.envMap&&(a.isWebGL2||e.get("EXT_shader_texture_lod"))?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",0!==r.toneMapping?"#define TONE_MAPPING":"",0!==r.toneMapping?$s.tonemapping_pars_fragment:"",0!==r.toneMapping?function(t,e){switch(e){case 1:e="Linear";break;case 2:e="Reinhard";break;case 3:e="Uncharted2";break;case 4:e="OptimizedCineon";break;case 5:e="ACESFilmic";break;default:throw Error("unsupported toneMapping: "+e)}return"vec3 "+t+"( vec3 color ) { return "+e+"ToneMapping( color ); }"}("toneMapping",r.toneMapping):"",r.dithering?"#define DITHERING":"",r.outputEncoding||r.mapEncoding||r.matcapEncoding||r.envMapEncoding||r.emissiveMapEncoding?$s.encodings_pars_fragment:"",r.mapEncoding?jt("mapTexelToLinear",r.mapEncoding):"",r.matcapEncoding?jt("matcapTexelToLinear",r.matcapEncoding):"",r.envMapEncoding?jt("envMapTexelToLinear",r.envMapEncoding):"",r.emissiveMapEncoding?jt("emissiveMapTexelToLinear",r.emissiveMapEncoding):"",r.outputEncoding?function(t,e){return"vec4 "+t+"( vec4 value ) { return LinearTo"+(e=Vt(e))[0]+e[1]+"; }"}("linearToOutputTexel",r.outputEncoding):"",r.depthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(Gt).join("\n")),c=zt(c=Ut(c=Wt(c),r),r),u=zt(u=Ut(u=Wt(u),r),r),c=qt(c),u=qt(u),a.isWebGL2&&!n.isRawShaderMaterial&&(a=!1,d=/^\s*#version\s+300\s+es\s*\n/,n.isShaderMaterial&&null!==c.match(d)&&null!==u.match(d)&&(a=!0,c=c.replace(d,""),u=u.replace(d,"")),h="#version 300 es\n\n#define attribute in\n#define varying out\n#define texture2D texture\n"+h,e=["#version 300 es\n\n#define varying in",a?"":"out highp vec4 pc_fragColor;",a?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+e),u=e+u,c=Ft(l,35633,h+c,t.debug.checkShaderErrors),u=Ft(l,35632,u,t.debug.checkShaderErrors),l.attachShader(x,c),l.attachShader(x,u),void 0!==n.index0AttributeName?l.bindAttribLocation(x,0,n.index0AttributeName):!0===r.morphTargets&&l.bindAttribLocation(x,0,"position"),l.linkProgram(x),t.debug.checkShaderErrors&&(t=l.getProgramInfoLog(x).trim(),r=l.getShaderInfoLog(c).trim(),a=l.getShaderInfoLog(u).trim(),p=d=!0,!1===l.getProgramParameter(x,35714)?(d=!1,console.error("THREE.WebGLProgram: shader error: ",l.getError(),"35715",l.getProgramParameter(x,35715),"gl.getProgramInfoLog",t,r,a)):""!==t?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",t):""!==r&&""!==a||(p=!1),p&&(this.diagnostics={runnable:d,material:n,programLog:t,vertexShader:{log:r,prefix:h},fragmentShader:{log:a,prefix:e}})),l.deleteShader(c),l.deleteShader(u),this.getUniforms=function(){return void 0===g&&(g=new Nt(l,x,o)),g},this.getAttributes=function(){if(void 0===y){for(var t={},e=l.getProgramParameter(x,35721),i=0;i<e;i++){var n=l.getActiveAttrib(x,i).name;t[n]=l.getAttribLocation(x,n)}y=t}return y},this.destroy=function(){l.deleteProgram(x),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.name=s.name,this.id=vr++,this.code=i,this.usedTimes=1,this.program=x,this.vertexShader=c,this.fragmentShader=u,this}function Xt(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program!==e.program?t.program.id-e.program.id:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function Jt(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function Kt(){function t(t,n,s,a,o,l){var h=e[i];return void 0===h?(h={id:t.id,object:t,geometry:n,material:s,program:s.program||r,groupOrder:a,renderOrder:t.renderOrder,z:o,group:l},e[i]=h):(h.id=t.id,h.object=t,h.geometry=n,h.material=s,h.program=s.program||r,h.groupOrder=a,h.renderOrder=t.renderOrder,h.z=o,h.group=l),i++,h}var e=[],i=0,n=[],s=[],r={id:-1};return{opaque:n,transparent:s,init:function(){i=0,n.length=0,s.length=0},push:function(e,i,r,a,o,l){e=t(e,i,r,a,o,l),(!0===r.transparent?s:n).push(e)},unshift:function(e,i,r,a,o,l){e=t(e,i,r,a,o,l),(!0===r.transparent?s:n).unshift(e)},sort:function(){1<n.length&&n.sort(Xt),1<s.length&&s.sort(Jt)}}}function Zt(){for(var t=new function(){var t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];switch(e.type){case"DirectionalLight":var n={direction:new s,color:new b,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new i};break;case"SpotLight":n={position:new s,direction:new s,color:new b,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new i};break;case"PointLight":n={position:new s,color:new b,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new i,shadowCameraNear:1,shadowCameraFar:1e3};break;case"HemisphereLight":n={direction:new s,skyColor:new b,groundColor:new b};break;case"RectAreaLight":n={color:new b,position:new s,halfWidth:new s,halfHeight:new s}}return t[e.id]=n}}},e={id:br++,hash:{stateID:-1,directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,shadowsLength:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]},n=0;9>n;n++)e.probe.push(new s);var r=new s,a=new g,o=new g;return{setup:function(i,n,s){for(var l=0,h=0,c=0,u=0;9>u;u++)e.probe[u].set(0,0,0);var d=0,p=0,m=0,f=0,g=0;s=s.matrixWorldInverse,u=0;for(var y=i.length;u<y;u++){var v=i[u],b=v.color,w=v.intensity,x=v.distance,S=v.shadow&&v.shadow.map?v.shadow.map.texture:null;if(v.isAmbientLight)l+=b.r*w,h+=b.g*w,c+=b.b*w;else if(v.isLightProbe)for(S=0;9>S;S++)e.probe[S].addScaledVector(v.sh.coefficients[S],w);else if(v.isDirectionalLight){var E=t.get(v);E.color.copy(v.color).multiplyScalar(v.intensity),E.direction.setFromMatrixPosition(v.matrixWorld),r.setFromMatrixPosition(v.target.matrixWorld),E.direction.sub(r),E.direction.transformDirection(s),(E.shadow=v.castShadow)&&(w=v.shadow,E.shadowBias=w.bias,E.shadowRadius=w.radius,E.shadowMapSize=w.mapSize),e.directionalShadowMap[d]=S,e.directionalShadowMatrix[d]=v.shadow.matrix,e.directional[d]=E,d++}else v.isSpotLight?((E=t.get(v)).position.setFromMatrixPosition(v.matrixWorld),E.position.applyMatrix4(s),E.color.copy(b).multiplyScalar(w),E.distance=x,E.direction.setFromMatrixPosition(v.matrixWorld),r.setFromMatrixPosition(v.target.matrixWorld),E.direction.sub(r),E.direction.transformDirection(s),E.coneCos=Math.cos(v.angle),E.penumbraCos=Math.cos(v.angle*(1-v.penumbra)),E.decay=v.decay,(E.shadow=v.castShadow)&&(w=v.shadow,E.shadowBias=w.bias,E.shadowRadius=w.radius,E.shadowMapSize=w.mapSize),e.spotShadowMap[m]=S,e.spotShadowMatrix[m]=v.shadow.matrix,e.spot[m]=E,m++):v.isRectAreaLight?((E=t.get(v)).color.copy(b).multiplyScalar(w),E.position.setFromMatrixPosition(v.matrixWorld),E.position.applyMatrix4(s),o.identity(),a.copy(v.matrixWorld),a.premultiply(s),o.extractRotation(a),E.halfWidth.set(.5*v.width,0,0),E.halfHeight.set(0,.5*v.height,0),E.halfWidth.applyMatrix4(o),E.halfHeight.applyMatrix4(o),e.rectArea[f]=E,f++):v.isPointLight?((E=t.get(v)).position.setFromMatrixPosition(v.matrixWorld),E.position.applyMatrix4(s),E.color.copy(v.color).multiplyScalar(v.intensity),E.distance=v.distance,E.decay=v.decay,(E.shadow=v.castShadow)&&(w=v.shadow,E.shadowBias=w.bias,E.shadowRadius=w.radius,E.shadowMapSize=w.mapSize,E.shadowCameraNear=w.camera.near,E.shadowCameraFar=w.camera.far),e.pointShadowMap[p]=S,e.pointShadowMatrix[p]=v.shadow.matrix,e.point[p]=E,p++):v.isHemisphereLight&&((E=t.get(v)).direction.setFromMatrixPosition(v.matrixWorld),E.direction.transformDirection(s),E.direction.normalize(),E.skyColor.copy(v.color).multiplyScalar(w),E.groundColor.copy(v.groundColor).multiplyScalar(w),e.hemi[g]=E,g++)}e.ambient[0]=l,e.ambient[1]=h,e.ambient[2]=c,e.directional.length=d,e.spot.length=m,e.rectArea.length=f,e.point.length=p,e.hemi.length=g,e.hash.stateID=e.id,e.hash.directionalLength=d,e.hash.pointLength=p,e.hash.spotLength=m,e.hash.rectAreaLength=f,e.hash.hemiLength=g,e.hash.shadowsLength=n.length},state:e}}function Qt(){var t=new Zt,e=[],i=[];return{init:function(){e.length=0,i.length=0},state:{lightsArray:e,shadowsArray:i,lights:t},setupLights:function(n){t.setup(e,i,n)},pushLight:function(t){e.push(t)},pushShadow:function(t){i.push(t)}}}function $t(t){z.call(this),this.type="MeshDepthMaterial",this.depthPacking=3200,this.morphTargets=this.skinning=!1,this.displacementMap=this.alphaMap=this.map=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.lights=this.fog=!1,this.setValues(t)}function te(t){z.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new s,this.nearDistance=1,this.farDistance=1e3,this.morphTargets=this.skinning=!1,this.displacementMap=this.alphaMap=this.map=null,this.displacementScale=1,this.displacementBias=0,this.lights=this.fog=!1,this.setValues(t)}function ee(t,e,n){function r(e,i,n,s,r,a){var o=e.geometry,l=y,h=e.customDepthMaterial;return n&&(l=v,h=e.customDistanceMaterial),h?l=h:(h=!1,i.morphTargets&&(o&&o.isBufferGeometry?h=o.morphAttributes&&o.morphAttributes.position&&0<o.morphAttributes.position.length:o&&o.isGeometry&&(h=o.morphTargets&&0<o.morphTargets.length)),e.isSkinnedMesh&&!1===i.skinning&&console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",e),e=e.isSkinnedMesh&&i.skinning,o=0,h&&(o|=1),e&&(o|=2),l=l[o]),t.localClippingEnabled&&!0===i.clipShadows&&0!==i.clippingPlanes.length&&(o=l.uuid,h=i.uuid,void 0===(e=b[o])&&(e={},b[o]=e),void 0===(o=e[h])&&(o=l.clone(),e[h]=o),l=o),l.visible=i.visible,l.wireframe=i.wireframe,l.side=null!=i.shadowSide?i.shadowSide:w[i.side],l.clipShadows=i.clipShadows,l.clippingPlanes=i.clippingPlanes,l.clipIntersection=i.clipIntersection,l.wireframeLinewidth=i.wireframeLinewidth,l.linewidth=i.linewidth,n&&l.isMeshDistanceMaterial&&(l.referencePosition.copy(s),l.nearDistance=r,l.farDistance=a),l}function a(i,n,s,o){if(!1!==i.visible){if(i.layers.test(n.layers)&&(i.isMesh||i.isLine||i.isPoints)&&i.castShadow&&(!i.frustumCulled||h.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,i.matrixWorld);var l=e.update(i),c=i.material;if(Array.isArray(c))for(var u=l.groups,d=0,p=u.length;d<p;d++){var f=u[d],g=c[f.materialIndex];g&&g.visible&&(g=r(i,g,o,m,s.near,s.far),t.renderBufferDirect(s,null,l,g,i,f))}else c.visible&&(g=r(i,c,o,m,s.near,s.far),t.renderBufferDirect(s,null,l,g,i,null))}for(l=0,c=(i=i.children).length;l<c;l++)a(i[l],n,s,o)}}var h=new f,c=new g,u=new i,d=new i(n,n),p=new s,m=new s,y=Array(4),v=Array(4),b={},w={0:1,1:0,2:2},x=[new s(1,0,0),new s(-1,0,0),new s(0,0,1),new s(0,0,-1),new s(0,1,0),new s(0,-1,0)],S=[new s(0,1,0),new s(0,1,0),new s(0,1,0),new s(0,1,0),new s(0,0,1),new s(0,0,-1)],E=[new o,new o,new o,new o,new o,new o];for(n=0;4!==n;++n){var M=0!=(1&n),T=0!=(2&n),C=new $t({depthPacking:3201,morphTargets:M,skinning:T});y[n]=C,M=new te({morphTargets:M,skinning:T}),v[n]=M}var P=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1,this.render=function(e,i,n){if(!1!==P.enabled&&(!1!==P.autoUpdate||!1!==P.needsUpdate)&&0!==e.length){var s=t.getRenderTarget(),r=t.getActiveCubeFace(),o=t.getActiveMipMapLevel(),f=t.state;f.setBlending(0),f.buffers.color.setClear(1,1,1,1),f.buffers.depth.setTest(!0),f.setScissorTest(!1);for(var g,y=0,v=e.length;y<v;y++){var b=e[y];g=b.shadow;var w=b&&b.isPointLight;if(void 0===g)console.warn("THREE.WebGLShadowMap:",b,"has no shadow.");else{var M=g.camera;if(u.copy(g.mapSize),u.min(d),w){var T=u.x,C=u.y;E[0].set(2*T,C,T,C),E[1].set(0,C,T,C),E[2].set(3*T,C,T,C),E[3].set(T,C,T,C),E[4].set(3*T,0,T,C),E[5].set(T,0,T,C),u.x*=4,u.y*=2}for(null===g.map&&(g.map=new l(u.x,u.y,{minFilter:1003,magFilter:1003,format:1023}),g.map.texture.name=b.name+".shadowMap",M.updateProjectionMatrix()),g.isSpotLightShadow&&g.update(b),T=g.map,C=g.matrix,m.setFromMatrixPosition(b.matrixWorld),M.position.copy(m),w?(g=6,C.makeTranslation(-m.x,-m.y,-m.z)):(g=1,p.setFromMatrixPosition(b.target.matrixWorld),M.lookAt(p),M.updateMatrixWorld(),C.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),C.multiply(M.projectionMatrix),C.multiply(M.matrixWorldInverse)),t.setRenderTarget(T),t.clear(),b=0;b<g;b++)w&&(p.copy(M.position),p.add(x[b]),M.up.copy(S[b]),M.lookAt(p),M.updateMatrixWorld(),f.viewport(E[b])),c.multiplyMatrices(M.projectionMatrix,M.matrixWorldInverse),h.setFromMatrix(c),a(i,n,M,w)}}P.needsUpdate=!1,t.setRenderTarget(s,r,o)}}}function ie(t,e,i){return{convert:function(t){if(1e3===t)return 10497;if(1001===t)return 33071;if(1002===t)return 33648;if(1003===t)return 9728;if(1004===t)return 9984;if(1005===t)return 9986;if(1006===t)return 9729;if(1007===t)return 9985;if(1008===t)return 9987;if(1009===t)return 5121;if(1017===t)return 32819;if(1018===t)return 32820;if(1019===t)return 33635;if(1010===t)return 5120;if(1011===t)return 5122;if(1012===t)return 5123;if(1013===t)return 5124;if(1014===t)return 5125;if(1015===t)return 5126;if(1016===t){if(i.isWebGL2)return 5131;var n=e.get("OES_texture_half_float");if(null!==n)return n.HALF_FLOAT_OES}if(1021===t)return 6406;if(1022===t)return 6407;if(1023===t)return 6408;if(1024===t)return 6409;if(1025===t)return 6410;if(1026===t)return 6402;if(1027===t)return 34041;if(1028===t)return 6403;if(100===t)return 32774;if(101===t)return 32778;if(102===t)return 32779;if(200===t)return 0;if(201===t)return 1;if(202===t)return 768;if(203===t)return 769;if(204===t)return 770;if(205===t)return 771;if(206===t)return 772;if(207===t)return 773;if(208===t)return 774;if(209===t)return 775;if(210===t)return 776;if((33776===t||33777===t||33778===t||33779===t)&&null!==(n=e.get("WEBGL_compressed_texture_s3tc"))){if(33776===t)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(33777===t)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(33778===t)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(33779===t)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((35840===t||35841===t||35842===t||35843===t)&&null!==(n=e.get("WEBGL_compressed_texture_pvrtc"))){if(35840===t)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===t)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===t)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===t)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===t&&null!==(n=e.get("WEBGL_compressed_texture_etc1")))return n.COMPRESSED_RGB_ETC1_WEBGL;if((37808===t||37809===t||37810===t||37811===t||37812===t||37813===t||37814===t||37815===t||37816===t||37817===t||37818===t||37819===t||37820===t||37821===t)&&null!==(n=e.get("WEBGL_compressed_texture_astc")))return t;if(103===t||104===t){if(i.isWebGL2){if(103===t)return 32775;if(104===t)return 32776}if(null!==(n=e.get("EXT_blend_minmax"))){if(103===t)return n.MIN_EXT;if(104===t)return n.MAX_EXT}}if(1020===t){if(i.isWebGL2)return 34042;if(null!==(n=e.get("WEBGL_depth_texture")))return n.UNSIGNED_INT_24_8_WEBGL}return 0}}}function ne(){T.call(this),this.type="Group"}function se(){T.call(this),this.type="Camera",this.matrixWorldInverse=new g,this.projectionMatrix=new g,this.projectionMatrixInverse=new g}function re(t,e,i,n){se.call(this),this.type="PerspectiveCamera",this.fov=void 0!==t?t:50,this.zoom=1,this.near=void 0!==i?i:.1,this.far=void 0!==n?n:2e3,this.focus=10,this.aspect=void 0!==e?e:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function ae(t){re.call(this),this.cameras=t||[]}function oe(t,e,i){xr.setFromMatrixPosition(e.matrixWorld),Sr.setFromMatrixPosition(i.matrixWorld);var n=xr.distanceTo(Sr),s=e.projectionMatrix.elements,r=i.projectionMatrix.elements,a=s[14]/(s[10]-1);i=s[14]/(s[10]+1);var o=(s[9]+1)/s[5],l=(s[9]-1)/s[5],h=(s[8]-1)/s[0],c=(r[8]+1)/r[0];s=a*h,r=a*c,h=(c=n/(-h+c))*-h,e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(h),t.translateZ(c),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.getInverse(t.matrixWorld),e=a+c,a=i+c,t.projectionMatrix.makePerspective(s-h,r+(n-h),o*i/a*e,l*i/a*e,e,a)}function le(t){function e(){return null!==u&&!0===u.isPresenting}function r(){if(e()){var i=u.getEyeParameters("left");l=2*i.renderWidth*v,h=i.renderHeight*v,P=t.getPixelRatio(),t.getSize(_),t.setDrawingBufferSize(l,h,1),M.viewport.set(0,0,l/2,h),T.viewport.set(l/2,0,l/2,h),L.start()}else c.enabled&&t.setDrawingBufferSize(_.width,_.height,P),L.stop()}function a(t,e){null!==e&&4===e.length&&t.set(e[0]*l,e[1]*h,e[2]*l,e[3]*h)}var l,h,c=this,u=null,d=null,p=null,m=[],f=new g,y=new g,v=1,b="local-floor";"undefined"!=typeof window&&"VRFrameData"in window&&(d=new window.VRFrameData,window.addEventListener("vrdisplaypresentchange",r,!1));var x=new g,S=new n,E=new s,M=new re;M.viewport=new o,M.layers.enable(1);var T=new re;T.viewport=new o,T.layers.enable(2);var C=new ae([M,T]);C.layers.enable(1),C.layers.enable(2);var P,_=new i,A=[];this.enabled=!1,this.getController=function(t){var e=m[t];return void 0===e&&((e=new ne).matrixAutoUpdate=!1,e.visible=!1,m[t]=e),e},this.getDevice=function(){return u},this.setDevice=function(t){void 0!==t&&(u=t),L.setContext(t)},this.setFramebufferScaleFactor=function(t){v=t},this.setReferenceSpaceType=function(t){b=t},this.setPoseTarget=function(t){void 0!==t&&(p=t)},this.getCamera=function(t){var i="local-floor"===b?1.6:0;if(!1===e())return t.position.set(0,i,0),t.rotation.set(0,0,0),t;if(u.depthNear=t.near,u.depthFar=t.far,u.getFrameData(d),"local-floor"===b){var n=u.stageParameters;n?f.fromArray(n.sittingToStandingTransform):f.makeTranslation(0,i,0)}i=d.pose,(n=null!==p?p:t).matrix.copy(f),n.matrix.decompose(n.position,n.quaternion,n.scale),null!==i.orientation&&(S.fromArray(i.orientation),n.quaternion.multiply(S)),null!==i.position&&(S.setFromRotationMatrix(f),E.fromArray(i.position),E.applyQuaternion(S),n.position.add(E)),n.updateMatrixWorld(),M.near=t.near,T.near=t.near,M.far=t.far,T.far=t.far,M.matrixWorldInverse.fromArray(d.leftViewMatrix),T.matrixWorldInverse.fromArray(d.rightViewMatrix),y.getInverse(f),"local-floor"===b&&(M.matrixWorldInverse.multiply(y),T.matrixWorldInverse.multiply(y)),null!==(t=n.parent)&&(x.getInverse(t.matrixWorld),M.matrixWorldInverse.multiply(x),T.matrixWorldInverse.multiply(x)),M.matrixWorld.getInverse(M.matrixWorldInverse),T.matrixWorld.getInverse(T.matrixWorldInverse),M.projectionMatrix.fromArray(d.leftProjectionMatrix),T.projectionMatrix.fromArray(d.rightProjectionMatrix),oe(C,M,T),(t=u.getLayers()).length&&(t=t[0],a(M.viewport,t.leftBounds),a(T.viewport,t.rightBounds));t:for(t=0;t<m.length;t++){i=m[t];e:{n=t;for(var s=navigator.getGamepads&&navigator.getGamepads(),r=0,o=0,l=s.length;r<l;r++){var h=s[r];if(h&&("Daydream Controller"===h.id||"Gear VR Controller"===h.id||"Oculus Go Controller"===h.id||"OpenVR Gamepad"===h.id||h.id.startsWith("Oculus Touch")||h.id.startsWith("Spatial Controller"))){if(o===n){n=h;break e}o++}}n=void 0}if(void 0!==n&&void 0!==n.pose){if(null===n.pose)break t;!1===(s=n.pose).hasPosition&&i.position.set(.2,-.6,-.05),null!==s.position&&i.position.fromArray(s.position),null!==s.orientation&&i.quaternion.fromArray(s.orientation),i.matrix.compose(i.position,i.quaternion,i.scale),i.matrix.premultiply(f),i.matrix.decompose(i.position,i.quaternion,i.scale),i.matrixWorldNeedsUpdate=!0,i.visible=!0,s="Daydream Controller"===n.id?0:1,void 0===A[t]&&(A[t]=!1),A[t]!==n.buttons[s].pressed&&(A[t]=n.buttons[s].pressed,!0===A[t]?i.dispatchEvent({type:"selectstart"}):(i.dispatchEvent({type:"selectend"}),i.dispatchEvent({type:"select"})))}else i.visible=!1}return C},this.getStandingMatrix=function(){return f},this.isPresenting=e;var L=new w;this.setAnimationLoop=function(t){L.setAnimationLoop(t),e()&&L.start()},this.submitFrame=function(){e()&&u.submitFrame()},this.dispose=function(){"undefined"!=typeof window&&window.removeEventListener("vrdisplaypresentchange",r)},this.setFrameOfReferenceType=function(){console.warn("THREE.WebVRManager: setFrameOfReferenceType() has been deprecated.")}}function he(t){function e(){return null!==l&&null!==h}function i(t){for(var e=0;e<d.length;e++)p[e]===t.inputSource&&d[e].dispatchEvent({type:t.type})}function n(){t.setFramebuffer(null),t.setRenderTarget(t.getRenderTarget()),b.stop()}function s(t){h=t,b.setContext(l),b.start()}function r(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.getInverse(t.matrixWorld)}var a=t.context,l=null,h=null,c="local-floor",u=null,d=[],p=[],m=new re;m.layers.enable(1),m.viewport=new o;var f=new re;f.layers.enable(2),f.viewport=new o;var y=new ae([m,f]);y.layers.enable(1),y.layers.enable(2),this.enabled=!1,this.getController=function(t){var e=d[t];return void 0===e&&((e=new ne).matrixAutoUpdate=!1,e.visible=!1,d[t]=e),e},this.setFramebufferScaleFactor=function(t){},this.setReferenceSpaceType=function(t){c=t},this.getSession=function(){return l},this.setSession=function(t){null!==(l=t)&&(l.addEventListener("select",i),l.addEventListener("selectstart",i),l.addEventListener("selectend",i),l.addEventListener("end",n),l.updateRenderState({baseLayer:new XRWebGLLayer(l,a)}),l.requestReferenceSpace(c).then(s),p=l.inputSources,l.addEventListener("inputsourceschange",function(){p=l.inputSources,console.log(p);for(var t=0;t<d.length;t++)d[t].userData.inputSource=p[t]}))},this.getCamera=function(t){if(e()){var i=t.parent,n=y.cameras;r(y,i);for(var s=0;s<n.length;s++)r(n[s],i);for(t.matrixWorld.copy(y.matrixWorld),s=0,i=(t=t.children).length;s<i;s++)t[s].updateMatrixWorld(!0);return oe(y,m,f),y}return t},this.isPresenting=e;var v=null,b=new w;b.setAnimationLoop(function(e,i){if(null!==(u=i.getViewerPose(h))){var n=u.views,s=l.renderState.baseLayer;t.setFramebuffer(s.framebuffer);for(var r=0;r<n.length;r++){var a=n[r],o=s.getViewport(a),c=y.cameras[r];c.matrix.fromArray(a.transform.inverse.matrix).getInverse(c.matrix),c.projectionMatrix.fromArray(a.projectionMatrix),c.viewport.set(o.x,o.y,o.width,o.height),0===r&&y.matrix.copy(c.matrix)}}for(r=0;r<d.length;r++)n=d[r],(s=p[r])&&null!==(s=i.getPose(s.targetRaySpace,h))?(n.matrix.fromArray(s.transform.matrix),n.matrix.decompose(n.position,n.rotation,n.scale),n.visible=!0):n.visible=!1;v&&v(e)}),this.setAnimationLoop=function(t){v=t},this.dispose=function(){},this.getStandingMatrix=function(){return console.warn("THREE.WebXRManager: getStandingMatrix() is no longer needed."),new g},this.getDevice=function(){console.warn("THREE.WebXRManager: getDevice() has been deprecated.")},this.setDevice=function(){console.warn("THREE.WebXRManager: setDevice() has been deprecated.")},this.setFrameOfReferenceType=function(){console.warn("THREE.WebXRManager: setFrameOfReferenceType() has been deprecated.")},this.submitFrame=function(){}}function ce(t){var e;function n(){k=new function(t){var e={};return{get:function(i){if(void 0!==e[i])return e[i];switch(i){case"WEBGL_depth_texture":var n=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=t.getExtension(i)}return null===n&&console.warn("THREE.WebGLRenderer: "+i+" extension not supported."),e[i]=n}}}(At),(B=new function(t,e,i){function n(e){if("highp"===e){if(0<t.getShaderPrecisionFormat(35633,36338).precision&&0<t.getShaderPrecisionFormat(35632,36338).precision)return"highp";e="mediump"}return"mediump"===e&&0<t.getShaderPrecisionFormat(35633,36337).precision&&0<t.getShaderPrecisionFormat(35632,36337).precision?"mediump":"lowp"}var s,r="undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext,a=void 0!==i.precision?i.precision:"highp",o=n(a);o!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",o,"instead."),a=o),i=!0===i.logarithmicDepthBuffer,o=t.getParameter(34930);var l=t.getParameter(35660),h=t.getParameter(3379),c=t.getParameter(34076),u=t.getParameter(34921),d=t.getParameter(36347),p=t.getParameter(36348),m=t.getParameter(36349),f=0<l,g=r||!!e.get("OES_texture_float");return{isWebGL2:r,getMaxAnisotropy:function(){if(void 0!==s)return s;var i=e.get("EXT_texture_filter_anisotropic");return s=null!==i?t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},getMaxPrecision:n,precision:a,logarithmicDepthBuffer:i,maxTextures:o,maxVertexTextures:l,maxTextureSize:h,maxCubemapSize:c,maxAttributes:u,maxVertexUniforms:d,maxVaryings:p,maxFragmentUniforms:m,vertexTextures:f,floatFragmentTextures:g,floatVertexTextures:f&&g,maxSamples:r?t.getParameter(36183):0}}(At,k,t)).isWebGL2||(k.get("WEBGL_depth_texture"),k.get("OES_texture_float"),k.get("OES_texture_half_float"),k.get("OES_texture_half_float_linear"),k.get("OES_standard_derivatives"),k.get("OES_element_index_uint"),k.get("ANGLE_instanced_arrays")),k.get("OES_texture_float_linear"),et=new ie(At,k,B),(H=new function(t,e,i,n){function s(e,i,n){var s=new Uint8Array(4),r=t.createTexture();for(t.bindTexture(e,r),t.texParameteri(e,10241,9728),t.texParameteri(e,10240,9728),e=0;e<n;e++)t.texImage2D(i+e,0,6408,1,1,0,6408,5121,s);return r}function r(i,s){v[i]=1,0===b[i]&&(t.enableVertexAttribArray(i),b[i]=1),w[i]!==s&&((n.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,s),w[i]=s)}function a(e){!0!==x[e]&&(t.enable(e),x[e]=!0)}function l(e){!1!==x[e]&&(t.disable(e),x[e]=!1)}function h(e,n,s,r,o,h,c,u){if(0===e)M&&(l(3042),M=!1);else if(M||(a(3042),M=!0),5!==e){if(e!==T||u!==I){if(100===C&&100===A||(t.blendEquation(32774),A=C=100),u)switch(e){case 1:t.blendFuncSeparate(1,771,1,771);break;case 2:t.blendFunc(1,1);break;case 3:t.blendFuncSeparate(0,0,769,771);break;case 4:t.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case 1:t.blendFuncSeparate(770,771,1,771);break;case 2:t.blendFunc(770,1);break;case 3:t.blendFunc(0,769);break;case 4:t.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}R=L=_=P=null,T=e,I=u}}else o=o||n,h=h||s,c=c||r,n===C&&o===A||(t.blendEquationSeparate(i.convert(n),i.convert(o)),C=n,A=o),s===P&&r===_&&h===L&&c===R||(t.blendFuncSeparate(i.convert(s),i.convert(r),i.convert(h),i.convert(c)),P=s,_=r,L=h,R=c),T=e,I=null}function c(e){O!==e&&(e?t.frontFace(2304):t.frontFace(2305),O=e)}function u(e){0!==e?(a(2884),e!==D&&(1===e?t.cullFace(1029):2===e?t.cullFace(1028):t.cullFace(1032))):l(2884),D=e}function d(e,i,n){e?(a(32823),(B!==i||H!==n)&&(t.polygonOffset(i,n),B=i,H=n)):l(32823)}function p(e){void 0===e&&(e=33984+N-1),V!==e&&(t.activeTexture(e),V=e)}var m=new function(){var e=!1,i=new o,n=null,s=new o(0,0,0,0);return{setMask:function(i){n===i||e||(t.colorMask(i,i,i,i),n=i)},setLocked:function(t){e=t},setClear:function(e,n,r,a,o){!0===o&&(e*=a,n*=a,r*=a),i.set(e,n,r,a),!1===s.equals(i)&&(t.clearColor(e,n,r,a),s.copy(i))},reset:function(){e=!1,n=null,s.set(-1,0,0,0)}}},f=new function(){var e=!1,i=null,n=null,s=null;return{setTest:function(t){t?a(2929):l(2929)},setMask:function(n){i===n||e||(t.depthMask(n),i=n)},setFunc:function(e){if(n!==e){if(e)switch(e){case 0:t.depthFunc(512);break;case 1:t.depthFunc(519);break;case 2:t.depthFunc(513);break;case 3:t.depthFunc(515);break;case 4:t.depthFunc(514);break;case 5:t.depthFunc(518);break;case 6:t.depthFunc(516);break;case 7:t.depthFunc(517);break;default:t.depthFunc(515)}else t.depthFunc(515);n=e}},setLocked:function(t){e=t},setClear:function(e){s!==e&&(t.clearDepth(e),s=e)},reset:function(){e=!1,s=n=i=null}}},g=new function(){var e=!1,i=null,n=null,s=null,r=null,o=null,h=null,c=null,u=null;return{setTest:function(t){t?a(2960):l(2960)},setMask:function(n){i===n||e||(t.stencilMask(n),i=n)},setFunc:function(e,i,a){n===e&&s===i&&r===a||(t.stencilFunc(e,i,a),n=e,s=i,r=a)},setOp:function(e,i,n){o===e&&h===i&&c===n||(t.stencilOp(e,i,n),o=e,h=i,c=n)},setLocked:function(t){e=t},setClear:function(e){u!==e&&(t.clearStencil(e),u=e)},reset:function(){e=!1,u=c=h=o=r=s=n=i=null}}},y=t.getParameter(34921),v=new Uint8Array(y),b=new Uint8Array(y),w=new Uint8Array(y),x={},S=null,E=null,M=null,T=null,C=null,P=null,_=null,A=null,L=null,R=null,I=!1,O=null,D=null,k=null,B=null,H=null,N=t.getParameter(35661),F=!1;y=0,-1!==(y=t.getParameter(7938)).indexOf("WebGL")?(y=parseFloat(/^WebGL ([0-9])/.exec(y)[1]),F=1<=y):-1!==y.indexOf("OpenGL ES")&&(y=parseFloat(/^OpenGL ES ([0-9])/.exec(y)[1]),F=2<=y);var V=null,j={},G=new o,U=new o,z={};return z[3553]=s(3553,3553,1),z[34067]=s(34067,34069,6),m.setClear(0,0,0,1),f.setClear(1),g.setClear(0),a(2929),f.setFunc(3),c(!1),u(1),a(2884),h(0),{buffers:{color:m,depth:f,stencil:g},initAttributes:function(){for(var t=0,e=v.length;t<e;t++)v[t]=0},enableAttribute:function(t){r(t,0)},enableAttributeAndDivisor:r,disableUnusedAttributes:function(){for(var e=0,i=b.length;e!==i;++e)b[e]!==v[e]&&(t.disableVertexAttribArray(e),b[e]=0)},enable:a,disable:l,getCompressedTextureFormats:function(){if(null===S&&(S=[],e.get("WEBGL_compressed_texture_pvrtc")||e.get("WEBGL_compressed_texture_s3tc")||e.get("WEBGL_compressed_texture_etc1")||e.get("WEBGL_compressed_texture_astc")))for(var i=t.getParameter(34467),n=0;n<i.length;n++)S.push(i[n]);return S},useProgram:function(e){return E!==e&&(t.useProgram(e),E=e,!0)},setBlending:h,setMaterial:function(t,e){2===t.side?l(2884):a(2884);var i=1===t.side;e&&(i=!i),c(i),1===t.blending&&!1===t.transparent?h(0):h(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha),f.setFunc(t.depthFunc),f.setTest(t.depthTest),f.setMask(t.depthWrite),m.setMask(t.colorWrite),d(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)},setFlipSided:c,setCullFace:u,setLineWidth:function(e){e!==k&&(F&&t.lineWidth(e),k=e)},setPolygonOffset:d,setScissorTest:function(t){t?a(3089):l(3089)},activeTexture:p,bindTexture:function(e,i){null===V&&p();var n=j[V];void 0===n&&(n={type:void 0,texture:void 0},j[V]=n),n.type===e&&n.texture===i||(t.bindTexture(e,i||z[e]),n.type=e,n.texture=i)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(e){!1===G.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),G.copy(e))},viewport:function(e){!1===U.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),U.copy(e))},reset:function(){for(var e=0;e<b.length;e++)1===b[e]&&(t.disableVertexAttribArray(e),b[e]=0);x={},V=S=null,j={},D=O=T=E=null,m.reset(),f.reset(),g.reset()}}}(At,k,et,B)).scissor(ft.copy(xt).multiplyScalar(bt)),H.viewport(mt.copy(wt).multiplyScalar(bt)),N=new function(t){var e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.frame++,e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(t,i,n){switch(n=n||1,e.calls++,i){case 4:e.triangles+=t/3*n;break;case 5:case 6:e.triangles+=n*(t-2);break;case 1:e.lines+=t/2*n;break;case 3:e.lines+=n*(t-1);break;case 2:e.lines+=n*t;break;case 0:e.points+=n*t;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}(At),F=new function(){var t=new WeakMap;return{get:function(e){var i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,n){t.get(e)[i]=n},dispose:function(){t=new WeakMap}}},V=new function(t,e,i,n,s,r,a){function o(t,e){return P?new OffscreenCanvas(t,e):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function l(t,e,i,n){var s=1;if((t.width>n||t.height>n)&&(s=n/Math.max(t.width,t.height)),1>s||!0===e){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap)return e=(n=e?Js.floorPowerOfTwo:Math.floor)(s*t.width),s=n(s*t.height),void 0===T&&(T=o(e,s)),(i=i?o(e,s):T).width=e,i.height=s,i.getContext("2d").drawImage(t,0,0,e,s),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+t.width+"x"+t.height+") to ("+e+"x"+s+")."),i;"data"in t&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+t.width+"x"+t.height+").")}return t}function h(t){return Js.isPowerOfTwo(t.width)&&Js.isPowerOfTwo(t.height)}function c(t,e){return t.generateMipmaps&&e&&1003!==t.minFilter&&1006!==t.minFilter}function u(e,i,s,r){t.generateMipmap(e),n.get(i).__maxMipLevel=Math.log(Math.max(s,r))*Math.LOG2E}function d(t,i){if(!s.isWebGL2)return t;var n=t;return 6403===t&&(5126===i&&(n=33326),5131===i&&(n=33325),5121===i&&(n=33321)),6407===t&&(5126===i&&(n=34837),5131===i&&(n=34843),5121===i&&(n=32849)),6408===t&&(5126===i&&(n=34836),5131===i&&(n=34842),5121===i&&(n=32856)),33325===n||33326===n||34842===n||34836===n?e.get("EXT_color_buffer_float"):(34843===n||34837===n)&&console.warn("THREE.WebGLRenderer: Floating point textures with RGB format not supported. Please use RGBA instead."),n}function p(t){return 1003===t||1004===t||1005===t?9728:9729}function m(e){(e=e.target).removeEventListener("dispose",m);var i=n.get(e);void 0!==i.__webglInit&&(t.deleteTexture(i.__webglTexture),n.remove(e)),e.isVideoTexture&&delete C[e.id],a.memory.textures--}function f(e){(e=e.target).removeEventListener("dispose",f);var i=n.get(e),s=n.get(e.texture);if(e){if(void 0!==s.__webglTexture&&t.deleteTexture(s.__webglTexture),e.depthTexture&&e.depthTexture.dispose(),e.isWebGLRenderTargetCube)for(s=0;6>s;s++)t.deleteFramebuffer(i.__webglFramebuffer[s]),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer[s]);else t.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer);n.remove(e.texture),n.remove(e)}a.memory.textures--}function g(t,e){var s=n.get(t);if(t.isVideoTexture){var r=t.id,o=a.render.frame;C[r]!==o&&(C[r]=o,t.update())}if(0<t.version&&s.__version!==t.version)if(void 0===(r=t.image))console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==r.complete)return void x(s,t,e);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}i.activeTexture(33984+e),i.bindTexture(3553,s.__webglTexture)}function y(e,a){var o=n.get(e);if(6===e.image.length)if(0<e.version&&o.__version!==e.version){w(o,e),i.activeTexture(33984+a),i.bindTexture(34067,o.__webglTexture),t.pixelStorei(37440,e.flipY),a=e&&e.isCompressedTexture;for(var p=e.image[0]&&e.image[0].isDataTexture,m=[],f=0;6>f;f++)m[f]=a||p?p?e.image[f].image:e.image[f]:l(e.image[f],!1,!0,s.maxCubemapSize);var g=m[0],y=h(g)||s.isWebGL2,v=r.convert(e.format),x=r.convert(e.type),S=d(v,x);for(b(34067,e,y),f=0;6>f;f++)if(a)for(var E,M=m[f].mipmaps,T=0,C=M.length;T<C;T++)E=M[T],1023!==e.format&&1022!==e.format?-1<i.getCompressedTextureFormats().indexOf(v)?i.compressedTexImage2D(34069+f,T,S,E.width,E.height,0,E.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(34069+f,T,S,E.width,E.height,0,v,x,E.data);else p?i.texImage2D(34069+f,0,S,m[f].width,m[f].height,0,v,x,m[f].data):i.texImage2D(34069+f,0,S,v,x,m[f]);o.__maxMipLevel=a?M.length-1:0,c(e,y)&&u(34067,e,g.width,g.height),o.__version=e.version,e.onUpdate&&e.onUpdate(e)}else i.activeTexture(33984+a),i.bindTexture(34067,o.__webglTexture)}function v(t,e){i.activeTexture(33984+e),i.bindTexture(34067,n.get(t).__webglTexture)}function b(i,a,o){o?(t.texParameteri(i,10242,r.convert(a.wrapS)),t.texParameteri(i,10243,r.convert(a.wrapT)),32879!==i&&35866!==i||t.texParameteri(i,32882,r.convert(a.wrapR)),t.texParameteri(i,10240,r.convert(a.magFilter)),t.texParameteri(i,10241,r.convert(a.minFilter))):(t.texParameteri(i,10242,33071),t.texParameteri(i,10243,33071),32879!==i&&35866!==i||t.texParameteri(i,32882,33071),1001===a.wrapS&&1001===a.wrapT||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),t.texParameteri(i,10240,p(a.magFilter)),t.texParameteri(i,10241,p(a.minFilter)),1003!==a.minFilter&&1006!==a.minFilter&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),!(o=e.get("EXT_texture_filter_anisotropic"))||1015===a.type&&null===e.get("OES_texture_float_linear")||1016===a.type&&null===(s.isWebGL2||e.get("OES_texture_half_float_linear"))||!(1<a.anisotropy||n.get(a).__currentAnisotropy)||(t.texParameterf(i,o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(a.anisotropy,s.getMaxAnisotropy())),n.get(a).__currentAnisotropy=a.anisotropy)}function w(e,i){void 0===e.__webglInit&&(e.__webglInit=!0,i.addEventListener("dispose",m),e.__webglTexture=t.createTexture(),a.memory.textures++)}function x(e,n,a){var o=3553;n.isDataTexture2DArray&&(o=35866),n.isDataTexture3D&&(o=32879),w(e,n),i.activeTexture(33984+a),i.bindTexture(o,e.__webglTexture),t.pixelStorei(37440,n.flipY),t.pixelStorei(37441,n.premultiplyAlpha),t.pixelStorei(3317,n.unpackAlignment),a=(a=!s.isWebGL2&&(1001!==n.wrapS||1001!==n.wrapT||1003!==n.minFilter&&1006!==n.minFilter))&&!1===h(n.image);var p=h(a=l(n.image,a,!1,s.maxTextureSize))||s.isWebGL2,m=r.convert(n.format),f=r.convert(n.type),g=d(m,f);b(o,n,p);var y=n.mipmaps;if(n.isDepthTexture){if(g=6402,1015===n.type){if(!s.isWebGL2)throw Error("Float Depth Texture only supported in WebGL2.0");g=36012}else s.isWebGL2&&(g=33189);1026===n.format&&6402===g&&1012!==n.type&&1014!==n.type&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=1012,f=r.convert(n.type)),1027===n.format&&(g=34041,1020!==n.type&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=1020,f=r.convert(n.type))),i.texImage2D(3553,0,g,a.width,a.height,0,m,f,null)}else if(n.isDataTexture)if(0<y.length&&p){for(var v=0,x=y.length;v<x;v++)o=y[v],i.texImage2D(3553,v,g,o.width,o.height,0,m,f,o.data);n.generateMipmaps=!1,e.__maxMipLevel=y.length-1}else i.texImage2D(3553,0,g,a.width,a.height,0,m,f,a.data),e.__maxMipLevel=0;else if(n.isCompressedTexture){for(v=0,x=y.length;v<x;v++)o=y[v],1023!==n.format&&1022!==n.format?-1<i.getCompressedTextureFormats().indexOf(m)?i.compressedTexImage2D(3553,v,g,o.width,o.height,0,o.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(3553,v,g,o.width,o.height,0,m,f,o.data);e.__maxMipLevel=y.length-1}else if(n.isDataTexture2DArray)i.texImage3D(35866,0,g,a.width,a.height,a.depth,0,m,f,a.data),e.__maxMipLevel=0;else if(n.isDataTexture3D)i.texImage3D(32879,0,g,a.width,a.height,a.depth,0,m,f,a.data),e.__maxMipLevel=0;else if(0<y.length&&p){for(v=0,x=y.length;v<x;v++)o=y[v],i.texImage2D(3553,v,g,m,f,o);n.generateMipmaps=!1,e.__maxMipLevel=y.length-1}else i.texImage2D(3553,0,g,m,f,a),e.__maxMipLevel=0;c(n,p)&&u(3553,n,a.width,a.height),e.__version=n.version,n.onUpdate&&n.onUpdate(n)}function S(e,s,a,o){var l=r.convert(s.texture.format),h=r.convert(s.texture.type),c=d(l,h);i.texImage2D(o,0,c,s.width,s.height,0,l,h,null),t.bindFramebuffer(36160,e),t.framebufferTexture2D(36160,a,o,n.get(s.texture).__webglTexture,0),t.bindFramebuffer(36160,null)}function E(e,i,n){t.bindRenderbuffer(36161,e),i.depthBuffer&&!i.stencilBuffer?(n?(n=M(i),t.renderbufferStorageMultisample(36161,n,33189,i.width,i.height)):t.renderbufferStorage(36161,33189,i.width,i.height),t.framebufferRenderbuffer(36160,36096,36161,e)):i.depthBuffer&&i.stencilBuffer?(n?(n=M(i),t.renderbufferStorageMultisample(36161,n,34041,i.width,i.height)):t.renderbufferStorage(36161,34041,i.width,i.height),t.framebufferRenderbuffer(36160,33306,36161,e)):(e=d(e=r.convert(i.texture.format),r.convert(i.texture.type)),n?(n=M(i),t.renderbufferStorageMultisample(36161,n,e,i.width,i.height)):t.renderbufferStorage(36161,e,i.width,i.height)),t.bindRenderbuffer(36161,null)}function M(t){return s.isWebGL2&&t.isWebGLMultisampleRenderTarget?Math.min(s.maxSamples,t.samples):0}var T,C={},P="undefined"!=typeof OffscreenCanvas,_=0,A=!1,L=!1;this.allocateTextureUnit=function(){var t=_;return t>=s.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+t+" texture units while this GPU supports only "+s.maxTextures),_+=1,t},this.resetTextureUnits=function(){_=0},this.setTexture2D=g,this.setTexture2DArray=function(t,e){var s=n.get(t);0<t.version&&s.__version!==t.version?x(s,t,e):(i.activeTexture(33984+e),i.bindTexture(35866,s.__webglTexture))},this.setTexture3D=function(t,e){var s=n.get(t);0<t.version&&s.__version!==t.version?x(s,t,e):(i.activeTexture(33984+e),i.bindTexture(32879,s.__webglTexture))},this.setTextureCube=y,this.setTextureCubeDynamic=v,this.setupRenderTarget=function(e){var o=n.get(e),l=n.get(e.texture);e.addEventListener("dispose",f),l.__webglTexture=t.createTexture(),a.memory.textures++;var p=!0===e.isWebGLRenderTargetCube,m=!0===e.isWebGLMultisampleRenderTarget,y=h(e)||s.isWebGL2;if(p)for(o.__webglFramebuffer=[],m=0;6>m;m++)o.__webglFramebuffer[m]=t.createFramebuffer();else if(o.__webglFramebuffer=t.createFramebuffer(),m)if(s.isWebGL2){o.__webglMultisampledFramebuffer=t.createFramebuffer(),o.__webglColorRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,o.__webglColorRenderbuffer),m=r.convert(e.texture.format);var v=r.convert(e.texture.type);m=d(m,v),v=M(e),t.renderbufferStorageMultisample(36161,v,m,e.width,e.height),t.bindFramebuffer(36160,o.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(36160,36064,36161,o.__webglColorRenderbuffer),t.bindRenderbuffer(36161,null),e.depthBuffer&&(o.__webglDepthRenderbuffer=t.createRenderbuffer(),E(o.__webglDepthRenderbuffer,e,!0)),t.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(p){for(i.bindTexture(34067,l.__webglTexture),b(34067,e.texture,y),m=0;6>m;m++)S(o.__webglFramebuffer[m],e,36064,34069+m);c(e.texture,y)&&u(34067,e.texture,e.width,e.height),i.bindTexture(34067,null)}else i.bindTexture(3553,l.__webglTexture),b(3553,e.texture,y),S(o.__webglFramebuffer,e,36064,3553),c(e.texture,y)&&u(3553,e.texture,e.width,e.height),i.bindTexture(3553,null);if(e.depthBuffer){if(o=n.get(e),l=!0===e.isWebGLRenderTargetCube,e.depthTexture){if(l)throw Error("target.depthTexture not supported in Cube render targets");if(e&&e.isWebGLRenderTargetCube)throw Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(36160,o.__webglFramebuffer),!e.depthTexture||!e.depthTexture.isDepthTexture)throw Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");if(n.get(e.depthTexture).__webglTexture&&e.depthTexture.image.width===e.width&&e.depthTexture.image.height===e.height||(e.depthTexture.image.width=e.width,e.depthTexture.image.height=e.height,e.depthTexture.needsUpdate=!0),g(e.depthTexture,0),o=n.get(e.depthTexture).__webglTexture,1026===e.depthTexture.format)t.framebufferTexture2D(36160,36096,3553,o,0);else{if(1027!==e.depthTexture.format)throw Error("Unknown depthTexture format");t.framebufferTexture2D(36160,33306,3553,o,0)}}else if(l)for(o.__webglDepthbuffer=[],l=0;6>l;l++)t.bindFramebuffer(36160,o.__webglFramebuffer[l]),o.__webglDepthbuffer[l]=t.createRenderbuffer(),E(o.__webglDepthbuffer[l],e);else t.bindFramebuffer(36160,o.__webglFramebuffer),o.__webglDepthbuffer=t.createRenderbuffer(),E(o.__webglDepthbuffer,e);t.bindFramebuffer(36160,null)}},this.updateRenderTargetMipmap=function(t){var e=t.texture,r=h(t)||s.isWebGL2;if(c(e,r)){r=t.isWebGLRenderTargetCube?34067:3553;var a=n.get(e).__webglTexture;i.bindTexture(r,a),u(r,e,t.width,t.height),i.bindTexture(r,null)}},this.updateMultisampleRenderTarget=function(e){if(e.isWebGLMultisampleRenderTarget)if(s.isWebGL2){var i=n.get(e);t.bindFramebuffer(36008,i.__webglMultisampledFramebuffer),t.bindFramebuffer(36009,i.__webglFramebuffer),i=e.width;var r=e.height,a=16384;e.depthBuffer&&(a|=256),e.stencilBuffer&&(a|=1024),t.blitFramebuffer(0,0,i,r,0,0,i,r,a,9728)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")},this.safeSetTexture2D=function(t,e){t&&t.isWebGLRenderTarget&&(!1===A&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),A=!0),t=t.texture),g(t,e)},this.safeSetTextureCube=function(t,e){t&&t.isWebGLRenderTargetCube&&(!1===L&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),L=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?y(t,e):v(t,e)}}(At,k,H,F,B,et,N),j=new x(At),G=new Q(At,j,N),U=new function(t,e){var i={};return{update:function(n){var s=e.render.frame,r=n.geometry,a=t.get(n,r);return i[a.id]!==s&&(r.isGeometry&&a.updateFromObject(n),t.update(a),i[a.id]=s),a},dispose:function(){i={}}}}(G,N),X=new function(t){var e={},i=new Float32Array(8);return{update:function(n,s,r,a){var o=n.morphTargetInfluences,l=o.length;if(void 0===(n=e[s.id])){n=[];for(var h=0;h<l;h++)n[h]=[h,0];e[s.id]=n}var c=r.morphTargets&&s.morphAttributes.position;for(r=r.morphNormals&&s.morphAttributes.normal,h=0;h<l;h++){var u=n[h];0!==u[1]&&(c&&s.removeAttribute("morphTarget"+h),r&&s.removeAttribute("morphNormal"+h))}for(h=0;h<l;h++)(u=n[h])[0]=h,u[1]=o[h];for(n.sort($),h=0;8>h;h++)(u=n[h])&&(o=u[0],l=u[1])?(c&&s.addAttribute("morphTarget"+h,c[o]),r&&s.addAttribute("morphNormal"+h,r[o]),i[h]=l):i[h]=0;a.getUniforms().setValue(t,"morphTargetInfluences",i)}}}(At),z=new function(t,e,i,n){function s(t,e){if(t)t.isTexture?i=t.encoding:t.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),i=t.texture.encoding);else var i=3e3;return 3e3===i&&e&&(i=3007),i}var r=[],a={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},o="precision supportsVertexTextures map mapEncoding matcap matcapEncoding envMap envMapMode envMapEncoding lightMap aoMap emissiveMap emissiveMapEncoding bumpMap normalMap objectSpaceNormalMap displacementMap specularMap roughnessMap metalnessMap gradientMap alphaMap combine vertexColors vertexTangents fog useFog fogExp flatShading sizeAttenuation logarithmicDepthBuffer skinning maxBones useVertexTexture morphTargets morphNormals maxMorphTargets maxMorphNormals premultipliedAlpha numDirLights numPointLights numSpotLights numHemiLights numRectAreaLights shadowMapEnabled shadowMapType toneMapping physicallyCorrectLights alphaTest doubleSided flipSided numClippingPlanes numClipIntersection depthPacking dithering".split(" ");this.getParameters=function(e,n,r,o,l,h,c){var u=a[e.type];if(c.isSkinnedMesh){var d=c.skeleton.bones;if(i.floatVertexTextures)d=1024;else{var p=Math.min(Math.floor((i.maxVertexUniforms-20)/4),d.length);p<d.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+d.length+" bones. This GPU supports "+p+"."),d=0):d=p}}else d=0;p=i.precision,null!==e.precision&&(p=i.getMaxPrecision(e.precision))!==e.precision&&console.warn("THREE.WebGLProgram.getParameters:",e.precision,"not supported, using",p,"instead.");var m=t.getRenderTarget();return{shaderID:u,precision:p,supportsVertexTextures:i.vertexTextures,outputEncoding:s(m?m.texture:null,t.gammaOutput),map:!!e.map,mapEncoding:s(e.map,t.gammaInput),matcap:!!e.matcap,matcapEncoding:s(e.matcap,t.gammaInput),envMap:!!e.envMap,envMapMode:e.envMap&&e.envMap.mapping,envMapEncoding:s(e.envMap,t.gammaInput),envMapCubeUV:!!e.envMap&&(306===e.envMap.mapping||307===e.envMap.mapping),lightMap:!!e.lightMap,aoMap:!!e.aoMap,emissiveMap:!!e.emissiveMap,emissiveMapEncoding:s(e.emissiveMap,t.gammaInput),bumpMap:!!e.bumpMap,normalMap:!!e.normalMap,objectSpaceNormalMap:1===e.normalMapType,displacementMap:!!e.displacementMap,roughnessMap:!!e.roughnessMap,metalnessMap:!!e.metalnessMap,specularMap:!!e.specularMap,alphaMap:!!e.alphaMap,gradientMap:!!e.gradientMap,combine:e.combine,vertexTangents:e.normalMap&&e.vertexTangents,vertexColors:e.vertexColors,fog:!!o,useFog:e.fog,fogExp:o&&o.isFogExp2,flatShading:e.flatShading,sizeAttenuation:e.sizeAttenuation,logarithmicDepthBuffer:i.logarithmicDepthBuffer,skinning:e.skinning&&0<d,maxBones:d,useVertexTexture:i.floatVertexTextures,morphTargets:e.morphTargets,morphNormals:e.morphNormals,maxMorphTargets:t.maxMorphTargets,maxMorphNormals:t.maxMorphNormals,numDirLights:n.directional.length,numPointLights:n.point.length,numSpotLights:n.spot.length,numRectAreaLights:n.rectArea.length,numHemiLights:n.hemi.length,numClippingPlanes:l,numClipIntersection:h,dithering:e.dithering,shadowMapEnabled:t.shadowMap.enabled&&c.receiveShadow&&0<r.length,shadowMapType:t.shadowMap.type,toneMapping:t.toneMapping,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:e.premultipliedAlpha,alphaTest:e.alphaTest,doubleSided:2===e.side,flipSided:1===e.side,depthPacking:void 0!==e.depthPacking&&e.depthPacking}},this.getProgramCode=function(e,i){var n=[];if(i.shaderID?n.push(i.shaderID):(n.push(e.fragmentShader),n.push(e.vertexShader)),void 0!==e.defines)for(var s in e.defines)n.push(s),n.push(e.defines[s]);for(s=0;s<o.length;s++)n.push(i[o[s]]);return n.push(e.onBeforeCompile.toString()),n.push(t.gammaOutput),n.push(t.gammaFactor),n.join()},this.acquireProgram=function(s,a,o,l){for(var h,c=0,u=r.length;c<u;c++){var d=r[c];if(d.code===l){++(h=d).usedTimes;break}}return void 0===h&&(h=new Yt(t,e,l,s,a,o,i,n),r.push(h)),h},this.releaseProgram=function(t){if(0==--t.usedTimes){var e=r.indexOf(t);r[e]=r[r.length-1],r.pop(),t.destroy()}},this.programs=r}(it,k,B,V),W=new function(){function t(i){(i=i.target).removeEventListener("dispose",t),delete e[i.id]}var e={};return{get:function(i,n){var s=e[i.id];if(void 0===s){var r=new Kt;e[i.id]={},e[i.id][n.id]=r,i.addEventListener("dispose",t)}else void 0===(r=s[n.id])&&(r=new Kt,s[n.id]=r);return r},dispose:function(){e={}}}},q=new function(){function t(i){(i=i.target).removeEventListener("dispose",t),delete e[i.id]}var e={};return{get:function(i,n){if(void 0===e[i.id]){var s=new Qt;e[i.id]={},e[i.id][n.id]=s,i.addEventListener("dispose",t)}else void 0===e[i.id][n.id]?(s=new Qt,e[i.id][n.id]=s):s=e[i.id][n.id];return s},dispose:function(){e={}}}},Y=new K(it,H,U,A),J=new function(t,e,i,n){var s;this.setMode=function(t){s=t},this.render=function(e,n){t.drawArrays(s,e,n),i.update(n,s)},this.renderInstances=function(r,a,o){if(n.isWebGL2)var l=t;else if(null===(l=e.get("ANGLE_instanced_arrays")))return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[n.isWebGL2?"drawArraysInstanced":"drawArraysInstancedANGLE"](s,a,o,r.maxInstancedCount),i.update(o,s,r.maxInstancedCount)}}(At,k,N,B),tt=new function(t,e,i,n){var s,r,a;this.setMode=function(t){s=t},this.setIndex=function(t){r=t.type,a=t.bytesPerElement},this.render=function(e,n){t.drawElements(s,n,r,e*a),i.update(n,s)},this.renderInstances=function(o,l,h){if(n.isWebGL2)var c=t;else if(null===(c=e.get("ANGLE_instanced_arrays")))return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");c[n.isWebGL2?"drawElementsInstanced":"drawElementsInstancedANGLE"](s,h,r,l*a,o.maxInstancedCount),i.update(h,s,o.maxInstancedCount)}}(At,k,N,B),N.programs=z.programs,it.context=At,it.capabilities=B,it.extensions=k,it.properties=F,it.renderLists=W,it.state=H,it.info=N}function r(t){t.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),nt=!0}function a(){console.log("THREE.WebGLRenderer: Context Restored."),nt=!1,n()}function l(t){(t=t.target).removeEventListener("dispose",l),h(t),F.remove(t)}function h(t){var e=F.get(t).program;t.program=void 0,void 0!==e&&z.releaseProgram(e)}function c(t,e,i,n){for(var s=0,r=t.length;s<r;s++){var a=t[s],o=a.object,l=a.geometry,h=void 0===n?a.material:n;if(a=a.group,i.isArrayCamera){pt=i;for(var c=i.cameras,u=0,p=c.length;u<p;u++){var m=c[u];o.layers.test(m.layers)&&(H.viewport(mt.copy(m.viewport)),D.setupLights(m),d(o,e,m,l,h,a))}}else pt=null,d(o,e,i,l,h,a)}}function d(t,i,n,s,r,a){if(t.onBeforeRender(it,i,n,s,r,a),D=q.get(i,pt||n),t.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),t.isImmediateRenderObject){H.setMaterial(r);var o=m(n,i.fog,r,t);ct=e=null,ut=!1,function(t,e){t.render(function(t){it.renderBufferImmediate(t,e)})}(t,o)}else it.renderBufferDirect(n,i.fog,s,r,t,a);t.onAfterRender(it,i,n,s,r,a),D=q.get(i,pt||n)}function p(t,e,i){var n=F.get(t),s=D.state.lights,r=n.lightsHash,a=s.state.hash;i=z.getParameters(t,s.state,D.state.shadowsArray,e,Mt.numPlanes,Mt.numIntersection,i);var o=z.getProgramCode(t,i),c=n.program,u=!0;if(void 0===c)t.addEventListener("dispose",l);else if(c.code!==o)h(t);else{if(r.stateID!==a.stateID||r.directionalLength!==a.directionalLength||r.pointLength!==a.pointLength||r.spotLength!==a.spotLength||r.rectAreaLength!==a.rectAreaLength||r.hemiLength!==a.hemiLength||r.shadowsLength!==a.shadowsLength)r.stateID=a.stateID,r.directionalLength=a.directionalLength,r.pointLength=a.pointLength,r.spotLength=a.spotLength,r.rectAreaLength=a.rectAreaLength,r.hemiLength=a.hemiLength,r.shadowsLength=a.shadowsLength;else if(void 0!==i.shaderID)return;u=!1}if(u&&(i.shaderID?(o=nr[i.shaderID],n.shader={name:t.type,uniforms:y(o.uniforms),vertexShader:o.vertexShader,fragmentShader:o.fragmentShader}):n.shader={name:t.type,uniforms:t.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader},t.onBeforeCompile(n.shader,it),o=z.getProgramCode(t,i),c=z.acquireProgram(t,n.shader,i,o),n.program=c,t.program=c),i=c.getAttributes(),t.morphTargets)for(o=t.numSupportedMorphTargets=0;o<it.maxMorphTargets;o++)0<=i["morphTarget"+o]&&t.numSupportedMorphTargets++;if(t.morphNormals)for(o=t.numSupportedMorphNormals=0;o<it.maxMorphNormals;o++)0<=i["morphNormal"+o]&&t.numSupportedMorphNormals++;i=n.shader.uniforms,(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(n.numClippingPlanes=Mt.numPlanes,n.numIntersection=Mt.numIntersection,i.clippingPlanes=Mt.uniform),n.fog=e,void 0===r&&(n.lightsHash=r={}),r.stateID=a.stateID,r.directionalLength=a.directionalLength,r.pointLength=a.pointLength,r.spotLength=a.spotLength,r.rectAreaLength=a.rectAreaLength,r.hemiLength=a.hemiLength,r.shadowsLength=a.shadowsLength,t.lights&&(i.ambientLightColor.value=s.state.ambient,i.lightProbe.value=s.state.probe,i.directionalLights.value=s.state.directional,i.spotLights.value=s.state.spot,i.rectAreaLights.value=s.state.rectArea,i.pointLights.value=s.state.point,i.hemisphereLights.value=s.state.hemi,i.directionalShadowMap.value=s.state.directionalShadowMap,i.directionalShadowMatrix.value=s.state.directionalShadowMatrix,i.spotShadowMap.value=s.state.spotShadowMap,i.spotShadowMatrix.value=s.state.spotShadowMatrix,i.pointShadowMap.value=s.state.pointShadowMap,i.pointShadowMatrix.value=s.state.pointShadowMatrix),t=n.program.getUniforms(),t=Nt.seqWithValue(t.seq,i),n.uniformsList=t}function m(t,e,i,n){V.resetTextureUnits();var s=F.get(i),r=s.lightsHash,a=D.state.lights.state.hash;Tt&&(Ct||t!==dt)&&Mt.setState(i.clippingPlanes,i.clipIntersection,i.clipShadows,t,s,t===dt&&i.id===ht),!1===i.needsUpdate&&(void 0===s.program?i.needsUpdate=!0:i.fog&&s.fog!==e?i.needsUpdate=!0:(!i.lights||r.stateID===a.stateID&&r.directionalLength===a.directionalLength&&r.pointLength===a.pointLength&&r.spotLength===a.spotLength&&r.rectAreaLength===a.rectAreaLength&&r.hemiLength===a.hemiLength&&r.shadowsLength===a.shadowsLength)&&(void 0===s.numClippingPlanes||s.numClippingPlanes===Mt.numPlanes&&s.numIntersection===Mt.numIntersection)||(i.needsUpdate=!0)),i.needsUpdate&&(p(i,e,n),i.needsUpdate=!1);var o=!1,l=!1,h=!1;a=(r=s.program).getUniforms();var c=s.shader.uniforms;if(H.useProgram(r.program)&&(h=l=o=!0),i.id!==ht&&(ht=i.id,l=!0),(o||dt!==t)&&(a.setValue(At,"projectionMatrix",t.projectionMatrix),B.logarithmicDepthBuffer&&a.setValue(At,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),dt!==t&&(dt=t,h=l=!0),(i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.envMap)&&(void 0!==(o=a.map.cameraPosition)&&o.setValue(At,_t.setFromMatrixPosition(t.matrixWorld))),(i.isMeshPhongMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.skinning)&&a.setValue(At,"viewMatrix",t.matrixWorldInverse)),i.skinning&&(a.setOptional(At,n,"bindMatrix"),a.setOptional(At,n,"bindMatrixInverse"),t=n.skeleton))if(o=t.bones,B.floatVertexTextures){if(void 0===t.boneTexture){o=Math.sqrt(4*o.length),o=Js.ceilPowerOfTwo(o),o=Math.max(o,4);var d=new Float32Array(o*o*4);d.set(t.boneMatrices);var m=new u(d,o,o,1023,1015);m.needsUpdate=!0,t.boneMatrices=d,t.boneTexture=m,t.boneTextureSize=o}a.setValue(At,"boneTexture",t.boneTexture,V),a.setValue(At,"boneTextureSize",t.boneTextureSize)}else a.setOptional(At,t,"boneMatrices");return l&&(a.setValue(At,"toneMappingExposure",it.toneMappingExposure),a.setValue(At,"toneMappingWhitePoint",it.toneMappingWhitePoint),i.lights&&(l=h,c.ambientLightColor.needsUpdate=l,c.lightProbe.needsUpdate=l,c.directionalLights.needsUpdate=l,c.pointLights.needsUpdate=l,c.spotLights.needsUpdate=l,c.rectAreaLights.needsUpdate=l,c.hemisphereLights.needsUpdate=l),e&&i.fog&&(c.fogColor.value.copy(e.color),e.isFog?(c.fogNear.value=e.near,c.fogFar.value=e.far):e.isFogExp2&&(c.fogDensity.value=e.density)),i.isMeshBasicMaterial?v(c,i):i.isMeshLambertMaterial?(v(c,i),i.emissiveMap&&(c.emissiveMap.value=i.emissiveMap)):i.isMeshPhongMaterial?(v(c,i),i.isMeshToonMaterial?(b(c,i),i.gradientMap&&(c.gradientMap.value=i.gradientMap)):b(c,i)):i.isMeshStandardMaterial?(v(c,i),i.isMeshPhysicalMaterial?(S(c,i),c.reflectivity.value=i.reflectivity,c.clearCoat.value=i.clearCoat,c.clearCoatRoughness.value=i.clearCoatRoughness):S(c,i)):i.isMeshMatcapMaterial?(v(c,i),i.matcap&&(c.matcap.value=i.matcap),i.bumpMap&&(c.bumpMap.value=i.bumpMap,c.bumpScale.value=i.bumpScale,1===i.side&&(c.bumpScale.value*=-1)),i.normalMap&&(c.normalMap.value=i.normalMap,c.normalScale.value.copy(i.normalScale),1===i.side&&c.normalScale.value.negate()),i.displacementMap&&(c.displacementMap.value=i.displacementMap,c.displacementScale.value=i.displacementScale,c.displacementBias.value=i.displacementBias)):i.isMeshDepthMaterial?(v(c,i),i.displacementMap&&(c.displacementMap.value=i.displacementMap,c.displacementScale.value=i.displacementScale,c.displacementBias.value=i.displacementBias)):i.isMeshDistanceMaterial?(v(c,i),i.displacementMap&&(c.displacementMap.value=i.displacementMap,c.displacementScale.value=i.displacementScale,c.displacementBias.value=i.displacementBias),c.referencePosition.value.copy(i.referencePosition),c.nearDistance.value=i.nearDistance,c.farDistance.value=i.farDistance):i.isMeshNormalMaterial?(v(c,i),i.bumpMap&&(c.bumpMap.value=i.bumpMap,c.bumpScale.value=i.bumpScale,1===i.side&&(c.bumpScale.value*=-1)),i.normalMap&&(c.normalMap.value=i.normalMap,c.normalScale.value.copy(i.normalScale),1===i.side&&c.normalScale.value.negate()),i.displacementMap&&(c.displacementMap.value=i.displacementMap,c.displacementScale.value=i.displacementScale,c.displacementBias.value=i.displacementBias)):i.isLineBasicMaterial?(c.diffuse.value.copy(i.color),c.opacity.value=i.opacity,i.isLineDashedMaterial&&(c.dashSize.value=i.dashSize,c.totalSize.value=i.dashSize+i.gapSize,c.scale.value=i.scale)):i.isPointsMaterial?(c.diffuse.value.copy(i.color),c.opacity.value=i.opacity,c.size.value=i.size*bt,c.scale.value=.5*vt,c.map.value=i.map,null!==i.map&&(!0===i.map.matrixAutoUpdate&&i.map.updateMatrix(),c.uvTransform.value.copy(i.map.matrix))):i.isSpriteMaterial?(c.diffuse.value.copy(i.color),c.opacity.value=i.opacity,c.rotation.value=i.rotation,c.map.value=i.map,null!==i.map&&(!0===i.map.matrixAutoUpdate&&i.map.updateMatrix(),c.uvTransform.value.copy(i.map.matrix))):i.isShadowMaterial&&(c.color.value.copy(i.color),c.opacity.value=i.opacity),void 0!==c.ltc_1&&(c.ltc_1.value=ir.LTC_1),void 0!==c.ltc_2&&(c.ltc_2.value=ir.LTC_2),Nt.upload(At,s.uniformsList,c,V)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(Nt.upload(At,s.uniformsList,c,V),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&a.setValue(At,"center",n.center),a.setValue(At,"modelViewMatrix",n.modelViewMatrix),a.setValue(At,"normalMatrix",n.normalMatrix),a.setValue(At,"modelMatrix",n.matrixWorld),r}function v(t,e){if(t.opacity.value=e.opacity,e.color&&t.diffuse.value.copy(e.color),e.emissive&&t.emissive.value.copy(e.emissive).multiplyScalar(e.emissiveIntensity),e.map&&(t.map.value=e.map),e.alphaMap&&(t.alphaMap.value=e.alphaMap),e.specularMap&&(t.specularMap.value=e.specularMap),e.envMap&&(t.envMap.value=e.envMap,t.flipEnvMap.value=e.envMap.isCubeTexture?-1:1,t.reflectivity.value=e.reflectivity,t.refractionRatio.value=e.refractionRatio,t.maxMipLevel.value=F.get(e.envMap).__maxMipLevel),e.lightMap&&(t.lightMap.value=e.lightMap,t.lightMapIntensity.value=e.lightMapIntensity),e.aoMap&&(t.aoMap.value=e.aoMap,t.aoMapIntensity.value=e.aoMapIntensity),e.map)var i=e.map;else e.specularMap?i=e.specularMap:e.displacementMap?i=e.displacementMap:e.normalMap?i=e.normalMap:e.bumpMap?i=e.bumpMap:e.roughnessMap?i=e.roughnessMap:e.metalnessMap?i=e.metalnessMap:e.alphaMap?i=e.alphaMap:e.emissiveMap&&(i=e.emissiveMap);void 0!==i&&(i.isWebGLRenderTarget&&(i=i.texture),!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uvTransform.value.copy(i.matrix))}function b(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap),e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1)),e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate()),e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}function S(t,e){t.roughness.value=e.roughness,t.metalness.value=e.metalness,e.roughnessMap&&(t.roughnessMap.value=e.roughnessMap),e.metalnessMap&&(t.metalnessMap.value=e.metalnessMap),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap),e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,1===e.side&&(t.bumpScale.value*=-1)),e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),1===e.side&&t.normalScale.value.negate()),e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias),e.envMap&&(t.envMapIntensity.value=e.envMapIntensity)}console.log("THREE.WebGLRenderer","105");var E=void 0!==(t=t||{}).canvas?t.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),M=void 0!==t.context?t.context:null,T=void 0!==t.alpha&&t.alpha,C=void 0===t.depth||t.depth,P=void 0===t.stencil||t.stencil,_=void 0!==t.antialias&&t.antialias,A=void 0===t.premultipliedAlpha||t.premultipliedAlpha,L=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,R=void 0!==t.powerPreference?t.powerPreference:"default",I=void 0!==t.failIfMajorPerformanceCaveat&&t.failIfMajorPerformanceCaveat,O=null,D=null;this.domElement=E,this.context=null,this.debug={checkShaderErrors:!0},this.sortObjects=this.autoClearStencil=this.autoClearDepth=this.autoClearColor=this.autoClear=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.physicallyCorrectLights=this.gammaOutput=this.gammaInput=!1,this.toneMappingWhitePoint=this.toneMappingExposure=this.toneMapping=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var k,B,H,N,F,V,j,G,U,z,W,q,Y,X,J,tt,et,it=this,nt=!1,st=null,rt=0,at=0,ot=null,lt=null,ht=-1,ct=e=null,ut=!1,dt=null,pt=null,mt=new o,ft=new o,gt=null,yt=E.width,vt=E.height,bt=1,wt=new o(0,0,yt,vt),xt=new o(0,0,yt,vt),St=!1,Et=new f,Mt=new Z,Tt=!1,Ct=!1,Pt=new g,_t=new s;try{T={alpha:T,depth:C,stencil:P,antialias:_,premultipliedAlpha:A,preserveDrawingBuffer:L,powerPreference:R,failIfMajorPerformanceCaveat:I,xrCompatible:!0},E.addEventListener("webglcontextlost",r,!1),E.addEventListener("webglcontextrestored",a,!1);var At=M||E.getContext("webgl",T)||E.getContext("experimental-webgl",T);if(null===At){if(null!==E.getContext("webgl"))throw Error("Error creating WebGL context with your selected attributes.");throw Error("Error creating WebGL context.")}void 0===At.getShaderPrecisionFormat&&(At.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){throw console.error("THREE.WebGLRenderer: "+t.message),t}n();var Lt="undefined"!=typeof navigator&&"xr"in navigator&&"supportsSession"in navigator.xr?new he(it):new le(it);this.vr=Lt;var Rt=new ee(it,U,B.maxTextureSize);this.shadowMap=Rt,this.getContext=function(){return At},this.getContextAttributes=function(){return At.getContextAttributes()},this.forceContextLoss=function(){var t=k.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){var t=k.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return bt},this.setPixelRatio=function(t){void 0!==t&&(bt=t,this.setSize(yt,vt,!1))},this.getSize=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),t=new i),t.set(yt,vt)},this.setSize=function(t,e,i){Lt.isPresenting()?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(yt=t,vt=e,E.width=t*bt,E.height=e*bt,!1!==i&&(E.style.width=t+"px",E.style.height=e+"px"),this.setViewport(0,0,t,e))},this.getDrawingBufferSize=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),t=new i),t.set(yt*bt,vt*bt)},this.setDrawingBufferSize=function(t,e,i){yt=t,vt=e,bt=i,E.width=t*i,E.height=e*i,this.setViewport(0,0,t,e)},this.getCurrentViewport=function(t){return void 0===t&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),t=new o),t.copy(mt)},this.getViewport=function(t){return t.copy(wt)},this.setViewport=function(t,e,i,n){t.isVector4?wt.set(t.x,t.y,t.z,t.w):wt.set(t,e,i,n),H.viewport(mt.copy(wt).multiplyScalar(bt))},this.getScissor=function(t){return t.copy(xt)},this.setScissor=function(t,e,i,n){t.isVector4?xt.set(t.x,t.y,t.z,t.w):xt.set(t,e,i,n),H.scissor(ft.copy(xt).multiplyScalar(bt))},this.getScissorTest=function(){return St},this.setScissorTest=function(t){H.setScissorTest(St=t)},this.getClearColor=function(){return Y.getClearColor()},this.setClearColor=function(){Y.setClearColor.apply(Y,arguments)},this.getClearAlpha=function(){return Y.getClearAlpha()},this.setClearAlpha=function(){Y.setClearAlpha.apply(Y,arguments)},this.clear=function(t,e,i){var n=0;(void 0===t||t)&&(n|=16384),(void 0===e||e)&&(n|=256),(void 0===i||i)&&(n|=1024),At.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){E.removeEventListener("webglcontextlost",r,!1),E.removeEventListener("webglcontextrestored",a,!1),W.dispose(),q.dispose(),F.dispose(),U.dispose(),Lt.dispose(),Ot.stop()},this.renderBufferImmediate=function(t,e){H.initAttributes();var i=F.get(t);t.hasPositions&&!i.position&&(i.position=At.createBuffer()),t.hasNormals&&!i.normal&&(i.normal=At.createBuffer()),t.hasUvs&&!i.uv&&(i.uv=At.createBuffer()),t.hasColors&&!i.color&&(i.color=At.createBuffer()),e=e.getAttributes(),t.hasPositions&&(At.bindBuffer(34962,i.position),At.bufferData(34962,t.positionArray,35048),H.enableAttribute(e.position),At.vertexAttribPointer(e.position,3,5126,!1,0,0)),t.hasNormals&&(At.bindBuffer(34962,i.normal),At.bufferData(34962,t.normalArray,35048),H.enableAttribute(e.normal),At.vertexAttribPointer(e.normal,3,5126,!1,0,0)),t.hasUvs&&(At.bindBuffer(34962,i.uv),At.bufferData(34962,t.uvArray,35048),H.enableAttribute(e.uv),At.vertexAttribPointer(e.uv,2,5126,!1,0,0)),t.hasColors&&(At.bindBuffer(34962,i.color),At.bufferData(34962,t.colorArray,35048),H.enableAttribute(e.color),At.vertexAttribPointer(e.color,3,5126,!1,0,0)),H.disableUnusedAttributes(),At.drawArrays(4,0,t.count),t.count=0},this.renderBufferDirect=function(t,i,n,s,r,a){var o=r.isMesh&&0>r.matrixWorld.determinant();H.setMaterial(s,o);var l=m(t,i,s,r),h=!1;e===n.id&&ct===l.id&&ut===(!0===s.wireframe)||(e=n.id,ct=l.id,ut=!0===s.wireframe,h=!0),r.morphTargetInfluences&&(X.update(r,n,s,l),h=!0),o=n.index;var c=n.attributes.position;if(i=1,!0===s.wireframe&&(o=G.getWireframeAttribute(n),i=2),t=J,null!==o){var u=j.get(o);(t=tt).setIndex(u)}if(h){if(n&&n.isInstancedBufferGeometry&&!B.isWebGL2&&null===k.get("ANGLE_instanced_arrays"))console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");else{H.initAttributes(),h=n.attributes,l=l.getAttributes();var d=s.defaultAttributeValues;for(E in l){var p=l[E];if(0<=p){var f=h[E];if(void 0!==f){var g=f.normalized,y=f.itemSize,v=j.get(f);if(void 0!==v){var b=v.buffer,w=v.type;if(v=v.bytesPerElement,f.isInterleavedBufferAttribute){var x=f.data,S=x.stride;f=f.offset,x&&x.isInstancedInterleavedBuffer?(H.enableAttributeAndDivisor(p,x.meshPerAttribute),void 0===n.maxInstancedCount&&(n.maxInstancedCount=x.meshPerAttribute*x.count)):H.enableAttribute(p),At.bindBuffer(34962,b),At.vertexAttribPointer(p,y,w,g,S*v,f*v)}else f.isInstancedBufferAttribute?(H.enableAttributeAndDivisor(p,f.meshPerAttribute),void 0===n.maxInstancedCount&&(n.maxInstancedCount=f.meshPerAttribute*f.count)):H.enableAttribute(p),At.bindBuffer(34962,b),At.vertexAttribPointer(p,y,w,g,0,0)}}else if(void 0!==d&&void 0!==(g=d[E]))switch(g.length){case 2:At.vertexAttrib2fv(p,g);break;case 3:At.vertexAttrib3fv(p,g);break;case 4:At.vertexAttrib4fv(p,g);break;default:At.vertexAttrib1fv(p,g)}}}H.disableUnusedAttributes()}null!==o&&At.bindBuffer(34963,u.buffer)}u=1/0,null!==o?u=o.count:void 0!==c&&(u=c.count),o=n.drawRange.start*i,c=null!==a?a.start*i:0;var E=Math.max(o,c);if(0!==(a=Math.max(0,Math.min(u,o+n.drawRange.count*i,c+(null!==a?a.count*i:1/0))-1-E+1))){if(r.isMesh)if(!0===s.wireframe)H.setLineWidth(s.wireframeLinewidth*(null===ot?bt:1)),t.setMode(1);else switch(r.drawMode){case 0:t.setMode(4);break;case 1:t.setMode(5);break;case 2:t.setMode(6)}else r.isLine?(void 0===(s=s.linewidth)&&(s=1),H.setLineWidth(s*(null===ot?bt:1)),r.isLineSegments?t.setMode(1):r.isLineLoop?t.setMode(2):t.setMode(3)):r.isPoints?t.setMode(0):r.isSprite&&t.setMode(4);n&&n.isInstancedBufferGeometry?0<n.maxInstancedCount&&t.renderInstances(n,E,a):t.render(E,a)}},this.compile=function(t,e){(D=q.get(t,e)).init(),t.traverse(function(t){t.isLight&&(D.pushLight(t),t.castShadow&&D.pushShadow(t))}),D.setupLights(e),t.traverse(function(e){if(e.material)if(Array.isArray(e.material))for(var i=0;i<e.material.length;i++)p(e.material[i],t.fog,e);else p(e.material,t.fog,e)})};var It=null,Ot=new w;Ot.setAnimationLoop(function(t){Lt.isPresenting()||It&&It(t)}),"undefined"!=typeof window&&Ot.setContext(window),this.setAnimationLoop=function(t){It=t,Lt.setAnimationLoop(t),Ot.start()},this.render=function(t,i,n,s){if(void 0!==n){console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead.");var r=n}if(void 0!==s){console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead.");var a=s}i&&i.isCamera?nt||(ct=e=null,ut=!1,ht=-1,dt=null,!0===t.autoUpdate&&t.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),Lt.enabled&&(i=Lt.getCamera(i)),(D=q.get(t,i)).init(),t.onBeforeRender(it,t,i,r||ot),Pt.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),Et.setFromMatrix(Pt),Ct=this.localClippingEnabled,Tt=Mt.init(this.clippingPlanes,Ct,i),(O=W.get(t,i)).init(),function t(e,i,n,s){if(!1!==e.visible){if(e.layers.test(i.layers))if(e.isGroup)n=e.renderOrder;else if(e.isLight)D.pushLight(e),e.castShadow&&D.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||Et.intersectsSprite(e)){s&&_t.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Pt);var r=U.update(e),a=e.material;a.visible&&O.push(e,r,a,n,_t.z,null)}}else if(e.isImmediateRenderObject)s&&_t.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Pt),O.push(e,null,e.material,n,_t.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.update(),!e.frustumCulled||Et.intersectsObject(e)))if(s&&_t.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Pt),r=U.update(e),a=e.material,Array.isArray(a))for(var o=r.groups,l=0,h=o.length;l<h;l++){var c=o[l],u=a[c.materialIndex];u&&u.visible&&O.push(e,r,u,n,_t.z,c)}else a.visible&&O.push(e,r,a,n,_t.z,null);for(l=0,h=(e=e.children).length;l<h;l++)t(e[l],i,n,s)}}(t,i,0,it.sortObjects),!0===it.sortObjects&&O.sort(),Tt&&Mt.beginShadows(),Rt.render(D.state.shadowsArray,t,i),D.setupLights(i),Tt&&Mt.endShadows(),this.info.autoReset&&this.info.reset(),void 0!==r&&this.setRenderTarget(r),Y.render(O,t,i,a),n=O.opaque,s=O.transparent,t.overrideMaterial?(r=t.overrideMaterial,n.length&&c(n,t,i,r),s.length&&c(s,t,i,r)):(n.length&&c(n,t,i),s.length&&c(s,t,i)),t.onAfterRender(it,t,i),null!==ot&&(V.updateRenderTargetMipmap(ot),V.updateMultisampleRenderTarget(ot)),H.buffers.depth.setTest(!0),H.buffers.depth.setMask(!0),H.buffers.color.setMask(!0),H.setPolygonOffset(!1),Lt.enabled&&Lt.submitFrame(),D=O=null):console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.setFramebuffer=function(t){st!==t&&At.bindFramebuffer(36160,t),st=t},this.getActiveCubeFace=function(){return rt},this.getActiveMipMapLevel=function(){return at},this.getRenderTarget=function(){return ot},this.setRenderTarget=function(t,e,i){ot=t,rt=e,at=i,t&&void 0===F.get(t).__webglFramebuffer&&V.setupRenderTarget(t);var n=st,s=!1;t?(n=F.get(t).__webglFramebuffer,t.isWebGLRenderTargetCube?(n=n[e||0],s=!0):n=t.isWebGLMultisampleRenderTarget?F.get(t).__webglMultisampledFramebuffer:n,mt.copy(t.viewport),ft.copy(t.scissor),gt=t.scissorTest):(mt.copy(wt).multiplyScalar(bt),ft.copy(xt).multiplyScalar(bt),gt=St),lt!==n&&(At.bindFramebuffer(36160,n),lt=n),H.viewport(mt),H.scissor(ft),H.setScissorTest(gt),s&&(t=F.get(t.texture),At.framebufferTexture2D(36160,36064,34069+(e||0),t.__webglTexture,i||0))},this.readRenderTargetPixels=function(t,e,i,n,s,r,a){if(t&&t.isWebGLRenderTarget){var o=F.get(t).__webglFramebuffer;if(t.isWebGLRenderTargetCube&&void 0!==a&&(o=o[a]),o){a=!1,o!==lt&&(At.bindFramebuffer(36160,o),a=!0);try{var l=t.texture,h=l.format,c=l.type;1023!==h&&et.convert(h)!==At.getParameter(35739)?console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format."):1009===c||et.convert(c)===At.getParameter(35738)||1015===c&&(B.isWebGL2||k.get("OES_texture_float")||k.get("WEBGL_color_buffer_float"))||1016===c&&(B.isWebGL2?k.get("EXT_color_buffer_float"):k.get("EXT_color_buffer_half_float"))?36053===At.checkFramebufferStatus(36160)?0<=e&&e<=t.width-n&&0<=i&&i<=t.height-s&&At.readPixels(e,i,n,s,et.convert(h),et.convert(c),r):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete."):console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.")}finally{a&&At.bindFramebuffer(36160,lt)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")},this.copyFramebufferToTexture=function(t,e,i){var n=e.image.width,s=e.image.height,r=et.convert(e.format);V.setTexture2D(e,0),At.copyTexImage2D(3553,i||0,r,t.x,t.y,n,s,0)},this.copyTextureToTexture=function(t,e,i,n){var s=e.image.width,r=e.image.height,a=et.convert(i.format),o=et.convert(i.type);V.setTexture2D(i,0),e.isDataTexture?At.texSubImage2D(3553,n||0,t.x,t.y,s,r,a,o,e.image.data):At.texSubImage2D(3553,n||0,t.x,t.y,a,o,e.image)}}function ue(t,e){this.name="",this.color=new b(t),this.density=void 0!==e?e:25e-5}function de(t,e,i){this.name="",this.color=new b(t),this.near=void 0!==e?e:1,this.far=void 0!==i?i:1e3}function pe(){T.call(this),this.type="Scene",this.overrideMaterial=this.fog=this.background=null,this.autoUpdate=!0}function me(t,e){this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function fe(t,e,i,n){this.data=t,this.itemSize=e,this.offset=i,this.normalized=!0===n}function ge(t){z.call(this),this.type="SpriteMaterial",this.color=new b(16777215),this.map=null,this.rotation=0,this.sizeAttenuation=!0,this.lights=!1,this.transparent=!0,this.setValues(t)}function ye(t){if(T.call(this),this.type="Sprite",void 0===wr){wr=new F;var e=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]);e=new me(e,5),wr.setIndex([0,1,2,0,2,3]),wr.addAttribute("position",new fe(e,3,0,!1)),wr.addAttribute("uv",new fe(e,2,3,!1))}this.geometry=wr,this.material=void 0!==t?t:new ge,this.center=new i(.5,.5)}function ve(){T.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function be(t,e){t&&t.isGeometry&&console.error("THREE.SkinnedMesh no longer supports THREE.Geometry. Use THREE.BufferGeometry instead."),J.call(this,t,e),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new g,this.bindMatrixInverse=new g}function we(t,e){if(t=t||[],this.bones=t.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===e)this.calculateInverses();else if(this.bones.length===e.length)this.boneInverses=e.slice(0);else for(console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[],t=0,e=this.bones.length;t<e;t++)this.boneInverses.push(new g)}function xe(){T.call(this),this.type="Bone"}function Se(t){z.call(this),this.type="LineBasicMaterial",this.color=new b(16777215),this.linewidth=1,this.linejoin=this.linecap="round",this.lights=!1,this.setValues(t)}function Ee(t,e,i){1===i&&console.error("THREE.Line: parameter THREE.LinePieces no longer supported. Use THREE.LineSegments instead."),T.call(this),this.type="Line",this.geometry=void 0!==t?t:new F,this.material=void 0!==e?e:new Se({color:16777215*Math.random()})}function Me(t,e){Ee.call(this,t,e),this.type="LineSegments"}function Te(t,e){Ee.call(this,t,e),this.type="LineLoop"}function Ce(t){z.call(this),this.type="PointsMaterial",this.color=new b(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.lights=this.morphTargets=!1,this.setValues(t)}function Pe(t,e){T.call(this),this.type="Points",this.geometry=void 0!==t?t:new F,this.material=void 0!==e?e:new Ce({color:16777215*Math.random()})}function _e(t,e,i,n,s,r,o,l,h){a.call(this,t,e,i,n,s,r,o,l,h),this.format=void 0!==o?o:1022,this.minFilter=void 0!==r?r:1006,this.magFilter=void 0!==s?s:1006,this.generateMipmaps=!1}function Ae(t,e,i,n,s,r,o,l,h,c,u,d){a.call(this,null,r,o,l,h,c,n,s,u,d),this.image={width:e,height:i},this.mipmaps=t,this.generateMipmaps=this.flipY=!1}function Le(t,e,i,n,s,r,o,l,h){a.call(this,t,e,i,n,s,r,o,l,h),this.needsUpdate=!0}function Re(t,e,i,n,s,r,o,l,h,c){if(1026!==(c=void 0!==c?c:1026)&&1027!==c)throw Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&1026===c&&(i=1012),void 0===i&&1027===c&&(i=1020),a.call(this,null,n,s,r,o,l,c,i,h),this.image={width:t,height:e},this.magFilter=void 0!==o?o:1003,this.minFilter=void 0!==l?l:1003,this.generateMipmaps=this.flipY=!1}function Ie(t){F.call(this),this.type="WireframeGeometry";var e,i,n,r=[],a=[0,0],o={},l=["a","b","c"];if(t&&t.isGeometry){var h=t.faces,c=0;for(i=h.length;c<i;c++){var u=h[c];for(e=0;3>e;e++){var d=u[l[e]],p=u[l[(e+1)%3]];a[0]=Math.min(d,p),a[1]=Math.max(d,p),void 0===o[d=a[0]+","+a[1]]&&(o[d]={index1:a[0],index2:a[1]})}}for(d in o)c=o[d],l=t.vertices[c.index1],r.push(l.x,l.y,l.z),l=t.vertices[c.index2],r.push(l.x,l.y,l.z)}else if(t&&t.isBufferGeometry)if(l=new s,null!==t.index){h=t.attributes.position,u=t.index;var m=t.groups;for(0===m.length&&(m=[{start:0,count:u.count,materialIndex:0}]),t=0,n=m.length;t<n;++t)for(e=(c=m[t]).start,i=c.count,c=e,i=e+i;c<i;c+=3)for(e=0;3>e;e++)d=u.getX(c+e),p=u.getX(c+(e+1)%3),a[0]=Math.min(d,p),a[1]=Math.max(d,p),void 0===o[d=a[0]+","+a[1]]&&(o[d]={index1:a[0],index2:a[1]});for(d in o)c=o[d],l.fromBufferAttribute(h,c.index1),r.push(l.x,l.y,l.z),l.fromBufferAttribute(h,c.index2),r.push(l.x,l.y,l.z)}else for(c=0,i=(h=t.attributes.position).count/3;c<i;c++)for(e=0;3>e;e++)o=3*c+e,l.fromBufferAttribute(h,o),r.push(l.x,l.y,l.z),o=3*c+(e+1)%3,l.fromBufferAttribute(h,o),r.push(l.x,l.y,l.z);this.addAttribute("position",new k(r,3))}function Oe(t,e,i){C.call(this),this.type="ParametricGeometry",this.parameters={func:t,slices:e,stacks:i},this.fromBufferGeometry(new De(t,e,i)),this.mergeVertices()}function De(t,e,i){F.call(this),this.type="ParametricBufferGeometry",this.parameters={func:t,slices:e,stacks:i};var n,r,a=[],o=[],l=[],h=[],c=new s,u=new s,d=new s,p=new s,m=new s;3>t.length&&console.error("THREE.ParametricGeometry: Function must now modify a Vector3 as third parameter.");var f=e+1;for(n=0;n<=i;n++){var g=n/i;for(r=0;r<=e;r++){var y=r/e;t(y,g,u),o.push(u.x,u.y,u.z),0<=y-1e-5?(t(y-1e-5,g,d),p.subVectors(u,d)):(t(y+1e-5,g,d),p.subVectors(d,u)),0<=g-1e-5?(t(y,g-1e-5,d),m.subVectors(u,d)):(t(y,g+1e-5,d),m.subVectors(d,u)),c.crossVectors(p,m).normalize(),l.push(c.x,c.y,c.z),h.push(y,g)}}for(n=0;n<i;n++)for(r=0;r<e;r++)t=n*f+r+1,c=(n+1)*f+r+1,u=(n+1)*f+r,a.push(n*f+r,t,u),a.push(t,c,u);this.setIndex(a),this.addAttribute("position",new k(o,3)),this.addAttribute("normal",new k(l,3)),this.addAttribute("uv",new k(h,2))}function ke(t,e,i,n){C.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:t,indices:e,radius:i,detail:n},this.fromBufferGeometry(new Be(t,e,i,n)),this.mergeVertices()}function Be(t,e,n,r){function a(t){h.push(t.x,t.y,t.z)}function o(e,i){e*=3,i.x=t[e+0],i.y=t[e+1],i.z=t[e+2]}function l(t,e,i,n){0>n&&1===t.x&&(c[e]=t.x-1),0===i.x&&0===i.z&&(c[e]=n/2/Math.PI+.5)}F.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:t,indices:e,radius:n,detail:r},n=n||1;var h=[],c=[];!function(t){for(var i=new s,n=new s,r=new s,l=0;l<e.length;l+=3){o(e[l+0],i),o(e[l+1],n),o(e[l+2],r);var h,c,u=i,d=n,p=r,m=Math.pow(2,t),f=[];for(c=0;c<=m;c++){f[c]=[];var g=u.clone().lerp(p,c/m),y=d.clone().lerp(p,c/m),v=m-c;for(h=0;h<=v;h++)f[c][h]=0===h&&c===m?g:g.clone().lerp(y,h/v)}for(c=0;c<m;c++)for(h=0;h<2*(m-c)-1;h++)u=Math.floor(h/2),0==h%2?(a(f[c][u+1]),a(f[c+1][u]),a(f[c][u])):(a(f[c][u+1]),a(f[c+1][u+1]),a(f[c+1][u]))}}(r=r||0),function(t){for(var e=new s,i=0;i<h.length;i+=3)e.x=h[i+0],e.y=h[i+1],e.z=h[i+2],e.normalize().multiplyScalar(t),h[i+0]=e.x,h[i+1]=e.y,h[i+2]=e.z}(n),function(){for(var t=new s,e=0;e<h.length;e+=3)t.x=h[e+0],t.y=h[e+1],t.z=h[e+2],c.push(Math.atan2(t.z,-t.x)/2/Math.PI+.5,1-(Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))/Math.PI+.5));t=new s,e=new s;for(var n=new s,r=new s,a=new i,o=new i,u=new i,d=0,p=0;d<h.length;d+=9,p+=6){t.set(h[d+0],h[d+1],h[d+2]),e.set(h[d+3],h[d+4],h[d+5]),n.set(h[d+6],h[d+7],h[d+8]),a.set(c[p+0],c[p+1]),o.set(c[p+2],c[p+3]),u.set(c[p+4],c[p+5]),r.copy(t).add(e).add(n).divideScalar(3);var m=Math.atan2(r.z,-r.x);l(a,p+0,t,m),l(o,p+2,e,m),l(u,p+4,n,m)}for(t=0;t<c.length;t+=6)e=c[t+0],n=c[t+2],r=c[t+4],a=Math.min(e,n,r),.9<Math.max(e,n,r)&&.1>a&&(.2>e&&(c[t+0]+=1),.2>n&&(c[t+2]+=1),.2>r&&(c[t+4]+=1))}(),this.addAttribute("position",new k(h,3)),this.addAttribute("normal",new k(h.slice(),3)),this.addAttribute("uv",new k(c,2)),0===r?this.computeVertexNormals():this.normalizeNormals()}function He(t,e){C.call(this),this.type="TetrahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new Ne(t,e)),this.mergeVertices()}function Ne(t,e){Be.call(this,[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],t,e),this.type="TetrahedronBufferGeometry",this.parameters={radius:t,detail:e}}function Fe(t,e){C.call(this),this.type="OctahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new Ve(t,e)),this.mergeVertices()}function Ve(t,e){Be.call(this,[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],t,e),this.type="OctahedronBufferGeometry",this.parameters={radius:t,detail:e}}function je(t,e){C.call(this),this.type="IcosahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new Ge(t,e)),this.mergeVertices()}function Ge(t,e){var i=(1+Math.sqrt(5))/2;Be.call(this,[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],t,e),this.type="IcosahedronBufferGeometry",this.parameters={radius:t,detail:e}}function Ue(t,e){C.call(this),this.type="DodecahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new ze(t,e)),this.mergeVertices()}function ze(t,e){var i=(1+Math.sqrt(5))/2,n=1/i;Be.call(this,[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-i,0,-n,i,0,n,-i,0,n,i,-n,-i,0,-n,i,0,n,-i,0,n,i,0,-i,0,-n,i,0,-n,-i,0,n,i,0,n],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],t,e),this.type="DodecahedronBufferGeometry",this.parameters={radius:t,detail:e}}function We(t,e,i,n,s,r){C.call(this),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:i,radialSegments:n,closed:s},void 0!==r&&console.warn("THREE.TubeGeometry: taper has been removed."),t=new qe(t,e,i,n,s),this.tangents=t.tangents,this.normals=t.normals,this.binormals=t.binormals,this.fromBufferGeometry(t),this.mergeVertices()}function qe(t,e,n,r,a){function o(i){m=t.getPointAt(i/e,m);var s=l.normals[i];for(i=l.binormals[i],c=0;c<=r;c++){var a=c/r*Math.PI*2,o=Math.sin(a);a=-Math.cos(a),d.x=a*s.x+o*i.x,d.y=a*s.y+o*i.y,d.z=a*s.z+o*i.z,d.normalize(),g.push(d.x,d.y,d.z),u.x=m.x+n*d.x,u.y=m.y+n*d.y,u.z=m.z+n*d.z,f.push(u.x,u.y,u.z)}}F.call(this),this.type="TubeBufferGeometry",this.parameters={path:t,tubularSegments:e,radius:n,radialSegments:r,closed:a},e=e||64,n=n||1,r=r||8,a=a||!1;var l=t.computeFrenetFrames(e,a);this.tangents=l.tangents,this.normals=l.normals,this.binormals=l.binormals;var h,c,u=new s,d=new s,p=new i,m=new s,f=[],g=[],y=[],v=[];for(h=0;h<e;h++)o(h);for(o(!1===a?e:0),h=0;h<=e;h++)for(c=0;c<=r;c++)p.x=h/e,p.y=c/r,y.push(p.x,p.y);!function(){for(c=1;c<=e;c++)for(h=1;h<=r;h++){var t=(r+1)*c+(h-1),i=(r+1)*c+h,n=(r+1)*(c-1)+h;v.push((r+1)*(c-1)+(h-1),t,n),v.push(t,i,n)}}(),this.setIndex(v),this.addAttribute("position",new k(f,3)),this.addAttribute("normal",new k(g,3)),this.addAttribute("uv",new k(y,2))}function Ye(t,e,i,n,s,r,a){C.call(this),this.type="TorusKnotGeometry",this.parameters={radius:t,tube:e,tubularSegments:i,radialSegments:n,p:s,q:r},void 0!==a&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new Xe(t,e,i,n,s,r)),this.mergeVertices()}function Xe(t,e,i,n,r,a){function o(t,e,i,n,s){var r=Math.sin(t);e=i/e*t,i=Math.cos(e),s.x=n*(2+i)*.5*Math.cos(t),s.y=n*(2+i)*r*.5,s.z=n*Math.sin(e)*.5}F.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:t,tube:e,tubularSegments:i,radialSegments:n,p:r,q:a},t=t||1,e=e||.4,i=Math.floor(i)||64,n=Math.floor(n)||8,r=r||2,a=a||3;var l,h=[],c=[],u=[],d=[],p=new s,m=new s,f=new s,g=new s,y=new s,v=new s,b=new s;for(l=0;l<=i;++l){var w=l/i*r*Math.PI*2;for(o(w,r,a,t,f),o(w+.01,r,a,t,g),v.subVectors(g,f),b.addVectors(g,f),y.crossVectors(v,b),b.crossVectors(y,v),y.normalize(),b.normalize(),w=0;w<=n;++w){var x=w/n*Math.PI*2,S=-e*Math.cos(x);x=e*Math.sin(x),p.x=f.x+(S*b.x+x*y.x),p.y=f.y+(S*b.y+x*y.y),p.z=f.z+(S*b.z+x*y.z),c.push(p.x,p.y,p.z),m.subVectors(p,f).normalize(),u.push(m.x,m.y,m.z),d.push(l/i),d.push(w/n)}}for(w=1;w<=i;w++)for(l=1;l<=n;l++)t=(n+1)*w+(l-1),e=(n+1)*w+l,r=(n+1)*(w-1)+l,h.push((n+1)*(w-1)+(l-1),t,r),h.push(t,e,r);this.setIndex(h),this.addAttribute("position",new k(c,3)),this.addAttribute("normal",new k(u,3)),this.addAttribute("uv",new k(d,2))}function Je(t,e,i,n,s){C.call(this),this.type="TorusGeometry",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:n,arc:s},this.fromBufferGeometry(new Ke(t,e,i,n,s)),this.mergeVertices()}function Ke(t,e,i,n,r){F.call(this),this.type="TorusBufferGeometry",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:n,arc:r},t=t||1,e=e||.4,i=Math.floor(i)||8,n=Math.floor(n)||6,r=r||2*Math.PI;var a,o,l=[],h=[],c=[],u=[],d=new s,p=new s,m=new s;for(a=0;a<=i;a++)for(o=0;o<=n;o++){var f=o/n*r,g=a/i*Math.PI*2;p.x=(t+e*Math.cos(g))*Math.cos(f),p.y=(t+e*Math.cos(g))*Math.sin(f),p.z=e*Math.sin(g),h.push(p.x,p.y,p.z),d.x=t*Math.cos(f),d.y=t*Math.sin(f),m.subVectors(p,d).normalize(),c.push(m.x,m.y,m.z),u.push(o/n),u.push(a/i)}for(a=1;a<=i;a++)for(o=1;o<=n;o++)t=(n+1)*(a-1)+o-1,e=(n+1)*(a-1)+o,r=(n+1)*a+o,l.push((n+1)*a+o-1,t,r),l.push(t,e,r);this.setIndex(l),this.addAttribute("position",new k(h,3)),this.addAttribute("normal",new k(c,3)),this.addAttribute("uv",new k(u,2))}function Ze(t,e,i,n,s){for(var r,a=0,o=e,l=i-n;o<i;o+=n)a+=(t[l]-t[o])*(t[o+1]+t[l+1]),l=o;if(s===0<a)for(s=e;s<i;s+=n)r=hi(s,t[s],t[s+1],r);else for(s=i-n;s>=e;s-=n)r=hi(s,t[s],t[s+1],r);return r&&ri(r,r.next)&&(ci(r),r=r.next),r}function Qe(t,e){if(!t)return t;e||(e=t);do{var i=!1;if(t.steiner||!ri(t,t.next)&&0!==si(t.prev,t,t.next))t=t.next;else{if(ci(t),(t=e=t.prev)===t.next)break;i=!0}}while(i||t!==e);return e}function $e(t,e){return t.x-e.x}function ti(t,e){var i=e,n=t.x,s=t.y,r=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var a=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=n&&a>r){if(r=a,a===n){if(s===i.y)return i;if(s===i.next.y)return i.next}var o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!o)return null;if(n===r)return o.prev;e=o,a=o.x;var l=o.y,h=1/0;for(i=o.next;i!==e;){if(n>=i.x&&i.x>=a&&n!==i.x&&ni(s<l?n:r,s,a,l,s<l?r:n,s,i.x,i.y)){var c=Math.abs(s-i.y)/(n-i.x);(c<h||c===h&&i.x>o.x)&&oi(i,t)&&(o=i,h=c)}i=i.next}return o}function ei(t,e,i,n,s){return 1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1)|(1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function ii(t){var e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}function ni(t,e,i,n,s,r,a,o){return 0<=(s-a)*(e-o)-(t-a)*(r-o)&&0<=(t-a)*(n-o)-(i-a)*(e-o)&&0<=(i-a)*(r-o)-(s-a)*(n-o)}function si(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function ri(t,e){return t.x===e.x&&t.y===e.y}function ai(t,e,i,n){return!!(ri(t,e)&&ri(i,n)||ri(t,n)&&ri(i,e))||0<si(t,e,i)!=0<si(t,e,n)&&0<si(i,n,t)!=0<si(i,n,e)}function oi(t,e){return 0>si(t.prev,t,t.next)?0<=si(t,e,t.next)&&0<=si(t,t.prev,e):0>si(t,e,t.prev)||0>si(t,t.next,e)}function li(t,e){var i=new ui(t.i,t.x,t.y),n=new ui(e.i,e.x,e.y),s=t.next,r=e.prev;return t.next=e,e.prev=t,i.next=s,s.prev=i,n.next=i,i.prev=n,r.next=n,n.prev=r,n}function hi(t,e,i,n){return t=new ui(t,e,i),n?(t.next=n.next,t.prev=n,n.next.prev=t,n.next=t):(t.prev=t,t.next=t),t}function ci(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ui(t,e,i){this.i=t,this.x=e,this.y=i,this.nextZ=this.prevZ=this.z=this.next=this.prev=null,this.steiner=!1}function di(t){var e=t.length;2<e&&t[e-1].equals(t[0])&&t.pop()}function pi(t,e){for(var i=0;i<e.length;i++)t.push(e[i].x),t.push(e[i].y)}function mi(t,e){C.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:t,options:e},this.fromBufferGeometry(new fi(t,e)),this.mergeVertices()}function fi(t,e){function n(t){function n(t,e,i){return e||console.error("THREE.ExtrudeGeometry: vec does not exist"),e.clone().multiplyScalar(i).add(t)}function l(t,e,n){var s=t.x-e.x,r=t.y-e.y,a=n.x-t.x,o=n.y-t.y,l=s*s+r*r;if(Math.abs(s*o-r*a)>Number.EPSILON){var h=Math.sqrt(l),c=Math.sqrt(a*a+o*o);if(l=e.x-r/h,e=e.y+s/h,2>=(r=(a=l+s*(o=((n.x-o/c-l)*o-(n.y+a/c-e)*a)/(s*o-r*a))-t.x)*a+(s=e+r*o-t.y)*s))return new i(a,s);r=Math.sqrt(r/2)}else t=!1,s>Number.EPSILON?a>Number.EPSILON&&(t=!0):s<-Number.EPSILON?a<-Number.EPSILON&&(t=!0):Math.sign(r)===Math.sign(o)&&(t=!0),t?(a=-r,r=Math.sqrt(l)):(a=s,s=r,r=Math.sqrt(l/2));return new i(a/r,s/r)}function h(t,e){for(j=t.length;0<=--j;){var i=j,n=j-1;0>n&&(n=t.length-1);var s,o=g+2*S;for(s=0;s<o;s++){var l=F*s,h=F*(s+1),c=e+n+l,u=e+n+h;h=e+i+h,d(e+i+l),d(c),d(h),d(c),d(u),d(h),l=a.length/3,p((l=M.generateSideWallUV(r,a,l-6,l-3,l-2,l-1))[0]),p(l[1]),p(l[3]),p(l[1]),p(l[2]),p(l[3])}}}function c(t,e,i){m.push(t),m.push(e),m.push(i)}function u(t,e,i){d(t),d(e),d(i),t=a.length/3,p((t=M.generateTopUV(r,a,t-3,t-2,t-1))[0]),p(t[1]),p(t[2])}function d(t){a.push(m[3*t]),a.push(m[3*t+1]),a.push(m[3*t+2])}function p(t){o.push(t.x),o.push(t.y)}var m=[],f=void 0!==e.curveSegments?e.curveSegments:12,g=void 0!==e.steps?e.steps:1,y=void 0!==e.depth?e.depth:100,v=void 0===e.bevelEnabled||e.bevelEnabled,b=void 0!==e.bevelThickness?e.bevelThickness:6,w=void 0!==e.bevelSize?e.bevelSize:b-2,x=void 0!==e.bevelOffset?e.bevelOffset:0,S=void 0!==e.bevelSegments?e.bevelSegments:3,E=e.extrudePath,M=void 0!==e.UVGenerator?e.UVGenerator:Tr;void 0!==e.amount&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),y=e.amount);var T,C=!1;if(E){var P=E.getSpacedPoints(g);C=!0,v=!1;var _=E.computeFrenetFrames(g,!1),A=new s,L=new s,R=new s}v||(x=w=b=S=0),t=(f=t.extractPoints(f)).shape;var I=f.holes;if(!Mr.isClockWise(t)){t=t.reverse();var O=0;for(T=I.length;O<T;O++){var D=I[O];Mr.isClockWise(D)&&(I[O]=D.reverse())}}var k=Mr.triangulateShape(t,I),B=t;for(O=0,T=I.length;O<T;O++)D=I[O],t=t.concat(D);var H,N,F=t.length,V=k.length;f=[];var j=0,G=B.length,U=G-1;for(H=j+1;j<G;j++,U++,H++)U===G&&(U=0),H===G&&(H=0),f[j]=l(B[j],B[U],B[H]);E=[];var z=f.concat();for(O=0,T=I.length;O<T;O++){D=I[O];var W=[];for(j=0,U=(G=D.length)-1,H=j+1;j<G;j++,U++,H++)U===G&&(U=0),H===G&&(H=0),W[j]=l(D[j],D[U],D[H]);E.push(W),z=z.concat(W)}for(U=0;U<S;U++){G=U/S;var q=b*Math.cos(G*Math.PI/2);for(H=w*Math.sin(G*Math.PI/2)+x,j=0,G=B.length;j<G;j++){var Y=n(B[j],f[j],H);c(Y.x,Y.y,-q)}for(O=0,T=I.length;O<T;O++)for(D=I[O],W=E[O],j=0,G=D.length;j<G;j++)c((Y=n(D[j],W[j],H)).x,Y.y,-q)}for(H=w+x,j=0;j<F;j++)Y=v?n(t[j],z[j],H):t[j],C?(L.copy(_.normals[0]).multiplyScalar(Y.x),A.copy(_.binormals[0]).multiplyScalar(Y.y),R.copy(P[0]).add(L).add(A),c(R.x,R.y,R.z)):c(Y.x,Y.y,0);for(G=1;G<=g;G++)for(j=0;j<F;j++)Y=v?n(t[j],z[j],H):t[j],C?(L.copy(_.normals[G]).multiplyScalar(Y.x),A.copy(_.binormals[G]).multiplyScalar(Y.y),R.copy(P[G]).add(L).add(A),c(R.x,R.y,R.z)):c(Y.x,Y.y,y/g*G);for(U=S-1;0<=U;U--){for(G=U/S,q=b*Math.cos(G*Math.PI/2),H=w*Math.sin(G*Math.PI/2)+x,j=0,G=B.length;j<G;j++)c((Y=n(B[j],f[j],H)).x,Y.y,y+q);for(O=0,T=I.length;O<T;O++)for(D=I[O],W=E[O],j=0,G=D.length;j<G;j++)Y=n(D[j],W[j],H),C?c(Y.x,Y.y+P[g-1].y,P[g-1].x+q):c(Y.x,Y.y,y+q)}!function(){var t=a.length/3;if(v){var e=0*F;for(j=0;j<V;j++)u((N=k[j])[2]+e,N[1]+e,N[0]+e);for(e=F*(g+2*S),j=0;j<V;j++)u((N=k[j])[0]+e,N[1]+e,N[2]+e)}else{for(j=0;j<V;j++)u((N=k[j])[2],N[1],N[0]);for(j=0;j<V;j++)u((N=k[j])[0]+F*g,N[1]+F*g,N[2]+F*g)}r.addGroup(t,a.length/3-t,0)}(),function(){var t=a.length/3,e=0;for(h(B,e),e+=B.length,O=0,T=I.length;O<T;O++)h(D=I[O],e),e+=D.length;r.addGroup(t,a.length/3-t,1)}()}F.call(this),this.type="ExtrudeBufferGeometry",this.parameters={shapes:t,options:e};for(var r=this,a=[],o=[],l=0,h=(t=Array.isArray(t)?t:[t]).length;l<h;l++)n(t[l]);this.addAttribute("position",new k(a,3)),this.addAttribute("uv",new k(o,2)),this.computeVertexNormals()}function gi(t,e,i){if(i.shapes=[],Array.isArray(t))for(var n=0,s=t.length;n<s;n++)i.shapes.push(t[n].uuid);else i.shapes.push(t.uuid);return void 0!==e.extrudePath&&(i.options.extrudePath=e.extrudePath.toJSON()),i}function yi(t,e){C.call(this),this.type="TextGeometry",this.parameters={text:t,parameters:e},this.fromBufferGeometry(new vi(t,e)),this.mergeVertices()}function vi(t,e){var i=(e=e||{}).font;if(!i||!i.isFont)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new C;t=i.generateShapes(t,e.size),e.depth=void 0!==e.height?e.height:50,void 0===e.bevelThickness&&(e.bevelThickness=10),void 0===e.bevelSize&&(e.bevelSize=8),void 0===e.bevelEnabled&&(e.bevelEnabled=!1),fi.call(this,t,e),this.type="TextBufferGeometry"}function bi(t,e,i,n,s,r,a){C.call(this),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:s,thetaStart:r,thetaLength:a},this.fromBufferGeometry(new wi(t,e,i,n,s,r,a)),this.mergeVertices()}function wi(t,e,i,n,r,a,o){F.call(this),this.type="SphereBufferGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:r,thetaStart:a,thetaLength:o},t=t||1,e=Math.max(3,Math.floor(e)||8),i=Math.max(2,Math.floor(i)||6),n=void 0!==n?n:0,r=void 0!==r?r:2*Math.PI,a=void 0!==a?a:0,o=void 0!==o?o:Math.PI;var l,h,c=Math.min(a+o,Math.PI),u=0,d=[],p=new s,m=new s,f=[],g=[],y=[],v=[];for(h=0;h<=i;h++){var b=[],w=h/i,x=0;for(0==h&&0==a?x=.5/e:h==i&&c==Math.PI&&(x=-.5/e),l=0;l<=e;l++){var S=l/e;p.x=-t*Math.cos(n+S*r)*Math.sin(a+w*o),p.y=t*Math.cos(a+w*o),p.z=t*Math.sin(n+S*r)*Math.sin(a+w*o),g.push(p.x,p.y,p.z),m.copy(p).normalize(),y.push(m.x,m.y,m.z),v.push(S+x,1-w),b.push(u++)}d.push(b)}for(h=0;h<i;h++)for(l=0;l<e;l++)t=d[h][l+1],n=d[h][l],r=d[h+1][l],o=d[h+1][l+1],(0!==h||0<a)&&f.push(t,n,o),(h!==i-1||c<Math.PI)&&f.push(n,r,o);this.setIndex(f),this.addAttribute("position",new k(g,3)),this.addAttribute("normal",new k(y,3)),this.addAttribute("uv",new k(v,2))}function xi(t,e,i,n,s,r){C.call(this),this.type="RingGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:i,phiSegments:n,thetaStart:s,thetaLength:r},this.fromBufferGeometry(new Si(t,e,i,n,s,r)),this.mergeVertices()}function Si(t,e,n,r,a,o){F.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:n,phiSegments:r,thetaStart:a,thetaLength:o},t=t||.5,e=e||1,a=void 0!==a?a:0,o=void 0!==o?o:2*Math.PI,n=void 0!==n?Math.max(3,n):8;var l,h,c=[],u=[],d=[],p=[],m=t,f=(e-t)/(r=void 0!==r?Math.max(1,r):1),g=new s,y=new i;for(l=0;l<=r;l++){for(h=0;h<=n;h++)t=a+h/n*o,g.x=m*Math.cos(t),g.y=m*Math.sin(t),u.push(g.x,g.y,g.z),d.push(0,0,1),y.x=(g.x/e+1)/2,y.y=(g.y/e+1)/2,p.push(y.x,y.y);m+=f}for(l=0;l<r;l++)for(e=l*(n+1),h=0;h<n;h++)a=(t=h+e)+n+1,o=t+n+2,m=t+1,c.push(t,a,m),c.push(a,o,m);this.setIndex(c),this.addAttribute("position",new k(u,3)),this.addAttribute("normal",new k(d,3)),this.addAttribute("uv",new k(p,2))}function Ei(t,e,i,n){C.call(this),this.type="LatheGeometry",this.parameters={points:t,segments:e,phiStart:i,phiLength:n},this.fromBufferGeometry(new Mi(t,e,i,n)),this.mergeVertices()}function Mi(t,e,n,r){F.call(this),this.type="LatheBufferGeometry",this.parameters={points:t,segments:e,phiStart:n,phiLength:r},e=Math.floor(e)||12,n=n||0,r=r||2*Math.PI,r=Js.clamp(r,0,2*Math.PI);var a,o=[],l=[],h=[],c=1/e,u=new s,d=new i;for(a=0;a<=e;a++){var p=n+a*c*r,m=Math.sin(p),f=Math.cos(p);for(p=0;p<=t.length-1;p++)u.x=t[p].x*m,u.y=t[p].y,u.z=t[p].x*f,l.push(u.x,u.y,u.z),d.x=a/e,d.y=p/(t.length-1),h.push(d.x,d.y)}for(a=0;a<e;a++)for(p=0;p<t.length-1;p++)c=(n=p+a*t.length)+t.length,u=n+t.length+1,d=n+1,o.push(n,c,d),o.push(c,u,d);if(this.setIndex(o),this.addAttribute("position",new k(l,3)),this.addAttribute("uv",new k(h,2)),this.computeVertexNormals(),r===2*Math.PI)for(r=this.attributes.normal.array,o=new s,l=new s,h=new s,n=e*t.length*3,p=a=0;a<t.length;a++,p+=3)o.x=r[p+0],o.y=r[p+1],o.z=r[p+2],l.x=r[n+p+0],l.y=r[n+p+1],l.z=r[n+p+2],h.addVectors(o,l).normalize(),r[p+0]=r[n+p+0]=h.x,r[p+1]=r[n+p+1]=h.y,r[p+2]=r[n+p+2]=h.z}function Ti(t,e){C.call(this),this.type="ShapeGeometry","object"==typeof e&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),e=e.curveSegments),this.parameters={shapes:t,curveSegments:e},this.fromBufferGeometry(new Ci(t,e)),this.mergeVertices()}function Ci(t,e){function i(t){var i,o=s.length/3,h=(t=t.extractPoints(e)).shape,c=t.holes;for(!1===Mr.isClockWise(h)&&(h=h.reverse()),t=0,i=c.length;t<i;t++){var u=c[t];!0===Mr.isClockWise(u)&&(c[t]=u.reverse())}var d=Mr.triangulateShape(h,c);for(t=0,i=c.length;t<i;t++)u=c[t],h=h.concat(u);for(t=0,i=h.length;t<i;t++)u=h[t],s.push(u.x,u.y,0),r.push(0,0,1),a.push(u.x,u.y);for(t=0,i=d.length;t<i;t++)h=d[t],n.push(h[0]+o,h[1]+o,h[2]+o),l+=3}F.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:t,curveSegments:e},e=e||12;var n=[],s=[],r=[],a=[],o=0,l=0;if(!1===Array.isArray(t))i(t);else for(var h=0;h<t.length;h++)i(t[h]),this.addGroup(o,l,h),o+=l,l=0;this.setIndex(n),this.addAttribute("position",new k(s,3)),this.addAttribute("normal",new k(r,3)),this.addAttribute("uv",new k(a,2))}function Pi(t,e){if(e.shapes=[],Array.isArray(t))for(var i=0,n=t.length;i<n;i++)e.shapes.push(t[i].uuid);else e.shapes.push(t.uuid);return e}function _i(t,e){F.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:e};var i=[];e=Math.cos(Js.DEG2RAD*(void 0!==e?e:1));var n=[0,0],s={},r=["a","b","c"];if(t.isBufferGeometry){var a=new C;a.fromBufferGeometry(t)}else a=t.clone();a.mergeVertices(),a.computeFaceNormals(),t=a.vertices;for(var o=0,l=(a=a.faces).length;o<l;o++)for(var h=a[o],c=0;3>c;c++){var u=h[r[c]],d=h[r[(c+1)%3]];n[0]=Math.min(u,d),n[1]=Math.max(u,d),void 0===s[u=n[0]+","+n[1]]?s[u]={index1:n[0],index2:n[1],face1:o,face2:void 0}:s[u].face2=o}for(u in s)(void 0===(n=s[u]).face2||a[n.face1].normal.dot(a[n.face2].normal)<=e)&&(r=t[n.index1],i.push(r.x,r.y,r.z),r=t[n.index2],i.push(r.x,r.y,r.z));this.addAttribute("position",new k(i,3))}function Ai(t,e,i,n,s,r,a,o){C.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:n,heightSegments:s,openEnded:r,thetaStart:a,thetaLength:o},this.fromBufferGeometry(new Li(t,e,i,n,s,r,a,o)),this.mergeVertices()}function Li(t,e,n,r,a,o,l,h){function c(n){var a,o=new i,c=new s,y=0,w=!0===n?t:e,x=!0===n?1:-1,S=g;for(a=1;a<=r;a++)p.push(0,v*x,0),m.push(0,x,0),f.push(.5,.5),g++;var E=g;for(a=0;a<=r;a++){var M=a/r*h+l,T=Math.cos(M);M=Math.sin(M),c.x=w*M,c.y=v*x,c.z=w*T,p.push(c.x,c.y,c.z),m.push(0,x,0),o.x=.5*T+.5,o.y=.5*M*x+.5,f.push(o.x,o.y),g++}for(a=0;a<r;a++)o=S+a,c=E+a,!0===n?d.push(c,c+1,o):d.push(c+1,c,o),y+=3;u.addGroup(b,y,!0===n?1:2),b+=y}F.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:n,radialSegments:r,heightSegments:a,openEnded:o,thetaStart:l,thetaLength:h};var u=this;t=void 0!==t?t:1,e=void 0!==e?e:1,n=n||1,r=Math.floor(r)||8,a=Math.floor(a)||1,o=void 0!==o&&o,l=void 0!==l?l:0,h=void 0!==h?h:2*Math.PI;var d=[],p=[],m=[],f=[],g=0,y=[],v=n/2,b=0;!function(){var i,o,c=new s,w=new s,x=0,S=(e-t)/n;for(o=0;o<=a;o++){var E=[],M=o/a,T=M*(e-t)+t;for(i=0;i<=r;i++){var C=i/r,P=C*h+l,_=Math.sin(P);P=Math.cos(P),w.x=T*_,w.y=-M*n+v,w.z=T*P,p.push(w.x,w.y,w.z),c.set(_,S,P).normalize(),m.push(c.x,c.y,c.z),f.push(C,1-M),E.push(g++)}y.push(E)}for(i=0;i<r;i++)for(o=0;o<a;o++)c=y[o+1][i],w=y[o+1][i+1],S=y[o][i+1],d.push(y[o][i],c,S),d.push(c,w,S),x+=6;u.addGroup(b,x,0),b+=x}(),!1===o&&(0<t&&c(!0),0<e&&c(!1)),this.setIndex(d),this.addAttribute("position",new k(p,3)),this.addAttribute("normal",new k(m,3)),this.addAttribute("uv",new k(f,2))}function Ri(t,e,i,n,s,r,a){Ai.call(this,0,t,e,i,n,s,r,a),this.type="ConeGeometry",this.parameters={radius:t,height:e,radialSegments:i,heightSegments:n,openEnded:s,thetaStart:r,thetaLength:a}}function Ii(t,e,i,n,s,r,a){Li.call(this,0,t,e,i,n,s,r,a),this.type="ConeBufferGeometry",this.parameters={radius:t,height:e,radialSegments:i,heightSegments:n,openEnded:s,thetaStart:r,thetaLength:a}}function Oi(t,e,i,n){C.call(this),this.type="CircleGeometry",this.parameters={radius:t,segments:e,thetaStart:i,thetaLength:n},this.fromBufferGeometry(new Di(t,e,i,n)),this.mergeVertices()}function Di(t,e,n,r){F.call(this),this.type="CircleBufferGeometry",this.parameters={radius:t,segments:e,thetaStart:n,thetaLength:r},t=t||1,e=void 0!==e?Math.max(3,e):8,n=void 0!==n?n:0,r=void 0!==r?r:2*Math.PI;var a,o=[],l=[],h=[],c=[],u=new s,d=new i;l.push(0,0,0),h.push(0,0,1),c.push(.5,.5);var p=0;for(a=3;p<=e;p++,a+=3){var m=n+p/e*r;u.x=t*Math.cos(m),u.y=t*Math.sin(m),l.push(u.x,u.y,u.z),h.push(0,0,1),d.x=(l[a]/t+1)/2,d.y=(l[a+1]/t+1)/2,c.push(d.x,d.y)}for(a=1;a<=e;a++)o.push(a,a+1,0);this.setIndex(o),this.addAttribute("position",new k(l,3)),this.addAttribute("normal",new k(h,3)),this.addAttribute("uv",new k(c,2))}function ki(t){z.call(this),this.type="ShadowMaterial",this.color=new b(0),this.transparent=!0,this.setValues(t)}function Bi(t){W.call(this,t),this.type="RawShaderMaterial"}function Hi(t){z.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new b(16777215),this.metalness=this.roughness=.5,this.lightMap=this.map=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new b(0),this.emissiveIntensity=1,this.bumpMap=this.emissiveMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new i(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.envMap=this.alphaMap=this.metalnessMap=this.roughnessMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(t)}function Ni(t){Hi.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoatRoughness=this.clearCoat=0,this.setValues(t)}function Fi(t){z.call(this),this.type="MeshPhongMaterial",this.color=new b(16777215),this.specular=new b(1118481),this.shininess=30,this.lightMap=this.map=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new b(0),this.emissiveIntensity=1,this.bumpMap=this.emissiveMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new i(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.envMap=this.alphaMap=this.specularMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(t)}function Vi(t){Fi.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(t)}function ji(t){z.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new i(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.morphNormals=this.morphTargets=this.skinning=this.lights=this.fog=!1,this.setValues(t)}function Gi(t){z.call(this),this.type="MeshLambertMaterial",this.color=new b(16777215),this.lightMap=this.map=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new b(0),this.emissiveIntensity=1,this.envMap=this.alphaMap=this.specularMap=this.emissiveMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(t)}function Ui(t){z.call(this),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new b(16777215),this.bumpMap=this.map=this.matcap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new i(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.lights=this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(t)}function zi(t){Se.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}function Wi(t,e,i,n){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new e.constructor(i),this.sampleValues=e,this.valueSize=i}function qi(t,e,i,n){Wi.call(this,t,e,i,n),this._offsetNext=this._weightNext=this._offsetPrev=this._weightPrev=-0}function Yi(t,e,i,n){Wi.call(this,t,e,i,n)}function Xi(t,e,i,n){Wi.call(this,t,e,i,n)}function Ji(t,e,i,n){if(void 0===t)throw Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=_r.convertArray(e,this.TimeBufferType),this.values=_r.convertArray(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}function Ki(t,e,i){Ji.call(this,t,e,i)}function Zi(t,e,i,n){Ji.call(this,t,e,i,n)}function Qi(t,e,i,n){Ji.call(this,t,e,i,n)}function $i(t,e,i,n){Wi.call(this,t,e,i,n)}function tn(t,e,i,n){Ji.call(this,t,e,i,n)}function en(t,e,i,n){Ji.call(this,t,e,i,n)}function nn(t,e,i,n){Ji.call(this,t,e,i,n)}function sn(t,e,i){this.name=t,this.tracks=i,this.duration=void 0!==e?e:-1,this.uuid=Js.generateUUID(),0>this.duration&&this.resetDuration()}function rn(t){if(void 0===t.type)throw Error("THREE.KeyframeTrack: track type undefined, can not parse");var e=function(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Qi;case"vector":case"vector2":case"vector3":case"vector4":return nn;case"color":return Zi;case"quaternion":return tn;case"bool":case"boolean":return Ki;case"string":return en}throw Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}(t.type);if(void 0===t.times){var i=[],n=[];_r.flattenJSON(t.keys,i,n,"value"),t.times=i,t.values=n}return void 0!==e.parse?e.parse(t):new e(t.name,t.times,t.values,t.interpolation)}function an(t,e,i){var n=this,s=!1,r=0,a=0,o=void 0;this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){a++,!1===s&&void 0!==n.onStart&&n.onStart(t,r,a),s=!0},this.itemEnd=function(t){r++,void 0!==n.onProgress&&n.onProgress(t,r,a),r===a&&(s=!1,void 0!==n.onLoad)&&n.onLoad()},this.itemError=function(t){void 0!==n.onError&&n.onError(t)},this.resolveURL=function(t){return o?o(t):t},this.setURLModifier=function(t){return o=t,this}}function on(t){this.manager=void 0!==t?t:Lr}function ln(t){this.manager=void 0!==t?t:Lr}function hn(t){this.manager=void 0!==t?t:Lr,this._parser=null}function cn(t){this.manager=void 0!==t?t:Lr,this._parser=null}function un(t){this.manager=void 0!==t?t:Lr}function dn(t){this.manager=void 0!==t?t:Lr}function pn(t){this.manager=void 0!==t?t:Lr}function mn(){this.type="Curve",this.arcLengthDivisions=200}function fn(t,e,i,n,s,r,a,o){mn.call(this),this.type="EllipseCurve",this.aX=t||0,this.aY=e||0,this.xRadius=i||1,this.yRadius=n||1,this.aStartAngle=s||0,this.aEndAngle=r||2*Math.PI,this.aClockwise=a||!1,this.aRotation=o||0}function gn(t,e,i,n,s,r){fn.call(this,t,e,i,i,n,s,r),this.type="ArcCurve"}function yn(){var t=0,e=0,i=0,n=0;return{initCatmullRom:function(s,r,a,o,l){t=r,e=s=l*(a-s),i=-3*r+3*a-2*s-(o=l*(o-r)),n=2*r-2*a+s+o},initNonuniformCatmullRom:function(s,r,a,o,l,h,c){t=r,e=s=((r-s)/l-(a-s)/(l+h)+(a-r)/h)*h,i=-3*r+3*a-2*s-(o=((a-r)/h-(o-r)/(h+c)+(o-a)/c)*h),n=2*r-2*a+s+o},calc:function(s){var r=s*s;return t+e*s+i*r+n*r*s}}}function vn(t,e,i,n){mn.call(this),this.type="CatmullRomCurve3",this.points=t||[],this.closed=e||!1,this.curveType=i||"centripetal",this.tension=n||.5}function bn(t,e,i,n,s){var r=t*t;return(2*i-2*n+(e=.5*(n-e))+(s=.5*(s-i)))*t*r+(-3*i+3*n-2*e-s)*r+e*t+i}function wn(t,e,i,n){var s=1-t;return s*s*e+2*(1-t)*t*i+t*t*n}function xn(t,e,i,n,s){var r=1-t,a=1-t;return r*r*r*e+3*a*a*t*i+3*(1-t)*t*t*n+t*t*t*s}function Sn(t,e,n,s){mn.call(this),this.type="CubicBezierCurve",this.v0=t||new i,this.v1=e||new i,this.v2=n||new i,this.v3=s||new i}function En(t,e,i,n){mn.call(this),this.type="CubicBezierCurve3",this.v0=t||new s,this.v1=e||new s,this.v2=i||new s,this.v3=n||new s}function Mn(t,e){mn.call(this),this.type="LineCurve",this.v1=t||new i,this.v2=e||new i}function Tn(t,e){mn.call(this),this.type="LineCurve3",this.v1=t||new s,this.v2=e||new s}function Cn(t,e,n){mn.call(this),this.type="QuadraticBezierCurve",this.v0=t||new i,this.v1=e||new i,this.v2=n||new i}function Pn(t,e,i){mn.call(this),this.type="QuadraticBezierCurve3",this.v0=t||new s,this.v1=e||new s,this.v2=i||new s}function _n(t){mn.call(this),this.type="SplineCurve",this.points=t||[]}function An(){mn.call(this),this.type="CurvePath",this.curves=[],this.autoClose=!1}function Ln(t){An.call(this),this.type="Path",this.currentPoint=new i,t&&this.setFromPoints(t)}function Rn(t){Ln.call(this,t),this.uuid=Js.generateUUID(),this.type="Shape",this.holes=[]}function In(t,e){T.call(this),this.type="Light",this.color=new b(t),this.intensity=void 0!==e?e:1,this.receiveShadow=void 0}function On(t,e,i){In.call(this,t,i),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(T.DefaultUp),this.updateMatrix(),this.groundColor=new b(e)}function Dn(t){this.camera=t,this.bias=0,this.radius=1,this.mapSize=new i(512,512),this.map=null,this.matrix=new g}function kn(){Dn.call(this,new re(50,1,.5,500))}function Bn(t,e,i,n,s,r){In.call(this,t,e),this.type="SpotLight",this.position.copy(T.DefaultUp),this.updateMatrix(),this.target=new T,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(t){this.intensity=t/Math.PI}}),this.distance=void 0!==i?i:0,this.angle=void 0!==n?n:Math.PI/3,this.penumbra=void 0!==s?s:0,this.decay=void 0!==r?r:1,this.shadow=new kn}function Hn(t,e,i,n){In.call(this,t,e),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(t){this.intensity=t/(4*Math.PI)}}),this.distance=void 0!==i?i:0,this.decay=void 0!==n?n:1,this.shadow=new Dn(new re(90,1,.5,500))}function Nn(t,e,i,n,s,r){se.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=void 0!==t?t:-1,this.right=void 0!==e?e:1,this.top=void 0!==i?i:1,this.bottom=void 0!==n?n:-1,this.near=void 0!==s?s:.1,this.far=void 0!==r?r:2e3,this.updateProjectionMatrix()}function Fn(){Dn.call(this,new Nn(-5,5,5,-5,.5,500))}function Vn(t,e){In.call(this,t,e),this.type="DirectionalLight",this.position.copy(T.DefaultUp),this.updateMatrix(),this.target=new T,this.shadow=new Fn}function jn(t,e){In.call(this,t,e),this.type="AmbientLight",this.castShadow=void 0}function Gn(t,e,i,n){In.call(this,t,e),this.type="RectAreaLight",this.width=void 0!==i?i:10,this.height=void 0!==n?n:10}function Un(t){this.manager=void 0!==t?t:Lr,this.textures={}}function zn(){F.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function Wn(t,e,i,n){"number"==typeof i&&(n=i,i=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),P.call(this,t,e,i),this.meshPerAttribute=n||1}function qn(t){this.manager=void 0!==t?t:Lr}function Yn(t){this.manager=void 0!==t?t:Lr,this.resourcePath=""}function Xn(t){"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.manager=void 0!==t?t:Lr,this.options=void 0}function Jn(){this.type="ShapePath",this.color=new b,this.subPaths=[],this.currentPath=null}function Kn(t){this.type="Font",this.data=t}function Zn(t){this.manager=void 0!==t?t:Lr}function Qn(){}function $n(t){this.manager=void 0!==t?t:Lr}function ts(){this.coefficients=[];for(var t=0;9>t;t++)this.coefficients.push(new s)}function es(t,e){In.call(this,void 0,e),this.sh=void 0!==t?t:new ts}function is(t,e,i){es.call(this,void 0,i),t=(new b).set(t),i=(new b).set(e),e=new s(t.r,t.g,t.b),t=new s(i.r,i.g,i.b);var n=(i=Math.sqrt(Math.PI))*Math.sqrt(.75);this.sh.coefficients[0].copy(e).add(t).multiplyScalar(i),this.sh.coefficients[1].copy(e).sub(t).multiplyScalar(n)}function ns(t,e){es.call(this,void 0,e),t=(new b).set(t),this.sh.coefficients[0].set(t.r,t.g,t.b).multiplyScalar(2*Math.sqrt(Math.PI))}function ss(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new re,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new re,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}function rs(t,e,i,n){T.call(this),this.type="CubeCamera";var r=new re(90,1,t,e);r.up.set(0,-1,0),r.lookAt(new s(1,0,0)),this.add(r);var a=new re(90,1,t,e);a.up.set(0,-1,0),a.lookAt(new s(-1,0,0)),this.add(a);var o=new re(90,1,t,e);o.up.set(0,0,1),o.lookAt(new s(0,1,0)),this.add(o);var l=new re(90,1,t,e);l.up.set(0,0,-1),l.lookAt(new s(0,-1,0)),this.add(l);var h=new re(90,1,t,e);h.up.set(0,-1,0),h.lookAt(new s(0,0,1)),this.add(h);var u=new re(90,1,t,e);u.up.set(0,-1,0),u.lookAt(new s(0,0,-1)),this.add(u),n=n||{format:1022,magFilter:1006,minFilter:1006},this.renderTarget=new c(i,i,n),this.renderTarget.texture.name="CubeCamera",this.update=function(t,e){null===this.parent&&this.updateMatrixWorld();var i=t.getRenderTarget(),n=this.renderTarget,s=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,t.setRenderTarget(n,0),t.render(e,r),t.setRenderTarget(n,1),t.render(e,a),t.setRenderTarget(n,2),t.render(e,o),t.setRenderTarget(n,3),t.render(e,l),t.setRenderTarget(n,4),t.render(e,h),n.texture.generateMipmaps=s,t.setRenderTarget(n,5),t.render(e,u),t.setRenderTarget(i)},this.clear=function(t,e,i,n){for(var s=t.getRenderTarget(),r=this.renderTarget,a=0;6>a;a++)t.setRenderTarget(r,a),t.clear(e,i,n);t.setRenderTarget(s)}}function as(t){this.autoStart=void 0===t||t,this.elapsedTime=this.oldTime=this.startTime=0,this.running=!1}function os(){T.call(this),this.type="AudioListener",this.context=Wr.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0}function ls(t){T.call(this),this.type="Audio",this.listener=t,this.context=t.context,this.gain=this.context.createGain(),this.gain.connect(t.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.offset=this.startTime=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function hs(t){ls.call(this,t),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}function cs(t,e){this.analyser=t.context.createAnalyser(),this.analyser.fftSize=void 0!==e?e:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),t.getOutput().connect(this.analyser)}function us(t,e,i){switch(this.binding=t,this.valueSize=i,t=Float64Array,e){case"quaternion":e=this._slerp;break;case"string":case"bool":t=Array,e=this._select;break;default:e=this._lerp}this.buffer=new t(4*i),this._mixBufferRegion=e,this.referenceCount=this.useCount=this.cumulativeWeight=0}function ds(t,e,i){i=i||ps.parseTrackName(e),this._targetGroup=t,this._bindings=t.subscribe_(e,i)}function ps(t,e,i){this.path=e,this.parsedPath=i||ps.parseTrackName(e),this.node=ps.findNode(t,this.parsedPath.nodeName)||t,this.rootNode=t}function ms(){this.uuid=Js.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var e=0,i=arguments.length;e!==i;++e)t[arguments[e].uuid]=e;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var n=this;this.stats={objects:{get total(){return n._objects.length},get inUse(){return this.total-n.nCachedObjects_}},get bindingsPerObject(){return n._bindings.length}}}function fs(t,e,i){this._mixer=t,this._clip=e,this._localRoot=i||null,e=(t=e.tracks).length,i=Array(e);for(var n={endingStart:2400,endingEnd:2400},s=0;s!==e;++s){var r=t[s].createInterpolant(null);i[s]=r,r.settings=n}this._interpolantSettings=n,this._interpolants=i,this._propertyBindings=Array(e),this._weightInterpolant=this._timeScaleInterpolant=this._byClipCacheIndex=this._cacheIndex=null,this.loop=2201,this._loopCount=-1,this._startTime=null,this.time=0,this._effectiveWeight=this.weight=this._effectiveTimeScale=this.timeScale=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtEnd=this.zeroSlopeAtStart=!0}function gs(t){this._root=t,this._initMemoryManager(),this.time=this._accuIndex=0,this.timeScale=1}function ys(t,e){"string"==typeof t&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),t=e),this.value=t}function vs(t,e,i){me.call(this,t,e),this.meshPerAttribute=i||1}function bs(t,e,i,n){this.ray=new q(t,e),this.near=i||0,this.far=n||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function ws(t,e){return t.distance-e.distance}function xs(t,e,i,n){if(!1!==t.visible&&(t.raycast(e,i),!0===n)){n=0;for(var s=(t=t.children).length;n<s;n++)xs(t[n],e,i,!0)}}function Ss(t,e,i){return this.radius=void 0!==t?t:1,this.phi=void 0!==e?e:0,this.theta=void 0!==i?i:0,this}function Es(t,e,i){return this.radius=void 0!==t?t:1,this.theta=void 0!==e?e:0,this.y=void 0!==i?i:0,this}function Ms(t,e){this.min=void 0!==t?t:new i(1/0,1/0),this.max=void 0!==e?e:new i(-1/0,-1/0)}function Ts(t,e){this.start=void 0!==t?t:new s,this.end=void 0!==e?e:new s}function Cs(t){T.call(this),this.material=t,this.render=function(){}}function Ps(t,e,i,n){this.object=t,this.size=void 0!==e?e:1,t=void 0!==i?i:16711680,n=void 0!==n?n:1,e=0,(i=this.object.geometry)&&i.isGeometry?e=3*i.faces.length:i&&i.isBufferGeometry&&(e=i.attributes.normal.count),i=new F,e=new k(6*e,3),i.addAttribute("position",e),Me.call(this,i,new Se({color:t,linewidth:n})),this.matrixAutoUpdate=!1,this.update()}function _s(t,e){T.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=e,t=new F,e=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(var i=0,n=1;32>i;i++,n++){var s=i/32*Math.PI*2,r=n/32*Math.PI*2;e.push(Math.cos(s),Math.sin(s),1,Math.cos(r),Math.sin(r),1)}t.addAttribute("position",new k(e,3)),e=new Se({fog:!1}),this.cone=new Me(t,e),this.add(this.cone),this.update()}function As(t){for(var e=function t(e){var i=[];e&&e.isBone&&i.push(e);for(var n=0;n<e.children.length;n++)i.push.apply(i,t(e.children[n]));return i}(t),i=new F,n=[],s=[],r=new b(0,0,1),a=new b(0,1,0),o=0;o<e.length;o++){var l=e[o];l.parent&&l.parent.isBone&&(n.push(0,0,0),n.push(0,0,0),s.push(r.r,r.g,r.b),s.push(a.r,a.g,a.b))}i.addAttribute("position",new k(n,3)),i.addAttribute("color",new k(s,3)),n=new Se({vertexColors:2,depthTest:!1,depthWrite:!1,transparent:!0}),Me.call(this,i,n),this.root=t,this.bones=e,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}function Ls(t,e,i){this.light=t,this.light.updateMatrixWorld(),this.color=i,t=new wi(e,4,2),e=new X({wireframe:!0,fog:!1}),J.call(this,t,e),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function Rs(t,e){this.type="RectAreaLightHelper",this.light=t,this.color=e,(t=new F).addAttribute("position",new k([1,1,0,-1,1,0,-1,-1,0,1,-1,0,1,1,0],3)),t.computeBoundingSphere(),e=new Se({fog:!1}),Ee.call(this,t,e),(t=new F).addAttribute("position",new k([1,1,0,-1,1,0,-1,-1,0,1,1,0,-1,-1,0,1,-1,0],3)),t.computeBoundingSphere(),this.add(new J(t,new X({side:1,fog:!1}))),this.update()}function Is(t,e,i){T.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,(t=new Ve(e)).rotateY(.5*Math.PI),this.material=new X({wireframe:!0,fog:!1}),void 0===this.color&&(this.material.vertexColors=2),e=t.getAttribute("position"),e=new Float32Array(3*e.count),t.addAttribute("color",new P(e,3)),this.add(new J(t,this.material)),this.update()}function Os(t,e){this.lightProbe=t,this.size=e,t=new W({defines:{GAMMA_OUTPUT:""},uniforms:{sh:{value:this.lightProbe.sh.coefficients},intensity:{value:this.lightProbe.intensity}},vertexShader:"varying vec3 vNormal;\nvoid main() {\n\tvNormal = normalize( normalMatrix * normal );\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"#define RECIPROCAL_PI 0.318309886\nvec3 inverseTransformDirection( in vec3 normal, in mat4 matrix ) {\n\t// matrix is assumed to be orthogonal\n\treturn normalize( ( vec4( normal, 0.0 ) * matrix ).xyz );\n}\nvec3 linearToOutput( in vec3 a ) {\n\t#ifdef GAMMA_OUTPUT\n\t\treturn pow( a, vec3( 1.0 / float( GAMMA_FACTOR ) ) );\n\t#else\n\t\treturn a;\n\t#endif\n}\n// source: https://graphics.stanford.edu/papers/envmap/envmap.pdf\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\t// normal is assumed to have unit length\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\t// band 0\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\t// band 1\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\t// band 2\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nuniform vec3 sh[ 9 ]; // sh coefficients\nuniform float intensity; // light probe intensity\nvarying vec3 vNormal;\nvoid main() {\n\tvec3 normal = normalize( vNormal );\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, sh );\n\tvec3 outgoingLight = RECIPROCAL_PI * irradiance * intensity;\n\toutgoingLight = linearToOutput( outgoingLight );\n\tgl_FragColor = vec4( outgoingLight, 1.0 );\n}"}),e=new wi(1,32,16),J.call(this,e,t),this.onBeforeRender()}function Ds(t,e,i,n){t=t||10,e=e||10,i=new b(void 0!==i?i:4473924),n=new b(void 0!==n?n:8947848);var s=e/2,r=t/e,a=t/2;t=[];for(var o=[],l=0,h=0,c=-a;l<=e;l++,c+=r){t.push(-a,0,c,a,0,c),t.push(c,0,-a,c,0,a);var u=l===s?i:n;u.toArray(o,h),h+=3,u.toArray(o,h),h+=3,u.toArray(o,h),h+=3,u.toArray(o,h),h+=3}(e=new F).addAttribute("position",new k(t,3)),e.addAttribute("color",new k(o,3)),i=new Se({vertexColors:2}),Me.call(this,e,i)}function ks(t,e,i,n,s,r){t=t||10,e=e||16,i=i||8,n=n||64,s=new b(void 0!==s?s:4473924),r=new b(void 0!==r?r:8947848);var a,o=[],l=[];for(a=0;a<=e;a++){var h=a/e*2*Math.PI,c=Math.sin(h)*t;h=Math.cos(h)*t,o.push(0,0,0),o.push(c,0,h);var u=1&a?s:r;l.push(u.r,u.g,u.b),l.push(u.r,u.g,u.b)}for(a=0;a<=i;a++){u=1&a?s:r;var d=t-t/i*a;for(e=0;e<n;e++)h=e/n*2*Math.PI,c=Math.sin(h)*d,h=Math.cos(h)*d,o.push(c,0,h),l.push(u.r,u.g,u.b),h=(e+1)/n*2*Math.PI,c=Math.sin(h)*d,h=Math.cos(h)*d,o.push(c,0,h),l.push(u.r,u.g,u.b)}(t=new F).addAttribute("position",new k(o,3)),t.addAttribute("color",new k(l,3)),o=new Se({vertexColors:2}),Me.call(this,t,o)}function Bs(t,e,i,n){this.audio=t,this.range=e||1,this.divisionsInnerAngle=i||16,this.divisionsOuterAngle=n||2,t=new F,e=new Float32Array(3*(3*(this.divisionsInnerAngle+2*this.divisionsOuterAngle)+3)),t.addAttribute("position",new P(e,3)),e=new Se({color:65280}),i=new Se({color:16776960}),Ee.call(this,t,[i,e]),this.update()}function Hs(t,e,i,n){this.object=t,this.size=void 0!==e?e:1,t=void 0!==i?i:16776960,n=void 0!==n?n:1,e=0,(i=this.object.geometry)&&i.isGeometry?e=i.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead."),i=new F,e=new k(6*e,3),i.addAttribute("position",e),Me.call(this,i,new Se({color:t,linewidth:n})),this.matrixAutoUpdate=!1,this.update()}function Ns(t,e,i){T.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,void 0===e&&(e=1),(t=new F).addAttribute("position",new k([-e,e,0,e,e,0,e,-e,0,-e,-e,0,-e,e,0],3)),e=new Se({fog:!1}),this.lightPlane=new Ee(t,e),this.add(this.lightPlane),(t=new F).addAttribute("position",new k([0,0,0,0,0,1],3)),this.targetLine=new Ee(t,e),this.add(this.targetLine),this.update()}function Fs(t){function e(t,e,n){i(t,n),i(e,n)}function i(t,e){r.push(0,0,0),a.push(e.r,e.g,e.b),void 0===o[t]&&(o[t]=[]),o[t].push(r.length/3-1)}var n=new F,s=new Se({color:16777215,vertexColors:1}),r=[],a=[],o={},l=new b(16755200),h=new b(16711680),c=new b(43775),u=new b(16777215),d=new b(3355443);e("n1","n2",l),e("n2","n4",l),e("n4","n3",l),e("n3","n1",l),e("f1","f2",l),e("f2","f4",l),e("f4","f3",l),e("f3","f1",l),e("n1","f1",l),e("n2","f2",l),e("n3","f3",l),e("n4","f4",l),e("p","n1",h),e("p","n2",h),e("p","n3",h),e("p","n4",h),e("u1","u2",c),e("u2","u3",c),e("u3","u1",c),e("c","t",u),e("p","c",d),e("cn1","cn2",d),e("cn3","cn4",d),e("cf1","cf2",d),e("cf3","cf4",d),n.addAttribute("position",new k(r,3)),n.addAttribute("color",new k(a,3)),Me.call(this,n,s),this.camera=t,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=o,this.update()}function Vs(t,e){this.object=t,void 0===e&&(e=16776960),t=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);var i=new Float32Array(24),n=new F;n.setIndex(new P(t,1)),n.addAttribute("position",new P(i,3)),Me.call(this,n,new Se({color:e})),this.matrixAutoUpdate=!1,this.update()}function js(t,e){this.type="Box3Helper",this.box=t,t=void 0!==e?e:16776960,e=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);var i=new F;i.setIndex(new P(e,1)),i.addAttribute("position",new k([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),Me.call(this,i,new Se({color:t})),this.geometry.computeBoundingSphere()}function Gs(t,e,i){this.type="PlaneHelper",this.plane=t,this.size=void 0===e?1:e,t=void 0!==i?i:16776960,(e=new F).addAttribute("position",new k([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),e.computeBoundingSphere(),Ee.call(this,e,new Se({color:t})),(e=new F).addAttribute("position",new k([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),e.computeBoundingSphere(),this.add(new J(e,new X({color:t,opacity:.2,transparent:!0,depthWrite:!1})))}function Us(t,e,i,n,r,a){T.call(this),void 0===t&&(t=new s(0,0,1)),void 0===e&&(e=new s(0,0,0)),void 0===i&&(i=1),void 0===n&&(n=16776960),void 0===r&&(r=.2*i),void 0===a&&(a=.2*r),void 0===Ur&&((Ur=new F).addAttribute("position",new k([0,0,0,0,1,0],3)),(zr=new Li(0,.5,1,5,1)).translate(0,-.5,0)),this.position.copy(e),this.line=new Ee(Ur,new Se({color:n})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new J(zr,new X({color:n})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(t),this.setLength(i,r,a)}function zs(t){var e=[0,0,0,t=t||1,0,0,0,0,0,0,t,0,0,0,0,0,0,t];(t=new F).addAttribute("position",new k(e,3)),t.addAttribute("color",new k([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3)),e=new Se({vertexColors:2}),Me.call(this,t,e)}function Ws(t){console.warn("THREE.ClosedSplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),vn.call(this,t),this.type="catmullrom",this.closed=!0}function qs(t){console.warn("THREE.SplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),vn.call(this,t),this.type="catmullrom"}function Ys(t){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),vn.call(this,t),this.type="catmullrom"}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t}),void 0===Math.sign&&(Math.sign=function(t){return 0>t?-1:0<t?1:+t}),!1=="name"in Function.prototype&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(void 0!==n&&null!==n)for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e}),Object.assign(e.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){void 0!==this._listeners&&(void 0!==(t=this._listeners[t])&&(-1!==(e=t.indexOf(e))&&t.splice(e,1)))},dispatchEvent:function(t){if(void 0!==this._listeners){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=0,n=(e=e.slice(0)).length;i<n;i++)e[i].call(this,t)}}}});var Xs,Js={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){for(var t=[],e=0;256>e;e++)t[e]=(16>e?"0":"")+e.toString(16);return function(){var e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]+"-"+t[255&i]+t[i>>8&255]+"-"+t[i>>16&15|64]+t[i>>24&255]+"-"+t[63&n|128]+t[n>>8&255]+"-"+t[n>>16&255]+t[n>>24&255]+t[255&s]+t[s>>8&255]+t[s>>16&255]+t[s>>24&255]).toUpperCase()}}(),clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,i,n,s){return n+(t-e)*(s-n)/(i-e)},lerp:function(t,e,i){return(1-i)*t+i*e},smoothstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*(3-2*t)},smootherstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},degToRad:function(t){return t*Js.DEG2RAD},radToDeg:function(t){return t*Js.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}};Object.defineProperties(i.prototype,{width:{get:function(){return this.x},set:function(t){this.x=t}},height:{get:function(){return this.y},set:function(t){this.y=t}}}),Object.assign(i.prototype,{isVector2:!0,set:function(t,e){return this.x=t,this.y=e,this},setScalar:function(t){return this.y=this.x=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(t){return this.x=t.x,this.y=t.y,this},add:function(t,e){return void 0!==e?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this)},addScalar:function(t){return this.x+=t,this.y+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this},sub:function(t,e){return void 0!==e?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this)},subScalar:function(t){return this.x-=t,this.y-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},multiply:function(t){return this.x*=t.x,this.y*=t.y,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this},divide:function(t){return this.x/=t.x,this.y/=t.y,this},divideScalar:function(t){return this.multiplyScalar(1/t)},applyMatrix3:function(t){var e=this.x,i=this.y;return t=t.elements,this.x=t[0]*e+t[3]*i+t[6],this.y=t[1]*e+t[4]*i+t[7],this},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this},clampScalar:function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this},clampLength:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=0>this.x?Math.ceil(this.x):Math.floor(this.x),this.y=0>this.y?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(t){return this.x*t.x+this.y*t.y},cross:function(t){return this.x*t.y-this.y*t.x},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){var t=Math.atan2(this.y,this.x);return 0>t&&(t+=2*Math.PI),t},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x;return e*e+(t=this.y-t.y)*t},manhattanDistanceTo:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this},lerpVectors:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)},equals:function(t){return t.x===this.x&&t.y===this.y},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t},fromBufferAttribute:function(t,e,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this},rotateAround:function(t,e){var i=Math.cos(e);e=Math.sin(e);var n=this.x-t.x,s=this.y-t.y;return this.x=n*i-s*e+t.x,this.y=n*e+s*i+t.y,this}}),Object.assign(n,{slerp:function(t,e,i,n){return i.copy(t).slerp(e,n)},slerpFlat:function(t,e,i,n,s,r,a){var o=i[n+0],l=i[n+1],h=i[n+2];i=i[n+3],n=s[r+0];var c=s[r+1],u=s[r+2];if(i!==(s=s[r+3])||o!==n||l!==c||h!==u){r=1-a;var d=o*n+l*c+h*u+i*s,p=0<=d?1:-1,m=1-d*d;m>Number.EPSILON&&(m=Math.sqrt(m),d=Math.atan2(m,d*p),r=Math.sin(r*d)/m,a=Math.sin(a*d)/m),o=o*r+n*(p*=a),l=l*r+c*p,h=h*r+u*p,i=i*r+s*p,r===1-a&&(o*=a=1/Math.sqrt(o*o+l*l+h*h+i*i),l*=a,h*=a,i*=a)}t[e]=o,t[e+1]=l,t[e+2]=h,t[e+3]=i}}),Object.defineProperties(n.prototype,{x:{get:function(){return this._x},set:function(t){this._x=t,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(t){this._y=t,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(t){this._z=t,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(t){this._w=t,this.onChangeCallback()}}}),Object.assign(n.prototype,{isQuaternion:!0,set:function(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this.onChangeCallback(),this},setFromEuler:function(t,e){if(!t||!t.isEuler)throw Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var i=t._x,n=t._y,s=t._z;t=t.order;var r=Math.cos,a=Math.sin,o=r(i/2),l=r(n/2);return r=r(s/2),i=a(i/2),n=a(n/2),s=a(s/2),"XYZ"===t?(this._x=i*l*r+o*n*s,this._y=o*n*r-i*l*s,this._z=o*l*s+i*n*r,this._w=o*l*r-i*n*s):"YXZ"===t?(this._x=i*l*r+o*n*s,this._y=o*n*r-i*l*s,this._z=o*l*s-i*n*r,this._w=o*l*r+i*n*s):"ZXY"===t?(this._x=i*l*r-o*n*s,this._y=o*n*r+i*l*s,this._z=o*l*s+i*n*r,this._w=o*l*r-i*n*s):"ZYX"===t?(this._x=i*l*r-o*n*s,this._y=o*n*r+i*l*s,this._z=o*l*s-i*n*r,this._w=o*l*r+i*n*s):"YZX"===t?(this._x=i*l*r+o*n*s,this._y=o*n*r+i*l*s,this._z=o*l*s-i*n*r,this._w=o*l*r-i*n*s):"XZY"===t&&(this._x=i*l*r-o*n*s,this._y=o*n*r-i*l*s,this._z=o*l*s+i*n*r,this._w=o*l*r+i*n*s),!1!==e&&this.onChangeCallback(),this},setFromAxisAngle:function(t,e){e/=2;var i=Math.sin(e);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(e),this.onChangeCallback(),this},setFromRotationMatrix:function(t){var e=t.elements,i=e[0];t=e[4];var n=e[8],s=e[1],r=e[5],a=e[9],o=e[2],l=e[6],h=i+r+(e=e[10]);return 0<h?(i=.5/Math.sqrt(h+1),this._w=.25/i,this._x=(l-a)*i,this._y=(n-o)*i,this._z=(s-t)*i):i>r&&i>e?(i=2*Math.sqrt(1+i-r-e),this._w=(l-a)/i,this._x=.25*i,this._y=(t+s)/i,this._z=(n+o)/i):r>e?(i=2*Math.sqrt(1+r-i-e),this._w=(n-o)/i,this._x=(t+s)/i,this._y=.25*i,this._z=(a+l)/i):(i=2*Math.sqrt(1+e-i-r),this._w=(s-t)/i,this._x=(n+o)/i,this._y=(a+l)/i,this._z=.25*i),this.onChangeCallback(),this},setFromUnitVectors:function(t,e){var i=t.dot(e)+1;return 1e-6>i?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0):(this._x=0,this._y=-t.z,this._z=t.y)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x),this._w=i,this.normalize()},angleTo:function(t){return 2*Math.acos(Math.abs(Js.clamp(this.dot(t),-1,1)))},rotateTowards:function(t,e){var i=this.angleTo(t);return 0===i?this:(this.slerp(t,Math.min(1,e/i)),this)},inverse:function(){return this.conjugate()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var t=this.length();return 0===t?(this._z=this._y=this._x=0,this._w=1):(t=1/t,this._x*=t,this._y*=t,this._z*=t,this._w*=t),this.onChangeCallback(),this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,e){var i=t._x,n=t._y,s=t._z;t=t._w;var r=e._x,a=e._y,o=e._z;return e=e._w,this._x=i*e+t*r+n*o-s*a,this._y=n*e+t*a+s*r-i*o,this._z=s*e+t*o+i*a-n*r,this._w=t*e-i*r-n*a-s*o,this.onChangeCallback(),this},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this._x,n=this._y,s=this._z,r=this._w,a=r*t._w+i*t._x+n*t._y+s*t._z;if(0>a?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),1<=a)return this._w=r,this._x=i,this._y=n,this._z=s,this;if((t=1-a*a)<=Number.EPSILON)return a=1-e,this._w=a*r+e*this._w,this._x=a*i+e*this._x,this._y=a*n+e*this._y,this._z=a*s+e*this._z,this.normalize();t=Math.sqrt(t);var o=Math.atan2(t,a);return a=Math.sin((1-e)*o)/t,e=Math.sin(e*o)/t,this._w=r*a+this._w*e,this._x=i*a+this._x*e,this._y=n*a+this._y*e,this._z=s*a+this._z*e,this.onChangeCallback(),this},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w},fromArray:function(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this.onChangeCallback(),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){}}),Object.assign(s.prototype,{isVector3:!0,set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},setScalar:function(t){return this.z=this.y=this.x=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},sub:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},multiply:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiplyVectors:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},applyEuler:(Xs=new n,function(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Xs.setFromEuler(t))}),applyAxisAngle:function(){var t=new n;return function(e,i){return this.applyQuaternion(t.setFromAxisAngle(e,i))}}(),applyMatrix3:function(t){var e=this.x,i=this.y,n=this.z;return t=t.elements,this.x=t[0]*e+t[3]*i+t[6]*n,this.y=t[1]*e+t[4]*i+t[7]*n,this.z=t[2]*e+t[5]*i+t[8]*n,this},applyMatrix4:function(t){var e=this.x,i=this.y,n=this.z,s=1/((t=t.elements)[3]*e+t[7]*i+t[11]*n+t[15]);return this.x=(t[0]*e+t[4]*i+t[8]*n+t[12])*s,this.y=(t[1]*e+t[5]*i+t[9]*n+t[13])*s,this.z=(t[2]*e+t[6]*i+t[10]*n+t[14])*s,this},applyQuaternion:function(t){var e=this.x,i=this.y,n=this.z,s=t.x,r=t.y,a=t.z,o=(t=t.w)*e+r*n-a*i,l=t*i+a*e-s*n,h=t*n+s*i-r*e;return e=-s*e-r*i-a*n,this.x=o*t+e*-s+l*-a-h*-r,this.y=l*t+e*-r+h*-s-o*-a,this.z=h*t+e*-a+o*-r-l*-s,this},project:function(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)},unproject:function(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)},transformDirection:function(t){var e=this.x,i=this.y,n=this.z;return t=t.elements,this.x=t[0]*e+t[4]*i+t[8]*n,this.y=t[1]*e+t[5]*i+t[9]*n,this.z=t[2]*e+t[6]*i+t[10]*n,this.normalize()},divide:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},divideScalar:function(t){return this.multiplyScalar(1/t)},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this},clampScalar:function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this},clampLength:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=0>this.x?Math.ceil(this.x):Math.floor(this.x),this.y=0>this.y?Math.ceil(this.y):Math.floor(this.y),this.z=0>this.z?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},lerpVectors:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)},cross:function(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)},crossVectors:function(t,e){var i=t.x,n=t.y;t=t.z;var s=e.x,r=e.y;return e=e.z,this.x=n*e-t*r,this.y=t*s-i*e,this.z=i*r-n*s,this},projectOnVector:function(t){var e=t.dot(this)/t.lengthSq();return this.copy(t).multiplyScalar(e)},projectOnPlane:function(){var t=new s;return function(e){return t.copy(this).projectOnVector(e),this.sub(t)}}(),reflect:function(){var t=new s;return function(e){return this.sub(t.copy(e).multiplyScalar(2*this.dot(e)))}}(),angleTo:function(t){return t=this.dot(t)/Math.sqrt(this.lengthSq()*t.lengthSq()),Math.acos(Js.clamp(t,-1,1))},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i+(t=this.z-t.z)*t},manhattanDistanceTo:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)},setFromSpherical:function(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)},setFromSphericalCoords:function(t,e,i){var n=Math.sin(e)*t;return this.x=n*Math.sin(i),this.y=Math.cos(e)*t,this.z=n*Math.cos(i),this},setFromCylindrical:function(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)},setFromCylindricalCoords:function(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this},setFromMatrixPosition:function(t){return t=t.elements,this.x=t[12],this.y=t[13],this.z=t[14],this},setFromMatrixScale:function(t){var e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length();return t=this.setFromMatrixColumn(t,2).length(),this.x=e,this.y=i,this.z=t,this},setFromMatrixColumn:function(t,e){return this.fromArray(t.elements,4*e)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t},fromBufferAttribute:function(t,e,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}}),Object.assign(r.prototype,{isMatrix3:!0,set:function(t,e,i,n,s,r,a,o,l){var h=this.elements;return h[0]=t,h[1]=n,h[2]=a,h[3]=e,h[4]=s,h[5]=o,h[6]=i,h[7]=r,h[8]=l,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t){var e=this.elements;return t=t.elements,e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this},setFromMatrix4:function(t){return t=t.elements,this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToBufferAttribute:function(){var t=new s;return function(e){for(var i=0,n=e.count;i<n;i++)t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.applyMatrix3(this),e.setXYZ(i,t.x,t.y,t.z);return e}}(),multiply:function(t){return this.multiplyMatrices(this,t)},premultiply:function(t){return this.multiplyMatrices(t,this)},multiplyMatrices:function(t,e){var i=t.elements,n=e.elements;e=this.elements,t=i[0];var s=i[3],r=i[6],a=i[1],o=i[4],l=i[7],h=i[2],c=i[5];i=i[8];var u=n[0],d=n[3],p=n[6],m=n[1],f=n[4],g=n[7],y=n[2],v=n[5];return n=n[8],e[0]=t*u+s*m+r*y,e[3]=t*d+s*f+r*v,e[6]=t*p+s*g+r*n,e[1]=a*u+o*m+l*y,e[4]=a*d+o*f+l*v,e[7]=a*p+o*g+l*n,e[2]=h*u+c*m+i*y,e[5]=h*d+c*f+i*v,e[8]=h*p+c*g+i*n,this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this},determinant:function(){var t=this.elements,e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],a=t[5],o=t[6],l=t[7];return e*r*(t=t[8])-e*a*l-i*s*t+i*a*o+n*s*l-n*r*o},getInverse:function(t,e){t&&t.isMatrix4&&console.error("THREE.Matrix3: .getInverse() no longer takes a Matrix4 argument.");var i=t.elements;t=this.elements;var n=i[0],s=i[1],r=i[2],a=i[3],o=i[4],l=i[5],h=i[6],c=i[7],u=(i=i[8])*o-l*c,d=l*h-i*a,p=c*a-o*h,m=n*u+s*d+r*p;if(0===m){if(!0===e)throw Error("THREE.Matrix3: .getInverse() can't invert matrix, determinant is 0");return console.warn("THREE.Matrix3: .getInverse() can't invert matrix, determinant is 0"),this.identity()}return e=1/m,t[0]=u*e,t[1]=(r*c-i*s)*e,t[2]=(l*s-r*o)*e,t[3]=d*e,t[4]=(i*n-r*h)*e,t[5]=(r*a-l*n)*e,t[6]=p*e,t[7]=(s*h-c*n)*e,t[8]=(o*n-s*a)*e,this},transpose:function(){var t=this.elements,e=t[1];return t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(t){return this.setFromMatrix4(t).getInverse(this).transpose()},transposeIntoArray:function(t){var e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this},setUvTransform:function(t,e,i,n,s,r,a){var o=Math.cos(s);s=Math.sin(s),this.set(i*o,i*s,-i*(o*r+s*a)+r+t,-n*s,n*o,-n*(-s*r+o*a)+a+e,0,0,1)},scale:function(t,e){var i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=e,i[4]*=e,i[7]*=e,this},rotate:function(t){var e=Math.cos(t);t=Math.sin(t);var i=this.elements,n=i[0],s=i[3],r=i[6],a=i[1],o=i[4],l=i[7];return i[0]=e*n+t*a,i[3]=e*s+t*o,i[6]=e*r+t*l,i[1]=-t*n+e*a,i[4]=-t*s+e*o,i[7]=-t*r+e*l,this},translate:function(t,e){var i=this.elements;return i[0]+=t*i[2],i[3]+=t*i[5],i[6]+=t*i[8],i[1]+=e*i[2],i[4]+=e*i[5],i[7]+=e*i[8],this},equals:function(t){var e=this.elements;t=t.elements;for(var i=0;9>i;i++)if(e[i]!==t[i])return!1;return!0},fromArray:function(t,e){void 0===e&&(e=0);for(var i=0;9>i;i++)this.elements[i]=t[i+e];return this},toArray:function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}});var Ks,Zs={getDataURL:function(t){if("undefined"==typeof HTMLCanvasElement)return t.src;if(!(t instanceof HTMLCanvasElement)){void 0===Ks&&(Ks=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),Ks.width=t.width,Ks.height=t.height;var e=Ks.getContext("2d");t instanceof ImageData?e.putImageData(t,0,0):e.drawImage(t,0,0,t.width,t.height),t=Ks}return 2048<t.width||2048<t.height?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}},Qs=0;a.DEFAULT_IMAGE=void 0,a.DEFAULT_MAPPING=300,a.prototype=Object.assign(Object.create(e.prototype),{constructor:a,isTexture:!0,updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.name=t.name,this.image=t.image,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this},toJSON:function(t){var e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];var i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){var n=this.image;if(void 0===n.uuid&&(n.uuid=Js.generateUUID()),!e&&void 0===t.images[n.uuid]){if(Array.isArray(n))for(var s=[],r=0,a=n.length;r<a;r++)s.push(Zs.getDataURL(n[r]));else s=Zs.getDataURL(n);t.images[n.uuid]={uuid:n.uuid,url:s}}i.image=n.uuid}return e||(t.textures[this.uuid]=i),i},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),0>t.x||1<t.x)switch(this.wrapS){case 1e3:t.x-=Math.floor(t.x);break;case 1001:t.x=0>t.x?0:1;break;case 1002:t.x=1===Math.abs(Math.floor(t.x)%2)?Math.ceil(t.x)-t.x:t.x-Math.floor(t.x)}if(0>t.y||1<t.y)switch(this.wrapT){case 1e3:t.y-=Math.floor(t.y);break;case 1001:t.y=0>t.y?0:1;break;case 1002:t.y=1===Math.abs(Math.floor(t.y)%2)?Math.ceil(t.y)-t.y:t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}}),Object.defineProperty(a.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(o.prototype,{isVector4:!0,set:function(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this},setScalar:function(t){return this.w=this.z=this.y=this.x=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setW:function(t){return this.w=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this},add:function(t,e){return void 0!==e?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this},sub:function(t,e){return void 0!==e?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},applyMatrix4:function(t){var e=this.x,i=this.y,n=this.z,s=this.w;return t=t.elements,this.x=t[0]*e+t[4]*i+t[8]*n+t[12]*s,this.y=t[1]*e+t[5]*i+t[9]*n+t[13]*s,this.z=t[2]*e+t[6]*i+t[10]*n+t[14]*s,this.w=t[3]*e+t[7]*i+t[11]*n+t[15]*s,this},divideScalar:function(t){return this.multiplyScalar(1/t)},setAxisAngleFromQuaternion:function(t){this.w=2*Math.acos(t.w);var e=Math.sqrt(1-t.w*t.w);return 1e-4>e?(this.x=1,this.z=this.y=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this},setAxisAngleFromRotationMatrix:function(t){var e=(t=t.elements)[0],i=t[4],n=t[8],s=t[1],r=t[5],a=t[9],o=t[2],l=t[6],h=t[10];return.01>Math.abs(i-s)&&.01>Math.abs(n-o)&&.01>Math.abs(a-l)?.1>Math.abs(i+s)&&.1>Math.abs(n+o)&&.1>Math.abs(a+l)&&.1>Math.abs(e+r+h-3)?(this.set(1,0,0,0),this):(t=Math.PI,h=(h+1)/2,i=(i+s)/4,n=(n+o)/4,a=(a+l)/4,(e=(e+1)/2)>(r=(r+1)/2)&&e>h?.01>e?(l=0,i=o=.707106781):(o=i/(l=Math.sqrt(e)),i=n/l):r>h?.01>r?(l=.707106781,o=0,i=.707106781):(l=i/(o=Math.sqrt(r)),i=a/o):.01>h?(o=l=.707106781,i=0):(l=n/(i=Math.sqrt(h)),o=a/i),this.set(l,o,i,t),this):(t=Math.sqrt((l-a)*(l-a)+(n-o)*(n-o)+(s-i)*(s-i)),.001>Math.abs(t)&&(t=1),this.x=(l-a)/t,this.y=(n-o)/t,this.z=(s-i)/t,this.w=Math.acos((e+r+h-1)/2),this)},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this},clampScalar:function(){var t,e;return function(i,n){return void 0===t&&(t=new o,e=new o),t.set(i,i,i,i),e.set(n,n,n,n),this.clamp(t,e)}}(),clampLength:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=0>this.x?Math.ceil(this.x):Math.floor(this.x),this.y=0>this.y?Math.ceil(this.y):Math.floor(this.y),this.z=0>this.z?Math.ceil(this.z):Math.floor(this.z),this.w=0>this.w?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this},lerpVectors:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t},fromBufferAttribute:function(t,e,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}}),l.prototype=Object.assign(Object.create(e.prototype),{constructor:l,isWebGLRenderTarget:!0,setSize:function(t,e){this.width===t&&this.height===e||(this.width=t,this.height=e,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.width=t.width,this.height=t.height,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.depthTexture=t.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),h.prototype=Object.assign(Object.create(l.prototype),{constructor:h,isWebGLMultisampleRenderTarget:!0,copy:function(t){return l.prototype.copy.call(this,t),this.samples=t.samples,this}}),c.prototype=Object.create(l.prototype),c.prototype.constructor=c,c.prototype.isWebGLRenderTargetCube=!0,u.prototype=Object.create(a.prototype),u.prototype.constructor=u,u.prototype.isDataTexture=!0,Object.assign(d.prototype,{isBox3:!0,set:function(t,e){return this.min.copy(t),this.max.copy(e),this},setFromArray:function(t){for(var e=1/0,i=1/0,n=1/0,s=-1/0,r=-1/0,a=-1/0,o=0,l=t.length;o<l;o+=3){var h=t[o],c=t[o+1],u=t[o+2];h<e&&(e=h),c<i&&(i=c),u<n&&(n=u),h>s&&(s=h),c>r&&(r=c),u>a&&(a=u)}return this.min.set(e,i,n),this.max.set(s,r,a),this},setFromBufferAttribute:function(t){for(var e=1/0,i=1/0,n=1/0,s=-1/0,r=-1/0,a=-1/0,o=0,l=t.count;o<l;o++){var h=t.getX(o),c=t.getY(o),u=t.getZ(o);h<e&&(e=h),c<i&&(i=c),u<n&&(n=u),h>s&&(s=h),c>r&&(r=c),u>a&&(a=u)}return this.min.set(e,i,n),this.max.set(s,r,a),this},setFromPoints:function(t){this.makeEmpty();for(var e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this},setFromCenterAndSize:function(){var t=new s;return function(e,i){return i=t.copy(i).multiplyScalar(.5),this.min.copy(e).sub(i),this.max.copy(e).add(i),this}}(),setFromObject:function(t){return this.makeEmpty(),this.expandByObject(t)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.min.copy(t.min),this.max.copy(t.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(t){return void 0===t&&(console.warn("THREE.Box3: .getCenter() target is now required"),t=new s),this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(t){return void 0===t&&(console.warn("THREE.Box3: .getSize() target is now required"),t=new s),this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(t){return this.min.min(t),this.max.max(t),this},expandByVector:function(t){return this.min.sub(t),this.max.add(t),this},expandByScalar:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this},expandByObject:function(){function t(t){var s=t.geometry;if(void 0!==s)if(s.isGeometry)for(s=s.vertices,i=0,n=s.length;i<n;i++)r.copy(s[i]),r.applyMatrix4(t.matrixWorld),e.expandByPoint(r);else if(s.isBufferGeometry&&void 0!==(s=s.attributes.position))for(i=0,n=s.count;i<n;i++)r.fromBufferAttribute(s,i).applyMatrix4(t.matrixWorld),e.expandByPoint(r)}var e,i,n,r=new s;return function(i){return e=this,i.updateMatrixWorld(!0),i.traverse(t),this}}(),containsPoint:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)},containsBox:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z},getParameter:function(t,e){return void 0===e&&(console.warn("THREE.Box3: .getParameter() target is now required"),e=new s),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)},intersectsSphere:function(){var t=new s;return function(e){return this.clampPoint(e.center,t),t.distanceToSquared(e.center)<=e.radius*e.radius}}(),intersectsPlane:function(t){if(0<t.normal.x)var e=t.normal.x*this.min.x,i=t.normal.x*this.max.x;else e=t.normal.x*this.max.x,i=t.normal.x*this.min.x;return 0<t.normal.y?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),0<t.normal.z?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant},intersectsTriangle:function(){function t(t){var s,r=0;for(s=t.length-3;r<=s;r+=3){l.fromArray(t,r);var a=c.x*Math.abs(l.x)+c.y*Math.abs(l.y)+c.z*Math.abs(l.z),o=e.dot(l),h=i.dot(l),u=n.dot(l);if(Math.max(-Math.max(o,h,u),Math.min(o,h,u))>a)return!1}return!0}var e=new s,i=new s,n=new s,r=new s,a=new s,o=new s,l=new s,h=new s,c=new s,u=new s;return function(s){return!this.isEmpty()&&(this.getCenter(h),c.subVectors(this.max,h),e.subVectors(s.a,h),i.subVectors(s.b,h),n.subVectors(s.c,h),r.subVectors(i,e),a.subVectors(n,i),o.subVectors(e,n),!!t(s=[0,-r.z,r.y,0,-a.z,a.y,0,-o.z,o.y,r.z,0,-r.x,a.z,0,-a.x,o.z,0,-o.x,-r.y,r.x,0,-a.y,a.x,0,-o.y,o.x,0])&&(!!t(s=[1,0,0,0,1,0,0,0,1])&&(u.crossVectors(r,a),t(s=[u.x,u.y,u.z]))))}}(),clampPoint:function(t,e){return void 0===e&&(console.warn("THREE.Box3: .clampPoint() target is now required"),e=new s),e.copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new s;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),getBoundingSphere:function(){var t=new s;return function(e){return void 0===e&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(e.center),e.radius=.5*this.getSize(t).length(),e}}(),intersect:function(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this},union:function(t){return this.min.min(t.min),this.max.max(t.max),this},applyMatrix4:function(){var t=[new s,new s,new s,new s,new s,new s,new s,new s];return function(e){return this.isEmpty()?this:(t[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),t[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),t[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),t[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),t[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),t[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),t[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),t[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(t),this)}}(),translate:function(t){return this.min.add(t),this.max.add(t),this},equals:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}),Object.assign(p.prototype,{set:function(t,e){return this.center.copy(t),this.radius=e,this},setFromPoints:function(){var t=new d;return function(e,i){var n=this.center;void 0!==i?n.copy(i):t.setFromPoints(e).getCenter(n);for(var s=i=0,r=e.length;s<r;s++)i=Math.max(i,n.distanceToSquared(e[s]));return this.radius=Math.sqrt(i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.center.copy(t.center),this.radius=t.radius,this},empty:function(){return 0>=this.radius},containsPoint:function(t){return t.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(t){return t.distanceTo(this.center)-this.radius},intersectsSphere:function(t){var e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e},intersectsBox:function(t){return t.intersectsSphere(this)},intersectsPlane:function(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius},clampPoint:function(t,e){var i=this.center.distanceToSquared(t);return void 0===e&&(console.warn("THREE.Sphere: .clampPoint() target is now required"),e=new s),e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e},getBoundingBox:function(t){return void 0===t&&(console.warn("THREE.Sphere: .getBoundingBox() target is now required"),t=new d),t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(t){return this.center.applyMatrix4(t),this.radius*=t.getMaxScaleOnAxis(),this},translate:function(t){return this.center.add(t),this},equals:function(t){return t.center.equals(this.center)&&t.radius===this.radius}}),Object.assign(m.prototype,{set:function(t,e){return this.normal.copy(t),this.constant=e,this},setComponents:function(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this},setFromNormalAndCoplanarPoint:function(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this},setFromCoplanarPoints:function(){var t=new s,e=new s;return function(i,n,s){return n=t.subVectors(s,n).cross(e.subVectors(i,n)).normalize(),this.setFromNormalAndCoplanarPoint(n,i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.normal.copy(t.normal),this.constant=t.constant,this},normalize:function(){var t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(t){return this.normal.dot(t)+this.constant},distanceToSphere:function(t){return this.distanceToPoint(t.center)-t.radius},projectPoint:function(t,e){return void 0===e&&(console.warn("THREE.Plane: .projectPoint() target is now required"),e=new s),e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)},intersectLine:function(){var t=new s;return function(e,i){void 0===i&&(console.warn("THREE.Plane: .intersectLine() target is now required"),i=new s);var n=e.delta(t),r=this.normal.dot(n);if(0===r){if(0===this.distanceToPoint(e.start))return i.copy(e.start)}else if(!(0>(r=-(e.start.dot(this.normal)+this.constant)/r)||1<r))return i.copy(n).multiplyScalar(r).add(e.start)}}(),intersectsLine:function(t){var e=this.distanceToPoint(t.start);return t=this.distanceToPoint(t.end),0>e&&0<t||0>t&&0<e},intersectsBox:function(t){return t.intersectsPlane(this)},intersectsSphere:function(t){return t.intersectsPlane(this)},coplanarPoint:function(t){return void 0===t&&(console.warn("THREE.Plane: .coplanarPoint() target is now required"),t=new s),t.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var t=new s,e=new r;return function(i,n){return n=n||e.getNormalMatrix(i),i=this.coplanarPoint(t).applyMatrix4(i),n=this.normal.applyMatrix3(n).normalize(),this.constant=-i.dot(n),this}}(),translate:function(t){return this.constant-=t.dot(this.normal),this},equals:function(t){return t.normal.equals(this.normal)&&t.constant===this.constant}}),Object.assign(f.prototype,{set:function(t,e,i,n,s,r){var a=this.planes;return a[0].copy(t),a[1].copy(e),a[2].copy(i),a[3].copy(n),a[4].copy(s),a[5].copy(r),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){for(var e=this.planes,i=0;6>i;i++)e[i].copy(t.planes[i]);return this},setFromMatrix:function(t){var e=this.planes,i=t.elements;t=i[0];var n=i[1],s=i[2],r=i[3],a=i[4],o=i[5],l=i[6],h=i[7],c=i[8],u=i[9],d=i[10],p=i[11],m=i[12],f=i[13],g=i[14];return i=i[15],e[0].setComponents(r-t,h-a,p-c,i-m).normalize(),e[1].setComponents(r+t,h+a,p+c,i+m).normalize(),e[2].setComponents(r+n,h+o,p+u,i+f).normalize(),e[3].setComponents(r-n,h-o,p-u,i-f).normalize(),e[4].setComponents(r-s,h-l,p-d,i-g).normalize(),e[5].setComponents(r+s,h+l,p+d,i+g).normalize(),this},intersectsObject:function(){var t=new p;return function(e){var i=e.geometry;return null===i.boundingSphere&&i.computeBoundingSphere(),t.copy(i.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(t)}}(),intersectsSprite:function(){var t=new p;return function(e){return t.center.set(0,0,0),t.radius=.7071067811865476,t.applyMatrix4(e.matrixWorld),this.intersectsSphere(t)}}(),intersectsSphere:function(t){var e=this.planes,i=t.center;t=-t.radius;for(var n=0;6>n;n++)if(e[n].distanceToPoint(i)<t)return!1;return!0},intersectsBox:function(){var t=new s;return function(e){for(var i=this.planes,n=0;6>n;n++){var s=i[n];if(t.x=0<s.normal.x?e.max.x:e.min.x,t.y=0<s.normal.y?e.max.y:e.min.y,t.z=0<s.normal.z?e.max.z:e.min.z,0>s.distanceToPoint(t))return!1}return!0}}(),containsPoint:function(t){for(var e=this.planes,i=0;6>i;i++)if(0>e[i].distanceToPoint(t))return!1;return!0}}),Object.assign(g.prototype,{isMatrix4:!0,set:function(t,e,i,n,s,r,a,o,l,h,c,u,d,p,m,f){var g=this.elements;return g[0]=t,g[4]=e,g[8]=i,g[12]=n,g[1]=s,g[5]=r,g[9]=a,g[13]=o,g[2]=l,g[6]=h,g[10]=c,g[14]=u,g[3]=d,g[7]=p,g[11]=m,g[15]=f,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new g).fromArray(this.elements)},copy:function(t){var e=this.elements;return t=t.elements,e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this},copyPosition:function(t){var e=this.elements;return t=t.elements,e[12]=t[12],e[13]=t[13],e[14]=t[14],this},extractBasis:function(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this},makeBasis:function(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this},extractRotation:function(){var t=new s;return function(e){var i=this.elements,n=e.elements,s=1/t.setFromMatrixColumn(e,0).length(),r=1/t.setFromMatrixColumn(e,1).length();return e=1/t.setFromMatrixColumn(e,2).length(),i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=0,i[4]=n[4]*r,i[5]=n[5]*r,i[6]=n[6]*r,i[7]=0,i[8]=n[8]*e,i[9]=n[9]*e,i[10]=n[10]*e,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}}(),makeRotationFromEuler:function(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var e=this.elements,i=t.x,n=t.y,s=t.z,r=Math.cos(i);i=Math.sin(i);var a=Math.cos(n);n=Math.sin(n);var o=Math.cos(s);if(s=Math.sin(s),"XYZ"===t.order){t=r*o;var l=r*s,h=i*o,c=i*s;e[0]=a*o,e[4]=-a*s,e[8]=n,e[1]=l+h*n,e[5]=t-c*n,e[9]=-i*a,e[2]=c-t*n,e[6]=h+l*n,e[10]=r*a}else"YXZ"===t.order?(t=a*o,l=a*s,h=n*o,c=n*s,e[0]=t+c*i,e[4]=h*i-l,e[8]=r*n,e[1]=r*s,e[5]=r*o,e[9]=-i,e[2]=l*i-h,e[6]=c+t*i,e[10]=r*a):"ZXY"===t.order?(t=a*o,l=a*s,h=n*o,c=n*s,e[0]=t-c*i,e[4]=-r*s,e[8]=h+l*i,e[1]=l+h*i,e[5]=r*o,e[9]=c-t*i,e[2]=-r*n,e[6]=i,e[10]=r*a):"ZYX"===t.order?(t=r*o,l=r*s,h=i*o,c=i*s,e[0]=a*o,e[4]=h*n-l,e[8]=t*n+c,e[1]=a*s,e[5]=c*n+t,e[9]=l*n-h,e[2]=-n,e[6]=i*a,e[10]=r*a):"YZX"===t.order?(t=r*a,l=r*n,h=i*a,c=i*n,e[0]=a*o,e[4]=c-t*s,e[8]=h*s+l,e[1]=s,e[5]=r*o,e[9]=-i*o,e[2]=-n*o,e[6]=l*s+h,e[10]=t-c*s):"XZY"===t.order&&(t=r*a,l=r*n,h=i*a,c=i*n,e[0]=a*o,e[4]=-s,e[8]=n*o,e[1]=t*s+c,e[5]=r*o,e[9]=l*s-h,e[2]=h*s-l,e[6]=i*o,e[10]=c*s+t);return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},makeRotationFromQuaternion:function(){var t=new s(0,0,0),e=new s(1,1,1);return function(i){return this.compose(t,i,e)}}(),lookAt:function(){var t=new s,e=new s,i=new s;return function(n,s,r){var a=this.elements;return i.subVectors(n,s),0===i.lengthSq()&&(i.z=1),i.normalize(),t.crossVectors(r,i),0===t.lengthSq()&&(1===Math.abs(r.z)?i.x+=1e-4:i.z+=1e-4,i.normalize(),t.crossVectors(r,i)),t.normalize(),e.crossVectors(i,t),a[0]=t.x,a[4]=e.x,a[8]=i.x,a[1]=t.y,a[5]=e.y,a[9]=i.y,a[2]=t.z,a[6]=e.z,a[10]=i.z,this}}(),multiply:function(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)},premultiply:function(t){return this.multiplyMatrices(t,this)},multiplyMatrices:function(t,e){var i=t.elements,n=e.elements;e=this.elements,t=i[0];var s=i[4],r=i[8],a=i[12],o=i[1],l=i[5],h=i[9],c=i[13],u=i[2],d=i[6],p=i[10],m=i[14],f=i[3],g=i[7],y=i[11];i=i[15];var v=n[0],b=n[4],w=n[8],x=n[12],S=n[1],E=n[5],M=n[9],T=n[13],C=n[2],P=n[6],_=n[10],A=n[14],L=n[3],R=n[7],I=n[11];return n=n[15],e[0]=t*v+s*S+r*C+a*L,e[4]=t*b+s*E+r*P+a*R,e[8]=t*w+s*M+r*_+a*I,e[12]=t*x+s*T+r*A+a*n,e[1]=o*v+l*S+h*C+c*L,e[5]=o*b+l*E+h*P+c*R,e[9]=o*w+l*M+h*_+c*I,e[13]=o*x+l*T+h*A+c*n,e[2]=u*v+d*S+p*C+m*L,e[6]=u*b+d*E+p*P+m*R,e[10]=u*w+d*M+p*_+m*I,e[14]=u*x+d*T+p*A+m*n,e[3]=f*v+g*S+y*C+i*L,e[7]=f*b+g*E+y*P+i*R,e[11]=f*w+g*M+y*_+i*I,e[15]=f*x+g*T+y*A+i*n,this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this},applyToBufferAttribute:function(){var t=new s;return function(e){for(var i=0,n=e.count;i<n;i++)t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.applyMatrix4(this),e.setXYZ(i,t.x,t.y,t.z);return e}}(),determinant:function(){var t=this.elements,e=t[0],i=t[4],n=t[8],s=t[12],r=t[1],a=t[5],o=t[9],l=t[13],h=t[2],c=t[6],u=t[10],d=t[14];return t[3]*(+s*o*c-n*l*c-s*a*u+i*l*u+n*a*d-i*o*d)+t[7]*(+e*o*d-e*l*u+s*r*u-n*r*d+n*l*h-s*o*h)+t[11]*(+e*l*c-e*a*d-s*r*c+i*r*d+s*a*h-i*l*h)+t[15]*(-n*a*h-e*o*c+e*a*u+n*r*c-i*r*u+i*o*h)},transpose:function(){var t=this.elements,e=t[1];return t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(t,e,i){var n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=i),this},getInverse:function(t,e){var i=this.elements,n=t.elements;t=n[0];var s=n[1],r=n[2],a=n[3],o=n[4],l=n[5],h=n[6],c=n[7],u=n[8],d=n[9],p=n[10],m=n[11],f=n[12],g=n[13],y=n[14],v=d*y*c-g*p*c+g*h*m-l*y*m-d*h*(n=n[15])+l*p*n,b=f*p*c-u*y*c-f*h*m+o*y*m+u*h*n-o*p*n,w=u*g*c-f*d*c+f*l*m-o*g*m-u*l*n+o*d*n,x=f*d*h-u*g*h-f*l*p+o*g*p+u*l*y-o*d*y,S=t*v+s*b+r*w+a*x;if(0===S){if(!0===e)throw Error("THREE.Matrix4: .getInverse() can't invert matrix, determinant is 0");return console.warn("THREE.Matrix4: .getInverse() can't invert matrix, determinant is 0"),this.identity()}return e=1/S,i[0]=v*e,i[1]=(g*p*a-d*y*a-g*r*m+s*y*m+d*r*n-s*p*n)*e,i[2]=(l*y*a-g*h*a+g*r*c-s*y*c-l*r*n+s*h*n)*e,i[3]=(d*h*a-l*p*a-d*r*c+s*p*c+l*r*m-s*h*m)*e,i[4]=b*e,i[5]=(u*y*a-f*p*a+f*r*m-t*y*m-u*r*n+t*p*n)*e,i[6]=(f*h*a-o*y*a-f*r*c+t*y*c+o*r*n-t*h*n)*e,i[7]=(o*p*a-u*h*a+u*r*c-t*p*c-o*r*m+t*h*m)*e,i[8]=w*e,i[9]=(f*d*a-u*g*a-f*s*m+t*g*m+u*s*n-t*d*n)*e,i[10]=(o*g*a-f*l*a+f*s*c-t*g*c-o*s*n+t*l*n)*e,i[11]=(u*l*a-o*d*a-u*s*c+t*d*c+o*s*m-t*l*m)*e,i[12]=x*e,i[13]=(u*g*r-f*d*r+f*s*p-t*g*p-u*s*y+t*d*y)*e,i[14]=(f*l*r-o*g*r-f*s*h+t*g*h+o*s*y-t*l*y)*e,i[15]=(o*d*r-u*l*r+u*s*h-t*d*h-o*s*p+t*l*p)*e,this},scale:function(t){var e=this.elements,i=t.x,n=t.y;return t=t.z,e[0]*=i,e[4]*=n,e[8]*=t,e[1]*=i,e[5]*=n,e[9]*=t,e[2]*=i,e[6]*=n,e[10]*=t,e[3]*=i,e[7]*=n,e[11]*=t,this},getMaxScaleOnAxis:function(){var t=this.elements;return Math.sqrt(Math.max(t[0]*t[0]+t[1]*t[1]+t[2]*t[2],t[4]*t[4]+t[5]*t[5]+t[6]*t[6],t[8]*t[8]+t[9]*t[9]+t[10]*t[10]))},makeTranslation:function(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this},makeRotationX:function(t){var e=Math.cos(t);return t=Math.sin(t),this.set(1,0,0,0,0,e,-t,0,0,t,e,0,0,0,0,1),this},makeRotationY:function(t){var e=Math.cos(t);return t=Math.sin(t),this.set(e,0,t,0,0,1,0,0,-t,0,e,0,0,0,0,1),this},makeRotationZ:function(t){var e=Math.cos(t);return t=Math.sin(t),this.set(e,-t,0,0,t,e,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(t,e){var i=Math.cos(e);e=Math.sin(e);var n=1-i,s=t.x,r=t.y;t=t.z;var a=n*s,o=n*r;return this.set(a*s+i,a*r-e*t,a*t+e*r,0,a*r+e*t,o*r+i,o*t-e*s,0,a*t-e*r,o*t+e*s,n*t*t+i,0,0,0,0,1),this},makeScale:function(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this},makeShear:function(t,e,i){return this.set(1,e,i,0,t,1,i,0,t,e,1,0,0,0,0,1),this},compose:function(t,e,i){var n=this.elements,s=e._x,r=e._y,a=e._z,o=e._w,l=s+s,h=r+r,c=a+a;e=s*l;var u=s*h;s*=c;var d=r*h;r*=c,a*=c,l*=o,h*=o,o*=c,c=i.x;var p=i.y;return i=i.z,n[0]=(1-(d+a))*c,n[1]=(u+o)*c,n[2]=(s-h)*c,n[3]=0,n[4]=(u-o)*p,n[5]=(1-(e+a))*p,n[6]=(r+l)*p,n[7]=0,n[8]=(s+h)*i,n[9]=(r-l)*i,n[10]=(1-(e+d))*i,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this},decompose:function(){var t=new s,e=new g;return function(i,n,s){var r=this.elements,a=t.set(r[0],r[1],r[2]).length(),o=t.set(r[4],r[5],r[6]).length(),l=t.set(r[8],r[9],r[10]).length();0>this.determinant()&&(a=-a),i.x=r[12],i.y=r[13],i.z=r[14],e.copy(this),i=1/a,r=1/o;var h=1/l;return e.elements[0]*=i,e.elements[1]*=i,e.elements[2]*=i,e.elements[4]*=r,e.elements[5]*=r,e.elements[6]*=r,e.elements[8]*=h,e.elements[9]*=h,e.elements[10]*=h,n.setFromRotationMatrix(e),s.x=a,s.y=o,s.z=l,this}}(),makePerspective:function(t,e,i,n,s,r){void 0===r&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var a=this.elements;return a[0]=2*s/(e-t),a[4]=0,a[8]=(e+t)/(e-t),a[12]=0,a[1]=0,a[5]=2*s/(i-n),a[9]=(i+n)/(i-n),a[13]=0,a[2]=0,a[6]=0,a[10]=-(r+s)/(r-s),a[14]=-2*r*s/(r-s),a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this},makeOrthographic:function(t,e,i,n,s,r){var a=this.elements,o=1/(e-t),l=1/(i-n),h=1/(r-s);return a[0]=2*o,a[4]=0,a[8]=0,a[12]=-(e+t)*o,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-(i+n)*l,a[2]=0,a[6]=0,a[10]=-2*h,a[14]=-(r+s)*h,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},equals:function(t){var e=this.elements;t=t.elements;for(var i=0;16>i;i++)if(e[i]!==t[i])return!1;return!0},fromArray:function(t,e){void 0===e&&(e=0);for(var i=0;16>i;i++)this.elements[i]=t[i+e];return this},toArray:function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}});var $s={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n#else\n\tif( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t}\n\treturn 1.0;\n#endif\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nvec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );\n\tvec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;\n\treturn Fr * fresnel + F0;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\treturn specularColor * brdf.x + brdf.y;\n}\nvoid BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tvec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG ) && ! defined( MATCAP )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG ) && ! defined( MATCAP )\n\tvarying vec3 vViewPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG ) && ! defined( MATCAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common:"#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV( sampler2D envMap, vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = normalMatrix * objectNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = normalMatrix * objectTangent;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * value.a * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat D = max( maxRange / maxRGB, 1.0 );\n\tD = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;\n\tXp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract( Le );\n\tvResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;\n\treturn vec4( max( vRGB, 0.0 ), 1.0 );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\treflectVec = normalize( reflectVec );\n\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\treflectVec = normalize( reflectVec );\n\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_pars_fragment:"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent ));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tfogDepth = -mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float fogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef TOON\n\tuniform sampler2D gradientMap;\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t\t#ifdef USE_GRADIENTMAP\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\t\t#else\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t\t#endif\n\t}\n#endif",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif",lights_pars_begin:"uniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {\n\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t\tfloat shadowCameraNear;\n\t\tfloat shadowCameraFar;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifdef TOON\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#else\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\t#endif\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef ENVMAP_TYPE_CUBE_UV\n\t\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#endif\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\tfloat clearCoatInv = 1.0 - clearCoatDHR;\n\t#if defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec3 singleScattering = vec3( 0.0 );\n\t\tvec3 multiScattering = vec3( 0.0 );\n\t\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t\tBRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );\n\t\tvec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\t\treflectedLight.indirectSpecular += clearCoatInv * radiance * singleScattering;\n\t\treflectedLight.indirectDiffuse += multiScattering * cosineWeightedIrradiance;\n\t\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n\t#else\n\t\treflectedLight.indirectSpecular += clearCoatInv * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#endif\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearCoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tirradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), maxMipLevel );\n\t#ifndef STANDARD\n\t\tclearCoatRadiance += getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), maxMipLevel );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t#else\n\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\tgl_Position.z *= gl_Position.w;\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#ifdef USE_MAP\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif",map_particle_pars_fragment:"#ifdef USE_MAP\n\tuniform mat3 uvTransform;\n\tuniform sampler2D map;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif",normal_fragment_begin:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n\t#ifdef USE_TANGENT\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\ttangent = tangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t\tbitangent = bitangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t#endif\n\t#endif\n#endif",normal_fragment_maps:"#ifdef USE_NORMALMAP\n\t#ifdef OBJECTSPACE_NORMALMAP\n\t\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\t#ifdef FLIP_SIDED\n\t\t\tnormal = - normal;\n\t\t#endif\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t#endif\n\t\tnormal = normalize( normalMatrix * normal );\n\t#else\n\t\t#ifdef USE_TANGENT\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\t\tmapN.xy = normalScale * mapN.xy;\n\t\t\tnormal = normalize( vTBN * mapN );\n\t\t#else\n\t\t\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n\t\t#endif\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\t#ifdef OBJECTSPACE_NORMALMAP\n\t\tuniform mat3 normalMatrix;\n\t#else\n\t\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\t\tvec2 st0 = dFdx( vUv.st );\n\t\t\tvec2 st1 = dFdy( vUv.st );\n\t\t\tfloat scale = sign( st1.t * st0.s - st0.t * st1.s );\n\t\t\tvec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );\n\t\t\tvec3 T = normalize( ( - q0 * st1.s + q1 * st0.s ) * scale );\n\t\t\tvec3 N = normalize( surf_norm );\n\t\t\tmat3 tsn = mat3( S, T, N );\n\t\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\t\tmapN.xy *= normalScale;\n\t\t\tmapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t\treturn normalize( tsn * mapN );\n\t\t}\n\t#endif\n#endif",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#if defined( DITHERING )\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n\t#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( ( color * ( 2.51 * color + 0.03 ) ) / ( color * ( 2.43 * color + 0.59 ) + 0.14 ) );\n}",uv_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif",uv_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n#endif",background_frag:"uniform sampler2D t2D;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV;\n\tsampleUV.y = asin( clamp( direction.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tvec4 texColor = texture2D( tEquirect, sampleUV );\n\tgl_FragColor = mapTexelToLinear( texColor );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\t#else\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\t#endif\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t\tmatcapColor = matcapTexelToLinear( matcapColor );\n\t#else\n\t\tvec4 matcapColor = vec4( 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#ifndef FLAT_SHADED\n\t\tvNormal = normalize( transformedNormal );\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphysical_frag:"#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <fog_fragment>\n}",shadow_vert:"#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}"},tr={clone:y,merge:v},er={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Object.assign(b.prototype,{isColor:!0,r:1,g:1,b:1,set:function(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this},setScalar:function(t){return this.b=this.g=this.r=t,this},setHex:function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this},setRGB:function(t,e,i){return this.r=t,this.g=e,this.b=i,this},setHSL:function(){function t(t,e,i){return 0>i&&(i+=1),1<i&&--i,i<1/6?t+6*(e-t)*i:.5>i?e:i<2/3?t+6*(e-t)*(2/3-i):t}return function(e,i,n){return e=Js.euclideanModulo(e,1),i=Js.clamp(i,0,1),n=Js.clamp(n,0,1),0===i?this.r=this.g=this.b=n:(n=2*n-(i=.5>=n?n*(1+i):n+i-n*i),this.r=t(n,i,e+1/3),this.g=t(n,i,e),this.b=t(n,i,e-1/3)),this}}(),setStyle:function(t){function e(e){void 0!==e&&1>parseFloat(e)&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}var i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(t)){var n=i[2];switch(i[1]){case"rgb":case"rgba":if(i=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n))return this.r=Math.min(255,parseInt(i[1],10))/255,this.g=Math.min(255,parseInt(i[2],10))/255,this.b=Math.min(255,parseInt(i[3],10))/255,e(i[5]),this;if(i=/^(\d+)%\s*,\s*(\d+)%\s*,\s*(\d+)%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n))return this.r=Math.min(100,parseInt(i[1],10))/100,this.g=Math.min(100,parseInt(i[2],10))/100,this.b=Math.min(100,parseInt(i[3],10))/100,e(i[5]),this;break;case"hsl":case"hsla":if(i=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n)){n=parseFloat(i[1])/360;var s=parseInt(i[2],10)/100,r=parseInt(i[3],10)/100;return e(i[5]),this.setHSL(n,s,r)}}}else if(i=/^#([A-Fa-f0-9]+)$/.exec(t)){if(3===(n=(i=i[1]).length))return this.r=parseInt(i.charAt(0)+i.charAt(0),16)/255,this.g=parseInt(i.charAt(1)+i.charAt(1),16)/255,this.b=parseInt(i.charAt(2)+i.charAt(2),16)/255,this;if(6===n)return this.r=parseInt(i.charAt(0)+i.charAt(1),16)/255,this.g=parseInt(i.charAt(2)+i.charAt(3),16)/255,this.b=parseInt(i.charAt(4)+i.charAt(5),16)/255,this}return t&&0<t.length&&(void 0!==(i=er[t])?this.setHex(i):console.warn("THREE.Color: Unknown color "+t)),this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},copyGammaToLinear:function(t,e){return void 0===e&&(e=2),this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this},copyLinearToGamma:function(t,e){return void 0===e&&(e=2),e=0<e?1/e:1,this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this},convertGammaToLinear:function(t){return this.copyGammaToLinear(this,t),this},convertLinearToGamma:function(t){return this.copyLinearToGamma(this,t),this},copySRGBToLinear:function(){function t(t){return.04045>t?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}return function(e){return this.r=t(e.r),this.g=t(e.g),this.b=t(e.b),this}}(),copyLinearToSRGB:function(){function t(t){return.0031308>t?12.92*t:1.055*Math.pow(t,.41666)-.055}return function(e){return this.r=t(e.r),this.g=t(e.g),this.b=t(e.b),this}}(),convertSRGBToLinear:function(){return this.copySRGBToLinear(this),this},convertLinearToSRGB:function(){return this.copyLinearToSRGB(this),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(t){void 0===t&&(console.warn("THREE.Color: .getHSL() target is now required"),t={h:0,s:0,l:0});var e,i=this.r,n=this.g,s=this.b,r=Math.max(i,n,s),a=Math.min(i,n,s),o=(a+r)/2;if(a===r)a=e=0;else{var l=r-a;switch(a=.5>=o?l/(r+a):l/(2-r-a),r){case i:e=(n-s)/l+(n<s?6:0);break;case n:e=(s-i)/l+2;break;case s:e=(i-n)/l+4}e/=6}return t.h=e,t.s=a,t.l=o,t},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(){var t={};return function(e,i,n){return this.getHSL(t),t.h+=e,t.s+=i,t.l+=n,this.setHSL(t.h,t.s,t.l),this}}(),add:function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this},addColors:function(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this},addScalar:function(t){return this.r+=t,this.g+=t,this.b+=t,this},sub:function(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this},multiply:function(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this},multiplyScalar:function(t){return this.r*=t,this.g*=t,this.b*=t,this},lerp:function(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this},lerpHSL:function(){var t={h:0,s:0,l:0},e={h:0,s:0,l:0};return function(i,n){this.getHSL(t),i.getHSL(e),i=Js.lerp(t.h,e.h,n);var s=Js.lerp(t.s,e.s,n);return n=Js.lerp(t.l,e.l,n),this.setHSL(i,s,n),this}}(),equals:function(t){return t.r===this.r&&t.g===this.g&&t.b===this.b},fromArray:function(t,e){return void 0===e&&(e=0),this.r=t[e],this.g=t[e+1],this.b=t[e+2],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t},toJSON:function(){return this.getHex()}});var ir={common:{diffuse:{value:new b(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new r},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new i(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new b(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new b(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},uvTransform:{value:new r}},sprite:{diffuse:{value:new b(15658734)},opacity:{value:1},center:{value:new i(.5,.5)},rotation:{value:0},map:{value:null},uvTransform:{value:new r}}},nr={basic:{uniforms:v([ir.common,ir.specularmap,ir.envmap,ir.aomap,ir.lightmap,ir.fog]),vertexShader:$s.meshbasic_vert,fragmentShader:$s.meshbasic_frag},lambert:{uniforms:v([ir.common,ir.specularmap,ir.envmap,ir.aomap,ir.lightmap,ir.emissivemap,ir.fog,ir.lights,{emissive:{value:new b(0)}}]),vertexShader:$s.meshlambert_vert,fragmentShader:$s.meshlambert_frag},phong:{uniforms:v([ir.common,ir.specularmap,ir.envmap,ir.aomap,ir.lightmap,ir.emissivemap,ir.bumpmap,ir.normalmap,ir.displacementmap,ir.gradientmap,ir.fog,ir.lights,{emissive:{value:new b(0)},specular:{value:new b(1118481)},shininess:{value:30}}]),vertexShader:$s.meshphong_vert,fragmentShader:$s.meshphong_frag},standard:{uniforms:v([ir.common,ir.envmap,ir.aomap,ir.lightmap,ir.emissivemap,ir.bumpmap,ir.normalmap,ir.displacementmap,ir.roughnessmap,ir.metalnessmap,ir.fog,ir.lights,{emissive:{value:new b(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:$s.meshphysical_vert,fragmentShader:$s.meshphysical_frag},matcap:{uniforms:v([ir.common,ir.bumpmap,ir.normalmap,ir.displacementmap,ir.fog,{matcap:{value:null}}]),vertexShader:$s.meshmatcap_vert,fragmentShader:$s.meshmatcap_frag},points:{uniforms:v([ir.points,ir.fog]),vertexShader:$s.points_vert,fragmentShader:$s.points_frag},dashed:{uniforms:v([ir.common,ir.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:$s.linedashed_vert,fragmentShader:$s.linedashed_frag},depth:{uniforms:v([ir.common,ir.displacementmap]),vertexShader:$s.depth_vert,fragmentShader:$s.depth_frag},normal:{uniforms:v([ir.common,ir.bumpmap,ir.normalmap,ir.displacementmap,{opacity:{value:1}}]),vertexShader:$s.normal_vert,fragmentShader:$s.normal_frag},sprite:{uniforms:v([ir.sprite,ir.fog]),vertexShader:$s.sprite_vert,fragmentShader:$s.sprite_frag},background:{uniforms:{uvTransform:{value:new r},t2D:{value:null}},vertexShader:$s.background_vert,fragmentShader:$s.background_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:$s.cube_vert,fragmentShader:$s.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:$s.equirect_vert,fragmentShader:$s.equirect_frag},distanceRGBA:{uniforms:v([ir.common,ir.displacementmap,{referencePosition:{value:new s},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:$s.distanceRGBA_vert,fragmentShader:$s.distanceRGBA_frag},shadow:{uniforms:v([ir.lights,ir.fog,{color:{value:new b(0)},opacity:{value:1}}]),vertexShader:$s.shadow_vert,fragmentShader:$s.shadow_frag}};nr.physical={uniforms:v([nr.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:$s.meshphysical_vert,fragmentShader:$s.meshphysical_frag},Object.assign(S.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(t){this.a=t.a,this.b=t.b,this.c=t.c,this.normal.copy(t.normal),this.color.copy(t.color),this.materialIndex=t.materialIndex;for(var e=0,i=t.vertexNormals.length;e<i;e++)this.vertexNormals[e]=t.vertexNormals[e].clone();for(e=0,i=t.vertexColors.length;e<i;e++)this.vertexColors[e]=t.vertexColors[e].clone();return this}}),E.RotationOrders="XYZ YZX ZXY XZY YXZ ZYX".split(" "),E.DefaultOrder="XYZ",Object.defineProperties(E.prototype,{x:{get:function(){return this._x},set:function(t){this._x=t,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(t){this._y=t,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(t){this._z=t,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(t){this._order=t,this.onChangeCallback()}}}),Object.assign(E.prototype,{isEuler:!0,set:function(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._order=n||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this},setFromRotationMatrix:function(t,e,i){var n=Js.clamp,s=t.elements;t=s[0];var r=s[4],a=s[8],o=s[1],l=s[5],h=s[9],c=s[2],u=s[6];return s=s[10],"XYZ"===(e=e||this._order)?(this._y=Math.asin(n(a,-1,1)),.99999>Math.abs(a)?(this._x=Math.atan2(-h,s),this._z=Math.atan2(-r,t)):(this._x=Math.atan2(u,l),this._z=0)):"YXZ"===e?(this._x=Math.asin(-n(h,-1,1)),.99999>Math.abs(h)?(this._y=Math.atan2(a,s),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-c,t),this._z=0)):"ZXY"===e?(this._x=Math.asin(n(u,-1,1)),.99999>Math.abs(u)?(this._y=Math.atan2(-c,s),this._z=Math.atan2(-r,l)):(this._y=0,this._z=Math.atan2(o,t))):"ZYX"===e?(this._y=Math.asin(-n(c,-1,1)),.99999>Math.abs(c)?(this._x=Math.atan2(u,s),this._z=Math.atan2(o,t)):(this._x=0,this._z=Math.atan2(-r,l))):"YZX"===e?(this._z=Math.asin(n(o,-1,1)),.99999>Math.abs(o)?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-c,t)):(this._x=0,this._y=Math.atan2(a,s))):"XZY"===e?(this._z=Math.asin(-n(r,-1,1)),.99999>Math.abs(r)?(this._x=Math.atan2(u,l),this._y=Math.atan2(a,t)):(this._x=Math.atan2(-h,s),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+e),this._order=e,!1!==i&&this.onChangeCallback(),this},setFromQuaternion:function(){var t=new g;return function(e,i,n){return t.makeRotationFromQuaternion(e),this.setFromRotationMatrix(t,i,n)}}(),setFromVector3:function(t,e){return this.set(t.x,t.y,t.z,e||this._order)},reorder:function(){var t=new n;return function(e){return t.setFromEuler(this),this.setFromQuaternion(t,e)}}(),equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t},toVector3:function(t){return t?t.set(this._x,this._y,this._z):new s(this._x,this._y,this._z)},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){}}),Object.assign(M.prototype,{set:function(t){this.mask=1<<t|0},enable:function(t){this.mask=this.mask|1<<t|0},toggle:function(t){this.mask^=1<<t|0},disable:function(t){this.mask&=~(1<<t|0)},test:function(t){return 0!=(this.mask&t.mask)}});var sr=0;T.DefaultUp=new s(0,1,0),T.DefaultMatrixAutoUpdate=!0,T.prototype=Object.assign(Object.create(e.prototype),{constructor:T,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix:function(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:function(){var t=new n;return function(e,i){return t.setFromAxisAngle(e,i),this.quaternion.multiply(t),this}}(),rotateOnWorldAxis:function(){var t=new n;return function(e,i){return t.setFromAxisAngle(e,i),this.quaternion.premultiply(t),this}}(),rotateX:function(){var t=new s(1,0,0);return function(e){return this.rotateOnAxis(t,e)}}(),rotateY:function(){var t=new s(0,1,0);return function(e){return this.rotateOnAxis(t,e)}}(),rotateZ:function(){var t=new s(0,0,1);return function(e){return this.rotateOnAxis(t,e)}}(),translateOnAxis:function(){var t=new s;return function(e,i){return t.copy(e).applyQuaternion(this.quaternion),this.position.add(t.multiplyScalar(i)),this}}(),translateX:function(){var t=new s(1,0,0);return function(e){return this.translateOnAxis(t,e)}}(),translateY:function(){var t=new s(0,1,0);return function(e){return this.translateOnAxis(t,e)}}(),translateZ:function(){var t=new s(0,0,1);return function(e){return this.translateOnAxis(t,e)}}(),localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var t=new g;return function(e){return e.applyMatrix4(t.getInverse(this.matrixWorld))}}(),lookAt:function(){var t=new n,e=new g,i=new s,r=new s;return function(n,s,a){n.isVector3?i.copy(n):i.set(n,s,a),n=this.parent,this.updateWorldMatrix(!0,!1),r.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?e.lookAt(r,i,this.up):e.lookAt(i,r,this.up),this.quaternion.setFromRotationMatrix(e),n&&(e.extractRotation(n.matrixWorld),t.setFromRotationMatrix(e),this.quaternion.premultiply(t.inverse()))}}(),add:function(t){if(1<arguments.length){for(var e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,t.dispatchEvent({type:"added"}),this.children.push(t)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)},remove:function(t){if(1<arguments.length){for(var e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}return-1!==(e=this.children.indexOf(t))&&(t.parent=null,t.dispatchEvent({type:"removed"}),this.children.splice(e,1)),this},attach:function(){var t=new g;return function(e){return this.updateWorldMatrix(!0,!1),t.getInverse(this.matrixWorld),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),t.multiply(e.parent.matrixWorld)),e.applyMatrix(t),e.updateWorldMatrix(!1,!1),this.add(e),this}}(),getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(var i=0,n=this.children.length;i<n;i++){var s=this.children[i].getObjectByProperty(t,e);if(void 0!==s)return s}},getWorldPosition:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),t=new s),this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(){var t=new s,e=new s;return function(i){return void 0===i&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),i=new n),this.updateMatrixWorld(!0),this.matrixWorld.decompose(t,i,e),i}}(),getWorldScale:function(){var t=new s,e=new n;return function(i){return void 0===i&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),i=new s),this.updateMatrixWorld(!0),this.matrixWorld.decompose(t,e,i),i}}(),getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),t=new s),this.updateMatrixWorld(!0);var e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()},raycast:function(){},traverse:function(t){t(this);for(var e=this.children,i=0,n=e.length;i<n;i++)e[i].traverse(t)},traverseVisible:function(t){if(!1!==this.visible){t(this);for(var e=this.children,i=0,n=e.length;i<n;i++)e[i].traverseVisible(t)}},traverseAncestors:function(t){var e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(var e=this.children,i=0,n=e.length;i<n;i++)e[i].updateMatrixWorld(t)},updateWorldMatrix:function(t,e){var i=this.parent;if(!0===t&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e)for(e=0,i=(t=this.children).length;e<i;e++)t[e].updateWorldMatrix(!1,!0)},toJSON:function(t){function e(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}function i(t){var e,i=[];for(e in t){var n=t[e];delete n.metadata,i.push(n)}return i}var n=void 0===t||"string"==typeof t,s={};n&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{}},s.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var r={};if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),!0===this.castShadow&&(r.castShadow=!0),!0===this.receiveShadow&&(r.receiveShadow=!0),!1===this.visible&&(r.visible=!1),!1===this.frustumCulled&&(r.frustumCulled=!1),0!==this.renderOrder&&(r.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(r.matrixAutoUpdate=!1),this.isMesh&&0!==this.drawMode&&(r.drawMode=this.drawMode),this.isMesh||this.isLine||this.isPoints){r.geometry=e(t.geometries,this.geometry);var a=this.geometry.parameters;if(void 0!==a&&void 0!==a.shapes)if(a=a.shapes,Array.isArray(a))for(var o=0,l=a.length;o<l;o++)e(t.shapes,a[o]);else e(t.shapes,a)}if(void 0!==this.material)if(Array.isArray(this.material)){for(a=[],o=0,l=this.material.length;o<l;o++)a.push(e(t.materials,this.material[o]));r.material=a}else r.material=e(t.materials,this.material);if(0<this.children.length)for(r.children=[],o=0;o<this.children.length;o++)r.children.push(this.children[o].toJSON(t).object);if(n){n=i(t.geometries),o=i(t.materials),l=i(t.textures);var h=i(t.images);a=i(t.shapes),0<n.length&&(s.geometries=n),0<o.length&&(s.materials=o),0<l.length&&(s.textures=l),0<h.length&&(s.images=h),0<a.length&&(s.shapes=a)}return s.object=r,s},clone:function(t){return(new this.constructor).copy(this,t)},copy:function(t,e){if(void 0===e&&(e=!0),this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(e=0;e<t.children.length;e++)this.add(t.children[e].clone());return this}});var rr=0;C.prototype=Object.assign(Object.create(e.prototype),{constructor:C,isGeometry:!0,applyMatrix:function(t){for(var e=(new r).getNormalMatrix(t),i=0,n=this.vertices.length;i<n;i++)this.vertices[i].applyMatrix4(t);for(i=0,n=this.faces.length;i<n;i++){(t=this.faces[i]).normal.applyMatrix3(e).normalize();for(var s=0,a=t.vertexNormals.length;s<a;s++)t.vertexNormals[s].applyMatrix3(e).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.normalsNeedUpdate=this.verticesNeedUpdate=!0,this},rotateX:function(){var t=new g;return function(e){return t.makeRotationX(e),this.applyMatrix(t),this}}(),rotateY:function(){var t=new g;return function(e){return t.makeRotationY(e),this.applyMatrix(t),this}}(),rotateZ:function(){var t=new g;return function(e){return t.makeRotationZ(e),this.applyMatrix(t),this}}(),translate:function(){var t=new g;return function(e,i,n){return t.makeTranslation(e,i,n),this.applyMatrix(t),this}}(),scale:function(){var t=new g;return function(e,i,n){return t.makeScale(e,i,n),this.applyMatrix(t),this}}(),lookAt:function(){var t=new T;return function(e){t.lookAt(e),t.updateMatrix(),this.applyMatrix(t.matrix)}}(),fromBufferGeometry:function(t){function e(t,e,r,a){var o=void 0===h?[]:[n.colors[t].clone(),n.colors[e].clone(),n.colors[r].clone()];a=new S(t,e,r,void 0===l?[]:[(new s).fromArray(l,3*t),(new s).fromArray(l,3*e),(new s).fromArray(l,3*r)],o,a),n.faces.push(a),void 0!==c&&n.faceVertexUvs[0].push([(new i).fromArray(c,2*t),(new i).fromArray(c,2*e),(new i).fromArray(c,2*r)]),void 0!==u&&n.faceVertexUvs[1].push([(new i).fromArray(u,2*t),(new i).fromArray(u,2*e),(new i).fromArray(u,2*r)])}var n=this,r=null!==t.index?t.index.array:void 0,a=t.attributes,o=a.position.array,l=void 0!==a.normal?a.normal.array:void 0,h=void 0!==a.color?a.color.array:void 0,c=void 0!==a.uv?a.uv.array:void 0,u=void 0!==a.uv2?a.uv2.array:void 0;for(void 0!==u&&(this.faceVertexUvs[1]=[]),a=0;a<o.length;a+=3)n.vertices.push((new s).fromArray(o,a)),void 0!==h&&n.colors.push((new b).fromArray(h,a));var d=t.groups;if(0<d.length)for(a=0;a<d.length;a++){var p=(o=d[a]).start,m=p;for(p+=o.count;m<p;m+=3)void 0!==r?e(r[m],r[m+1],r[m+2],o.materialIndex):e(m,m+1,m+2,o.materialIndex)}else if(void 0!==r)for(a=0;a<r.length;a+=3)e(r[a],r[a+1],r[a+2]);else for(a=0;a<o.length/3;a+=3)e(a,a+1,a+2);return this.computeFaceNormals(),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this},center:function(){var t=new s;return function(){return this.computeBoundingBox(),this.boundingBox.getCenter(t).negate(),this.translate(t.x,t.y,t.z),this}}(),normalize:function(){this.computeBoundingSphere();var t=this.boundingSphere.center,e=this.boundingSphere.radius;e=0===e?1:1/e;var i=new g;return i.set(e,0,0,-e*t.x,0,e,0,-e*t.y,0,0,e,-e*t.z,0,0,0,1),this.applyMatrix(i),this},computeFaceNormals:function(){for(var t=new s,e=new s,i=0,n=this.faces.length;i<n;i++){var r=this.faces[i],a=this.vertices[r.a],o=this.vertices[r.b];t.subVectors(this.vertices[r.c],o),e.subVectors(a,o),t.cross(e),t.normalize(),r.normal.copy(t)}},computeVertexNormals:function(t){var e;void 0===t&&(t=!0);var i=Array(this.vertices.length),n=0;for(e=this.vertices.length;n<e;n++)i[n]=new s;if(t){var r=new s,a=new s;for(t=0,n=this.faces.length;t<n;t++){e=this.faces[t];var o=this.vertices[e.a],l=this.vertices[e.b],h=this.vertices[e.c];r.subVectors(h,l),a.subVectors(o,l),r.cross(a),i[e.a].add(r),i[e.b].add(r),i[e.c].add(r)}}else for(this.computeFaceNormals(),t=0,n=this.faces.length;t<n;t++)i[(e=this.faces[t]).a].add(e.normal),i[e.b].add(e.normal),i[e.c].add(e.normal);for(n=0,e=this.vertices.length;n<e;n++)i[n].normalize();for(t=0,n=this.faces.length;t<n;t++)3===(o=(e=this.faces[t]).vertexNormals).length?(o[0].copy(i[e.a]),o[1].copy(i[e.b]),o[2].copy(i[e.c])):(o[0]=i[e.a].clone(),o[1]=i[e.b].clone(),o[2]=i[e.c].clone());0<this.faces.length&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var t;this.computeFaceNormals();var e=0;for(t=this.faces.length;e<t;e++){var i=this.faces[e],n=i.vertexNormals;3===n.length?(n[0].copy(i.normal),n[1].copy(i.normal),n[2].copy(i.normal)):(n[0]=i.normal.clone(),n[1]=i.normal.clone(),n[2]=i.normal.clone())}0<this.faces.length&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var t,e,i=0;for(e=this.faces.length;i<e;i++){var n=this.faces[i];n.__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]);var r=0;for(t=n.vertexNormals.length;r<t;r++)n.__originalVertexNormals[r]?n.__originalVertexNormals[r].copy(n.vertexNormals[r]):n.__originalVertexNormals[r]=n.vertexNormals[r].clone()}var a=new C;for(a.faces=this.faces,r=0,t=this.morphTargets.length;r<t;r++){if(!this.morphNormals[r]){this.morphNormals[r]={},this.morphNormals[r].faceNormals=[],this.morphNormals[r].vertexNormals=[],n=this.morphNormals[r].faceNormals;var o=this.morphNormals[r].vertexNormals;for(i=0,e=this.faces.length;i<e;i++){var l=new s,h={a:new s,b:new s,c:new s};n.push(l),o.push(h)}}for(o=this.morphNormals[r],a.vertices=this.morphTargets[r].vertices,a.computeFaceNormals(),a.computeVertexNormals(),i=0,e=this.faces.length;i<e;i++)n=this.faces[i],l=o.faceNormals[i],h=o.vertexNormals[i],l.copy(n.normal),h.a.copy(n.vertexNormals[0]),h.b.copy(n.vertexNormals[1]),h.c.copy(n.vertexNormals[2])}for(i=0,e=this.faces.length;i<e;i++)(n=this.faces[i]).normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new d),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new p),this.boundingSphere.setFromPoints(this.vertices)},merge:function(t,e,i){if(t&&t.isGeometry){var n,s=this.vertices.length,a=this.vertices,o=t.vertices,l=this.faces,h=t.faces,c=this.faceVertexUvs[0],u=t.faceVertexUvs[0],d=this.colors,p=t.colors;void 0===i&&(i=0),void 0!==e&&(n=(new r).getNormalMatrix(e)),t=0;for(var m=o.length;t<m;t++){var f=o[t].clone();void 0!==e&&f.applyMatrix4(e),a.push(f)}for(t=0,m=p.length;t<m;t++)d.push(p[t].clone());for(t=0,m=h.length;t<m;t++){var g=(o=h[t]).vertexNormals;for(p=o.vertexColors,(d=new S(o.a+s,o.b+s,o.c+s)).normal.copy(o.normal),void 0!==n&&d.normal.applyMatrix3(n).normalize(),e=0,a=g.length;e<a;e++)f=g[e].clone(),void 0!==n&&f.applyMatrix3(n).normalize(),d.vertexNormals.push(f);for(d.color.copy(o.color),e=0,a=p.length;e<a;e++)f=p[e],d.vertexColors.push(f.clone());d.materialIndex=o.materialIndex+i,l.push(d)}for(t=0,m=u.length;t<m;t++)if(n=[],void 0!==(i=u[t])){for(e=0,a=i.length;e<a;e++)n.push(i[e].clone());c.push(n)}}else console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",t)},mergeMesh:function(t){t&&t.isMesh?(t.matrixAutoUpdate&&t.updateMatrix(),this.merge(t.geometry,t.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",t)},mergeVertices:function(){var t,e={},i=[],n=[],s=Math.pow(10,4),r=0;for(t=this.vertices.length;r<t;r++){var a=this.vertices[r];void 0===e[a=Math.round(a.x*s)+"_"+Math.round(a.y*s)+"_"+Math.round(a.z*s)]?(e[a]=r,i.push(this.vertices[r]),n[r]=i.length-1):n[r]=n[e[a]]}for(e=[],r=0,t=this.faces.length;r<t;r++)for((s=this.faces[r]).a=n[s.a],s.b=n[s.b],s.c=n[s.c],s=[s.a,s.b,s.c],a=0;3>a;a++)if(s[a]===s[(a+1)%3]){e.push(r);break}for(r=e.length-1;0<=r;r--)for(s=e[r],this.faces.splice(s,1),n=0,t=this.faceVertexUvs.length;n<t;n++)this.faceVertexUvs[n].splice(s,1);return r=this.vertices.length-i.length,this.vertices=i,r},setFromPoints:function(t){this.vertices=[];for(var e=0,i=t.length;e<i;e++){var n=t[e];this.vertices.push(new s(n.x,n.y,n.z||0))}return this},sortFacesByMaterialIndex:function(){for(var t=this.faces,e=t.length,i=0;i<e;i++)t[i]._id=i;t.sort(function(t,e){return t.materialIndex-e.materialIndex});var n,s,r=this.faceVertexUvs[0],a=this.faceVertexUvs[1];for(r&&r.length===e&&(n=[]),a&&a.length===e&&(s=[]),i=0;i<e;i++){var o=t[i]._id;n&&n.push(r[o]),s&&s.push(a[o])}n&&(this.faceVertexUvs[0]=n),s&&(this.faceVertexUvs[1]=s)},toJSON:function(){function t(t,e,i){return i?t|1<<e:t&~(1<<e)}function e(t){var e=t.x.toString()+t.y.toString()+t.z.toString();return void 0!==h[e]?h[e]:(h[e]=l.length/3,l.push(t.x,t.y,t.z),h[e])}function i(t){var e=t.r.toString()+t.g.toString()+t.b.toString();return void 0!==u[e]?u[e]:(u[e]=c.length,c.push(t.getHex()),u[e])}function n(t){var e=t.x.toString()+t.y.toString();return void 0!==p[e]?p[e]:(p[e]=d.length/2,d.push(t.x,t.y),p[e])}var s={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),void 0!==this.parameters){var r,a=this.parameters;for(r in a)void 0!==a[r]&&(s[r]=a[r]);return s}for(a=[],r=0;r<this.vertices.length;r++){var o=this.vertices[r];a.push(o.x,o.y,o.z)}o=[];var l=[],h={},c=[],u={},d=[],p={};for(r=0;r<this.faces.length;r++){var m=this.faces[r],f=void 0!==this.faceVertexUvs[0][r],g=0<m.normal.length(),y=0<m.vertexNormals.length,v=1!==m.color.r||1!==m.color.g||1!==m.color.b,b=0<m.vertexColors.length,w=0;w=t(w=t(w=t(w=t(w=t(w=t(w=t(w=t(w,0,0),1,!0),2,!1),3,f),4,g),5,y),6,v),7,b),o.push(w),o.push(m.a,m.b,m.c),o.push(m.materialIndex),f&&(f=this.faceVertexUvs[0][r],o.push(n(f[0]),n(f[1]),n(f[2]))),g&&o.push(e(m.normal)),y&&(g=m.vertexNormals,o.push(e(g[0]),e(g[1]),e(g[2]))),v&&o.push(i(m.color)),b&&(m=m.vertexColors,o.push(i(m[0]),i(m[1]),i(m[2])))}return s.data={},s.data.vertices=a,s.data.normals=l,0<c.length&&(s.data.colors=c),0<d.length&&(s.data.uvs=[d]),s.data.faces=o,s},clone:function(){return(new C).copy(this)},copy:function(t){var e,i,n;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingSphere=this.boundingBox=null,this.name=t.name;var s=t.vertices,r=0;for(e=s.length;r<e;r++)this.vertices.push(s[r].clone());for(r=0,e=(s=t.colors).length;r<e;r++)this.colors.push(s[r].clone());for(r=0,e=(s=t.faces).length;r<e;r++)this.faces.push(s[r].clone());for(r=0,e=t.faceVertexUvs.length;r<e;r++){var a=t.faceVertexUvs[r];for(void 0===this.faceVertexUvs[r]&&(this.faceVertexUvs[r]=[]),s=0,i=a.length;s<i;s++){var o=a[s],l=[],h=0;for(n=o.length;h<n;h++)l.push(o[h].clone());this.faceVertexUvs[r].push(l)}}for(r=0,e=(h=t.morphTargets).length;r<e;r++){if((n={}).name=h[r].name,void 0!==h[r].vertices)for(n.vertices=[],s=0,i=h[r].vertices.length;s<i;s++)n.vertices.push(h[r].vertices[s].clone());if(void 0!==h[r].normals)for(n.normals=[],s=0,i=h[r].normals.length;s<i;s++)n.normals.push(h[r].normals[s].clone());this.morphTargets.push(n)}for(r=0,e=(h=t.morphNormals).length;r<e;r++){if(n={},void 0!==h[r].vertexNormals)for(n.vertexNormals=[],s=0,i=h[r].vertexNormals.length;s<i;s++)a=h[r].vertexNormals[s],(o={}).a=a.a.clone(),o.b=a.b.clone(),o.c=a.c.clone(),n.vertexNormals.push(o);if(void 0!==h[r].faceNormals)for(n.faceNormals=[],s=0,i=h[r].faceNormals.length;s<i;s++)n.faceNormals.push(h[r].faceNormals[s].clone());this.morphNormals.push(n)}for(r=0,e=(s=t.skinWeights).length;r<e;r++)this.skinWeights.push(s[r].clone());for(r=0,e=(s=t.skinIndices).length;r<e;r++)this.skinIndices.push(s[r].clone());for(r=0,e=(s=t.lineDistances).length;r<e;r++)this.lineDistances.push(s[r]);return null!==(r=t.boundingBox)&&(this.boundingBox=r.clone()),null!==(r=t.boundingSphere)&&(this.boundingSphere=r.clone()),this.elementsNeedUpdate=t.elementsNeedUpdate,this.verticesNeedUpdate=t.verticesNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.lineDistancesNeedUpdate=t.lineDistancesNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(P.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(P.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setArray:function(t){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");return this.count=void 0!==t?t.length/this.itemSize:0,this.array=t,this},setDynamic:function(t){return this.dynamic=t,this},copy:function(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.dynamic=t.dynamic,this},copyAt:function(t,e,i){t*=this.itemSize,i*=e.itemSize;for(var n=0,s=this.itemSize;n<s;n++)this.array[t+n]=e.array[i+n];return this},copyArray:function(t){return this.array.set(t),this},copyColorsArray:function(t){for(var e=this.array,i=0,n=0,s=t.length;n<s;n++){var r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),r=new b),e[i++]=r.r,e[i++]=r.g,e[i++]=r.b}return this},copyVector2sArray:function(t){for(var e=this.array,n=0,s=0,r=t.length;s<r;s++){var a=t[s];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",s),a=new i),e[n++]=a.x,e[n++]=a.y}return this},copyVector3sArray:function(t){for(var e=this.array,i=0,n=0,r=t.length;n<r;n++){var a=t[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),a=new s),e[i++]=a.x,e[i++]=a.y,e[i++]=a.z}return this},copyVector4sArray:function(t){for(var e=this.array,i=0,n=0,s=t.length;n<s;n++){var r=t[n];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),r=new o),e[i++]=r.x,e[i++]=r.y,e[i++]=r.z,e[i++]=r.w}return this},set:function(t,e){return void 0===e&&(e=0),this.array.set(t,e),this},getX:function(t){return this.array[t*this.itemSize]},setX:function(t,e){return this.array[t*this.itemSize]=e,this},getY:function(t){return this.array[t*this.itemSize+1]},setY:function(t,e){return this.array[t*this.itemSize+1]=e,this},getZ:function(t){return this.array[t*this.itemSize+2]},setZ:function(t,e){return this.array[t*this.itemSize+2]=e,this},getW:function(t){return this.array[t*this.itemSize+3]},setW:function(t,e){return this.array[t*this.itemSize+3]=e,this},setXY:function(t,e,i){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this},setXYZ:function(t,e,i,n){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this},setXYZW:function(t,e,i,n,s){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this.array[t+3]=s,this},onUpload:function(t){return this.onUploadCallback=t,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)},toJSON:function(){return{itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized}}}),_.prototype=Object.create(P.prototype),_.prototype.constructor=_,A.prototype=Object.create(P.prototype),A.prototype.constructor=A,L.prototype=Object.create(P.prototype),L.prototype.constructor=L,R.prototype=Object.create(P.prototype),R.prototype.constructor=R,I.prototype=Object.create(P.prototype),I.prototype.constructor=I,O.prototype=Object.create(P.prototype),O.prototype.constructor=O,D.prototype=Object.create(P.prototype),D.prototype.constructor=D,k.prototype=Object.create(P.prototype),k.prototype.constructor=k,B.prototype=Object.create(P.prototype),B.prototype.constructor=B,Object.assign(H.prototype,{computeGroups:function(t){var e=[],i=void 0;t=t.faces;for(var n=0;n<t.length;n++){var s=t[n];if(s.materialIndex!==i){i=s.materialIndex,void 0!==r&&(r.count=3*n-r.start,e.push(r));var r={start:3*n,materialIndex:i}}}void 0!==r&&(r.count=3*n-r.start,e.push(r)),this.groups=e},fromGeometry:function(t){var e=t.faces,n=t.vertices,s=t.faceVertexUvs,r=s[0]&&0<s[0].length,a=s[1]&&0<s[1].length,o=t.morphTargets,l=o.length;if(0<l){for(var h=[],c=0;c<l;c++)h[c]={name:o[c].name,data:[]};this.morphTargets.position=h}var u=t.morphNormals,d=u.length;if(0<d){var p=[];for(c=0;c<d;c++)p[c]={name:u[c].name,data:[]};this.morphTargets.normal=p}var m=t.skinIndices,f=t.skinWeights,g=m.length===n.length,y=f.length===n.length;for(0<n.length&&0===e.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported."),c=0;c<e.length;c++){var v=e[c];this.vertices.push(n[v.a],n[v.b],n[v.c]);var b=v.vertexNormals;for(3===b.length?this.normals.push(b[0],b[1],b[2]):(b=v.normal,this.normals.push(b,b,b)),3===(b=v.vertexColors).length?this.colors.push(b[0],b[1],b[2]):(b=v.color,this.colors.push(b,b,b)),!0===r&&(void 0!==(b=s[0][c])?this.uvs.push(b[0],b[1],b[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",c),this.uvs.push(new i,new i,new i))),!0===a&&(void 0!==(b=s[1][c])?this.uvs2.push(b[0],b[1],b[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",c),this.uvs2.push(new i,new i,new i))),b=0;b<l;b++){var w=o[b].vertices;h[b].data.push(w[v.a],w[v.b],w[v.c])}for(b=0;b<d;b++)w=u[b].vertexNormals[c],p[b].data.push(w.a,w.b,w.c);g&&this.skinIndices.push(m[v.a],m[v.b],m[v.c]),y&&this.skinWeights.push(f[v.a],f[v.b],f[v.c])}return this.computeGroups(t),this.verticesNeedUpdate=t.verticesNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,this}});var ar=1;F.prototype=Object.assign(Object.create(e.prototype),{constructor:F,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(t){Array.isArray(t)?this.index=new(65535<N(t)?D:I)(t,1):this.index=t},addAttribute:function(t,e,i){return e&&e.isBufferAttribute||e&&e.isInterleavedBufferAttribute?"index"===t?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(e),this):(this.attributes[t]=e,this):(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.addAttribute(t,new P(e,i)))},getAttribute:function(t){return this.attributes[t]},removeAttribute:function(t){return delete this.attributes[t],this},addGroup:function(t,e,i){this.groups.push({start:t,count:e,materialIndex:void 0!==i?i:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(t,e){this.drawRange.start=t,this.drawRange.count=e},applyMatrix:function(t){var e=this.attributes.position;void 0!==e&&(t.applyToBufferAttribute(e),e.needsUpdate=!0);var i=this.attributes.normal;return void 0!==i&&((e=(new r).getNormalMatrix(t)).applyToBufferAttribute(i),i.needsUpdate=!0),void 0!==(i=this.attributes.tangent)&&((e=(new r).getNormalMatrix(t)).applyToBufferAttribute(i),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var t=new g;return function(e){return t.makeRotationX(e),this.applyMatrix(t),this}}(),rotateY:function(){var t=new g;return function(e){return t.makeRotationY(e),this.applyMatrix(t),this}}(),rotateZ:function(){var t=new g;return function(e){return t.makeRotationZ(e),this.applyMatrix(t),this}}(),translate:function(){var t=new g;return function(e,i,n){return t.makeTranslation(e,i,n),this.applyMatrix(t),this}}(),scale:function(){var t=new g;return function(e,i,n){return t.makeScale(e,i,n),this.applyMatrix(t),this}}(),lookAt:function(){var t=new T;return function(e){t.lookAt(e),t.updateMatrix(),this.applyMatrix(t.matrix)}}(),center:function(){var t=new s;return function(){return this.computeBoundingBox(),this.boundingBox.getCenter(t).negate(),this.translate(t.x,t.y,t.z),this}}(),setFromObject:function(t){var e=t.geometry;if(t.isPoints||t.isLine){t=new k(3*e.vertices.length,3);var i=new k(3*e.colors.length,3);this.addAttribute("position",t.copyVector3sArray(e.vertices)),this.addAttribute("color",i.copyColorsArray(e.colors)),e.lineDistances&&e.lineDistances.length===e.vertices.length&&(t=new k(e.lineDistances.length,1),this.addAttribute("lineDistance",t.copyArray(e.lineDistances))),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone())}else t.isMesh&&e&&e.isGeometry&&this.fromGeometry(e);return this},setFromPoints:function(t){for(var e=[],i=0,n=t.length;i<n;i++){var s=t[i];e.push(s.x,s.y,s.z||0)}return this.addAttribute("position",new k(e,3)),this},updateFromObject:function(t){var e=t.geometry;if(t.isMesh){var i=e.__directGeometry;if(!0===e.elementsNeedUpdate&&(i=void 0,e.elementsNeedUpdate=!1),void 0===i)return this.fromGeometry(e);i.verticesNeedUpdate=e.verticesNeedUpdate,i.normalsNeedUpdate=e.normalsNeedUpdate,i.colorsNeedUpdate=e.colorsNeedUpdate,i.uvsNeedUpdate=e.uvsNeedUpdate,i.groupsNeedUpdate=e.groupsNeedUpdate,e.verticesNeedUpdate=!1,e.normalsNeedUpdate=!1,e.colorsNeedUpdate=!1,e.uvsNeedUpdate=!1,e.groupsNeedUpdate=!1,e=i}return!0===e.verticesNeedUpdate&&(void 0!==(i=this.attributes.position)&&(i.copyVector3sArray(e.vertices),i.needsUpdate=!0),e.verticesNeedUpdate=!1),!0===e.normalsNeedUpdate&&(void 0!==(i=this.attributes.normal)&&(i.copyVector3sArray(e.normals),i.needsUpdate=!0),e.normalsNeedUpdate=!1),!0===e.colorsNeedUpdate&&(void 0!==(i=this.attributes.color)&&(i.copyColorsArray(e.colors),i.needsUpdate=!0),e.colorsNeedUpdate=!1),e.uvsNeedUpdate&&(void 0!==(i=this.attributes.uv)&&(i.copyVector2sArray(e.uvs),i.needsUpdate=!0),e.uvsNeedUpdate=!1),e.lineDistancesNeedUpdate&&(void 0!==(i=this.attributes.lineDistance)&&(i.copyArray(e.lineDistances),i.needsUpdate=!0),e.lineDistancesNeedUpdate=!1),e.groupsNeedUpdate&&(e.computeGroups(t.geometry),this.groups=e.groups,e.groupsNeedUpdate=!1),this},fromGeometry:function(t){return t.__directGeometry=(new H).fromGeometry(t),this.fromDirectGeometry(t.__directGeometry)},fromDirectGeometry:function(t){var e=new Float32Array(3*t.vertices.length);for(var i in this.addAttribute("position",new P(e,3).copyVector3sArray(t.vertices)),0<t.normals.length&&(e=new Float32Array(3*t.normals.length),this.addAttribute("normal",new P(e,3).copyVector3sArray(t.normals))),0<t.colors.length&&(e=new Float32Array(3*t.colors.length),this.addAttribute("color",new P(e,3).copyColorsArray(t.colors))),0<t.uvs.length&&(e=new Float32Array(2*t.uvs.length),this.addAttribute("uv",new P(e,2).copyVector2sArray(t.uvs))),0<t.uvs2.length&&(e=new Float32Array(2*t.uvs2.length),this.addAttribute("uv2",new P(e,2).copyVector2sArray(t.uvs2))),this.groups=t.groups,t.morphTargets){e=[];for(var n=t.morphTargets[i],s=0,r=n.length;s<r;s++){var a=n[s],o=new k(3*a.data.length,3);o.name=a.name,e.push(o.copyVector3sArray(a.data))}this.morphAttributes[i]=e}return 0<t.skinIndices.length&&(i=new k(4*t.skinIndices.length,4),this.addAttribute("skinIndex",i.copyVector4sArray(t.skinIndices))),0<t.skinWeights.length&&(i=new k(4*t.skinWeights.length,4),this.addAttribute("skinWeight",i.copyVector4sArray(t.skinWeights))),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),this},computeBoundingBox:function(){var t=new d;return function(){null===this.boundingBox&&(this.boundingBox=new d);var e=this.attributes.position,i=this.morphAttributes.position;if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),i){e=0;for(var n=i.length;e<n;e++)t.setFromBufferAttribute(i[e]),this.boundingBox.expandByPoint(t.min),this.boundingBox.expandByPoint(t.max)}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}}(),computeBoundingSphere:function(){var t=new d,e=new d,i=new s;return function(){null===this.boundingSphere&&(this.boundingSphere=new p);var n=this.attributes.position,s=this.morphAttributes.position;if(n){var r=this.boundingSphere.center;if(t.setFromBufferAttribute(n),s)for(var a=0,o=s.length;a<o;a++){var l=s[a];e.setFromBufferAttribute(l),t.expandByPoint(e.min),t.expandByPoint(e.max)}t.getCenter(r);var h=0;for(a=0,o=n.count;a<o;a++)i.fromBufferAttribute(n,a),h=Math.max(h,r.distanceToSquared(i));if(s)for(a=0,o=s.length;a<o;a++){n=0;for(var c=(l=s[a]).count;n<c;n++)i.fromBufferAttribute(l,n),h=Math.max(h,r.distanceToSquared(i))}this.boundingSphere.radius=Math.sqrt(h),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var t=this.index,e=this.attributes;if(e.position){var i=e.position.array;if(void 0===e.normal)this.addAttribute("normal",new P(new Float32Array(i.length),3));else for(var n=e.normal.array,r=0,a=n.length;r<a;r++)n[r]=0;n=e.normal.array;var o=new s,l=new s,h=new s,c=new s,u=new s;if(t){var d=t.array;for(r=0,a=t.count;r<a;r+=3){t=3*d[r+0];var p=3*d[r+1],m=3*d[r+2];o.fromArray(i,t),l.fromArray(i,p),h.fromArray(i,m),c.subVectors(h,l),u.subVectors(o,l),c.cross(u),n[t]+=c.x,n[t+1]+=c.y,n[t+2]+=c.z,n[p]+=c.x,n[p+1]+=c.y,n[p+2]+=c.z,n[m]+=c.x,n[m+1]+=c.y,n[m+2]+=c.z}}else for(r=0,a=i.length;r<a;r+=9)o.fromArray(i,r),l.fromArray(i,r+3),h.fromArray(i,r+6),c.subVectors(h,l),u.subVectors(o,l),c.cross(u),n[r]=c.x,n[r+1]=c.y,n[r+2]=c.z,n[r+3]=c.x,n[r+4]=c.y,n[r+5]=c.z,n[r+6]=c.x,n[r+7]=c.y,n[r+8]=c.z;this.normalizeNormals(),e.normal.needsUpdate=!0}},merge:function(t,e){if(t&&t.isBufferGeometry){void 0===e&&(e=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));var i,n=this.attributes;for(i in n)if(void 0!==t.attributes[i]){var s=n[i].array,r=t.attributes[i],a=r.array,o=r.itemSize*e;r=Math.min(a.length,s.length-o);for(var l=0;l<r;l++,o++)s[o]=a[l]}return this}console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",t)},normalizeNormals:function(){var t=new s;return function(){for(var e=this.attributes.normal,i=0,n=e.count;i<n;i++)t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.normalize(),e.setXYZ(i,t.x,t.y,t.z)}}(),toNonIndexed:function(){function t(t,e){var i=t.array;t=t.itemSize;for(var n,s=new i.constructor(e.length*t),r=0,a=0,o=e.length;a<o;a++){n=e[a]*t;for(var l=0;l<t;l++)s[r++]=i[n++]}return new P(s,t)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var e,i=new F,n=this.index.array,s=this.attributes;for(e in s){var r=s[e];r=t(r,n),i.addAttribute(e,r)}var a=this.morphAttributes;for(e in a){var o=[],l=a[e];s=0;for(var h=l.length;s<h;s++)r=t(r=l[s],n),o.push(r);i.morphAttributes[e]=o}for(s=0,e=(n=this.groups).length;s<e;s++)r=n[s],i.addGroup(r.start,r.count,r.materialIndex);return i},toJSON:function(){var t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),0<Object.keys(this.userData).length&&(t.userData=this.userData),void 0!==this.parameters){var e=this.parameters;for(h in e)void 0!==e[h]&&(t[h]=e[h]);return t}t.data={attributes:{}},null!==(e=this.index)&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});var i=this.attributes;for(h in i){var n=(e=i[h]).toJSON();""!==e.name&&(n.name=e.name),t.data.attributes[h]=n}i={};var s=!1;for(h in this.morphAttributes){for(var r=this.morphAttributes[h],a=[],o=0,l=r.length;o<l;o++)n=(e=r[o]).toJSON(),""!==e.name&&(n.name=e.name),a.push(n);0<a.length&&(i[h]=a,s=!0)}s&&(t.data.morphAttributes=i);var h=this.groups;return 0<h.length&&(t.data.groups=JSON.parse(JSON.stringify(h))),null!==(h=this.boundingSphere)&&(t.data.boundingSphere={center:h.center.toArray(),radius:h.radius}),t},clone:function(){return(new F).copy(this)},copy:function(t){var e;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingSphere=this.boundingBox=null,this.name=t.name;var i=t.index;for(a in null!==i&&this.setIndex(i.clone()),i=t.attributes)this.addAttribute(a,i[a].clone());var n=t.morphAttributes;for(a in n){var s=[],r=n[a];for(i=0,e=r.length;i<e;i++)s.push(r[i].clone());this.morphAttributes[a]=s}var a=t.groups;for(i=0,e=a.length;i<e;i++)n=a[i],this.addGroup(n.start,n.count,n.materialIndex);return null!==(a=t.boundingBox)&&(this.boundingBox=a.clone()),null!==(a=t.boundingSphere)&&(this.boundingSphere=a.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),V.prototype=Object.create(C.prototype),V.prototype.constructor=V,j.prototype=Object.create(F.prototype),j.prototype.constructor=j,G.prototype=Object.create(C.prototype),G.prototype.constructor=G,U.prototype=Object.create(F.prototype),U.prototype.constructor=U;var or=0;z.prototype=Object.assign(Object.create(e.prototype),{constructor:z,isMaterial:!0,onBeforeCompile:function(){},setValues:function(t){if(void 0!==t)for(var e in t){var i=t[e];if(void 0===i)console.warn("THREE.Material: '"+e+"' parameter is undefined.");else if("shading"===e)console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===i;else{var n=this[e];void 0===n?console.warn("THREE."+this.type+": '"+e+"' is not a property of this material."):n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[e]=i}}},toJSON:function(t){function e(t){var e,i=[];for(e in t){var n=t[e];delete n.metadata,i.push(n)}return i}var i=void 0===t||"string"==typeof t;i&&(t={textures:{},images:{}});var n={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};return n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearCoat&&(n.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(n.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(t).uuid),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(t).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(t).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(t).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(t).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(t).uuid,n.reflectivity=this.reflectivity,void 0!==this.combine&&(n.combine=this.combine),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.size&&(n.size=this.size),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(n.blending=this.blending),!0===this.flatShading&&(n.flatShading=this.flatShading),0!==this.side&&(n.side=this.side),0!==this.vertexColors&&(n.vertexColors=this.vertexColors),1>this.opacity&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=this.transparent),n.depthFunc=this.depthFunc,n.depthTest=this.depthTest,n.depthWrite=this.depthWrite,0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),0<this.alphaTest&&(n.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(n.wireframe=this.wireframe),1<this.wireframeLinewidth&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(n.morphTargets=!0),!0===this.skinning&&(n.skinning=!0),!1===this.visible&&(n.visible=!1),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),i&&(i=e(t.textures),t=e(t.images),0<i.length&&(n.textures=i),0<t.length&&(n.images=t)),n},clone:function(){return(new this.constructor).copy(this)},copy:function(t){this.name=t.name,this.fog=t.fog,this.lights=t.lights,this.blending=t.blending,this.side=t.side,this.flatShading=t.flatShading,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.premultipliedAlpha=t.premultipliedAlpha,this.visible=t.visible,this.userData=JSON.parse(JSON.stringify(t.userData)),this.clipShadows=t.clipShadows,this.clipIntersection=t.clipIntersection;var e=t.clippingPlanes,i=null;if(null!==e){var n=e.length;i=Array(n);for(var s=0;s!==n;++s)i[s]=e[s].clone()}return this.clippingPlanes=i,this.shadowSide=t.shadowSide,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),W.prototype=Object.create(z.prototype),W.prototype.constructor=W,W.prototype.isShaderMaterial=!0,W.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=y(t.uniforms),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.lights=t.lights,this.clipping=t.clipping,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.extensions=t.extensions,this},W.prototype.toJSON=function(t){var e=z.prototype.toJSON.call(this,t);for(var i in e.uniforms={},this.uniforms){var n=this.uniforms[i].value;e.uniforms[i]=n&&n.isTexture?{type:"t",value:n.toJSON(t).uuid}:n&&n.isColor?{type:"c",value:n.getHex()}:n&&n.isVector2?{type:"v2",value:n.toArray()}:n&&n.isVector3?{type:"v3",value:n.toArray()}:n&&n.isVector4?{type:"v4",value:n.toArray()}:n&&n.isMatrix3?{type:"m3",value:n.toArray()}:n&&n.isMatrix4?{type:"m4",value:n.toArray()}:{value:n}}for(var s in 0<Object.keys(this.defines).length&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,t={},this.extensions)!0===this.extensions[s]&&(t[s]=!0);return 0<Object.keys(t).length&&(e.extensions=t),e},Object.assign(q.prototype,{set:function(t,e){return this.origin.copy(t),this.direction.copy(e),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this},at:function(t,e){return void 0===e&&(console.warn("THREE.Ray: .at() target is now required"),e=new s),e.copy(this.direction).multiplyScalar(t).add(this.origin)},lookAt:function(t){return this.direction.copy(t).sub(this.origin).normalize(),this},recast:function(){var t=new s;return function(e){return this.origin.copy(this.at(e,t)),this}}(),closestPointToPoint:function(t,e){return void 0===e&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),e=new s),e.subVectors(t,this.origin),0>(t=e.dot(this.direction))?e.copy(this.origin):e.copy(this.direction).multiplyScalar(t).add(this.origin)},distanceToPoint:function(t){return Math.sqrt(this.distanceSqToPoint(t))},distanceSqToPoint:function(){var t=new s;return function(e){var i=t.subVectors(e,this.origin).dot(this.direction);return 0>i?this.origin.distanceToSquared(e):(t.copy(this.direction).multiplyScalar(i).add(this.origin),t.distanceToSquared(e))}}(),distanceSqToSegment:function(){var t=new s,e=new s,i=new s;return function(n,s,r,a){t.copy(n).add(s).multiplyScalar(.5),e.copy(s).sub(n).normalize(),i.copy(this.origin).sub(t);var o=.5*n.distanceTo(s),l=-this.direction.dot(e),h=i.dot(this.direction),c=-i.dot(e),u=i.lengthSq(),d=Math.abs(1-l*l);if(0<d){s=l*h-c;var p=o*d;0<=(n=l*c-h)?s>=-p?s<=p?l=(n*=o=1/d)*(n+l*(s*=o)+2*h)+s*(l*n+s+2*c)+u:(s=o,l=-(n=Math.max(0,-(l*s+h)))*n+s*(s+2*c)+u):(s=-o,l=-(n=Math.max(0,-(l*s+h)))*n+s*(s+2*c)+u):s<=-p?l=-(n=Math.max(0,-(-l*o+h)))*n+(s=0<n?-o:Math.min(Math.max(-o,-c),o))*(s+2*c)+u:s<=p?(n=0,l=(s=Math.min(Math.max(-o,-c),o))*(s+2*c)+u):l=-(n=Math.max(0,-(l*o+h)))*n+(s=0<n?o:Math.min(Math.max(-o,-c),o))*(s+2*c)+u}else s=0<l?-o:o,l=-(n=Math.max(0,-(l*s+h)))*n+s*(s+2*c)+u;return r&&r.copy(this.direction).multiplyScalar(n).add(this.origin),a&&a.copy(e).multiplyScalar(s).add(t),l}}(),intersectSphere:function(){var t=new s;return function(e,i){t.subVectors(e.center,this.origin);var n=t.dot(this.direction),s=t.dot(t)-n*n;return s>(e=e.radius*e.radius)?null:(s=n-(e=Math.sqrt(e-s)),n+=e,0>s&&0>n?null:0>s?this.at(n,i):this.at(s,i))}}(),intersectsSphere:function(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius},distanceToPlane:function(t){var e=t.normal.dot(this.direction);return 0===e?0===t.distanceToPoint(this.origin)?0:null:0<=(t=-(this.origin.dot(t.normal)+t.constant)/e)?t:null},intersectPlane:function(t,e){return null===(t=this.distanceToPlane(t))?null:this.at(t,e)},intersectsPlane:function(t){var e=t.distanceToPoint(this.origin);return 0===e||0>t.normal.dot(this.direction)*e},intersectBox:function(t,e){var i=1/this.direction.x,n=1/this.direction.y,s=1/this.direction.z,r=this.origin;if(0<=i){var a=(t.min.x-r.x)*i;i*=t.max.x-r.x}else a=(t.max.x-r.x)*i,i*=t.min.x-r.x;if(0<=n){var o=(t.min.y-r.y)*n;n*=t.max.y-r.y}else o=(t.max.y-r.y)*n,n*=t.min.y-r.y;return a>n||o>i?null:((o>a||a!=a)&&(a=o),(n<i||i!=i)&&(i=n),0<=s?(o=(t.min.z-r.z)*s,t=(t.max.z-r.z)*s):(o=(t.max.z-r.z)*s,t=(t.min.z-r.z)*s),a>t||o>i?null:((o>a||a!=a)&&(a=o),(t<i||i!=i)&&(i=t),0>i?null:this.at(0<=a?a:i,e)))},intersectsBox:function(){var t=new s;return function(e){return null!==this.intersectBox(e,t)}}(),intersectTriangle:function(){var t=new s,e=new s,i=new s,n=new s;return function(s,r,a,o,l){if(e.subVectors(r,s),i.subVectors(a,s),n.crossVectors(e,i),0<(r=this.direction.dot(n))){if(o)return null;o=1}else{if(!(0>r))return null;o=-1,r=-r}return t.subVectors(this.origin,s),0>(s=o*this.direction.dot(i.crossVectors(t,i)))?null:0>(a=o*this.direction.dot(e.cross(t)))||s+a>r?null:0>(s=-o*t.dot(n))?null:this.at(s/r,l)}}(),applyMatrix4:function(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this},equals:function(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}}),Object.assign(Y,{getNormal:function(){var t=new s;return function(e,i,n,r){return void 0===r&&(console.warn("THREE.Triangle: .getNormal() target is now required"),r=new s),r.subVectors(n,i),t.subVectors(e,i),r.cross(t),0<(e=r.lengthSq())?r.multiplyScalar(1/Math.sqrt(e)):r.set(0,0,0)}}(),getBarycoord:function(){var t=new s,e=new s,i=new s;return function(n,r,a,o,l){t.subVectors(o,r),e.subVectors(a,r),i.subVectors(n,r),n=t.dot(t),r=t.dot(e),a=t.dot(i);var h=e.dot(e);o=e.dot(i);var c=n*h-r*r;return void 0===l&&(console.warn("THREE.Triangle: .getBarycoord() target is now required"),l=new s),0===c?l.set(-2,-1,-1):(h=(h*a-r*o)*(c=1/c),n=(n*o-r*a)*c,l.set(1-h-n,n,h))}}(),containsPoint:function(){var t=new s;return function(e,i,n,s){return Y.getBarycoord(e,i,n,s,t),0<=t.x&&0<=t.y&&1>=t.x+t.y}}(),getUV:function(){var t=new s;return function(e,i,n,s,r,a,o,l){return this.getBarycoord(e,i,n,s,t),l.set(0,0),l.addScaledVector(r,t.x),l.addScaledVector(a,t.y),l.addScaledVector(o,t.z),l}}(),isFrontFacing:function(){var t=new s,e=new s;return function(i,n,s,r){return t.subVectors(s,n),e.subVectors(i,n),0>t.cross(e).dot(r)}}()}),Object.assign(Y.prototype,{set:function(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this},setFromPointsAndIndices:function(t,e,i,n){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[n]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this},getArea:function(){var t=new s,e=new s;return function(){return t.subVectors(this.c,this.b),e.subVectors(this.a,this.b),.5*t.cross(e).length()}}(),getMidpoint:function(t){return void 0===t&&(console.warn("THREE.Triangle: .getMidpoint() target is now required"),t=new s),t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},getNormal:function(t){return Y.getNormal(this.a,this.b,this.c,t)},getPlane:function(t){return void 0===t&&(console.warn("THREE.Triangle: .getPlane() target is now required"),t=new s),t.setFromCoplanarPoints(this.a,this.b,this.c)},getBarycoord:function(t,e){return Y.getBarycoord(t,this.a,this.b,this.c,e)},getUV:function(t,e,i,n,s){return Y.getUV(t,this.a,this.b,this.c,e,i,n,s)},containsPoint:function(t){return Y.containsPoint(t,this.a,this.b,this.c)},isFrontFacing:function(t){return Y.isFrontFacing(this.a,this.b,this.c,t)},intersectsBox:function(t){return t.intersectsTriangle(this)},closestPointToPoint:function(){var t=new s,e=new s,i=new s,n=new s,r=new s,a=new s;return function(o,l){void 0===l&&(console.warn("THREE.Triangle: .closestPointToPoint() target is now required"),l=new s);var h=this.a,c=this.b,u=this.c;t.subVectors(c,h),e.subVectors(u,h),n.subVectors(o,h);var d=t.dot(n),p=e.dot(n);if(0>=d&&0>=p)return l.copy(h);r.subVectors(o,c);var m=t.dot(r),f=e.dot(r);if(0<=m&&f<=m)return l.copy(c);var g=d*f-m*p;if(0>=g&&0<=d&&0>=m)return c=d/(d-m),l.copy(h).addScaledVector(t,c);a.subVectors(o,u),o=t.dot(a);var y=e.dot(a);return 0<=y&&o<=y?l.copy(u):0>=(d=o*p-d*y)&&0<=p&&0>=y?(g=p/(p-y),l.copy(h).addScaledVector(e,g)):0>=(p=m*y-o*f)&&0<=f-m&&0<=o-y?(i.subVectors(u,c),g=(f-m)/(f-m+(o-y)),l.copy(c).addScaledVector(i,g)):(c=d*(u=1/(p+d+g)),g*=u,l.copy(h).addScaledVector(t,c).addScaledVector(e,g))}}(),equals:function(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}),X.prototype=Object.create(z.prototype),X.prototype.constructor=X,X.prototype.isMeshBasicMaterial=!0,X.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this},J.prototype=Object.assign(Object.create(T.prototype),{constructor:J,isMesh:!0,setDrawMode:function(t){this.drawMode=t},copy:function(t){return T.prototype.copy.call(this,t),this.drawMode=t.drawMode,void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this},updateMorphTargets:function(){var t=this.geometry;if(t.isBufferGeometry){t=t.morphAttributes;var e=Object.keys(t);if(0<e.length){var i=t[e[0]];if(void 0!==i)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},t=0,e=i.length;t<e;t++){var n=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[n]=t}}}else void 0!==(t=t.morphTargets)&&0<t.length&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")},raycast:function(){function t(t,e,i,n,s,r,a,o){return null===(1===e.side?n.intersectTriangle(a,r,s,!0,o):n.intersectTriangle(s,r,a,2!==e.side,o))?null:(E.copy(o),E.applyMatrix4(t.matrixWorld),(e=i.ray.origin.distanceTo(E))<i.near||e>i.far?null:{distance:e,point:E.clone(),object:t})}function e(e,n,s,r,a,p,g,E,M,T){if(o.fromBufferAttribute(a,E),l.fromBufferAttribute(a,M),h.fromBufferAttribute(a,T),a=e.morphTargetInfluences,n.morphTargets&&p&&a){m.set(0,0,0),f.set(0,0,0),y.set(0,0,0);for(var C=0,P=p.length;C<P;C++){var _=a[C],A=p[C];0!==_&&(c.fromBufferAttribute(A,E),u.fromBufferAttribute(A,M),d.fromBufferAttribute(A,T),m.addScaledVector(c.sub(o),_),f.addScaledVector(u.sub(l),_),y.addScaledVector(d.sub(h),_))}o.add(m),l.add(f),h.add(y)}return(e=t(e,n,s,r,o,l,h,x))&&(g&&(v.fromBufferAttribute(g,E),b.fromBufferAttribute(g,M),w.fromBufferAttribute(g,T),e.uv=Y.getUV(x,o,l,h,v,b,w,new i)),g=new S(E,M,T),Y.getNormal(o,l,h,g.normal),e.face=g),e}var n=new g,r=new q,a=new p,o=new s,l=new s,h=new s,c=new s,u=new s,d=new s,m=new s,f=new s,y=new s,v=new i,b=new i,w=new i,x=new s,E=new s;return function(s,o){var l=this.geometry,h=this.material,c=this.matrixWorld;if(void 0!==h&&(null===l.boundingSphere&&l.computeBoundingSphere(),a.copy(l.boundingSphere),a.applyMatrix4(c),!1!==s.ray.intersectsSphere(a)&&(n.getInverse(c),r.copy(s.ray).applyMatrix4(n),null===l.boundingBox||!1!==r.intersectsBox(l.boundingBox))))if(l.isBufferGeometry){var u=l.index;c=l.attributes.position;var d,p,m=l.morphAttributes.position,f=l.attributes.uv,g=l.groups,y=l.drawRange;if(null!==u)if(Array.isArray(h)){var S=0;for(d=g.length;S<d;S++){var E=g[S],M=h[E.materialIndex],T=Math.max(E.start,y.start);for(p=l=Math.min(E.start+E.count,y.start+y.count);T<p;T+=3){l=u.getX(T);var C=u.getX(T+1),P=u.getX(T+2);(l=e(this,M,s,r,c,m,f,l,C,P))&&(l.faceIndex=Math.floor(T/3),l.face.materialIndex=E.materialIndex,o.push(l))}}}else for(S=T=Math.max(0,y.start),d=l=Math.min(u.count,y.start+y.count);S<d;S+=3)l=u.getX(S),C=u.getX(S+1),P=u.getX(S+2),(l=e(this,h,s,r,c,m,f,l,C,P))&&(l.faceIndex=Math.floor(S/3),o.push(l));else if(void 0!==c)if(Array.isArray(h))for(S=0,d=g.length;S<d;S++)for(M=h[(E=g[S]).materialIndex],T=Math.max(E.start,y.start),p=l=Math.min(E.start+E.count,y.start+y.count);T<p;T+=3)(l=e(this,M,s,r,c,m,f,l=T,C=T+1,P=T+2))&&(l.faceIndex=Math.floor(T/3),l.face.materialIndex=E.materialIndex,o.push(l));else for(S=T=Math.max(0,y.start),d=l=Math.min(c.count,y.start+y.count);S<d;S+=3)(l=e(this,h,s,r,c,m,f,l=S,C=S+1,P=S+2))&&(l.faceIndex=Math.floor(S/3),o.push(l))}else if(l.isGeometry)for(c=Array.isArray(h),m=l.vertices,f=l.faces,0<(l=l.faceVertexUvs[0]).length&&(u=l),d=0,E=f.length;d<E;d++)M=f[d],void 0!==(l=c?h[M.materialIndex]:h)&&(g=m[M.a],y=m[M.b],S=m[M.c],l=t(this,l,s,r,g,y,S,x))&&(u&&u[d]&&(T=u[d],v.copy(T[0]),b.copy(T[1]),w.copy(T[2]),l.uv=Y.getUV(x,g,y,S,v,b,w,new i)),l.face=M,l.faceIndex=d,o.push(l))}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),tt.prototype=Object.create(a.prototype),tt.prototype.constructor=tt,tt.prototype.isCubeTexture=!0,Object.defineProperty(tt.prototype,"images",{get:function(){return this.image},set:function(t){this.image=t}}),et.prototype=Object.create(a.prototype),et.prototype.constructor=et,et.prototype.isDataTexture2DArray=!0,it.prototype=Object.create(a.prototype),it.prototype.constructor=it,it.prototype.isDataTexture3D=!0;var lr=new a,hr=new et,cr=new it,ur=new tt,dr=[],pr=[],mr=new Float32Array(16),fr=new Float32Array(9),gr=new Float32Array(4);Bt.prototype.updateCache=function(t){var e=this.cache;t instanceof Float32Array&&e.length!==t.length&&(this.cache=new Float32Array(t.length)),rt(e,t)},Ht.prototype.setValue=function(t,e,i){for(var n=this.seq,s=0,r=n.length;s!==r;++s){var a=n[s];a.setValue(t,e[a.id],i)}};var yr=/([\w\d_]+)(\])?(\[|\.)?/g;Nt.prototype.setValue=function(t,e,i,n){void 0!==(e=this.map[e])&&e.setValue(t,i,n)},Nt.prototype.setOptional=function(t,e,i){void 0!==(e=e[i])&&this.setValue(t,i,e)},Nt.upload=function(t,e,i,n){for(var s=0,r=e.length;s!==r;++s){var a=e[s],o=i[a.id];!1!==o.needsUpdate&&a.setValue(t,o.value,n)}},Nt.seqWithValue=function(t,e){for(var i=[],n=0,s=t.length;n!==s;++n){var r=t[n];r.id in e&&i.push(r)}return i};var vr=0,br=0;$t.prototype=Object.create(z.prototype),$t.prototype.constructor=$t,$t.prototype.isMeshDepthMaterial=!0,$t.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.depthPacking=t.depthPacking,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this},te.prototype=Object.create(z.prototype),te.prototype.constructor=te,te.prototype.isMeshDistanceMaterial=!0,te.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this},ne.prototype=Object.assign(Object.create(T.prototype),{constructor:ne,isGroup:!0}),se.prototype=Object.assign(Object.create(T.prototype),{constructor:se,isCamera:!0,copy:function(t,e){return T.prototype.copy.call(this,t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Camera: .getWorldDirection() target is now required"),t=new s),this.updateMatrixWorld(!0);var e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()},updateMatrixWorld:function(t){T.prototype.updateMatrixWorld.call(this,t),this.matrixWorldInverse.getInverse(this.matrixWorld)},clone:function(){return(new this.constructor).copy(this)}}),re.prototype=Object.assign(Object.create(se.prototype),{constructor:re,isPerspectiveCamera:!0,copy:function(t,e){return se.prototype.copy.call(this,t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this},setFocalLength:function(t){t=.5*this.getFilmHeight()/t,this.fov=2*Js.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var t=Math.tan(.5*Js.DEG2RAD*this.fov);return.5*this.getFilmHeight()/t},getEffectiveFOV:function(){return 2*Js.RAD2DEG*Math.atan(Math.tan(.5*Js.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(t,e,i,n,s,r){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=s,this.view.height=r,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var t=this.near,e=t*Math.tan(.5*Js.DEG2RAD*this.fov)/this.zoom,i=2*e,n=this.aspect*i,s=-.5*n,r=this.view;if(null!==this.view&&this.view.enabled){var a=r.fullWidth,o=r.fullHeight;s+=r.offsetX*n/a,e-=r.offsetY*i/o,n*=r.width/a,i*=r.height/o}0!==(r=this.filmOffset)&&(s+=t*r/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+n,e,e-i,t,this.far),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},toJSON:function(t){return(t=T.prototype.toJSON.call(this,t)).object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),ae.prototype=Object.assign(Object.create(re.prototype),{constructor:ae,isArrayCamera:!0});var wr,xr=new s,Sr=new s;Object.assign(ue.prototype,{isFogExp2:!0,clone:function(){return new ue(this.color,this.density)},toJSON:function(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}}),Object.assign(de.prototype,{isFog:!0,clone:function(){return new de(this.color,this.near,this.far)},toJSON:function(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}),pe.prototype=Object.assign(Object.create(T.prototype),{constructor:pe,isScene:!0,copy:function(t,e){return T.prototype.copy.call(this,t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.fog&&(this.fog=t.fog.clone()),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.autoUpdate=t.autoUpdate,this.matrixAutoUpdate=t.matrixAutoUpdate,this},toJSON:function(t){var e=T.prototype.toJSON.call(this,t);return null!==this.background&&(e.object.background=this.background.toJSON(t)),null!==this.fog&&(e.object.fog=this.fog.toJSON()),e},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(me.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(me.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setArray:function(t){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");return this.count=void 0!==t?t.length/this.stride:0,this.array=t,this},setDynamic:function(t){return this.dynamic=t,this},copy:function(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.dynamic=t.dynamic,this},copyAt:function(t,e,i){t*=this.stride,i*=e.stride;for(var n=0,s=this.stride;n<s;n++)this.array[t+n]=e.array[i+n];return this},set:function(t,e){return void 0===e&&(e=0),this.array.set(t,e),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(t){return this.onUploadCallback=t,this}}),Object.defineProperties(fe.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(fe.prototype,{isInterleavedBufferAttribute:!0,setX:function(t,e){return this.data.array[t*this.data.stride+this.offset]=e,this},setY:function(t,e){return this.data.array[t*this.data.stride+this.offset+1]=e,this},setZ:function(t,e){return this.data.array[t*this.data.stride+this.offset+2]=e,this},setW:function(t,e){return this.data.array[t*this.data.stride+this.offset+3]=e,this},getX:function(t){return this.data.array[t*this.data.stride+this.offset]},getY:function(t){return this.data.array[t*this.data.stride+this.offset+1]},getZ:function(t){return this.data.array[t*this.data.stride+this.offset+2]},getW:function(t){return this.data.array[t*this.data.stride+this.offset+3]},setXY:function(t,e,i){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this},setXYZ:function(t,e,i,n){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this},setXYZW:function(t,e,i,n,s){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this.data.array[t+3]=s,this}}),ge.prototype=Object.create(z.prototype),ge.prototype.constructor=ge,ge.prototype.isSpriteMaterial=!0,ge.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.rotation=t.rotation,this.sizeAttenuation=t.sizeAttenuation,this},ye.prototype=Object.assign(Object.create(T.prototype),{constructor:ye,isSprite:!0,raycast:function(){function t(t,e,i,n,s,r){a.subVectors(t,i).addScalar(.5).multiply(n),void 0!==s?(o.x=r*a.x-s*a.y,o.y=s*a.x+r*a.y):o.copy(a),t.copy(e),t.x+=o.x,t.y+=o.y,t.applyMatrix4(l)}var e=new s,n=new s,r=new s,a=new i,o=new i,l=new g,h=new s,c=new s,u=new s,d=new i,p=new i,m=new i;return function(s,a){n.setFromMatrixScale(this.matrixWorld),l.getInverse(this.modelViewMatrix).premultiply(this.matrixWorld),r.setFromMatrixPosition(this.modelViewMatrix);var o=this.material.rotation;if(0!==o)var f=Math.cos(o),g=Math.sin(o);o=this.center,t(h.set(-.5,-.5,0),r,o,n,g,f),t(c.set(.5,-.5,0),r,o,n,g,f),t(u.set(.5,.5,0),r,o,n,g,f),d.set(0,0),p.set(1,0),m.set(1,1);var y=s.ray.intersectTriangle(h,c,u,!1,e);null===y&&(t(c.set(-.5,.5,0),r,o,n,g,f),p.set(0,1),null===(y=s.ray.intersectTriangle(h,u,c,!1,e)))||(g=s.ray.origin.distanceTo(e))<s.near||g>s.far||a.push({distance:g,point:e.clone(),uv:Y.getUV(e,h,c,u,d,p,m,new i),face:null,object:this})}}(),clone:function(){return new this.constructor(this.material).copy(this)},copy:function(t){return T.prototype.copy.call(this,t),void 0!==t.center&&this.center.copy(t.center),this}}),ve.prototype=Object.assign(Object.create(T.prototype),{constructor:ve,isLOD:!0,copy:function(t){T.prototype.copy.call(this,t,!1);for(var e=0,i=(t=t.levels).length;e<i;e++){var n=t[e];this.addLevel(n.object.clone(),n.distance)}return this},addLevel:function(t,e){void 0===e&&(e=0),e=Math.abs(e);for(var i=this.levels,n=0;n<i.length&&!(e<i[n].distance);n++);return i.splice(n,0,{distance:e,object:t}),this.add(t),this},getObjectForDistance:function(t){for(var e=this.levels,i=1,n=e.length;i<n&&!(t<e[i].distance);i++);return e[i-1].object},raycast:function(){var t=new s;return function(e,i){t.setFromMatrixPosition(this.matrixWorld);var n=e.ray.origin.distanceTo(t);this.getObjectForDistance(n).raycast(e,i)}}(),update:function(){var t=new s,e=new s;return function(i){var n=this.levels;if(1<n.length){t.setFromMatrixPosition(i.matrixWorld),e.setFromMatrixPosition(this.matrixWorld),i=t.distanceTo(e),n[0].object.visible=!0;for(var s=1,r=n.length;s<r&&i>=n[s].distance;s++)n[s-1].object.visible=!1,n[s].object.visible=!0;for(;s<r;s++)n[s].object.visible=!1}}}(),toJSON:function(t){(t=T.prototype.toJSON.call(this,t)).object.levels=[];for(var e=this.levels,i=0,n=e.length;i<n;i++){var s=e[i];t.object.levels.push({object:s.object.uuid,distance:s.distance})}return t}}),be.prototype=Object.assign(Object.create(J.prototype),{constructor:be,isSkinnedMesh:!0,bind:function(t,e){this.skeleton=t,void 0===e&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.getInverse(e)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){for(var t=new o,e=this.geometry.attributes.skinWeight,i=0,n=e.count;i<n;i++){t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.w=e.getW(i);var s=1/t.manhattanLength();1/0!==s?t.multiplyScalar(s):t.set(1,0,0,0),e.setXYZW(i,t.x,t.y,t.z,t.w)}},updateMatrixWorld:function(t){J.prototype.updateMatrixWorld.call(this,t),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Object.assign(we.prototype,{calculateInverses:function(){this.boneInverses=[];for(var t=0,e=this.bones.length;t<e;t++){var i=new g;this.bones[t]&&i.getInverse(this.bones[t].matrixWorld),this.boneInverses.push(i)}},pose:function(){var t,e,i=0;for(e=this.bones.length;i<e;i++)(t=this.bones[i])&&t.matrixWorld.getInverse(this.boneInverses[i]);for(i=0,e=this.bones.length;i<e;i++)(t=this.bones[i])&&(t.parent&&t.parent.isBone?(t.matrix.getInverse(t.parent.matrixWorld),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))},update:function(){var t=new g,e=new g;return function(){for(var i=this.bones,n=this.boneInverses,s=this.boneMatrices,r=this.boneTexture,a=0,o=i.length;a<o;a++)t.multiplyMatrices(i[a]?i[a].matrixWorld:e,n[a]),t.toArray(s,16*a);void 0!==r&&(r.needsUpdate=!0)}}(),clone:function(){return new we(this.bones,this.boneInverses)},getBoneByName:function(t){for(var e=0,i=this.bones.length;e<i;e++){var n=this.bones[e];if(n.name===t)return n}}}),xe.prototype=Object.assign(Object.create(T.prototype),{constructor:xe,isBone:!0}),Se.prototype=Object.create(z.prototype),Se.prototype.constructor=Se,Se.prototype.isLineBasicMaterial=!0,Se.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this},Ee.prototype=Object.assign(Object.create(T.prototype),{constructor:Ee,isLine:!0,computeLineDistances:function(){var t=new s,e=new s;return function(){var i=this.geometry;if(i.isBufferGeometry)if(null===i.index){for(var n=i.attributes.position,s=[0],r=1,a=n.count;r<a;r++)t.fromBufferAttribute(n,r-1),e.fromBufferAttribute(n,r),s[r]=s[r-1],s[r]+=t.distanceTo(e);i.addAttribute("lineDistance",new k(s,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(i.isGeometry)for(n=i.vertices,(s=i.lineDistances)[0]=0,r=1,a=n.length;r<a;r++)s[r]=s[r-1],s[r]+=n[r-1].distanceTo(n[r]);return this}}(),raycast:function(){var t=new g,e=new q,i=new p;return function(n,r){var a=n.linePrecision,o=this.geometry,l=this.matrixWorld;if(null===o.boundingSphere&&o.computeBoundingSphere(),i.copy(o.boundingSphere),i.applyMatrix4(l),i.radius+=a,!1!==n.ray.intersectsSphere(i)){t.getInverse(l),e.copy(n.ray).applyMatrix4(t),a/=(this.scale.x+this.scale.y+this.scale.z)/3,a*=a;var h=new s,c=new s;l=new s;var u=new s,d=this&&this.isLineSegments?2:1;if(o.isBufferGeometry){var p=o.index,m=o.attributes.position.array;if(null!==p){o=0;for(var f=(p=p.array).length-1;o<f;o+=d){var g=p[o+1];h.fromArray(m,3*p[o]),c.fromArray(m,3*g),(g=e.distanceSqToSegment(h,c,u,l))>a||(u.applyMatrix4(this.matrixWorld),(g=n.ray.origin.distanceTo(u))<n.near||g>n.far||r.push({distance:g,point:l.clone().applyMatrix4(this.matrixWorld),index:o,face:null,faceIndex:null,object:this}))}}else for(o=0,f=m.length/3-1;o<f;o+=d)h.fromArray(m,3*o),c.fromArray(m,3*o+3),(g=e.distanceSqToSegment(h,c,u,l))>a||(u.applyMatrix4(this.matrixWorld),(g=n.ray.origin.distanceTo(u))<n.near||g>n.far||r.push({distance:g,point:l.clone().applyMatrix4(this.matrixWorld),index:o,face:null,faceIndex:null,object:this}))}else if(o.isGeometry)for(c=(h=o.vertices).length,o=0;o<c-1;o+=d)(g=e.distanceSqToSegment(h[o],h[o+1],u,l))>a||(u.applyMatrix4(this.matrixWorld),(g=n.ray.origin.distanceTo(u))<n.near||g>n.far||r.push({distance:g,point:l.clone().applyMatrix4(this.matrixWorld),index:o,face:null,faceIndex:null,object:this}))}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Me.prototype=Object.assign(Object.create(Ee.prototype),{constructor:Me,isLineSegments:!0,computeLineDistances:function(){var t=new s,e=new s;return function(){var i=this.geometry;if(i.isBufferGeometry)if(null===i.index){for(var n=i.attributes.position,s=[],r=0,a=n.count;r<a;r+=2)t.fromBufferAttribute(n,r),e.fromBufferAttribute(n,r+1),s[r]=0===r?0:s[r-1],s[r+1]=s[r]+t.distanceTo(e);i.addAttribute("lineDistance",new k(s,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(i.isGeometry)for(n=i.vertices,s=i.lineDistances,r=0,a=n.length;r<a;r+=2)t.copy(n[r]),e.copy(n[r+1]),s[r]=0===r?0:s[r-1],s[r+1]=s[r]+t.distanceTo(e);return this}}()}),Te.prototype=Object.assign(Object.create(Ee.prototype),{constructor:Te,isLineLoop:!0}),Ce.prototype=Object.create(z.prototype),Ce.prototype.constructor=Ce,Ce.prototype.isPointsMaterial=!0,Ce.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.morphTargets=t.morphTargets,this},Pe.prototype=Object.assign(Object.create(T.prototype),{constructor:Pe,isPoints:!0,raycast:function(){var t=new g,e=new q,i=new p;return function(n,r){function a(t,i){var s=e.distanceSqToPoint(t);s<u&&(e.closestPointToPoint(t,d),d.applyMatrix4(h),(t=n.ray.origin.distanceTo(d))<n.near||t>n.far||r.push({distance:t,distanceToRay:Math.sqrt(s),point:d.clone(),index:i,face:null,object:o}))}var o=this,l=this.geometry,h=this.matrixWorld,c=n.params.Points.threshold;if(null===l.boundingSphere&&l.computeBoundingSphere(),i.copy(l.boundingSphere),i.applyMatrix4(h),i.radius+=c,!1!==n.ray.intersectsSphere(i)){t.getInverse(h),e.copy(n.ray).applyMatrix4(t);var u=(c/=(this.scale.x+this.scale.y+this.scale.z)/3)*c;c=new s;var d=new s;if(l.isBufferGeometry){var p=l.index;if(l=l.attributes.position.array,null!==p){var m=p.array;p=0;for(var f=m.length;p<f;p++){var g=m[p];c.fromArray(l,3*g),a(c,g)}}else for(p=0,m=l.length/3;p<m;p++)c.fromArray(l,3*p),a(c,p)}else for(p=0,m=(c=l.vertices).length;p<m;p++)a(c[p],p)}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),_e.prototype=Object.assign(Object.create(a.prototype),{constructor:_e,isVideoTexture:!0,update:function(){var t=this.image;t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}),Ae.prototype=Object.create(a.prototype),Ae.prototype.constructor=Ae,Ae.prototype.isCompressedTexture=!0,Le.prototype=Object.create(a.prototype),Le.prototype.constructor=Le,Le.prototype.isCanvasTexture=!0,Re.prototype=Object.create(a.prototype),Re.prototype.constructor=Re,Re.prototype.isDepthTexture=!0,Ie.prototype=Object.create(F.prototype),Ie.prototype.constructor=Ie,Oe.prototype=Object.create(C.prototype),Oe.prototype.constructor=Oe,De.prototype=Object.create(F.prototype),De.prototype.constructor=De,ke.prototype=Object.create(C.prototype),ke.prototype.constructor=ke,Be.prototype=Object.create(F.prototype),Be.prototype.constructor=Be,He.prototype=Object.create(C.prototype),He.prototype.constructor=He,Ne.prototype=Object.create(Be.prototype),Ne.prototype.constructor=Ne,Fe.prototype=Object.create(C.prototype),Fe.prototype.constructor=Fe,Ve.prototype=Object.create(Be.prototype),Ve.prototype.constructor=Ve,je.prototype=Object.create(C.prototype),je.prototype.constructor=je,Ge.prototype=Object.create(Be.prototype),Ge.prototype.constructor=Ge,Ue.prototype=Object.create(C.prototype),Ue.prototype.constructor=Ue,ze.prototype=Object.create(Be.prototype),ze.prototype.constructor=ze,We.prototype=Object.create(C.prototype),We.prototype.constructor=We,qe.prototype=Object.create(F.prototype),qe.prototype.constructor=qe,qe.prototype.toJSON=function(){var t=F.prototype.toJSON.call(this);return t.path=this.parameters.path.toJSON(),t},Ye.prototype=Object.create(C.prototype),Ye.prototype.constructor=Ye,Xe.prototype=Object.create(F.prototype),Xe.prototype.constructor=Xe,Je.prototype=Object.create(C.prototype),Je.prototype.constructor=Je,Ke.prototype=Object.create(F.prototype),Ke.prototype.constructor=Ke;var Er=function(t,e,i){i=i||2;var n,s=e&&e.length,r=s?e[0]*i:t.length,a=Ze(t,0,r,i,!0),o=[];if(!a)return o;if(s){var l,h=i;s=[];var c=0;for(l=e.length;c<l;c++){var u=e[c]*h;(u=Ze(t,u,c<l-1?e[c+1]*h:t.length,h,!1))===u.next&&(u.steiner=!0),s.push(ii(u))}for(s.sort($e),c=0;c<s.length;c++)(h=ti(e=s[c],h=a))&&Qe(e=li(h,e),e.next),a=Qe(a,a.next)}if(t.length>80*i){var d=n=t[0],p=s=t[1];for(h=i;h<r;h+=i)c=t[h],e=t[h+1],c<d&&(d=c),e<p&&(p=e),c>n&&(n=c),e>s&&(s=e);n=0!==(n=Math.max(n-d,s-p))?1/n:0}return function t(e,i,n,s,r,a,o){if(e){if(!o&&a){var l=e,h=l;do{null===h.z&&(h.z=ei(h.x,h.y,s,r,a)),h.prevZ=h.prev,h=h.nextZ=h.next}while(h!==l);h.prevZ.nextZ=null,h.prevZ=null,l=h;var c,u,d,p,m=1;do{h=l;var f=l=null;for(u=0;h;){u++;var g=h;for(c=d=0;c<m&&(d++,g=g.nextZ);c++);for(p=m;0<d||0<p&&g;)0!==d&&(0===p||!g||h.z<=g.z)?(c=h,h=h.nextZ,d--):(c=g,g=g.nextZ,p--),f?f.nextZ=c:l=c,c.prevZ=f,f=c;h=g}f.nextZ=null,m*=2}while(1<u)}for(l=e;e.prev!==e.next;){if(h=e.prev,g=e.next,a)t:{p=s;var y=r,v=a;if(0<=si(u=(f=e).prev,d=f,m=f.next))f=!1;else{var b=u.x>d.x?u.x>m.x?u.x:m.x:d.x>m.x?d.x:m.x,w=u.y>d.y?u.y>m.y?u.y:m.y:d.y>m.y?d.y:m.y;for(c=ei(u.x<d.x?u.x<m.x?u.x:m.x:d.x<m.x?d.x:m.x,u.y<d.y?u.y<m.y?u.y:m.y:d.y<m.y?d.y:m.y,p,y,v),p=ei(b,w,p,y,v),y=f.nextZ;y&&y.z<=p;){if(y!==f.prev&&y!==f.next&&ni(u.x,u.y,d.x,d.y,m.x,m.y,y.x,y.y)&&0<=si(y.prev,y,y.next)){f=!1;break t}y=y.nextZ}for(y=f.prevZ;y&&y.z>=c;){if(y!==f.prev&&y!==f.next&&ni(u.x,u.y,d.x,d.y,m.x,m.y,y.x,y.y)&&0<=si(y.prev,y,y.next)){f=!1;break t}y=y.prevZ}f=!0}}else t:if(f=e,u=f.prev,d=f,m=f.next,0<=si(u,d,m))f=!1;else{for(c=f.next.next;c!==f.prev;){if(ni(u.x,u.y,d.x,d.y,m.x,m.y,c.x,c.y)&&0<=si(c.prev,c,c.next)){f=!1;break t}c=c.next}f=!0}if(f)i.push(h.i/n),i.push(e.i/n),i.push(g.i/n),ci(e),l=e=g.next;else if((e=g)===l){if(o){if(1===o){o=i,l=n,h=e;do{!ri(g=h.prev,f=h.next.next)&&ai(g,h,h.next,f)&&oi(g,f)&&oi(f,g)&&(o.push(g.i/l),o.push(h.i/l),o.push(f.i/l),ci(h),ci(h.next),h=e=f),h=h.next}while(h!==e);t(e=h,i,n,s,r,a,2)}else if(2===o)t:{o=e;do{for(l=o.next.next;l!==o.prev;){if(h=o.i!==l.i){if(g=l,f=(h=o).next.i!==g.i&&h.prev.i!==g.i){e:{f=h;do{if(f.i!==h.i&&f.next.i!==h.i&&f.i!==g.i&&f.next.i!==g.i&&ai(f,f.next,h,g)){f=!0;break e}f=f.next}while(f!==h);f=!1}f=!f}if(f=f&&oi(h,g)&&oi(g,h)){f=h,u=!1,d=(h.x+g.x)/2,g=(h.y+g.y)/2;do{f.y>g!=f.next.y>g&&f.next.y!==f.y&&d<(f.next.x-f.x)*(g-f.y)/(f.next.y-f.y)+f.x&&(u=!u),f=f.next}while(f!==h);f=u}h=f}if(h){e=li(o,l),o=Qe(o,o.next),e=Qe(e,e.next),t(o,i,n,s,r,a),t(e,i,n,s,r,a);break t}l=l.next}o=o.next}while(o!==e)}}else t(Qe(e),i,n,s,r,a,1);break}}}}(a,o,i,d,p,n),o},Mr={area:function(t){for(var e=t.length,i=0,n=e-1,s=0;s<e;n=s++)i+=t[n].x*t[s].y-t[s].x*t[n].y;return.5*i},isClockWise:function(t){return 0>Mr.area(t)},triangulateShape:function(t,e){var i=[],n=[],s=[];di(t),pi(i,t);var r=t.length;for(e.forEach(di),t=0;t<e.length;t++)n.push(r),r+=e[t].length,pi(i,e[t]);for(e=Er(i,n),t=0;t<e.length;t+=3)s.push(e.slice(t,t+3));return s}};mi.prototype=Object.create(C.prototype),mi.prototype.constructor=mi,mi.prototype.toJSON=function(){var t=C.prototype.toJSON.call(this);return gi(this.parameters.shapes,this.parameters.options,t)},fi.prototype=Object.create(F.prototype),fi.prototype.constructor=fi,fi.prototype.toJSON=function(){var t=F.prototype.toJSON.call(this);return gi(this.parameters.shapes,this.parameters.options,t)};var Tr={generateTopUV:function(t,e,n,s,r){t=e[3*s],s=e[3*s+1];var a=e[3*r];return r=e[3*r+1],[new i(e[3*n],e[3*n+1]),new i(t,s),new i(a,r)]},generateSideWallUV:function(t,e,n,s,r,a){t=e[3*n];var o=e[3*n+1];n=e[3*n+2];var l=e[3*s],h=e[3*s+1];s=e[3*s+2];var c=e[3*r],u=e[3*r+1];r=e[3*r+2];var d=e[3*a],p=e[3*a+1];return e=e[3*a+2],.01>Math.abs(o-h)?[new i(t,1-n),new i(l,1-s),new i(c,1-r),new i(d,1-e)]:[new i(o,1-n),new i(h,1-s),new i(u,1-r),new i(p,1-e)]}};yi.prototype=Object.create(C.prototype),yi.prototype.constructor=yi,vi.prototype=Object.create(fi.prototype),vi.prototype.constructor=vi,bi.prototype=Object.create(C.prototype),bi.prototype.constructor=bi,wi.prototype=Object.create(F.prototype),wi.prototype.constructor=wi,xi.prototype=Object.create(C.prototype),xi.prototype.constructor=xi,Si.prototype=Object.create(F.prototype),Si.prototype.constructor=Si,Ei.prototype=Object.create(C.prototype),Ei.prototype.constructor=Ei,Mi.prototype=Object.create(F.prototype),Mi.prototype.constructor=Mi,Ti.prototype=Object.create(C.prototype),Ti.prototype.constructor=Ti,Ti.prototype.toJSON=function(){var t=C.prototype.toJSON.call(this);return Pi(this.parameters.shapes,t)},Ci.prototype=Object.create(F.prototype),Ci.prototype.constructor=Ci,Ci.prototype.toJSON=function(){var t=F.prototype.toJSON.call(this);return Pi(this.parameters.shapes,t)},_i.prototype=Object.create(F.prototype),_i.prototype.constructor=_i,Ai.prototype=Object.create(C.prototype),Ai.prototype.constructor=Ai,Li.prototype=Object.create(F.prototype),Li.prototype.constructor=Li,Ri.prototype=Object.create(Ai.prototype),Ri.prototype.constructor=Ri,Ii.prototype=Object.create(Li.prototype),Ii.prototype.constructor=Ii,Oi.prototype=Object.create(C.prototype),Oi.prototype.constructor=Oi,Di.prototype=Object.create(F.prototype),Di.prototype.constructor=Di;var Cr=Object.freeze({WireframeGeometry:Ie,ParametricGeometry:Oe,ParametricBufferGeometry:De,TetrahedronGeometry:He,TetrahedronBufferGeometry:Ne,OctahedronGeometry:Fe,OctahedronBufferGeometry:Ve,IcosahedronGeometry:je,IcosahedronBufferGeometry:Ge,DodecahedronGeometry:Ue,DodecahedronBufferGeometry:ze,PolyhedronGeometry:ke,PolyhedronBufferGeometry:Be,TubeGeometry:We,TubeBufferGeometry:qe,TorusKnotGeometry:Ye,TorusKnotBufferGeometry:Xe,TorusGeometry:Je,TorusBufferGeometry:Ke,TextGeometry:yi,TextBufferGeometry:vi,SphereGeometry:bi,SphereBufferGeometry:wi,RingGeometry:xi,RingBufferGeometry:Si,PlaneGeometry:G,PlaneBufferGeometry:U,LatheGeometry:Ei,LatheBufferGeometry:Mi,ShapeGeometry:Ti,ShapeBufferGeometry:Ci,ExtrudeGeometry:mi,ExtrudeBufferGeometry:fi,EdgesGeometry:_i,ConeGeometry:Ri,ConeBufferGeometry:Ii,CylinderGeometry:Ai,CylinderBufferGeometry:Li,CircleGeometry:Oi,CircleBufferGeometry:Di,BoxGeometry:V,BoxBufferGeometry:j});ki.prototype=Object.create(z.prototype),ki.prototype.constructor=ki,ki.prototype.isShadowMaterial=!0,ki.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.color.copy(t.color),this},Bi.prototype=Object.create(W.prototype),Bi.prototype.constructor=Bi,Bi.prototype.isRawShaderMaterial=!0,Hi.prototype=Object.create(z.prototype),Hi.prototype.constructor=Hi,Hi.prototype.isMeshStandardMaterial=!0,Hi.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},Ni.prototype=Object.create(Hi.prototype),Ni.prototype.constructor=Ni,Ni.prototype.isMeshPhysicalMaterial=!0,Ni.prototype.copy=function(t){return Hi.prototype.copy.call(this,t),this.defines={PHYSICAL:""},this.reflectivity=t.reflectivity,this.clearCoat=t.clearCoat,this.clearCoatRoughness=t.clearCoatRoughness,this},Fi.prototype=Object.create(z.prototype),Fi.prototype.constructor=Fi,Fi.prototype.isMeshPhongMaterial=!0,Fi.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},Vi.prototype=Object.create(Fi.prototype),Vi.prototype.constructor=Vi,Vi.prototype.isMeshToonMaterial=!0,Vi.prototype.copy=function(t){return Fi.prototype.copy.call(this,t),this.gradientMap=t.gradientMap,this},ji.prototype=Object.create(z.prototype),ji.prototype.constructor=ji,ji.prototype.isMeshNormalMaterial=!0,ji.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},Gi.prototype=Object.create(z.prototype),Gi.prototype.constructor=Gi,Gi.prototype.isMeshLambertMaterial=!0,Gi.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},Ui.prototype=Object.create(z.prototype),Ui.prototype.constructor=Ui,Ui.prototype.isMeshMatcapMaterial=!0,Ui.prototype.copy=function(t){return z.prototype.copy.call(this,t),this.defines={MATCAP:""},this.color.copy(t.color),this.matcap=t.matcap,this.map=t.map,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},zi.prototype=Object.create(Se.prototype),zi.prototype.constructor=zi,zi.prototype.isLineDashedMaterial=!0,zi.prototype.copy=function(t){return Se.prototype.copy.call(this,t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this};var Pr=Object.freeze({ShadowMaterial:ki,SpriteMaterial:ge,RawShaderMaterial:Bi,ShaderMaterial:W,PointsMaterial:Ce,MeshPhysicalMaterial:Ni,MeshStandardMaterial:Hi,MeshPhongMaterial:Fi,MeshToonMaterial:Vi,MeshNormalMaterial:ji,MeshLambertMaterial:Gi,MeshDepthMaterial:$t,MeshDistanceMaterial:te,MeshBasicMaterial:X,MeshMatcapMaterial:Ui,LineDashedMaterial:zi,LineBasicMaterial:Se,Material:z}),_r={arraySlice:function(t,e,i){return _r.isTypedArray(t)?new t.constructor(t.subarray(e,void 0!==i?i:t.length)):t.slice(e,i)},convertArray:function(t,e,i){return!t||!i&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)},isTypedArray:function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},getKeyframeOrder:function(t){for(var e=t.length,i=Array(e),n=0;n!==e;++n)i[n]=n;return i.sort(function(e,i){return t[e]-t[i]}),i},sortedArray:function(t,e,i){for(var n=t.length,s=new t.constructor(n),r=0,a=0;a!==n;++r)for(var o=i[r]*e,l=0;l!==e;++l)s[a++]=t[o+l];return s},flattenJSON:function(t,e,i,n){for(var s=1,r=t[0];void 0!==r&&void 0===r[n];)r=t[s++];if(void 0!==r){var a=r[n];if(void 0!==a)if(Array.isArray(a))do{void 0!==(a=r[n])&&(e.push(r.time),i.push.apply(i,a)),r=t[s++]}while(void 0!==r);else if(void 0!==a.toArray)do{void 0!==(a=r[n])&&(e.push(r.time),a.toArray(i,i.length)),r=t[s++]}while(void 0!==r);else do{void 0!==(a=r[n])&&(e.push(r.time),i.push(a)),r=t[s++]}while(void 0!==r)}}};Object.assign(Wi.prototype,{evaluate:function(t){var e=this.parameterPositions,i=this._cachedIndex,n=e[i],s=e[i-1];t:{e:{i:{n:if(!(t<n)){for(var r=i+2;;){if(void 0===n){if(t<s)break n;return this._cachedIndex=i=e.length,this.afterEnd_(i-1,t,s)}if(i===r)break;if(s=n,t<(n=e[++i]))break e}n=e.length;break i}if(t>=s)break t;for(t<(r=e[1])&&(i=2,s=r),r=i-2;;){if(void 0===s)return this._cachedIndex=0,this.beforeStart_(0,t,n);if(i===r)break;if(n=s,t>=(s=e[--i-1]))break e}n=i,i=0}for(;i<n;)t<e[s=i+n>>>1]?n=s:i=s+1;if(n=e[i],void 0===(s=e[i-1]))return this._cachedIndex=0,this.beforeStart_(0,t,n);if(void 0===n)return this._cachedIndex=i=e.length,this.afterEnd_(i-1,s,t)}this._cachedIndex=i,this.intervalChanged_(i,s,n)}return this.interpolate_(i,s,t,n)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(t){var e=this.resultBuffer,i=this.sampleValues,n=this.valueSize;t*=n;for(var s=0;s!==n;++s)e[s]=i[t+s];return e},interpolate_:function(){throw Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(Wi.prototype,{beforeStart_:Wi.prototype.copySampleValue_,afterEnd_:Wi.prototype.copySampleValue_}),qi.prototype=Object.assign(Object.create(Wi.prototype),{constructor:qi,DefaultSettings_:{endingStart:2400,endingEnd:2400},intervalChanged_:function(t,e,i){var n=this.parameterPositions,s=t-2,r=t+1,a=n[s],o=n[r];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:s=t,a=2*e-i;break;case 2402:a=e+n[s=n.length-2]-n[s+1];break;default:s=t,a=i}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:r=t,o=2*i-e;break;case 2402:r=1,o=i+n[1]-n[0];break;default:r=t-1,o=e}t=.5*(i-e),n=this.valueSize,this._weightPrev=t/(e-a),this._weightNext=t/(o-i),this._offsetPrev=s*n,this._offsetNext=r*n},interpolate_:function(t,e,i,n){var s=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=(t*=a)-a,l=this._offsetPrev,h=this._offsetNext,c=this._weightPrev,u=this._weightNext,d=(i-e)/(n-e);for(e=-c*(n=(i=d*d)*d)+2*c*i-c*d,c=(1+c)*n+(-1.5-2*c)*i+(-.5+c)*d+1,d=(-1-u)*n+(1.5+u)*i+.5*d,u=u*n-u*i,i=0;i!==a;++i)s[i]=e*r[l+i]+c*r[o+i]+d*r[t+i]+u*r[h+i];return s}}),Yi.prototype=Object.assign(Object.create(Wi.prototype),{constructor:Yi,interpolate_:function(t,e,i,n){var s=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=(t*=a)-a;for(i=1-(e=(i-e)/(n-e)),n=0;n!==a;++n)s[n]=r[o+n]*i+r[t+n]*e;return s}}),Xi.prototype=Object.assign(Object.create(Wi.prototype),{constructor:Xi,interpolate_:function(t){return this.copySampleValue_(t-1)}}),Object.assign(Ji,{toJSON:function(t){var e=t.constructor;if(void 0!==e.toJSON)e=e.toJSON(t);else{e={name:t.name,times:_r.convertArray(t.times,Array),values:_r.convertArray(t.values,Array)};var i=t.getInterpolation();i!==t.DefaultInterpolation&&(e.interpolation=i)}return e.type=t.ValueTypeName,e}}),Object.assign(Ji.prototype,{constructor:Ji,TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:2301,InterpolantFactoryMethodDiscrete:function(t){return new Xi(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodLinear:function(t){return new Yi(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:function(t){return new qi(this.times,this.values,this.getValueSize(),t)},setInterpolation:function(t){switch(t){case 2300:var e=this.InterpolantFactoryMethodDiscrete;break;case 2301:e=this.InterpolantFactoryMethodLinear;break;case 2302:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){if(e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name,void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw Error(e);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",e),this}return this.createInterpolant=e,this},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(t){if(0!==t)for(var e=this.times,i=0,n=e.length;i!==n;++i)e[i]+=t;return this},scale:function(t){if(1!==t)for(var e=this.times,i=0,n=e.length;i!==n;++i)e[i]*=t;return this},trim:function(t,e){for(var i=this.times,n=i.length,s=0,r=n-1;s!==n&&i[s]<t;)++s;for(;-1!==r&&i[r]>e;)--r;return++r,0===s&&r===n||(s>=r&&(s=(r=Math.max(r,1))-1),t=this.getValueSize(),this.times=_r.arraySlice(i,s,r),this.values=_r.arraySlice(this.values,s*t,r*t)),this},validate:function(){var t=!0,e=this.getValueSize();0!=e-Math.floor(e)&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),t=!1);var i=this.times;e=this.values;var n=i.length;0===n&&(console.error("THREE.KeyframeTrack: Track is empty.",this),t=!1);for(var s=null,r=0;r!==n;r++){var a=i[r];if("number"==typeof a&&isNaN(a)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,r,a),t=!1;break}if(null!==s&&s>a){console.error("THREE.KeyframeTrack: Out of order keys.",this,r,a,s),t=!1;break}s=a}if(void 0!==e&&_r.isTypedArray(e))for(r=0,i=e.length;r!==i;++r)if(n=e[r],isNaN(n)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,r,n),t=!1;break}return t},optimize:function(){for(var t=this.times,e=this.values,i=this.getValueSize(),n=2302===this.getInterpolation(),s=1,r=t.length-1,a=1;a<r;++a){var o=!1,l=t[a];if(l!==t[a+1]&&(1!==a||l!==l[0]))if(n)o=!0;else{var h=a*i,c=h-i,u=h+i;for(l=0;l!==i;++l){var d=e[h+l];if(d!==e[c+l]||d!==e[u+l]){o=!0;break}}}if(o){if(a!==s)for(t[s]=t[a],o=a*i,h=s*i,l=0;l!==i;++l)e[h+l]=e[o+l];++s}}if(0<r){for(t[s]=t[r],o=r*i,h=s*i,l=0;l!==i;++l)e[h+l]=e[o+l];++s}return s!==t.length&&(this.times=_r.arraySlice(t,0,s),this.values=_r.arraySlice(e,0,s*i)),this},clone:function(){var t=_r.arraySlice(this.times,0),e=_r.arraySlice(this.values,0);return(t=new this.constructor(this.name,t,e)).createInterpolant=this.createInterpolant,t}}),Ki.prototype=Object.assign(Object.create(Ji.prototype),{constructor:Ki,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),Zi.prototype=Object.assign(Object.create(Ji.prototype),{constructor:Zi,ValueTypeName:"color"}),Qi.prototype=Object.assign(Object.create(Ji.prototype),{constructor:Qi,ValueTypeName:"number"}),$i.prototype=Object.assign(Object.create(Wi.prototype),{constructor:$i,interpolate_:function(t,e,i,s){var r=this.resultBuffer,a=this.sampleValues,o=this.valueSize;for(e=(i-e)/(s-e),i=(t*=o)+o;t!==i;t+=4)n.slerpFlat(r,0,a,t-o,a,t,e);return r}}),tn.prototype=Object.assign(Object.create(Ji.prototype),{constructor:tn,ValueTypeName:"quaternion",DefaultInterpolation:2301,InterpolantFactoryMethodLinear:function(t){return new $i(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:void 0}),en.prototype=Object.assign(Object.create(Ji.prototype),{constructor:en,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),nn.prototype=Object.assign(Object.create(Ji.prototype),{constructor:nn,ValueTypeName:"vector"}),Object.assign(sn,{parse:function(t){for(var e=[],i=t.tracks,n=1/(t.fps||1),s=0,r=i.length;s!==r;++s)e.push(rn(i[s]).scale(n));return new sn(t.name,t.duration,e)},toJSON:function(t){var e=[],i=t.tracks;t={name:t.name,duration:t.duration,tracks:e,uuid:t.uuid};for(var n=0,s=i.length;n!==s;++n)e.push(Ji.toJSON(i[n]));return t},CreateFromMorphTargetSequence:function(t,e,i,n){for(var s=e.length,r=[],a=0;a<s;a++){var o=[],l=[];o.push((a+s-1)%s,a,(a+1)%s),l.push(0,1,0);var h=_r.getKeyframeOrder(o);o=_r.sortedArray(o,1,h),l=_r.sortedArray(l,1,h),n||0!==o[0]||(o.push(s),l.push(l[0])),r.push(new Qi(".morphTargetInfluences["+e[a].name+"]",o,l).scale(1/i))}return new sn(t,-1,r)},findByName:function(t,e){var i=t;for(Array.isArray(t)||(i=t.geometry&&t.geometry.animations||t.animations),t=0;t<i.length;t++)if(i[t].name===e)return i[t];return null},CreateClipsFromMorphTargetSequences:function(t,e,i){for(var n={},s=/^([\w-]*?)([\d]+)$/,r=0,a=t.length;r<a;r++){var o=t[r],l=o.name.match(s);if(l&&1<l.length){var h=l[1];(l=n[h])||(n[h]=l=[]),l.push(o)}}for(h in t=[],n)t.push(sn.CreateFromMorphTargetSequence(h,n[h],e,i));return t},parseAnimation:function(t,e){if(!t)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;var i=function(t,e,i,n,s){if(0!==i.length){var r=[],a=[];_r.flattenJSON(i,r,a,n),0!==r.length&&s.push(new t(e,r,a))}},n=[],s=t.name||"default",r=t.length||-1,a=t.fps||30;t=t.hierarchy||[];for(var o=0;o<t.length;o++){var l=t[o].keys;if(l&&0!==l.length)if(l[0].morphTargets){r={};for(var h=0;h<l.length;h++)if(l[h].morphTargets)for(var c=0;c<l[h].morphTargets.length;c++)r[l[h].morphTargets[c]]=-1;for(var u in r){var d=[],p=[];for(c=0;c!==l[h].morphTargets.length;++c){var m=l[h];d.push(m.time),p.push(m.morphTarget===u?1:0)}n.push(new Qi(".morphTargetInfluence["+u+"]",d,p))}r=r.length*(a||1)}else i(nn,(h=".bones["+e[o].name+"]")+".position",l,"pos",n),i(tn,h+".quaternion",l,"rot",n),i(nn,h+".scale",l,"scl",n)}return 0===n.length?null:new sn(s,r,n)}}),Object.assign(sn.prototype,{resetDuration:function(){for(var t=0,e=0,i=this.tracks.length;e!==i;++e){var n=this.tracks[e];t=Math.max(t,n.times[n.times.length-1])}return this.duration=t,this},trim:function(){for(var t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this},validate:function(){for(var t=!0,e=0;e<this.tracks.length;e++)t=t&&this.tracks[e].validate();return t},optimize:function(){for(var t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this},clone:function(){for(var t=[],e=0;e<this.tracks.length;e++)t.push(this.tracks[e].clone());return new sn(this.name,this.duration,t)}});var Ar={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}},Lr=new an,Rr={};Object.assign(on.prototype,{load:function(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var s=this,r=Ar.get(t);if(void 0!==r)return s.manager.itemStart(t),setTimeout(function(){e&&e(r),s.manager.itemEnd(t)},0),r;if(void 0===Rr[t]){var a=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(a){i=a[1];var o=!!a[2];a=a[3],a=decodeURIComponent(a),o&&(a=atob(a));try{var l=(this.responseType||"").toLowerCase();switch(l){case"arraybuffer":case"blob":var h=new Uint8Array(a.length);for(o=0;o<a.length;o++)h[o]=a.charCodeAt(o);var c="blob"===l?new Blob([h.buffer],{type:i}):h.buffer;break;case"document":c=(new DOMParser).parseFromString(a,i);break;case"json":c=JSON.parse(a);break;default:c=a}setTimeout(function(){e&&e(c),s.manager.itemEnd(t)},0)}catch(e){setTimeout(function(){n&&n(e),s.manager.itemError(t),s.manager.itemEnd(t)},0)}}else{Rr[t]=[],Rr[t].push({onLoad:e,onProgress:i,onError:n});var u=new XMLHttpRequest;for(o in u.open("GET",t,!0),u.addEventListener("load",function(e){var i=this.response;Ar.add(t,i);var n=Rr[t];if(delete Rr[t],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received.");for(var r=0,a=n.length;r<a;r++){var o=n[r];o.onLoad&&o.onLoad(i)}}else{for(r=0,a=n.length;r<a;r++)(o=n[r]).onError&&o.onError(e);s.manager.itemError(t)}s.manager.itemEnd(t)},!1),u.addEventListener("progress",function(e){for(var i=Rr[t],n=0,s=i.length;n<s;n++){var r=i[n];r.onProgress&&r.onProgress(e)}},!1),u.addEventListener("error",function(e){var i=Rr[t];delete Rr[t];for(var n=0,r=i.length;n<r;n++){var a=i[n];a.onError&&a.onError(e)}s.manager.itemError(t),s.manager.itemEnd(t)},!1),u.addEventListener("abort",function(e){var i=Rr[t];delete Rr[t];for(var n=0,r=i.length;n<r;n++){var a=i[n];a.onError&&a.onError(e)}s.manager.itemError(t),s.manager.itemEnd(t)},!1),void 0!==this.responseType&&(u.responseType=this.responseType),void 0!==this.withCredentials&&(u.withCredentials=this.withCredentials),u.overrideMimeType&&u.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)u.setRequestHeader(o,this.requestHeader[o]);u.send(null)}return s.manager.itemStart(t),u}Rr[t].push({onLoad:e,onProgress:i,onError:n})},setPath:function(t){return this.path=t,this},setResponseType:function(t){return this.responseType=t,this},setWithCredentials:function(t){return this.withCredentials=t,this},setMimeType:function(t){return this.mimeType=t,this},setRequestHeader:function(t){return this.requestHeader=t,this}}),Object.assign(ln.prototype,{load:function(t,e,i,n){var s=this,r=new on(s.manager);r.setPath(s.path),r.load(t,function(t){e(s.parse(JSON.parse(t)))},i,n)},parse:function(t){for(var e=[],i=0;i<t.length;i++){var n=sn.parse(t[i]);e.push(n)}return e},setPath:function(t){return this.path=t,this}}),Object.assign(hn.prototype,{load:function(t,e,i,n){function s(s){l.load(t[s],function(t){t=r._parser(t,!0),a[s]={width:t.width,height:t.height,format:t.format,mipmaps:t.mipmaps},6===(h+=1)&&(1===t.mipmapCount&&(o.minFilter=1006),o.format=t.format,o.needsUpdate=!0,e&&e(o))},i,n)}var r=this,a=[],o=new Ae;o.image=a;var l=new on(this.manager);if(l.setPath(this.path),l.setResponseType("arraybuffer"),Array.isArray(t))for(var h=0,c=0,u=t.length;c<u;++c)s(c);else l.load(t,function(t){if((t=r._parser(t,!0)).isCubemap)for(var i=t.mipmaps.length/t.mipmapCount,n=0;n<i;n++){a[n]={mipmaps:[]};for(var s=0;s<t.mipmapCount;s++)a[n].mipmaps.push(t.mipmaps[n*t.mipmapCount+s]),a[n].format=t.format,a[n].width=t.width,a[n].height=t.height}else o.image.width=t.width,o.image.height=t.height,o.mipmaps=t.mipmaps;1===t.mipmapCount&&(o.minFilter=1006),o.format=t.format,o.needsUpdate=!0,e&&e(o)},i,n);return o},setPath:function(t){return this.path=t,this}}),Object.assign(cn.prototype,{load:function(t,e,i,n){var s=this,r=new u,a=new on(this.manager);return a.setResponseType("arraybuffer"),a.setPath(this.path),a.load(t,function(t){(t=s._parser(t))&&(void 0!==t.image?r.image=t.image:void 0!==t.data&&(r.image.width=t.width,r.image.height=t.height,r.image.data=t.data),r.wrapS=void 0!==t.wrapS?t.wrapS:1001,r.wrapT=void 0!==t.wrapT?t.wrapT:1001,r.magFilter=void 0!==t.magFilter?t.magFilter:1006,r.minFilter=void 0!==t.minFilter?t.minFilter:1008,r.anisotropy=void 0!==t.anisotropy?t.anisotropy:1,void 0!==t.format&&(r.format=t.format),void 0!==t.type&&(r.type=t.type),void 0!==t.mipmaps&&(r.mipmaps=t.mipmaps),1===t.mipmapCount&&(r.minFilter=1006),r.needsUpdate=!0,e&&e(r,t))},i,n),r},setPath:function(t){return this.path=t,this}}),Object.assign(un.prototype,{crossOrigin:"anonymous",load:function(t,e,i,n){function s(){l.removeEventListener("load",s,!1),l.removeEventListener("error",r,!1),Ar.add(t,this),e&&e(this),a.manager.itemEnd(t)}function r(e){l.removeEventListener("load",s,!1),l.removeEventListener("error",r,!1),n&&n(e),a.manager.itemError(t),a.manager.itemEnd(t)}void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var a=this,o=Ar.get(t);if(void 0!==o)return a.manager.itemStart(t),setTimeout(function(){e&&e(o),a.manager.itemEnd(t)},0),o;var l=document.createElementNS("http://www.w3.org/1999/xhtml","img");return l.addEventListener("load",s,!1),l.addEventListener("error",r,!1),"data:"!==t.substr(0,5)&&void 0!==this.crossOrigin&&(l.crossOrigin=this.crossOrigin),a.manager.itemStart(t),l.src=t,l},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this}}),Object.assign(dn.prototype,{crossOrigin:"anonymous",load:function(t,e,i,n){function s(i){a.load(t[i],function(t){r.images[i]=t,6===++o&&(r.needsUpdate=!0,e&&e(r))},void 0,n)}var r=new tt,a=new un(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);var o=0;for(i=0;i<t.length;++i)s(i);return r},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this}}),Object.assign(pn.prototype,{crossOrigin:"anonymous",load:function(t,e,i,n){var s=new a,r=new un(this.manager);return r.setCrossOrigin(this.crossOrigin),r.setPath(this.path),r.load(t,function(i){s.image=i,i=0<t.search(/\.jpe?g($|\?)/i)||0===t.search(/^data:image\/jpeg/),s.format=i?1022:1023,s.needsUpdate=!0,void 0!==e&&e(s)},i,n),s},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this}}),Object.assign(mn.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(t,e){return t=this.getUtoTmapping(t),this.getPoint(t,e)},getPoints:function(t){void 0===t&&(t=5);for(var e=[],i=0;i<=t;i++)e.push(this.getPoint(i/t));return e},getSpacedPoints:function(t){void 0===t&&(t=5);for(var e=[],i=0;i<=t;i++)e.push(this.getPointAt(i/t));return e},getLength:function(){var t=this.getLengths();return t[t.length-1]},getLengths:function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e,i=[],n=this.getPoint(0),s=0;for(i.push(0),e=1;e<=t;e++){var r=this.getPoint(e/t);s+=r.distanceTo(n),i.push(s),n=r}return this.cacheArcLengths=i},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(t,e){var i=this.getLengths(),n=i.length;e=e||t*i[n-1];for(var s,r=0,a=n-1;r<=a;)if(0>(s=i[t=Math.floor(r+(a-r)/2)]-e))r=t+1;else{if(!(0<s)){a=t;break}a=t-1}return i[t=a]===e?t/(n-1):(t+(e-(r=i[t]))/(i[t+1]-r))/(n-1)},getTangent:function(t){var e=t-1e-4;return t+=1e-4,0>e&&(e=0),1<t&&(t=1),e=this.getPoint(e),this.getPoint(t).clone().sub(e).normalize()},getTangentAt:function(t){return t=this.getUtoTmapping(t),this.getTangent(t)},computeFrenetFrames:function(t,e){var i,n=new s,r=[],a=[],o=[],l=new s,h=new g;for(i=0;i<=t;i++){var c=i/t;r[i]=this.getTangentAt(c),r[i].normalize()}a[0]=new s,o[0]=new s,i=Number.MAX_VALUE,c=Math.abs(r[0].x);var u=Math.abs(r[0].y),d=Math.abs(r[0].z);for(c<=i&&(i=c,n.set(1,0,0)),u<=i&&(i=u,n.set(0,1,0)),d<=i&&n.set(0,0,1),l.crossVectors(r[0],n).normalize(),a[0].crossVectors(r[0],l),o[0].crossVectors(r[0],a[0]),i=1;i<=t;i++)a[i]=a[i-1].clone(),o[i]=o[i-1].clone(),l.crossVectors(r[i-1],r[i]),l.length()>Number.EPSILON&&(l.normalize(),n=Math.acos(Js.clamp(r[i-1].dot(r[i]),-1,1)),a[i].applyMatrix4(h.makeRotationAxis(l,n))),o[i].crossVectors(r[i],a[i]);if(!0===e)for(n=Math.acos(Js.clamp(a[0].dot(a[t]),-1,1)),n/=t,0<r[0].dot(l.crossVectors(a[0],a[t]))&&(n=-n),i=1;i<=t;i++)a[i].applyMatrix4(h.makeRotationAxis(r[i],n*i)),o[i].crossVectors(r[i],a[i]);return{tangents:r,normals:a,binormals:o}},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this},toJSON:function(){var t={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t},fromJSON:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}),fn.prototype=Object.create(mn.prototype),fn.prototype.constructor=fn,fn.prototype.isEllipseCurve=!0,fn.prototype.getPoint=function(t,e){e=e||new i;for(var n=2*Math.PI,s=this.aEndAngle-this.aStartAngle,r=Math.abs(s)<Number.EPSILON;0>s;)s+=n;for(;s>n;)s-=n;s<Number.EPSILON&&(s=r?0:n),!0!==this.aClockwise||r||(s=s===n?-n:s-n),n=this.aStartAngle+t*s,t=this.aX+this.xRadius*Math.cos(n);var a=this.aY+this.yRadius*Math.sin(n);return 0!==this.aRotation&&(n=Math.cos(this.aRotation),s=Math.sin(this.aRotation),t=(r=t-this.aX)*n-(a-=this.aY)*s+this.aX,a=r*s+a*n+this.aY),e.set(t,a)},fn.prototype.copy=function(t){return mn.prototype.copy.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this},fn.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t},fn.prototype.fromJSON=function(t){return mn.prototype.fromJSON.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this},gn.prototype=Object.create(fn.prototype),gn.prototype.constructor=gn,gn.prototype.isArcCurve=!0;var Ir=new s,Or=new yn,Dr=new yn,kr=new yn;vn.prototype=Object.create(mn.prototype),vn.prototype.constructor=vn,vn.prototype.isCatmullRomCurve3=!0,vn.prototype.getPoint=function(t,e){e=e||new s;var i=this.points,n=i.length;t*=n-(this.closed?0:1);var r=Math.floor(t);if(t-=r,this.closed?r+=0<r?0:(Math.floor(Math.abs(r)/n)+1)*n:0===t&&r===n-1&&(r=n-2,t=1),this.closed||0<r)var a=i[(r-1)%n];else Ir.subVectors(i[0],i[1]).add(i[0]),a=Ir;var o=i[r%n],l=i[(r+1)%n];if(this.closed||r+2<n?i=i[(r+2)%n]:(Ir.subVectors(i[n-1],i[n-2]).add(i[n-1]),i=Ir),"centripetal"===this.curveType||"chordal"===this.curveType){var h="chordal"===this.curveType?.5:.25;n=Math.pow(a.distanceToSquared(o),h),r=Math.pow(o.distanceToSquared(l),h),h=Math.pow(l.distanceToSquared(i),h),1e-4>r&&(r=1),1e-4>n&&(n=r),1e-4>h&&(h=r),Or.initNonuniformCatmullRom(a.x,o.x,l.x,i.x,n,r,h),Dr.initNonuniformCatmullRom(a.y,o.y,l.y,i.y,n,r,h),kr.initNonuniformCatmullRom(a.z,o.z,l.z,i.z,n,r,h)}else"catmullrom"===this.curveType&&(Or.initCatmullRom(a.x,o.x,l.x,i.x,this.tension),Dr.initCatmullRom(a.y,o.y,l.y,i.y,this.tension),kr.initCatmullRom(a.z,o.z,l.z,i.z,this.tension));return e.set(Or.calc(t),Dr.calc(t),kr.calc(t)),e},vn.prototype.copy=function(t){mn.prototype.copy.call(this,t),this.points=[];for(var e=0,i=t.points.length;e<i;e++)this.points.push(t.points[e].clone());return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this},vn.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);t.points=[];for(var e=0,i=this.points.length;e<i;e++)t.points.push(this.points[e].toArray());return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t},vn.prototype.fromJSON=function(t){mn.prototype.fromJSON.call(this,t),this.points=[];for(var e=0,i=t.points.length;e<i;e++){var n=t.points[e];this.points.push((new s).fromArray(n))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this},Sn.prototype=Object.create(mn.prototype),Sn.prototype.constructor=Sn,Sn.prototype.isCubicBezierCurve=!0,Sn.prototype.getPoint=function(t,e){e=e||new i;var n=this.v0,s=this.v1,r=this.v2,a=this.v3;return e.set(xn(t,n.x,s.x,r.x,a.x),xn(t,n.y,s.y,r.y,a.y)),e},Sn.prototype.copy=function(t){return mn.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this},Sn.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t},Sn.prototype.fromJSON=function(t){return mn.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this},En.prototype=Object.create(mn.prototype),En.prototype.constructor=En,En.prototype.isCubicBezierCurve3=!0,En.prototype.getPoint=function(t,e){e=e||new s;var i=this.v0,n=this.v1,r=this.v2,a=this.v3;return e.set(xn(t,i.x,n.x,r.x,a.x),xn(t,i.y,n.y,r.y,a.y),xn(t,i.z,n.z,r.z,a.z)),e},En.prototype.copy=function(t){return mn.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this},En.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t},En.prototype.fromJSON=function(t){return mn.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this},Mn.prototype=Object.create(mn.prototype),Mn.prototype.constructor=Mn,Mn.prototype.isLineCurve=!0,Mn.prototype.getPoint=function(t,e){return e=e||new i,1===t?e.copy(this.v2):(e.copy(this.v2).sub(this.v1),e.multiplyScalar(t).add(this.v1)),e},Mn.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},Mn.prototype.getTangent=function(){return this.v2.clone().sub(this.v1).normalize()},Mn.prototype.copy=function(t){return mn.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Mn.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Mn.prototype.fromJSON=function(t){return mn.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Tn.prototype=Object.create(mn.prototype),Tn.prototype.constructor=Tn,Tn.prototype.isLineCurve3=!0,Tn.prototype.getPoint=function(t,e){return e=e||new s,1===t?e.copy(this.v2):(e.copy(this.v2).sub(this.v1),e.multiplyScalar(t).add(this.v1)),e},Tn.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},Tn.prototype.copy=function(t){return mn.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Tn.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Tn.prototype.fromJSON=function(t){return mn.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Cn.prototype=Object.create(mn.prototype),Cn.prototype.constructor=Cn,Cn.prototype.isQuadraticBezierCurve=!0,Cn.prototype.getPoint=function(t,e){e=e||new i;var n=this.v0,s=this.v1,r=this.v2;return e.set(wn(t,n.x,s.x,r.x),wn(t,n.y,s.y,r.y)),e},Cn.prototype.copy=function(t){return mn.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Cn.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Cn.prototype.fromJSON=function(t){return mn.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Pn.prototype=Object.create(mn.prototype),Pn.prototype.constructor=Pn,Pn.prototype.isQuadraticBezierCurve3=!0,Pn.prototype.getPoint=function(t,e){e=e||new s;var i=this.v0,n=this.v1,r=this.v2;return e.set(wn(t,i.x,n.x,r.x),wn(t,i.y,n.y,r.y),wn(t,i.z,n.z,r.z)),e},Pn.prototype.copy=function(t){return mn.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Pn.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Pn.prototype.fromJSON=function(t){return mn.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},_n.prototype=Object.create(mn.prototype),_n.prototype.constructor=_n,_n.prototype.isSplineCurve=!0,_n.prototype.getPoint=function(t,e){e=e||new i;var n=this.points,s=(n.length-1)*t;s-=t=Math.floor(s);var r=n[0===t?t:t-1],a=n[t],o=n[t>n.length-2?n.length-1:t+1];return n=n[t>n.length-3?n.length-1:t+2],e.set(bn(s,r.x,a.x,o.x,n.x),bn(s,r.y,a.y,o.y,n.y)),e},_n.prototype.copy=function(t){mn.prototype.copy.call(this,t),this.points=[];for(var e=0,i=t.points.length;e<i;e++)this.points.push(t.points[e].clone());return this},_n.prototype.toJSON=function(){var t=mn.prototype.toJSON.call(this);t.points=[];for(var e=0,i=this.points.length;e<i;e++)t.points.push(this.points[e].toArray());return t},_n.prototype.fromJSON=function(t){mn.prototype.fromJSON.call(this,t),this.points=[];for(var e=0,n=t.points.length;e<n;e++){var s=t.points[e];this.points.push((new i).fromArray(s))}return this};var Br=Object.freeze({ArcCurve:gn,CatmullRomCurve3:vn,CubicBezierCurve:Sn,CubicBezierCurve3:En,EllipseCurve:fn,LineCurve:Mn,LineCurve3:Tn,QuadraticBezierCurve:Cn,QuadraticBezierCurve3:Pn,SplineCurve:_n});An.prototype=Object.assign(Object.create(mn.prototype),{constructor:An,add:function(t){this.curves.push(t)},closePath:function(){var t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);t.equals(e)||this.curves.push(new Mn(e,t))},getPoint:function(t){var e=t*this.getLength(),i=this.getCurveLengths();for(t=0;t<i.length;){if(i[t]>=e)return e=i[t]-e,i=(t=this.curves[t]).getLength(),t.getPointAt(0===i?0:1-e/i);t++}return null},getLength:function(){var t=this.getCurveLengths();return t[t.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var t=[],e=0,i=0,n=this.curves.length;i<n;i++)e+=this.curves[i].getLength(),t.push(e);return this.cacheLengths=t},getSpacedPoints:function(t){void 0===t&&(t=40);for(var e=[],i=0;i<=t;i++)e.push(this.getPoint(i/t));return this.autoClose&&e.push(e[0]),e},getPoints:function(t){t=t||12;for(var e,i=[],n=0,s=this.curves;n<s.length;n++){var r=s[n];r=r.getPoints(r&&r.isEllipseCurve?2*t:r&&(r.isLineCurve||r.isLineCurve3)?1:r&&r.isSplineCurve?t*r.points.length:t);for(var a=0;a<r.length;a++){var o=r[a];e&&e.equals(o)||(i.push(o),e=o)}}return this.autoClose&&1<i.length&&!i[i.length-1].equals(i[0])&&i.push(i[0]),i},copy:function(t){mn.prototype.copy.call(this,t),this.curves=[];for(var e=0,i=t.curves.length;e<i;e++)this.curves.push(t.curves[e].clone());return this.autoClose=t.autoClose,this},toJSON:function(){var t=mn.prototype.toJSON.call(this);t.autoClose=this.autoClose,t.curves=[];for(var e=0,i=this.curves.length;e<i;e++)t.curves.push(this.curves[e].toJSON());return t},fromJSON:function(t){mn.prototype.fromJSON.call(this,t),this.autoClose=t.autoClose,this.curves=[];for(var e=0,i=t.curves.length;e<i;e++){var n=t.curves[e];this.curves.push((new Br[n.type]).fromJSON(n))}return this}}),Ln.prototype=Object.assign(Object.create(An.prototype),{constructor:Ln,setFromPoints:function(t){this.moveTo(t[0].x,t[0].y);for(var e=1,i=t.length;e<i;e++)this.lineTo(t[e].x,t[e].y)},moveTo:function(t,e){this.currentPoint.set(t,e)},lineTo:function(t,e){var n=new Mn(this.currentPoint.clone(),new i(t,e));this.curves.push(n),this.currentPoint.set(t,e)},quadraticCurveTo:function(t,e,n,s){t=new Cn(this.currentPoint.clone(),new i(t,e),new i(n,s)),this.curves.push(t),this.currentPoint.set(n,s)},bezierCurveTo:function(t,e,n,s,r,a){t=new Sn(this.currentPoint.clone(),new i(t,e),new i(n,s),new i(r,a)),this.curves.push(t),this.currentPoint.set(r,a)},splineThru:function(t){var e=[this.currentPoint.clone()].concat(t);e=new _n(e),this.curves.push(e),this.currentPoint.copy(t[t.length-1])},arc:function(t,e,i,n,s,r){this.absarc(t+this.currentPoint.x,e+this.currentPoint.y,i,n,s,r)},absarc:function(t,e,i,n,s,r){this.absellipse(t,e,i,i,n,s,r)},ellipse:function(t,e,i,n,s,r,a,o){this.absellipse(t+this.currentPoint.x,e+this.currentPoint.y,i,n,s,r,a,o)},absellipse:function(t,e,i,n,s,r,a,o){t=new fn(t,e,i,n,s,r,a,o),0<this.curves.length&&((e=t.getPoint(0)).equals(this.currentPoint)||this.lineTo(e.x,e.y)),this.curves.push(t),t=t.getPoint(1),this.currentPoint.copy(t)},copy:function(t){return An.prototype.copy.call(this,t),this.currentPoint.copy(t.currentPoint),this},toJSON:function(){var t=An.prototype.toJSON.call(this);return t.currentPoint=this.currentPoint.toArray(),t},fromJSON:function(t){return An.prototype.fromJSON.call(this,t),this.currentPoint.fromArray(t.currentPoint),this}}),Rn.prototype=Object.assign(Object.create(Ln.prototype),{constructor:Rn,getPointsHoles:function(t){for(var e=[],i=0,n=this.holes.length;i<n;i++)e[i]=this.holes[i].getPoints(t);return e},extractPoints:function(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}},copy:function(t){Ln.prototype.copy.call(this,t),this.holes=[];for(var e=0,i=t.holes.length;e<i;e++)this.holes.push(t.holes[e].clone());return this},toJSON:function(){var t=Ln.prototype.toJSON.call(this);t.uuid=this.uuid,t.holes=[];for(var e=0,i=this.holes.length;e<i;e++)t.holes.push(this.holes[e].toJSON());return t},fromJSON:function(t){Ln.prototype.fromJSON.call(this,t),this.uuid=t.uuid,this.holes=[];for(var e=0,i=t.holes.length;e<i;e++){var n=t.holes[e];this.holes.push((new Ln).fromJSON(n))}return this}}),In.prototype=Object.assign(Object.create(T.prototype),{constructor:In,isLight:!0,copy:function(t){return T.prototype.copy.call(this,t),this.color.copy(t.color),this.intensity=t.intensity,this},toJSON:function(t){return(t=T.prototype.toJSON.call(this,t)).object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),On.prototype=Object.assign(Object.create(In.prototype),{constructor:On,isHemisphereLight:!0,copy:function(t){return In.prototype.copy.call(this,t),this.groundColor.copy(t.groundColor),this}}),Object.assign(Dn.prototype,{copy:function(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var t={};return 0!==this.bias&&(t.bias=this.bias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}),kn.prototype=Object.assign(Object.create(Dn.prototype),{constructor:kn,isSpotLightShadow:!0,update:function(t){var e=this.camera,i=2*Js.RAD2DEG*t.angle,n=this.mapSize.width/this.mapSize.height;t=t.distance||e.far,i===e.fov&&n===e.aspect&&t===e.far||(e.fov=i,e.aspect=n,e.far=t,e.updateProjectionMatrix())}}),Bn.prototype=Object.assign(Object.create(In.prototype),{constructor:Bn,isSpotLight:!0,copy:function(t){return In.prototype.copy.call(this,t),this.distance=t.distance,this.angle=t.angle,this.penumbra=t.penumbra,this.decay=t.decay,this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),Hn.prototype=Object.assign(Object.create(In.prototype),{constructor:Hn,isPointLight:!0,copy:function(t){return In.prototype.copy.call(this,t),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}),Nn.prototype=Object.assign(Object.create(se.prototype),{constructor:Nn,isOrthographicCamera:!0,copy:function(t,e){return se.prototype.copy.call(this,t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this},setViewOffset:function(t,e,i,n,s,r){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=s,this.view.height=r,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2,s=i-t;if(i+=t,t=n+e,e=n-e,null!==this.view&&this.view.enabled){i=this.zoom/(this.view.width/this.view.fullWidth),e=this.zoom/(this.view.height/this.view.fullHeight);var r=(this.right-this.left)/this.view.width;n=(this.top-this.bottom)/this.view.height,i=(s+=this.view.offsetX/i*r)+this.view.width/i*r,e=(t-=this.view.offsetY/e*n)-this.view.height/e*n}this.projectionMatrix.makeOrthographic(s,i,t,e,this.near,this.far),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},toJSON:function(t){return(t=T.prototype.toJSON.call(this,t)).object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}),Fn.prototype=Object.assign(Object.create(Dn.prototype),{constructor:Fn}),Vn.prototype=Object.assign(Object.create(In.prototype),{constructor:Vn,isDirectionalLight:!0,copy:function(t){return In.prototype.copy.call(this,t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),jn.prototype=Object.assign(Object.create(In.prototype),{constructor:jn,isAmbientLight:!0}),Gn.prototype=Object.assign(Object.create(In.prototype),{constructor:Gn,isRectAreaLight:!0,copy:function(t){return In.prototype.copy.call(this,t),this.width=t.width,this.height=t.height,this},toJSON:function(t){return(t=In.prototype.toJSON.call(this,t)).object.width=this.width,t.object.height=this.height,t}}),Object.assign(Un.prototype,{load:function(t,e,i,n){var s=this,r=new on(s.manager);r.setPath(s.path),r.load(t,function(t){e(s.parse(JSON.parse(t)))},i,n)},parse:function(t){function e(t){return void 0===n[t]&&console.warn("THREE.MaterialLoader: Undefined texture",t),n[t]}var n=this.textures,a=new Pr[t.type];if(void 0!==t.uuid&&(a.uuid=t.uuid),void 0!==t.name&&(a.name=t.name),void 0!==t.color&&a.color.setHex(t.color),void 0!==t.roughness&&(a.roughness=t.roughness),void 0!==t.metalness&&(a.metalness=t.metalness),void 0!==t.emissive&&a.emissive.setHex(t.emissive),void 0!==t.specular&&a.specular.setHex(t.specular),void 0!==t.shininess&&(a.shininess=t.shininess),void 0!==t.clearCoat&&(a.clearCoat=t.clearCoat),void 0!==t.clearCoatRoughness&&(a.clearCoatRoughness=t.clearCoatRoughness),void 0!==t.vertexColors&&(a.vertexColors=t.vertexColors),void 0!==t.fog&&(a.fog=t.fog),void 0!==t.flatShading&&(a.flatShading=t.flatShading),void 0!==t.blending&&(a.blending=t.blending),void 0!==t.combine&&(a.combine=t.combine),void 0!==t.side&&(a.side=t.side),void 0!==t.opacity&&(a.opacity=t.opacity),void 0!==t.transparent&&(a.transparent=t.transparent),void 0!==t.alphaTest&&(a.alphaTest=t.alphaTest),void 0!==t.depthTest&&(a.depthTest=t.depthTest),void 0!==t.depthWrite&&(a.depthWrite=t.depthWrite),void 0!==t.colorWrite&&(a.colorWrite=t.colorWrite),void 0!==t.wireframe&&(a.wireframe=t.wireframe),void 0!==t.wireframeLinewidth&&(a.wireframeLinewidth=t.wireframeLinewidth),void 0!==t.wireframeLinecap&&(a.wireframeLinecap=t.wireframeLinecap),void 0!==t.wireframeLinejoin&&(a.wireframeLinejoin=t.wireframeLinejoin),void 0!==t.rotation&&(a.rotation=t.rotation),1!==t.linewidth&&(a.linewidth=t.linewidth),void 0!==t.dashSize&&(a.dashSize=t.dashSize),void 0!==t.gapSize&&(a.gapSize=t.gapSize),void 0!==t.scale&&(a.scale=t.scale),void 0!==t.polygonOffset&&(a.polygonOffset=t.polygonOffset),void 0!==t.polygonOffsetFactor&&(a.polygonOffsetFactor=t.polygonOffsetFactor),void 0!==t.polygonOffsetUnits&&(a.polygonOffsetUnits=t.polygonOffsetUnits),void 0!==t.skinning&&(a.skinning=t.skinning),void 0!==t.morphTargets&&(a.morphTargets=t.morphTargets),void 0!==t.dithering&&(a.dithering=t.dithering),void 0!==t.visible&&(a.visible=t.visible),void 0!==t.userData&&(a.userData=t.userData),void 0!==t.uniforms)for(var l in t.uniforms){var h=t.uniforms[l];switch(a.uniforms[l]={},h.type){case"t":a.uniforms[l].value=e(h.value);break;case"c":a.uniforms[l].value=(new b).setHex(h.value);break;case"v2":a.uniforms[l].value=(new i).fromArray(h.value);break;case"v3":a.uniforms[l].value=(new s).fromArray(h.value);break;case"v4":a.uniforms[l].value=(new o).fromArray(h.value);break;case"m3":a.uniforms[l].value=(new r).fromArray(h.value);case"m4":a.uniforms[l].value=(new g).fromArray(h.value);break;default:a.uniforms[l].value=h.value}}if(void 0!==t.defines&&(a.defines=t.defines),void 0!==t.vertexShader&&(a.vertexShader=t.vertexShader),void 0!==t.fragmentShader&&(a.fragmentShader=t.fragmentShader),void 0!==t.extensions)for(var c in t.extensions)a.extensions[c]=t.extensions[c];return void 0!==t.shading&&(a.flatShading=1===t.shading),void 0!==t.size&&(a.size=t.size),void 0!==t.sizeAttenuation&&(a.sizeAttenuation=t.sizeAttenuation),void 0!==t.map&&(a.map=e(t.map)),void 0!==t.matcap&&(a.matcap=e(t.matcap)),void 0!==t.alphaMap&&(a.alphaMap=e(t.alphaMap),a.transparent=!0),void 0!==t.bumpMap&&(a.bumpMap=e(t.bumpMap)),void 0!==t.bumpScale&&(a.bumpScale=t.bumpScale),void 0!==t.normalMap&&(a.normalMap=e(t.normalMap)),void 0!==t.normalMapType&&(a.normalMapType=t.normalMapType),void 0!==t.normalScale&&(l=t.normalScale,!1===Array.isArray(l)&&(l=[l,l]),a.normalScale=(new i).fromArray(l)),void 0!==t.displacementMap&&(a.displacementMap=e(t.displacementMap)),void 0!==t.displacementScale&&(a.displacementScale=t.displacementScale),void 0!==t.displacementBias&&(a.displacementBias=t.displacementBias),void 0!==t.roughnessMap&&(a.roughnessMap=e(t.roughnessMap)),void 0!==t.metalnessMap&&(a.metalnessMap=e(t.metalnessMap)),void 0!==t.emissiveMap&&(a.emissiveMap=e(t.emissiveMap)),void 0!==t.emissiveIntensity&&(a.emissiveIntensity=t.emissiveIntensity),void 0!==t.specularMap&&(a.specularMap=e(t.specularMap)),void 0!==t.envMap&&(a.envMap=e(t.envMap)),void 0!==t.envMapIntensity&&(a.envMapIntensity=t.envMapIntensity),void 0!==t.reflectivity&&(a.reflectivity=t.reflectivity),void 0!==t.lightMap&&(a.lightMap=e(t.lightMap)),void 0!==t.lightMapIntensity&&(a.lightMapIntensity=t.lightMapIntensity),void 0!==t.aoMap&&(a.aoMap=e(t.aoMap)),void 0!==t.aoMapIntensity&&(a.aoMapIntensity=t.aoMapIntensity),void 0!==t.gradientMap&&(a.gradientMap=e(t.gradientMap)),a},setPath:function(t){return this.path=t,this},setTextures:function(t){return this.textures=t,this}});var Hr={decodeText:function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);for(var e="",i=0,n=t.length;i<n;i++)e+=String.fromCharCode(t[i]);try{return decodeURIComponent(escape(e))}catch(t){return e}},extractUrlBase:function(t){var e=t.lastIndexOf("/");return-1===e?"./":t.substr(0,e+1)}};zn.prototype=Object.assign(Object.create(F.prototype),{constructor:zn,isInstancedBufferGeometry:!0,copy:function(t){return F.prototype.copy.call(this,t),this.maxInstancedCount=t.maxInstancedCount,this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var t=F.prototype.toJSON.call(this);return t.maxInstancedCount=this.maxInstancedCount,t.isInstancedBufferGeometry=!0,t}}),Wn.prototype=Object.assign(Object.create(P.prototype),{constructor:Wn,isInstancedBufferAttribute:!0,copy:function(t){return P.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},toJSON:function(){var t=P.prototype.toJSON.call(this);return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}),Object.assign(qn.prototype,{load:function(t,e,i,n){var s=this,r=new on(s.manager);r.setPath(s.path),r.load(t,function(t){e(s.parse(JSON.parse(t)))},i,n)},parse:function(t){var e=t.isInstancedBufferGeometry?new zn:new F,i=t.data.index;if(void 0!==i){var n=new Nr[i.type](i.array);e.setIndex(new P(n,1))}for(var r in i=t.data.attributes){var a=i[r];n=new Nr[a.type](a.array),n=new(a.isInstancedBufferAttribute?Wn:P)(n,a.itemSize,a.normalized),void 0!==a.name&&(n.name=a.name),e.addAttribute(r,n)}var o=t.data.morphAttributes;if(o)for(r in o){var l=o[r],h=[];i=0;for(var c=l.length;i<c;i++)a=l[i],n=new P(n=new Nr[a.type](a.array),a.itemSize,a.normalized),void 0!==a.name&&(n.name=a.name),h.push(n);e.morphAttributes[r]=h}if(void 0!==(r=t.data.groups||t.data.drawcalls||t.data.offsets))for(i=0,a=r.length;i!==a;++i)n=r[i],e.addGroup(n.start,n.count,n.materialIndex);return void 0!==(i=t.data.boundingSphere)&&(r=new s,void 0!==i.center&&r.fromArray(i.center),e.boundingSphere=new p(r,i.radius)),t.name&&(e.name=t.name),t.userData&&(e.userData=t.userData),e},setPath:function(t){return this.path=t,this}});var Nr={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:"undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};Object.assign(Yn.prototype,{crossOrigin:"anonymous",load:function(t,e,i,n){var s=this,r=void 0===this.path?Hr.extractUrlBase(t):this.path;this.resourcePath=this.resourcePath||r,(r=new on(s.manager)).setPath(this.path),r.load(t,function(i){var r=null;try{r=JSON.parse(i)}catch(e){return void 0!==n&&n(e),void console.error("THREE:ObjectLoader: Can't parse "+t+".",e.message)}void 0===(i=r.metadata)||void 0===i.type||"geometry"===i.type.toLowerCase()?console.error("THREE.ObjectLoader: Can't load "+t):s.parse(r,e)},i,n)},setPath:function(t){return this.path=t,this},setResourcePath:function(t){return this.resourcePath=t,this},setCrossOrigin:function(t){return this.crossOrigin=t,this},parse:function(t,e){var i=this.parseShape(t.shapes);i=this.parseGeometries(t.geometries,i);var n=this.parseImages(t.images,function(){void 0!==e&&e(s)});n=this.parseTextures(t.textures,n),n=this.parseMaterials(t.materials,n);var s=this.parseObject(t.object,i,n);return t.animations&&(s.animations=this.parseAnimations(t.animations)),void 0!==t.images&&0!==t.images.length||void 0===e||e(s),s},parseShape:function(t){var e={};if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var s=(new Rn).fromJSON(t[i]);e[s.uuid]=s}return e},parseGeometries:function(t,e){var i={};if(void 0!==t)for(var n=new qn,s=0,r=t.length;s<r;s++){var a=t[s];switch(a.type){case"PlaneGeometry":case"PlaneBufferGeometry":var o=new Cr[a.type](a.width,a.height,a.widthSegments,a.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":o=new Cr[a.type](a.width,a.height,a.depth,a.widthSegments,a.heightSegments,a.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":o=new Cr[a.type](a.radius,a.segments,a.thetaStart,a.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":o=new Cr[a.type](a.radiusTop,a.radiusBottom,a.height,a.radialSegments,a.heightSegments,a.openEnded,a.thetaStart,a.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":o=new Cr[a.type](a.radius,a.height,a.radialSegments,a.heightSegments,a.openEnded,a.thetaStart,a.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":o=new Cr[a.type](a.radius,a.widthSegments,a.heightSegments,a.phiStart,a.phiLength,a.thetaStart,a.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":o=new Cr[a.type](a.radius,a.detail);break;case"RingGeometry":case"RingBufferGeometry":o=new Cr[a.type](a.innerRadius,a.outerRadius,a.thetaSegments,a.phiSegments,a.thetaStart,a.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":o=new Cr[a.type](a.radius,a.tube,a.radialSegments,a.tubularSegments,a.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":o=new Cr[a.type](a.radius,a.tube,a.tubularSegments,a.radialSegments,a.p,a.q);break;case"TubeGeometry":case"TubeBufferGeometry":o=new Cr[a.type]((new Br[a.path.type]).fromJSON(a.path),a.tubularSegments,a.radius,a.radialSegments,a.closed);break;case"LatheGeometry":case"LatheBufferGeometry":o=new Cr[a.type](a.points,a.segments,a.phiStart,a.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":o=new Cr[a.type](a.vertices,a.indices,a.radius,a.details);break;case"ShapeGeometry":case"ShapeBufferGeometry":o=[];for(var l=0,h=a.shapes.length;l<h;l++){var c=e[a.shapes[l]];o.push(c)}o=new Cr[a.type](o,a.curveSegments);break;case"ExtrudeGeometry":case"ExtrudeBufferGeometry":for(o=[],l=0,h=a.shapes.length;l<h;l++)c=e[a.shapes[l]],o.push(c);void 0!==(l=a.options.extrudePath)&&(a.options.extrudePath=(new Br[l.type]).fromJSON(l)),o=new Cr[a.type](o,a.options);break;case"BufferGeometry":case"InstancedBufferGeometry":o=n.parse(a);break;case"Geometry":"THREE"in window&&"LegacyJSONLoader"in THREE?o=(new THREE.LegacyJSONLoader).parse(a,this.resourcePath).geometry:console.error('THREE.ObjectLoader: You have to import LegacyJSONLoader in order load geometry data of type "Geometry".');break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+a.type+'"');continue}o.uuid=a.uuid,void 0!==a.name&&(o.name=a.name),!0===o.isBufferGeometry&&void 0!==a.userData&&(o.userData=a.userData),i[a.uuid]=o}return i},parseMaterials:function(t,e){var i={},n={};if(void 0!==t){var s=new Un;s.setTextures(e),e=0;for(var r=t.length;e<r;e++){var a=t[e];if("MultiMaterial"===a.type){for(var o=[],l=0;l<a.materials.length;l++){var h=a.materials[l];void 0===i[h.uuid]&&(i[h.uuid]=s.parse(h)),o.push(i[h.uuid])}n[a.uuid]=o}else void 0===i[a.uuid]&&(i[a.uuid]=s.parse(a)),n[a.uuid]=i[a.uuid]}}return n},parseAnimations:function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i],s=sn.parse(n);void 0!==n.uuid&&(s.uuid=n.uuid),e.push(s)}return e},parseImages:function(t,e){function i(t){return n.manager.itemStart(t),r.load(t,function(){n.manager.itemEnd(t)},void 0,function(){n.manager.itemError(t),n.manager.itemEnd(t)})}var n=this,s={};if(void 0!==t&&0<t.length){var r=new un(e=new an(e));r.setCrossOrigin(this.crossOrigin),e=0;for(var a=t.length;e<a;e++){var o=t[e],l=o.url;if(Array.isArray(l)){s[o.uuid]=[];for(var h=0,c=l.length;h<c;h++){var u=l[h];u=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(u)?u:n.resourcePath+u,s[o.uuid].push(i(u))}}else u=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(o.url)?o.url:n.resourcePath+o.url,s[o.uuid]=i(u)}}return s},parseTextures:function(t,e){function i(t,e){return"number"==typeof t?t:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",t),e[t])}var n={};if(void 0!==t)for(var s=0,r=t.length;s<r;s++){var o=t[s];void 0===o.image&&console.warn('THREE.ObjectLoader: No "image" specified for',o.uuid),void 0===e[o.image]&&console.warn("THREE.ObjectLoader: Undefined image",o.image);var l=Array.isArray(e[o.image])?new tt(e[o.image]):new a(e[o.image]);l.needsUpdate=!0,l.uuid=o.uuid,void 0!==o.name&&(l.name=o.name),void 0!==o.mapping&&(l.mapping=i(o.mapping,Fr)),void 0!==o.offset&&l.offset.fromArray(o.offset),void 0!==o.repeat&&l.repeat.fromArray(o.repeat),void 0!==o.center&&l.center.fromArray(o.center),void 0!==o.rotation&&(l.rotation=o.rotation),void 0!==o.wrap&&(l.wrapS=i(o.wrap[0],Vr),l.wrapT=i(o.wrap[1],Vr)),void 0!==o.format&&(l.format=o.format),void 0!==o.type&&(l.type=o.type),void 0!==o.encoding&&(l.encoding=o.encoding),void 0!==o.minFilter&&(l.minFilter=i(o.minFilter,jr)),void 0!==o.magFilter&&(l.magFilter=i(o.magFilter,jr)),void 0!==o.anisotropy&&(l.anisotropy=o.anisotropy),void 0!==o.flipY&&(l.flipY=o.flipY),void 0!==o.premultiplyAlpha&&(l.premultiplyAlpha=o.premultiplyAlpha),void 0!==o.unpackAlignment&&(l.unpackAlignment=o.unpackAlignment),n[o.uuid]=l}return n},parseObject:function(t,e,i){function n(t){return void 0===e[t]&&console.warn("THREE.ObjectLoader: Undefined geometry",t),e[t]}function s(t){if(void 0!==t){if(Array.isArray(t)){for(var e=[],n=0,s=t.length;n<s;n++){var r=t[n];void 0===i[r]&&console.warn("THREE.ObjectLoader: Undefined material",r),e.push(i[r])}return e}return void 0===i[t]&&console.warn("THREE.ObjectLoader: Undefined material",t),i[t]}}switch(t.type){case"Scene":var r=new pe;void 0!==t.background&&Number.isInteger(t.background)&&(r.background=new b(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?r.fog=new de(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(r.fog=new ue(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":r=new re(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(r.focus=t.focus),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.filmGauge&&(r.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(r.filmOffset=t.filmOffset),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"OrthographicCamera":r=new Nn(t.left,t.right,t.top,t.bottom,t.near,t.far),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"AmbientLight":r=new jn(t.color,t.intensity);break;case"DirectionalLight":r=new Vn(t.color,t.intensity);break;case"PointLight":r=new Hn(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":r=new Gn(t.color,t.intensity,t.width,t.height);break;case"SpotLight":r=new Bn(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":r=new On(t.color,t.groundColor,t.intensity);break;case"SkinnedMesh":console.warn("THREE.ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":r=n(t.geometry);var a=s(t.material);r=r.bones&&0<r.bones.length?new be(r,a):new J(r,a),void 0!==t.drawMode&&r.setDrawMode(t.drawMode);break;case"LOD":r=new ve;break;case"Line":r=new Ee(n(t.geometry),s(t.material),t.mode);break;case"LineLoop":r=new Te(n(t.geometry),s(t.material));break;case"LineSegments":r=new Me(n(t.geometry),s(t.material));break;case"PointCloud":case"Points":r=new Pe(n(t.geometry),s(t.material));break;case"Sprite":r=new ye(s(t.material));break;case"Group":r=new ne;break;default:r=new T}if(r.uuid=t.uuid,void 0!==t.name&&(r.name=t.name),void 0!==t.matrix?(r.matrix.fromArray(t.matrix),void 0!==t.matrixAutoUpdate&&(r.matrixAutoUpdate=t.matrixAutoUpdate),r.matrixAutoUpdate&&r.matrix.decompose(r.position,r.quaternion,r.scale)):(void 0!==t.position&&r.position.fromArray(t.position),void 0!==t.rotation&&r.rotation.fromArray(t.rotation),void 0!==t.quaternion&&r.quaternion.fromArray(t.quaternion),void 0!==t.scale&&r.scale.fromArray(t.scale)),void 0!==t.castShadow&&(r.castShadow=t.castShadow),void 0!==t.receiveShadow&&(r.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(r.shadow.bias=t.shadow.bias),void 0!==t.shadow.radius&&(r.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&r.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(r.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(r.visible=t.visible),void 0!==t.frustumCulled&&(r.frustumCulled=t.frustumCulled),void 0!==t.renderOrder&&(r.renderOrder=t.renderOrder),void 0!==t.userData&&(r.userData=t.userData),void 0!==t.layers&&(r.layers.mask=t.layers),void 0!==t.children){a=t.children;for(var o=0;o<a.length;o++)r.add(this.parseObject(a[o],e,i))}if("LOD"===t.type)for(t=t.levels,a=0;a<t.length;a++){o=t[a];var l=r.getObjectByProperty("uuid",o.object);void 0!==l&&r.addLevel(l,o.distance)}return r}});var Fr={UVMapping:300,CubeReflectionMapping:301,CubeRefractionMapping:302,EquirectangularReflectionMapping:303,EquirectangularRefractionMapping:304,SphericalReflectionMapping:305,CubeUVReflectionMapping:306,CubeUVRefractionMapping:307},Vr={RepeatWrapping:1e3,ClampToEdgeWrapping:1001,MirroredRepeatWrapping:1002},jr={NearestFilter:1003,NearestMipMapNearestFilter:1004,NearestMipMapLinearFilter:1005,LinearFilter:1006,LinearMipMapNearestFilter:1007,LinearMipMapLinearFilter:1008};Xn.prototype={constructor:Xn,setOptions:function(t){return this.options=t,this},load:function(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var s=this,r=Ar.get(t);if(void 0!==r)return s.manager.itemStart(t),setTimeout(function(){e&&e(r),s.manager.itemEnd(t)},0),r;fetch(t).then(function(t){return t.blob()}).then(function(t){return void 0===s.options?createImageBitmap(t):createImageBitmap(t,s.options)}).then(function(i){Ar.add(t,i),e&&e(i),s.manager.itemEnd(t)}).catch(function(e){n&&n(e),s.manager.itemError(t),s.manager.itemEnd(t)}),s.manager.itemStart(t)},setCrossOrigin:function(){return this},setPath:function(t){return this.path=t,this}},Object.assign(Jn.prototype,{moveTo:function(t,e){this.currentPath=new Ln,this.subPaths.push(this.currentPath),this.currentPath.moveTo(t,e)},lineTo:function(t,e){this.currentPath.lineTo(t,e)},quadraticCurveTo:function(t,e,i,n){this.currentPath.quadraticCurveTo(t,e,i,n)},bezierCurveTo:function(t,e,i,n,s,r){this.currentPath.bezierCurveTo(t,e,i,n,s,r)},splineThru:function(t){this.currentPath.splineThru(t)},toShapes:function(t,e){function i(t){for(var e=[],i=0,n=t.length;i<n;i++){var s=t[i],r=new Rn;r.curves=s.curves,e.push(r)}return e}function n(t,e){for(var i=e.length,n=!1,s=i-1,r=0;r<i;s=r++){var a=e[s],o=e[r],l=o.x-a.x,h=o.y-a.y;if(Math.abs(h)>Number.EPSILON){if(0>h&&(a=e[r],l=-l,o=e[s],h=-h),!(t.y<a.y||t.y>o.y))if(t.y===a.y){if(t.x===a.x)return!0}else{if(0===(s=h*(t.x-a.x)-l*(t.y-a.y)))return!0;0>s||(n=!n)}}else if(t.y===a.y&&(o.x<=t.x&&t.x<=a.x||a.x<=t.x&&t.x<=o.x))return!0}return n}var s=Mr.isClockWise,r=this.subPaths;if(0===r.length)return[];if(!0===e)return i(r);if(e=[],1===r.length){var a=r[0],o=new Rn;return o.curves=a.curves,e.push(o),e}var l=!s(r[0].getPoints());l=t?!l:l,o=[];var h=[],c=[],u=0;h[u]=void 0,c[u]=[];for(var d=0,p=r.length;d<p;d++){var m=(a=r[d]).getPoints(),f=s(m);(f=t?!f:f)?(!l&&h[u]&&u++,h[u]={s:new Rn,p:m},h[u].s.curves=a.curves,l&&u++,c[u]=[]):c[u].push({h:a,p:m[0]})}if(!h[0])return i(r);if(1<h.length){for(d=!1,t=[],s=0,r=h.length;s<r;s++)o[s]=[];for(s=0,r=h.length;s<r;s++)for(a=c[s],f=0;f<a.length;f++){for(l=a[f],u=!0,m=0;m<h.length;m++)n(l.p,h[m].p)&&(s!==m&&t.push({froms:s,tos:m,hole:f}),u?(u=!1,o[m].push(l)):d=!0);u&&o[s].push(l)}0<t.length&&(d||(c=o))}for(d=0,s=h.length;d<s;d++)for(o=h[d].s,e.push(o),r=0,a=(t=c[d]).length;r<a;r++)o.holes.push(t[r].h);return e}}),Object.assign(Kn.prototype,{isFont:!0,generateShapes:function(t,e){void 0===e&&(e=100);var i=[],n=e;e=this.data;var s=Array.from?Array.from(t):String(t).split("");n/=e.resolution;var r=(e.boundingBox.yMax-e.boundingBox.yMin+e.underlineThickness)*n;t=[];for(var a=0,o=0,l=0;l<s.length;l++){var h=s[l];if("\n"===h)a=0,o-=r;else{var c=n,u=a,d=o;if(h=e.glyphs[h]||e.glyphs["?"]){var p=new Jn;if(h.o)for(var m=h._cachedOutline||(h._cachedOutline=h.o.split(" ")),f=0,g=m.length;f<g;)switch(m[f++]){case"m":var y=m[f++]*c+u,v=m[f++]*c+d;p.moveTo(y,v);break;case"l":y=m[f++]*c+u,v=m[f++]*c+d,p.lineTo(y,v);break;case"q":var b=m[f++]*c+u,w=m[f++]*c+d,x=m[f++]*c+u,S=m[f++]*c+d;p.quadraticCurveTo(x,S,b,w);break;case"b":b=m[f++]*c+u,w=m[f++]*c+d,x=m[f++]*c+u,S=m[f++]*c+d,y=m[f++]*c+u,v=m[f++]*c+d,p.bezierCurveTo(x,S,y,v,b,w)}c={offsetX:h.ha*c,path:p}}else c=void 0;a+=c.offsetX,t.push(c.path)}}for(e=0,s=t.length;e<s;e++)Array.prototype.push.apply(i,t[e].toShapes());return i}}),Object.assign(Zn.prototype,{load:function(t,e,i,n){var s=this,r=new on(this.manager);r.setPath(this.path),r.load(t,function(t){try{var i=JSON.parse(t)}catch(e){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),i=JSON.parse(t.substring(65,t.length-2))}t=s.parse(i),e&&e(t)},i,n)},parse:function(t){return new Kn(t)},setPath:function(t){return this.path=t,this}}),Qn.Handlers={handlers:[],add:function(t,e){this.handlers.push(t,e)},get:function(t){for(var e=this.handlers,i=0,n=e.length;i<n;i+=2){var s=e[i+1];if(e[i].test(t))return s}return null}},Object.assign(Qn.prototype,{crossOrigin:"anonymous",onLoadStart:function(){},onLoadProgress:function(){},onLoadComplete:function(){},initMaterials:function(t,e,i){for(var n=[],s=0;s<t.length;++s)n[s]=this.createMaterial(t[s],e,i);return n},createMaterial:function(){var t={NoBlending:0,NormalBlending:1,AdditiveBlending:2,SubtractiveBlending:3,MultiplyBlending:4,CustomBlending:5},e=new b,i=new pn,n=new Un;return function(s,r,a){function o(t,e,n,s,o){t=r+t;var l=Qn.Handlers.get(t);return null!==l?t=l.load(t):(i.setCrossOrigin(a),t=i.load(t)),void 0!==e&&(t.repeat.fromArray(e),1!==e[0]&&(t.wrapS=1e3),1!==e[1]&&(t.wrapT=1e3)),void 0!==n&&t.offset.fromArray(n),void 0!==s&&("repeat"===s[0]&&(t.wrapS=1e3),"mirror"===s[0]&&(t.wrapS=1002),"repeat"===s[1]&&(t.wrapT=1e3),"mirror"===s[1]&&(t.wrapT=1002)),void 0!==o&&(t.anisotropy=o),e=Js.generateUUID(),h[e]=t,e}var l,h={},c={uuid:Js.generateUUID(),type:"MeshLambertMaterial"};for(l in s){var u=s[l];switch(l){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":c.name=u;break;case"blending":c.blending=t[u];break;case"colorAmbient":case"mapAmbient":console.warn("THREE.Loader.createMaterial:",l,"is no longer supported.");break;case"colorDiffuse":c.color=e.fromArray(u).getHex();break;case"colorSpecular":c.specular=e.fromArray(u).getHex();break;case"colorEmissive":c.emissive=e.fromArray(u).getHex();break;case"specularCoef":c.shininess=u;break;case"shading":"basic"===u.toLowerCase()&&(c.type="MeshBasicMaterial"),"phong"===u.toLowerCase()&&(c.type="MeshPhongMaterial"),"standard"===u.toLowerCase()&&(c.type="MeshStandardMaterial");break;case"mapDiffuse":c.map=o(u,s.mapDiffuseRepeat,s.mapDiffuseOffset,s.mapDiffuseWrap,s.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":c.emissiveMap=o(u,s.mapEmissiveRepeat,s.mapEmissiveOffset,s.mapEmissiveWrap,s.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":c.lightMap=o(u,s.mapLightRepeat,s.mapLightOffset,s.mapLightWrap,s.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":c.aoMap=o(u,s.mapAORepeat,s.mapAOOffset,s.mapAOWrap,s.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":c.bumpMap=o(u,s.mapBumpRepeat,s.mapBumpOffset,s.mapBumpWrap,s.mapBumpAnisotropy);break;case"mapBumpScale":c.bumpScale=u;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":c.normalMap=o(u,s.mapNormalRepeat,s.mapNormalOffset,s.mapNormalWrap,s.mapNormalAnisotropy);break;case"mapNormalFactor":c.normalScale=u;break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":c.specularMap=o(u,s.mapSpecularRepeat,s.mapSpecularOffset,s.mapSpecularWrap,s.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":c.metalnessMap=o(u,s.mapMetalnessRepeat,s.mapMetalnessOffset,s.mapMetalnessWrap,s.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":c.roughnessMap=o(u,s.mapRoughnessRepeat,s.mapRoughnessOffset,s.mapRoughnessWrap,s.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":c.alphaMap=o(u,s.mapAlphaRepeat,s.mapAlphaOffset,s.mapAlphaWrap,s.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":c.side=1;break;case"doubleSided":c.side=2;break;case"transparency":console.warn("THREE.Loader.createMaterial: transparency has been renamed to opacity"),c.opacity=u;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":c[l]=u;break;case"vertexColors":!0===u&&(c.vertexColors=2),"face"===u&&(c.vertexColors=1);break;default:console.error("THREE.Loader.createMaterial: Unsupported",l,u)}}return"MeshBasicMaterial"===c.type&&delete c.emissive,"MeshPhongMaterial"!==c.type&&delete c.specular,1>c.opacity&&(c.transparent=!0),n.setTextures(h),n.parse(c)}}()});var Gr,Ur,zr,Wr={getContext:function(){return void 0===Gr&&(Gr=new(window.AudioContext||window.webkitAudioContext)),Gr},setContext:function(t){Gr=t}};Object.assign($n.prototype,{load:function(t,e,i,n){var s=new on(this.manager);s.setResponseType("arraybuffer"),s.setPath(this.path),s.load(t,function(t){t=t.slice(0),Wr.getContext().decodeAudioData(t,function(t){e(t)})},i,n)},setPath:function(t){return this.path=t,this}}),Object.assign(ts.prototype,{isSphericalHarmonics3:!0,set:function(t){for(var e=0;9>e;e++)this.coefficients[e].copy(t[e]);return this},zero:function(){for(var t=0;9>t;t++)this.coefficients[t].set(0,0,0);return this},getAt:function(t,e){var i=t.x,n=t.y;t=t.z;var s=this.coefficients;return e=.282095*s[0],e+=.488603*s[1]*n,e+=.488603*s[2]*t,e+=.488603*s[3]*i,e+=1.092548*s[4]*i*n,e+=1.092548*s[5]*n*t,e+=.315392*s[6]*(3*t*t-1),(e+=1.092548*s[7]*i*t)+.546274*s[8]*(i*i-n*n)},getIrradianceAt:function(t,e){var i=t.x,n=t.y;t=t.z;var s=this.coefficients;return e=.886227*s[0],e+=1.023328*s[1]*n,e+=1.023328*s[2]*t,e+=1.023328*s[3]*i,e+=.858086*s[4]*i*n,e+=.858086*s[5]*n*t,e+=s[6]*(.743125*t*t-.247708),(e+=.858086*s[7]*i*t)+.429043*s[8]*(i*i-n*n)},add:function(t){for(var e=0;9>e;e++)this.coefficients[e].add(t.coefficients[e]);return this},scale:function(t){for(var e=0;9>e;e++)this.coefficients[e].multiplyScalar(t);return this},lerp:function(t,e){for(var i=0;9>i;i++)this.coefficients[i].lerp(t.coefficients[i],e);return this},equals:function(t){for(var e=0;9>e;e++)if(!this.coefficients[e].equals(t.coefficients[e]))return!1;return!0},copy:function(t){return this.set(t.coefficients)},clone:function(){return(new this.constructor).copy(this)},fromArray:function(t){for(var e=this.coefficients,i=0;9>i;i++)e[i].fromArray(t,3*i);return this},toArray:function(){for(var t=[],e=this.coefficients,i=0;9>i;i++)e[i].toArray(t,3*i);return t}}),Object.assign(ts,{getBasisAt:function(t,e){var i=t.x,n=t.y;t=t.z,e[0]=.282095,e[1]=.488603*n,e[2]=.488603*t,e[3]=.488603*i,e[4]=1.092548*i*n,e[5]=1.092548*n*t,e[6]=.315392*(3*t*t-1),e[7]=1.092548*i*t,e[8]=.546274*(i*i-n*n)}}),es.prototype=Object.assign(Object.create(In.prototype),{constructor:es,isLightProbe:!0,copy:function(t){return In.prototype.copy.call(this,t),this.sh.copy(t.sh),this.intensity=t.intensity,this},toJSON:function(t){return In.prototype.toJSON.call(this,t)}}),is.prototype=Object.assign(Object.create(es.prototype),{constructor:is,isHemisphereLightProbe:!0,copy:function(t){return es.prototype.copy.call(this,t),this},toJSON:function(t){return es.prototype.toJSON.call(this,t)}}),ns.prototype=Object.assign(Object.create(es.prototype),{constructor:ns,isAmbientLightProbe:!0,copy:function(t){return es.prototype.copy.call(this,t),this},toJSON:function(t){return es.prototype.toJSON.call(this,t)}}),Object.assign(ss.prototype,{update:function(){var t,e,i,n,s,r,a,o,l=new g,h=new g;return function(c){if(t!==this||e!==c.focus||i!==c.fov||n!==c.aspect*this.aspect||s!==c.near||r!==c.far||a!==c.zoom||o!==this.eyeSep){t=this,e=c.focus,i=c.fov,n=c.aspect*this.aspect,s=c.near,r=c.far,a=c.zoom;var u=c.projectionMatrix.clone(),d=(o=this.eyeSep/2)*s/e,p=s*Math.tan(Js.DEG2RAD*i*.5)/a;h.elements[12]=-o,l.elements[12]=o;var m=-p*n+d,f=p*n+d;u.elements[0]=2*s/(f-m),u.elements[8]=(f+m)/(f-m),this.cameraL.projectionMatrix.copy(u),m=-p*n-d,f=p*n-d,u.elements[0]=2*s/(f-m),u.elements[8]=(f+m)/(f-m),this.cameraR.projectionMatrix.copy(u)}this.cameraL.matrixWorld.copy(c.matrixWorld).multiply(h),this.cameraR.matrixWorld.copy(c.matrixWorld).multiply(l)}}()}),rs.prototype=Object.create(T.prototype),rs.prototype.constructor=rs,Object.assign(as.prototype,{start:function(){this.oldTime=this.startTime=("undefined"==typeof performance?Date:performance).now(),this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.autoStart=this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var e=("undefined"==typeof performance?Date:performance).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}),os.prototype=Object.assign(Object.create(T.prototype),{constructor:os,getInput:function(){return this.gain},removeFilter:function(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this},getFilter:function(){return this.filter},setFilter:function(t){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=t,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this},updateMatrixWorld:function(){var t=new s,e=new n,i=new s,r=new s,a=new as;return function(n){T.prototype.updateMatrixWorld.call(this,n),n=this.context.listener;var s=this.up;if(this.timeDelta=a.getDelta(),this.matrixWorld.decompose(t,e,i),r.set(0,0,-1).applyQuaternion(e),n.positionX){var o=this.context.currentTime+this.timeDelta;n.positionX.linearRampToValueAtTime(t.x,o),n.positionY.linearRampToValueAtTime(t.y,o),n.positionZ.linearRampToValueAtTime(t.z,o),n.forwardX.linearRampToValueAtTime(r.x,o),n.forwardY.linearRampToValueAtTime(r.y,o),n.forwardZ.linearRampToValueAtTime(r.z,o),n.upX.linearRampToValueAtTime(s.x,o),n.upY.linearRampToValueAtTime(s.y,o),n.upZ.linearRampToValueAtTime(s.z,o)}else n.setPosition(t.x,t.y,t.z),n.setOrientation(r.x,r.y,r.z,s.x,s.y,s.z)}}()}),ls.prototype=Object.assign(Object.create(T.prototype),{constructor:ls,getOutput:function(){return this.gain},setNodeSource:function(t){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=t,this.connect(),this},setMediaElementSource:function(t){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(t),this.connect(),this},setBuffer:function(t){return this.buffer=t,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0===this.isPlaying)console.warn("THREE.Audio: Audio is already playing.");else{if(!1!==this.hasPlaybackControl){var t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.onended=this.onEnded.bind(this),this.startTime=this.context.currentTime,t.start(this.startTime,this.offset),this.isPlaying=!0,this.source=t,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}console.warn("THREE.Audio: this Audio has no playback control.")}},pause:function(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this.source.stop(),this.source.onended=null,this.offset+=(this.context.currentTime-this.startTime)*this.playbackRate,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")},stop:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.source.onended=null,this.offset=0,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")},connect:function(){if(0<this.filters.length){this.source.connect(this.filters[0]);for(var t=1,e=this.filters.length;t<e;t++)this.filters[t-1].connect(this.filters[t]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(0<this.filters.length){this.source.disconnect(this.filters[0]);for(var t=1,e=this.filters.length;t<e;t++)this.filters[t-1].disconnect(this.filters[t]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(t){return t||(t=[]),!0===this.isPlaying?(this.disconnect(),this.filters=t,this.connect()):this.filters=t,this},setDetune:function(t){if(this.detune=t,void 0!==this.source.detune)return!0===this.isPlaying&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this},getDetune:function(){return this.detune},getFilter:function(){return this.getFilters()[0]},setFilter:function(t){return this.setFilters(t?[t]:[])},setPlaybackRate:function(t){if(!1!==this.hasPlaybackControl)return this.playbackRate=t,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("THREE.Audio: this Audio has no playback control.")},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(t){if(!1!==this.hasPlaybackControl)return this.loop=t,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")},getVolume:function(){return this.gain.gain.value},setVolume:function(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}}),hs.prototype=Object.assign(Object.create(ls.prototype),{constructor:hs,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(t){return this.panner.refDistance=t,this},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(t){return this.panner.rolloffFactor=t,this},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(t){return this.panner.distanceModel=t,this},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(t){return this.panner.maxDistance=t,this},setDirectionalCone:function(t,e,i){return this.panner.coneInnerAngle=t,this.panner.coneOuterAngle=e,this.panner.coneOuterGain=i,this},updateMatrixWorld:function(){var t=new s,e=new n,i=new s,r=new s;return function(n){if(T.prototype.updateMatrixWorld.call(this,n),!0!==this.hasPlaybackControl||!1!==this.isPlaying)if(this.matrixWorld.decompose(t,e,i),r.set(0,0,1).applyQuaternion(e),(n=this.panner).positionX){var s=this.context.currentTime+this.listener.timeDelta;n.positionX.linearRampToValueAtTime(t.x,s),n.positionY.linearRampToValueAtTime(t.y,s),n.positionZ.linearRampToValueAtTime(t.z,s),n.orientationX.linearRampToValueAtTime(r.x,s),n.orientationY.linearRampToValueAtTime(r.y,s),n.orientationZ.linearRampToValueAtTime(r.z,s)}else n.setPosition(t.x,t.y,t.z),n.setOrientation(r.x,r.y,r.z)}}()}),Object.assign(cs.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var t=0,e=this.getFrequencyData(),i=0;i<e.length;i++)t+=e[i];return t/e.length}}),Object.assign(us.prototype,{accumulate:function(t,e){var i=this.buffer,n=this.valueSize;t=t*n+n;var s=this.cumulativeWeight;if(0===s){for(s=0;s!==n;++s)i[t+s]=i[s];s=e}else s+=e,this._mixBufferRegion(i,t,0,e/s,n);this.cumulativeWeight=s},apply:function(t){var e=this.valueSize,i=this.buffer;t=t*e+e;var n=this.cumulativeWeight,s=this.binding;this.cumulativeWeight=0,1>n&&this._mixBufferRegion(i,t,3*e,1-n,e),n=e;for(var r=e+e;n!==r;++n)if(i[n]!==i[n+e]){s.setValue(i,t);break}},saveOriginalState:function(){var t=this.buffer,e=this.valueSize,i=3*e;this.binding.getValue(t,i);for(var n=e;n!==i;++n)t[n]=t[i+n%e];this.cumulativeWeight=0},restoreOriginalState:function(){this.binding.setValue(this.buffer,3*this.valueSize)},_select:function(t,e,i,n,s){if(.5<=n)for(n=0;n!==s;++n)t[e+n]=t[i+n]},_slerp:function(t,e,i,s){n.slerpFlat(t,e,t,e,t,i,s)},_lerp:function(t,e,i,n,s){for(var r=1-n,a=0;a!==s;++a){var o=e+a;t[o]=t[o]*r+t[i+a]*n}}}),Object.assign(ds.prototype,{getValue:function(t,e){this.bind();var i=this._bindings[this._targetGroup.nCachedObjects_];void 0!==i&&i.getValue(t,e)},setValue:function(t,e){for(var i=this._bindings,n=this._targetGroup.nCachedObjects_,s=i.length;n!==s;++n)i[n].setValue(t,e)},bind:function(){for(var t=this._bindings,e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].bind()},unbind:function(){for(var t=this._bindings,e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].unbind()}}),Object.assign(ps,{Composite:ds,create:function(t,e,i){return t&&t.isAnimationObjectGroup?new ps.Composite(t,e,i):new ps(t,e,i)},sanitizeNodeName:function(){var t=/[\[\]\.:\/]/g;return function(e){return e.replace(/\s/g,"_").replace(t,"")}}(),parseTrackName:function(){var t="[^"+"\\[\\]\\.:\\/".replace("\\.","")+"]",e=/((?:WC+[\/:])*)/.source.replace("WC","[^\\[\\]\\.:\\/]");t=/(WCOD+)?/.source.replace("WCOD",t);var i=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC","[^\\[\\]\\.:\\/]"),n=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC","[^\\[\\]\\.:\\/]"),s=new RegExp("^"+e+t+i+n+"$"),r=["material","materials","bones"];return function(t){var e=s.exec(t);if(!e)throw Error("PropertyBinding: Cannot parse trackName: "+t);var i=(e={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]}).nodeName&&e.nodeName.lastIndexOf(".");if(void 0!==i&&-1!==i){var n=e.nodeName.substring(i+1);-1!==r.indexOf(n)&&(e.nodeName=e.nodeName.substring(0,i),e.objectName=n)}if(null===e.propertyName||0===e.propertyName.length)throw Error("PropertyBinding: can not parse propertyName from trackName: "+t);return e}}(),findNode:function(t,e){if(!e||""===e||"root"===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){var i=t.skeleton.getBoneByName(e);if(void 0!==i)return i}if(t.children){var n=function(t){for(var i=0;i<t.length;i++){var s=t[i];if(s.name===e||s.uuid===e||(s=n(s.children)))return s}return null};if(t=n(t.children))return t}return null}}),Object.assign(ps.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(t,e){t[e]=this.node[this.propertyName]},function(t,e){for(var i=this.resolvedProperty,n=0,s=i.length;n!==s;++n)t[e++]=i[n]},function(t,e){t[e]=this.resolvedProperty[this.propertyIndex]},function(t,e){this.resolvedProperty.toArray(t,e)}],SetterByBindingTypeAndVersioning:[[function(t,e){this.targetObject[this.propertyName]=t[e]},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){for(var i=this.resolvedProperty,n=0,s=i.length;n!==s;++n)i[n]=t[e++]},function(t,e){for(var i=this.resolvedProperty,n=0,s=i.length;n!==s;++n)i[n]=t[e++];this.targetObject.needsUpdate=!0},function(t,e){for(var i=this.resolvedProperty,n=0,s=i.length;n!==s;++n)i[n]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty[this.propertyIndex]=t[e]},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty.fromArray(t,e)},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(t,e){this.bind(),this.getValue(t,e)},setValue:function(t,e){this.bind(),this.setValue(t,e)},bind:function(){var t=this.node,e=this.parsedPath,i=e.objectName,n=e.propertyName,s=e.propertyIndex;if(t||(this.node=t=ps.findNode(this.rootNode,e.nodeName)||this.rootNode),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,t){if(i){var r=e.objectIndex;switch(i){case"materials":if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);t=t.material.materials;break;case"bones":if(!t.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);for(t=t.skeleton.bones,i=0;i<t.length;i++)if(t[i].name===r){r=i;break}break;default:if(void 0===t[i])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);t=t[i]}if(void 0!==r){if(void 0===t[r])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);t=t[r]}}if(void 0===(r=t[n]))console.error("THREE.PropertyBinding: Trying to update property for track: "+e.nodeName+"."+n+" but it wasn't found.",t);else{if(e=this.Versioning.None,this.targetObject=t,void 0!==t.needsUpdate?e=this.Versioning.NeedsUpdate:void 0!==t.matrixWorldNeedsUpdate&&(e=this.Versioning.MatrixWorldNeedsUpdate),i=this.BindingType.Direct,void 0!==s){if("morphTargetInfluences"===n){if(!t.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(t.geometry.isBufferGeometry){if(!t.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);for(i=0;i<this.node.geometry.morphAttributes.position.length;i++)if(t.geometry.morphAttributes.position[i].name===s){s=i;break}}else{if(!t.geometry.morphTargets)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphTargets.",this);for(i=0;i<this.node.geometry.morphTargets.length;i++)if(t.geometry.morphTargets[i].name===s){s=i;break}}}i=this.BindingType.ArrayElement,this.resolvedProperty=r,this.propertyIndex=s}else void 0!==r.fromArray&&void 0!==r.toArray?(i=this.BindingType.HasFromToArray,this.resolvedProperty=r):Array.isArray(r)?(i=this.BindingType.EntireArray,this.resolvedProperty=r):this.propertyName=n;this.getValue=this.GetterByBindingType[i],this.setValue=this.SetterByBindingTypeAndVersioning[i][e]}}else console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.")},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(ps.prototype,{_getValue_unbound:ps.prototype.getValue,_setValue_unbound:ps.prototype.setValue}),Object.assign(ms.prototype,{isAnimationObjectGroup:!0,add:function(){for(var t=this._objects,e=t.length,i=this.nCachedObjects_,n=this._indicesByUUID,s=this._paths,r=this._parsedPaths,a=this._bindings,o=a.length,l=void 0,h=0,c=arguments.length;h!==c;++h){var u=arguments[h],d=u.uuid,p=n[d];if(void 0===p){p=e++,n[d]=p,t.push(u),d=0;for(var m=o;d!==m;++d)a[d].push(new ps(u,s[d],r[d]))}else if(p<i){l=t[p];var f=--i;for(n[(m=t[f]).uuid]=p,t[p]=m,n[d]=f,t[f]=u,d=0,m=o;d!==m;++d){var g=a[d],y=g[p];g[p]=g[f],void 0===y&&(y=new ps(u,s[d],r[d])),g[f]=y}}else t[p]!==l&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=i},remove:function(){for(var t=this._objects,e=this.nCachedObjects_,i=this._indicesByUUID,n=this._bindings,s=n.length,r=0,a=arguments.length;r!==a;++r){var o=arguments[r],l=o.uuid,h=i[l];if(void 0!==h&&h>=e){var c=e++,u=t[c];for(i[u.uuid]=h,t[h]=u,i[l]=c,t[c]=o,o=0,l=s;o!==l;++o){var d=(u=n[o])[h];u[h]=u[c],u[c]=d}}}this.nCachedObjects_=e},uncache:function(){for(var t=this._objects,e=t.length,i=this.nCachedObjects_,n=this._indicesByUUID,s=this._bindings,r=s.length,a=0,o=arguments.length;a!==o;++a){var l=arguments[a].uuid,h=n[l];if(void 0!==h)if(delete n[l],h<i){var c=t[l=--i],u=--e,d=t[u];for(n[c.uuid]=h,t[h]=c,n[d.uuid]=l,t[l]=d,t.pop(),c=0,d=r;c!==d;++c){var p=s[c],m=p[u];p[h]=p[l],p[l]=m,p.pop()}}else for(n[(d=t[u=--e]).uuid]=h,t[h]=d,t.pop(),c=0,d=r;c!==d;++c)(p=s[c])[h]=p[u],p.pop()}this.nCachedObjects_=i},subscribe_:function(t,e){var i=this._bindingsIndicesByPath,n=i[t],s=this._bindings;if(void 0!==n)return s[n];var r=this._paths,a=this._parsedPaths,o=this._objects,l=this.nCachedObjects_,h=Array(o.length);for(n=s.length,i[t]=n,r.push(t),a.push(e),s.push(h),i=l,n=o.length;i!==n;++i)h[i]=new ps(o[i],t,e);return h},unsubscribe_:function(t){var e=this._bindingsIndicesByPath,i=e[t];if(void 0!==i){var n=this._paths,s=this._parsedPaths,r=this._bindings,a=r.length-1,o=r[a];e[t[a]]=i,r[i]=o,r.pop(),s[i]=s[a],s.pop(),n[i]=n[a],n.pop()}}}),Object.assign(fs.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(t){return this._startTime=t,this},setLoop:function(t,e){return this.loop=t,this.repetitions=e,this},setEffectiveWeight:function(t){return this.weight=t,this._effectiveWeight=this.enabled?t:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(t){return this._scheduleFading(t,0,1)},fadeOut:function(t){return this._scheduleFading(t,1,0)},crossFadeFrom:function(t,e,i){if(t.fadeOut(e),this.fadeIn(e),i){i=this._clip.duration;var n=t._clip.duration,s=i/n;t.warp(1,n/i,e),this.warp(s,1,e)}return this},crossFadeTo:function(t,e,i){return t.crossFadeFrom(this,e,i)},stopFading:function(){var t=this._weightInterpolant;return null!==t&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this},setEffectiveTimeScale:function(t){return this.timeScale=t,this._effectiveTimeScale=this.paused?0:t,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(t){return this.timeScale=this._clip.duration/t,this.stopWarping()},syncWith:function(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()},halt:function(t){return this.warp(this._effectiveTimeScale,0,t)},warp:function(t,e,i){var n=this._mixer,s=n.time,r=this._timeScaleInterpolant,a=this.timeScale;return null===r&&(this._timeScaleInterpolant=r=n._lendControlInterpolant()),n=r.parameterPositions,r=r.sampleValues,n[0]=s,n[1]=s+i,r[0]=t/a,r[1]=e/a,this},stopWarping:function(){var t=this._timeScaleInterpolant;return null!==t&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(t,e,i,n){if(this.enabled){var s=this._startTime;if(null!==s){if(0>(e=(t-s)*i)||0===i)return;this._startTime=null,e*=i}if(e*=this._updateTimeScale(t),i=this._updateTime(e),0<(t=this._updateWeight(t))){e=this._interpolants,s=this._propertyBindings;for(var r=0,a=e.length;r!==a;++r)e[r].evaluate(i),s[r].accumulate(n,t)}}else this._updateWeight(t)},_updateWeight:function(t){var e=0;if(this.enabled){e=this.weight;var i=this._weightInterpolant;if(null!==i){var n=i.evaluate(t)[0];e*=n,t>i.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=e},_updateTimeScale:function(t){var e=0;if(!this.paused){e=this.timeScale;var i=this._timeScaleInterpolant;if(null!==i)e*=i.evaluate(t)[0],t>i.parameterPositions[1]&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e)}return this._effectiveTimeScale=e},_updateTime:function(t){var e=this.time+t,i=this._clip.duration,n=this.loop,s=this._loopCount,r=2202===n;if(0===t)return-1===s?e:r&&1==(1&s)?i-e:e;if(2200===n)t:{if(-1===s&&(this._loopCount=0,this._setEndings(!0,!0,!1)),e>=i)e=i;else{if(!(0>e)){this.time=e;break t}e=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=e,this._mixer.dispatchEvent({type:"finished",action:this,direction:0>t?-1:1})}else{if(-1===s&&(0<=t?(s=0,this._setEndings(!0,0===this.repetitions,r)):this._setEndings(0===this.repetitions,!0,r)),e>=i||0>e){e-=i*(n=Math.floor(e/i)),s+=Math.abs(n);var a=this.repetitions-s;0>=a?(this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=e=0<t?i:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:0<t?1:-1})):(1===a?(t=0>t,this._setEndings(t,!t,r)):this._setEndings(!1,!1,r),this._loopCount=s,this.time=e,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:n}))}else this.time=e;if(r&&1==(1&s))return i-e}return e},_setEndings:function(t,e,i){var n=this._interpolantSettings;i?(n.endingStart=2401,n.endingEnd=2401):(n.endingStart=t?this.zeroSlopeAtStart?2401:2400:2402,n.endingEnd=e?this.zeroSlopeAtEnd?2401:2400:2402)},_scheduleFading:function(t,e,i){var n=this._mixer,s=n.time,r=this._weightInterpolant;return null===r&&(this._weightInterpolant=r=n._lendControlInterpolant()),n=r.parameterPositions,r=r.sampleValues,n[0]=s,r[0]=e,n[1]=s+t,r[1]=i,this}}),gs.prototype=Object.assign(Object.create(e.prototype),{constructor:gs,_bindAction:function(t,e){var i=t._localRoot||this._root,n=t._clip.tracks,s=n.length,r=t._propertyBindings;t=t._interpolants;var a=i.uuid,o=this._bindingsByRootAndName,l=o[a];for(void 0===l&&(l={},o[a]=l),o=0;o!==s;++o){var h=n[o],c=h.name,u=l[c];if(void 0===u){if(void 0!==(u=r[o])){null===u._cacheIndex&&(++u.referenceCount,this._addInactiveBinding(u,a,c));continue}++(u=new us(ps.create(i,c,e&&e._propertyBindings[o].binding.parsedPath),h.ValueTypeName,h.getValueSize())).referenceCount,this._addInactiveBinding(u,a,c)}r[o]=u,t[o].resultBuffer=u.buffer}},_activateAction:function(t){if(!this._isActiveAction(t)){if(null===t._cacheIndex){var e=(t._localRoot||this._root).uuid,i=t._clip.uuid,n=this._actionsByClip[i];this._bindAction(t,n&&n.knownActions[0]),this._addInactiveAction(t,i,e)}for(i=0,n=(e=t._propertyBindings).length;i!==n;++i){var s=e[i];0==s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(t)}},_deactivateAction:function(t){if(this._isActiveAction(t)){for(var e=t._propertyBindings,i=0,n=e.length;i!==n;++i){var s=e[i];0==--s.useCount&&(s.restoreOriginalState(),this._takeBackBinding(s))}this._takeBackAction(t)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var t=this;this.stats={actions:{get total(){return t._actions.length},get inUse(){return t._nActiveActions}},bindings:{get total(){return t._bindings.length},get inUse(){return t._nActiveBindings}},controlInterpolants:{get total(){return t._controlInterpolants.length},get inUse(){return t._nActiveControlInterpolants}}}},_isActiveAction:function(t){return null!==(t=t._cacheIndex)&&t<this._nActiveActions},_addInactiveAction:function(t,e,i){var n=this._actions,s=this._actionsByClip,r=s[e];void 0===r?(r={knownActions:[t],actionByRoot:{}},t._byClipCacheIndex=0,s[e]=r):(e=r.knownActions,t._byClipCacheIndex=e.length,e.push(t)),t._cacheIndex=n.length,n.push(t),r.actionByRoot[i]=t},_removeInactiveAction:function(t){var e=this._actions,i=e[e.length-1],n=t._cacheIndex;i._cacheIndex=n,e[n]=i,e.pop(),t._cacheIndex=null,e=t._clip.uuid;var s=(n=(i=this._actionsByClip)[e]).knownActions,r=s[s.length-1],a=t._byClipCacheIndex;r._byClipCacheIndex=a,s[a]=r,s.pop(),t._byClipCacheIndex=null,delete n.actionByRoot[(t._localRoot||this._root).uuid],0===s.length&&delete i[e],this._removeInactiveBindingsForAction(t)},_removeInactiveBindingsForAction:function(t){for(var e=0,i=(t=t._propertyBindings).length;e!==i;++e){var n=t[e];0==--n.referenceCount&&this._removeInactiveBinding(n)}},_lendAction:function(t){var e=this._actions,i=t._cacheIndex,n=this._nActiveActions++,s=e[n];t._cacheIndex=n,e[n]=t,s._cacheIndex=i,e[i]=s},_takeBackAction:function(t){var e=this._actions,i=t._cacheIndex,n=--this._nActiveActions,s=e[n];t._cacheIndex=n,e[n]=t,s._cacheIndex=i,e[i]=s},_addInactiveBinding:function(t,e,i){var n=this._bindingsByRootAndName,s=n[e],r=this._bindings;void 0===s&&(s={},n[e]=s),s[i]=t,t._cacheIndex=r.length,r.push(t)},_removeInactiveBinding:function(t){var e=this._bindings,i=t.binding,n=i.rootNode.uuid;i=i.path;var s=this._bindingsByRootAndName,r=s[n],a=e[e.length-1];t=t._cacheIndex,a._cacheIndex=t,e[t]=a,e.pop(),delete r[i];t:{for(var o in r)break t;delete s[n]}},_lendBinding:function(t){var e=this._bindings,i=t._cacheIndex,n=this._nActiveBindings++,s=e[n];t._cacheIndex=n,e[n]=t,s._cacheIndex=i,e[i]=s},_takeBackBinding:function(t){var e=this._bindings,i=t._cacheIndex,n=--this._nActiveBindings,s=e[n];t._cacheIndex=n,e[n]=t,s._cacheIndex=i,e[i]=s},_lendControlInterpolant:function(){var t=this._controlInterpolants,e=this._nActiveControlInterpolants++,i=t[e];return void 0===i&&((i=new Yi(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=e,t[e]=i),i},_takeBackControlInterpolant:function(t){var e=this._controlInterpolants,i=t.__cacheIndex,n=--this._nActiveControlInterpolants,s=e[n];t.__cacheIndex=n,e[n]=t,s.__cacheIndex=i,e[i]=s},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(t,e){var i=e||this._root,n=i.uuid;t=null!==(i="string"==typeof t?sn.findByName(i,t):t)?i.uuid:t;var s=this._actionsByClip[t],r=null;if(void 0!==s){if(void 0!==(r=s.actionByRoot[n]))return r;r=s.knownActions[0],null===i&&(i=r._clip)}return null===i?null:(e=new fs(this,i,e),this._bindAction(e,r),this._addInactiveAction(e,t,n),e)},existingAction:function(t,e){var i=e||this._root;return e=i.uuid,i="string"==typeof t?sn.findByName(i,t):t,void 0!==(t=this._actionsByClip[i?i.uuid:t])&&t.actionByRoot[e]||null},stopAllAction:function(){for(var t=this._actions,e=this._nActiveActions,i=this._bindings,n=this._nActiveBindings,s=this._nActiveBindings=this._nActiveActions=0;s!==e;++s)t[s].reset();for(s=0;s!==n;++s)i[s].useCount=0;return this},update:function(t){t*=this.timeScale;for(var e=this._actions,i=this._nActiveActions,n=this.time+=t,s=Math.sign(t),r=this._accuIndex^=1,a=0;a!==i;++a)e[a]._update(n,t,s,r);for(t=this._bindings,e=this._nActiveBindings,a=0;a!==e;++a)t[a].apply(r);return this},getRoot:function(){return this._root},uncacheClip:function(t){var e=this._actions;t=t.uuid;var i=this._actionsByClip,n=i[t];if(void 0!==n){for(var s=0,r=(n=n.knownActions).length;s!==r;++s){var a=n[s];this._deactivateAction(a);var o=a._cacheIndex,l=e[e.length-1];a._cacheIndex=null,a._byClipCacheIndex=null,l._cacheIndex=o,e[o]=l,e.pop(),this._removeInactiveBindingsForAction(a)}delete i[t]}},uncacheRoot:function(t){t=t.uuid;var e=this._actionsByClip;for(n in e){var i=e[n].actionByRoot[t];void 0!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}var n=this._bindingsByRootAndName[t];if(void 0!==n)for(var s in n)(t=n[s]).restoreOriginalState(),this._removeInactiveBinding(t)},uncacheAction:function(t,e){null!==(t=this.existingAction(t,e))&&(this._deactivateAction(t),this._removeInactiveAction(t))}}),ys.prototype.clone=function(){return new ys(void 0===this.value.clone?this.value:this.value.clone())},vs.prototype=Object.assign(Object.create(me.prototype),{constructor:vs,isInstancedInterleavedBuffer:!0,copy:function(t){return me.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this}}),Object.assign(bs.prototype,{linePrecision:1,set:function(t,e){this.ray.set(t,e)},setFromCamera:function(t,e){e&&e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize()):e&&e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(t,e,i){return xs(t,this,i=i||[],e),i.sort(ws),i},intersectObjects:function(t,e,i){if(i=i||[],!1===Array.isArray(t))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),i;for(var n=0,s=t.length;n<s;n++)xs(t[n],this,i,e);return i.sort(ws),i}}),Object.assign(Ss.prototype,{set:function(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(t){return this.setFromCartesianCoords(t.x,t.y,t.z)},setFromCartesianCoords:function(t,e,i){return this.radius=Math.sqrt(t*t+e*e+i*i),0===this.radius?this.phi=this.theta=0:(this.theta=Math.atan2(t,i),this.phi=Math.acos(Js.clamp(e/this.radius,-1,1))),this}}),Object.assign(Es.prototype,{set:function(t,e,i){return this.radius=t,this.theta=e,this.y=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.radius=t.radius,this.theta=t.theta,this.y=t.y,this},setFromVector3:function(t){return this.setFromCartesianCoords(t.x,t.y,t.z)},setFromCartesianCoords:function(t,e,i){return this.radius=Math.sqrt(t*t+i*i),this.theta=Math.atan2(t,i),this.y=e,this}}),Object.assign(Ms.prototype,{set:function(t,e){return this.min.copy(t),this.max.copy(e),this},setFromPoints:function(t){this.makeEmpty();for(var e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this},setFromCenterAndSize:function(){var t=new i;return function(e,i){return i=t.copy(i).multiplyScalar(.5),this.min.copy(e).sub(i),this.max.copy(e).add(i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.min.copy(t.min),this.max.copy(t.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(t){return void 0===t&&(console.warn("THREE.Box2: .getCenter() target is now required"),t=new i),this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(t){return void 0===t&&(console.warn("THREE.Box2: .getSize() target is now required"),t=new i),this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(t){return this.min.min(t),this.max.max(t),this},expandByVector:function(t){return this.min.sub(t),this.max.add(t),this},expandByScalar:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this},containsPoint:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)},containsBox:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y},getParameter:function(t,e){return void 0===e&&(console.warn("THREE.Box2: .getParameter() target is now required"),e=new i),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)},clampPoint:function(t,e){return void 0===e&&(console.warn("THREE.Box2: .clampPoint() target is now required"),e=new i),e.copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new i;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),intersect:function(t){return this.min.max(t.min),this.max.min(t.max),this},union:function(t){return this.min.min(t.min),this.max.max(t.max),this},translate:function(t){return this.min.add(t),this.max.add(t),this},equals:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}),Object.assign(Ts.prototype,{set:function(t,e){return this.start.copy(t),this.end.copy(e),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.start.copy(t.start),this.end.copy(t.end),this},getCenter:function(t){return void 0===t&&(console.warn("THREE.Line3: .getCenter() target is now required"),t=new s),t.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(t){return void 0===t&&(console.warn("THREE.Line3: .delta() target is now required"),t=new s),t.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,e){return void 0===e&&(console.warn("THREE.Line3: .at() target is now required"),e=new s),this.delta(e).multiplyScalar(t).add(this.start)},closestPointToPointParameter:function(){var t=new s,e=new s;return function(i,n){return t.subVectors(i,this.start),e.subVectors(this.end,this.start),i=e.dot(e),i=e.dot(t)/i,n&&(i=Js.clamp(i,0,1)),i}}(),closestPointToPoint:function(t,e,i){return t=this.closestPointToPointParameter(t,e),void 0===i&&(console.warn("THREE.Line3: .closestPointToPoint() target is now required"),i=new s),this.delta(i).multiplyScalar(t).add(this.start)},applyMatrix4:function(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this},equals:function(t){return t.start.equals(this.start)&&t.end.equals(this.end)}}),Cs.prototype=Object.create(T.prototype),Cs.prototype.constructor=Cs,Cs.prototype.isImmediateRenderObject=!0,Ps.prototype=Object.create(Me.prototype),Ps.prototype.constructor=Ps,Ps.prototype.update=function(){var t=new s,e=new s,i=new r;return function(){var n=["a","b","c"];this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);var s=this.object.matrixWorld,r=this.geometry.attributes.position,a=this.object.geometry;if(a&&a.isGeometry)for(var o=a.vertices,l=a.faces,h=a=0,c=l.length;h<c;h++)for(var u=l[h],d=0,p=u.vertexNormals.length;d<p;d++){var m=u.vertexNormals[d];t.copy(o[u[n[d]]]).applyMatrix4(s),e.copy(m).applyMatrix3(i).normalize().multiplyScalar(this.size).add(t),r.setXYZ(a,t.x,t.y,t.z),a+=1,r.setXYZ(a,e.x,e.y,e.z),a+=1}else if(a&&a.isBufferGeometry)for(n=a.attributes.position,o=a.attributes.normal,d=a=0,p=n.count;d<p;d++)t.set(n.getX(d),n.getY(d),n.getZ(d)).applyMatrix4(s),e.set(o.getX(d),o.getY(d),o.getZ(d)),e.applyMatrix3(i).normalize().multiplyScalar(this.size).add(t),r.setXYZ(a,t.x,t.y,t.z),a+=1,r.setXYZ(a,e.x,e.y,e.z),a+=1;r.needsUpdate=!0}}(),_s.prototype=Object.create(T.prototype),_s.prototype.constructor=_s,_s.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},_s.prototype.update=function(){var t=new s;return function(){this.light.updateMatrixWorld();var e=this.light.distance?this.light.distance:1e3,i=e*Math.tan(this.light.angle);this.cone.scale.set(i,i,e),t.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(t),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}(),As.prototype=Object.create(Me.prototype),As.prototype.constructor=As,As.prototype.updateMatrixWorld=function(){var t=new s,e=new g,i=new g;return function(n){var s=this.bones,r=this.geometry,a=r.getAttribute("position");i.getInverse(this.root.matrixWorld);for(var o=0,l=0;o<s.length;o++){var h=s[o];h.parent&&h.parent.isBone&&(e.multiplyMatrices(i,h.matrixWorld),t.setFromMatrixPosition(e),a.setXYZ(l,t.x,t.y,t.z),e.multiplyMatrices(i,h.parent.matrixWorld),t.setFromMatrixPosition(e),a.setXYZ(l+1,t.x,t.y,t.z),l+=2)}r.getAttribute("position").needsUpdate=!0,T.prototype.updateMatrixWorld.call(this,n)}}(),Ls.prototype=Object.create(J.prototype),Ls.prototype.constructor=Ls,Ls.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},Ls.prototype.update=function(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)},Rs.prototype=Object.create(Ee.prototype),Rs.prototype.constructor=Rs,Rs.prototype.update=function(){if(this.scale.set(.5*this.light.width,.5*this.light.height,1),void 0!==this.color)this.material.color.set(this.color),this.children[0].material.color.set(this.color);else{this.material.color.copy(this.light.color).multiplyScalar(this.light.intensity);var t=this.material.color,e=Math.max(t.r,t.g,t.b);1<e&&t.multiplyScalar(1/e),this.children[0].material.color.copy(this.material.color)}},Rs.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose(),this.children[0].geometry.dispose(),this.children[0].material.dispose()},Is.prototype=Object.create(T.prototype),Is.prototype.constructor=Is,Is.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},Is.prototype.update=function(){var t=new s,e=new b,i=new b;return function(){var n=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{var s=n.geometry.getAttribute("color");e.copy(this.light.color),i.copy(this.light.groundColor);for(var r=0,a=s.count;r<a;r++){var o=r<a/2?e:i;s.setXYZ(r,o.r,o.g,o.b)}s.needsUpdate=!0}n.lookAt(t.setFromMatrixPosition(this.light.matrixWorld).negate())}}(),Os.prototype=Object.create(J.prototype),Os.prototype.constructor=Os,Os.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},Os.prototype.onBeforeRender=function(){this.position.copy(this.lightProbe.position),this.scale.set(1,1,1).multiplyScalar(this.size),this.material.uniforms.intensity.value=this.lightProbe.intensity},Ds.prototype=Object.assign(Object.create(Me.prototype),{constructor:Ds,copy:function(t){return Me.prototype.copy.call(this,t),this.geometry.copy(t.geometry),this.material.copy(t.material),this},clone:function(){return(new this.constructor).copy(this)}}),ks.prototype=Object.create(Me.prototype),ks.prototype.constructor=ks,Bs.prototype=Object.create(Ee.prototype),Bs.prototype.constructor=Bs,Bs.prototype.update=function(){function t(t,n,r,a){for(r=(n-t)/r,p.setXYZ(c,0,0,0),u++,e=t;e<n;e+=r)i=c+u,p.setXYZ(i,Math.sin(e)*s,0,Math.cos(e)*s),p.setXYZ(i+1,Math.sin(Math.min(e+r,n))*s,0,Math.cos(Math.min(e+r,n))*s),p.setXYZ(i+2,0,0,0),u+=3;d.addGroup(c,u,a),c+=u,u=0}var e,i,n=this.audio,s=this.range,r=this.divisionsInnerAngle,a=this.divisionsOuterAngle,o=Js.degToRad(n.panner.coneInnerAngle),l=o/2,h=(n=Js.degToRad(n.panner.coneOuterAngle))/2,c=0,u=0,d=this.geometry,p=d.attributes.position;d.clearGroups(),t(-h,-l,a,0),t(-l,l,r,1),t(l,h,a,0),p.needsUpdate=!0,o===n&&(this.material[0].visible=!1)},Bs.prototype.dispose=function(){this.geometry.dispose(),this.material[0].dispose(),this.material[1].dispose()},Hs.prototype=Object.create(Me.prototype),Hs.prototype.constructor=Hs,Hs.prototype.update=function(){var t=new s,e=new s,i=new r;return function(){this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);for(var n=this.object.matrixWorld,s=this.geometry.attributes.position,r=this.object.geometry,a=r.vertices,o=0,l=0,h=(r=r.faces).length;l<h;l++){var c=r[l],u=c.normal;t.copy(a[c.a]).add(a[c.b]).add(a[c.c]).divideScalar(3).applyMatrix4(n),e.copy(u).applyMatrix3(i).normalize().multiplyScalar(this.size).add(t),s.setXYZ(o,t.x,t.y,t.z),o+=1,s.setXYZ(o,e.x,e.y,e.z),o+=1}s.needsUpdate=!0}}(),Ns.prototype=Object.create(T.prototype),Ns.prototype.constructor=Ns,Ns.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},Ns.prototype.update=function(){var t=new s,e=new s,i=new s;return function(){t.setFromMatrixPosition(this.light.matrixWorld),e.setFromMatrixPosition(this.light.target.matrixWorld),i.subVectors(e,t),this.lightPlane.lookAt(e),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(e),this.targetLine.scale.z=i.length()}}(),Fs.prototype=Object.create(Me.prototype),Fs.prototype.constructor=Fs,Fs.prototype.update=function(){function t(t,s,a,o){if(n.set(s,a,o).unproject(r),void 0!==(t=i[t]))for(s=e.getAttribute("position"),a=0,o=t.length;a<o;a++)s.setXYZ(t[a],n.x,n.y,n.z)}var e,i,n=new s,r=new se;return function(){e=this.geometry,i=this.pointMap,r.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),t("c",0,0,-1),t("t",0,0,1),t("n1",-1,-1,-1),t("n2",1,-1,-1),t("n3",-1,1,-1),t("n4",1,1,-1),t("f1",-1,-1,1),t("f2",1,-1,1),t("f3",-1,1,1),t("f4",1,1,1),t("u1",.7,1.1,-1),t("u2",-.7,1.1,-1),t("u3",0,2,-1),t("cf1",-1,0,1),t("cf2",1,0,1),t("cf3",0,-1,1),t("cf4",0,1,1),t("cn1",-1,0,-1),t("cn2",1,0,-1),t("cn3",0,-1,-1),t("cn4",0,1,-1),e.getAttribute("position").needsUpdate=!0}}(),Vs.prototype=Object.create(Me.prototype),Vs.prototype.constructor=Vs,Vs.prototype.update=function(){var t=new d;return function(e){if(void 0!==e&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&t.setFromObject(this.object),!t.isEmpty()){e=t.min;var i=t.max,n=this.geometry.attributes.position,s=n.array;s[0]=i.x,s[1]=i.y,s[2]=i.z,s[3]=e.x,s[4]=i.y,s[5]=i.z,s[6]=e.x,s[7]=e.y,s[8]=i.z,s[9]=i.x,s[10]=e.y,s[11]=i.z,s[12]=i.x,s[13]=i.y,s[14]=e.z,s[15]=e.x,s[16]=i.y,s[17]=e.z,s[18]=e.x,s[19]=e.y,s[20]=e.z,s[21]=i.x,s[22]=e.y,s[23]=e.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}(),Vs.prototype.setFromObject=function(t){return this.object=t,this.update(),this},Vs.prototype.copy=function(t){return Me.prototype.copy.call(this,t),this.object=t.object,this},Vs.prototype.clone=function(){return(new this.constructor).copy(this)},js.prototype=Object.create(Me.prototype),js.prototype.constructor=js,js.prototype.updateMatrixWorld=function(t){var e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),T.prototype.updateMatrixWorld.call(this,t))},Gs.prototype=Object.create(Ee.prototype),Gs.prototype.constructor=Gs,Gs.prototype.updateMatrixWorld=function(t){var e=-this.plane.constant;1e-8>Math.abs(e)&&(e=1e-8),this.scale.set(.5*this.size,.5*this.size,e),this.children[0].material.side=0>e?1:0,this.lookAt(this.plane.normal),T.prototype.updateMatrixWorld.call(this,t)},Us.prototype=Object.create(T.prototype),Us.prototype.constructor=Us,Us.prototype.setDirection=function(){var t,e=new s;return function(i){.99999<i.y?this.quaternion.set(0,0,0,1):-.99999>i.y?this.quaternion.set(1,0,0,0):(e.set(i.z,0,-i.x).normalize(),t=Math.acos(i.y),this.quaternion.setFromAxisAngle(e,t))}}(),Us.prototype.setLength=function(t,e,i){void 0===e&&(e=.2*t),void 0===i&&(i=.2*e),this.line.scale.set(1,Math.max(0,t-e),1),this.line.updateMatrix(),this.cone.scale.set(i,e,i),this.cone.position.y=t,this.cone.updateMatrix()},Us.prototype.setColor=function(t){this.line.material.color.copy(t),this.cone.material.color.copy(t)},Us.prototype.copy=function(t){return T.prototype.copy.call(this,t,!1),this.line.copy(t.line),this.cone.copy(t.cone),this},Us.prototype.clone=function(){return(new this.constructor).copy(this)},zs.prototype=Object.create(Me.prototype),zs.prototype.constructor=zs,mn.create=function(t,e){return console.log("THREE.Curve.create() has been deprecated"),t.prototype=Object.create(mn.prototype),t.prototype.constructor=t,t.prototype.getPoint=e,t},Object.assign(An.prototype,{createPointsGeometry:function(t){return console.warn("THREE.CurvePath: .createPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead."),t=this.getPoints(t),this.createGeometry(t)},createSpacedPointsGeometry:function(t){return console.warn("THREE.CurvePath: .createSpacedPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead."),t=this.getSpacedPoints(t),this.createGeometry(t)},createGeometry:function(t){console.warn("THREE.CurvePath: .createGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");for(var e=new C,i=0,n=t.length;i<n;i++){var r=t[i];e.vertices.push(new s(r.x,r.y,r.z||0))}return e}}),Object.assign(Ln.prototype,{fromPoints:function(t){console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(t)}}),Ws.prototype=Object.create(vn.prototype),qs.prototype=Object.create(vn.prototype),Ys.prototype=Object.create(vn.prototype),Object.assign(Ys.prototype,{initFromArray:function(){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),Ds.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},As.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")},Object.assign(Qn.prototype,{extractUrlBase:function(t){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),Hr.extractUrlBase(t)}}),Object.assign(Yn.prototype,{setTexturePath:function(t){return console.warn("THREE.ObjectLoader: .setTexturePath() has been renamed to .setResourcePath()."),this.setResourcePath(t)}}),Object.assign(Ms.prototype,{center:function(t){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(t)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(t){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},size:function(t){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(t)}}),Object.assign(d.prototype,{center:function(t){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(t)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(t){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},isIntersectionSphere:function(t){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(t)},size:function(t){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(t)}}),Ts.prototype.center=function(t){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(t)},Object.assign(Js,{random16:function(){return console.warn("THREE.Math: .random16() has been deprecated. Use Math.random() instead."),Math.random()},nearestPowerOfTwo:function(t){return console.warn("THREE.Math: .nearestPowerOfTwo() has been renamed to .floorPowerOfTwo()."),Js.floorPowerOfTwo(t)},nextPowerOfTwo:function(t){return console.warn("THREE.Math: .nextPowerOfTwo() has been renamed to .ceilPowerOfTwo()."),Js.ceilPowerOfTwo(t)}}),Object.assign(r.prototype,{flattenToArrayOffset:function(t,e){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(t,e)},multiplyVector3:function(t){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),t.applyMatrix3(this)},multiplyVector3Array:function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},applyToBuffer:function(t){return console.warn("THREE.Matrix3: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(t)},applyToVector3Array:function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")}}),Object.assign(g.prototype,{extractPosition:function(t){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(t)},flattenToArrayOffset:function(t,e){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(t,e)},getPosition:function(){var t;return function(){return void 0===t&&(t=new s),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),t.setFromMatrixColumn(this,3)}}(),setRotationFromQuaternion:function(t){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(t)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(t){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector4:function(t){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector3Array:function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},rotateAxis:function(t){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),t.transformDirection(this)},crossVector:function(t){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBuffer:function(t){return console.warn("THREE.Matrix4: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(t)},applyToVector3Array:function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(t,e,i,n,s,r){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(t,e,n,i,s,r)}}),m.prototype.isIntersectionLine=function(t){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(t)},n.prototype.multiplyVector3=function(t){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),t.applyQuaternion(this)},Object.assign(q.prototype,{isIntersectionBox:function(t){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},isIntersectionPlane:function(t){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(t)},isIntersectionSphere:function(t){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(t)}}),Object.assign(Y.prototype,{area:function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()},barycoordFromPoint:function(t,e){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(t,e)},midpoint:function(t){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(t)},normal:function(t){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(t)},plane:function(t){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(t)}}),Object.assign(Y,{barycoordFromPoint:function(t,e,i,n,s){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),Y.getBarycoord(t,e,i,n,s)},normal:function(t,e,i,n){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),Y.getNormal(t,e,i,n)}}),Object.assign(Rn.prototype,{extractAllPoints:function(t){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(t)},extrude:function(t){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new mi(this,t)},makeGeometry:function(t){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new Ti(this,t)}}),Object.assign(i.prototype,{fromAttribute:function(t,e,i){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},distanceToManhattan:function(t){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(t)},lengthManhattan:function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(s.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(t){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(t)},getScaleFromMatrix:function(t){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(t)},getColumnFromMatrix:function(t,e){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,t)},applyProjection:function(t){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(t)},fromAttribute:function(t,e,i){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},distanceToManhattan:function(t){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(t)},lengthManhattan:function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(o.prototype,{fromAttribute:function(t,e,i){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,i)},lengthManhattan:function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}}),Object.assign(C.prototype,{computeTangents:function(){console.error("THREE.Geometry: .computeTangents() has been removed.")},computeLineDistances:function(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")}}),Object.assign(T.prototype,{getChildByName:function(t){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(t)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(t,e){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(e,t)},getWorldRotation:function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")}}),Object.defineProperties(T.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(t){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=t}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.defineProperties(ve.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(we.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),be.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")},Object.defineProperty(mn.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(t){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=t}}),re.prototype.setLens=function(t,e){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==e&&(this.filmGauge=e),this.setFocalLength(t)},Object.defineProperties(In.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(t){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=t}},shadowCameraLeft:{set:function(t){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=t}},shadowCameraRight:{set:function(t){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=t}},shadowCameraTop:{set:function(t){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=t}},shadowCameraBottom:{set:function(t){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=t}},shadowCameraNear:{set:function(t){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=t}},shadowCameraFar:{set:function(t){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=t}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(t){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=t}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(t){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=t}},shadowMapHeight:{set:function(t){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=t}}}),Object.defineProperties(P.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},copyIndicesArray:function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")}}),Object.assign(F.prototype,{addIndex:function(t){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(t)},addDrawCall:function(t,e,i){void 0!==i&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(t,e)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")}}),Object.defineProperties(F.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.assign(fi.prototype,{getArrays:function(){console.error("THREE.ExtrudeBufferGeometry: .getArrays() has been removed.")},addShapeList:function(){console.error("THREE.ExtrudeBufferGeometry: .addShapeList() has been removed.")},addShape:function(){console.error("THREE.ExtrudeBufferGeometry: .addShape() has been removed.")}}),Object.defineProperties(ys.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(z.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new b}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(t){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=1===t}}}),Object.defineProperties(Fi.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(W.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(t){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=t}}}),Object.assign(ce.prototype,{clearTarget:function(t,e,i,n){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(t),this.clear(e,i,n)},animate:function(t){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(t)},getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},getMaxAnisotropy:function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},getPrecision:function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},resetGLState:function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(t){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(t)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")},setFaceCulling:function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")},allocTextureUnit:function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")},setTexture:function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")},setTexture2D:function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")},setTextureCube:function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")}}),Object.defineProperties(ce.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(t){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=t}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(t){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=t}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}}}),Object.defineProperties(ee.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}}),Object.defineProperties(c.prototype,{activeCubeFace:{set:function(){console.warn("THREE.WebGLRenderTargetCube: .activeCubeFace has been removed. It is now the second parameter of WebGLRenderer.setRenderTarget().")}},activeMipMapLevel:{set:function(){console.warn("THREE.WebGLRenderTargetCube: .activeMipMapLevel has been removed. It is now the third parameter of WebGLRenderer.setRenderTarget().")}}}),Object.defineProperties(l.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(t){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=t}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(t){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=t}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(t){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=t}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(t){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=t}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(t){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=t}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(t){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=t}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(t){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=t}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(t){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=t}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(t){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=t}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(t){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=t}}}),Object.defineProperties(le.prototype,{standing:{set:function(){console.warn("THREE.WebVRManager: .standing has been removed.")}},userHeight:{set:function(){console.warn("THREE.WebVRManager: .userHeight has been removed.")}}}),ls.prototype.load=function(t){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");var e=this;return(new $n).load(t,function(t){e.setBuffer(t)}),this},cs.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()},rs.prototype.updateCubeMap=function(t,e){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(t,e)},Zs.crossOrigin=void 0,Zs.loadTexture=function(t,e,i,n){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");var s=new pn;return s.setCrossOrigin(this.crossOrigin),t=s.load(t,i,void 0,n),e&&(t.mapping=e),t},Zs.loadTextureCube=function(t,e,i,n){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");var s=new dn;return s.setCrossOrigin(this.crossOrigin),t=s.load(t,i,void 0,n),e&&(t.mapping=e),t},Zs.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},Zs.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")},t.ACESFilmicToneMapping=5,t.AddEquation=100,t.AddOperation=2,t.AdditiveBlending=2,t.AlphaFormat=1021,t.AlwaysDepth=1,t.AmbientLight=jn,t.AmbientLightProbe=ns,t.AnimationClip=sn,t.AnimationLoader=ln,t.AnimationMixer=gs,t.AnimationObjectGroup=ms,t.AnimationUtils=_r,t.ArcCurve=gn,t.ArrayCamera=ae,t.ArrowHelper=Us,t.Audio=ls,t.AudioAnalyser=cs,t.AudioContext=Wr,t.AudioListener=os,t.AudioLoader=$n,t.AxesHelper=zs,t.AxisHelper=function(t){return console.warn("THREE.AxisHelper has been renamed to THREE.AxesHelper."),new zs(t)},t.BackSide=1,t.BasicDepthPacking=3200,t.BasicShadowMap=0,t.BinaryTextureLoader=function(t){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new cn(t)},t.Bone=xe,t.BooleanKeyframeTrack=Ki,t.BoundingBoxHelper=function(t,e){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new Vs(t,e)},t.Box2=Ms,t.Box3=d,t.Box3Helper=js,t.BoxBufferGeometry=j,t.BoxGeometry=V,t.BoxHelper=Vs,t.BufferAttribute=P,t.BufferGeometry=F,t.BufferGeometryLoader=qn,t.ByteType=1010,t.Cache=Ar,t.Camera=se,t.CameraHelper=Fs,t.CanvasRenderer=function(){console.error("THREE.CanvasRenderer has been removed")},t.CanvasTexture=Le,t.CatmullRomCurve3=vn,t.CineonToneMapping=4,t.CircleBufferGeometry=Di,t.CircleGeometry=Oi,t.ClampToEdgeWrapping=1001,t.Clock=as,t.ClosedSplineCurve3=Ws,t.Color=b,t.ColorKeyframeTrack=Zi,t.CompressedTexture=Ae,t.CompressedTextureLoader=hn,t.ConeBufferGeometry=Ii,t.ConeGeometry=Ri,t.CubeCamera=rs,t.CubeGeometry=V,t.CubeReflectionMapping=301,t.CubeRefractionMapping=302,t.CubeTexture=tt,t.CubeTextureLoader=dn,t.CubeUVReflectionMapping=306,t.CubeUVRefractionMapping=307,t.CubicBezierCurve=Sn,t.CubicBezierCurve3=En,t.CubicInterpolant=qi,t.CullFaceBack=1,t.CullFaceFront=2,t.CullFaceFrontBack=3,t.CullFaceNone=0,t.Curve=mn,t.CurvePath=An,t.CustomBlending=5,t.CylinderBufferGeometry=Li,t.CylinderGeometry=Ai,t.Cylindrical=Es,t.DataTexture=u,t.DataTexture2DArray=et,t.DataTexture3D=it,t.DataTextureLoader=cn,t.DefaultLoadingManager=Lr,t.DepthFormat=1026,t.DepthStencilFormat=1027,t.DepthTexture=Re,t.DirectionalLight=Vn,t.DirectionalLightHelper=Ns,t.DirectionalLightShadow=Fn,t.DiscreteInterpolant=Xi,t.DodecahedronBufferGeometry=ze,t.DodecahedronGeometry=Ue,t.DoubleSide=2,t.DstAlphaFactor=206,t.DstColorFactor=208,t.DynamicBufferAttribute=function(t,e){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setDynamic( true ) instead."),new P(t,e).setDynamic(!0)},t.EdgesGeometry=_i,t.EdgesHelper=function(t,e){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new Me(new _i(t.geometry),new Se({color:void 0!==e?e:16777215}))},t.EllipseCurve=fn,t.EqualDepth=4,t.EquirectangularReflectionMapping=303,t.EquirectangularRefractionMapping=304,t.Euler=E,t.EventDispatcher=e,t.ExtrudeBufferGeometry=fi,t.ExtrudeGeometry=mi,t.Face3=S,t.Face4=function(t,e,i,n,s,r,a){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new S(t,e,i,s,r,a)},t.FaceColors=1,t.FaceNormalsHelper=Hs,t.FileLoader=on,t.FlatShading=1,t.Float32Attribute=function(t,e){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new k(t,e)},t.Float32BufferAttribute=k,t.Float64Attribute=function(t,e){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new B(t,e)},t.Float64BufferAttribute=B,t.FloatType=1015,t.Fog=de,t.FogExp2=ue,t.Font=Kn,t.FontLoader=Zn,t.FrontFaceDirectionCCW=1,t.FrontFaceDirectionCW=0,t.FrontSide=0,t.Frustum=f,t.GammaEncoding=3007,t.Geometry=C,t.GeometryUtils={merge:function(t,e,i){if(console.warn("THREE.GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead."),e.isMesh){e.matrixAutoUpdate&&e.updateMatrix();var n=e.matrix;e=e.geometry}t.merge(e,n,i)},center:function(t){return console.warn("THREE.GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),t.center()}},t.GreaterDepth=6,t.GreaterEqualDepth=5,t.GridHelper=Ds,t.Group=ne,t.HalfFloatType=1016,t.HemisphereLight=On,t.HemisphereLightHelper=Is,t.HemisphereLightProbe=is,t.IcosahedronBufferGeometry=Ge,t.IcosahedronGeometry=je,t.ImageBitmapLoader=Xn,t.ImageLoader=un,t.ImageUtils=Zs,t.ImmediateRenderObject=Cs,t.InstancedBufferAttribute=Wn,t.InstancedBufferGeometry=zn,t.InstancedInterleavedBuffer=vs,t.Int16Attribute=function(t,e){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new R(t,e)},t.Int16BufferAttribute=R,t.Int32Attribute=function(t,e){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new O(t,e)},t.Int32BufferAttribute=O,t.Int8Attribute=function(t,e){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new _(t,e)},t.Int8BufferAttribute=_,t.IntType=1013,t.InterleavedBuffer=me,t.InterleavedBufferAttribute=fe,t.Interpolant=Wi,t.InterpolateDiscrete=2300,t.InterpolateLinear=2301,t.InterpolateSmooth=2302,t.JSONLoader=function(){console.error("THREE.JSONLoader has been removed.")},t.KeyframeTrack=Ji,t.LOD=ve,t.LatheBufferGeometry=Mi,t.LatheGeometry=Ei,t.Layers=M,t.LensFlare=function(){console.error("THREE.LensFlare has been moved to /examples/js/objects/Lensflare.js")},t.LessDepth=2,t.LessEqualDepth=3,t.Light=In,t.LightProbe=es,t.LightProbeHelper=Os,t.LightShadow=Dn,t.Line=Ee,t.Line3=Ts,t.LineBasicMaterial=Se,t.LineCurve=Mn,t.LineCurve3=Tn,t.LineDashedMaterial=zi,t.LineLoop=Te,t.LinePieces=1,t.LineSegments=Me,t.LineStrip=0,t.LinearEncoding=3e3,t.LinearFilter=1006,t.LinearInterpolant=Yi,t.LinearMipMapLinearFilter=1008,t.LinearMipMapNearestFilter=1007,t.LinearToneMapping=1,t.Loader=Qn,t.LoaderUtils=Hr,t.LoadingManager=an,t.LogLuvEncoding=3003,t.LoopOnce=2200,t.LoopPingPong=2202,t.LoopRepeat=2201,t.LuminanceAlphaFormat=1025,t.LuminanceFormat=1024,t.MOUSE={LEFT:0,MIDDLE:1,RIGHT:2},t.Material=z,t.MaterialLoader=Un,t.Math=Js,t.Matrix3=r,t.Matrix4=g,t.MaxEquation=104,t.Mesh=J,t.MeshBasicMaterial=X,t.MeshDepthMaterial=$t,t.MeshDistanceMaterial=te,t.MeshFaceMaterial=function(t){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),t},t.MeshLambertMaterial=Gi,t.MeshMatcapMaterial=Ui,t.MeshNormalMaterial=ji,t.MeshPhongMaterial=Fi,t.MeshPhysicalMaterial=Ni,t.MeshStandardMaterial=Hi,t.MeshToonMaterial=Vi,t.MinEquation=103,t.MirroredRepeatWrapping=1002,t.MixOperation=1,t.MultiMaterial=function(t){return void 0===t&&(t=[]),console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),t.isMultiMaterial=!0,t.materials=t,t.clone=function(){return t.slice()},t},t.MultiplyBlending=4,t.MultiplyOperation=0,t.NearestFilter=1003,t.NearestMipMapLinearFilter=1005,t.NearestMipMapNearestFilter=1004,t.NeverDepth=0,t.NoBlending=0,t.NoColors=0,t.NoToneMapping=0,t.NormalBlending=1,t.NotEqualDepth=7,t.NumberKeyframeTrack=Qi,t.Object3D=T,t.ObjectLoader=Yn,t.ObjectSpaceNormalMap=1,t.OctahedronBufferGeometry=Ve,t.OctahedronGeometry=Fe,t.OneFactor=201,t.OneMinusDstAlphaFactor=207,t.OneMinusDstColorFactor=209,t.OneMinusSrcAlphaFactor=205,t.OneMinusSrcColorFactor=203,t.OrthographicCamera=Nn,t.PCFShadowMap=1,t.PCFSoftShadowMap=2,t.ParametricBufferGeometry=De,t.ParametricGeometry=Oe,t.Particle=function(t){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new ye(t)},t.ParticleBasicMaterial=function(t){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new Ce(t)},t.ParticleSystem=function(t,e){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new Pe(t,e)},t.ParticleSystemMaterial=function(t){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new Ce(t)},t.Path=Ln,t.PerspectiveCamera=re,t.Plane=m,t.PlaneBufferGeometry=U,t.PlaneGeometry=G,t.PlaneHelper=Gs,t.PointCloud=function(t,e){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new Pe(t,e)},t.PointCloudMaterial=function(t){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new Ce(t)},t.PointLight=Hn,t.PointLightHelper=Ls,t.Points=Pe,t.PointsMaterial=Ce,t.PolarGridHelper=ks,t.PolyhedronBufferGeometry=Be,t.PolyhedronGeometry=ke,t.PositionalAudio=hs,t.PositionalAudioHelper=Bs,t.PropertyBinding=ps,t.PropertyMixer=us,t.QuadraticBezierCurve=Cn,t.QuadraticBezierCurve3=Pn,t.Quaternion=n,t.QuaternionKeyframeTrack=tn,t.QuaternionLinearInterpolant=$i,t.REVISION="105",t.RGBADepthPacking=3201,t.RGBAFormat=1023,t.RGBA_ASTC_10x10_Format=37819,t.RGBA_ASTC_10x5_Format=37816,t.RGBA_ASTC_10x6_Format=37817,t.RGBA_ASTC_10x8_Format=37818,t.RGBA_ASTC_12x10_Format=37820,t.RGBA_ASTC_12x12_Format=37821,t.RGBA_ASTC_4x4_Format=37808,t.RGBA_ASTC_5x4_Format=37809,t.RGBA_ASTC_5x5_Format=37810,t.RGBA_ASTC_6x5_Format=37811,t.RGBA_ASTC_6x6_Format=37812,t.RGBA_ASTC_8x5_Format=37813,t.RGBA_ASTC_8x6_Format=37814,t.RGBA_ASTC_8x8_Format=37815,t.RGBA_PVRTC_2BPPV1_Format=35843,t.RGBA_PVRTC_4BPPV1_Format=35842,t.RGBA_S3TC_DXT1_Format=33777,t.RGBA_S3TC_DXT3_Format=33778,t.RGBA_S3TC_DXT5_Format=33779,t.RGBDEncoding=3006,t.RGBEEncoding=3002,t.RGBEFormat=1023,t.RGBFormat=1022,t.RGBM16Encoding=3005,t.RGBM7Encoding=3004,t.RGB_ETC1_Format=36196,t.RGB_PVRTC_2BPPV1_Format=35841,t.RGB_PVRTC_4BPPV1_Format=35840,t.RGB_S3TC_DXT1_Format=33776,t.RawShaderMaterial=Bi,t.Ray=q,t.Raycaster=bs,t.RectAreaLight=Gn,t.RectAreaLightHelper=Rs,t.RedFormat=1028,t.ReinhardToneMapping=2,t.RepeatWrapping=1e3,t.ReverseSubtractEquation=102,t.RingBufferGeometry=Si,t.RingGeometry=xi,t.Scene=pe,t.SceneUtils={createMultiMaterialObject:function(){console.error("THREE.SceneUtils has been moved to /examples/js/utils/SceneUtils.js")},detach:function(){console.error("THREE.SceneUtils has been moved to /examples/js/utils/SceneUtils.js")},attach:function(){console.error("THREE.SceneUtils has been moved to /examples/js/utils/SceneUtils.js")}},t.ShaderChunk=$s,t.ShaderLib=nr,t.ShaderMaterial=W,t.ShadowMaterial=ki,t.Shape=Rn,t.ShapeBufferGeometry=Ci,t.ShapeGeometry=Ti,t.ShapePath=Jn,t.ShapeUtils=Mr,t.ShortType=1011,t.Skeleton=we,t.SkeletonHelper=As,t.SkinnedMesh=be,t.SmoothShading=2,t.Sphere=p,t.SphereBufferGeometry=wi,t.SphereGeometry=bi,t.Spherical=Ss,t.SphericalHarmonics3=ts,t.SphericalReflectionMapping=305,t.Spline=Ys,t.SplineCurve=_n,t.SplineCurve3=qs,t.SpotLight=Bn,t.SpotLightHelper=_s,t.SpotLightShadow=kn,t.Sprite=ye,t.SpriteMaterial=ge,t.SrcAlphaFactor=204,t.SrcAlphaSaturateFactor=210,t.SrcColorFactor=202,t.StereoCamera=ss,t.StringKeyframeTrack=en,t.SubtractEquation=101,t.SubtractiveBlending=3,t.TangentSpaceNormalMap=0,t.TetrahedronBufferGeometry=Ne,t.TetrahedronGeometry=He,t.TextBufferGeometry=vi,t.TextGeometry=yi,t.Texture=a,t.TextureLoader=pn,t.TorusBufferGeometry=Ke,t.TorusGeometry=Je,t.TorusKnotBufferGeometry=Xe,t.TorusKnotGeometry=Ye,t.Triangle=Y,t.TriangleFanDrawMode=2,t.TriangleStripDrawMode=1,t.TrianglesDrawMode=0,t.TubeBufferGeometry=qe,t.TubeGeometry=We,t.UVMapping=300,t.Uint16Attribute=function(t,e){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new I(t,e)},t.Uint16BufferAttribute=I,t.Uint32Attribute=function(t,e){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new D(t,e)},t.Uint32BufferAttribute=D,t.Uint8Attribute=function(t,e){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new A(t,e)},t.Uint8BufferAttribute=A,t.Uint8ClampedAttribute=function(t,e){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new L(t,e)},t.Uint8ClampedBufferAttribute=L,t.Uncharted2ToneMapping=3,t.Uniform=ys,t.UniformsLib=ir,t.UniformsUtils=tr,t.UnsignedByteType=1009,t.UnsignedInt248Type=1020,t.UnsignedIntType=1014,t.UnsignedShort4444Type=1017,t.UnsignedShort5551Type=1018,t.UnsignedShort565Type=1019,t.UnsignedShortType=1012,t.Vector2=i,t.Vector3=s,t.Vector4=o,t.VectorKeyframeTrack=nn,t.Vertex=function(t,e,i){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new s(t,e,i)},t.VertexColors=2,t.VertexNormalsHelper=Ps,t.VideoTexture=_e,t.WebGLMultisampleRenderTarget=h,t.WebGLRenderTarget=l,t.WebGLRenderTargetCube=c,t.WebGLRenderer=ce,t.WebGLUtils=ie,t.WireframeGeometry=Ie,t.WireframeHelper=function(t,e){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new Me(new Ie(t.geometry),new Se({color:void 0!==e?e:16777215}))},t.WrapAroundEnding=2402,t.XHRLoader=function(t){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new on(t)},t.ZeroCurvatureEnding=2400,t.ZeroFactor=200,t.ZeroSlopeEnding=2401,t.sRGBEncoding=3001,Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof t&&"undefined"!=typeof module?xe(t):"function"==typeof define&&define.amd?define(["exports"],xe):xe((we=we||self).THREE={}),THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.EffectComposer=function(t,e){if(this.renderer=t,void 0===e){var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},n=t.getSize(new THREE.Vector2);this._pixelRatio=t.getPixelRatio(),this._width=n.width,this._height=n.height,(e=new THREE.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,i)).texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=e.width,this._height=e.height;this.renderTarget1=e,this.renderTarget2=e.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),void 0===THREE.ShaderPass&&console.error("THREE.EffectComposer relies on THREE.ShaderPass"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader),this.clock=new THREE.Clock},Object.assign(THREE.EffectComposer.prototype,{swapBuffers:function(){var t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t},addPass:function(t){this.passes.push(t);var e=this.renderer.getDrawingBufferSize(new THREE.Vector2);t.setSize(e.width,e.height)},insertPass:function(t,e){this.passes.splice(e,0,t)},isLastEnabledPass:function(t){for(var e=t+1;e<this.passes.length;e++)if(this.passes[e].enabled)return!1;return!0},render:function(t){void 0===t&&(t=this.clock.getDelta());var e,i,n=this.renderer.getRenderTarget(),s=!1,r=this.passes.length;for(i=0;i<r;i++)if(!1!==(e=this.passes[i]).enabled){if(e.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(i),e.render(this.renderer,this.writeBuffer,this.readBuffer,t,s),e.needsSwap){if(s){var a=this.renderer.context;a.stencilFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),a.stencilFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==THREE.MaskPass&&(e instanceof THREE.MaskPass?s=!0:e instanceof THREE.ClearMaskPass&&(s=!1))}this.renderer.setRenderTarget(n)},reset:function(t){if(void 0===t){var e=this.renderer.getSize(new THREE.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=e.width,this._height=e.height,(t=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(t,e){this._width=t,this._height=e;var i=this._width*this._pixelRatio,n=this._height*this._pixelRatio;this.renderTarget1.setSize(i,n),this.renderTarget2.setSize(i,n);for(var s=0;s<this.passes.length;s++)this.passes[s].setSize(i,n)},setPixelRatio:function(t){this._pixelRatio=t,this.setSize(this._width,this._height)}}),THREE.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(THREE.Pass.prototype,{setSize:function(){},render:function(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),THREE.Pass.FullScreenQuad=(Se=new THREE.OrthographicCamera(-1,1,1,-1,0,1),Ee=new THREE.PlaneBufferGeometry(2,2),Me=function(t){this._mesh=new THREE.Mesh(Ee,t)},Object.defineProperty(Me.prototype,"material",{get:function(){return this._mesh.material},set:function(t){this._mesh.material=t}}),Object.assign(Me.prototype,{render:function(t){t.render(this._mesh,Se)}}),Me),THREE.GLTFLoader=function(){function t(t){this.manager=void 0!==t?t:THREE.DefaultLoadingManager,this.dracoLoader=null}t.prototype={constructor:t,crossOrigin:"anonymous",load:function(t,e,i,n){var s,r=this;s=void 0!==this.resourcePath?this.resourcePath:void 0!==this.path?this.path:THREE.LoaderUtils.extractUrlBase(t),r.manager.itemStart(t);var a=function(e){n?n(e):console.error(e),r.manager.itemError(t),r.manager.itemEnd(t)},o=new THREE.FileLoader(r.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.load(t,function(i){try{r.parse(i,s,function(i){e(i),r.manager.itemEnd(t)},a)}catch(t){a(t)}},i,a)},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this},setResourcePath:function(t){return this.resourcePath=t,this},setDRACOLoader:function(t){return this.dracoLoader=t,this},parse:function(t,u,d,p){var m,f={};if("string"==typeof t)m=t;else if(THREE.LoaderUtils.decodeText(new Uint8Array(t,0,4))===r){try{f[e.KHR_BINARY_GLTF]=new function(t){this.name=e.KHR_BINARY_GLTF,this.content=null,this.body=null;var i=new DataView(t,0,a);if(this.header={magic:THREE.LoaderUtils.decodeText(new Uint8Array(t.slice(0,4))),version:i.getUint32(4,!0),length:i.getUint32(8,!0)},this.header.magic!==r)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.");var n=new DataView(t,a),s=0;for(;s<n.byteLength;){var l=n.getUint32(s,!0);s+=4;var h=n.getUint32(s,!0);if(s+=4,h===o.JSON){var c=new Uint8Array(t,a+s,l);this.content=THREE.LoaderUtils.decodeText(c)}else if(h===o.BIN){var u=a+s;this.body=t.slice(u,u+l)}s+=l}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}(t)}catch(t){return void(p&&p(t))}m=f[e.KHR_BINARY_GLTF].content}else m=THREE.LoaderUtils.decodeText(new Uint8Array(t));var g=JSON.parse(m);if(void 0===g.asset||g.asset.version[0]<2)p&&p(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead."));else{if(g.extensionsUsed)for(var y=0;y<g.extensionsUsed.length;++y){var v=g.extensionsUsed[y],b=g.extensionsRequired||[];switch(v){case e.KHR_LIGHTS_PUNCTUAL:f[v]=new n(g);break;case e.KHR_MATERIALS_UNLIT:f[v]=new s(g);break;case e.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:f[v]=new c(g);break;case e.KHR_DRACO_MESH_COMPRESSION:f[v]=new l(g,this.dracoLoader);break;case e.MSFT_TEXTURE_DDS:f[e.MSFT_TEXTURE_DDS]=new i;break;case e.KHR_TEXTURE_TRANSFORM:f[e.KHR_TEXTURE_TRANSFORM]=new h(g);break;default:b.indexOf(v)>=0&&console.warn('THREE.GLTFLoader: Unknown extension "'+v+'".')}}new H(g,f,{path:u||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(d,p)}}};var e={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function i(){if(!THREE.DDSLoader)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing THREE.DDSLoader");this.name=e.MSFT_TEXTURE_DDS,this.ddsLoader=new THREE.DDSLoader}function n(t){this.name=e.KHR_LIGHTS_PUNCTUAL;var i=t.extensions&&t.extensions[e.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=i.lights||[]}function s(){this.name=e.KHR_MATERIALS_UNLIT}n.prototype.loadLight=function(t){var e,i=this.lightDefs[t],n=new THREE.Color(16777215);void 0!==i.color&&n.fromArray(i.color);var s=void 0!==i.range?i.range:0;switch(i.type){case"directional":(e=new THREE.DirectionalLight(n)).target.position.set(0,0,-1),e.add(e.target);break;case"point":(e=new THREE.PointLight(n)).distance=s;break;case"spot":(e=new THREE.SpotLight(n)).distance=s,i.spot=i.spot||{},i.spot.innerConeAngle=void 0!==i.spot.innerConeAngle?i.spot.innerConeAngle:0,i.spot.outerConeAngle=void 0!==i.spot.outerConeAngle?i.spot.outerConeAngle:Math.PI/4,e.angle=i.spot.outerConeAngle,e.penumbra=1-i.spot.innerConeAngle/i.spot.outerConeAngle,e.target.position.set(0,0,-1),e.add(e.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+i.type+'".')}return e.position.set(0,0,0),e.decay=2,void 0!==i.intensity&&(e.intensity=i.intensity),e.name=i.name||"light_"+t,Promise.resolve(e)},s.prototype.getMaterialType=function(){return THREE.MeshBasicMaterial},s.prototype.extendParams=function(t,e,i){var n=[];t.color=new THREE.Color(1,1,1),t.opacity=1;var s=e.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){var r=s.baseColorFactor;t.color.fromArray(r),t.opacity=r[3]}void 0!==s.baseColorTexture&&n.push(i.assignTexture(t,"map",s.baseColorTexture))}return Promise.all(n)};var r="glTF",a=12,o={JSON:1313821514,BIN:5130562};function l(t,i){if(!i)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=e.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=i}function h(){this.name=e.KHR_TEXTURE_TRANSFORM}function c(){return{name:e.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return THREE.ShaderMaterial},extendParams:function(t,e,i){var n=e.extensions[this.name],s=THREE.ShaderLib.standard,r=THREE.UniformsUtils.clone(s.uniforms),a=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),o=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),l=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),h=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),c=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),u=s.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",a).replace("#include <metalnessmap_pars_fragment>",o).replace("#include <roughnessmap_fragment>",l).replace("#include <metalnessmap_fragment>",h).replace("#include <lights_physical_fragment>",c);delete r.roughness,delete r.metalness,delete r.roughnessMap,delete r.metalnessMap,r.specular={value:(new THREE.Color).setHex(1118481)},r.glossiness={value:.5},r.specularMap={value:null},r.glossinessMap={value:null},t.vertexShader=s.vertexShader,t.fragmentShader=u,t.uniforms=r,t.defines={STANDARD:""},t.color=new THREE.Color(1,1,1),t.opacity=1;var d=[];if(Array.isArray(n.diffuseFactor)){var p=n.diffuseFactor;t.color.fromArray(p),t.opacity=p[3]}if(void 0!==n.diffuseTexture&&d.push(i.assignTexture(t,"map",n.diffuseTexture)),t.emissive=new THREE.Color(0,0,0),t.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,t.specular=new THREE.Color(1,1,1),Array.isArray(n.specularFactor)&&t.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var m=n.specularGlossinessTexture;d.push(i.assignTexture(t,"glossinessMap",m)),d.push(i.assignTexture(t,"specularMap",m))}return Promise.all(d)},createMaterial:function(t){var e=new THREE.ShaderMaterial({defines:t.defines,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,fog:!0,lights:!0,opacity:t.opacity,transparent:t.transparent});return e.isGLTFSpecularGlossinessMaterial=!0,e.color=t.color,e.map=void 0===t.map?null:t.map,e.lightMap=null,e.lightMapIntensity=1,e.aoMap=void 0===t.aoMap?null:t.aoMap,e.aoMapIntensity=1,e.emissive=t.emissive,e.emissiveIntensity=1,e.emissiveMap=void 0===t.emissiveMap?null:t.emissiveMap,e.bumpMap=void 0===t.bumpMap?null:t.bumpMap,e.bumpScale=1,e.normalMap=void 0===t.normalMap?null:t.normalMap,t.normalScale&&(e.normalScale=t.normalScale),e.displacementMap=null,e.displacementScale=1,e.displacementBias=0,e.specularMap=void 0===t.specularMap?null:t.specularMap,e.specular=t.specular,e.glossinessMap=void 0===t.glossinessMap?null:t.glossinessMap,e.glossiness=t.glossiness,e.alphaMap=null,e.envMap=void 0===t.envMap?null:t.envMap,e.envMapIntensity=1,e.refractionRatio=.98,e.extensions.derivatives=!0,e},cloneMaterial:function(t){var e=t.clone();e.isGLTFSpecularGlossinessMaterial=!0;for(var i=this.specularGlossinessParams,n=0,s=i.length;n<s;n++){var r=t[i[n]];e[i[n]]=r&&r.isColor?r.clone():r}return e},refreshUniforms:function(t,e,i,n,s,r){if(!0===s.isGLTFSpecularGlossinessMaterial){var a,o=s.uniforms,l=s.defines;o.opacity.value=s.opacity,o.diffuse.value.copy(s.color),o.emissive.value.copy(s.emissive).multiplyScalar(s.emissiveIntensity),o.map.value=s.map,o.specularMap.value=s.specularMap,o.alphaMap.value=s.alphaMap,o.lightMap.value=s.lightMap,o.lightMapIntensity.value=s.lightMapIntensity,o.aoMap.value=s.aoMap,o.aoMapIntensity.value=s.aoMapIntensity,s.map?a=s.map:s.specularMap?a=s.specularMap:s.displacementMap?a=s.displacementMap:s.normalMap?a=s.normalMap:s.bumpMap?a=s.bumpMap:s.glossinessMap?a=s.glossinessMap:s.alphaMap?a=s.alphaMap:s.emissiveMap&&(a=s.emissiveMap),void 0!==a&&(a.isWebGLRenderTarget&&(a=a.texture),!0===a.matrixAutoUpdate&&a.updateMatrix(),o.uvTransform.value.copy(a.matrix)),s.envMap&&(o.envMap.value=s.envMap,o.envMapIntensity.value=s.envMapIntensity,o.flipEnvMap.value=s.envMap.isCubeTexture?-1:1,o.reflectivity.value=s.reflectivity,o.refractionRatio.value=s.refractionRatio,o.maxMipLevel.value=t.properties.get(s.envMap).__maxMipLevel),o.specular.value.copy(s.specular),o.glossiness.value=s.glossiness,o.glossinessMap.value=s.glossinessMap,o.emissiveMap.value=s.emissiveMap,o.bumpMap.value=s.bumpMap,o.normalMap.value=s.normalMap,o.displacementMap.value=s.displacementMap,o.displacementScale.value=s.displacementScale,o.displacementBias.value=s.displacementBias,null!==o.glossinessMap.value&&void 0===l.USE_GLOSSINESSMAP&&(l.USE_GLOSSINESSMAP="",l.USE_ROUGHNESSMAP=""),null===o.glossinessMap.value&&void 0!==l.USE_GLOSSINESSMAP&&(delete l.USE_GLOSSINESSMAP,delete l.USE_ROUGHNESSMAP)}}}}function u(t,e,i,n){THREE.Interpolant.call(this,t,e,i,n)}l.prototype.decodePrimitive=function(t,e){var i=this.json,n=this.dracoLoader,s=t.extensions[this.name].bufferView,r=t.extensions[this.name].attributes,a={},o={},l={};for(var h in r){var c=M[h]||h.toLowerCase();a[c]=r[h]}for(h in t.attributes){c=M[h]||h.toLowerCase();if(void 0!==r[h]){var u=i.accessors[t.attributes[h]],d=w[u.componentType];l[c]=d,o[c]=!0===u.normalized}}return e.getDependency("bufferView",s).then(function(t){return new Promise(function(e){n.decodeDracoFile(t,function(t){for(var i in t.attributes){var n=t.attributes[i],s=o[i];void 0!==s&&(n.normalized=s)}e(t)},a,l)})})},h.prototype.extendTexture=function(t,e){return t=t.clone(),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),void 0!==e.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),t.needsUpdate=!0,t},u.prototype=Object.create(THREE.Interpolant.prototype),u.prototype.constructor=u,u.prototype.copySampleValue_=function(t){for(var e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=t*n*3+n,r=0;r!==n;r++)e[r]=i[s+r];return e},u.prototype.beforeStart_=u.prototype.copySampleValue_,u.prototype.afterEnd_=u.prototype.copySampleValue_,u.prototype.interpolate_=function(t,e,i,n){for(var s=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,h=n-e,c=(i-e)/h,u=c*c,d=u*c,p=t*l,m=p-l,f=-2*d+3*u,g=d-u,y=1-f,v=g-u+c,b=0;b!==a;b++){var w=r[m+b+a],x=r[m+b+o]*h,S=r[p+b+a],E=r[p+b]*h;s[b]=y*w+v*x+f*S+g*E}return s};var d,p=0,m=1,f=2,g=3,y=4,v=5,b=6,w=(Number,THREE.Matrix3,THREE.Matrix4,THREE.Vector2,THREE.Vector3,THREE.Vector4,THREE.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),x={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},S={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},E=(THREE.BackSide,THREE.FrontSide,THREE.NeverDepth,THREE.LessDepth,THREE.EqualDepth,THREE.LessEqualDepth,THREE.GreaterEqualDepth,THREE.NotEqualDepth,THREE.GreaterEqualDepth,THREE.AlwaysDepth,THREE.AddEquation,THREE.SubtractEquation,THREE.ReverseSubtractEquation,THREE.ZeroFactor,THREE.OneFactor,THREE.SrcColorFactor,THREE.OneMinusSrcColorFactor,THREE.SrcAlphaFactor,THREE.OneMinusSrcAlphaFactor,THREE.DstAlphaFactor,THREE.OneMinusDstAlphaFactor,THREE.DstColorFactor,THREE.OneMinusDstColorFactor,THREE.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),M={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},T={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},C={CUBICSPLINE:void 0,LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete},P="OPAQUE",_="MASK",A="BLEND",L={"image/png":THREE.RGBAFormat,"image/jpeg":THREE.RGBFormat};function R(t,e){return"string"!=typeof t||""===t?"":/^(https?:)?\/\//i.test(t)?t:/^data:.*,.*$/i.test(t)?t:/^blob:.*$/i.test(t)?t:e+t}function I(t,e,i){for(var n in i.extensions)void 0===t[n]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=i.extensions[n])}function O(t,e){void 0!==e.extras&&("object"==typeof e.extras?Object.assign(t.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function D(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(var i=0,n=e.weights.length;i<n;i++)t.morphTargetInfluences[i]=e.weights[i];if(e.extras&&Array.isArray(e.extras.targetNames)){var s=e.extras.targetNames;if(t.morphTargetInfluences.length===s.length){t.morphTargetDictionary={};for(i=0,n=s.length;i<n;i++)t.morphTargetDictionary[s[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function k(t){for(var e="",i=Object.keys(t).sort(),n=0,s=i.length;n<s;n++)e+=i[n]+":"+t[i[n]]+";";return e}function B(t){if(t.isInterleavedBufferAttribute){for(var e=t.count,i=t.itemSize,n=t.array.slice(0,e*i),s=0,r=0;s<e;++s)n[r++]=t.getX(s),i>=2&&(n[r++]=t.getY(s)),i>=3&&(n[r++]=t.getZ(s)),i>=4&&(n[r++]=t.getW(s));return new THREE.BufferAttribute(n,i,t.normalized)}return t.clone()}function H(t,e,i){this.json=t||{},this.extensions=e||{},this.options=i||{},this.cache=new function(){var t={};return{get:function(e){return t[e]},add:function(e,i){t[e]=i},remove:function(e){delete t[e]},removeAll:function(){t={}}}},this.primitiveCache={},this.textureLoader=new THREE.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new THREE.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}function N(t,e,i){var n=e.attributes,s=[];function r(e,n){return i.getDependency("accessor",e).then(function(e){t.addAttribute(n,e)})}for(var a in n){var o=M[a]||a.toLowerCase();o in t.attributes||s.push(r(n[a],o))}if(void 0!==e.indices&&!t.index){var l=i.getDependency("accessor",e.indices).then(function(e){t.setIndex(e)});s.push(l)}return O(t,e),Promise.all(s).then(function(){return void 0!==e.targets?function(t,e,i){for(var n=!1,s=!1,r=0,a=e.length;r<a&&(void 0!==(h=e[r]).POSITION&&(n=!0),void 0!==h.NORMAL&&(s=!0),!n||!s);r++);if(!n&&!s)return Promise.resolve(t);var o=[],l=[];for(r=0,a=e.length;r<a;r++){var h=e[r];if(n){var c=void 0!==h.POSITION?i.getDependency("accessor",h.POSITION):t.attributes.position;o.push(c)}s&&(c=void 0!==h.NORMAL?i.getDependency("accessor",h.NORMAL):t.attributes.normal,l.push(c))}return Promise.all([Promise.all(o),Promise.all(l)]).then(function(i){for(var r=i[0],a=i[1],o=0,l=r.length;o<l;o++)t.attributes.position!==r[o]&&(r[o]=B(r[o]));for(o=0,l=a.length;o<l;o++)t.attributes.normal!==a[o]&&(a[o]=B(a[o]));for(o=0,l=e.length;o<l;o++){var h=e[o],c="morphTarget"+o;if(n&&void 0!==h.POSITION){var u=r[o];u.name=c;for(var d=t.attributes.position,p=0,m=u.count;p<m;p++)u.setXYZ(p,u.getX(p)+d.getX(p),u.getY(p)+d.getY(p),u.getZ(p)+d.getZ(p))}if(s&&void 0!==h.NORMAL){var f=a[o];f.name=c;var g=t.attributes.normal;for(p=0,m=f.count;p<m;p++)f.setXYZ(p,f.getX(p)+g.getX(p),f.getY(p)+g.getY(p),f.getZ(p)+g.getZ(p))}}return n&&(t.morphAttributes.position=r),s&&(t.morphAttributes.normal=a),t})}(t,e.targets,i):t})}return H.prototype.parse=function(t,e){var i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(e){var r={scene:e[0][n.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:n.asset,parser:i,userData:{}};I(s,r,n),t(r)}).catch(e)},H.prototype.markDefs=function(){for(var t=this.json.nodes||[],e=this.json.skins||[],i=this.json.meshes||[],n={},s={},r=0,a=e.length;r<a;r++)for(var o=e[r].joints,l=0,h=o.length;l<h;l++)t[o[l]].isBone=!0;for(var c=0,u=t.length;c<u;c++){var d=t[c];void 0!==d.mesh&&(void 0===n[d.mesh]&&(n[d.mesh]=s[d.mesh]=0),n[d.mesh]++,void 0!==d.skin&&(i[d.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=s},H.prototype.getDependency=function(t,i){var n=t+":"+i,s=this.cache.get(n);if(!s){switch(t){case"scene":s=this.loadScene(i);break;case"node":s=this.loadNode(i);break;case"mesh":s=this.loadMesh(i);break;case"accessor":s=this.loadAccessor(i);break;case"bufferView":s=this.loadBufferView(i);break;case"buffer":s=this.loadBuffer(i);break;case"material":s=this.loadMaterial(i);break;case"texture":s=this.loadTexture(i);break;case"skin":s=this.loadSkin(i);break;case"animation":s=this.loadAnimation(i);break;case"camera":s=this.loadCamera(i);break;case"light":s=this.extensions[e.KHR_LIGHTS_PUNCTUAL].loadLight(i);break;default:throw new Error("Unknown type: "+t)}this.cache.add(n,s)}return s},H.prototype.getDependencies=function(t){var e=this.cache.get(t);if(!e){var i=this,n=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(n.map(function(e,n){return i.getDependency(t,n)})),this.cache.add(t,e)}return e},H.prototype.loadBuffer=function(t){var i=this.json.buffers[t],n=this.fileLoader;if(i.type&&"arraybuffer"!==i.type)throw new Error("THREE.GLTFLoader: "+i.type+" buffer type is not supported.");if(void 0===i.uri&&0===t)return Promise.resolve(this.extensions[e.KHR_BINARY_GLTF].body);var s=this.options;return new Promise(function(t,e){n.load(R(i.uri,s.path),t,void 0,function(){e(new Error('THREE.GLTFLoader: Failed to load buffer "'+i.uri+'".'))})})},H.prototype.loadBufferView=function(t){var e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then(function(t){var i=e.byteLength||0,n=e.byteOffset||0;return t.slice(n,n+i)})},H.prototype.loadAccessor=function(t){var e=this,i=this.json,n=this.json.accessors[t];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var s=[];return void 0!==n.bufferView?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),void 0!==n.sparse&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then(function(t){var s,r,a=t[0],o=E[n.type],l=w[n.componentType],h=l.BYTES_PER_ELEMENT,c=h*o,u=n.byteOffset||0,d=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,p=!0===n.normalized;if(d&&d!==c){var m="InterleavedBuffer:"+n.bufferView+":"+n.componentType,f=e.cache.get(m);f||(s=new l(a),f=new THREE.InterleavedBuffer(s,d/h),e.cache.add(m,f)),r=new THREE.InterleavedBufferAttribute(f,o,u/h,p)}else s=null===a?new l(n.count*o):new l(a,u,n.count*o),r=new THREE.BufferAttribute(s,o,p);if(void 0!==n.sparse){var g=E.SCALAR,y=w[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,x=new y(t[1],v,n.sparse.count*g),S=new l(t[2],b,n.sparse.count*o);null!==a&&r.setArray(r.array.slice());for(var M=0,T=x.length;M<T;M++){var C=x[M];if(r.setX(C,S[M*o]),o>=2&&r.setY(C,S[M*o+1]),o>=3&&r.setZ(C,S[M*o+2]),o>=4&&r.setW(C,S[M*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return r})},H.prototype.loadTexture=function(t){var i,n=this,s=this.json,r=this.options,a=this.textureLoader,o=window.URL||window.webkitURL,l=s.textures[t],h=l.extensions||{},c=(i=h[e.MSFT_TEXTURE_DDS]?s.images[h[e.MSFT_TEXTURE_DDS].source]:s.images[l.source]).uri,u=!1;return void 0!==i.bufferView&&(c=n.getDependency("bufferView",i.bufferView).then(function(t){u=!0;var e=new Blob([t],{type:i.mimeType});return c=o.createObjectURL(e)})),Promise.resolve(c).then(function(t){var i=THREE.Loader.Handlers.get(t);return i||(i=h[e.MSFT_TEXTURE_DDS]?n.extensions[e.MSFT_TEXTURE_DDS].ddsLoader:a),new Promise(function(e,n){i.load(R(t,r.path),e,void 0,n)})}).then(function(t){!0===u&&o.revokeObjectURL(c),t.flipY=!1,void 0!==l.name&&(t.name=l.name),i.mimeType in L&&(t.format=L[i.mimeType]);var e=(s.samplers||{})[l.sampler]||{};return t.magFilter=x[e.magFilter]||THREE.LinearFilter,t.minFilter=x[e.minFilter]||THREE.LinearMipMapLinearFilter,t.wrapS=S[e.wrapS]||THREE.RepeatWrapping,t.wrapT=S[e.wrapT]||THREE.RepeatWrapping,t})},H.prototype.assignTexture=function(t,i,n){var s=this;return this.getDependency("texture",n.index).then(function(r){if(!r.isCompressedTexture)switch(i){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":r.format=THREE.RGBFormat}if(s.extensions[e.KHR_TEXTURE_TRANSFORM]){var a=void 0!==n.extensions?n.extensions[e.KHR_TEXTURE_TRANSFORM]:void 0;a&&(r=s.extensions[e.KHR_TEXTURE_TRANSFORM].extendTexture(r,a))}t[i]=r})},H.prototype.assignFinalMaterial=function(t){var i=t.geometry,n=t.material,s=this.extensions,r=void 0!==i.attributes.tangent,a=void 0!==i.attributes.color,o=void 0===i.attributes.normal,l=!0===t.isSkinnedMesh,h=Object.keys(i.morphAttributes).length>0,c=h&&void 0!==i.morphAttributes.normal;if(t.isPoints){var u="PointsMaterial:"+n.uuid,d=this.cache.get(u);d||(d=new THREE.PointsMaterial,THREE.Material.prototype.copy.call(d,n),d.color.copy(n.color),d.map=n.map,d.lights=!1,this.cache.add(u,d)),n=d}else if(t.isLine){u="LineBasicMaterial:"+n.uuid;var p=this.cache.get(u);p||(p=new THREE.LineBasicMaterial,THREE.Material.prototype.copy.call(p,n),p.color.copy(n.color),p.lights=!1,this.cache.add(u,p)),n=p}if(r||a||o||l||h){u="ClonedMaterial:"+n.uuid+":";n.isGLTFSpecularGlossinessMaterial&&(u+="specular-glossiness:"),l&&(u+="skinning:"),r&&(u+="vertex-tangents:"),a&&(u+="vertex-colors:"),o&&(u+="flat-shading:"),h&&(u+="morph-targets:"),c&&(u+="morph-normals:");var m=this.cache.get(u);m||(m=n.isGLTFSpecularGlossinessMaterial?s[e.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(n):n.clone(),l&&(m.skinning=!0),r&&(m.vertexTangents=!0),a&&(m.vertexColors=THREE.VertexColors),o&&(m.flatShading=!0),h&&(m.morphTargets=!0),c&&(m.morphNormals=!0),this.cache.add(u,m)),n=m}n.aoMap&&void 0===i.attributes.uv2&&void 0!==i.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),i.addAttribute("uv2",new THREE.BufferAttribute(i.attributes.uv.array,2))),n.isGLTFSpecularGlossinessMaterial&&(t.onBeforeRender=s[e.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms),t.material=n},H.prototype.loadMaterial=function(t){var i,n=this.json,s=this.extensions,r=n.materials[t],a={},o=r.extensions||{},l=[];if(o[e.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=s[e.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];i=h.getMaterialType(),l.push(h.extendParams(a,r,this))}else if(o[e.KHR_MATERIALS_UNLIT]){var c=s[e.KHR_MATERIALS_UNLIT];i=c.getMaterialType(),l.push(c.extendParams(a,r,this))}else{i=THREE.MeshStandardMaterial;var u=r.pbrMetallicRoughness||{};if(a.color=new THREE.Color(1,1,1),a.opacity=1,Array.isArray(u.baseColorFactor)){var d=u.baseColorFactor;a.color.fromArray(d),a.opacity=d[3]}void 0!==u.baseColorTexture&&l.push(this.assignTexture(a,"map",u.baseColorTexture)),a.metalness=void 0!==u.metallicFactor?u.metallicFactor:1,a.roughness=void 0!==u.roughnessFactor?u.roughnessFactor:1,void 0!==u.metallicRoughnessTexture&&(l.push(this.assignTexture(a,"metalnessMap",u.metallicRoughnessTexture)),l.push(this.assignTexture(a,"roughnessMap",u.metallicRoughnessTexture)))}!0===r.doubleSided&&(a.side=THREE.DoubleSide);var p=r.alphaMode||P;return p===A?a.transparent=!0:(a.transparent=!1,p===_&&(a.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&i!==THREE.MeshBasicMaterial&&(l.push(this.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new THREE.Vector2(1,1),void 0!==r.normalTexture.scale&&a.normalScale.set(r.normalTexture.scale,r.normalTexture.scale)),void 0!==r.occlusionTexture&&i!==THREE.MeshBasicMaterial&&(l.push(this.assignTexture(a,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(a.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&i!==THREE.MeshBasicMaterial&&(a.emissive=(new THREE.Color).fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&i!==THREE.MeshBasicMaterial&&l.push(this.assignTexture(a,"emissiveMap",r.emissiveTexture)),Promise.all(l).then(function(){var t;return t=i===THREE.ShaderMaterial?s[e.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new i(a),void 0!==r.name&&(t.name=r.name),t.map&&(t.map.encoding=THREE.sRGBEncoding),t.emissiveMap&&(t.emissiveMap.encoding=THREE.sRGBEncoding),t.specularMap&&(t.specularMap.encoding=THREE.sRGBEncoding),O(t,r),r.extensions&&I(s,t,r),t})},H.prototype.loadGeometries=function(t){var i=this,n=this.extensions,s=this.primitiveCache;function r(t){return n[e.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,i).then(function(e){return N(e,t,i)})}for(var a,o,l=[],h=0,c=t.length;h<c;h++){var u,d=t[h],p=(void 0,(o=(a=d).extensions&&a.extensions[e.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+k(o.attributes):a.indices+":"+k(a.attributes)+":"+a.mode),m=s[p];if(m)l.push(m.promise);else u=d.extensions&&d.extensions[e.KHR_DRACO_MESH_COMPRESSION]?r(d):N(new THREE.BufferGeometry,d,i),s[p]={primitive:d,promise:u},l.push(u)}return Promise.all(l)},H.prototype.loadMesh=function(t){for(var e=this,i=this.json,n=(this.extensions,i.meshes[t]),s=n.primitives,r=[],a=0,o=s.length;a<o;a++){var l=void 0===s[a].material?d=d||new THREE.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:THREE.FrontSide}):this.getDependency("material",s[a].material);r.push(l)}return Promise.all(r).then(function(i){return e.loadGeometries(s).then(function(r){for(var a=[],o=0,l=r.length;o<l;o++){var h,c=r[o],u=s[o],d=i[o];if(u.mode===y||u.mode===v||u.mode===b||void 0===u.mode)!0===(h=!0===n.isSkinnedMesh?new THREE.SkinnedMesh(c,d):new THREE.Mesh(c,d)).isSkinnedMesh&&h.normalizeSkinWeights(),u.mode===v?h.drawMode=THREE.TriangleStripDrawMode:u.mode===b&&(h.drawMode=THREE.TriangleFanDrawMode);else if(u.mode===m)h=new THREE.LineSegments(c,d);else if(u.mode===g)h=new THREE.Line(c,d);else if(u.mode===f)h=new THREE.LineLoop(c,d);else{if(u.mode!==p)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);h=new THREE.Points(c,d)}Object.keys(h.geometry.morphAttributes).length>0&&D(h,n),h.name=n.name||"mesh_"+t,r.length>1&&(h.name+="_"+o),O(h,n),e.assignFinalMaterial(h),a.push(h)}if(1===a.length)return a[0];var w=new THREE.Group;for(o=0,l=a.length;o<l;o++)w.add(a[o]);return w})})},H.prototype.loadCamera=function(t){var e,i=this.json.cameras[t],n=i[i.type];if(n)return"perspective"===i.type?e=new THREE.PerspectiveCamera(THREE.Math.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(e=new THREE.OrthographicCamera(n.xmag/-2,n.xmag/2,n.ymag/2,n.ymag/-2,n.znear,n.zfar)),void 0!==i.name&&(e.name=i.name),O(e,i),Promise.resolve(e);console.warn("THREE.GLTFLoader: Missing camera parameters.")},H.prototype.loadSkin=function(t){var e=this.json.skins[t],i={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",e.inverseBindMatrices).then(function(t){return i.inverseBindMatrices=t,i})},H.prototype.loadAnimation=function(t){for(var e=this.json.animations[t],i=[],n=[],s=[],r=[],a=[],o=0,l=e.channels.length;o<l;o++){var h=e.channels[o],c=e.samplers[h.sampler],d=h.target,p=void 0!==d.node?d.node:d.id,m=void 0!==e.parameters?e.parameters[c.input]:c.input,f=void 0!==e.parameters?e.parameters[c.output]:c.output;i.push(this.getDependency("node",p)),n.push(this.getDependency("accessor",m)),s.push(this.getDependency("accessor",f)),r.push(c),a.push(d)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(s),Promise.all(r),Promise.all(a)]).then(function(i){for(var n=i[0],s=i[1],r=i[2],a=i[3],o=i[4],l=[],h=0,c=n.length;h<c;h++){var d=n[h],p=s[h],m=r[h],f=a[h],g=o[h];if(void 0!==d){var y;switch(d.updateMatrix(),d.matrixAutoUpdate=!0,T[g.path]){case T.weights:y=THREE.NumberKeyframeTrack;break;case T.rotation:y=THREE.QuaternionKeyframeTrack;break;case T.position:case T.scale:default:y=THREE.VectorKeyframeTrack}var v=d.name?d.name:d.uuid,b=void 0!==f.interpolation?C[f.interpolation]:THREE.InterpolateLinear,w=[];T[g.path]===T.weights?d.traverse(function(t){!0===t.isMesh&&t.morphTargetInfluences&&w.push(t.name?t.name:t.uuid)}):w.push(v);for(var x=0,S=w.length;x<S;x++){var E=new y(w[x]+"."+T[g.path],p.array,m.array,b);"CUBICSPLINE"===f.interpolation&&(E.createInterpolant=function(t){return new u(this.times,this.values,this.getValueSize()/3,t)},E.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(E)}}}var M=void 0!==e.name?e.name:"animation_"+t;return new THREE.AnimationClip(M,void 0,l)})},H.prototype.loadNode=function(t){var i=this.json,n=this.extensions,s=this,r=i.meshReferences,a=i.meshUses,o=i.nodes[t];return(!0===o.isBone?Promise.resolve(new THREE.Bone):void 0!==o.mesh?s.getDependency("mesh",o.mesh).then(function(t){var e;if(r[o.mesh]>1){var i=a[o.mesh]++;(e=t.clone()).name+="_instance_"+i,e.onBeforeRender=t.onBeforeRender;for(var n=0,s=e.children.length;n<s;n++)e.children[n].name+="_instance_"+i,e.children[n].onBeforeRender=t.children[n].onBeforeRender}else e=t;return void 0!==o.weights&&e.traverse(function(t){if(t.isMesh)for(var e=0,i=o.weights.length;e<i;e++)t.morphTargetInfluences[e]=o.weights[e]}),e}):void 0!==o.camera?s.getDependency("camera",o.camera):o.extensions&&o.extensions[e.KHR_LIGHTS_PUNCTUAL]&&void 0!==o.extensions[e.KHR_LIGHTS_PUNCTUAL].light?s.getDependency("light",o.extensions[e.KHR_LIGHTS_PUNCTUAL].light):Promise.resolve(new THREE.Object3D)).then(function(t){if(void 0!==o.name&&(t.userData.name=o.name,t.name=THREE.PropertyBinding.sanitizeNodeName(o.name)),O(t,o),o.extensions&&I(n,t,o),void 0!==o.matrix){var e=new THREE.Matrix4;e.fromArray(o.matrix),t.applyMatrix(e)}else void 0!==o.translation&&t.position.fromArray(o.translation),void 0!==o.rotation&&t.quaternion.fromArray(o.rotation),void 0!==o.scale&&t.scale.fromArray(o.scale);return t})},H.prototype.loadScene=function(){function t(e,i,n,s){var r=n.nodes[e];return s.getDependency("node",e).then(function(t){return void 0===r.skin?t:s.getDependency("skin",r.skin).then(function(t){for(var i=[],n=0,r=(e=t).joints.length;n<r;n++)i.push(s.getDependency("node",e.joints[n]));return Promise.all(i)}).then(function(i){for(var n=!0===t.isGroup?t.children:[t],s=0,r=n.length;s<r;s++){for(var a=n[s],o=[],l=[],h=0,c=i.length;h<c;h++){var u=i[h];if(u){o.push(u);var d=new THREE.Matrix4;void 0!==e.inverseBindMatrices&&d.fromArray(e.inverseBindMatrices.array,16*h),l.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[h])}a.bind(new THREE.Skeleton(o,l),a.matrixWorld)}return t});var e}).then(function(e){i.add(e);var a=[];if(r.children)for(var o=r.children,l=0,h=o.length;l<h;l++){var c=o[l];a.push(t(c,e,n,s))}return Promise.all(a)})}return function(e){var i=this.json,n=this.extensions,s=this.json.scenes[e],r=new THREE.Scene;void 0!==s.name&&(r.name=s.name),O(r,s),s.extensions&&I(n,r,s);for(var a=s.nodes||[],o=[],l=0,h=a.length;l<h;l++)o.push(t(a[l],r,i,this));return Promise.all(o).then(function(){return r})}}(),t}(),THREE.LuminosityHighPassShader={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new THREE.Color(0)},defaultOpacity:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec3 defaultColor;","uniform float defaultOpacity;","uniform float luminosityThreshold;","uniform float smoothWidth;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( texel.xyz, luma );","vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );","float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );","gl_FragColor = mix( outputColor, texel, alpha );","}"].join("\n")},THREE.RenderPass=function(t,e,i,n,s){THREE.Pass.call(this),this.scene=t,this.camera=e,this.overrideMaterial=i,this.clearColor=n,this.clearAlpha=void 0!==s?s:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1},THREE.RenderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.RenderPass,render:function(t,e,i){var n,s,r=t.autoClear;t.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(n=t.getClearColor().getHex(),s=t.getClearAlpha(),t.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:i),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),this.clearColor&&t.setClearColor(n,s),this.scene.overrideMaterial=null,t.autoClear=r}}),THREE.ShaderPass=function(t,e){THREE.Pass.call(this),this.textureID=void 0!==e?e:"tDiffuse",t instanceof THREE.ShaderMaterial?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=THREE.UniformsUtils.clone(t.uniforms),this.material=new THREE.ShaderMaterial({defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new THREE.Pass.FullScreenQuad(this.material)},THREE.ShaderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ShaderPass,render:function(t,e,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}}),THREE.UnrealBloomPass=function(t,e,i,n){THREE.Pass.call(this),this.strength=void 0!==e?e:1,this.radius=i,this.threshold=n,this.resolution=void 0!==t?new THREE.Vector2(t.x,t.y):new THREE.Vector2(256,256),this.clearColor=new THREE.Color(0,0,0);var s={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;var r=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.renderTargetBright=new THREE.WebGLRenderTarget(r,a,s),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(var o=0;o<this.nMips;o++){var l=new THREE.WebGLRenderTarget(r,a,s);l.texture.name="UnrealBloomPass.h"+o,l.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(l);var h=new THREE.WebGLRenderTarget(r,a,s);h.texture.name="UnrealBloomPass.v"+o,h.texture.generateMipmaps=!1,this.renderTargetsVertical.push(h),r=Math.round(r/2),a=Math.round(a/2)}void 0===THREE.LuminosityHighPassShader&&console.error("THREE.UnrealBloomPass relies on THREE.LuminosityHighPassShader");var c=THREE.LuminosityHighPassShader;this.highPassUniforms=THREE.UniformsUtils.clone(c.uniforms),this.highPassUniforms.luminosityThreshold.value=n,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new THREE.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:c.vertexShader,fragmentShader:c.fragmentShader,defines:{}}),this.separableBlurMaterials=[];var u=[3,5,7,9,11];for(r=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2),o=0;o<this.nMips;o++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(u[o])),this.separableBlurMaterials[o].uniforms.texSize.value=new THREE.Vector2(r,a),r=Math.round(r/2),a=Math.round(a/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=e,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,void 0===THREE.CopyShader&&console.error("THREE.UnrealBloomPass relies on THREE.CopyShader");var d=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(d.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:d.vertexShader,fragmentShader:d.fragmentShader,blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.basic=new THREE.MeshBasicMaterial,this.fsQuad=new THREE.Pass.FullScreenQuad(null)},THREE.UnrealBloomPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.UnrealBloomPass,dispose:function(){for(var t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose()},setSize:function(t,e){var i=Math.round(t/2),n=Math.round(e/2);this.renderTargetBright.setSize(i,n);for(var s=0;s<this.nMips;s++)this.renderTargetsHorizontal[s].setSize(i,n),this.renderTargetsVertical[s].setSize(i,n),this.separableBlurMaterials[s].uniforms.texSize.value=new THREE.Vector2(i,n),i=Math.round(i/2),n=Math.round(n/2)},render:function(t,e,i,n,s){this.oldClearColor.copy(t.getClearColor()),this.oldClearAlpha=t.getClearAlpha();var r=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),s&&t.context.disable(t.context.STENCIL_TEST),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=i.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);for(var a=this.renderTargetBright,o=0;o<this.nMips;o++)this.fsQuad.material=this.separableBlurMaterials[o],this.separableBlurMaterials[o].uniforms.colorTexture.value=a.texture,this.separableBlurMaterials[o].uniforms.direction.value=THREE.UnrealBloomPass.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[o]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[o].uniforms.colorTexture.value=this.renderTargetsHorizontal[o].texture,this.separableBlurMaterials[o].uniforms.direction.value=THREE.UnrealBloomPass.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[o]),t.clear(),this.fsQuad.render(t),a=this.renderTargetsVertical[o];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,s&&t.context.enable(t.context.STENCIL_TEST),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(i),this.fsQuad.render(t)),t.setClearColor(this.oldClearColor,this.oldClearAlpha),t.autoClear=r},getSeperableBlurMaterial:function(t){return new THREE.ShaderMaterial({defines:{KERNEL_RADIUS:t,SIGMA:t},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat fSigma = float(SIGMA);\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, fSigma);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\t\t\t\t\t\tfloat x = float(i);\t\t\t\t\t\tfloat w = gaussianPdf(x, fSigma);\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\t\t\t\t\t\tweightSum += 2.0 * w;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})},getCompositeMaterial:function(t){return new THREE.ShaderMaterial({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},dirtTexture:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D blurTexture1;\t\t\t\tuniform sampler2D blurTexture2;\t\t\t\tuniform sampler2D blurTexture3;\t\t\t\tuniform sampler2D blurTexture4;\t\t\t\tuniform sampler2D blurTexture5;\t\t\t\tuniform sampler2D dirtTexture;\t\t\t\tuniform float bloomStrength;\t\t\t\tuniform float bloomRadius;\t\t\t\tuniform float bloomFactors[NUM_MIPS];\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\t\t\t\t\t\t\t\tfloat lerpBloomFactor(const in float factor) { \t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\t\t\t\t}\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\t\t\t\t}"})}}),THREE.UnrealBloomPass.BlurDirectionX=new THREE.Vector2(1,0),THREE.UnrealBloomPass.BlurDirectionY=new THREE.Vector2(0,1)}("undefined"==typeof LL?LL={}:LL);